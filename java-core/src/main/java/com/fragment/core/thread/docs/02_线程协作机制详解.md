# ç¬¬äºŒç« ï¼šçº¿ç¨‹åä½œæœºåˆ¶è¯¦è§£

## å¼•è¨€

ç†è§£äº†çº¿ç¨‹çš„ç”Ÿå‘½å‘¨æœŸåï¼Œæœ¬ç« å°†æ·±å…¥æ¢è®¨çº¿ç¨‹é—´å¦‚ä½•åä½œã€‚æˆ‘ä»¬å°†è¯¦ç»†åˆ†æ`sleep`ã€`join`ã€`yield`ã€`wait/notify`ç­‰æ ¸å¿ƒæ–¹æ³•çš„åŸç†å’Œä½¿ç”¨åœºæ™¯ã€‚

---

## 1. Thread.sleep() - çº¿ç¨‹ä¼‘çœ 

### 1.1 é—®é¢˜1ï¼šsleep()çš„ä½œç”¨æ˜¯ä»€ä¹ˆï¼Ÿ

**å®šä¹‰**ï¼š

```java
public static native void sleep(long millis) throws InterruptedException;
public static void sleep(long millis, int nanos) throws InterruptedException;
```

**æ ¸å¿ƒä½œç”¨**ï¼š
- è®©å½“å‰çº¿ç¨‹æš‚åœæ‰§è¡ŒæŒ‡å®šæ—¶é—´
- è¿›å…¥TIMED_WAITINGçŠ¶æ€
- **ä¸é‡Šæ”¾é”**ï¼ˆé‡è¦ï¼ï¼‰

---

### 1.2 é—®é¢˜2ï¼šsleep()çš„å·¥ä½œåŸç†æ˜¯ä»€ä¹ˆï¼Ÿ

**çŠ¶æ€è½¬æ¢å›¾**ï¼š

```
RUNNABLE (è¿è¡Œä¸­)
    â†“ Thread.sleep(1000)
TIMED_WAITING (è¶…æ—¶ç­‰å¾…)
    â†“ 1ç§’åè‡ªåŠ¨å”¤é†’
RUNNABLE (å°±ç»ª)
    â†“ è·å¾—CPU
RUNNABLE (è¿è¡Œä¸­)
```

**åº•å±‚å®ç°**ï¼š

```java
// Thread.sleep() æ˜¯nativeæ–¹æ³•
public static native void sleep(long millis) throws InterruptedException;

// å®é™…æµç¨‹ï¼š
// 1. JVMè°ƒç”¨æ“ä½œç³»ç»Ÿçš„sleepå‡½æ•°
// 2. çº¿ç¨‹è¢«ç§»å‡ºCPUè°ƒåº¦é˜Ÿåˆ—
// 3. è®¾ç½®å®šæ—¶å™¨
// 4. å®šæ—¶å™¨åˆ°æœŸåï¼Œçº¿ç¨‹é‡æ–°è¿›å…¥å°±ç»ªé˜Ÿåˆ—
// 5. ç­‰å¾…CPUè°ƒåº¦
```

---

### 1.3 é—®é¢˜3ï¼šsleep()ä¸é‡Šæ”¾é”æ˜¯ä»€ä¹ˆæ„æ€ï¼Ÿ

**ç¤ºä¾‹ä»£ç **ï¼š

```java
public class SleepWithLock {
    private static final Object lock = new Object();
    
    public static void main(String[] args) {
        Thread t1 = new Thread(() -> {
            synchronized (lock) {
                System.out.println("t1è·å¾—é”");
                try {
                    System.out.println("t1å¼€å§‹sleepï¼Œä½†ä¸é‡Šæ”¾é”");
                    Thread.sleep(3000); // æŒæœ‰é”çš„åŒæ—¶sleep
                    System.out.println("t1 sleepç»“æŸ");
                } catch (InterruptedException e) {
                    e.printStackTrace();
                }
                System.out.println("t1é‡Šæ”¾é”");
            }
        });
        
        Thread t2 = new Thread(() -> {
            synchronized (lock) {
                System.out.println("t2è·å¾—é”");
            }
        });
        
        t1.start();
        try {
            Thread.sleep(100); // ç¡®ä¿t1å…ˆè·å¾—é”
        } catch (InterruptedException e) {
            e.printStackTrace();
        }
        t2.start();
    }
}
```

**æ‰§è¡Œç»“æœ**ï¼š

```
t1è·å¾—é”
t1å¼€å§‹sleepï¼Œä½†ä¸é‡Šæ”¾é”
t1 sleepç»“æŸ
t1é‡Šæ”¾é”
t2è·å¾—é”  â† å¿…é¡»ç­‰å¾…t1é‡Šæ”¾é”
```

**æ—¶é—´çº¿å›¾**ï¼š

```
æ—¶é—´è½´: 0s----1s----2s----3s----4s
t1:     [è·å¾—é”][sleep 3ç§’ï¼ŒæŒæœ‰é”][é‡Šæ”¾é”]
t2:     [ç­‰å¾…é”........................][è·å¾—é”]
```

**å…³é”®ç†è§£**ï¼š
- sleep()åªæ˜¯è®©çº¿ç¨‹æš‚åœï¼Œä¸ä¼šé‡Šæ”¾ä»»ä½•èµ„æº
- å¦‚æœæŒæœ‰é”ï¼Œå…¶ä»–çº¿ç¨‹æ— æ³•è·å¾—é”
- å¯èƒ½å¯¼è‡´æ€§èƒ½é—®é¢˜

---

### 1.4 é—®é¢˜4ï¼šsleep()çš„å…¸å‹ä½¿ç”¨åœºæ™¯æ˜¯ä»€ä¹ˆï¼Ÿ

#### åœºæ™¯1ï¼šæ¨¡æ‹Ÿè€—æ—¶æ“ä½œ

```java
public class SimulateTask {
    public static void main(String[] args) {
        System.out.println("å¼€å§‹å¤„ç†ä»»åŠ¡");
        try {
            Thread.sleep(2000); // æ¨¡æ‹Ÿè€—æ—¶2ç§’
        } catch (InterruptedException e) {
            e.printStackTrace();
        }
        System.out.println("ä»»åŠ¡å¤„ç†å®Œæˆ");
    }
}
```

#### åœºæ™¯2ï¼šå®šæ—¶ä»»åŠ¡

```java
public class ScheduledTask {
    public static void main(String[] args) {
        while (true) {
            System.out.println("æ‰§è¡Œå®šæ—¶ä»»åŠ¡: " + System.currentTimeMillis());
            try {
                Thread.sleep(5000); // æ¯5ç§’æ‰§è¡Œä¸€æ¬¡
            } catch (InterruptedException e) {
                break; // è¢«ä¸­æ–­æ—¶é€€å‡º
            }
        }
    }
}
```

#### åœºæ™¯3ï¼šé™ä½CPUå ç”¨

```java
public class ReduceCpuUsage {
    private static volatile boolean running = true;
    
    public static void main(String[] args) {
        // âŒ é”™è¯¯ï¼šCPUå ç”¨100%
        while (running) {
            // ç©ºå¾ªç¯ï¼Œç–¯ç‹‚å ç”¨CPU
        }
        
        // âœ… æ­£ç¡®ï¼šé™ä½CPUå ç”¨
        while (running) {
            try {
                Thread.sleep(100); // ä¼‘çœ 100ms
            } catch (InterruptedException e) {
                break;
            }
            // æ‰§è¡Œæ£€æŸ¥é€»è¾‘
        }
    }
}
```

---

### 1.5 é—®é¢˜5ï¼šsleep()æœ‰å“ªäº›å¸¸è§é™·é˜±ï¼Ÿ

#### é™·é˜±1ï¼šåœ¨å¾ªç¯ä¸­ä½¿ç”¨sleepå¯èƒ½å¯¼è‡´æ—¶é—´æ¼‚ç§»

```java
// âŒ é”™è¯¯ï¼šæ—¶é—´ä¼šç´¯ç§¯æ¼‚ç§»
public class TimeDrift {
    public static void main(String[] args) {
        long startTime = System.currentTimeMillis();
        
        for (int i = 0; i < 10; i++) {
            try {
                Thread.sleep(1000); // æœŸæœ›æ¯ç§’æ‰§è¡Œä¸€æ¬¡
            } catch (InterruptedException e) {
                e.printStackTrace();
            }
            System.out.println("æ‰§è¡Œç¬¬ " + i + " æ¬¡");
        }
        
        long endTime = System.currentTimeMillis();
        System.out.println("æ€»è€—æ—¶: " + (endTime - startTime) / 1000 + "ç§’");
        // å®é™…å¯èƒ½è¶…è¿‡10ç§’ï¼ˆå› ä¸ºä»£ç æ‰§è¡Œä¹Ÿéœ€è¦æ—¶é—´ï¼‰
    }
}

// âœ… æ­£ç¡®ï¼šä½¿ç”¨ScheduledExecutorService
public class FixedRate {
    public static void main(String[] args) {
        ScheduledExecutorService executor = Executors.newScheduledThreadPool(1);
        executor.scheduleAtFixedRate(() -> {
            System.out.println("æ‰§è¡Œä»»åŠ¡");
        }, 0, 1, TimeUnit.SECONDS); // å›ºå®šé¢‘ç‡1ç§’
    }
}
```

#### é™·é˜±2ï¼šsleep()ä¸èƒ½ç²¾ç¡®æ§åˆ¶æ—¶é—´

```java
public class SleepAccuracy {
    public static void main(String[] args) {
        long startTime = System.nanoTime();
        try {
            Thread.sleep(1); // æœŸæœ›sleep 1æ¯«ç§’
        } catch (InterruptedException e) {
            e.printStackTrace();
        }
        long endTime = System.nanoTime();
        
        System.out.println("å®é™…è€—æ—¶: " + (endTime - startTime) / 1_000_000.0 + "æ¯«ç§’");
        // å®é™…å¯èƒ½æ˜¯ 1.5msã€2msï¼Œç”šè‡³æ›´å¤šï¼ˆå–å†³äºOSè°ƒåº¦ï¼‰
    }
}
```

**åŸå› **ï¼š
- æ“ä½œç³»ç»Ÿçš„æ—¶é—´ç‰‡é€šå¸¸æ˜¯10-15ms
- sleep()ä¾èµ–OSè°ƒåº¦ï¼Œæ— æ³•ä¿è¯ç²¾ç¡®æ—¶é—´

---

## 2. Thread.join() - ç­‰å¾…çº¿ç¨‹ç»“æŸ

### 2.1 é—®é¢˜6ï¼šjoin()çš„ä½œç”¨æ˜¯ä»€ä¹ˆï¼Ÿ

**å®šä¹‰**ï¼š

```java
public final void join() throws InterruptedException;
public final synchronized void join(long millis) throws InterruptedException;
public final synchronized void join(long millis, int nanos) throws InterruptedException;
```

**æ ¸å¿ƒä½œç”¨**ï¼š
- ç­‰å¾…ç›®æ ‡çº¿ç¨‹æ‰§è¡Œå®Œæ¯•
- å½“å‰çº¿ç¨‹è¿›å…¥WAITINGæˆ–TIMED_WAITINGçŠ¶æ€
- ç›®æ ‡çº¿ç¨‹ç»“æŸåï¼Œå½“å‰çº¿ç¨‹ç»§ç»­æ‰§è¡Œ

---

### 2.2 é—®é¢˜7ï¼šjoin()çš„å·¥ä½œåŸç†æ˜¯ä»€ä¹ˆï¼Ÿ

**ç¤ºä¾‹ä»£ç **ï¼š

```java
public class JoinExample {
    public static void main(String[] args) throws InterruptedException {
        Thread t1 = new Thread(() -> {
            System.out.println("t1å¼€å§‹æ‰§è¡Œ");
            try {
                Thread.sleep(2000);
            } catch (InterruptedException e) {
                e.printStackTrace();
            }
            System.out.println("t1æ‰§è¡Œå®Œæˆ");
        });
        
        System.out.println("mainçº¿ç¨‹å¯åŠ¨t1");
        t1.start();
        
        System.out.println("mainçº¿ç¨‹ç­‰å¾…t1ç»“æŸ");
        t1.join(); // mainçº¿ç¨‹åœ¨è¿™é‡Œç­‰å¾…
        
        System.out.println("mainçº¿ç¨‹ç»§ç»­æ‰§è¡Œ");
    }
}
```

**æ‰§è¡Œç»“æœ**ï¼š

```
mainçº¿ç¨‹å¯åŠ¨t1
mainçº¿ç¨‹ç­‰å¾…t1ç»“æŸ
t1å¼€å§‹æ‰§è¡Œ
t1æ‰§è¡Œå®Œæˆ
mainçº¿ç¨‹ç»§ç»­æ‰§è¡Œ
```

**çŠ¶æ€è½¬æ¢å›¾**ï¼š

```
mainçº¿ç¨‹:
RUNNABLE (è¿è¡Œä¸­)
    â†“ t1.join()
WAITING (ç­‰å¾…t1ç»“æŸ)
    â†“ t1æ‰§è¡Œå®Œæ¯•
RUNNABLE (å°±ç»ª)
    â†“ è·å¾—CPU
RUNNABLE (è¿è¡Œä¸­)
```

---

### 2.3 é—®é¢˜8ï¼šjoin()çš„åº•å±‚å®ç°æ˜¯ä»€ä¹ˆï¼Ÿ

**æºç åˆ†æ**ï¼š

```java
public final synchronized void join(long millis) throws InterruptedException {
    long base = System.currentTimeMillis();
    long now = 0;
    
    if (millis < 0) {
        throw new IllegalArgumentException("timeout value is negative");
    }
    
    if (millis == 0) {
        // æ— é™ç­‰å¾…
        while (isAlive()) {
            wait(0); // è°ƒç”¨Object.wait()
        }
    } else {
        // è¶…æ—¶ç­‰å¾…
        while (isAlive()) {
            long delay = millis - now;
            if (delay <= 0) {
                break;
            }
            wait(delay);
            now = System.currentTimeMillis() - base;
        }
    }
}
```

**å…³é”®å‘ç°**ï¼š

1. **join()æ˜¯synchronizedæ–¹æ³•**ï¼šé”ä½çš„æ˜¯ç›®æ ‡çº¿ç¨‹å¯¹è±¡
2. **åº•å±‚ä½¿ç”¨wait()**ï¼šè°ƒç”¨Object.wait()è¿›å…¥ç­‰å¾…
3. **å¾ªç¯æ£€æŸ¥isAlive()**ï¼šé˜²æ­¢è™šå‡å”¤é†’
4. **è°æ¥å”¤é†’ï¼Ÿ**ï¼šJVMåœ¨çº¿ç¨‹ç»“æŸæ—¶è‡ªåŠ¨è°ƒç”¨notifyAll()

**æµç¨‹å›¾**ï¼š

```
mainçº¿ç¨‹è°ƒç”¨t1.join()
    â†“
è·å–t1å¯¹è±¡çš„é”
    â†“
æ£€æŸ¥t1.isAlive()
    â†“ true
è°ƒç”¨t1.wait()ï¼ˆmainçº¿ç¨‹ç­‰å¾…ï¼‰
    â†“
t1çº¿ç¨‹æ‰§è¡Œå®Œæ¯•
    â†“
JVMè‡ªåŠ¨è°ƒç”¨t1.notifyAll()
    â†“
mainçº¿ç¨‹è¢«å”¤é†’
    â†“
å†æ¬¡æ£€æŸ¥t1.isAlive()
    â†“ false
join()è¿”å›ï¼Œmainçº¿ç¨‹ç»§ç»­æ‰§è¡Œ
```

---

### 2.4 é—®é¢˜9ï¼šjoin()çš„å…¸å‹ä½¿ç”¨åœºæ™¯æ˜¯ä»€ä¹ˆï¼Ÿ

#### åœºæ™¯1ï¼šç­‰å¾…æ‰€æœ‰å­ä»»åŠ¡å®Œæˆ

```java
public class WaitAllTasks {
    public static void main(String[] args) throws InterruptedException {
        List<Thread> threads = new ArrayList<>();
        
        // åˆ›å»º10ä¸ªä»»åŠ¡çº¿ç¨‹
        for (int i = 0; i < 10; i++) {
            final int taskId = i;
            Thread t = new Thread(() -> {
                System.out.println("ä»»åŠ¡ " + taskId + " å¼€å§‹æ‰§è¡Œ");
                try {
                    Thread.sleep(1000);
                } catch (InterruptedException e) {
                    e.printStackTrace();
                }
                System.out.println("ä»»åŠ¡ " + taskId + " æ‰§è¡Œå®Œæˆ");
            });
            threads.add(t);
            t.start();
        }
        
        // ç­‰å¾…æ‰€æœ‰ä»»åŠ¡å®Œæˆ
        for (Thread t : threads) {
            t.join();
        }
        
        System.out.println("æ‰€æœ‰ä»»åŠ¡å®Œæˆï¼Œå¼€å§‹æ±‡æ€»ç»“æœ");
    }
}
```

#### åœºæ™¯2ï¼šæ§åˆ¶æ‰§è¡Œé¡ºåº

```java
public class ControlOrder {
    public static void main(String[] args) throws InterruptedException {
        Thread t1 = new Thread(() -> {
            System.out.println("æ­¥éª¤1ï¼šåˆå§‹åŒ–æ•°æ®");
        });
        
        Thread t2 = new Thread(() -> {
            System.out.println("æ­¥éª¤2ï¼šå¤„ç†æ•°æ®");
        });
        
        Thread t3 = new Thread(() -> {
            System.out.println("æ­¥éª¤3ï¼šä¿å­˜ç»“æœ");
        });
        
        // æŒ‰é¡ºåºæ‰§è¡Œ
        t1.start();
        t1.join(); // ç­‰å¾…t1å®Œæˆ
        
        t2.start();
        t2.join(); // ç­‰å¾…t2å®Œæˆ
        
        t3.start();
        t3.join(); // ç­‰å¾…t3å®Œæˆ
        
        System.out.println("æµç¨‹å®Œæˆ");
    }
}
```

#### åœºæ™¯3ï¼šè¶…æ—¶æ§åˆ¶

```java
public class JoinTimeout {
    public static void main(String[] args) throws InterruptedException {
        Thread t1 = new Thread(() -> {
            try {
                Thread.sleep(5000); // æ¨¡æ‹Ÿé•¿æ—¶é—´ä»»åŠ¡
            } catch (InterruptedException e) {
                e.printStackTrace();
            }
        });
        
        t1.start();
        
        // æœ€å¤šç­‰å¾…2ç§’
        t1.join(2000);
        
        if (t1.isAlive()) {
            System.out.println("ä»»åŠ¡è¶…æ—¶ï¼Œå¼ºåˆ¶ä¸­æ–­");
            t1.interrupt();
        } else {
            System.out.println("ä»»åŠ¡æ­£å¸¸å®Œæˆ");
        }
    }
}
```

---

## 3. Thread.yield() - çº¿ç¨‹è®©æ­¥

### 3.1 é—®é¢˜10ï¼šyield()çš„ä½œç”¨æ˜¯ä»€ä¹ˆï¼Ÿ

**å®šä¹‰**ï¼š

```java
public static native void yield();
```

**æ ¸å¿ƒä½œç”¨**ï¼š
- æç¤ºè°ƒåº¦å™¨ï¼šå½“å‰çº¿ç¨‹æ„¿æ„æ”¾å¼ƒCPU
- çº¿ç¨‹ä»Running â†’ Readyï¼ˆä»ç„¶æ˜¯RUNNABLEçŠ¶æ€ï¼‰
- **ä»…ä»…æ˜¯æç¤ºï¼Œä¸ä¿è¯ä¸€å®šè®©æ­¥**

---

### 3.2 é—®é¢˜11ï¼šyield()çš„å·¥ä½œåŸç†æ˜¯ä»€ä¹ˆï¼Ÿ

**çŠ¶æ€è½¬æ¢**ï¼š

```
RUNNABLE (è¿è¡Œä¸­)
    â†“ Thread.yield()
RUNNABLE (å°±ç»ª)
    â†“ å¯èƒ½ç«‹å³è¢«å†æ¬¡è°ƒåº¦
RUNNABLE (è¿è¡Œä¸­)
```

**å…³é”®ç‰¹ç‚¹**ï¼š

1. **ä¸é‡Šæ”¾é”**ï¼šå’Œsleep()ä¸€æ ·
2. **ä¸ä¿è¯è®©æ­¥**ï¼šåªæ˜¯å»ºè®®ï¼Œè°ƒåº¦å™¨å¯ä»¥å¿½ç•¥
3. **ä¸è¿›å…¥ç­‰å¾…çŠ¶æ€**ï¼šä»ç„¶æ˜¯RUNNABLE
4. **å¯èƒ½ç«‹å³è¢«å†æ¬¡è°ƒåº¦**ï¼šå¦‚æœæ²¡æœ‰å…¶ä»–åŒä¼˜å…ˆçº§çº¿ç¨‹

**ç¤ºä¾‹ä»£ç **ï¼š

```java
public class YieldExample {
    public static void main(String[] args) {
        Thread t1 = new Thread(() -> {
            for (int i = 0; i < 5; i++) {
                System.out.println("t1: " + i);
                Thread.yield(); // è®©æ­¥
            }
        });
        
        Thread t2 = new Thread(() -> {
            for (int i = 0; i < 5; i++) {
                System.out.println("t2: " + i);
                Thread.yield(); // è®©æ­¥
            }
        });
        
        t1.start();
        t2.start();
    }
}
```

**å¯èƒ½çš„è¾“å‡º**ï¼ˆä¸ç¡®å®šï¼‰ï¼š

```
t1: 0
t2: 0
t1: 1
t2: 1
t1: 2
t2: 2
...
```

---

### 3.3 é—®é¢˜12ï¼šyield()çš„ä½¿ç”¨åœºæ™¯å’Œé™·é˜±æ˜¯ä»€ä¹ˆï¼Ÿ

#### ä½¿ç”¨åœºæ™¯ï¼š

1. **è°ƒè¯•å’Œæµ‹è¯•**ï¼šå¢åŠ çº¿ç¨‹åˆ‡æ¢çš„æ¦‚ç‡ï¼Œæš´éœ²å¹¶å‘é—®é¢˜
2. **é˜²æ­¢çº¿ç¨‹é¥¥é¥¿**ï¼šè®©ä½ä¼˜å…ˆçº§çº¿ç¨‹æœ‰æœºä¼šæ‰§è¡Œ
3. **é™ä½CPUå ç”¨**ï¼šåœ¨å¾ªç¯ä¸­é€‚å½“è®©æ­¥

#### é™·é˜±ï¼š

```java
// âŒ é”™è¯¯ï¼šyield()ä¸èƒ½æ›¿ä»£sleep()
while (running) {
    Thread.yield(); // å¯èƒ½æ²¡æœ‰æ•ˆæœï¼ŒCPUä»ç„¶100%
}

// âœ… æ­£ç¡®ï¼šä½¿ç”¨sleep()
while (running) {
    try {
        Thread.sleep(100);
    } catch (InterruptedException e) {
        break;
    }
}
```

**ä¸ºä»€ä¹ˆyield()ä¸å¯é ï¼Ÿ**

- ä¾èµ–æ“ä½œç³»ç»Ÿå®ç°
- ä¸åŒå¹³å°è¡Œä¸ºä¸åŒ
- æ— æ³•ä¿è¯è®©æ­¥æ•ˆæœ

**å»ºè®®**ï¼š
- âš ï¸ ä¸è¦ä¾èµ–yield()å®ç°ä¸šåŠ¡é€»è¾‘
- âœ… ä»…ç”¨äºæµ‹è¯•å’Œè°ƒè¯•
- âœ… ç”Ÿäº§ç¯å¢ƒä½¿ç”¨sleep()æˆ–wait()

---

## 4. wait/notify/notifyAll - çº¿ç¨‹é€šä¿¡

### 4.1 é—®é¢˜13ï¼šä¸ºä»€ä¹ˆéœ€è¦wait/notifyï¼Ÿ

**åœºæ™¯ï¼šç”Ÿäº§è€…-æ¶ˆè´¹è€…é—®é¢˜**

```java
// âŒ é”™è¯¯æ–¹å¼ï¼šå¿™ç­‰å¾…
public class BusyWaiting {
    private static final List<Integer> buffer = new ArrayList<>();
    private static final int MAX_SIZE = 10;
    
    // æ¶ˆè´¹è€…
    public static void consumer() {
        while (true) {
            synchronized (buffer) {
                while (buffer.isEmpty()) {
                    // å¿™ç­‰å¾…ï¼Œæµªè´¹CPU
                }
                Integer item = buffer.remove(0);
                System.out.println("æ¶ˆè´¹: " + item);
            }
        }
    }
}
```

**é—®é¢˜**ï¼š
- æ¶ˆè´¹è€…åœ¨ç©ºç¼“å†²åŒºæ—¶ç–¯ç‹‚å¾ªç¯ï¼Œæµªè´¹CPU
- æŒæœ‰é”çš„åŒæ—¶å¾ªç¯ï¼Œç”Ÿäº§è€…æ— æ³•æ·»åŠ æ•°æ®
- æ­»é”ï¼

**è§£å†³æ–¹æ¡ˆï¼šwait/notify**

---

### 4.2 é—®é¢˜14ï¼šwait/notifyçš„å·¥ä½œåŸç†æ˜¯ä»€ä¹ˆï¼Ÿ

**å®šä¹‰**ï¼š

```java
// Objectç±»çš„æ–¹æ³•ï¼ˆä¸æ˜¯Threadç±»ï¼ï¼‰
public final void wait() throws InterruptedException;
public final native void wait(long timeout) throws InterruptedException;
public final void wait(long timeout, int nanos) throws InterruptedException;

public final native void notify();
public final native void notifyAll();
```

**æ ¸å¿ƒç‰¹ç‚¹**ï¼š

1. **å¿…é¡»åœ¨synchronizedå—ä¸­è°ƒç”¨**
2. **wait()ä¼šé‡Šæ”¾é”**ï¼ˆä¸sleep()ä¸åŒï¼ï¼‰
3. **notify()å”¤é†’ä¸€ä¸ªç­‰å¾…çº¿ç¨‹**
4. **notifyAll()å”¤é†’æ‰€æœ‰ç­‰å¾…çº¿ç¨‹**

---

### 4.3 é—®é¢˜15ï¼šwait()çš„å®Œæ•´æµç¨‹æ˜¯ä»€ä¹ˆï¼Ÿ

**æµç¨‹å›¾**ï¼š

```
çº¿ç¨‹æŒæœ‰é”
    â†“
è°ƒç”¨obj.wait()
    â†“
é‡Šæ”¾é”
    â†“
è¿›å…¥objçš„ç­‰å¾…é˜Ÿåˆ—
    â†“
çº¿ç¨‹çŠ¶æ€: WAITING
    â†“
å…¶ä»–çº¿ç¨‹è°ƒç”¨obj.notify()
    â†“
ä»ç­‰å¾…é˜Ÿåˆ—ç§»åˆ°åŒæ­¥é˜Ÿåˆ—
    â†“
ç«äº‰é”
    â†“
è·å¾—é”
    â†“
wait()è¿”å›
    â†“
ç»§ç»­æ‰§è¡Œ
```

**ç¤ºä¾‹ä»£ç **ï¼š

```java
public class WaitNotifyExample {
    private static final Object lock = new Object();
    private static boolean condition = false;
    
    public static void main(String[] args) throws InterruptedException {
        // ç­‰å¾…çº¿ç¨‹
        Thread waiter = new Thread(() -> {
            synchronized (lock) {
                System.out.println("ç­‰å¾…çº¿ç¨‹ï¼šæ£€æŸ¥æ¡ä»¶");
                while (!condition) {
                    try {
                        System.out.println("ç­‰å¾…çº¿ç¨‹ï¼šæ¡ä»¶ä¸æ»¡è¶³ï¼Œå¼€å§‹ç­‰å¾…");
                        lock.wait(); // é‡Šæ”¾é”ï¼Œè¿›å…¥ç­‰å¾…
                        System.out.println("ç­‰å¾…çº¿ç¨‹ï¼šè¢«å”¤é†’ï¼Œé‡æ–°æ£€æŸ¥æ¡ä»¶");
                    } catch (InterruptedException e) {
                        e.printStackTrace();
                    }
                }
                System.out.println("ç­‰å¾…çº¿ç¨‹ï¼šæ¡ä»¶æ»¡è¶³ï¼Œç»§ç»­æ‰§è¡Œ");
            }
        });
        
        // é€šçŸ¥çº¿ç¨‹
        Thread notifier = new Thread(() -> {
            synchronized (lock) {
                System.out.println("é€šçŸ¥çº¿ç¨‹ï¼šä¿®æ”¹æ¡ä»¶");
                condition = true;
                System.out.println("é€šçŸ¥çº¿ç¨‹ï¼šå”¤é†’ç­‰å¾…çº¿ç¨‹");
                lock.notify();
            }
        });
        
        waiter.start();
        Thread.sleep(1000); // ç¡®ä¿waiterå…ˆæ‰§è¡Œ
        notifier.start();
    }
}
```

**æ‰§è¡Œç»“æœ**ï¼š

```
ç­‰å¾…çº¿ç¨‹ï¼šæ£€æŸ¥æ¡ä»¶
ç­‰å¾…çº¿ç¨‹ï¼šæ¡ä»¶ä¸æ»¡è¶³ï¼Œå¼€å§‹ç­‰å¾…
é€šçŸ¥çº¿ç¨‹ï¼šä¿®æ”¹æ¡ä»¶
é€šçŸ¥çº¿ç¨‹ï¼šå”¤é†’ç­‰å¾…çº¿ç¨‹
ç­‰å¾…çº¿ç¨‹ï¼šè¢«å”¤é†’ï¼Œé‡æ–°æ£€æŸ¥æ¡ä»¶
ç­‰å¾…çº¿ç¨‹ï¼šæ¡ä»¶æ»¡è¶³ï¼Œç»§ç»­æ‰§è¡Œ
```

---

### 4.4 é—®é¢˜16ï¼šä¸ºä»€ä¹ˆwait()å¿…é¡»åœ¨å¾ªç¯ä¸­è°ƒç”¨ï¼Ÿ

**é”™è¯¯ç¤ºä¾‹**ï¼š

```java
// âŒ é”™è¯¯ï¼šä½¿ç”¨ifåˆ¤æ–­
synchronized (lock) {
    if (!condition) {
        lock.wait(); // å¯èƒ½å‡ºç°è™šå‡å”¤é†’ï¼
    }
    // ç»§ç»­æ‰§è¡Œ
}
```

**æ­£ç¡®ç¤ºä¾‹**ï¼š

```java
// âœ… æ­£ç¡®ï¼šä½¿ç”¨whileå¾ªç¯
synchronized (lock) {
    while (!condition) {
        lock.wait(); // è¢«å”¤é†’åé‡æ–°æ£€æŸ¥æ¡ä»¶
    }
    // ç»§ç»­æ‰§è¡Œ
}
```

**åŸå› ï¼šè™šå‡å”¤é†’ï¼ˆSpurious Wakeupï¼‰**

1. **æ“ä½œç³»ç»Ÿå¯èƒ½æ— æ•…å”¤é†’çº¿ç¨‹**
2. **notify()å¯èƒ½å”¤é†’é”™è¯¯çš„çº¿ç¨‹**
3. **æ¡ä»¶å¯èƒ½è¢«å…¶ä»–çº¿ç¨‹æ”¹å˜**

**ç¤ºä¾‹ï¼šå¤šä¸ªæ¶ˆè´¹è€…**

```java
public class SpuriousWakeup {
    private static final List<Integer> buffer = new ArrayList<>();
    
    // æ¶ˆè´¹è€…1
    public static void consumer1() {
        synchronized (buffer) {
            if (buffer.isEmpty()) { // âŒ ä½¿ç”¨if
                buffer.wait();
            }
            Integer item = buffer.remove(0); // å¯èƒ½æŠ›å‡ºå¼‚å¸¸ï¼
        }
    }
    
    // æ¶ˆè´¹è€…2
    public static void consumer2() {
        synchronized (buffer) {
            if (buffer.isEmpty()) { // âŒ ä½¿ç”¨if
                buffer.wait();
            }
            Integer item = buffer.remove(0); // å¯èƒ½æŠ›å‡ºå¼‚å¸¸ï¼
        }
    }
    
    // ç”Ÿäº§è€…
    public static void producer() {
        synchronized (buffer) {
            buffer.add(1);
            buffer.notifyAll(); // å”¤é†’æ‰€æœ‰æ¶ˆè´¹è€…
        }
    }
}
```

**é—®é¢˜**ï¼š
- ç”Ÿäº§è€…æ·»åŠ 1ä¸ªå…ƒç´ ï¼Œå”¤é†’2ä¸ªæ¶ˆè´¹è€…
- æ¶ˆè´¹è€…1è·å¾—é”ï¼Œæ¶ˆè´¹å…ƒç´ 
- æ¶ˆè´¹è€…2è·å¾—é”ï¼Œç¼“å†²åŒºå·²ç©ºï¼ŒæŠ›å‡ºå¼‚å¸¸ï¼

**è§£å†³**ï¼šä½¿ç”¨whileå¾ªç¯

```java
synchronized (buffer) {
    while (buffer.isEmpty()) { // âœ… ä½¿ç”¨while
        buffer.wait();
    }
    Integer item = buffer.remove(0); // å®‰å…¨
}
```

---

### 4.5 é—®é¢˜17ï¼šnotify() vs notifyAll()ï¼Œåº”è¯¥ç”¨å“ªä¸ªï¼Ÿ

**åŒºåˆ«**ï¼š

| æ–¹æ³• | è¡Œä¸º | é€‚ç”¨åœºæ™¯ |
|------|------|---------|
| **notify()** | éšæœºå”¤é†’ä¸€ä¸ªç­‰å¾…çº¿ç¨‹ | æ‰€æœ‰ç­‰å¾…çº¿ç¨‹ç­‰å¾…ç›¸åŒæ¡ä»¶ |
| **notifyAll()** | å”¤é†’æ‰€æœ‰ç­‰å¾…çº¿ç¨‹ | ç­‰å¾…çº¿ç¨‹ç­‰å¾…ä¸åŒæ¡ä»¶ |

**ç¤ºä¾‹ï¼šç”Ÿäº§è€…-æ¶ˆè´¹è€…ï¼ˆå®Œæ•´ç‰ˆï¼‰**

```java
public class ProducerConsumer {
    private static final List<Integer> buffer = new ArrayList<>();
    private static final int MAX_SIZE = 10;
    private static final Object lock = new Object();
    
    // ç”Ÿäº§è€…
    static class Producer implements Runnable {
        @Override
        public void run() {
            int value = 0;
            while (true) {
                synchronized (lock) {
                    // ç¼“å†²åŒºæ»¡ï¼Œç­‰å¾…
                    while (buffer.size() == MAX_SIZE) {
                        try {
                            System.out.println("ç”Ÿäº§è€…ç­‰å¾…ï¼šç¼“å†²åŒºå·²æ»¡");
                            lock.wait();
                        } catch (InterruptedException e) {
                            e.printStackTrace();
                        }
                    }
                    
                    // ç”Ÿäº§
                    buffer.add(value);
                    System.out.println("ç”Ÿäº§: " + value);
                    value++;
                    
                    // å”¤é†’æ¶ˆè´¹è€…
                    lock.notifyAll(); // ä½¿ç”¨notifyAll()
                }
                
                try {
                    Thread.sleep(100);
                } catch (InterruptedException e) {
                    e.printStackTrace();
                }
            }
        }
    }
    
    // æ¶ˆè´¹è€…
    static class Consumer implements Runnable {
        @Override
        public void run() {
            while (true) {
                synchronized (lock) {
                    // ç¼“å†²åŒºç©ºï¼Œç­‰å¾…
                    while (buffer.isEmpty()) {
                        try {
                            System.out.println("æ¶ˆè´¹è€…ç­‰å¾…ï¼šç¼“å†²åŒºä¸ºç©º");
                            lock.wait();
                        } catch (InterruptedException e) {
                            e.printStackTrace();
                        }
                    }
                    
                    // æ¶ˆè´¹
                    Integer value = buffer.remove(0);
                    System.out.println("æ¶ˆè´¹: " + value);
                    
                    // å”¤é†’ç”Ÿäº§è€…
                    lock.notifyAll(); // ä½¿ç”¨notifyAll()
                }
                
                try {
                    Thread.sleep(200);
                } catch (InterruptedException e) {
                    e.printStackTrace();
                }
            }
        }
    }
    
    public static void main(String[] args) {
        new Thread(new Producer()).start();
        new Thread(new Consumer()).start();
    }
}
```

**ä¸ºä»€ä¹ˆä½¿ç”¨notifyAll()ï¼Ÿ**

- ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…ç­‰å¾…ä¸åŒæ¡ä»¶
- notify()å¯èƒ½å”¤é†’é”™è¯¯çš„çº¿ç¨‹ï¼ˆç”Ÿäº§è€…å”¤é†’ç”Ÿäº§è€…ï¼‰
- notifyAll()ä¿è¯æ­£ç¡®çš„çº¿ç¨‹è¢«å”¤é†’

**æ€§èƒ½è€ƒè™‘**ï¼š
- notifyAll()ä¼šå”¤é†’æ‰€æœ‰çº¿ç¨‹ï¼Œå¯èƒ½å¯¼è‡´"æƒŠç¾¤æ•ˆåº”"
- ä½†ä¿è¯æ­£ç¡®æ€§æ›´é‡è¦
- å¦‚æœç¡®å®šåªæœ‰ä¸€ç§ç­‰å¾…çº¿ç¨‹ï¼Œå¯ä»¥ä½¿ç”¨notify()

---

## 5. Lost Wakeupï¼ˆä¸¢å¤±å”¤é†’ï¼‰é—®é¢˜

### 5.1 é—®é¢˜18ï¼šä»€ä¹ˆæ˜¯Lost Wakeupï¼Ÿ

**å®šä¹‰**ï¼š

Lost Wakeupï¼ˆä¸¢å¤±å”¤é†’ï¼‰æ˜¯æŒ‡ï¼š`notify()`åœ¨`wait()`ä¹‹å‰æ‰§è¡Œï¼Œå¯¼è‡´å”¤é†’ä¿¡å·ä¸¢å¤±ï¼Œç­‰å¾…çº¿ç¨‹æ°¸è¿œæ— æ³•è¢«å”¤é†’çš„é—®é¢˜ã€‚

**é—®é¢˜åœºæ™¯**ï¼š

```
æ—¶é—´çº¿ï¼š
T1: çº¿ç¨‹Aæ£€æŸ¥æ¡ä»¶ï¼ˆæ¡ä»¶ä¸æ»¡è¶³ï¼‰
T2: çº¿ç¨‹Bä¿®æ”¹æ¡ä»¶ï¼Œè°ƒç”¨notify()  â† æ­¤æ—¶çº¿ç¨‹Aè¿˜æ²¡æœ‰wait()
T3: çº¿ç¨‹Aè°ƒç”¨wait()              â† å”¤é†’ä¿¡å·å·²ç»ä¸¢å¤±ï¼
T4: çº¿ç¨‹Aæ°¸è¿œç­‰å¾…...
```

---

### 5.2 é—®é¢˜19ï¼šLost Wakeupæ˜¯å¦‚ä½•å‘ç”Ÿçš„ï¼Ÿ

**é”™è¯¯ç¤ºä¾‹**ï¼š

```java
// âŒ é”™è¯¯ï¼šæ£€æŸ¥æ¡ä»¶åœ¨synchronizedå—å¤–
public class LostWakeupBug {
    private static final Object lock = new Object();
    private static boolean ready = false;
    
    // ç­‰å¾…çº¿ç¨‹
    static class Waiter implements Runnable {
        @Override
        public void run() {
            // æ£€æŸ¥æ¡ä»¶ï¼ˆæ²¡æœ‰åŒæ­¥ä¿æŠ¤ï¼‰
            if (!ready) {
                System.out.println("æ¡ä»¶ä¸æ»¡è¶³ï¼Œå‡†å¤‡wait...");
                
                // å‡è®¾è¿™é‡Œå‘ç”Ÿçº¿ç¨‹åˆ‡æ¢
                // æ­¤æ—¶notifierå¯èƒ½å·²ç»æ‰§è¡Œäº†notify()
                
                synchronized (lock) {
                    try {
                        lock.wait(); // å”¤é†’ä¿¡å·å·²ç»ä¸¢å¤±ï¼
                    } catch (InterruptedException e) {
                        e.printStackTrace();
                    }
                }
            }
        }
    }
    
    // é€šçŸ¥çº¿ç¨‹
    static class Notifier implements Runnable {
        @Override
        public void run() {
            synchronized (lock) {
                ready = true;
                lock.notify(); // æ­¤æ—¶waiterè¿˜æ²¡æœ‰wait()
            }
        }
    }
}
```

**é—®é¢˜åˆ†æ**ï¼š

1. **ç«æ€æ¡ä»¶**ï¼šæ£€æŸ¥æ¡ä»¶å’Œè°ƒç”¨wait()ä¹‹é—´æ²¡æœ‰åŸå­æ€§
2. **æ—¶åºé—®é¢˜**ï¼šnotify()å¯èƒ½åœ¨wait()ä¹‹å‰æ‰§è¡Œ
3. **ä¿¡å·ä¸¢å¤±**ï¼šnotify()çš„å”¤é†’ä¿¡å·æ²¡æœ‰è¢«ä¿å­˜

---

### 5.3 é—®é¢˜20ï¼šå¦‚ä½•é¿å…Lost Wakeupï¼Ÿ

**è§£å†³æ–¹æ¡ˆï¼šæ£€æŸ¥æ¡ä»¶å’Œwait()å¿…é¡»åœ¨åŒä¸€ä¸ªsynchronizedå—ä¸­**

**æ­£ç¡®ç¤ºä¾‹**ï¼š

```java
// âœ… æ­£ç¡®ï¼šæ£€æŸ¥æ¡ä»¶å’Œwait()åœ¨åŒä¸€ä¸ªsynchronizedå—ä¸­
public class LostWakeupFix {
    private static final Object lock = new Object();
    private static boolean ready = false;
    
    // ç­‰å¾…çº¿ç¨‹
    static class Waiter implements Runnable {
        @Override
        public void run() {
            synchronized (lock) {
                // æ£€æŸ¥æ¡ä»¶å’Œwait()åœ¨åŒä¸€ä¸ªsynchronizedå—ä¸­
                while (!ready) {
                    try {
                        System.out.println("æ¡ä»¶ä¸æ»¡è¶³ï¼Œå¼€å§‹wait");
                        lock.wait();
                        System.out.println("è¢«å”¤é†’ï¼Œé‡æ–°æ£€æŸ¥æ¡ä»¶");
                    } catch (InterruptedException e) {
                        Thread.currentThread().interrupt();
                        return;
                    }
                }
                System.out.println("æ¡ä»¶æ»¡è¶³ï¼Œç»§ç»­æ‰§è¡Œ");
            }
        }
    }
    
    // é€šçŸ¥çº¿ç¨‹
    static class Notifier implements Runnable {
        @Override
        public void run() {
            synchronized (lock) {
                ready = true;
                System.out.println("ä¿®æ”¹æ¡ä»¶ï¼Œè°ƒç”¨notify");
                lock.notify();
            }
        }
    }
}
```

**ä¸ºä»€ä¹ˆè¿™æ ·èƒ½é¿å…Lost Wakeupï¼Ÿ**

1. **åŸå­æ€§**ï¼šæ£€æŸ¥æ¡ä»¶å’Œwait()åœ¨åŒä¸€ä¸ªsynchronizedå—ä¸­ï¼Œä¿è¯åŸå­æ€§
2. **æ¡ä»¶å˜é‡**ï¼šå³ä½¿notify()å…ˆæ‰§è¡Œï¼Œæ¡ä»¶å˜é‡`ready`ä¹Ÿèƒ½æ­£ç¡®ä¼ é€’ä¿¡æ¯
3. **whileå¾ªç¯**ï¼šè¢«å”¤é†’åé‡æ–°æ£€æŸ¥æ¡ä»¶ï¼Œé˜²æ­¢è™šå‡å”¤é†’

---

### 5.4 é—®é¢˜21ï¼šLost Wakeup vs è™šå‡å”¤é†’ï¼Œæœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ

| é—®é¢˜ | Lost Wakeup | è™šå‡å”¤é†’ |
|------|-------------|---------|
| **å®šä¹‰** | notify()åœ¨wait()ä¹‹å‰æ‰§è¡Œ | wait()è¢«æ„å¤–å”¤é†’ |
| **åŸå› ** | æ£€æŸ¥æ¡ä»¶å’Œwait()ä¸åŸå­ | æ“ä½œç³»ç»Ÿæˆ–JVMçš„å®ç° |
| **åæœ** | æ°¸è¿œç­‰å¾… | æ¡ä»¶ä¸æ»¡è¶³æ—¶ç»§ç»­æ‰§è¡Œ |
| **è§£å†³** | æ£€æŸ¥æ¡ä»¶å’Œwait()åœ¨åŒä¸€ä¸ªsynchronizedå— | ä½¿ç”¨whileå¾ªç¯æ£€æŸ¥æ¡ä»¶ |

**ä¸¤è€…çš„å…±åŒç‚¹**ï¼š
- éƒ½éœ€è¦ä½¿ç”¨`while`å¾ªç¯æ£€æŸ¥æ¡ä»¶
- éƒ½éœ€è¦åœ¨`synchronized`å—ä¸­æ“ä½œ

---

### 5.5 é—®é¢˜22ï¼šä¸ºä»€ä¹ˆæ¡ä»¶å˜é‡èƒ½é¿å…Lost Wakeupï¼Ÿ

**å…³é”®ç‚¹**ï¼šæ¡ä»¶å˜é‡ä¿å­˜äº†çŠ¶æ€ä¿¡æ¯

**å¯¹æ¯”åˆ†æ**ï¼š

```java
// åœºæ™¯1ï¼šæ²¡æœ‰æ¡ä»¶å˜é‡ï¼ˆå®¹æ˜“Lost Wakeupï¼‰
synchronized (lock) {
    lock.wait(); // å¦‚æœnotify()å·²ç»æ‰§è¡Œï¼Œå°±æ°¸è¿œç­‰å¾…
}

// åœºæ™¯2ï¼šæœ‰æ¡ä»¶å˜é‡ï¼ˆé¿å…Lost Wakeupï¼‰
synchronized (lock) {
    while (!ready) { // readyä¿å­˜äº†çŠ¶æ€
        lock.wait(); // å³ä½¿notify()å…ˆæ‰§è¡Œï¼Œreadyä¹Ÿæ˜¯trueï¼Œä¸ä¼šwait()
    }
}
```

**åŸç†**ï¼š
1. æ¡ä»¶å˜é‡`ready`ä¿å­˜äº†çŠ¶æ€ä¿¡æ¯
2. å³ä½¿`notify()`å…ˆæ‰§è¡Œï¼Œ`ready`å·²ç»æ˜¯`true`
3. ç­‰å¾…çº¿ç¨‹æ£€æŸ¥æ¡ä»¶æ—¶å‘ç°å·²æ»¡è¶³ï¼Œä¸ä¼šè°ƒç”¨`wait()`
4. é¿å…äº†Lost Wakeup

---

### 5.6 é—®é¢˜23ï¼šå®é™…å¼€å‘ä¸­å¦‚ä½•é¿å…Lost Wakeupï¼Ÿ

**æœ€ä½³å®è·µ**ï¼š

```java
// æ ‡å‡†æ¨¡å¼ï¼ˆæ¨èï¼‰
synchronized (lock) {
    while (!condition) {  // 1. ä½¿ç”¨whileå¾ªç¯
        try {
            lock.wait();  // 2. wait()åœ¨synchronizedå—ä¸­
        } catch (InterruptedException e) {
            Thread.currentThread().interrupt();
            return;       // 3. æ­£ç¡®å¤„ç†ä¸­æ–­
        }
    }
    // æ‰§è¡Œä»»åŠ¡
}

// ä¿®æ”¹æ¡ä»¶å¹¶é€šçŸ¥
synchronized (lock) {
    condition = true;     // 1. å…ˆä¿®æ”¹æ¡ä»¶
    lock.notifyAll();     // 2. å†é€šçŸ¥
}
```

**æ ¸å¿ƒåŸåˆ™**ï¼š
1. âœ… æ£€æŸ¥æ¡ä»¶å’Œ`wait()`å¿…é¡»åœ¨åŒä¸€ä¸ª`synchronized`å—ä¸­
2. âœ… ä½¿ç”¨`while`å¾ªç¯è€Œä¸æ˜¯`if`æ£€æŸ¥æ¡ä»¶
3. âœ… ä½¿ç”¨æ¡ä»¶å˜é‡ä¿å­˜çŠ¶æ€
4. âœ… ä¿®æ”¹æ¡ä»¶åç«‹å³è°ƒç”¨`notify()`/`notifyAll()`
5. âœ… ä¼˜å…ˆä½¿ç”¨`notifyAll()`è€Œä¸æ˜¯`notify()`

---

### 5.7 é—®é¢˜24ï¼šä½¿ç”¨Lockå’ŒConditionèƒ½é¿å…Lost Wakeupå—ï¼Ÿ

**å¯ä»¥ï¼Œè€Œä¸”æ›´å®‰å…¨**ï¼š

```java
import java.util.concurrent.locks.Lock;
import java.util.concurrent.locks.ReentrantLock;
import java.util.concurrent.locks.Condition;

public class LockConditionExample {
    private final Lock lock = new ReentrantLock();
    private final Condition condition = lock.newCondition();
    private boolean ready = false;
    
    // ç­‰å¾…çº¿ç¨‹
    public void waitForCondition() {
        lock.lock();
        try {
            while (!ready) {
                condition.await(); // ç±»ä¼¼wait()
            }
            System.out.println("æ¡ä»¶æ»¡è¶³");
        } catch (InterruptedException e) {
            Thread.currentThread().interrupt();
        } finally {
            lock.unlock();
        }
    }
    
    // é€šçŸ¥çº¿ç¨‹
    public void signalCondition() {
        lock.lock();
        try {
            ready = true;
            condition.signal(); // ç±»ä¼¼notify()
        } finally {
            lock.unlock();
        }
    }
}
```

**ä¼˜åŠ¿**ï¼š
- âœ… æ›´çµæ´»çš„é”æ§åˆ¶
- âœ… å¯ä»¥æœ‰å¤šä¸ªCondition
- âœ… æ”¯æŒå…¬å¹³é”
- âœ… å¯ä¸­æ–­çš„é”è·å–

---

## 6. æ–¹æ³•å¯¹æ¯”æ€»ç»“

### 6.1 é—®é¢˜25ï¼šsleep vs waitï¼Œæœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ

| ç»´åº¦ | sleep() | wait() |
|------|---------|--------|
| **æ‰€å±ç±»** | Threadç±» | Objectç±» |
| **é‡Šæ”¾é”** | ä¸é‡Šæ”¾ | é‡Šæ”¾ |
| **ä½¿ç”¨ä½ç½®** | ä»»ä½•åœ°æ–¹ | å¿…é¡»åœ¨synchronizedå—ä¸­ |
| **å”¤é†’æ–¹å¼** | è¶…æ—¶è‡ªåŠ¨å”¤é†’ | notify/notifyAllå”¤é†’ |
| **ç”¨é€”** | æš‚åœæ‰§è¡Œ | çº¿ç¨‹é€šä¿¡ |

**è®°å¿†å£è¯€**ï¼š
- sleepæ˜¯ç¡è§‰ï¼ŒæŠ±ç€é”ç¡
- waitæ˜¯ç­‰å¾…ï¼Œæ”¾ä¸‹é”ç­‰

---

### 5.2 é—®é¢˜19ï¼šjoin vs waitï¼Œæœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ

| ç»´åº¦ | join() | wait() |
|------|--------|--------|
| **ç›®çš„** | ç­‰å¾…çº¿ç¨‹ç»“æŸ | ç­‰å¾…æ¡ä»¶æ»¡è¶³ |
| **åº•å±‚å®ç°** | ä½¿ç”¨wait() | nativeæ–¹æ³• |
| **å”¤é†’æ–¹å¼** | JVMè‡ªåŠ¨notifyAll() | æ‰‹åŠ¨notify/notifyAll() |
| **ä½¿ç”¨åœºæ™¯** | ç­‰å¾…å­ä»»åŠ¡å®Œæˆ | çº¿ç¨‹é—´é€šä¿¡ |

---

### 5.3 é—®é¢˜20ï¼šyield vs sleepï¼Œæœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ

| ç»´åº¦ | yield() | sleep() |
|------|---------|---------|
| **çŠ¶æ€** | RUNNABLE | TIMED_WAITING |
| **ä¿è¯æ€§** | ä¸ä¿è¯è®©æ­¥ | ä¿è¯æš‚åœ |
| **æ—¶é—´æ§åˆ¶** | æ—  | ç²¾ç¡®ï¼ˆç›¸å¯¹ï¼‰ |
| **å¯é æ€§** | ä¸å¯é  | å¯é  |

---

## 6. ç»å…¸é¢è¯•é¢˜ï¼šä¸¤ä¸ªçº¿ç¨‹äº¤æ›¿æ‰“å°1åˆ°100

### 6.1 é—®é¢˜21ï¼šå¦‚ä½•å®ç°ä¸¤ä¸ªçº¿ç¨‹äº¤æ›¿æ‰“å°ï¼Ÿ

è¿™æ˜¯ä¸€é“ç»å…¸çš„é¢è¯•é¢˜ï¼Œè€ƒå¯Ÿå¯¹çº¿ç¨‹åä½œæœºåˆ¶çš„ç†è§£ã€‚

**éœ€æ±‚**ï¼š
- çº¿ç¨‹1æ‰“å°å¥‡æ•°ï¼š1, 3, 5, 7, ...
- çº¿ç¨‹2æ‰“å°å¶æ•°ï¼š2, 4, 6, 8, ...
- ä¸¤ä¸ªçº¿ç¨‹äº¤æ›¿æ‰§è¡Œï¼ŒæŒ‰é¡ºåºæ‰“å°1åˆ°100

---

### 6.2 æ–¹æ¡ˆ1ï¼šä½¿ç”¨wait/notifyå®ç°

**æ ¸å¿ƒæ€è·¯**ï¼š
1. ä½¿ç”¨å…±äº«å˜é‡è®°å½•å½“å‰æ•°å­—
2. ä½¿ç”¨æ ‡å¿—ä½åˆ¤æ–­è½®åˆ°å“ªä¸ªçº¿ç¨‹
3. ä¸æ˜¯è‡ªå·±çš„å›åˆå°±wait()
4. æ‰“å°å®Œånotify()å”¤é†’å¦ä¸€ä¸ªçº¿ç¨‹

**å®ç°ä»£ç **ï¼š

```java
public class AlternatePrint {
    private static final Object lock = new Object();
    private static int currentNumber = 1;
    private static final int MAX = 100;
    
    public static void main(String[] args) {
        // å¥‡æ•°çº¿ç¨‹
        Thread oddThread = new Thread(() -> {
            synchronized (lock) {
                while (currentNumber <= MAX) {
                    // å¦‚æœå½“å‰æ•°å­—æ˜¯å¶æ•°ï¼Œç­‰å¾…
                    while (currentNumber % 2 == 0 && currentNumber <= MAX) {
                        try {
                            lock.wait();
                        } catch (InterruptedException e) {
                            Thread.currentThread().interrupt();
                            return;
                        }
                    }
                    
                    // æ‰“å°å¥‡æ•°
                    if (currentNumber <= MAX) {
                        System.out.println("å¥‡æ•°çº¿ç¨‹: " + currentNumber);
                        currentNumber++;
                        lock.notify(); // å”¤é†’å¶æ•°çº¿ç¨‹
                    }
                }
            }
        }, "OddThread");
        
        // å¶æ•°çº¿ç¨‹
        Thread evenThread = new Thread(() -> {
            synchronized (lock) {
                while (currentNumber <= MAX) {
                    // å¦‚æœå½“å‰æ•°å­—æ˜¯å¥‡æ•°ï¼Œç­‰å¾…
                    while (currentNumber % 2 == 1 && currentNumber <= MAX) {
                        try {
                            lock.wait();
                        } catch (InterruptedException e) {
                            Thread.currentThread().interrupt();
                            return;
                        }
                    }
                    
                    // æ‰“å°å¶æ•°
                    if (currentNumber <= MAX) {
                        System.out.println("å¶æ•°çº¿ç¨‹: " + currentNumber);
                        currentNumber++;
                        lock.notify(); // å”¤é†’å¥‡æ•°çº¿ç¨‹
                    }
                }
            }
        }, "EvenThread");
        
        oddThread.start();
        evenThread.start();
    }
}
```

**å…³é”®ç‚¹**ï¼š
1. âœ… ä½¿ç”¨`while`è€Œä¸æ˜¯`if`æ£€æŸ¥æ¡ä»¶ï¼ˆé˜²æ­¢è™šå‡å”¤é†’ï¼‰
2. âœ… åœ¨ä¿®æ”¹å…±äº«å˜é‡åè°ƒç”¨`notify()`
3. âœ… ä¸¤ä¸ªçº¿ç¨‹éƒ½åœ¨åŒä¸€ä¸ªé”å¯¹è±¡ä¸ŠåŒæ­¥
4. âœ… æ£€æŸ¥è¾¹ç•Œæ¡ä»¶ï¼ˆcurrentNumber <= MAXï¼‰

---

### 6.3 æ–¹æ¡ˆ2ï¼šä½¿ç”¨æ ‡å¿—ä½å®ç°

**æ ¸å¿ƒæ€è·¯**ï¼š
1. ä½¿ç”¨å¸ƒå°”æ ‡å¿—ä½æ§åˆ¶è½®æ¬¡
2. æ¯ä¸ªçº¿ç¨‹è´Ÿè´£æ‰“å°å›ºå®šçš„æ•°å­—åºåˆ—
3. é€šè¿‡wait/notifyå®ç°è½®æµ

**å®ç°ä»£ç **ï¼š

```java
public class AlternatePrinter {
    private final Object lock = new Object();
    private boolean isOddTurn = true; // trueè¡¨ç¤ºè½®åˆ°å¥‡æ•°
    
    /**
     * æ‰“å°å¥‡æ•°
     */
    public void printOdd(int number) {
        synchronized (lock) {
            // å¦‚æœä¸æ˜¯å¥‡æ•°çš„å›åˆï¼Œç­‰å¾…
            while (!isOddTurn) {
                try {
                    lock.wait();
                } catch (InterruptedException e) {
                    Thread.currentThread().interrupt();
                    return;
                }
            }
            
            System.out.println("çº¿ç¨‹1: " + number);
            isOddTurn = false; // åˆ‡æ¢åˆ°å¶æ•°å›åˆ
            lock.notify(); // å”¤é†’å¶æ•°çº¿ç¨‹
        }
    }
    
    /**
     * æ‰“å°å¶æ•°
     */
    public void printEven(int number) {
        synchronized (lock) {
            // å¦‚æœä¸æ˜¯å¶æ•°çš„å›åˆï¼Œç­‰å¾…
            while (isOddTurn) {
                try {
                    lock.wait();
                } catch (InterruptedException e) {
                    Thread.currentThread().interrupt();
                    return;
                }
            }
            
            System.out.println("çº¿ç¨‹2: " + number);
            isOddTurn = true; // åˆ‡æ¢åˆ°å¥‡æ•°å›åˆ
            lock.notify(); // å”¤é†’å¥‡æ•°çº¿ç¨‹
        }
    }
}

// ä½¿ç”¨ç¤ºä¾‹
public static void main(String[] args) throws InterruptedException {
    AlternatePrinter printer = new AlternatePrinter();
    
    // çº¿ç¨‹1æ‰“å°å¥‡æ•°
    Thread t1 = new Thread(() -> {
        for (int i = 1; i <= 100; i += 2) {
            printer.printOdd(i);
        }
    }, "Thread-1");
    
    // çº¿ç¨‹2æ‰“å°å¶æ•°
    Thread t2 = new Thread(() -> {
        for (int i = 2; i <= 100; i += 2) {
            printer.printEven(i);
        }
    }, "Thread-2");
    
    t1.start();
    t2.start();
    
    t1.join();
    t2.join();
}
```

**ä¼˜ç‚¹**ï¼š
- âœ… é€»è¾‘æ¸…æ™°ï¼ŒèŒè´£åˆ†æ˜
- âœ… æ˜“äºæ‰©å±•ï¼ˆå¯ä»¥è½»æ¾æ”¹ä¸º3ä¸ªæˆ–æ›´å¤šçº¿ç¨‹ï¼‰
- âœ… æ›´ç¬¦åˆé¢å‘å¯¹è±¡è®¾è®¡

---

### 6.4 é—®é¢˜22ï¼šä¸ºä»€ä¹ˆè¦ç”¨whileè€Œä¸æ˜¯ifï¼Ÿ

**é”™è¯¯ç¤ºä¾‹ï¼ˆä½¿ç”¨ifï¼‰**ï¼š

```java
// âŒ é”™è¯¯ï¼šä½¿ç”¨if
synchronized (lock) {
    if (!isMyTurn) {
        lock.wait(); // è™šå‡å”¤é†’æ—¶ä¸ä¼šé‡æ–°æ£€æŸ¥
    }
    // æ‰§è¡Œä»»åŠ¡
}
```

**æ­£ç¡®ç¤ºä¾‹ï¼ˆä½¿ç”¨whileï¼‰**ï¼š

```java
// âœ… æ­£ç¡®ï¼šä½¿ç”¨while
synchronized (lock) {
    while (!isMyTurn) {
        lock.wait(); // è¢«å”¤é†’åé‡æ–°æ£€æŸ¥æ¡ä»¶
    }
    // æ‰§è¡Œä»»åŠ¡
}
```

**åŸå› **ï¼š
1. **è™šå‡å”¤é†’**ï¼šæ“ä½œç³»ç»Ÿå¯èƒ½åœ¨æ²¡æœ‰notifyçš„æƒ…å†µä¸‹å”¤é†’çº¿ç¨‹
2. **å¤šä¸ªç­‰å¾…çº¿ç¨‹**ï¼šnotifyAll()ä¼šå”¤é†’æ‰€æœ‰çº¿ç¨‹ï¼Œä½†åªæœ‰ä¸€ä¸ªèƒ½ç»§ç»­
3. **æ¡ä»¶å˜åŒ–**ï¼šè¢«å”¤é†’æ—¶æ¡ä»¶å¯èƒ½å·²ç»ä¸æ»¡è¶³äº†

---

### 6.5 é—®é¢˜23ï¼šèƒ½å¦ä½¿ç”¨notifyAll()ï¼Ÿ

**å¯ä»¥ï¼Œä½†è¦æ³¨æ„**ï¼š

```java
// ä½¿ç”¨notifyAll()
synchronized (lock) {
    while (!isMyTurn) {
        lock.wait();
    }
    System.out.println(number);
    isMyTurn = !isMyTurn;
    lock.notifyAll(); // å”¤é†’æ‰€æœ‰ç­‰å¾…çº¿ç¨‹
}
```

**å¯¹æ¯”**ï¼š

| æ–¹æ³• | ä¼˜ç‚¹ | ç¼ºç‚¹ | é€‚ç”¨åœºæ™¯ |
|------|------|------|---------|
| **notify()** | æ€§èƒ½å¥½ | å¯èƒ½å”¤é†’é”™è¯¯çš„çº¿ç¨‹ | åªæœ‰ä¸€ç§ç­‰å¾…çº¿ç¨‹ |
| **notifyAll()** | å®‰å…¨ | æ€§èƒ½ç•¥å·® | å¤šç§ç­‰å¾…çº¿ç¨‹ |

**å»ºè®®**ï¼š
- å¦‚æœåªæœ‰ä¸¤ä¸ªçº¿ç¨‹äº¤æ›¿ï¼Œç”¨`notify()`å³å¯
- å¦‚æœæœ‰å¤šä¸ªçº¿ç¨‹æˆ–å¤æ‚æ¡ä»¶ï¼Œç”¨`notifyAll()`æ›´å®‰å…¨

---

### 6.6 æ‰©å±•ï¼šä¸‰ä¸ªçº¿ç¨‹äº¤æ›¿æ‰“å°ABC

**éœ€æ±‚**ï¼š
- çº¿ç¨‹1æ‰“å°A
- çº¿ç¨‹2æ‰“å°B
- çº¿ç¨‹3æ‰“å°C
- å¾ªç¯æ‰“å°10æ¬¡ï¼šABCABCABC...

**å®ç°æ€è·¯**ï¼š

```java
public class PrintABC {
    private final Object lock = new Object();
    private int state = 0; // 0:A, 1:B, 2:C
    
    public void printA() {
        synchronized (lock) {
            while (state != 0) {
                try {
                    lock.wait();
                } catch (InterruptedException e) {
                    Thread.currentThread().interrupt();
                    return;
                }
            }
            System.out.print("A");
            state = 1;
            lock.notifyAll();
        }
    }
    
    public void printB() {
        synchronized (lock) {
            while (state != 1) {
                try {
                    lock.wait();
                } catch (InterruptedException e) {
                    Thread.currentThread().interrupt();
                    return;
                }
            }
            System.out.print("B");
            state = 2;
            lock.notifyAll();
        }
    }
    
    public void printC() {
        synchronized (lock) {
            while (state != 2) {
                try {
                    lock.wait();
                } catch (InterruptedException e) {
                    Thread.currentThread().interrupt();
                    return;
                }
            }
            System.out.print("C");
            state = 0;
            lock.notifyAll();
        }
    }
}
```

**å…³é”®ç‚¹**ï¼š
- ä½¿ç”¨çŠ¶æ€å˜é‡æ§åˆ¶è½®æ¬¡
- å¿…é¡»ä½¿ç”¨`notifyAll()`ï¼ˆå› ä¸ºæœ‰3ä¸ªçº¿ç¨‹ï¼‰
- æ¯ä¸ªçº¿ç¨‹åªåœ¨ç‰¹å®šçŠ¶æ€ä¸‹æ‰§è¡Œ

---

## 8. æ ¸å¿ƒé—®é¢˜æ€»ç»“

### Q1: sleep()ä¼šé‡Šæ”¾é”å—ï¼Ÿ
**A**: ä¸ä¼šï¼Œsleep()åªæ˜¯æš‚åœæ‰§è¡Œï¼Œä¸é‡Šæ”¾ä»»ä½•èµ„æºã€‚

### Q2: join()çš„åº•å±‚å®ç°æ˜¯ä»€ä¹ˆï¼Ÿ
**A**: ä½¿ç”¨wait()å®ç°ï¼ŒJVMåœ¨çº¿ç¨‹ç»“æŸæ—¶è‡ªåŠ¨è°ƒç”¨notifyAll()ã€‚

### Q3: yield()å¯é å—ï¼Ÿ
**A**: ä¸å¯é ï¼Œåªæ˜¯å»ºè®®ï¼Œè°ƒåº¦å™¨å¯ä»¥å¿½ç•¥ï¼Œä¸è¦ä¾èµ–å®ƒå®ç°ä¸šåŠ¡é€»è¾‘ã€‚

### Q4: wait()ä¸ºä»€ä¹ˆå¿…é¡»åœ¨synchronizedå—ä¸­ï¼Ÿ
**A**: é˜²æ­¢ç«æ€æ¡ä»¶ï¼Œä¿è¯åŸå­æ€§æ£€æŸ¥æ¡ä»¶å’Œè¿›å…¥ç­‰å¾…ã€‚

### Q5: wait()ä¸ºä»€ä¹ˆå¿…é¡»åœ¨å¾ªç¯ä¸­è°ƒç”¨ï¼Ÿ
**A**: é˜²æ­¢è™šå‡å”¤é†’ï¼Œè¢«å”¤é†’åé‡æ–°æ£€æŸ¥æ¡ä»¶ã€‚

### Q6: notify() vs notifyAll()ï¼Œç”¨å“ªä¸ªï¼Ÿ
**A**: ä¼˜å…ˆä½¿ç”¨notifyAll()ï¼Œé™¤éç¡®å®šåªæœ‰ä¸€ç§ç­‰å¾…çº¿ç¨‹ã€‚

### Q7: sleep() vs wait()ï¼Œæ ¸å¿ƒåŒºåˆ«æ˜¯ä»€ä¹ˆï¼Ÿ
**A**: sleep()ä¸é‡Šæ”¾é”ï¼Œwait()é‡Šæ”¾é”ï¼›sleep()æ˜¯æš‚åœï¼Œwait()æ˜¯é€šä¿¡ã€‚

### Q8: ä»€ä¹ˆæ˜¯Lost Wakeupï¼Ÿå¦‚ä½•é¿å…ï¼Ÿ
**A**: notify()åœ¨wait()ä¹‹å‰æ‰§è¡Œå¯¼è‡´å”¤é†’ä¿¡å·ä¸¢å¤±ã€‚é¿å…æ–¹æ³•ï¼šæ£€æŸ¥æ¡ä»¶å’Œwait()å¿…é¡»åœ¨åŒä¸€ä¸ªsynchronizedå—ä¸­ï¼Œä½¿ç”¨æ¡ä»¶å˜é‡ä¿å­˜çŠ¶æ€ã€‚

### Q9: Lost Wakeup vs è™šå‡å”¤é†’æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ
**A**: Lost Wakeupæ˜¯notify()å…ˆäºwait()æ‰§è¡Œï¼Œè™šå‡å”¤é†’æ˜¯wait()è¢«æ„å¤–å”¤é†’ã€‚ä¸¤è€…éƒ½éœ€è¦ç”¨whileå¾ªç¯æ£€æŸ¥æ¡ä»¶ã€‚

### Q10: å¦‚ä½•å®ç°ä¸¤ä¸ªçº¿ç¨‹äº¤æ›¿æ‰“å°ï¼Ÿ
**A**: ä½¿ç”¨wait/notify + æ ‡å¿—ä½ï¼Œæ³¨æ„ç”¨whileæ£€æŸ¥æ¡ä»¶ï¼Œé˜²æ­¢è™šå‡å”¤é†’å’ŒLost Wakeupã€‚

---

## ä¸‹ä¸€ç« é¢„å‘Š

ä¸‹ä¸€ç« æˆ‘ä»¬å°†å­¦ä¹ ï¼š

- **çº¿ç¨‹ä¸­æ–­æœºåˆ¶**ï¼šinterrupt()çš„åŸç†å’Œä½¿ç”¨
- **çº¿ç¨‹çŠ¶æ€çš„ç²¾ç¡®æ§åˆ¶**
- **ä¸çº¿ç¨‹æ± çš„å¯¹æ¯”åˆ†æ**
- **å®é™…é¡¹ç›®ä¸­çš„æœ€ä½³å®è·µ**

è®©æˆ‘ä»¬ç»§ç»­æ·±å…¥ï¼ğŸš€
