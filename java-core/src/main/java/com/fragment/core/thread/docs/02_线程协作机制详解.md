# ç¬¬äºŒç« ï¼šçº¿ç¨‹åä½œæœºåˆ¶è¯¦è§£

## å¼•è¨€

ç†è§£äº†çº¿ç¨‹çš„ç”Ÿå‘½å‘¨æœŸåï¼Œæœ¬ç« å°†æ·±å…¥æ¢è®¨çº¿ç¨‹é—´å¦‚ä½•åä½œã€‚æˆ‘ä»¬å°†è¯¦ç»†åˆ†æ`sleep`ã€`join`ã€`yield`ã€`wait/notify`ç­‰æ ¸å¿ƒæ–¹æ³•çš„åŸç†å’Œä½¿ç”¨åœºæ™¯ã€‚

---

## 1. Thread.sleep() - çº¿ç¨‹ä¼‘çœ 

### 1.1 é—®é¢˜1ï¼šsleep()çš„ä½œç”¨æ˜¯ä»€ä¹ˆï¼Ÿ

**å®šä¹‰**ï¼š

```java
public static native void sleep(long millis) throws InterruptedException;
public static void sleep(long millis, int nanos) throws InterruptedException;
```

**æ ¸å¿ƒä½œç”¨**ï¼š
- è®©å½“å‰çº¿ç¨‹æš‚åœæ‰§è¡ŒæŒ‡å®šæ—¶é—´
- è¿›å…¥TIMED_WAITINGçŠ¶æ€
- **ä¸é‡Šæ”¾é”**ï¼ˆé‡è¦ï¼ï¼‰

---

### 1.2 é—®é¢˜2ï¼šsleep()çš„å·¥ä½œåŸç†æ˜¯ä»€ä¹ˆï¼Ÿ

**çŠ¶æ€è½¬æ¢å›¾**ï¼š

```
RUNNABLE (è¿è¡Œä¸­)
    â†“ Thread.sleep(1000)
TIMED_WAITING (è¶…æ—¶ç­‰å¾…)
    â†“ 1ç§’åè‡ªåŠ¨å”¤é†’
RUNNABLE (å°±ç»ª)
    â†“ è·å¾—CPU
RUNNABLE (è¿è¡Œä¸­)
```

**åº•å±‚å®ç°**ï¼š

```java
// Thread.sleep() æ˜¯nativeæ–¹æ³•
public static native void sleep(long millis) throws InterruptedException;

// å®é™…æµç¨‹ï¼š
// 1. JVMè°ƒç”¨æ“ä½œç³»ç»Ÿçš„sleepå‡½æ•°
// 2. çº¿ç¨‹è¢«ç§»å‡ºCPUè°ƒåº¦é˜Ÿåˆ—
// 3. è®¾ç½®å®šæ—¶å™¨
// 4. å®šæ—¶å™¨åˆ°æœŸåï¼Œçº¿ç¨‹é‡æ–°è¿›å…¥å°±ç»ªé˜Ÿåˆ—
// 5. ç­‰å¾…CPUè°ƒåº¦
```

---

### 1.3 é—®é¢˜3ï¼šsleep()ä¸é‡Šæ”¾é”æ˜¯ä»€ä¹ˆæ„æ€ï¼Ÿ

**ç¤ºä¾‹ä»£ç **ï¼š

```java
public class SleepWithLock {
    private static final Object lock = new Object();
    
    public static void main(String[] args) {
        Thread t1 = new Thread(() -> {
            synchronized (lock) {
                System.out.println("t1è·å¾—é”");
                try {
                    System.out.println("t1å¼€å§‹sleepï¼Œä½†ä¸é‡Šæ”¾é”");
                    Thread.sleep(3000); // æŒæœ‰é”çš„åŒæ—¶sleep
                    System.out.println("t1 sleepç»“æŸ");
                } catch (InterruptedException e) {
                    e.printStackTrace();
                }
                System.out.println("t1é‡Šæ”¾é”");
            }
        });
        
        Thread t2 = new Thread(() -> {
            synchronized (lock) {
                System.out.println("t2è·å¾—é”");
            }
        });
        
        t1.start();
        try {
            Thread.sleep(100); // ç¡®ä¿t1å…ˆè·å¾—é”
        } catch (InterruptedException e) {
            e.printStackTrace();
        }
        t2.start();
    }
}
```

**æ‰§è¡Œç»“æœ**ï¼š

```
t1è·å¾—é”
t1å¼€å§‹sleepï¼Œä½†ä¸é‡Šæ”¾é”
t1 sleepç»“æŸ
t1é‡Šæ”¾é”
t2è·å¾—é”  â† å¿…é¡»ç­‰å¾…t1é‡Šæ”¾é”
```

**æ—¶é—´çº¿å›¾**ï¼š

```
æ—¶é—´è½´: 0s----1s----2s----3s----4s
t1:     [è·å¾—é”][sleep 3ç§’ï¼ŒæŒæœ‰é”][é‡Šæ”¾é”]
t2:     [ç­‰å¾…é”........................][è·å¾—é”]
```

**å…³é”®ç†è§£**ï¼š
- sleep()åªæ˜¯è®©çº¿ç¨‹æš‚åœï¼Œä¸ä¼šé‡Šæ”¾ä»»ä½•èµ„æº
- å¦‚æœæŒæœ‰é”ï¼Œå…¶ä»–çº¿ç¨‹æ— æ³•è·å¾—é”
- å¯èƒ½å¯¼è‡´æ€§èƒ½é—®é¢˜

---

### 1.4 é—®é¢˜4ï¼šsleep()çš„å…¸å‹ä½¿ç”¨åœºæ™¯æ˜¯ä»€ä¹ˆï¼Ÿ

#### åœºæ™¯1ï¼šæ¨¡æ‹Ÿè€—æ—¶æ“ä½œ

```java
public class SimulateTask {
    public static void main(String[] args) {
        System.out.println("å¼€å§‹å¤„ç†ä»»åŠ¡");
        try {
            Thread.sleep(2000); // æ¨¡æ‹Ÿè€—æ—¶2ç§’
        } catch (InterruptedException e) {
            e.printStackTrace();
        }
        System.out.println("ä»»åŠ¡å¤„ç†å®Œæˆ");
    }
}
```

#### åœºæ™¯2ï¼šå®šæ—¶ä»»åŠ¡

```java
public class ScheduledTask {
    public static void main(String[] args) {
        while (true) {
            System.out.println("æ‰§è¡Œå®šæ—¶ä»»åŠ¡: " + System.currentTimeMillis());
            try {
                Thread.sleep(5000); // æ¯5ç§’æ‰§è¡Œä¸€æ¬¡
            } catch (InterruptedException e) {
                break; // è¢«ä¸­æ–­æ—¶é€€å‡º
            }
        }
    }
}
```

#### åœºæ™¯3ï¼šé™ä½CPUå ç”¨

```java
public class ReduceCpuUsage {
    private static volatile boolean running = true;
    
    public static void main(String[] args) {
        // âŒ é”™è¯¯ï¼šCPUå ç”¨100%
        while (running) {
            // ç©ºå¾ªç¯ï¼Œç–¯ç‹‚å ç”¨CPU
        }
        
        // âœ… æ­£ç¡®ï¼šé™ä½CPUå ç”¨
        while (running) {
            try {
                Thread.sleep(100); // ä¼‘çœ 100ms
            } catch (InterruptedException e) {
                break;
            }
            // æ‰§è¡Œæ£€æŸ¥é€»è¾‘
        }
    }
}
```

---

### 1.5 é—®é¢˜5ï¼šsleep()æœ‰å“ªäº›å¸¸è§é™·é˜±ï¼Ÿ

#### é™·é˜±1ï¼šåœ¨å¾ªç¯ä¸­ä½¿ç”¨sleepå¯èƒ½å¯¼è‡´æ—¶é—´æ¼‚ç§»

```java
// âŒ é”™è¯¯ï¼šæ—¶é—´ä¼šç´¯ç§¯æ¼‚ç§»
public class TimeDrift {
    public static void main(String[] args) {
        long startTime = System.currentTimeMillis();
        
        for (int i = 0; i < 10; i++) {
            try {
                Thread.sleep(1000); // æœŸæœ›æ¯ç§’æ‰§è¡Œä¸€æ¬¡
            } catch (InterruptedException e) {
                e.printStackTrace();
            }
            System.out.println("æ‰§è¡Œç¬¬ " + i + " æ¬¡");
        }
        
        long endTime = System.currentTimeMillis();
        System.out.println("æ€»è€—æ—¶: " + (endTime - startTime) / 1000 + "ç§’");
        // å®é™…å¯èƒ½è¶…è¿‡10ç§’ï¼ˆå› ä¸ºä»£ç æ‰§è¡Œä¹Ÿéœ€è¦æ—¶é—´ï¼‰
    }
}

// âœ… æ­£ç¡®ï¼šä½¿ç”¨ScheduledExecutorService
public class FixedRate {
    public static void main(String[] args) {
        ScheduledExecutorService executor = Executors.newScheduledThreadPool(1);
        executor.scheduleAtFixedRate(() -> {
            System.out.println("æ‰§è¡Œä»»åŠ¡");
        }, 0, 1, TimeUnit.SECONDS); // å›ºå®šé¢‘ç‡1ç§’
    }
}
```

#### é™·é˜±2ï¼šsleep()ä¸èƒ½ç²¾ç¡®æ§åˆ¶æ—¶é—´

```java
public class SleepAccuracy {
    public static void main(String[] args) {
        long startTime = System.nanoTime();
        try {
            Thread.sleep(1); // æœŸæœ›sleep 1æ¯«ç§’
        } catch (InterruptedException e) {
            e.printStackTrace();
        }
        long endTime = System.nanoTime();
        
        System.out.println("å®é™…è€—æ—¶: " + (endTime - startTime) / 1_000_000.0 + "æ¯«ç§’");
        // å®é™…å¯èƒ½æ˜¯ 1.5msã€2msï¼Œç”šè‡³æ›´å¤šï¼ˆå–å†³äºOSè°ƒåº¦ï¼‰
    }
}
```

**åŸå› **ï¼š
- æ“ä½œç³»ç»Ÿçš„æ—¶é—´ç‰‡é€šå¸¸æ˜¯10-15ms
- sleep()ä¾èµ–OSè°ƒåº¦ï¼Œæ— æ³•ä¿è¯ç²¾ç¡®æ—¶é—´

---

## 2. Thread.join() - ç­‰å¾…çº¿ç¨‹ç»“æŸ

### 2.1 é—®é¢˜6ï¼šjoin()çš„ä½œç”¨æ˜¯ä»€ä¹ˆï¼Ÿ

**å®šä¹‰**ï¼š

```java
public final void join() throws InterruptedException;
public final synchronized void join(long millis) throws InterruptedException;
public final synchronized void join(long millis, int nanos) throws InterruptedException;
```

**æ ¸å¿ƒä½œç”¨**ï¼š
- ç­‰å¾…ç›®æ ‡çº¿ç¨‹æ‰§è¡Œå®Œæ¯•
- å½“å‰çº¿ç¨‹è¿›å…¥WAITINGæˆ–TIMED_WAITINGçŠ¶æ€
- ç›®æ ‡çº¿ç¨‹ç»“æŸåï¼Œå½“å‰çº¿ç¨‹ç»§ç»­æ‰§è¡Œ

---

### 2.2 é—®é¢˜7ï¼šjoin()çš„å·¥ä½œåŸç†æ˜¯ä»€ä¹ˆï¼Ÿ

**ç¤ºä¾‹ä»£ç **ï¼š

```java
public class JoinExample {
    public static void main(String[] args) throws InterruptedException {
        Thread t1 = new Thread(() -> {
            System.out.println("t1å¼€å§‹æ‰§è¡Œ");
            try {
                Thread.sleep(2000);
            } catch (InterruptedException e) {
                e.printStackTrace();
            }
            System.out.println("t1æ‰§è¡Œå®Œæˆ");
        });
        
        System.out.println("mainçº¿ç¨‹å¯åŠ¨t1");
        t1.start();
        
        System.out.println("mainçº¿ç¨‹ç­‰å¾…t1ç»“æŸ");
        t1.join(); // mainçº¿ç¨‹åœ¨è¿™é‡Œç­‰å¾…
        
        System.out.println("mainçº¿ç¨‹ç»§ç»­æ‰§è¡Œ");
    }
}
```

**æ‰§è¡Œç»“æœ**ï¼š

```
mainçº¿ç¨‹å¯åŠ¨t1
mainçº¿ç¨‹ç­‰å¾…t1ç»“æŸ
t1å¼€å§‹æ‰§è¡Œ
t1æ‰§è¡Œå®Œæˆ
mainçº¿ç¨‹ç»§ç»­æ‰§è¡Œ
```

**çŠ¶æ€è½¬æ¢å›¾**ï¼š

```
mainçº¿ç¨‹:
RUNNABLE (è¿è¡Œä¸­)
    â†“ t1.join()
WAITING (ç­‰å¾…t1ç»“æŸ)
    â†“ t1æ‰§è¡Œå®Œæ¯•
RUNNABLE (å°±ç»ª)
    â†“ è·å¾—CPU
RUNNABLE (è¿è¡Œä¸­)
```

---

### 2.3 é—®é¢˜8ï¼šjoin()çš„åº•å±‚å®ç°æ˜¯ä»€ä¹ˆï¼Ÿ

**æºç åˆ†æ**ï¼š

```java
public final synchronized void join(long millis) throws InterruptedException {
    long base = System.currentTimeMillis();
    long now = 0;
    
    if (millis < 0) {
        throw new IllegalArgumentException("timeout value is negative");
    }
    
    if (millis == 0) {
        // æ— é™ç­‰å¾…
        while (isAlive()) {
            wait(0); // è°ƒç”¨Object.wait()
        }
    } else {
        // è¶…æ—¶ç­‰å¾…
        while (isAlive()) {
            long delay = millis - now;
            if (delay <= 0) {
                break;
            }
            wait(delay);
            now = System.currentTimeMillis() - base;
        }
    }
}
```

**å…³é”®å‘ç°**ï¼š

1. **join()æ˜¯synchronizedæ–¹æ³•**ï¼šé”ä½çš„æ˜¯ç›®æ ‡çº¿ç¨‹å¯¹è±¡
2. **åº•å±‚ä½¿ç”¨wait()**ï¼šè°ƒç”¨Object.wait()è¿›å…¥ç­‰å¾…
3. **å¾ªç¯æ£€æŸ¥isAlive()**ï¼šé˜²æ­¢è™šå‡å”¤é†’
4. **è°æ¥å”¤é†’ï¼Ÿ**ï¼šJVMåœ¨çº¿ç¨‹ç»“æŸæ—¶è‡ªåŠ¨è°ƒç”¨notifyAll()

**æµç¨‹å›¾**ï¼š

```
mainçº¿ç¨‹è°ƒç”¨t1.join()
    â†“
è·å–t1å¯¹è±¡çš„é”
    â†“
æ£€æŸ¥t1.isAlive()
    â†“ true
è°ƒç”¨t1.wait()ï¼ˆmainçº¿ç¨‹ç­‰å¾…ï¼‰
    â†“
t1çº¿ç¨‹æ‰§è¡Œå®Œæ¯•
    â†“
JVMè‡ªåŠ¨è°ƒç”¨t1.notifyAll()
    â†“
mainçº¿ç¨‹è¢«å”¤é†’
    â†“
å†æ¬¡æ£€æŸ¥t1.isAlive()
    â†“ false
join()è¿”å›ï¼Œmainçº¿ç¨‹ç»§ç»­æ‰§è¡Œ
```

---

### 2.4 é—®é¢˜9ï¼šjoin()çš„å…¸å‹ä½¿ç”¨åœºæ™¯æ˜¯ä»€ä¹ˆï¼Ÿ

#### åœºæ™¯1ï¼šç­‰å¾…æ‰€æœ‰å­ä»»åŠ¡å®Œæˆ

```java
public class WaitAllTasks {
    public static void main(String[] args) throws InterruptedException {
        List<Thread> threads = new ArrayList<>();
        
        // åˆ›å»º10ä¸ªä»»åŠ¡çº¿ç¨‹
        for (int i = 0; i < 10; i++) {
            final int taskId = i;
            Thread t = new Thread(() -> {
                System.out.println("ä»»åŠ¡ " + taskId + " å¼€å§‹æ‰§è¡Œ");
                try {
                    Thread.sleep(1000);
                } catch (InterruptedException e) {
                    e.printStackTrace();
                }
                System.out.println("ä»»åŠ¡ " + taskId + " æ‰§è¡Œå®Œæˆ");
            });
            threads.add(t);
            t.start();
        }
        
        // ç­‰å¾…æ‰€æœ‰ä»»åŠ¡å®Œæˆ
        for (Thread t : threads) {
            t.join();
        }
        
        System.out.println("æ‰€æœ‰ä»»åŠ¡å®Œæˆï¼Œå¼€å§‹æ±‡æ€»ç»“æœ");
    }
}
```

#### åœºæ™¯2ï¼šæ§åˆ¶æ‰§è¡Œé¡ºåº

```java
public class ControlOrder {
    public static void main(String[] args) throws InterruptedException {
        Thread t1 = new Thread(() -> {
            System.out.println("æ­¥éª¤1ï¼šåˆå§‹åŒ–æ•°æ®");
        });
        
        Thread t2 = new Thread(() -> {
            System.out.println("æ­¥éª¤2ï¼šå¤„ç†æ•°æ®");
        });
        
        Thread t3 = new Thread(() -> {
            System.out.println("æ­¥éª¤3ï¼šä¿å­˜ç»“æœ");
        });
        
        // æŒ‰é¡ºåºæ‰§è¡Œ
        t1.start();
        t1.join(); // ç­‰å¾…t1å®Œæˆ
        
        t2.start();
        t2.join(); // ç­‰å¾…t2å®Œæˆ
        
        t3.start();
        t3.join(); // ç­‰å¾…t3å®Œæˆ
        
        System.out.println("æµç¨‹å®Œæˆ");
    }
}
```

#### åœºæ™¯3ï¼šè¶…æ—¶æ§åˆ¶

```java
public class JoinTimeout {
    public static void main(String[] args) throws InterruptedException {
        Thread t1 = new Thread(() -> {
            try {
                Thread.sleep(5000); // æ¨¡æ‹Ÿé•¿æ—¶é—´ä»»åŠ¡
            } catch (InterruptedException e) {
                e.printStackTrace();
            }
        });
        
        t1.start();
        
        // æœ€å¤šç­‰å¾…2ç§’
        t1.join(2000);
        
        if (t1.isAlive()) {
            System.out.println("ä»»åŠ¡è¶…æ—¶ï¼Œå¼ºåˆ¶ä¸­æ–­");
            t1.interrupt();
        } else {
            System.out.println("ä»»åŠ¡æ­£å¸¸å®Œæˆ");
        }
    }
}
```

---

## 3. Thread.yield() - çº¿ç¨‹è®©æ­¥

### 3.1 é—®é¢˜10ï¼šyield()çš„ä½œç”¨æ˜¯ä»€ä¹ˆï¼Ÿ

**å®šä¹‰**ï¼š

```java
public static native void yield();
```

**æ ¸å¿ƒä½œç”¨**ï¼š
- æç¤ºè°ƒåº¦å™¨ï¼šå½“å‰çº¿ç¨‹æ„¿æ„æ”¾å¼ƒCPU
- çº¿ç¨‹ä»Running â†’ Readyï¼ˆä»ç„¶æ˜¯RUNNABLEçŠ¶æ€ï¼‰
- **ä»…ä»…æ˜¯æç¤ºï¼Œä¸ä¿è¯ä¸€å®šè®©æ­¥**

---

### 3.2 é—®é¢˜11ï¼šyield()çš„å·¥ä½œåŸç†æ˜¯ä»€ä¹ˆï¼Ÿ

**çŠ¶æ€è½¬æ¢**ï¼š

```
RUNNABLE (è¿è¡Œä¸­)
    â†“ Thread.yield()
RUNNABLE (å°±ç»ª)
    â†“ å¯èƒ½ç«‹å³è¢«å†æ¬¡è°ƒåº¦
RUNNABLE (è¿è¡Œä¸­)
```

**å…³é”®ç‰¹ç‚¹**ï¼š

1. **ä¸é‡Šæ”¾é”**ï¼šå’Œsleep()ä¸€æ ·
2. **ä¸ä¿è¯è®©æ­¥**ï¼šåªæ˜¯å»ºè®®ï¼Œè°ƒåº¦å™¨å¯ä»¥å¿½ç•¥
3. **ä¸è¿›å…¥ç­‰å¾…çŠ¶æ€**ï¼šä»ç„¶æ˜¯RUNNABLE
4. **å¯èƒ½ç«‹å³è¢«å†æ¬¡è°ƒåº¦**ï¼šå¦‚æœæ²¡æœ‰å…¶ä»–åŒä¼˜å…ˆçº§çº¿ç¨‹

**ç¤ºä¾‹ä»£ç **ï¼š

```java
public class YieldExample {
    public static void main(String[] args) {
        Thread t1 = new Thread(() -> {
            for (int i = 0; i < 5; i++) {
                System.out.println("t1: " + i);
                Thread.yield(); // è®©æ­¥
            }
        });
        
        Thread t2 = new Thread(() -> {
            for (int i = 0; i < 5; i++) {
                System.out.println("t2: " + i);
                Thread.yield(); // è®©æ­¥
            }
        });
        
        t1.start();
        t2.start();
    }
}
```

**å¯èƒ½çš„è¾“å‡º**ï¼ˆä¸ç¡®å®šï¼‰ï¼š

```
t1: 0
t2: 0
t1: 1
t2: 1
t1: 2
t2: 2
...
```

---

### 3.3 é—®é¢˜12ï¼šyield()çš„ä½¿ç”¨åœºæ™¯å’Œé™·é˜±æ˜¯ä»€ä¹ˆï¼Ÿ

#### ä½¿ç”¨åœºæ™¯ï¼š

1. **è°ƒè¯•å’Œæµ‹è¯•**ï¼šå¢åŠ çº¿ç¨‹åˆ‡æ¢çš„æ¦‚ç‡ï¼Œæš´éœ²å¹¶å‘é—®é¢˜
2. **é˜²æ­¢çº¿ç¨‹é¥¥é¥¿**ï¼šè®©ä½ä¼˜å…ˆçº§çº¿ç¨‹æœ‰æœºä¼šæ‰§è¡Œ
3. **é™ä½CPUå ç”¨**ï¼šåœ¨å¾ªç¯ä¸­é€‚å½“è®©æ­¥

#### é™·é˜±ï¼š

```java
// âŒ é”™è¯¯ï¼šyield()ä¸èƒ½æ›¿ä»£sleep()
while (running) {
    Thread.yield(); // å¯èƒ½æ²¡æœ‰æ•ˆæœï¼ŒCPUä»ç„¶100%
}

// âœ… æ­£ç¡®ï¼šä½¿ç”¨sleep()
while (running) {
    try {
        Thread.sleep(100);
    } catch (InterruptedException e) {
        break;
    }
}
```

**ä¸ºä»€ä¹ˆyield()ä¸å¯é ï¼Ÿ**

- ä¾èµ–æ“ä½œç³»ç»Ÿå®ç°
- ä¸åŒå¹³å°è¡Œä¸ºä¸åŒ
- æ— æ³•ä¿è¯è®©æ­¥æ•ˆæœ

**å»ºè®®**ï¼š
- âš ï¸ ä¸è¦ä¾èµ–yield()å®ç°ä¸šåŠ¡é€»è¾‘
- âœ… ä»…ç”¨äºæµ‹è¯•å’Œè°ƒè¯•
- âœ… ç”Ÿäº§ç¯å¢ƒä½¿ç”¨sleep()æˆ–wait()

---

## 4. wait/notify/notifyAll - çº¿ç¨‹é€šä¿¡

### 4.1 é—®é¢˜13ï¼šä¸ºä»€ä¹ˆéœ€è¦wait/notifyï¼Ÿ

**åœºæ™¯ï¼šç”Ÿäº§è€…-æ¶ˆè´¹è€…é—®é¢˜**

```java
// âŒ é”™è¯¯æ–¹å¼ï¼šå¿™ç­‰å¾…
public class BusyWaiting {
    private static final List<Integer> buffer = new ArrayList<>();
    private static final int MAX_SIZE = 10;
    
    // æ¶ˆè´¹è€…
    public static void consumer() {
        while (true) {
            synchronized (buffer) {
                while (buffer.isEmpty()) {
                    // å¿™ç­‰å¾…ï¼Œæµªè´¹CPU
                }
                Integer item = buffer.remove(0);
                System.out.println("æ¶ˆè´¹: " + item);
            }
        }
    }
}
```

**é—®é¢˜**ï¼š
- æ¶ˆè´¹è€…åœ¨ç©ºç¼“å†²åŒºæ—¶ç–¯ç‹‚å¾ªç¯ï¼Œæµªè´¹CPU
- æŒæœ‰é”çš„åŒæ—¶å¾ªç¯ï¼Œç”Ÿäº§è€…æ— æ³•æ·»åŠ æ•°æ®
- æ­»é”ï¼

**è§£å†³æ–¹æ¡ˆï¼šwait/notify**

---

### 4.2 é—®é¢˜14ï¼šwait/notifyçš„å·¥ä½œåŸç†æ˜¯ä»€ä¹ˆï¼Ÿ

**å®šä¹‰**ï¼š

```java
// Objectç±»çš„æ–¹æ³•ï¼ˆä¸æ˜¯Threadç±»ï¼ï¼‰
public final void wait() throws InterruptedException;
public final native void wait(long timeout) throws InterruptedException;
public final void wait(long timeout, int nanos) throws InterruptedException;

public final native void notify();
public final native void notifyAll();
```

**æ ¸å¿ƒç‰¹ç‚¹**ï¼š

1. **å¿…é¡»åœ¨synchronizedå—ä¸­è°ƒç”¨**
2. **wait()ä¼šé‡Šæ”¾é”**ï¼ˆä¸sleep()ä¸åŒï¼ï¼‰
3. **notify()å”¤é†’ä¸€ä¸ªç­‰å¾…çº¿ç¨‹**
4. **notifyAll()å”¤é†’æ‰€æœ‰ç­‰å¾…çº¿ç¨‹**

---

### 4.3 é—®é¢˜15ï¼šwait()çš„å®Œæ•´æµç¨‹æ˜¯ä»€ä¹ˆï¼Ÿ

**æµç¨‹å›¾**ï¼š

```
çº¿ç¨‹æŒæœ‰é”
    â†“
è°ƒç”¨obj.wait()
    â†“
é‡Šæ”¾é”
    â†“
è¿›å…¥objçš„ç­‰å¾…é˜Ÿåˆ—
    â†“
çº¿ç¨‹çŠ¶æ€: WAITING
    â†“
å…¶ä»–çº¿ç¨‹è°ƒç”¨obj.notify()
    â†“
ä»ç­‰å¾…é˜Ÿåˆ—ç§»åˆ°åŒæ­¥é˜Ÿåˆ—
    â†“
ç«äº‰é”
    â†“
è·å¾—é”
    â†“
wait()è¿”å›
    â†“
ç»§ç»­æ‰§è¡Œ
```

**ç¤ºä¾‹ä»£ç **ï¼š

```java
public class WaitNotifyExample {
    private static final Object lock = new Object();
    private static boolean condition = false;
    
    public static void main(String[] args) throws InterruptedException {
        // ç­‰å¾…çº¿ç¨‹
        Thread waiter = new Thread(() -> {
            synchronized (lock) {
                System.out.println("ç­‰å¾…çº¿ç¨‹ï¼šæ£€æŸ¥æ¡ä»¶");
                while (!condition) {
                    try {
                        System.out.println("ç­‰å¾…çº¿ç¨‹ï¼šæ¡ä»¶ä¸æ»¡è¶³ï¼Œå¼€å§‹ç­‰å¾…");
                        lock.wait(); // é‡Šæ”¾é”ï¼Œè¿›å…¥ç­‰å¾…
                        System.out.println("ç­‰å¾…çº¿ç¨‹ï¼šè¢«å”¤é†’ï¼Œé‡æ–°æ£€æŸ¥æ¡ä»¶");
                    } catch (InterruptedException e) {
                        e.printStackTrace();
                    }
                }
                System.out.println("ç­‰å¾…çº¿ç¨‹ï¼šæ¡ä»¶æ»¡è¶³ï¼Œç»§ç»­æ‰§è¡Œ");
            }
        });
        
        // é€šçŸ¥çº¿ç¨‹
        Thread notifier = new Thread(() -> {
            synchronized (lock) {
                System.out.println("é€šçŸ¥çº¿ç¨‹ï¼šä¿®æ”¹æ¡ä»¶");
                condition = true;
                System.out.println("é€šçŸ¥çº¿ç¨‹ï¼šå”¤é†’ç­‰å¾…çº¿ç¨‹");
                lock.notify();
            }
        });
        
        waiter.start();
        Thread.sleep(1000); // ç¡®ä¿waiterå…ˆæ‰§è¡Œ
        notifier.start();
    }
}
```

**æ‰§è¡Œç»“æœ**ï¼š

```
ç­‰å¾…çº¿ç¨‹ï¼šæ£€æŸ¥æ¡ä»¶
ç­‰å¾…çº¿ç¨‹ï¼šæ¡ä»¶ä¸æ»¡è¶³ï¼Œå¼€å§‹ç­‰å¾…
é€šçŸ¥çº¿ç¨‹ï¼šä¿®æ”¹æ¡ä»¶
é€šçŸ¥çº¿ç¨‹ï¼šå”¤é†’ç­‰å¾…çº¿ç¨‹
ç­‰å¾…çº¿ç¨‹ï¼šè¢«å”¤é†’ï¼Œé‡æ–°æ£€æŸ¥æ¡ä»¶
ç­‰å¾…çº¿ç¨‹ï¼šæ¡ä»¶æ»¡è¶³ï¼Œç»§ç»­æ‰§è¡Œ
```

---

### 4.4 é—®é¢˜16ï¼šä¸ºä»€ä¹ˆwait()å¿…é¡»åœ¨å¾ªç¯ä¸­è°ƒç”¨ï¼Ÿ

**é”™è¯¯ç¤ºä¾‹**ï¼š

```java
// âŒ é”™è¯¯ï¼šä½¿ç”¨ifåˆ¤æ–­
synchronized (lock) {
    if (!condition) {
        lock.wait(); // å¯èƒ½å‡ºç°è™šå‡å”¤é†’ï¼
    }
    // ç»§ç»­æ‰§è¡Œ
}
```

**æ­£ç¡®ç¤ºä¾‹**ï¼š

```java
// âœ… æ­£ç¡®ï¼šä½¿ç”¨whileå¾ªç¯
synchronized (lock) {
    while (!condition) {
        lock.wait(); // è¢«å”¤é†’åé‡æ–°æ£€æŸ¥æ¡ä»¶
    }
    // ç»§ç»­æ‰§è¡Œ
}
```

**åŸå› ï¼šè™šå‡å”¤é†’ï¼ˆSpurious Wakeupï¼‰**

1. **æ“ä½œç³»ç»Ÿå¯èƒ½æ— æ•…å”¤é†’çº¿ç¨‹**
2. **notify()å¯èƒ½å”¤é†’é”™è¯¯çš„çº¿ç¨‹**
3. **æ¡ä»¶å¯èƒ½è¢«å…¶ä»–çº¿ç¨‹æ”¹å˜**

**ç¤ºä¾‹ï¼šå¤šä¸ªæ¶ˆè´¹è€…**

```java
public class SpuriousWakeup {
    private static final List<Integer> buffer = new ArrayList<>();
    
    // æ¶ˆè´¹è€…1
    public static void consumer1() {
        synchronized (buffer) {
            if (buffer.isEmpty()) { // âŒ ä½¿ç”¨if
                buffer.wait();
            }
            Integer item = buffer.remove(0); // å¯èƒ½æŠ›å‡ºå¼‚å¸¸ï¼
        }
    }
    
    // æ¶ˆè´¹è€…2
    public static void consumer2() {
        synchronized (buffer) {
            if (buffer.isEmpty()) { // âŒ ä½¿ç”¨if
                buffer.wait();
            }
            Integer item = buffer.remove(0); // å¯èƒ½æŠ›å‡ºå¼‚å¸¸ï¼
        }
    }
    
    // ç”Ÿäº§è€…
    public static void producer() {
        synchronized (buffer) {
            buffer.add(1);
            buffer.notifyAll(); // å”¤é†’æ‰€æœ‰æ¶ˆè´¹è€…
        }
    }
}
```

**é—®é¢˜**ï¼š
- ç”Ÿäº§è€…æ·»åŠ 1ä¸ªå…ƒç´ ï¼Œå”¤é†’2ä¸ªæ¶ˆè´¹è€…
- æ¶ˆè´¹è€…1è·å¾—é”ï¼Œæ¶ˆè´¹å…ƒç´ 
- æ¶ˆè´¹è€…2è·å¾—é”ï¼Œç¼“å†²åŒºå·²ç©ºï¼ŒæŠ›å‡ºå¼‚å¸¸ï¼

**è§£å†³**ï¼šä½¿ç”¨whileå¾ªç¯

```java
synchronized (buffer) {
    while (buffer.isEmpty()) { // âœ… ä½¿ç”¨while
        buffer.wait();
    }
    Integer item = buffer.remove(0); // å®‰å…¨
}
```

---

### 4.5 é—®é¢˜17ï¼šnotify() vs notifyAll()ï¼Œåº”è¯¥ç”¨å“ªä¸ªï¼Ÿ

**åŒºåˆ«**ï¼š

| æ–¹æ³• | è¡Œä¸º | é€‚ç”¨åœºæ™¯ |
|------|------|---------|
| **notify()** | éšæœºå”¤é†’ä¸€ä¸ªç­‰å¾…çº¿ç¨‹ | æ‰€æœ‰ç­‰å¾…çº¿ç¨‹ç­‰å¾…ç›¸åŒæ¡ä»¶ |
| **notifyAll()** | å”¤é†’æ‰€æœ‰ç­‰å¾…çº¿ç¨‹ | ç­‰å¾…çº¿ç¨‹ç­‰å¾…ä¸åŒæ¡ä»¶ |

**ç¤ºä¾‹ï¼šç”Ÿäº§è€…-æ¶ˆè´¹è€…ï¼ˆå®Œæ•´ç‰ˆï¼‰**

```java
public class ProducerConsumer {
    private static final List<Integer> buffer = new ArrayList<>();
    private static final int MAX_SIZE = 10;
    private static final Object lock = new Object();
    
    // ç”Ÿäº§è€…
    static class Producer implements Runnable {
        @Override
        public void run() {
            int value = 0;
            while (true) {
                synchronized (lock) {
                    // ç¼“å†²åŒºæ»¡ï¼Œç­‰å¾…
                    while (buffer.size() == MAX_SIZE) {
                        try {
                            System.out.println("ç”Ÿäº§è€…ç­‰å¾…ï¼šç¼“å†²åŒºå·²æ»¡");
                            lock.wait();
                        } catch (InterruptedException e) {
                            e.printStackTrace();
                        }
                    }
                    
                    // ç”Ÿäº§
                    buffer.add(value);
                    System.out.println("ç”Ÿäº§: " + value);
                    value++;
                    
                    // å”¤é†’æ¶ˆè´¹è€…
                    lock.notifyAll(); // ä½¿ç”¨notifyAll()
                }
                
                try {
                    Thread.sleep(100);
                } catch (InterruptedException e) {
                    e.printStackTrace();
                }
            }
        }
    }
    
    // æ¶ˆè´¹è€…
    static class Consumer implements Runnable {
        @Override
        public void run() {
            while (true) {
                synchronized (lock) {
                    // ç¼“å†²åŒºç©ºï¼Œç­‰å¾…
                    while (buffer.isEmpty()) {
                        try {
                            System.out.println("æ¶ˆè´¹è€…ç­‰å¾…ï¼šç¼“å†²åŒºä¸ºç©º");
                            lock.wait();
                        } catch (InterruptedException e) {
                            e.printStackTrace();
                        }
                    }
                    
                    // æ¶ˆè´¹
                    Integer value = buffer.remove(0);
                    System.out.println("æ¶ˆè´¹: " + value);
                    
                    // å”¤é†’ç”Ÿäº§è€…
                    lock.notifyAll(); // ä½¿ç”¨notifyAll()
                }
                
                try {
                    Thread.sleep(200);
                } catch (InterruptedException e) {
                    e.printStackTrace();
                }
            }
        }
    }
    
    public static void main(String[] args) {
        new Thread(new Producer()).start();
        new Thread(new Consumer()).start();
    }
}
```

**ä¸ºä»€ä¹ˆä½¿ç”¨notifyAll()ï¼Ÿ**

- ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…ç­‰å¾…ä¸åŒæ¡ä»¶
- notify()å¯èƒ½å”¤é†’é”™è¯¯çš„çº¿ç¨‹ï¼ˆç”Ÿäº§è€…å”¤é†’ç”Ÿäº§è€…ï¼‰
- notifyAll()ä¿è¯æ­£ç¡®çš„çº¿ç¨‹è¢«å”¤é†’

**æ€§èƒ½è€ƒè™‘**ï¼š
- notifyAll()ä¼šå”¤é†’æ‰€æœ‰çº¿ç¨‹ï¼Œå¯èƒ½å¯¼è‡´"æƒŠç¾¤æ•ˆåº”"
- ä½†ä¿è¯æ­£ç¡®æ€§æ›´é‡è¦
- å¦‚æœç¡®å®šåªæœ‰ä¸€ç§ç­‰å¾…çº¿ç¨‹ï¼Œå¯ä»¥ä½¿ç”¨notify()

---

## 5. æ–¹æ³•å¯¹æ¯”æ€»ç»“

### 5.1 é—®é¢˜18ï¼šsleep vs waitï¼Œæœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ

| ç»´åº¦ | sleep() | wait() |
|------|---------|--------|
| **æ‰€å±ç±»** | Threadç±» | Objectç±» |
| **é‡Šæ”¾é”** | ä¸é‡Šæ”¾ | é‡Šæ”¾ |
| **ä½¿ç”¨ä½ç½®** | ä»»ä½•åœ°æ–¹ | å¿…é¡»åœ¨synchronizedå—ä¸­ |
| **å”¤é†’æ–¹å¼** | è¶…æ—¶è‡ªåŠ¨å”¤é†’ | notify/notifyAllå”¤é†’ |
| **ç”¨é€”** | æš‚åœæ‰§è¡Œ | çº¿ç¨‹é€šä¿¡ |

**è®°å¿†å£è¯€**ï¼š
- sleepæ˜¯ç¡è§‰ï¼ŒæŠ±ç€é”ç¡
- waitæ˜¯ç­‰å¾…ï¼Œæ”¾ä¸‹é”ç­‰

---

### 5.2 é—®é¢˜19ï¼šjoin vs waitï¼Œæœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ

| ç»´åº¦ | join() | wait() |
|------|--------|--------|
| **ç›®çš„** | ç­‰å¾…çº¿ç¨‹ç»“æŸ | ç­‰å¾…æ¡ä»¶æ»¡è¶³ |
| **åº•å±‚å®ç°** | ä½¿ç”¨wait() | nativeæ–¹æ³• |
| **å”¤é†’æ–¹å¼** | JVMè‡ªåŠ¨notifyAll() | æ‰‹åŠ¨notify/notifyAll() |
| **ä½¿ç”¨åœºæ™¯** | ç­‰å¾…å­ä»»åŠ¡å®Œæˆ | çº¿ç¨‹é—´é€šä¿¡ |

---

### 5.3 é—®é¢˜20ï¼šyield vs sleepï¼Œæœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ

| ç»´åº¦ | yield() | sleep() |
|------|---------|---------|
| **çŠ¶æ€** | RUNNABLE | TIMED_WAITING |
| **ä¿è¯æ€§** | ä¸ä¿è¯è®©æ­¥ | ä¿è¯æš‚åœ |
| **æ—¶é—´æ§åˆ¶** | æ—  | ç²¾ç¡®ï¼ˆç›¸å¯¹ï¼‰ |
| **å¯é æ€§** | ä¸å¯é  | å¯é  |

---

## 6. æ ¸å¿ƒé—®é¢˜æ€»ç»“

### Q1: sleep()ä¼šé‡Šæ”¾é”å—ï¼Ÿ
**A**: ä¸ä¼šï¼Œsleep()åªæ˜¯æš‚åœæ‰§è¡Œï¼Œä¸é‡Šæ”¾ä»»ä½•èµ„æºã€‚

### Q2: join()çš„åº•å±‚å®ç°æ˜¯ä»€ä¹ˆï¼Ÿ
**A**: ä½¿ç”¨wait()å®ç°ï¼ŒJVMåœ¨çº¿ç¨‹ç»“æŸæ—¶è‡ªåŠ¨è°ƒç”¨notifyAll()ã€‚

### Q3: yield()å¯é å—ï¼Ÿ
**A**: ä¸å¯é ï¼Œåªæ˜¯å»ºè®®ï¼Œè°ƒåº¦å™¨å¯ä»¥å¿½ç•¥ï¼Œä¸è¦ä¾èµ–å®ƒå®ç°ä¸šåŠ¡é€»è¾‘ã€‚

### Q4: wait()ä¸ºä»€ä¹ˆå¿…é¡»åœ¨synchronizedå—ä¸­ï¼Ÿ
**A**: é˜²æ­¢ç«æ€æ¡ä»¶ï¼Œä¿è¯åŸå­æ€§æ£€æŸ¥æ¡ä»¶å’Œè¿›å…¥ç­‰å¾…ã€‚

### Q5: wait()ä¸ºä»€ä¹ˆå¿…é¡»åœ¨å¾ªç¯ä¸­è°ƒç”¨ï¼Ÿ
**A**: é˜²æ­¢è™šå‡å”¤é†’ï¼Œè¢«å”¤é†’åé‡æ–°æ£€æŸ¥æ¡ä»¶ã€‚

### Q6: notify() vs notifyAll()ï¼Œç”¨å“ªä¸ªï¼Ÿ
**A**: ä¼˜å…ˆä½¿ç”¨notifyAll()ï¼Œé™¤éç¡®å®šåªæœ‰ä¸€ç§ç­‰å¾…çº¿ç¨‹ã€‚

### Q7: sleep() vs wait()ï¼Œæ ¸å¿ƒåŒºåˆ«æ˜¯ä»€ä¹ˆï¼Ÿ
**A**: sleep()ä¸é‡Šæ”¾é”ï¼Œwait()é‡Šæ”¾é”ï¼›sleep()æ˜¯æš‚åœï¼Œwait()æ˜¯é€šä¿¡ã€‚

---

## ä¸‹ä¸€ç« é¢„å‘Š

ä¸‹ä¸€ç« æˆ‘ä»¬å°†å­¦ä¹ ï¼š

- **çº¿ç¨‹ä¸­æ–­æœºåˆ¶**ï¼šinterrupt()çš„åŸç†å’Œä½¿ç”¨
- **çº¿ç¨‹çŠ¶æ€çš„ç²¾ç¡®æ§åˆ¶**
- **ä¸çº¿ç¨‹æ± çš„å¯¹æ¯”åˆ†æ**
- **å®é™…é¡¹ç›®ä¸­çš„æœ€ä½³å®è·µ**

è®©æˆ‘ä»¬ç»§ç»­æ·±å…¥ï¼ğŸš€
