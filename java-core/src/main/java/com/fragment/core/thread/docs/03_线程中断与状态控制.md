# ç¬¬ä¸‰ç« ï¼šçº¿ç¨‹ä¸­æ–­ä¸çŠ¶æ€æ§åˆ¶

## å¼•è¨€

åœ¨å®é™…å¼€å‘ä¸­ï¼Œæˆ‘ä»¬ç»å¸¸éœ€è¦åœæ­¢æ­£åœ¨è¿è¡Œçš„çº¿ç¨‹ã€‚æœ¬ç« å°†æ·±å…¥æ¢è®¨çº¿ç¨‹ä¸­æ–­æœºåˆ¶ã€å®ˆæŠ¤çº¿ç¨‹ã€çº¿ç¨‹ä¼˜å…ˆçº§ç­‰é«˜çº§ç‰¹æ€§ï¼Œä»¥åŠå¦‚ä½•ç²¾ç¡®æ§åˆ¶çº¿ç¨‹çš„ç”Ÿå‘½å‘¨æœŸã€‚

---

## 1. çº¿ç¨‹ä¸­æ–­æœºåˆ¶

### 1.1 é—®é¢˜1ï¼šä¸ºä»€ä¹ˆä¸èƒ½ç›´æ¥åœæ­¢çº¿ç¨‹ï¼Ÿ

**å†å²ï¼šThread.stop()æ–¹æ³•**

```java
// âŒ å·²åºŸå¼ƒçš„æ–¹æ³•
@Deprecated
public final void stop() {
    // å¼ºåˆ¶åœæ­¢çº¿ç¨‹
}
```

**ä¸ºä»€ä¹ˆåºŸå¼ƒï¼Ÿ**

```java
public class StopDanger {
    private int balance = 1000;
    
    public synchronized void transfer(int amount) {
        balance -= amount;
        // å¦‚æœåœ¨è¿™é‡Œè¢«stop()ï¼Œæ•°æ®ä¸ä¸€è‡´ï¼
        balance += amount;
    }
}
```

**é—®é¢˜åˆ†æ**ï¼š

1. **ç ´åæ•°æ®ä¸€è‡´æ€§**ï¼šçº¿ç¨‹å¯èƒ½åœ¨ä»»æ„ä½ç½®åœæ­¢
2. **ä¸é‡Šæ”¾é”**ï¼šå¯èƒ½å¯¼è‡´æ­»é”
3. **èµ„æºæ³„æ¼**ï¼šæ–‡ä»¶ã€è¿æ¥ç­‰èµ„æºæ— æ³•æ­£ç¡®å…³é—­
4. **æ— æ³•æ¸…ç†**ï¼šæ²¡æœ‰æœºä¼šæ‰§è¡Œfinallyå—

**æ—¶é—´çº¿å›¾**ï¼š

```
æ­£å¸¸æµç¨‹ï¼š
balance -= 100  [balance = 900]
    â†“
balance += 100  [balance = 1000]
    â†“
å®Œæˆ

è¢«stop()æ‰“æ–­ï¼š
balance -= 100  [balance = 900]
    â†“ stop()
çº¿ç¨‹ç»ˆæ­¢  [balance = 900ï¼Œæ•°æ®é”™è¯¯ï¼]
```

---

### 1.2 é—®é¢˜2ï¼šæ­£ç¡®çš„åœæ­¢çº¿ç¨‹æ–¹å¼æ˜¯ä»€ä¹ˆï¼Ÿ

**æ–¹æ¡ˆ1ï¼šä½¿ç”¨æ ‡å¿—ä½**

```java
public class FlagStop {
    private volatile boolean running = true;
    
    public void run() {
        while (running) {
            // æ‰§è¡Œä»»åŠ¡
            System.out.println("çº¿ç¨‹è¿è¡Œä¸­...");
            try {
                Thread.sleep(1000);
            } catch (InterruptedException e) {
                e.printStackTrace();
            }
        }
        System.out.println("çº¿ç¨‹åœæ­¢");
    }
    
    public void stop() {
        running = false;
    }
    
    public static void main(String[] args) throws InterruptedException {
        FlagStop task = new FlagStop();
        Thread t = new Thread(task::run);
        t.start();
        
        Thread.sleep(3000);
        task.stop(); // è¯·æ±‚åœæ­¢
    }
}
```

**ä¼˜ç‚¹**ï¼š
- âœ… çº¿ç¨‹å¯ä»¥å®Œæˆå½“å‰æ“ä½œ
- âœ… å¯ä»¥æ¸…ç†èµ„æº
- âœ… æ•°æ®ä¸€è‡´æ€§æœ‰ä¿è¯

**ç¼ºç‚¹**ï¼š
- âŒ å¦‚æœçº¿ç¨‹é˜»å¡ï¼ˆå¦‚IOæ“ä½œï¼‰ï¼Œæ— æ³•åŠæ—¶å“åº”
- âŒ éœ€è¦åœ¨ä»£ç ä¸­é¢‘ç¹æ£€æŸ¥æ ‡å¿—ä½

---

**æ–¹æ¡ˆ2ï¼šä½¿ç”¨ä¸­æ–­æœºåˆ¶ï¼ˆæ¨èï¼‰**

```java
public class InterruptStop {
    public static void main(String[] args) throws InterruptedException {
        Thread t = new Thread(() -> {
            while (!Thread.currentThread().isInterrupted()) {
                System.out.println("çº¿ç¨‹è¿è¡Œä¸­...");
                try {
                    Thread.sleep(1000);
                } catch (InterruptedException e) {
                    System.out.println("çº¿ç¨‹è¢«ä¸­æ–­ï¼Œå‡†å¤‡é€€å‡º");
                    // é‡æ–°è®¾ç½®ä¸­æ–­æ ‡å¿—
                    Thread.currentThread().interrupt();
                    break;
                }
            }
            System.out.println("çº¿ç¨‹åœæ­¢");
        });
        
        t.start();
        Thread.sleep(3000);
        t.interrupt(); // å‘é€ä¸­æ–­ä¿¡å·
    }
}
```

---

### 1.3 é—®é¢˜3ï¼šçº¿ç¨‹ä¸­æ–­çš„æ ¸å¿ƒAPIæ˜¯ä»€ä¹ˆï¼Ÿ

**ä¸‰ä¸ªæ ¸å¿ƒæ–¹æ³•**ï¼š

```java
// 1. è®¾ç½®ä¸­æ–­æ ‡å¿—
public void interrupt()

// 2. æ£€æŸ¥ä¸­æ–­æ ‡å¿—ï¼ˆä¸æ¸…é™¤ï¼‰
public boolean isInterrupted()

// 3. æ£€æŸ¥å¹¶æ¸…é™¤ä¸­æ–­æ ‡å¿—ï¼ˆé™æ€æ–¹æ³•ï¼‰
public static boolean interrupted()
```

**è¯¦ç»†è¯´æ˜**ï¼š

#### 1. interrupt() - è¯·æ±‚ä¸­æ–­

```java
Thread t = new Thread(() -> {
    // çº¿ç¨‹é€»è¾‘
});
t.start();
t.interrupt(); // è®¾ç½®tçš„ä¸­æ–­æ ‡å¿—ä¸ºtrue
```

**ä½œç”¨**ï¼š
- è®¾ç½®çº¿ç¨‹çš„ä¸­æ–­æ ‡å¿—ä¸ºtrue
- å¦‚æœçº¿ç¨‹åœ¨é˜»å¡çŠ¶æ€ï¼ˆsleep/wait/joinï¼‰ï¼ŒæŠ›å‡ºInterruptedException
- ä¸ä¼šå¼ºåˆ¶åœæ­¢çº¿ç¨‹

---

#### 2. isInterrupted() - æ£€æŸ¥ä¸­æ–­

```java
public class CheckInterrupt {
    public static void main(String[] args) throws InterruptedException {
        Thread t = new Thread(() -> {
            while (true) {
                if (Thread.currentThread().isInterrupted()) {
                    System.out.println("æ£€æµ‹åˆ°ä¸­æ–­ï¼Œé€€å‡ºå¾ªç¯");
                    break;
                }
                System.out.println("è¿è¡Œä¸­...");
            }
        });
        
        t.start();
        Thread.sleep(100);
        t.interrupt();
    }
}
```

**ç‰¹ç‚¹**ï¼š
- è¿”å›ä¸­æ–­æ ‡å¿—çš„å€¼
- **ä¸æ¸…é™¤ä¸­æ–­æ ‡å¿—**
- å¯ä»¥å¤šæ¬¡è°ƒç”¨

---

#### 3. interrupted() - æ£€æŸ¥å¹¶æ¸…é™¤

```java
public class ClearInterrupt {
    public static void main(String[] args) throws InterruptedException {
        Thread t = new Thread(() -> {
            System.out.println("ç¬¬1æ¬¡æ£€æŸ¥: " + Thread.interrupted()); // trueï¼Œæ¸…é™¤æ ‡å¿—
            System.out.println("ç¬¬2æ¬¡æ£€æŸ¥: " + Thread.interrupted()); // false
            System.out.println("ç¬¬3æ¬¡æ£€æŸ¥: " + Thread.currentThread().isInterrupted()); // false
        });
        
        t.start();
        Thread.sleep(100);
        t.interrupt();
        Thread.sleep(100);
    }
}
```

**ç‰¹ç‚¹**ï¼š
- è¿”å›ä¸­æ–­æ ‡å¿—çš„å€¼
- **æ¸…é™¤ä¸­æ–­æ ‡å¿—**
- é™æ€æ–¹æ³•ï¼Œä½œç”¨äºå½“å‰çº¿ç¨‹

---

### 1.4 é—®é¢˜4ï¼šä¸­æ–­çš„å·¥ä½œåŸç†æ˜¯ä»€ä¹ˆï¼Ÿ

**çŠ¶æ€è½¬æ¢å›¾**ï¼š

```
åœºæ™¯1ï¼šçº¿ç¨‹æ­£åœ¨è¿è¡Œ
RUNNABLE (è¿è¡Œä¸­)
    â†“ interrupt()
RUNNABLE (è¿è¡Œä¸­ï¼Œä¸­æ–­æ ‡å¿—=true)
    â†“ æ£€æŸ¥isInterrupted()
å†³å®šæ˜¯å¦é€€å‡º

åœºæ™¯2ï¼šçº¿ç¨‹æ­£åœ¨é˜»å¡
WAITING/TIMED_WAITING (é˜»å¡ä¸­)
    â†“ interrupt()
æŠ›å‡ºInterruptedException
    â†“
RUNNABLE (è¿è¡Œä¸­ï¼Œä¸­æ–­æ ‡å¿—=false)
    â†“ catchå—å¤„ç†
å†³å®šæ˜¯å¦é€€å‡º
```

**å…³é”®ç†è§£**ï¼š

1. **ä¸­æ–­åªæ˜¯ä¸€ä¸ªæ ‡å¿—**ï¼šä¸ä¼šå¼ºåˆ¶åœæ­¢çº¿ç¨‹
2. **é˜»å¡æ–¹æ³•ä¼šå“åº”ä¸­æ–­**ï¼šæŠ›å‡ºInterruptedException
3. **æŠ›å‡ºå¼‚å¸¸åæ¸…é™¤æ ‡å¿—**ï¼šéœ€è¦é‡æ–°è®¾ç½®

**ç¤ºä¾‹ï¼šä¸­æ–­é˜»å¡çº¿ç¨‹**

```java
public class InterruptBlocked {
    public static void main(String[] args) throws InterruptedException {
        Thread t = new Thread(() -> {
            try {
                System.out.println("å¼€å§‹sleep");
                Thread.sleep(10000); // é˜»å¡10ç§’
                System.out.println("sleepç»“æŸ"); // ä¸ä¼šæ‰§è¡Œ
            } catch (InterruptedException e) {
                System.out.println("sleepè¢«ä¸­æ–­");
                System.out.println("ä¸­æ–­æ ‡å¿—: " + Thread.currentThread().isInterrupted()); // false
            }
        });
        
        t.start();
        Thread.sleep(1000);
        t.interrupt(); // ä¸­æ–­é˜»å¡çš„çº¿ç¨‹
    }
}
```

**è¾“å‡º**ï¼š

```
å¼€å§‹sleep
sleepè¢«ä¸­æ–­
ä¸­æ–­æ ‡å¿—: false
```

---

### 1.5 é—®é¢˜5ï¼šå¦‚ä½•æ­£ç¡®å¤„ç†InterruptedExceptionï¼Ÿ

**é”™è¯¯å¤„ç†æ–¹å¼**ï¼š

```java
// âŒ é”™è¯¯1ï¼šåæ‰å¼‚å¸¸
try {
    Thread.sleep(1000);
} catch (InterruptedException e) {
    // ä»€ä¹ˆéƒ½ä¸åšï¼Œä¸­æ–­ä¿¡æ¯ä¸¢å¤±
}

// âŒ é”™è¯¯2ï¼šåªæ‰“å°æ—¥å¿—
try {
    Thread.sleep(1000);
} catch (InterruptedException e) {
    e.printStackTrace(); // ä»…æ‰“å°ï¼Œä¸ä¼ æ’­ä¸­æ–­
}
```

**æ­£ç¡®å¤„ç†æ–¹å¼**ï¼š

```java
// âœ… æ–¹å¼1ï¼šé‡æ–°æŠ›å‡ºå¼‚å¸¸
public void method() throws InterruptedException {
    try {
        Thread.sleep(1000);
    } catch (InterruptedException e) {
        // æ¸…ç†èµ„æº
        cleanup();
        // é‡æ–°æŠ›å‡º
        throw e;
    }
}

// âœ… æ–¹å¼2ï¼šæ¢å¤ä¸­æ–­çŠ¶æ€
public void method() {
    try {
        Thread.sleep(1000);
    } catch (InterruptedException e) {
        // æ¸…ç†èµ„æº
        cleanup();
        // æ¢å¤ä¸­æ–­æ ‡å¿—
        Thread.currentThread().interrupt();
    }
}

// âœ… æ–¹å¼3ï¼šé€€å‡ºçº¿ç¨‹
public void run() {
    while (!Thread.currentThread().isInterrupted()) {
        try {
            Thread.sleep(1000);
        } catch (InterruptedException e) {
            System.out.println("çº¿ç¨‹è¢«ä¸­æ–­ï¼Œå‡†å¤‡é€€å‡º");
            // æ¢å¤ä¸­æ–­æ ‡å¿—
            Thread.currentThread().interrupt();
            // é€€å‡ºå¾ªç¯
            break;
        }
    }
}
```

**å¤„ç†åŸåˆ™**ï¼š

1. **ä¸è¦åæ‰å¼‚å¸¸**ï¼šå¿…é¡»ä¼ æ’­ä¸­æ–­ä¿¡æ¯
2. **æ¸…ç†èµ„æº**ï¼šå…³é—­æ–‡ä»¶ã€è¿æ¥ç­‰
3. **æ¢å¤ä¸­æ–­çŠ¶æ€**ï¼šè°ƒç”¨interrupt()
4. **å‘ä¸Šä¼ æ’­**ï¼šæŠ›å‡ºå¼‚å¸¸æˆ–è®¾ç½®æ ‡å¿—

---

### 1.6 é—®é¢˜6ï¼šå“ªäº›æ–¹æ³•ä¼šå“åº”ä¸­æ–­ï¼Ÿ

**å“åº”ä¸­æ–­çš„æ–¹æ³•**ï¼ˆæŠ›å‡ºInterruptedExceptionï¼‰ï¼š

```java
// Threadç±»
Thread.sleep(long millis)
Thread.join()
Thread.join(long millis)

// Objectç±»
Object.wait()
Object.wait(long timeout)

// å¹¶å‘å·¥å…·ç±»
BlockingQueue.take()
BlockingQueue.put(E e)
CountDownLatch.await()
Semaphore.acquire()
Lock.lockInterruptibly()
Condition.await()
```

**ä¸å“åº”ä¸­æ–­çš„æ–¹æ³•**ï¼š

```java
// synchronizedå—ï¼ˆä¸ä¼šæŠ›å‡ºInterruptedExceptionï¼‰
synchronized (lock) {
    // å³ä½¿è¢«ä¸­æ–­ï¼Œä¹Ÿä¼šç»§ç»­ç­‰å¾…é”
}

// IOæ“ä½œï¼ˆä¸ä¼šæŠ›å‡ºInterruptedExceptionï¼‰
InputStream.read()
OutputStream.write()
Socket.accept()
```

**ç¤ºä¾‹ï¼šsynchronizedä¸å“åº”ä¸­æ–­**

```java
public class SynchronizedNoInterrupt {
    private static final Object lock = new Object();
    
    public static void main(String[] args) throws InterruptedException {
        Thread t1 = new Thread(() -> {
            synchronized (lock) {
                try {
                    Thread.sleep(10000); // æŒæœ‰é”10ç§’
                } catch (InterruptedException e) {
                    e.printStackTrace();
                }
            }
        });
        
        Thread t2 = new Thread(() -> {
            System.out.println("t2å°è¯•è·å–é”");
            synchronized (lock) { // é˜»å¡åœ¨è¿™é‡Œ
                System.out.println("t2è·å¾—é”");
            }
        });
        
        t1.start();
        Thread.sleep(100);
        t2.start();
        Thread.sleep(100);
        
        t2.interrupt(); // ä¸­æ–­t2ï¼Œä½†t2ä»ç„¶é˜»å¡
        System.out.println("t2è¢«ä¸­æ–­ï¼Œä½†ä»åœ¨ç­‰å¾…é”");
        
        Thread.sleep(2000);
        System.out.println("t2çŠ¶æ€: " + t2.getState()); // BLOCKED
    }
}
```

**è§£å†³æ–¹æ¡ˆï¼šä½¿ç”¨Lock.lockInterruptibly()**

```java
public class LockInterruptibly {
    private static final Lock lock = new ReentrantLock();
    
    public static void main(String[] args) throws InterruptedException {
        Thread t1 = new Thread(() -> {
            lock.lock();
            try {
                Thread.sleep(10000);
            } catch (InterruptedException e) {
                e.printStackTrace();
            } finally {
                lock.unlock();
            }
        });
        
        Thread t2 = new Thread(() -> {
            try {
                System.out.println("t2å°è¯•è·å–é”");
                lock.lockInterruptibly(); // å¯ä¸­æ–­çš„é”
                try {
                    System.out.println("t2è·å¾—é”");
                } finally {
                    lock.unlock();
                }
            } catch (InterruptedException e) {
                System.out.println("t2è¢«ä¸­æ–­");
            }
        });
        
        t1.start();
        Thread.sleep(100);
        t2.start();
        Thread.sleep(100);
        
        t2.interrupt(); // ä¸­æ–­t2ï¼Œç«‹å³å“åº”
    }
}
```

---

## 2. å®ˆæŠ¤çº¿ç¨‹ï¼ˆDaemon Threadï¼‰

### 2.1 é—®é¢˜7ï¼šä»€ä¹ˆæ˜¯å®ˆæŠ¤çº¿ç¨‹ï¼Ÿ

**å®šä¹‰**ï¼š

- **ç”¨æˆ·çº¿ç¨‹**ï¼šJVMä¼šç­‰å¾…æ‰€æœ‰ç”¨æˆ·çº¿ç¨‹ç»“æŸæ‰é€€å‡º
- **å®ˆæŠ¤çº¿ç¨‹**ï¼šJVMä¸ä¼šç­‰å¾…å®ˆæŠ¤çº¿ç¨‹ç»“æŸï¼Œç”¨æˆ·çº¿ç¨‹ç»“æŸåç«‹å³é€€å‡º

**è®¾ç½®æ–¹å¼**ï¼š

```java
Thread t = new Thread(() -> {
    // çº¿ç¨‹é€»è¾‘
});
t.setDaemon(true); // è®¾ç½®ä¸ºå®ˆæŠ¤çº¿ç¨‹ï¼ˆå¿…é¡»åœ¨start()ä¹‹å‰ï¼‰
t.start();
```

---

### 2.2 é—®é¢˜8ï¼šå®ˆæŠ¤çº¿ç¨‹çš„å…¸å‹åº”ç”¨åœºæ™¯æ˜¯ä»€ä¹ˆï¼Ÿ

**åœºæ™¯1ï¼šåƒåœ¾å›æ”¶çº¿ç¨‹**

```java
// JVMçš„GCçº¿ç¨‹å°±æ˜¯å®ˆæŠ¤çº¿ç¨‹
// å½“æ‰€æœ‰ç”¨æˆ·çº¿ç¨‹ç»“æŸæ—¶ï¼ŒGCçº¿ç¨‹è‡ªåŠ¨é€€å‡º
```

**åœºæ™¯2ï¼šç›‘æ§çº¿ç¨‹**

```java
public class MonitorDaemon {
    public static void main(String[] args) throws InterruptedException {
        Thread monitor = new Thread(() -> {
            while (true) {
                System.out.println("ç›‘æ§ä¸­...");
                try {
                    Thread.sleep(1000);
                } catch (InterruptedException e) {
                    break;
                }
            }
        });
        
        monitor.setDaemon(true); // è®¾ç½®ä¸ºå®ˆæŠ¤çº¿ç¨‹
        monitor.start();
        
        // ä¸»çº¿ç¨‹æ‰§è¡Œä»»åŠ¡
        System.out.println("ä¸»çº¿ç¨‹å¼€å§‹å·¥ä½œ");
        Thread.sleep(3000);
        System.out.println("ä¸»çº¿ç¨‹ç»“æŸ");
        
        // ä¸»çº¿ç¨‹ç»“æŸåï¼Œå®ˆæŠ¤çº¿ç¨‹è‡ªåŠ¨é€€å‡º
    }
}
```

**åœºæ™¯3ï¼šå¿ƒè·³çº¿ç¨‹**

```java
public class HeartbeatDaemon {
    public static void main(String[] args) throws InterruptedException {
        Thread heartbeat = new Thread(() -> {
            while (true) {
                System.out.println("å‘é€å¿ƒè·³...");
                try {
                    Thread.sleep(5000);
                } catch (InterruptedException e) {
                    break;
                }
            }
        });
        
        heartbeat.setDaemon(true);
        heartbeat.start();
        
        // ä¸»çº¿ç¨‹å¤„ç†ä¸šåŠ¡
        Thread.sleep(15000);
        System.out.println("ä¸šåŠ¡ç»“æŸï¼Œç¨‹åºé€€å‡º");
        // å¿ƒè·³çº¿ç¨‹è‡ªåŠ¨é€€å‡º
    }
}
```

---

### 2.3 é—®é¢˜9ï¼šå®ˆæŠ¤çº¿ç¨‹æœ‰å“ªäº›æ³¨æ„äº‹é¡¹ï¼Ÿ

**é™·é˜±1ï¼šå®ˆæŠ¤çº¿ç¨‹å¯èƒ½çªç„¶ç»ˆæ­¢**

```java
public class DaemonTrap1 {
    public static void main(String[] args) throws InterruptedException {
        Thread daemon = new Thread(() -> {
            try {
                System.out.println("å¼€å§‹å†™å…¥æ–‡ä»¶");
                // æ¨¡æ‹Ÿæ–‡ä»¶å†™å…¥
                for (int i = 0; i < 10; i++) {
                    System.out.println("å†™å…¥æ•°æ® " + i);
                    Thread.sleep(500);
                }
                System.out.println("æ–‡ä»¶å†™å…¥å®Œæˆ"); // å¯èƒ½ä¸ä¼šæ‰§è¡Œ
            } catch (InterruptedException e) {
                e.printStackTrace();
            }
        });
        
        daemon.setDaemon(true);
        daemon.start();
        
        Thread.sleep(2000);
        System.out.println("ä¸»çº¿ç¨‹ç»“æŸ");
        // å®ˆæŠ¤çº¿ç¨‹å¯èƒ½åœ¨å†™å…¥è¿‡ç¨‹ä¸­è¢«å¼ºåˆ¶ç»ˆæ­¢ï¼Œæ•°æ®ä¸¢å¤±ï¼
    }
}
```

**é™·é˜±2ï¼šfinallyå—å¯èƒ½ä¸æ‰§è¡Œ**

```java
public class DaemonTrap2 {
    public static void main(String[] args) throws InterruptedException {
        Thread daemon = new Thread(() -> {
            try {
                System.out.println("è·å–èµ„æº");
                Thread.sleep(5000);
            } catch (InterruptedException e) {
                e.printStackTrace();
            } finally {
                System.out.println("é‡Šæ”¾èµ„æº"); // å¯èƒ½ä¸æ‰§è¡Œ
            }
        });
        
        daemon.setDaemon(true);
        daemon.start();
        
        Thread.sleep(1000);
        System.out.println("ä¸»çº¿ç¨‹ç»“æŸ");
        // å®ˆæŠ¤çº¿ç¨‹çš„finallyå—å¯èƒ½ä¸æ‰§è¡Œ
    }
}
```

**ä½¿ç”¨åŸåˆ™**ï¼š

1. âŒ **ä¸è¦åœ¨å®ˆæŠ¤çº¿ç¨‹ä¸­æ‰§è¡ŒIOæ“ä½œ**
2. âŒ **ä¸è¦åœ¨å®ˆæŠ¤çº¿ç¨‹ä¸­æŒæœ‰èµ„æº**
3. âŒ **ä¸è¦ä¾èµ–å®ˆæŠ¤çº¿ç¨‹çš„finallyå—**
4. âœ… **åªç”¨äºä¸é‡è¦çš„åå°ä»»åŠ¡**
5. âœ… **å¯ä»¥éšæ—¶ç»ˆæ­¢çš„ä»»åŠ¡**

---

## 3. çº¿ç¨‹ä¼˜å…ˆçº§

### 3.1 é—®é¢˜10ï¼šçº¿ç¨‹ä¼˜å…ˆçº§æ˜¯ä»€ä¹ˆï¼Ÿ

**å®šä¹‰**ï¼š

```java
public final static int MIN_PRIORITY = 1;   // æœ€ä½ä¼˜å…ˆçº§
public final static int NORM_PRIORITY = 5;  // é»˜è®¤ä¼˜å…ˆçº§
public final static int MAX_PRIORITY = 10;  // æœ€é«˜ä¼˜å…ˆçº§

// è®¾ç½®ä¼˜å…ˆçº§
thread.setPriority(Thread.MAX_PRIORITY);

// è·å–ä¼˜å…ˆçº§
int priority = thread.getPriority();
```

**ä½œç”¨**ï¼š
- æç¤ºè°ƒåº¦å™¨ä¼˜å…ˆè°ƒåº¦é«˜ä¼˜å…ˆçº§çº¿ç¨‹
- **ä»…ä»…æ˜¯æç¤ºï¼Œä¸ä¿è¯**

---

### 3.2 é—®é¢˜11ï¼šçº¿ç¨‹ä¼˜å…ˆçº§å¯é å—ï¼Ÿ

**ç¤ºä¾‹ä»£ç **ï¼š

```java
public class PriorityTest {
    private static int count1 = 0;
    private static int count2 = 0;
    
    public static void main(String[] args) throws InterruptedException {
        Thread t1 = new Thread(() -> {
            while (true) {
                count1++;
            }
        });
        
        Thread t2 = new Thread(() -> {
            while (true) {
                count2++;
            }
        });
        
        t1.setPriority(Thread.MIN_PRIORITY); // ä¼˜å…ˆçº§1
        t2.setPriority(Thread.MAX_PRIORITY); // ä¼˜å…ˆçº§10
        
        t1.start();
        t2.start();
        
        Thread.sleep(1000);
        
        System.out.println("ä½ä¼˜å…ˆçº§çº¿ç¨‹æ‰§è¡Œæ¬¡æ•°: " + count1);
        System.out.println("é«˜ä¼˜å…ˆçº§çº¿ç¨‹æ‰§è¡Œæ¬¡æ•°: " + count2);
        
        System.exit(0);
    }
}
```

**å¯èƒ½çš„ç»“æœ**ï¼š

```
ä½ä¼˜å…ˆçº§çº¿ç¨‹æ‰§è¡Œæ¬¡æ•°: 1234567890
é«˜ä¼˜å…ˆçº§çº¿ç¨‹æ‰§è¡Œæ¬¡æ•°: 1234567890
```

**ä¸ºä»€ä¹ˆä¸å¯é ï¼Ÿ**

1. **ä¾èµ–æ“ä½œç³»ç»Ÿ**ï¼šä¸åŒOSå®ç°ä¸åŒ
2. **å¯èƒ½è¢«å¿½ç•¥**ï¼šæŸäº›OSå¿½ç•¥Javaä¼˜å…ˆçº§
3. **æ˜ å°„é—®é¢˜**ï¼šJava 10ä¸ªä¼˜å…ˆçº§æ˜ å°„åˆ°OSçš„ä¼˜å…ˆçº§
4. **çº¿ç¨‹é¥¥é¥¿**ï¼šä½ä¼˜å…ˆçº§çº¿ç¨‹å¯èƒ½æ°¸è¿œå¾—ä¸åˆ°æ‰§è¡Œ

**å»ºè®®**ï¼š
- âš ï¸ ä¸è¦ä¾èµ–ä¼˜å…ˆçº§å®ç°ä¸šåŠ¡é€»è¾‘
- âš ï¸ ä»…ä½œä¸ºæ€§èƒ½ä¼˜åŒ–çš„å‚è€ƒ
- âœ… ä½¿ç”¨å…¶ä»–æœºåˆ¶ï¼ˆå¦‚çº¿ç¨‹æ± ï¼‰æ§åˆ¶æ‰§è¡Œé¡ºåº

---

## 4. çº¿ç¨‹ç»„ï¼ˆThreadGroupï¼‰

### 4.1 é—®é¢˜12ï¼šä»€ä¹ˆæ˜¯çº¿ç¨‹ç»„ï¼Ÿ

**å®šä¹‰**ï¼š

```java
// åˆ›å»ºçº¿ç¨‹ç»„
ThreadGroup group = new ThreadGroup("MyGroup");

// åœ¨çº¿ç¨‹ç»„ä¸­åˆ›å»ºçº¿ç¨‹
Thread t1 = new Thread(group, () -> {
    // çº¿ç¨‹é€»è¾‘
}, "Thread-1");

// æ‰¹é‡æ“ä½œ
group.interrupt(); // ä¸­æ–­ç»„å†…æ‰€æœ‰çº¿ç¨‹
```

**ä½œç”¨**ï¼š
- æ‰¹é‡ç®¡ç†çº¿ç¨‹
- ç»Ÿä¸€å¼‚å¸¸å¤„ç†
- å±‚çº§ç»“æ„

---

### 4.2 é—®é¢˜13ï¼šçº¿ç¨‹ç»„çš„å®é™…åº”ç”¨åœºæ™¯æ˜¯ä»€ä¹ˆï¼Ÿ

**åœºæ™¯1ï¼šæ‰¹é‡ä¸­æ–­**

```java
public class ThreadGroupInterrupt {
    public static void main(String[] args) throws InterruptedException {
        ThreadGroup group = new ThreadGroup("WorkerGroup");
        
        // åˆ›å»º10ä¸ªå·¥ä½œçº¿ç¨‹
        for (int i = 0; i < 10; i++) {
            new Thread(group, () -> {
                while (!Thread.currentThread().isInterrupted()) {
                    System.out.println(Thread.currentThread().getName() + " è¿è¡Œä¸­");
                    try {
                        Thread.sleep(1000);
                    } catch (InterruptedException e) {
                        Thread.currentThread().interrupt();
                        break;
                    }
                }
            }, "Worker-" + i).start();
        }
        
        Thread.sleep(3000);
        
        // æ‰¹é‡ä¸­æ–­æ‰€æœ‰çº¿ç¨‹
        System.out.println("ä¸­æ–­æ‰€æœ‰å·¥ä½œçº¿ç¨‹");
        group.interrupt();
    }
}
```

**åœºæ™¯2ï¼šç»Ÿä¸€å¼‚å¸¸å¤„ç†**

```java
public class ThreadGroupException {
    public static void main(String[] args) {
        ThreadGroup group = new ThreadGroup("MyGroup") {
            @Override
            public void uncaughtException(Thread t, Throwable e) {
                System.out.println("çº¿ç¨‹ " + t.getName() + " å‘ç”Ÿå¼‚å¸¸: " + e.getMessage());
            }
        };
        
        Thread t1 = new Thread(group, () -> {
            throw new RuntimeException("æ¨¡æ‹Ÿå¼‚å¸¸");
        }, "Thread-1");
        
        t1.start();
    }
}
```

**ç°çŠ¶**ï¼š
- âš ï¸ ThreadGroupå·²è¿‡æ—¶ï¼Œä¸æ¨èä½¿ç”¨
- âœ… ä½¿ç”¨çº¿ç¨‹æ± ï¼ˆExecutorServiceï¼‰æ›¿ä»£
- âœ… ä½¿ç”¨UncaughtExceptionHandlerå¤„ç†å¼‚å¸¸

---

## 5. çº¿ç¨‹æœ¬åœ°å˜é‡ï¼ˆThreadLocalï¼‰

### 5.1 é—®é¢˜14ï¼šä»€ä¹ˆæ˜¯ThreadLocalï¼Ÿ

**å®šä¹‰**ï¼š

```java
// åˆ›å»ºThreadLocalå˜é‡
ThreadLocal<String> threadLocal = new ThreadLocal<>();

// è®¾ç½®å€¼
threadLocal.set("value");

// è·å–å€¼
String value = threadLocal.get();

// ç§»é™¤å€¼
threadLocal.remove();
```

**ä½œç”¨**ï¼š
- æ¯ä¸ªçº¿ç¨‹æ‹¥æœ‰ç‹¬ç«‹çš„å˜é‡å‰¯æœ¬
- çº¿ç¨‹éš”ç¦»ï¼Œé¿å…å…±äº«å˜é‡çš„åŒæ­¥é—®é¢˜

---

### 5.2 é—®é¢˜15ï¼šThreadLocalçš„å…¸å‹åº”ç”¨åœºæ™¯æ˜¯ä»€ä¹ˆï¼Ÿ

**åœºæ™¯1ï¼šæ•°æ®åº“è¿æ¥ç®¡ç†**

```java
public class ConnectionManager {
    private static ThreadLocal<Connection> connectionHolder = new ThreadLocal<>();
    
    public static Connection getConnection() {
        Connection conn = connectionHolder.get();
        if (conn == null) {
            conn = createConnection();
            connectionHolder.set(conn);
        }
        return conn;
    }
    
    public static void closeConnection() {
        Connection conn = connectionHolder.get();
        if (conn != null) {
            try {
                conn.close();
            } catch (SQLException e) {
                e.printStackTrace();
            } finally {
                connectionHolder.remove(); // å¿…é¡»remove
            }
        }
    }
    
    private static Connection createConnection() {
        // åˆ›å»ºæ•°æ®åº“è¿æ¥
        return null;
    }
}
```

**åœºæ™¯2ï¼šç”¨æˆ·ä¸Šä¸‹æ–‡ä¼ é€’**

```java
public class UserContext {
    private static ThreadLocal<User> userHolder = new ThreadLocal<>();
    
    public static void setUser(User user) {
        userHolder.set(user);
    }
    
    public static User getUser() {
        return userHolder.get();
    }
    
    public static void clear() {
        userHolder.remove();
    }
}

// ä½¿ç”¨
public class UserService {
    public void processRequest(User user) {
        try {
            UserContext.setUser(user);
            // ä¸šåŠ¡é€»è¾‘ï¼Œå¯ä»¥åœ¨ä»»ä½•åœ°æ–¹è·å–user
            doSomething();
        } finally {
            UserContext.clear(); // å¿…é¡»æ¸…ç†
        }
    }
}
```

**åœºæ™¯3ï¼šSimpleDateFormatçº¿ç¨‹å®‰å…¨**

```java
// âŒ é”™è¯¯ï¼šSimpleDateFormatä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„
public class DateFormatUnsafe {
    private static SimpleDateFormat sdf = new SimpleDateFormat("yyyy-MM-dd");
    
    public static String format(Date date) {
        return sdf.format(date); // å¤šçº¿ç¨‹ä¸‹å¯èƒ½å‡ºé”™
    }
}

// âœ… æ­£ç¡®ï¼šä½¿ç”¨ThreadLocal
public class DateFormatSafe {
    private static ThreadLocal<SimpleDateFormat> sdfHolder = 
        ThreadLocal.withInitial(() -> new SimpleDateFormat("yyyy-MM-dd"));
    
    public static String format(Date date) {
        return sdfHolder.get().format(date); // çº¿ç¨‹å®‰å…¨
    }
}
```

---

### 5.3 é—®é¢˜16ï¼šThreadLocalæœ‰å“ªäº›é™·é˜±ï¼Ÿ

**é™·é˜±1ï¼šå†…å­˜æ³„æ¼**

```java
public class ThreadLocalLeak {
    // âŒ é”™è¯¯ï¼šä½¿ç”¨å®Œä¸remove
    private static ThreadLocal<byte[]> holder = new ThreadLocal<>();
    
    public static void main(String[] args) {
        ExecutorService executor = Executors.newFixedThreadPool(10);
        
        for (int i = 0; i < 100; i++) {
            executor.execute(() -> {
                // å­˜å‚¨å¤§å¯¹è±¡
                holder.set(new byte[1024 * 1024]); // 1MB
                // ä½¿ç”¨å®Œä¸removeï¼Œçº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹ä¸ä¼šé”€æ¯ï¼Œå¯¼è‡´å†…å­˜æ³„æ¼
            });
        }
    }
}

// âœ… æ­£ç¡®ï¼šä½¿ç”¨å®Œå¿…é¡»remove
public class ThreadLocalNoLeak {
    private static ThreadLocal<byte[]> holder = new ThreadLocal<>();
    
    public static void main(String[] args) {
        ExecutorService executor = Executors.newFixedThreadPool(10);
        
        for (int i = 0; i < 100; i++) {
            executor.execute(() -> {
                try {
                    holder.set(new byte[1024 * 1024]);
                    // ä½¿ç”¨ThreadLocal
                } finally {
                    holder.remove(); // å¿…é¡»æ¸…ç†
                }
            });
        }
    }
}
```

**é™·é˜±2ï¼šçˆ¶å­çº¿ç¨‹ä¼ é€’é—®é¢˜**

```java
public class ThreadLocalInherit {
    private static ThreadLocal<String> holder = new ThreadLocal<>();
    
    public static void main(String[] args) {
        holder.set("parent value");
        
        new Thread(() -> {
            System.out.println(holder.get()); // nullï¼Œæ— æ³•è·å–çˆ¶çº¿ç¨‹çš„å€¼
        }).start();
    }
}

// è§£å†³æ–¹æ¡ˆï¼šä½¿ç”¨InheritableThreadLocal
public class InheritableThreadLocalExample {
    private static InheritableThreadLocal<String> holder = new InheritableThreadLocal<>();
    
    public static void main(String[] args) {
        holder.set("parent value");
        
        new Thread(() -> {
            System.out.println(holder.get()); // "parent value"
        }).start();
    }
}
```

**ä½¿ç”¨åŸåˆ™**ï¼š

1. âœ… **ä½¿ç”¨å®Œå¿…é¡»remove()**
2. âœ… **åœ¨finallyå—ä¸­æ¸…ç†**
3. âœ… **é¿å…å­˜å‚¨å¤§å¯¹è±¡**
4. âš ï¸ **çº¿ç¨‹æ± ä¸­ç‰¹åˆ«æ³¨æ„å†…å­˜æ³„æ¼**

---

## 6. æ ¸å¿ƒé—®é¢˜æ€»ç»“

### Q1: ä¸ºä»€ä¹ˆä¸èƒ½ä½¿ç”¨stop()åœæ­¢çº¿ç¨‹ï¼Ÿ
**A**: ä¼šç ´åæ•°æ®ä¸€è‡´æ€§ã€ä¸é‡Šæ”¾é”ã€èµ„æºæ³„æ¼ã€æ— æ³•æ¸…ç†ã€‚

### Q2: æ­£ç¡®åœæ­¢çº¿ç¨‹çš„æ–¹å¼æ˜¯ä»€ä¹ˆï¼Ÿ
**A**: ä½¿ç”¨ä¸­æ–­æœºåˆ¶ï¼ˆinterrupt()ï¼‰æˆ–æ ‡å¿—ä½ã€‚

### Q3: InterruptedExceptionåº”è¯¥å¦‚ä½•å¤„ç†ï¼Ÿ
**A**: ä¸è¦åæ‰å¼‚å¸¸ï¼Œè¦ä¹ˆé‡æ–°æŠ›å‡ºï¼Œè¦ä¹ˆæ¢å¤ä¸­æ–­çŠ¶æ€ã€‚

### Q4: å“ªäº›æ–¹æ³•ä¼šå“åº”ä¸­æ–­ï¼Ÿ
**A**: sleepã€waitã€joinã€BlockingQueueæ“ä½œã€Lock.lockInterruptiblyç­‰ã€‚

### Q5: synchronizedä¼šå“åº”ä¸­æ–­å—ï¼Ÿ
**A**: ä¸ä¼šï¼Œéœ€è¦ä½¿ç”¨Lock.lockInterruptibly()ã€‚

### Q6: å®ˆæŠ¤çº¿ç¨‹é€‚åˆåšä»€ä¹ˆï¼Ÿ
**A**: ä¸é‡è¦çš„åå°ä»»åŠ¡ï¼Œå¦‚ç›‘æ§ã€å¿ƒè·³ï¼Œä¸èƒ½åšIOæ“ä½œã€‚

### Q7: çº¿ç¨‹ä¼˜å…ˆçº§å¯é å—ï¼Ÿ
**A**: ä¸å¯é ï¼Œä¾èµ–æ“ä½œç³»ç»Ÿï¼Œä¸è¦ç”¨äºä¸šåŠ¡é€»è¾‘ã€‚

### Q8: ThreadLocalæœ‰ä»€ä¹ˆç”¨ï¼Ÿ
**A**: çº¿ç¨‹éš”ç¦»ï¼Œæ¯ä¸ªçº¿ç¨‹æ‹¥æœ‰ç‹¬ç«‹çš„å˜é‡å‰¯æœ¬ã€‚

### Q9: ThreadLocalæœ€å¤§çš„é™·é˜±æ˜¯ä»€ä¹ˆï¼Ÿ
**A**: å†…å­˜æ³„æ¼ï¼Œä½¿ç”¨å®Œå¿…é¡»remove()ï¼Œç‰¹åˆ«æ˜¯åœ¨çº¿ç¨‹æ± ä¸­ã€‚

---

## ä¸‹ä¸€ç« é¢„å‘Š

ä¸‹ä¸€ç« æˆ‘ä»¬å°†å¯¹æ¯”åˆ†æï¼š

- **æ‰‹åŠ¨ç®¡ç†çº¿ç¨‹ vs çº¿ç¨‹æ± **
- **ThreadPoolExecutorå¦‚ä½•æ§åˆ¶çº¿ç¨‹ç”Ÿå‘½å‘¨æœŸ**
- **çº¿ç¨‹æ± çš„ä¼˜åŠ¿å’ŒåŠ£åŠ¿**
- **å¦‚ä½•é€‰æ‹©åˆé€‚çš„æ–¹æ¡ˆ**

è®©æˆ‘ä»¬ç»§ç»­æ·±å…¥ï¼ğŸš€
