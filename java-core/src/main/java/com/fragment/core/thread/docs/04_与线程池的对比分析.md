# ç¬¬å››ç« ï¼šä¸çº¿ç¨‹æ± çš„å¯¹æ¯”åˆ†æ

## å¼•è¨€

å‰é¢æˆ‘ä»¬å­¦ä¹ äº†æ‰‹åŠ¨ç®¡ç†çº¿ç¨‹çš„å„ç§æœºåˆ¶ï¼Œæœ¬ç« å°†æ·±å…¥å¯¹æ¯”æ‰‹åŠ¨ç®¡ç†çº¿ç¨‹ä¸çº¿ç¨‹æ± çš„å·®å¼‚ï¼Œç†è§£ThreadPoolExecutorå¦‚ä½•æ§åˆ¶çº¿ç¨‹ç”Ÿå‘½å‘¨æœŸï¼Œä»¥åŠå¦‚ä½•é€‰æ‹©åˆé€‚çš„æ–¹æ¡ˆã€‚

---

## 1. æ‰‹åŠ¨ç®¡ç†çº¿ç¨‹ vs çº¿ç¨‹æ± 

### 1.1 é—®é¢˜1ï¼šæ‰‹åŠ¨ç®¡ç†çº¿ç¨‹æœ‰å“ªäº›é—®é¢˜ï¼Ÿ

**åœºæ™¯ï¼šWebæœåŠ¡å™¨å¤„ç†è¯·æ±‚**

```java
// âŒ æ‰‹åŠ¨ç®¡ç†çº¿ç¨‹çš„æ–¹å¼
public class ManualThreadServer {
    public static void main(String[] args) throws IOException {
        ServerSocket serverSocket = new ServerSocket(8080);
        
        while (true) {
            Socket socket = serverSocket.accept();
            
            // ä¸ºæ¯ä¸ªè¯·æ±‚åˆ›å»ºæ–°çº¿ç¨‹
            new Thread(() -> {
                try {
                    handleRequest(socket);
                } catch (IOException e) {
                    e.printStackTrace();
                } finally {
                    try {
                        socket.close();
                    } catch (IOException e) {
                        e.printStackTrace();
                    }
                }
            }).start();
        }
    }
    
    private static void handleRequest(Socket socket) throws IOException {
        // å¤„ç†è¯·æ±‚
    }
}
```

**å­˜åœ¨çš„é—®é¢˜**ï¼š

1. **æ— é™åˆ¶åˆ›å»ºçº¿ç¨‹**ï¼š
   - æ¯ä¸ªè¯·æ±‚åˆ›å»ºä¸€ä¸ªçº¿ç¨‹
   - é«˜å¹¶å‘æ—¶å¯èƒ½åˆ›å»ºæ•°ä¸‡ä¸ªçº¿ç¨‹
   - å¯¼è‡´OOMæˆ–ç³»ç»Ÿå´©æºƒ

2. **èµ„æºæµªè´¹**ï¼š
   - çº¿ç¨‹åˆ›å»ºå’Œé”€æ¯å¼€é”€å¤§
   - æ¯ä¸ªçº¿ç¨‹å ç”¨1MBæ ˆç©ºé—´
   - ä¸Šä¸‹æ–‡åˆ‡æ¢é¢‘ç¹

3. **æ— æ³•æ§åˆ¶**ï¼š
   - æ— æ³•é™åˆ¶å¹¶å‘æ•°
   - æ— æ³•æ‹’ç»è¿‡è½½è¯·æ±‚
   - æ— æ³•ç›‘æ§å’Œç®¡ç†

4. **å“åº”æ—¶é—´ä¸ç¨³å®š**ï¼š
   - åˆ›å»ºçº¿ç¨‹éœ€è¦æ—¶é—´
   - é«˜å¹¶å‘æ—¶å“åº”å˜æ…¢

**æ€§èƒ½å¯¹æ¯”**ï¼š

```
åœºæ™¯ï¼šå¤„ç†10000ä¸ªè¯·æ±‚

æ‰‹åŠ¨åˆ›å»ºçº¿ç¨‹ï¼š
- åˆ›å»º10000ä¸ªçº¿ç¨‹
- å†…å­˜å ç”¨ï¼š10000 Ã— 1MB = 10GB
- åˆ›å»ºè€—æ—¶ï¼š10000 Ã— 1ms = 10ç§’
- ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼šé¢‘ç¹

çº¿ç¨‹æ± ï¼ˆ100ä¸ªçº¿ç¨‹ï¼‰ï¼š
- å¤ç”¨100ä¸ªçº¿ç¨‹
- å†…å­˜å ç”¨ï¼š100 Ã— 1MB = 100MB
- åˆ›å»ºè€—æ—¶ï¼š100 Ã— 1ms = 0.1ç§’
- ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼šè¾ƒå°‘
```

---

### 1.2 é—®é¢˜2ï¼šçº¿ç¨‹æ± å¦‚ä½•è§£å†³è¿™äº›é—®é¢˜ï¼Ÿ

**ä½¿ç”¨çº¿ç¨‹æ± çš„æ–¹å¼**ï¼š

```java
// âœ… ä½¿ç”¨çº¿ç¨‹æ± 
public class ThreadPoolServer {
    private static final ExecutorService executor = 
        new ThreadPoolExecutor(
            10,                              // æ ¸å¿ƒçº¿ç¨‹æ•°
            100,                             // æœ€å¤§çº¿ç¨‹æ•°
            60L,                             // ç©ºé—²çº¿ç¨‹å­˜æ´»æ—¶é—´
            TimeUnit.SECONDS,
            new LinkedBlockingQueue<>(1000), // ä»»åŠ¡é˜Ÿåˆ—
            new ThreadPoolExecutor.CallerRunsPolicy() // æ‹’ç»ç­–ç•¥
        );
    
    public static void main(String[] args) throws IOException {
        ServerSocket serverSocket = new ServerSocket(8080);
        
        while (true) {
            Socket socket = serverSocket.accept();
            
            // æäº¤ä»»åŠ¡åˆ°çº¿ç¨‹æ± 
            executor.execute(() -> {
                try {
                    handleRequest(socket);
                } catch (IOException e) {
                    e.printStackTrace();
                } finally {
                    try {
                        socket.close();
                    } catch (IOException e) {
                        e.printStackTrace();
                    }
                }
            });
        }
    }
    
    private static void handleRequest(Socket socket) throws IOException {
        // å¤„ç†è¯·æ±‚
    }
}
```

**çº¿ç¨‹æ± çš„ä¼˜åŠ¿**ï¼š

1. âœ… **çº¿ç¨‹å¤ç”¨**ï¼šé¿å…é¢‘ç¹åˆ›å»ºå’Œé”€æ¯
2. âœ… **èµ„æºæ§åˆ¶**ï¼šé™åˆ¶æœ€å¤§çº¿ç¨‹æ•°
3. âœ… **ä»»åŠ¡é˜Ÿåˆ—**ï¼šç¼“å†²è¿‡è½½è¯·æ±‚
4. âœ… **æ‹’ç»ç­–ç•¥**ï¼šä¼˜é›…å¤„ç†è¿‡è½½
5. âœ… **ç»Ÿä¸€ç®¡ç†**ï¼šç›‘æ§ã€è°ƒä¼˜ã€å…³é—­

---

## 2. çº¿ç¨‹ç”Ÿå‘½å‘¨æœŸæ§åˆ¶å¯¹æ¯”

### 2.1 é—®é¢˜3ï¼šæ‰‹åŠ¨ç®¡ç†çº¿ç¨‹çš„ç”Ÿå‘½å‘¨æœŸæœ‰å¤šå¤æ‚ï¼Ÿ

**å®Œæ•´çš„ç”Ÿå‘½å‘¨æœŸç®¡ç†**ï¼š

```java
public class ManualThreadLifecycle {
    private volatile boolean running = true;
    private Thread thread;
    
    // 1. åˆ›å»ºçº¿ç¨‹
    public void start() {
        thread = new Thread(() -> {
            System.out.println("çº¿ç¨‹å¯åŠ¨");
            
            // 2. åˆå§‹åŒ–èµ„æº
            Connection conn = null;
            try {
                conn = createConnection();
                
                // 3. æ‰§è¡Œä»»åŠ¡
                while (running && !Thread.currentThread().isInterrupted()) {
                    try {
                        doWork(conn);
                    } catch (Exception e) {
                        handleException(e);
                    }
                }
            } finally {
                // 4. æ¸…ç†èµ„æº
                if (conn != null) {
                    try {
                        conn.close();
                    } catch (SQLException e) {
                        e.printStackTrace();
                    }
                }
                System.out.println("çº¿ç¨‹ç»“æŸ");
            }
        });
        
        // 5. è®¾ç½®çº¿ç¨‹å±æ€§
        thread.setName("Worker-Thread");
        thread.setDaemon(false);
        thread.setPriority(Thread.NORM_PRIORITY);
        
        // 6. è®¾ç½®å¼‚å¸¸å¤„ç†å™¨
        thread.setUncaughtExceptionHandler((t, e) -> {
            System.err.println("çº¿ç¨‹ " + t.getName() + " å¼‚å¸¸: " + e);
        });
        
        // 7. å¯åŠ¨çº¿ç¨‹
        thread.start();
    }
    
    // 8. åœæ­¢çº¿ç¨‹
    public void stop() {
        running = false;
        if (thread != null) {
            thread.interrupt();
        }
    }
    
    // 9. ç­‰å¾…çº¿ç¨‹ç»“æŸ
    public void join() throws InterruptedException {
        if (thread != null) {
            thread.join();
        }
    }
    
    private Connection createConnection() {
        // åˆ›å»ºè¿æ¥
        return null;
    }
    
    private void doWork(Connection conn) throws Exception {
        // æ‰§è¡Œä»»åŠ¡
    }
    
    private void handleException(Exception e) {
        // å¤„ç†å¼‚å¸¸
    }
}
```

**å¤æ‚åº¦åˆ†æ**ï¼š

- éœ€è¦æ‰‹åŠ¨ç®¡ç†9ä¸ªæ­¥éª¤
- å®¹æ˜“é—æ¼èµ„æºæ¸…ç†
- å¼‚å¸¸å¤„ç†å¤æ‚
- éš¾ä»¥å¤ç”¨å’Œç»´æŠ¤

---

### 2.2 é—®é¢˜4ï¼šçº¿ç¨‹æ± å¦‚ä½•ç®€åŒ–ç”Ÿå‘½å‘¨æœŸç®¡ç†ï¼Ÿ

**ä½¿ç”¨çº¿ç¨‹æ± **ï¼š

```java
public class ThreadPoolLifecycle {
    private final ExecutorService executor;
    
    public ThreadPoolLifecycle() {
        // çº¿ç¨‹æ± è‡ªåŠ¨ç®¡ç†ç”Ÿå‘½å‘¨æœŸ
        executor = new ThreadPoolExecutor(
            10, 20, 60L, TimeUnit.SECONDS,
            new LinkedBlockingQueue<>(1000),
            new ThreadFactoryBuilder()
                .setNameFormat("worker-%d")
                .setDaemon(false)
                .setUncaughtExceptionHandler((t, e) -> {
                    System.err.println("çº¿ç¨‹å¼‚å¸¸: " + t.getName());
                })
                .build(),
            new ThreadPoolExecutor.CallerRunsPolicy()
        );
    }
    
    // æäº¤ä»»åŠ¡ï¼ˆçº¿ç¨‹æ± è‡ªåŠ¨ç®¡ç†ï¼‰
    public void submitTask(Runnable task) {
        executor.execute(task);
    }
    
    // å…³é—­çº¿ç¨‹æ± 
    public void shutdown() {
        executor.shutdown();
        try {
            if (!executor.awaitTermination(60, TimeUnit.SECONDS)) {
                executor.shutdownNow();
            }
        } catch (InterruptedException e) {
            executor.shutdownNow();
            Thread.currentThread().interrupt();
        }
    }
}
```

**ç®€åŒ–çš„åœ°æ–¹**ï¼š

1. âœ… **è‡ªåŠ¨åˆ›å»ºçº¿ç¨‹**ï¼šæ ¹æ®éœ€è¦åˆ›å»º
2. âœ… **è‡ªåŠ¨å¤ç”¨çº¿ç¨‹**ï¼šä»»åŠ¡å®Œæˆåçº¿ç¨‹ä¸é”€æ¯
3. âœ… **è‡ªåŠ¨å›æ”¶çº¿ç¨‹**ï¼šç©ºé—²è¶…æ—¶è‡ªåŠ¨å›æ”¶
4. âœ… **ç»Ÿä¸€å¼‚å¸¸å¤„ç†**ï¼šThreadFactoryè®¾ç½®
5. âœ… **ä¼˜é›…å…³é—­**ï¼šshutdown()è‡ªåŠ¨ç­‰å¾…ä»»åŠ¡å®Œæˆ

---

## 3. ThreadPoolExecutorçš„çº¿ç¨‹æ§åˆ¶æœºåˆ¶

### 3.1 é—®é¢˜5ï¼šThreadPoolExecutorå¦‚ä½•æ§åˆ¶çº¿ç¨‹æ•°é‡ï¼Ÿ

**æ ¸å¿ƒå‚æ•°**ï¼š

```java
public ThreadPoolExecutor(
    int corePoolSize,        // æ ¸å¿ƒçº¿ç¨‹æ•°
    int maximumPoolSize,     // æœ€å¤§çº¿ç¨‹æ•°
    long keepAliveTime,      // ç©ºé—²çº¿ç¨‹å­˜æ´»æ—¶é—´
    TimeUnit unit,           // æ—¶é—´å•ä½
    BlockingQueue<Runnable> workQueue,  // ä»»åŠ¡é˜Ÿåˆ—
    ThreadFactory threadFactory,        // çº¿ç¨‹å·¥å‚
    RejectedExecutionHandler handler    // æ‹’ç»ç­–ç•¥
)
```

**çº¿ç¨‹æ•°é‡æ§åˆ¶æµç¨‹**ï¼š

```
æäº¤ä»»åŠ¡
    â†“
å½“å‰çº¿ç¨‹æ•° < corePoolSizeï¼Ÿ
    â†“ æ˜¯
åˆ›å»ºæ ¸å¿ƒçº¿ç¨‹ï¼ˆæ°¸ä¸å›æ”¶ï¼‰
    â†“ å¦
é˜Ÿåˆ—æœªæ»¡ï¼Ÿ
    â†“ æ˜¯
åŠ å…¥é˜Ÿåˆ—ç­‰å¾…
    â†“ å¦
å½“å‰çº¿ç¨‹æ•° < maximumPoolSizeï¼Ÿ
    â†“ æ˜¯
åˆ›å»ºä¸´æ—¶çº¿ç¨‹ï¼ˆè¶…æ—¶å›æ”¶ï¼‰
    â†“ å¦
æ‰§è¡Œæ‹’ç»ç­–ç•¥
```

**å¯¹æ¯”æ‰‹åŠ¨ç®¡ç†**ï¼š

```java
// æ‰‹åŠ¨ç®¡ç†ï¼šæ— æ³•æ§åˆ¶çº¿ç¨‹æ•°
for (int i = 0; i < 10000; i++) {
    new Thread(() -> {
        // ä»»åŠ¡
    }).start(); // åˆ›å»º10000ä¸ªçº¿ç¨‹ï¼
}

// çº¿ç¨‹æ± ï¼šç²¾ç¡®æ§åˆ¶
ThreadPoolExecutor executor = new ThreadPoolExecutor(
    10, 100, 60L, TimeUnit.SECONDS,
    new LinkedBlockingQueue<>(1000)
);

for (int i = 0; i < 10000; i++) {
    executor.execute(() -> {
        // ä»»åŠ¡
    }); // æœ€å¤š100ä¸ªçº¿ç¨‹ï¼Œå…¶ä½™æ’é˜Ÿ
}
```

---

### 3.2 é—®é¢˜6ï¼šThreadPoolExecutorå¦‚ä½•ç®¡ç†çº¿ç¨‹ç”Ÿå‘½å‘¨æœŸï¼Ÿ

**Workerçº¿ç¨‹çš„ç”Ÿå‘½å‘¨æœŸ**ï¼š

```java
// ThreadPoolExecutorå†…éƒ¨çš„Workerç±»
private final class Worker extends AbstractQueuedSynchronizer
    implements Runnable {
    
    final Thread thread;
    Runnable firstTask;
    
    Worker(Runnable firstTask) {
        this.firstTask = firstTask;
        this.thread = getThreadFactory().newThread(this);
    }
    
    public void run() {
        runWorker(this);
    }
}

// Workerçš„æ‰§è¡Œé€»è¾‘
final void runWorker(Worker w) {
    Runnable task = w.firstTask;
    w.firstTask = null;
    
    try {
        // å¾ªç¯è·å–ä»»åŠ¡
        while (task != null || (task = getTask()) != null) {
            try {
                // æ‰§è¡Œå‰é’©å­
                beforeExecute(w.thread, task);
                
                // æ‰§è¡Œä»»åŠ¡
                task.run();
                
                // æ‰§è¡Œåé’©å­
                afterExecute(task, null);
            } catch (Exception e) {
                afterExecute(task, e);
                throw e;
            } finally {
                task = null;
            }
        }
    } finally {
        // Workeré€€å‡º
        processWorkerExit(w);
    }
}

// è·å–ä»»åŠ¡ï¼ˆæ§åˆ¶çº¿ç¨‹å­˜æ´»ï¼‰
private Runnable getTask() {
    boolean timedOut = false;
    
    for (;;) {
        int wc = workerCountOf(ctl.get());
        
        // åˆ¤æ–­æ˜¯å¦éœ€è¦è¶…æ—¶æ§åˆ¶
        boolean timed = wc > corePoolSize;
        
        if (timed && timedOut) {
            // è¶…æ—¶ï¼Œçº¿ç¨‹é€€å‡º
            return null;
        }
        
        try {
            Runnable r = timed ?
                workQueue.poll(keepAliveTime, TimeUnit.NANOSECONDS) : // è¶…æ—¶ç­‰å¾…
                workQueue.take();                                      // é˜»å¡ç­‰å¾…
            if (r != null)
                return r;
            timedOut = true;
        } catch (InterruptedException e) {
            timedOut = false;
        }
    }
}
```

**å…³é”®æœºåˆ¶**ï¼š

1. **æ ¸å¿ƒçº¿ç¨‹**ï¼šä½¿ç”¨`take()`é˜»å¡ç­‰å¾…ï¼Œæ°¸ä¸è¶…æ—¶
2. **ä¸´æ—¶çº¿ç¨‹**ï¼šä½¿ç”¨`poll(timeout)`è¶…æ—¶ç­‰å¾…ï¼Œè¶…æ—¶åé€€å‡º
3. **å¾ªç¯è·å–ä»»åŠ¡**ï¼šçº¿ç¨‹å¤ç”¨çš„æ ¸å¿ƒ
4. **é’©å­æ–¹æ³•**ï¼šbeforeExecuteã€afterExecute

**å¯¹æ¯”æ‰‹åŠ¨ç®¡ç†**ï¼š

| ç»´åº¦ | æ‰‹åŠ¨ç®¡ç† | çº¿ç¨‹æ±  |
|------|---------|--------|
| **çº¿ç¨‹åˆ›å»º** | æ¯æ¬¡new Thread() | æŒ‰éœ€åˆ›å»ºï¼Œå¤ç”¨ |
| **çº¿ç¨‹é”€æ¯** | ä»»åŠ¡ç»“æŸç«‹å³é”€æ¯ | ç©ºé—²è¶…æ—¶æ‰é”€æ¯ |
| **ä»»åŠ¡è·å–** | æ—  | ä»é˜Ÿåˆ—å¾ªç¯è·å– |
| **å¼‚å¸¸å¤„ç†** | æ‰‹åŠ¨try-catch | ç»Ÿä¸€å¤„ç† |
| **èµ„æºæ¸…ç†** | æ‰‹åŠ¨finally | è‡ªåŠ¨æ¸…ç† |

---

### 3.3 é—®é¢˜7ï¼šçº¿ç¨‹æ± å¦‚ä½•å¤„ç†çº¿ç¨‹å¼‚å¸¸ï¼Ÿ

**æ‰‹åŠ¨ç®¡ç†çº¿ç¨‹çš„å¼‚å¸¸å¤„ç†**ï¼š

```java
Thread t = new Thread(() -> {
    try {
        // ä»»åŠ¡é€»è¾‘
        throw new RuntimeException("ä»»åŠ¡å¼‚å¸¸");
    } catch (Exception e) {
        // å¿…é¡»æ‰‹åŠ¨æ•è·
        System.err.println("ä»»åŠ¡å¼‚å¸¸: " + e);
    }
});

t.setUncaughtExceptionHandler((thread, throwable) -> {
    // æœªæ•è·å¼‚å¸¸å¤„ç†
    System.err.println("çº¿ç¨‹ " + thread.getName() + " å¼‚å¸¸: " + throwable);
});

t.start();
```

**çº¿ç¨‹æ± çš„å¼‚å¸¸å¤„ç†**ï¼š

```java
ThreadPoolExecutor executor = new ThreadPoolExecutor(
    10, 20, 60L, TimeUnit.SECONDS,
    new LinkedBlockingQueue<>(1000),
    new ThreadFactory() {
        @Override
        public Thread newThread(Runnable r) {
            Thread t = new Thread(r);
            // ç»Ÿä¸€è®¾ç½®å¼‚å¸¸å¤„ç†å™¨
            t.setUncaughtExceptionHandler((thread, throwable) -> {
                System.err.println("çº¿ç¨‹å¼‚å¸¸: " + thread.getName());
                throwable.printStackTrace();
            });
            return t;
        }
    }
) {
    // é‡å†™afterExecuteå¤„ç†ä»»åŠ¡å¼‚å¸¸
    @Override
    protected void afterExecute(Runnable r, Throwable t) {
        super.afterExecute(r, t);
        if (t != null) {
            System.err.println("ä»»åŠ¡æ‰§è¡Œå¼‚å¸¸: " + t);
        }
        // å¦‚æœæ˜¯Futureä»»åŠ¡ï¼Œéœ€è¦è°ƒç”¨get()æ‰èƒ½è·å–å¼‚å¸¸
        if (r instanceof Future<?>) {
            try {
                ((Future<?>) r).get();
            } catch (Exception e) {
                System.err.println("Futureä»»åŠ¡å¼‚å¸¸: " + e.getCause());
            }
        }
    }
};
```

**ä¼˜åŠ¿**ï¼š

1. âœ… **ç»Ÿä¸€å¼‚å¸¸å¤„ç†**ï¼šThreadFactoryè®¾ç½®
2. âœ… **ä»»åŠ¡å¼‚å¸¸ä¸å½±å“çº¿ç¨‹**ï¼šçº¿ç¨‹ç»§ç»­æ‰§è¡Œä¸‹ä¸€ä¸ªä»»åŠ¡
3. âœ… **é’©å­æ–¹æ³•**ï¼šafterExecuteå¯ä»¥è®°å½•æ—¥å¿—ã€ç›‘æ§

---

## 4. ä½¿ç”¨åœºæ™¯å¯¹æ¯”

### 4.1 é—®é¢˜8ï¼šä»€ä¹ˆæ—¶å€™åº”è¯¥æ‰‹åŠ¨ç®¡ç†çº¿ç¨‹ï¼Ÿ

**é€‚åˆæ‰‹åŠ¨ç®¡ç†çš„åœºæ™¯**ï¼š

#### åœºæ™¯1ï¼šé•¿æœŸè¿è¡Œçš„åå°çº¿ç¨‹

```java
public class BackgroundMonitor {
    private volatile boolean running = true;
    private Thread monitorThread;
    
    public void start() {
        monitorThread = new Thread(() -> {
            while (running) {
                try {
                    // ç›‘æ§é€»è¾‘
                    checkSystemHealth();
                    Thread.sleep(5000);
                } catch (InterruptedException e) {
                    break;
                }
            }
        });
        
        monitorThread.setName("System-Monitor");
        monitorThread.setDaemon(true);
        monitorThread.start();
    }
    
    private void checkSystemHealth() {
        // æ£€æŸ¥ç³»ç»Ÿå¥åº·çŠ¶æ€
    }
}
```

**åŸå› **ï¼š
- çº¿ç¨‹æ•°é‡å›ºå®šï¼ˆ1ä¸ªï¼‰
- é•¿æœŸè¿è¡Œï¼Œä¸éœ€è¦å¤ç”¨
- ç®€å•çš„é€»è¾‘ï¼Œä¸éœ€è¦çº¿ç¨‹æ± çš„å¤æ‚åŠŸèƒ½

---

#### åœºæ™¯2ï¼šéœ€è¦ç²¾ç¡®æ§åˆ¶çº¿ç¨‹è¡Œä¸º

```java
public class PreciseControl {
    public void execute() {
        Thread t = new Thread(() -> {
            // è®¾ç½®çº¿ç¨‹ä¼˜å…ˆçº§
            Thread.currentThread().setPriority(Thread.MAX_PRIORITY);
            
            // è®¾ç½®çº¿ç¨‹ç»„
            ThreadGroup group = Thread.currentThread().getThreadGroup();
            
            // ç²¾ç¡®æ§åˆ¶çº¿ç¨‹è¡Œä¸º
            doWork();
        });
        
        t.start();
    }
    
    private void doWork() {
        // ä»»åŠ¡é€»è¾‘
    }
}
```

---

#### åœºæ™¯3ï¼šä¸€æ¬¡æ€§ä»»åŠ¡

```java
public class OneTimeTask {
    public void executeOnce() {
        new Thread(() -> {
            // ä¸€æ¬¡æ€§ä»»åŠ¡
            System.out.println("æ‰§è¡Œä¸€æ¬¡æ€§ä»»åŠ¡");
        }).start();
    }
}
```

**åŸå› **ï¼š
- åªæ‰§è¡Œä¸€æ¬¡ï¼Œä¸éœ€è¦å¤ç”¨
- ä½¿ç”¨çº¿ç¨‹æ± åè€Œå¢åŠ å¤æ‚åº¦

---

### 4.2 é—®é¢˜9ï¼šä»€ä¹ˆæ—¶å€™åº”è¯¥ä½¿ç”¨çº¿ç¨‹æ± ï¼Ÿ

**é€‚åˆçº¿ç¨‹æ± çš„åœºæ™¯**ï¼š

#### åœºæ™¯1ï¼šé«˜å¹¶å‘è¯·æ±‚å¤„ç†

```java
public class WebServer {
    private final ExecutorService executor = 
        new ThreadPoolExecutor(
            100, 500, 60L, TimeUnit.SECONDS,
            new LinkedBlockingQueue<>(10000),
            new ThreadPoolExecutor.CallerRunsPolicy()
        );
    
    public void handleRequest(Request request) {
        executor.execute(() -> {
            processRequest(request);
        });
    }
    
    private void processRequest(Request request) {
        // å¤„ç†è¯·æ±‚
    }
}
```

**åŸå› **ï¼š
- è¯·æ±‚æ•°é‡ä¸ç¡®å®š
- éœ€è¦æ§åˆ¶å¹¶å‘æ•°
- éœ€è¦ä»»åŠ¡é˜Ÿåˆ—ç¼“å†²

---

#### åœºæ™¯2ï¼šæ‰¹é‡ä»»åŠ¡å¤„ç†

```java
public class BatchProcessor {
    private final ExecutorService executor = 
        Executors.newFixedThreadPool(10);
    
    public void processBatch(List<Task> tasks) {
        List<Future<Result>> futures = new ArrayList<>();
        
        for (Task task : tasks) {
            Future<Result> future = executor.submit(() -> {
                return processTask(task);
            });
            futures.add(future);
        }
        
        // ç­‰å¾…æ‰€æœ‰ä»»åŠ¡å®Œæˆ
        for (Future<Result> future : futures) {
            try {
                Result result = future.get();
                handleResult(result);
            } catch (Exception e) {
                e.printStackTrace();
            }
        }
    }
    
    private Result processTask(Task task) {
        // å¤„ç†ä»»åŠ¡
        return null;
    }
    
    private void handleResult(Result result) {
        // å¤„ç†ç»“æœ
    }
}
```

**åŸå› **ï¼š
- ä»»åŠ¡æ•°é‡å¤§
- éœ€è¦ç­‰å¾…æ‰€æœ‰ä»»åŠ¡å®Œæˆ
- éœ€è¦è·å–è¿”å›ç»“æœ

---

#### åœºæ™¯3ï¼šå®šæ—¶ä»»åŠ¡

```java
public class ScheduledTasks {
    private final ScheduledExecutorService executor = 
        Executors.newScheduledThreadPool(5);
    
    public void start() {
        // å»¶è¿Ÿæ‰§è¡Œ
        executor.schedule(() -> {
            System.out.println("å»¶è¿Ÿä»»åŠ¡");
        }, 5, TimeUnit.SECONDS);
        
        // å›ºå®šé¢‘ç‡æ‰§è¡Œ
        executor.scheduleAtFixedRate(() -> {
            System.out.println("å®šæ—¶ä»»åŠ¡");
        }, 0, 10, TimeUnit.SECONDS);
        
        // å›ºå®šå»¶è¿Ÿæ‰§è¡Œ
        executor.scheduleWithFixedDelay(() -> {
            System.out.println("å»¶è¿Ÿä»»åŠ¡");
        }, 0, 10, TimeUnit.SECONDS);
    }
}
```

**åŸå› **ï¼š
- éœ€è¦å®šæ—¶è°ƒåº¦
- éœ€è¦å‘¨æœŸæ‰§è¡Œ
- ScheduledExecutorServiceæä¾›äº†å®Œå–„çš„å®šæ—¶åŠŸèƒ½

---

## 5. æ€§èƒ½å¯¹æ¯”

### 5.1 é—®é¢˜10ï¼šæ‰‹åŠ¨ç®¡ç†çº¿ç¨‹ vs çº¿ç¨‹æ± ï¼Œæ€§èƒ½å·®å¼‚æœ‰å¤šå¤§ï¼Ÿ

**æµ‹è¯•ä»£ç **ï¼š

```java
public class PerformanceComparison {
    private static final int TASK_COUNT = 10000;
    
    // æ‰‹åŠ¨åˆ›å»ºçº¿ç¨‹
    public static void manualThreads() {
        long startTime = System.currentTimeMillis();
        
        List<Thread> threads = new ArrayList<>();
        for (int i = 0; i < TASK_COUNT; i++) {
            Thread t = new Thread(() -> {
                doWork();
            });
            threads.add(t);
            t.start();
        }
        
        for (Thread t : threads) {
            try {
                t.join();
            } catch (InterruptedException e) {
                e.printStackTrace();
            }
        }
        
        long endTime = System.currentTimeMillis();
        System.out.println("æ‰‹åŠ¨åˆ›å»ºçº¿ç¨‹è€—æ—¶: " + (endTime - startTime) + "ms");
    }
    
    // ä½¿ç”¨çº¿ç¨‹æ± 
    public static void threadPool() {
        long startTime = System.currentTimeMillis();
        
        ExecutorService executor = Executors.newFixedThreadPool(100);
        
        List<Future<?>> futures = new ArrayList<>();
        for (int i = 0; i < TASK_COUNT; i++) {
            Future<?> future = executor.submit(() -> {
                doWork();
            });
            futures.add(future);
        }
        
        for (Future<?> future : futures) {
            try {
                future.get();
            } catch (Exception e) {
                e.printStackTrace();
            }
        }
        
        executor.shutdown();
        
        long endTime = System.currentTimeMillis();
        System.out.println("çº¿ç¨‹æ± è€—æ—¶: " + (endTime - startTime) + "ms");
    }
    
    private static void doWork() {
        // æ¨¡æ‹Ÿä»»åŠ¡
        try {
            Thread.sleep(10);
        } catch (InterruptedException e) {
            e.printStackTrace();
        }
    }
    
    public static void main(String[] args) {
        manualThreads();
        threadPool();
    }
}
```

**æµ‹è¯•ç»“æœ**ï¼ˆå‚è€ƒå€¼ï¼‰ï¼š

```
æ‰‹åŠ¨åˆ›å»ºçº¿ç¨‹è€—æ—¶: 15000ms
çº¿ç¨‹æ± è€—æ—¶: 1200ms

æ€§èƒ½æå‡: 12.5å€
```

**åˆ†æ**ï¼š

| ç»´åº¦ | æ‰‹åŠ¨åˆ›å»º | çº¿ç¨‹æ±  |
|------|---------|--------|
| **çº¿ç¨‹åˆ›å»º** | 10000æ¬¡ | 100æ¬¡ |
| **å†…å­˜å ç”¨** | 10GB | 100MB |
| **ä¸Šä¸‹æ–‡åˆ‡æ¢** | é¢‘ç¹ | è¾ƒå°‘ |
| **å“åº”æ—¶é—´** | ä¸ç¨³å®š | ç¨³å®š |

---

## 6. æ ¸å¿ƒé—®é¢˜æ€»ç»“

### Q1: æ‰‹åŠ¨ç®¡ç†çº¿ç¨‹çš„æœ€å¤§é—®é¢˜æ˜¯ä»€ä¹ˆï¼Ÿ
**A**: æ— æ³•æ§åˆ¶çº¿ç¨‹æ•°é‡ï¼Œé«˜å¹¶å‘æ—¶å¯èƒ½åˆ›å»ºè¿‡å¤šçº¿ç¨‹å¯¼è‡´OOMã€‚

### Q2: çº¿ç¨‹æ± å¦‚ä½•è§£å†³è¿™ä¸ªé—®é¢˜ï¼Ÿ
**A**: é€šè¿‡corePoolSizeå’ŒmaximumPoolSizeé™åˆ¶çº¿ç¨‹æ•°ï¼Œä»»åŠ¡é˜Ÿåˆ—ç¼“å†²è¿‡è½½è¯·æ±‚ã€‚

### Q3: ThreadPoolExecutorå¦‚ä½•æ§åˆ¶çº¿ç¨‹ç”Ÿå‘½å‘¨æœŸï¼Ÿ
**A**: æ ¸å¿ƒçº¿ç¨‹æ°¸ä¸è¶…æ—¶ï¼Œä¸´æ—¶çº¿ç¨‹ç©ºé—²è¶…æ—¶è‡ªåŠ¨å›æ”¶ï¼ŒWorkerå¾ªç¯è·å–ä»»åŠ¡å®ç°å¤ç”¨ã€‚

### Q4: ä»€ä¹ˆæ—¶å€™åº”è¯¥æ‰‹åŠ¨ç®¡ç†çº¿ç¨‹ï¼Ÿ
**A**: é•¿æœŸè¿è¡Œçš„åå°çº¿ç¨‹ã€éœ€è¦ç²¾ç¡®æ§åˆ¶çº¿ç¨‹è¡Œä¸ºã€ä¸€æ¬¡æ€§ä»»åŠ¡ã€‚

### Q5: ä»€ä¹ˆæ—¶å€™åº”è¯¥ä½¿ç”¨çº¿ç¨‹æ± ï¼Ÿ
**A**: é«˜å¹¶å‘è¯·æ±‚å¤„ç†ã€æ‰¹é‡ä»»åŠ¡å¤„ç†ã€å®šæ—¶ä»»åŠ¡ã€‚

### Q6: çº¿ç¨‹æ± æ¯”æ‰‹åŠ¨ç®¡ç†æ€§èƒ½æå‡å¤šå°‘ï¼Ÿ
**A**: æ ¹æ®åœºæ™¯ä¸åŒï¼Œé€šå¸¸å¯ä»¥æå‡5-20å€ã€‚

---

## ä¸‹ä¸€ç« é¢„å‘Š

ä¸‹ä¸€ç« æˆ‘ä»¬å°†æ·±å…¥æºç ï¼š

- **Threadç±»çš„æ ¸å¿ƒæºç åˆ†æ**
- **wait/notifyçš„åº•å±‚å®ç°**
- **çº¿ç¨‹çŠ¶æ€è½¬æ¢çš„æºç å®ç°**
- **å®é™…ç¼–ç ä¸­å¯ä»¥å€Ÿé‰´çš„è®¾è®¡**

è®©æˆ‘ä»¬ç»§ç»­æ·±å…¥ï¼ğŸš€
