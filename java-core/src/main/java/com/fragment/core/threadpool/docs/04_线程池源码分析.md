# ç¬¬å››ç« ï¼šçº¿ç¨‹æ± æºç åˆ†æ

## å¼•è¨€

æœ¬ç« å°†æ·±å…¥ThreadPoolExecutorçš„æºç ï¼Œç†è§£å…¶ç²¾å¦™çš„è®¾è®¡å’Œå®ç°ç»†èŠ‚ã€‚

---

## 1. ctlçš„å·§å¦™è®¾è®¡

### 1.1 é—®é¢˜1ï¼šä¸ºä»€ä¹ˆç”¨ä¸€ä¸ªAtomicIntegerè¡¨ç¤ºä¸¤ä¸ªå€¼ï¼Ÿ

**æºç åˆ†æ**ï¼š

```java
// ä½¿ç”¨ä¸€ä¸ª32ä½æ•´æ•°åŒæ—¶è¡¨ç¤ºä¸¤ä¸ªä¿¡æ¯
private final AtomicInteger ctl = new AtomicInteger(ctlOf(RUNNING, 0));

// é«˜3ä½ï¼šè¡¨ç¤ºçº¿ç¨‹æ± çŠ¶æ€ï¼ˆ5ç§çŠ¶æ€ï¼‰
// ä½29ä½ï¼šè¡¨ç¤ºå·¥ä½œçº¿ç¨‹æ•°é‡ï¼ˆæœ€å¤š5äº¿ä¸ªçº¿ç¨‹ï¼‰
private static final int COUNT_BITS = Integer.SIZE - 3;  // 29
private static final int CAPACITY   = (1 << COUNT_BITS) - 1;  // 0001 1111...ï¼ˆ29ä¸ª1ï¼‰

// çº¿ç¨‹æ± çŠ¶æ€ï¼ˆå­˜å‚¨åœ¨é«˜3ä½ï¼‰
private static final int RUNNING    = -1 << COUNT_BITS;  // 111 00000...
private static final int SHUTDOWN   =  0 << COUNT_BITS;  // 000 00000...
private static final int STOP       =  1 << COUNT_BITS;  // 001 00000...
private static final int TIDYING    =  2 << COUNT_BITS;  // 010 00000...
private static final int TERMINATED =  3 << COUNT_BITS;  // 011 00000...

// è·å–è¿è¡ŒçŠ¶æ€
private static int runStateOf(int c)     { return c & ~CAPACITY; }
// è·å–å·¥ä½œçº¿ç¨‹æ•°
private static int workerCountOf(int c)  { return c & CAPACITY; }
// ç»„åˆçŠ¶æ€å’Œçº¿ç¨‹æ•°
private static int ctlOf(int rs, int wc) { return rs | wc; }
```

**è®¾è®¡ä¼˜åŠ¿**ï¼š

1. **åŸå­æ€§**ï¼šçŠ¶æ€å’Œçº¿ç¨‹æ•°å¿…é¡»åŒæ—¶æ›´æ–°ï¼Œä¸€æ¬¡CASæ“ä½œå®Œæˆ
2. **æ€§èƒ½**ï¼šé¿å…ä½¿ç”¨ä¸¤ä¸ªAtomicIntegerï¼Œå‡å°‘å†…å­˜å ç”¨
3. **ä¸€è‡´æ€§**ï¼šä¿è¯çŠ¶æ€å’Œçº¿ç¨‹æ•°çš„å¼ºä¸€è‡´æ€§

**ä½è¿ç®—å›¾è§£**ï¼š

```
ctl = 111 00000000000000000000000000101
      â†‘â†‘â†‘ â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘
      çŠ¶æ€  å·¥ä½œçº¿ç¨‹æ•°ï¼ˆ5ä¸ªçº¿ç¨‹ï¼‰
      
runStateOf(ctl):
  ctl & ~CAPACITY
  = 111 00000000000000000000000000101
  & 111 00000000000000000000000000000
  = 111 00000000000000000000000000000  (RUNNING)

workerCountOf(ctl):
  ctl & CAPACITY
  = 111 00000000000000000000000000101
  & 000 11111111111111111111111111111
  = 000 00000000000000000000000000101  (5)
```

---

## 2. execute()æ–¹æ³•æºç å‰–æ

### 2.2 é—®é¢˜2ï¼šä»»åŠ¡æäº¤çš„å®Œæ•´æµç¨‹æ˜¯ä»€ä¹ˆï¼Ÿ

**æºç åˆ†æ**ï¼š

```java
public void execute(Runnable command) {
    if (command == null)
        throw new NullPointerException();
    
    // è·å–ctlå€¼
    int c = ctl.get();
    
    // æ­¥éª¤1: å¦‚æœå½“å‰çº¿ç¨‹æ•° < æ ¸å¿ƒçº¿ç¨‹æ•°ï¼Œåˆ›å»ºæ ¸å¿ƒçº¿ç¨‹
    if (workerCountOf(c) < corePoolSize) {
        if (addWorker(command, true))  // trueè¡¨ç¤ºæ ¸å¿ƒçº¿ç¨‹
            return;  // åˆ›å»ºæˆåŠŸï¼Œç›´æ¥è¿”å›
        c = ctl.get();  // åˆ›å»ºå¤±è´¥ï¼Œé‡æ–°è·å–ctl
    }
    
    // æ­¥éª¤2: å°è¯•å°†ä»»åŠ¡åŠ å…¥é˜Ÿåˆ—
    if (isRunning(c) && workQueue.offer(command)) {
        int recheck = ctl.get();
        // åŒé‡æ£€æŸ¥ï¼šå¦‚æœçº¿ç¨‹æ± å·²å…³é—­ï¼Œç§»é™¤ä»»åŠ¡å¹¶æ‹’ç»
        if (!isRunning(recheck) && remove(command))
            reject(command);
        // å¦‚æœæ²¡æœ‰å·¥ä½œçº¿ç¨‹ï¼Œåˆ›å»ºä¸€ä¸ªï¼ˆé˜²æ­¢é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡æ— äººæ‰§è¡Œï¼‰
        else if (workerCountOf(recheck) == 0)
            addWorker(null, false);
    }
    // æ­¥éª¤3: é˜Ÿåˆ—æ»¡äº†ï¼Œå°è¯•åˆ›å»ºä¸´æ—¶çº¿ç¨‹
    else if (!addWorker(command, false)) {  // falseè¡¨ç¤ºéæ ¸å¿ƒçº¿ç¨‹
        // æ­¥éª¤4: æ— æ³•åˆ›å»ºçº¿ç¨‹ï¼Œæ‰§è¡Œæ‹’ç»ç­–ç•¥
        reject(command);
    }
}
```

**å…³é”®ç‚¹**ï¼š

1. **ä¸ºä»€ä¹ˆéœ€è¦åŒé‡æ£€æŸ¥ï¼Ÿ**
   - çº¿ç¨‹æ± çŠ¶æ€å¯èƒ½åœ¨ä»»åŠ¡å…¥é˜Ÿåæ”¹å˜
   - éœ€è¦ç¡®ä¿å·²å…³é—­çš„çº¿ç¨‹æ± ä¸æ‰§è¡Œæ–°ä»»åŠ¡

2. **ä¸ºä»€ä¹ˆé˜Ÿåˆ—æˆåŠŸåè¿˜è¦æ£€æŸ¥çº¿ç¨‹æ•°ï¼Ÿ**
   - é˜²æ­¢æ‰€æœ‰æ ¸å¿ƒçº¿ç¨‹éƒ½å·²é€€å‡ºï¼Œå¯¼è‡´é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡æ— äººæ‰§è¡Œ

---

## 3. addWorker()æ–¹æ³•æºç å‰–æ

### 3.1 é—®é¢˜3ï¼šWorkeræ˜¯å¦‚ä½•åˆ›å»ºçš„ï¼Ÿ

**æºç åˆ†æ**ï¼š

```java
private boolean addWorker(Runnable firstTask, boolean core) {
    retry:
    for (;;) {
        int c = ctl.get();
        int rs = runStateOf(c);
        
        // æ£€æŸ¥çº¿ç¨‹æ± çŠ¶æ€
        if (rs >= SHUTDOWN &&
            ! (rs == SHUTDOWN &&
               firstTask == null &&
               ! workQueue.isEmpty()))
            return false;
        
        // CASå¢åŠ çº¿ç¨‹æ•°
        for (;;) {
            int wc = workerCountOf(c);
            if (wc >= CAPACITY ||
                wc >= (core ? corePoolSize : maximumPoolSize))
                return false;
            if (compareAndIncrementWorkerCount(c))
                break retry;  // CASæˆåŠŸï¼Œè·³å‡ºå¤–å±‚å¾ªç¯
            c = ctl.get();
            if (runStateOf(c) != rs)
                continue retry;  // çŠ¶æ€æ”¹å˜ï¼Œé‡è¯•
        }
    }
    
    // åˆ›å»ºWorker
    boolean workerStarted = false;
    boolean workerAdded = false;
    Worker w = null;
    try {
        w = new Worker(firstTask);
        final Thread t = w.thread;
        if (t != null) {
            final ReentrantLock mainLock = this.mainLock;
            mainLock.lock();
            try {
                int rs = runStateOf(ctl.get());
                
                if (rs < SHUTDOWN ||
                    (rs == SHUTDOWN && firstTask == null)) {
                    if (t.isAlive())
                        throw new IllegalThreadStateException();
                    workers.add(w);  // æ·»åŠ åˆ°workersé›†åˆ
                    int s = workers.size();
                    if (s > largestPoolSize)
                        largestPoolSize = s;
                    workerAdded = true;
                }
            } finally {
                mainLock.unlock();
            }
            if (workerAdded) {
                t.start();  // å¯åŠ¨Workerçº¿ç¨‹
                workerStarted = true;
            }
        }
    } finally {
        if (! workerStarted)
            addWorkerFailed(w);
    }
    return workerStarted;
}
```

**å…³é”®ç‚¹**ï¼š

1. **ä¸ºä»€ä¹ˆä½¿ç”¨ä¸¤å±‚å¾ªç¯ï¼Ÿ**
   - å¤–å±‚å¾ªç¯ï¼šæ£€æŸ¥çº¿ç¨‹æ± çŠ¶æ€
   - å†…å±‚å¾ªç¯ï¼šCASå¢åŠ çº¿ç¨‹æ•°

2. **ä¸ºä»€ä¹ˆéœ€è¦mainLockï¼Ÿ**
   - workersæ˜¯HashSetï¼Œéçº¿ç¨‹å®‰å…¨
   - éœ€è¦ä¿æŠ¤workersçš„æ·»åŠ æ“ä½œ

---

## 4. Workerç±»æºç å‰–æ

### 4.1 é—®é¢˜4ï¼šWorkerä¸ºä»€ä¹ˆç»§æ‰¿AQSï¼Ÿ

**æºç åˆ†æ**ï¼š

```java
private final class Worker
    extends AbstractQueuedSynchronizer
    implements Runnable {
    
    final Thread thread;
    Runnable firstTask;
    volatile long completedTasks;
    
    Worker(Runnable firstTask) {
        setState(-1);  // ç¦æ­¢ä¸­æ–­ï¼Œç›´åˆ°runWorker
        this.firstTask = firstTask;
        this.thread = getThreadFactory().newThread(this);
    }
    
    public void run() {
        runWorker(this);
    }
    
    // å®ç°ç®€å•çš„ä¸å¯é‡å…¥é”
    protected boolean isHeldExclusively() {
        return getState() != 0;
    }
    
    protected boolean tryAcquire(int unused) {
        if (compareAndSetState(0, 1)) {
            setExclusiveOwnerThread(Thread.currentThread());
            return true;
        }
        return false;
    }
    
    protected boolean tryRelease(int unused) {
        setExclusiveOwnerThread(null);
        setState(0);
        return true;
    }
    
    public void lock()        { acquire(1); }
    public boolean tryLock()  { return tryAcquire(1); }
    public void unlock()      { release(1); }
    public boolean isLocked() { return isHeldExclusively(); }
    
    void interruptIfStarted() {
        Thread t;
        if (getState() >= 0 && (t = thread) != null && !t.isInterrupted()) {
            try {
                t.interrupt();
            } catch (SecurityException ignore) {
            }
        }
    }
}
```

**ä¸ºä»€ä¹ˆç»§æ‰¿AQSï¼Ÿ**

1. **å®ç°ä¸å¯é‡å…¥é”**ï¼šæ§åˆ¶ä»»åŠ¡æ‰§è¡Œçš„å¹¶å‘
2. **åŒºåˆ†ç©ºé—²å’Œæ‰§è¡Œä¸­**ï¼šshutdown()æ—¶åªä¸­æ–­ç©ºé—²Worker
3. **é¿å…ä¸­æ–­æ­£åœ¨æ‰§è¡Œçš„ä»»åŠ¡**ï¼šä¿æŠ¤ä»»åŠ¡æ‰§è¡Œ

**çŠ¶æ€å«ä¹‰**ï¼š
- `state = -1`ï¼šåˆå§‹çŠ¶æ€ï¼Œç¦æ­¢ä¸­æ–­
- `state = 0`ï¼šç©ºé—²çŠ¶æ€ï¼Œå¯ä»¥ä¸­æ–­
- `state = 1`ï¼šæ‰§è¡ŒçŠ¶æ€ï¼ŒæŒæœ‰é”

---

## 5. runWorker()æ–¹æ³•æºç å‰–æ

### 5.1 é—®é¢˜5ï¼šWorkerå¦‚ä½•å¾ªç¯æ‰§è¡Œä»»åŠ¡ï¼Ÿ

**æºç åˆ†æ**ï¼š

```java
final void runWorker(Worker w) {
    Thread wt = Thread.currentThread();
    Runnable task = w.firstTask;
    w.firstTask = null;
    w.unlock();  // å…è®¸ä¸­æ–­ï¼ˆstateä»-1å˜ä¸º0ï¼‰
    boolean completedAbruptly = true;
    try {
        // æ ¸å¿ƒå¾ªç¯ï¼šæ‰§è¡ŒfirstTaskæˆ–ä»é˜Ÿåˆ—è·å–ä»»åŠ¡
        while (task != null || (task = getTask()) != null) {
            w.lock();  // è·å–é”ï¼Œé˜²æ­¢shutdownæ—¶ä¸­æ–­
            
            // æ£€æŸ¥çº¿ç¨‹æ± çŠ¶æ€ï¼Œå†³å®šæ˜¯å¦ä¸­æ–­
            if ((runStateAtLeast(ctl.get(), STOP) ||
                 (Thread.interrupted() &&
                  runStateAtLeast(ctl.get(), STOP))) &&
                !wt.isInterrupted())
                wt.interrupt();
            
            try {
                beforeExecute(wt, task);  // é’©å­æ–¹æ³•
                Throwable thrown = null;
                try {
                    task.run();  // æ‰§è¡Œä»»åŠ¡
                } catch (RuntimeException x) {
                    thrown = x; throw x;
                } catch (Error x) {
                    thrown = x; throw x;
                } catch (Throwable x) {
                    thrown = x; throw new Error(x);
                } finally {
                    afterExecute(task, thrown);  // é’©å­æ–¹æ³•
                }
            } finally {
                task = null;
                w.completedTasks++;
                w.unlock();  // é‡Šæ”¾é”
            }
        }
        completedAbruptly = false;
    } finally {
        processWorkerExit(w, completedAbruptly);  // Workeré€€å‡ºå¤„ç†
    }
}
```

**å…³é”®ç‚¹**ï¼š

1. **ä¸ºä»€ä¹ˆè¦lock/unlockï¼Ÿ**
   - é˜²æ­¢shutdown()æ—¶ä¸­æ–­æ­£åœ¨æ‰§è¡Œçš„ä»»åŠ¡
   - åªä¸­æ–­ç©ºé—²çš„Worker

2. **é’©å­æ–¹æ³•çš„ä½œç”¨**ï¼š
   - `beforeExecute()`ï¼šä»»åŠ¡æ‰§è¡Œå‰çš„å¤„ç†
   - `afterExecute()`ï¼šä»»åŠ¡æ‰§è¡Œåçš„å¤„ç†
   - å¯ä»¥ç”¨äºç»Ÿè®¡ã€æ—¥å¿—ã€ç›‘æ§

---

## 6. getTask()æ–¹æ³•æºç å‰–æ

### 6.1 é—®é¢˜6ï¼šWorkerå¦‚ä½•ä»é˜Ÿåˆ—è·å–ä»»åŠ¡ï¼Ÿ

**æºç åˆ†æ**ï¼š

```java
private Runnable getTask() {
    boolean timedOut = false;
    
    for (;;) {
        int c = ctl.get();
        int rs = runStateOf(c);
        
        // æ£€æŸ¥çº¿ç¨‹æ± çŠ¶æ€
        if (rs >= SHUTDOWN && (rs >= STOP || workQueue.isEmpty())) {
            decrementWorkerCount();
            return null;  // è¿”å›nullï¼ŒWorkeré€€å‡º
        }
        
        int wc = workerCountOf(c);
        
        // åˆ¤æ–­æ˜¯å¦éœ€è¦è¶…æ—¶æ§åˆ¶
        boolean timed = allowCoreThreadTimeOut || wc > corePoolSize;
        
        // åˆ¤æ–­æ˜¯å¦åº”è¯¥é€€å‡º
        if ((wc > maximumPoolSize || (timed && timedOut))
            && (wc > 1 || workQueue.isEmpty())) {
            if (compareAndDecrementWorkerCount(c))
                return null;
            continue;
        }
        
        try {
            // æ ¸å¿ƒçº¿ç¨‹ï¼šé˜»å¡ç­‰å¾…
            // éæ ¸å¿ƒçº¿ç¨‹ï¼šè¶…æ—¶ç­‰å¾…
            Runnable r = timed ?
                workQueue.poll(keepAliveTime, TimeUnit.NANOSECONDS) :
                workQueue.take();
            if (r != null)
                return r;
            timedOut = true;
        } catch (InterruptedException retry) {
            timedOut = false;
        }
    }
}
```

**å…³é”®ç‚¹**ï¼š

1. **æ ¸å¿ƒçº¿ç¨‹ä¸ºä»€ä¹ˆä¸ä¼šé€€å‡ºï¼Ÿ**
   - `timed = false`ï¼Œä½¿ç”¨`take()`é˜»å¡ç­‰å¾…
   - é™¤éè®¾ç½®äº†`allowCoreThreadTimeOut`

2. **ä¸´æ—¶çº¿ç¨‹å¦‚ä½•å›æ”¶ï¼Ÿ**
   - `timed = true`ï¼Œä½¿ç”¨`poll(timeout)`è¶…æ—¶ç­‰å¾…
   - è¶…æ—¶åè¿”å›nullï¼ŒWorkeré€€å‡º

---

## 7. shutdown()æ–¹æ³•æºç å‰–æ

### 7.1 é—®é¢˜7ï¼šå¦‚ä½•ä¼˜é›…å…³é—­çº¿ç¨‹æ± ï¼Ÿ

**æºç åˆ†æ**ï¼š

```java
public void shutdown() {
    final ReentrantLock mainLock = this.mainLock;
    mainLock.lock();
    try {
        checkShutdownAccess();
        advanceRunState(SHUTDOWN);  // è®¾ç½®çŠ¶æ€ä¸ºSHUTDOWN
        interruptIdleWorkers();     // ä¸­æ–­ç©ºé—²Worker
        onShutdown();               // é’©å­æ–¹æ³•
    } finally {
        mainLock.unlock();
    }
    tryTerminate();
}

private void interruptIdleWorkers() {
    interruptIdleWorkers(false);
}

private void interruptIdleWorkers(boolean onlyOne) {
    final ReentrantLock mainLock = this.mainLock;
    mainLock.lock();
    try {
        for (Worker w : workers) {
            Thread t = w.thread;
            if (!t.isInterrupted() && w.tryLock()) {  // åªä¸­æ–­ç©ºé—²Worker
                try {
                    t.interrupt();
                } catch (SecurityException ignore) {
                } finally {
                    w.unlock();
                }
            }
            if (onlyOne)
                break;
        }
    } finally {
        mainLock.unlock();
    }
}
```

**å…³é”®ç‚¹**ï¼š

1. **ä¸ºä»€ä¹ˆç”¨tryLock()ï¼Ÿ**
   - åªä¸­æ–­ç©ºé—²çš„Workerï¼ˆèƒ½è·å–é”çš„ï¼‰
   - æ­£åœ¨æ‰§è¡Œä»»åŠ¡çš„WorkeræŒæœ‰é”ï¼Œä¸ä¼šè¢«ä¸­æ–­

2. **shutdown() vs shutdownNow()**ï¼š
   - `shutdown()`ï¼šç­‰å¾…é˜Ÿåˆ—ä»»åŠ¡æ‰§è¡Œå®Œ
   - `shutdownNow()`ï¼šæ¸…ç©ºé˜Ÿåˆ—ï¼Œä¸­æ–­æ‰€æœ‰Worker

---

## 8. æºç ä¸­çš„ç²¾å¦™è®¾è®¡

### 8.1 è®¾è®¡æ¨¡å¼

1. **æ¨¡æ¿æ–¹æ³•æ¨¡å¼**ï¼š
   - `beforeExecute()`ã€`afterExecute()`ã€`terminated()`

2. **ç­–ç•¥æ¨¡å¼**ï¼š
   - `RejectedExecutionHandler`

3. **å·¥å‚æ¨¡å¼**ï¼š
   - `ThreadFactory`

### 8.2 å¹¶å‘æ§åˆ¶

1. **CASæ“ä½œ**ï¼š
   - `ctl`çš„æ›´æ–°ä½¿ç”¨CASï¼Œæ— é”åŒ–

2. **ReentrantLock**ï¼š
   - ä¿æŠ¤`workers`é›†åˆçš„æ“ä½œ

3. **AQS**ï¼š
   - Workerå®ç°ç®€å•çš„ä¸å¯é‡å…¥é”

### 8.3 æ€§èƒ½ä¼˜åŒ–

1. **ä½è¿ç®—**ï¼š
   - ç”¨ä¸€ä¸ªæ•´æ•°è¡¨ç¤ºä¸¤ä¸ªå€¼

2. **å±€éƒ¨æ€§åŸç†**ï¼š
   - WorkeræŒæœ‰Threadï¼Œå‡å°‘æŸ¥æ‰¾

3. **åŒé‡æ£€æŸ¥**ï¼š
   - å‡å°‘é”ç«äº‰

---

## 9. ç‰¹æ®Šåœºæ™¯æºç åˆ†æ

### 9.1 æ ¸å¿ƒçº¿ç¨‹æ•°ä¸º0çš„ç‰¹æ®Šæƒ…å†µ

#### é—®é¢˜ï¼šæ ¸å¿ƒçº¿ç¨‹æ•°ä¸º0ï¼Œæœ€å¤§çº¿ç¨‹æ•°ä¸º1ï¼Œæ— ç•Œé˜Ÿåˆ—ä¼šå‘ç”Ÿä»€ä¹ˆï¼Ÿ

è¿™æ˜¯ä¸€ä¸ªéå¸¸æœ‰æ„æ€çš„åœºæ™¯ï¼Œè®©æˆ‘ä»¬é€šè¿‡æºç åˆ†ææ¥ç†è§£ï¼š

**åœºæ™¯é…ç½®**ï¼š
```java
ThreadPoolExecutor executor = new ThreadPoolExecutor(
    0,                      // corePoolSize = 0
    1,                      // maximumPoolSize = 1
    60L, TimeUnit.SECONDS,
    new LinkedBlockingQueue<>()  // æ— ç•Œé˜Ÿåˆ—
);
```

**æºç æ‰§è¡Œæµç¨‹åˆ†æ**ï¼š

```java
public void execute(Runnable command) {
    if (command == null)
        throw new NullPointerException();
    
    int c = ctl.get();
    
    // æ­¥éª¤1: workerCountOf(c) = 0, corePoolSize = 0
    // æ¡ä»¶ï¼š0 < 0 ä¸º falseï¼Œä¸ä¼šè¿›å…¥
    if (workerCountOf(c) < corePoolSize) {
        if (addWorker(command, true))
            return;
        c = ctl.get();
    }
    
    // æ­¥éª¤2: å°è¯•å°†ä»»åŠ¡åŠ å…¥é˜Ÿåˆ—
    // æ— ç•Œé˜Ÿåˆ—ï¼Œoffer() æ°¸è¿œè¿”å› true
    if (isRunning(c) && workQueue.offer(command)) {
        int recheck = ctl.get();
        if (!isRunning(recheck) && remove(command))
            reject(command);
        // å…³é”®ç‚¹ï¼šworkerCountOf(recheck) = 0
        // æ¡ä»¶æˆç«‹ï¼Œåˆ›å»ºä¸€ä¸ªWorkeræ¥æ‰§è¡Œé˜Ÿåˆ—ä¸­çš„ä»»åŠ¡
        else if (workerCountOf(recheck) == 0)
            addWorker(null, false);  // â­ æ ¸å¿ƒé€»è¾‘
    }
    
    // æ­¥éª¤3: å› ä¸ºæ— ç•Œé˜Ÿåˆ—ï¼Œæ°¸è¿œä¸ä¼šèµ°åˆ°è¿™é‡Œ
    else if (!addWorker(command, false)) {
        reject(command);
    }
}
```

**æ‰§è¡Œç»“æœ**ï¼š

1. **ç¬¬ä¸€ä¸ªä»»åŠ¡æäº¤**ï¼š
   - ä¸æ»¡è¶³åˆ›å»ºæ ¸å¿ƒçº¿ç¨‹æ¡ä»¶ï¼ˆ0 < 0 ä¸ºfalseï¼‰
   - ä»»åŠ¡æˆåŠŸåŠ å…¥æ— ç•Œé˜Ÿåˆ—
   - æ£€æµ‹åˆ°æ²¡æœ‰å·¥ä½œçº¿ç¨‹ï¼ˆworkerCount = 0ï¼‰
   - **åˆ›å»ºä¸€ä¸ªéæ ¸å¿ƒçº¿ç¨‹**æ‰§è¡Œé˜Ÿåˆ—ä»»åŠ¡ï¼ˆ`addWorker(null, false)`ï¼‰

2. **åç»­ä»»åŠ¡æäº¤**ï¼š
   - ä¸æ»¡è¶³åˆ›å»ºæ ¸å¿ƒçº¿ç¨‹æ¡ä»¶
   - ä»»åŠ¡ç»§ç»­åŠ å…¥æ— ç•Œé˜Ÿåˆ—
   - æ­¤æ—¶å·²æœ‰1ä¸ªå·¥ä½œçº¿ç¨‹ï¼Œä¸å†åˆ›å»ºæ–°çº¿ç¨‹
   - **æ‰€æœ‰ä»»åŠ¡ç”±è¿™å”¯ä¸€çš„çº¿ç¨‹ä¸²è¡Œæ‰§è¡Œ**

**å…³é”®æºç è§£è¯»**ï¼š

```java
// addWorker(null, false) çš„å«ä¹‰
private boolean addWorker(Runnable firstTask, boolean core) {
    // ...
    
    // core = falseï¼Œæ£€æŸ¥æ˜¯å¦è¶…è¿‡ maximumPoolSize
    if (wc >= (core ? corePoolSize : maximumPoolSize))
        return false;
    
    // åˆ›å»ºWorkerï¼ŒfirstTask = null
    // Workerä¼šä»é˜Ÿåˆ—ä¸­å¾ªç¯è·å–ä»»åŠ¡æ‰§è¡Œ
    Worker w = new Worker(firstTask);
    // ...
}
```

**çº¿ç¨‹çš„ç”Ÿå‘½å‘¨æœŸ**ï¼š

```java
private Runnable getTask() {
    boolean timedOut = false;
    
    for (;;) {
        int c = ctl.get();
        int wc = workerCountOf(c);
        
        // å…³é”®ï¼šwc = 1, corePoolSize = 0
        // timed = trueï¼ˆå› ä¸º wc > corePoolSizeï¼‰
        boolean timed = allowCoreThreadTimeOut || wc > corePoolSize;
        
        // å¦‚æœè¶…æ—¶ä¸”é˜Ÿåˆ—ä¸ºç©ºï¼Œçº¿ç¨‹ä¼šé€€å‡º
        if ((wc > maximumPoolSize || (timed && timedOut))
            && (wc > 1 || workQueue.isEmpty())) {
            if (compareAndDecrementWorkerCount(c))
                return null;  // çº¿ç¨‹é€€å‡º
            continue;
        }
        
        try {
            // ä½¿ç”¨ poll(keepAliveTime) è¶…æ—¶ç­‰å¾…
            // 60ç§’å†…æ²¡æœ‰æ–°ä»»åŠ¡ï¼Œçº¿ç¨‹ä¼šé€€å‡º
            Runnable r = timed ?
                workQueue.poll(keepAliveTime, TimeUnit.NANOSECONDS) :
                workQueue.take();
            if (r != null)
                return r;
            timedOut = true;  // æ ‡è®°è¶…æ—¶
        } catch (InterruptedException retry) {
            timedOut = false;
        }
    }
}
```

**è¡Œä¸ºæ€»ç»“**ï¼š

| æ—¶é—´ç‚¹ | çº¿ç¨‹æ•° | é˜Ÿåˆ—ä»»åŠ¡æ•° | è¡Œä¸º |
|--------|--------|-----------|------|
| æäº¤ç¬¬1ä¸ªä»»åŠ¡ | 0 â†’ 1 | 1 | ä»»åŠ¡å…¥é˜Ÿï¼Œåˆ›å»º1ä¸ªçº¿ç¨‹æ‰§è¡Œ |
| æäº¤ç¬¬2-Nä¸ªä»»åŠ¡ | 1 | é€’å¢ | ä»»åŠ¡å…¥é˜Ÿï¼Œç”±å”¯ä¸€çº¿ç¨‹ä¸²è¡Œæ‰§è¡Œ |
| 60ç§’æ— æ–°ä»»åŠ¡ | 1 â†’ 0 | 0 | çº¿ç¨‹è¶…æ—¶é€€å‡º |
| å†æ¬¡æäº¤ä»»åŠ¡ | 0 â†’ 1 | 1 | é‡æ–°åˆ›å»ºçº¿ç¨‹ |

---

### 9.2 newCachedThreadPool çš„æºç åˆ†æ

#### newCachedThreadPool æ˜¯ä¸Šè¿°åœºæ™¯å—ï¼Ÿ

**ç­”æ¡ˆï¼šä¸æ˜¯ï¼** è®©æˆ‘ä»¬çœ‹æºç ï¼š

```java
public static ExecutorService newCachedThreadPool() {
    return new ThreadPoolExecutor(
        0,                          // corePoolSize = 0 âœ“
        Integer.MAX_VALUE,          // maximumPoolSize = æ— é™ âœ—
        60L, TimeUnit.SECONDS,
        new SynchronousQueue<>()    // åŒæ­¥é˜Ÿåˆ—ï¼ˆéæ— ç•Œé˜Ÿåˆ—ï¼‰âœ—
    );
}
```

**å…³é”®åŒºåˆ«**ï¼š

| é…ç½®é¡¹ | ä½ çš„åœºæ™¯ | newCachedThreadPool |
|--------|---------|---------------------|
| corePoolSize | 0 | 0 |
| maximumPoolSize | 1 | Integer.MAX_VALUE |
| é˜Ÿåˆ—ç±»å‹ | æ— ç•Œé˜Ÿåˆ— | SynchronousQueue |

**SynchronousQueue çš„ç‰¹æ€§**ï¼š

```java
// SynchronousQueue æ˜¯ä¸€ä¸ªä¸å­˜å‚¨å…ƒç´ çš„é˜»å¡é˜Ÿåˆ—
// offer() åªæœ‰åœ¨æœ‰çº¿ç¨‹ç­‰å¾…æ¥æ”¶æ—¶æ‰ä¼šæˆåŠŸ
SynchronousQueue<Runnable> queue = new SynchronousQueue<>();

// å¦‚æœæ²¡æœ‰çº¿ç¨‹ç­‰å¾…ï¼Œoffer() ç«‹å³è¿”å› false
boolean success = queue.offer(task);  // é€šå¸¸è¿”å› false
```

**newCachedThreadPool çš„æ‰§è¡Œæµç¨‹**ï¼š

```java
public void execute(Runnable command) {
    int c = ctl.get();
    
    // æ­¥éª¤1: 0 < 0 ä¸º falseï¼Œä¸åˆ›å»ºæ ¸å¿ƒçº¿ç¨‹
    if (workerCountOf(c) < corePoolSize) {
        if (addWorker(command, true))
            return;
        c = ctl.get();
    }
    
    // æ­¥éª¤2: å°è¯•å°†ä»»åŠ¡åŠ å…¥ SynchronousQueue
    // å¦‚æœæ²¡æœ‰ç©ºé—²çº¿ç¨‹ç­‰å¾…ï¼Œoffer() è¿”å› false
    if (isRunning(c) && workQueue.offer(command)) {
        // é€šå¸¸ä¸ä¼šè¿›å…¥è¿™é‡Œ
        int recheck = ctl.get();
        if (!isRunning(recheck) && remove(command))
            reject(command);
        else if (workerCountOf(recheck) == 0)
            addWorker(null, false);
    }
    // æ­¥éª¤3: offer() å¤±è´¥ï¼Œåˆ›å»ºæ–°çº¿ç¨‹
    // å› ä¸º maximumPoolSize = Integer.MAX_VALUEï¼Œå‡ ä¹æ€»èƒ½åˆ›å»ºæˆåŠŸ
    else if (!addWorker(command, false)) {
        reject(command);
    }
}
```

**newCachedThreadPool çš„è¡Œä¸º**ï¼š

1. **æœ‰ç©ºé—²çº¿ç¨‹**ï¼š
   - ç©ºé—²çº¿ç¨‹åœ¨ `SynchronousQueue.poll()` ç­‰å¾…
   - æ–°ä»»åŠ¡çš„ `offer()` æˆåŠŸï¼Œç›´æ¥äº¤ç»™ç©ºé—²çº¿ç¨‹

2. **æ— ç©ºé—²çº¿ç¨‹**ï¼š
   - `offer()` å¤±è´¥ï¼ˆSynchronousQueue ä¸å­˜å‚¨ï¼‰
   - **ç«‹å³åˆ›å»ºæ–°çº¿ç¨‹**æ‰§è¡Œä»»åŠ¡
   - å¯èƒ½åˆ›å»ºå¤§é‡çº¿ç¨‹ï¼ˆæœ€å¤š Integer.MAX_VALUEï¼‰

3. **çº¿ç¨‹å›æ”¶**ï¼š
   - çº¿ç¨‹ç©ºé—²60ç§’åè‡ªåŠ¨é€€å‡º

**å¯¹æ¯”æ€»ç»“**ï¼š

```java
// åœºæ™¯1ï¼šæ ¸å¿ƒçº¿ç¨‹æ•°0 + æœ€å¤§çº¿ç¨‹æ•°1 + æ— ç•Œé˜Ÿåˆ—
// è¡Œä¸ºï¼šæœ€å¤š1ä¸ªçº¿ç¨‹ï¼Œä»»åŠ¡ä¸²è¡Œæ‰§è¡Œï¼Œé˜Ÿåˆ—å¯èƒ½æ— é™å¢é•¿
ThreadPoolExecutor executor1 = new ThreadPoolExecutor(
    0, 1, 60L, TimeUnit.SECONDS,
    new LinkedBlockingQueue<>()
);

// åœºæ™¯2ï¼šnewCachedThreadPool
// è¡Œä¸ºï¼šçº¿ç¨‹æ•°åŠ¨æ€å¢é•¿ï¼Œä»»åŠ¡å¹¶å‘æ‰§è¡Œï¼Œå¯èƒ½åˆ›å»ºå¤§é‡çº¿ç¨‹
ExecutorService executor2 = Executors.newCachedThreadPool();
```

**é£é™©å¯¹æ¯”**ï¼š

| åœºæ™¯ | é£é™© | åŸå›  |
|------|------|------|
| æ ¸å¿ƒ0+æœ€å¤§1+æ— ç•Œé˜Ÿåˆ— | **é˜Ÿåˆ—OOM** | ä»»åŠ¡å †ç§¯åœ¨é˜Ÿåˆ—ä¸­ |
| newCachedThreadPool | **çº¿ç¨‹OOM** | åˆ›å»ºå¤§é‡çº¿ç¨‹ |

---

### 9.3 æ ¸å¿ƒçº¿ç¨‹æ•°ä¸º0çš„è®¾è®¡è€ƒé‡

#### ä¸ºä»€ä¹ˆå…è®¸æ ¸å¿ƒçº¿ç¨‹æ•°ä¸º0ï¼Ÿ

**æºç ä¸­çš„ä¿æŠ¤æœºåˆ¶**ï¼š

```java
// execute() æ–¹æ³•ä¸­çš„ä¿æŠ¤é€»è¾‘
if (isRunning(c) && workQueue.offer(command)) {
    int recheck = ctl.get();
    if (!isRunning(recheck) && remove(command))
        reject(command);
    // â­ å…³é”®ä¿æŠ¤ï¼šå¦‚æœæ²¡æœ‰å·¥ä½œçº¿ç¨‹ï¼Œåˆ›å»ºä¸€ä¸ª
    else if (workerCountOf(recheck) == 0)
        addWorker(null, false);
}
```

**è®¾è®¡æ„å›¾**ï¼š

1. **å»¶è¿Ÿåˆ›å»ºçº¿ç¨‹**ï¼š
   - ä¸ç«‹å³åˆ›å»ºçº¿ç¨‹ï¼ŒèŠ‚çœèµ„æº
   - æœ‰ä»»åŠ¡æ—¶æ‰åˆ›å»º

2. **åŠ¨æ€ä¼¸ç¼©**ï¼š
   - æ ¹æ®è´Ÿè½½åŠ¨æ€è°ƒæ•´çº¿ç¨‹æ•°
   - ç©ºé—²æ—¶è‡ªåŠ¨å›æ”¶

3. **é˜²æ­¢ä»»åŠ¡é¥¿æ­»**ï¼š
   - å³ä½¿æ ¸å¿ƒçº¿ç¨‹æ•°ä¸º0ï¼Œä¹Ÿä¼šåˆ›å»ºè‡³å°‘1ä¸ªçº¿ç¨‹
   - ä¿è¯é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡èƒ½è¢«æ‰§è¡Œ

**é€‚ç”¨åœºæ™¯**ï¼š

```java
// åœºæ™¯1ï¼šé—´æ­‡æ€§ä»»åŠ¡
// å¤§éƒ¨åˆ†æ—¶é—´ç©ºé—²ï¼Œå¶å°”æœ‰ä»»åŠ¡
ThreadPoolExecutor executor = new ThreadPoolExecutor(
    0, 10, 60L, TimeUnit.SECONDS,
    new LinkedBlockingQueue<>(100)
);

// åœºæ™¯2ï¼šç¼“å­˜çº¿ç¨‹æ± 
// ä»»åŠ¡é‡ä¸å¯é¢„æµ‹ï¼Œéœ€è¦å¿«é€Ÿå“åº”
ExecutorService executor = Executors.newCachedThreadPool();
```

**æ³¨æ„äº‹é¡¹**ï¼š

1. **å¿…é¡»è®¾ç½®åˆç†çš„ maximumPoolSize**
2. **å¿…é¡»è®¾ç½®æœ‰ç•Œé˜Ÿåˆ—æˆ–ä½¿ç”¨ SynchronousQueue**
3. **å¿…é¡»è®¾ç½®åˆç†çš„ keepAliveTime**

---

## 10. æ ¸å¿ƒé—®é¢˜æ€»ç»“

### Q1: ctlä¸ºä»€ä¹ˆç”¨ä¸€ä¸ªAtomicIntegerï¼Ÿ
**A**: ä¿è¯çŠ¶æ€å’Œçº¿ç¨‹æ•°çš„åŸå­æ€§æ›´æ–°ï¼Œæé«˜æ€§èƒ½ã€‚

### Q2: Workerä¸ºä»€ä¹ˆç»§æ‰¿AQSï¼Ÿ
**A**: å®ç°ä¸å¯é‡å…¥é”ï¼ŒåŒºåˆ†ç©ºé—²å’Œæ‰§è¡Œä¸­çš„Workerã€‚

### Q3: ä¸ºä»€ä¹ˆéœ€è¦åŒé‡æ£€æŸ¥ï¼Ÿ
**A**: é˜²æ­¢çº¿ç¨‹æ± çŠ¶æ€åœ¨æ“ä½œè¿‡ç¨‹ä¸­æ”¹å˜ã€‚

### Q4: æ ¸å¿ƒçº¿ç¨‹ä¸ºä»€ä¹ˆä¸ä¼šé€€å‡ºï¼Ÿ
**A**: ä½¿ç”¨`take()`é˜»å¡ç­‰å¾…ï¼Œä¸ä¼šè¶…æ—¶ã€‚

### Q5: shutdown()å¦‚ä½•ä¿è¯ä¸ä¸­æ–­æ‰§è¡Œä¸­çš„ä»»åŠ¡ï¼Ÿ
**A**: ä½¿ç”¨`tryLock()`ï¼Œåªä¸­æ–­ç©ºé—²çš„Workerã€‚

### Q6: æ ¸å¿ƒçº¿ç¨‹æ•°ä¸º0æ—¶ï¼Œä»»åŠ¡å¦‚ä½•è¢«æ‰§è¡Œï¼Ÿ
**A**: ä»»åŠ¡å…¥é˜Ÿåï¼Œæ£€æµ‹åˆ°workerCount=0ï¼Œä¼šè°ƒç”¨`addWorker(null, false)`åˆ›å»ºä¸€ä¸ªéæ ¸å¿ƒçº¿ç¨‹æ‰§è¡Œé˜Ÿåˆ—ä»»åŠ¡ã€‚

### Q7: newCachedThreadPool ä¸ºä»€ä¹ˆèƒ½å¿«é€Ÿå“åº”ï¼Ÿ
**A**: ä½¿ç”¨`SynchronousQueue`ï¼Œæ— ç©ºé—²çº¿ç¨‹æ—¶`offer()`å¤±è´¥ï¼Œç«‹å³åˆ›å»ºæ–°çº¿ç¨‹ï¼Œé¿å…ä»»åŠ¡ç­‰å¾…ã€‚

### Q8: æ ¸å¿ƒçº¿ç¨‹æ•°0 + æ— ç•Œé˜Ÿåˆ—æœ‰ä»€ä¹ˆé£é™©ï¼Ÿ
**A**: åªä¼šåˆ›å»º1ä¸ªçº¿ç¨‹ä¸²è¡Œæ‰§è¡Œï¼Œä»»åŠ¡ä¼šå †ç§¯åœ¨é˜Ÿåˆ—ä¸­ï¼Œå¯èƒ½å¯¼è‡´OOMã€‚

---

## ä¸‹ä¸€ç« é¢„å‘Š

ä¸‹ä¸€ç« æˆ‘ä»¬å°†ï¼š

- **å®ç°ä¸€ä¸ªç®€æ˜“ç‰ˆçº¿ç¨‹æ± **
- **ç†è§£çº¿ç¨‹æ± çš„æ ¸å¿ƒé€»è¾‘**
- **æŒæ¡çº¿ç¨‹æ± çš„è®¾è®¡æ€æƒ³**

è®©æˆ‘ä»¬ç»§ç»­æ·±å…¥ï¼ğŸš€
