# ç¬¬äºŒç« ï¼šçº¿ç¨‹æ± çš„å·¥ä½œåŸç†

## å¼•è¨€

åœ¨ä¸Šä¸€ç« ä¸­ï¼Œæˆ‘ä»¬ç†è§£äº†ä¸ºä»€ä¹ˆéœ€è¦çº¿ç¨‹æ± ã€‚ç°åœ¨è®©æˆ‘ä»¬æ·±å…¥æ¢è®¨ï¼š**çº¿ç¨‹æ± æ˜¯å¦‚ä½•å·¥ä½œçš„ï¼Ÿ**

æœ¬ç« å°†é€šè¿‡æµç¨‹å›¾å’Œæºç åˆ†æï¼Œæ­ç¤ºçº¿ç¨‹æ± çš„å†…éƒ¨æœºåˆ¶ã€‚

---

## 1. çº¿ç¨‹æ± çš„æ ¸å¿ƒç»„ä»¶

### 1.1 é—®é¢˜1ï¼šçº¿ç¨‹æ± ç”±å“ªäº›éƒ¨åˆ†ç»„æˆï¼Ÿ

**ç±»æ¯”**ï¼šæŠŠçº¿ç¨‹æ± æƒ³è±¡æˆä¸€ä¸ªé¤å…

```
é¤å…ï¼ˆçº¿ç¨‹æ± ï¼‰
â”œâ”€â”€ æœåŠ¡å‘˜ï¼ˆWorkerçº¿ç¨‹ï¼‰
â”œâ”€â”€ ç‚¹é¤å•ï¼ˆä»»åŠ¡é˜Ÿåˆ— BlockingQueueï¼‰
â”œâ”€â”€ å¨æˆ¿è§„åˆ™ï¼ˆæ‹’ç»ç­–ç•¥ RejectedExecutionHandlerï¼‰
â”œâ”€â”€ ç»ç†ï¼ˆçº¿ç¨‹æ± ç®¡ç†å™¨ ThreadPoolExecutorï¼‰
â””â”€â”€ èœå•ï¼ˆä»»åŠ¡ Runnable/Callableï¼‰
```

**çº¿ç¨‹æ± çš„æ ¸å¿ƒç»„ä»¶**ï¼š

```java
public class ThreadPoolExecutor extends AbstractExecutorService {
    
    // 1. çº¿ç¨‹æ± çŠ¶æ€å’Œçº¿ç¨‹æ•°é‡ï¼ˆç”¨ä¸€ä¸ªAtomicIntegerè¡¨ç¤ºï¼‰
    private final AtomicInteger ctl = new AtomicInteger(ctlOf(RUNNING, 0));
    
    // 2. ä»»åŠ¡é˜Ÿåˆ—
    private final BlockingQueue<Runnable> workQueue;
    
    // 3. å·¥ä½œçº¿ç¨‹é›†åˆ
    private final HashSet<Worker> workers = new HashSet<Worker>();
    
    // 4. çº¿ç¨‹å·¥å‚
    private volatile ThreadFactory threadFactory;
    
    // 5. æ‹’ç»ç­–ç•¥
    private volatile RejectedExecutionHandler handler;
    
    // 6. æ ¸å¿ƒå‚æ•°
    private volatile int corePoolSize;        // æ ¸å¿ƒçº¿ç¨‹æ•°
    private volatile int maximumPoolSize;     // æœ€å¤§çº¿ç¨‹æ•°
    private volatile long keepAliveTime;      // ç©ºé—²çº¿ç¨‹å­˜æ´»æ—¶é—´
}
```

---

### 1.2 é—®é¢˜2ï¼šè¿™äº›ç»„ä»¶å¦‚ä½•åä½œï¼Ÿ

**æ•´ä½“æ¶æ„å›¾**ï¼š

```
                    æäº¤ä»»åŠ¡
                      â†“
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚ ThreadPoolExecutor â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â†“
            åˆ¤æ–­ï¼šå½“å‰çº¿ç¨‹æ•° < æ ¸å¿ƒçº¿ç¨‹æ•°ï¼Ÿ
                      â†“
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
           æ˜¯                    å¦
            â†“                    â†“
      åˆ›å»ºæ ¸å¿ƒçº¿ç¨‹          ä»»åŠ¡åŠ å…¥é˜Ÿåˆ—
            â†“                    â†“
      ç›´æ¥æ‰§è¡Œä»»åŠ¡          é˜Ÿåˆ—å·²æ»¡ï¼Ÿ
                                â†“
                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”
                       å¦                æ˜¯
                        â†“                â†“
                    ç­‰å¾…æ‰§è¡Œ        çº¿ç¨‹æ•° < æœ€å¤§çº¿ç¨‹æ•°ï¼Ÿ
                                        â†“
                                â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”
                               æ˜¯                å¦
                                â†“                â†“
                          åˆ›å»ºä¸´æ—¶çº¿ç¨‹      æ‰§è¡Œæ‹’ç»ç­–ç•¥
                                â†“
                          æ‰§è¡Œä»»åŠ¡
```

---

## 2. çº¿ç¨‹æ± çš„å·¥ä½œæµç¨‹

### 2.1 é—®é¢˜3ï¼šä»»åŠ¡æäº¤åå‘ç”Ÿäº†ä»€ä¹ˆï¼Ÿ

**å®Œæ•´æµç¨‹å›¾**ï¼š

```
[ç”¨æˆ·æäº¤ä»»åŠ¡]
      â†“
executor.execute(task)
      â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ­¥éª¤1: æ£€æŸ¥çº¿ç¨‹æ± çŠ¶æ€                â”‚
â”‚ if (çº¿ç¨‹æ± å·²å…³é—­) â†’ æ‹’ç»ä»»åŠ¡         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ­¥éª¤2: åˆ¤æ–­æ ¸å¿ƒçº¿ç¨‹æ•°                â”‚
â”‚ if (å½“å‰çº¿ç¨‹æ•° < corePoolSize)       â”‚
â”‚    â†’ åˆ›å»ºæ ¸å¿ƒçº¿ç¨‹å¹¶æ‰§è¡Œä»»åŠ¡          â”‚
â”‚    â†’ ç»“æŸ                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ­¥éª¤3: å°è¯•åŠ å…¥é˜Ÿåˆ—                  â”‚
â”‚ if (é˜Ÿåˆ—æœªæ»¡)                        â”‚
â”‚    â†’ ä»»åŠ¡åŠ å…¥workQueue               â”‚
â”‚    â†’ ç­‰å¾…çº¿ç¨‹ä»é˜Ÿåˆ—è·å–              â”‚
â”‚    â†’ ç»“æŸ                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ­¥éª¤4: åˆ¤æ–­æœ€å¤§çº¿ç¨‹æ•°                â”‚
â”‚ if (å½“å‰çº¿ç¨‹æ•° < maximumPoolSize)    â”‚
â”‚    â†’ åˆ›å»ºä¸´æ—¶çº¿ç¨‹å¹¶æ‰§è¡Œä»»åŠ¡          â”‚
â”‚    â†’ ç»“æŸ                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ­¥éª¤5: æ‰§è¡Œæ‹’ç»ç­–ç•¥                  â”‚
â”‚ handler.rejectedExecution(task)      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**æºç å®ç°**ï¼š

```java
public void execute(Runnable command) {
    if (command == null)
        throw new NullPointerException();
    
    int c = ctl.get();
    
    // æ­¥éª¤1: å¦‚æœå½“å‰çº¿ç¨‹æ•° < æ ¸å¿ƒçº¿ç¨‹æ•°ï¼Œåˆ›å»ºæ ¸å¿ƒçº¿ç¨‹
    if (workerCountOf(c) < corePoolSize) {
        if (addWorker(command, true))  // trueè¡¨ç¤ºæ ¸å¿ƒçº¿ç¨‹
            return;
        c = ctl.get();
    }
    
    // æ­¥éª¤2: å°è¯•å°†ä»»åŠ¡åŠ å…¥é˜Ÿåˆ—
    if (isRunning(c) && workQueue.offer(command)) {
        int recheck = ctl.get();
        // åŒé‡æ£€æŸ¥ï¼šå¦‚æœçº¿ç¨‹æ± å·²å…³é—­ï¼Œç§»é™¤ä»»åŠ¡å¹¶æ‹’ç»
        if (!isRunning(recheck) && remove(command))
            reject(command);
        // å¦‚æœæ²¡æœ‰å·¥ä½œçº¿ç¨‹ï¼Œåˆ›å»ºä¸€ä¸ª
        else if (workerCountOf(recheck) == 0)
            addWorker(null, false);
    }
    // æ­¥éª¤3: é˜Ÿåˆ—æ»¡äº†ï¼Œå°è¯•åˆ›å»ºä¸´æ—¶çº¿ç¨‹
    else if (!addWorker(command, false)) {  // falseè¡¨ç¤ºéæ ¸å¿ƒçº¿ç¨‹
        // æ­¥éª¤4: æ— æ³•åˆ›å»ºçº¿ç¨‹ï¼Œæ‰§è¡Œæ‹’ç»ç­–ç•¥
        reject(command);
    }
}
```

---

### 2.2 é—®é¢˜4ï¼šWorkerçº¿ç¨‹æ˜¯å¦‚ä½•å·¥ä½œçš„ï¼Ÿ

**Workerçº¿ç¨‹çš„ç”Ÿå‘½å‘¨æœŸ**ï¼š

```
[Workeråˆ›å»º]
      â†“
å¯åŠ¨çº¿ç¨‹ï¼šworker.thread.start()
      â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ runWorker(Worker w)                  â”‚
â”‚                                      â”‚
â”‚ while (true) {                       â”‚
â”‚   1. æ‰§è¡ŒfirstTaskï¼ˆå¦‚æœæœ‰ï¼‰         â”‚
â”‚   2. ä»é˜Ÿåˆ—è·å–ä»»åŠ¡ï¼š                â”‚
â”‚      task = workQueue.take()         â”‚
â”‚   3. æ‰§è¡Œä»»åŠ¡ï¼š                      â”‚
â”‚      task.run()                      â”‚
â”‚   4. ä»»åŠ¡å®Œæˆï¼Œç»§ç»­å¾ªç¯              â”‚
â”‚ }                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â†“
é˜Ÿåˆ—ä¸ºç©º && è¶…è¿‡keepAliveTime
      â†“
[Workeré€€å‡º]
```

**æºç å®ç°**ï¼š

```java
private final class Worker extends AbstractQueuedSynchronizer 
    implements Runnable {
    
    final Thread thread;        // WorkeræŒæœ‰çš„çº¿ç¨‹
    Runnable firstTask;         // ç¬¬ä¸€ä¸ªä»»åŠ¡
    volatile long completedTasks; // å®Œæˆçš„ä»»åŠ¡æ•°
    
    Worker(Runnable firstTask) {
        setState(-1); // ç¦æ­¢ä¸­æ–­ï¼Œç›´åˆ°runWorker
        this.firstTask = firstTask;
        this.thread = getThreadFactory().newThread(this);
    }
    
    public void run() {
        runWorker(this);
    }
}

final void runWorker(Worker w) {
    Thread wt = Thread.currentThread();
    Runnable task = w.firstTask;
    w.firstTask = null;
    w.unlock(); // å…è®¸ä¸­æ–­
    
    boolean completedAbruptly = true;
    try {
        // æ ¸å¿ƒå¾ªç¯ï¼šä¸æ–­ä»é˜Ÿåˆ—è·å–ä»»åŠ¡
        while (task != null || (task = getTask()) != null) {
            w.lock();
            
            // æ£€æŸ¥çº¿ç¨‹æ± çŠ¶æ€
            if ((runStateAtLeast(ctl.get(), STOP) ||
                 (Thread.interrupted() &&
                  runStateAtLeast(ctl.get(), STOP))) &&
                !wt.isInterrupted())
                wt.interrupt();
            
            try {
                beforeExecute(wt, task);  // é’©å­æ–¹æ³•
                Throwable thrown = null;
                try {
                    task.run();  // æ‰§è¡Œä»»åŠ¡
                } catch (RuntimeException x) {
                    thrown = x; throw x;
                } catch (Error x) {
                    thrown = x; throw x;
                } catch (Throwable x) {
                    thrown = x; throw new Error(x);
                } finally {
                    afterExecute(task, thrown);  // é’©å­æ–¹æ³•
                }
            } finally {
                task = null;
                w.completedTasks++;
                w.unlock();
            }
        }
        completedAbruptly = false;
    } finally {
        processWorkerExit(w, completedAbruptly);  // Workeré€€å‡ºå¤„ç†
    }
}
```

---

### 2.3 é—®é¢˜5ï¼šWorkerå¦‚ä½•ä»é˜Ÿåˆ—è·å–ä»»åŠ¡ï¼Ÿ

**getTask()æ–¹æ³•çš„é€»è¾‘**ï¼š

```
getTask()
    â†“
æ£€æŸ¥çº¿ç¨‹æ± çŠ¶æ€
    â†“
åˆ¤æ–­ï¼šå½“å‰çº¿ç¨‹æ˜¯å¦åº”è¯¥é€€å‡ºï¼Ÿ
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ é€€å‡ºæ¡ä»¶ï¼š                          â”‚
â”‚ 1. çº¿ç¨‹æ± å·²å…³é—­                     â”‚
â”‚ 2. çº¿ç¨‹æ•° > maximumPoolSize         â”‚
â”‚ 3. çº¿ç¨‹æ•° > corePoolSize            â”‚
â”‚    && é˜Ÿåˆ—ä¸ºç©º                      â”‚
â”‚    && è¶…è¿‡keepAliveTime             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
åº”è¯¥é€€å‡ºï¼Ÿ
    â†“
â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”
æ˜¯         å¦
â†“          â†“
è¿”å›null   ä»é˜Ÿåˆ—è·å–ä»»åŠ¡
â†“          â†“
Workeré€€å‡º  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
           â”‚ æ ¸å¿ƒçº¿ç¨‹ï¼š           â”‚
           â”‚   workQueue.take()   â”‚
           â”‚   (é˜»å¡ç­‰å¾…)         â”‚
           â”‚                      â”‚
           â”‚ éæ ¸å¿ƒçº¿ç¨‹ï¼š         â”‚
           â”‚   workQueue.poll(    â”‚
           â”‚     keepAliveTime,   â”‚
           â”‚     TimeUnit)        â”‚
           â”‚   (è¶…æ—¶ç­‰å¾…)         â”‚
           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**æºç å®ç°**ï¼š

```java
private Runnable getTask() {
    boolean timedOut = false;
    
    for (;;) {
        int c = ctl.get();
        int rs = runStateOf(c);
        
        // æ£€æŸ¥çº¿ç¨‹æ± çŠ¶æ€
        if (rs >= SHUTDOWN && (rs >= STOP || workQueue.isEmpty())) {
            decrementWorkerCount();
            return null;
        }
        
        int wc = workerCountOf(c);
        
        // åˆ¤æ–­æ˜¯å¦éœ€è¦è¶…æ—¶æ§åˆ¶
        boolean timed = allowCoreThreadTimeOut || wc > corePoolSize;
        
        // åˆ¤æ–­æ˜¯å¦åº”è¯¥é€€å‡º
        if ((wc > maximumPoolSize || (timed && timedOut))
            && (wc > 1 || workQueue.isEmpty())) {
            if (compareAndDecrementWorkerCount(c))
                return null;
            continue;
        }
        
        try {
            // æ ¸å¿ƒçº¿ç¨‹ï¼šé˜»å¡ç­‰å¾…
            // éæ ¸å¿ƒçº¿ç¨‹ï¼šè¶…æ—¶ç­‰å¾…
            Runnable r = timed ?
                workQueue.poll(keepAliveTime, TimeUnit.NANOSECONDS) :
                workQueue.take();
            if (r != null)
                return r;
            timedOut = true;
        } catch (InterruptedException retry) {
            timedOut = false;
        }
    }
}
```

---

## 3. çº¿ç¨‹æ± çš„çŠ¶æ€ç®¡ç†

### 3.1 é—®é¢˜6ï¼šçº¿ç¨‹æ± æœ‰å“ªäº›çŠ¶æ€ï¼Ÿ

**çº¿ç¨‹æ± çš„5ç§çŠ¶æ€**ï¼š

```
RUNNING â†’ SHUTDOWN â†’ STOP â†’ TIDYING â†’ TERMINATED
```

**çŠ¶æ€è½¬æ¢å›¾**ï¼š

```
        shutdown()
RUNNING â”€â”€â”€â”€â”€â”€â”€â”€â†’ SHUTDOWN
   â”‚                  â”‚
   â”‚ shutdownNow()    â”‚ é˜Ÿåˆ—ä¸ºç©º && çº¿ç¨‹æ•°ä¸º0
   â†“                  â†“
  STOP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ TIDYING â”€â”€â”€â”€â”€â”€â”€â”€â†’ TERMINATED
                      â†‘
                      â”‚
                  æ‰§è¡Œterminated()
```

**çŠ¶æ€è¯¦è§£**ï¼š

| çŠ¶æ€ | å€¼ | è¯´æ˜ | æ¥å—æ–°ä»»åŠ¡ | å¤„ç†é˜Ÿåˆ—ä»»åŠ¡ |
|------|---|------|-----------|------------|
| **RUNNING** | -1 | è¿è¡ŒçŠ¶æ€ | âœ… | âœ… |
| **SHUTDOWN** | 0 | å…³é—­çŠ¶æ€ | âŒ | âœ… |
| **STOP** | 1 | åœæ­¢çŠ¶æ€ | âŒ | âŒ |
| **TIDYING** | 2 | æ•´ç†çŠ¶æ€ | âŒ | âŒ |
| **TERMINATED** | 3 | ç»ˆæ­¢çŠ¶æ€ | âŒ | âŒ |

**æºç å®ç°**ï¼š

```java
// ä½¿ç”¨é«˜3ä½è¡¨ç¤ºçŠ¶æ€ï¼Œä½29ä½è¡¨ç¤ºçº¿ç¨‹æ•°
private final AtomicInteger ctl = new AtomicInteger(ctlOf(RUNNING, 0));
private static final int COUNT_BITS = Integer.SIZE - 3;  // 29
private static final int CAPACITY   = (1 << COUNT_BITS) - 1;  // æœ€å¤§çº¿ç¨‹æ•°

// çŠ¶æ€å€¼ï¼ˆå­˜å‚¨åœ¨é«˜3ä½ï¼‰
private static final int RUNNING    = -1 << COUNT_BITS;  // 111...
private static final int SHUTDOWN   =  0 << COUNT_BITS;  // 000...
private static final int STOP       =  1 << COUNT_BITS;  // 001...
private static final int TIDYING    =  2 << COUNT_BITS;  // 010...
private static final int TERMINATED =  3 << COUNT_BITS;  // 011...

// è·å–çŠ¶æ€
private static int runStateOf(int c)     { return c & ~CAPACITY; }
// è·å–çº¿ç¨‹æ•°
private static int workerCountOf(int c)  { return c & CAPACITY; }
// ç»„åˆçŠ¶æ€å’Œçº¿ç¨‹æ•°
private static int ctlOf(int rs, int wc) { return rs | wc; }
```

**ä¸ºä»€ä¹ˆç”¨ä¸€ä¸ªAtomicIntegerè¡¨ç¤ºä¸¤ä¸ªå€¼ï¼Ÿ**

- âœ… **åŸå­æ€§**ï¼šçŠ¶æ€å’Œçº¿ç¨‹æ•°å¿…é¡»åŒæ—¶æ›´æ–°
- âœ… **æ€§èƒ½**ï¼šä¸€æ¬¡CASæ“ä½œå®Œæˆä¸¤ä¸ªå€¼çš„æ›´æ–°
- âœ… **èŠ‚çœç©ºé—´**ï¼šåªéœ€è¦ä¸€ä¸ªå˜é‡

---

### 3.2 é—®é¢˜7ï¼šå¦‚ä½•ä¼˜é›…åœ°å…³é—­çº¿ç¨‹æ± ï¼Ÿ

**ä¸¤ç§å…³é—­æ–¹å¼**ï¼š

```java
// æ–¹å¼1: shutdown() - æ¸©æŸ”å…³é—­
executor.shutdown();
// - ä¸å†æ¥å—æ–°ä»»åŠ¡
// - ç­‰å¾…é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡æ‰§è¡Œå®Œ
// - ç­‰å¾…æ­£åœ¨æ‰§è¡Œçš„ä»»åŠ¡å®Œæˆ

// æ–¹å¼2: shutdownNow() - å¼ºåˆ¶å…³é—­
List<Runnable> notExecuted = executor.shutdownNow();
// - ä¸å†æ¥å—æ–°ä»»åŠ¡
// - æ¸…ç©ºé˜Ÿåˆ—ï¼Œè¿”å›æœªæ‰§è¡Œçš„ä»»åŠ¡
// - ä¸­æ–­æ­£åœ¨æ‰§è¡Œçš„ä»»åŠ¡
```

**å…³é—­æµç¨‹å›¾**ï¼š

```
shutdown()
    â†“
è®¾ç½®çŠ¶æ€ä¸ºSHUTDOWN
    â†“
ä¸­æ–­ç©ºé—²Worker
    â†“
ç­‰å¾…æ‰€æœ‰ä»»åŠ¡å®Œæˆ
    â†“
è®¾ç½®çŠ¶æ€ä¸ºTIDYING
    â†“
è°ƒç”¨terminated()é’©å­
    â†“
è®¾ç½®çŠ¶æ€ä¸ºTERMINATED
    â†“
é€šçŸ¥awaitTermination()çš„çº¿ç¨‹
```

**æºç å®ç°**ï¼š

```java
public void shutdown() {
    final ReentrantLock mainLock = this.mainLock;
    mainLock.lock();
    try {
        checkShutdownAccess();
        advanceRunState(SHUTDOWN);  // è®¾ç½®çŠ¶æ€
        interruptIdleWorkers();     // ä¸­æ–­ç©ºé—²Worker
        onShutdown();               // é’©å­æ–¹æ³•
    } finally {
        mainLock.unlock();
    }
    tryTerminate();
}

public List<Runnable> shutdownNow() {
    List<Runnable> tasks;
    final ReentrantLock mainLock = this.mainLock;
    mainLock.lock();
    try {
        checkShutdownAccess();
        advanceRunState(STOP);      // è®¾ç½®çŠ¶æ€
        interruptWorkers();         // ä¸­æ–­æ‰€æœ‰Worker
        tasks = drainQueue();       // æ¸…ç©ºé˜Ÿåˆ—
    } finally {
        mainLock.unlock();
    }
    tryTerminate();
    return tasks;
}
```

---

## 4. ä»»åŠ¡é˜Ÿåˆ—è¯¦è§£

### 4.1 é—®é¢˜8ï¼šä¸ºä»€ä¹ˆä½¿ç”¨BlockingQueueï¼Ÿ

**BlockingQueueçš„ç‰¹æ€§**ï¼š

```
ç”Ÿäº§è€…-æ¶ˆè´¹è€…æ¨¡å¼

ç”Ÿäº§è€…ï¼ˆæäº¤ä»»åŠ¡çš„çº¿ç¨‹ï¼‰
    â†“
workQueue.offer(task)  â† éé˜»å¡/é˜»å¡
    â†“
[BlockingQueue]
    â†“
workQueue.take()       â† é˜»å¡ç­‰å¾…
    â†“
æ¶ˆè´¹è€…ï¼ˆWorkerçº¿ç¨‹ï¼‰
```

**ä¼˜åŠ¿**ï¼š
- âœ… **çº¿ç¨‹å®‰å…¨**ï¼šå†…éƒ¨ä½¿ç”¨é”ä¿è¯å¹¶å‘å®‰å…¨
- âœ… **é˜»å¡ç­‰å¾…**ï¼šWorkerçº¿ç¨‹è‡ªåŠ¨ç­‰å¾…ï¼Œæ— éœ€è½®è¯¢
- âœ… **å¤šç§å®ç°**ï¼šé€‚åº”ä¸åŒåœºæ™¯

---

### 4.2 é—®é¢˜9ï¼šæœ‰å“ªäº›é˜Ÿåˆ—å®ç°ï¼Ÿ

**å¸¸ç”¨é˜Ÿåˆ—å¯¹æ¯”**ï¼š

| é˜Ÿåˆ—ç±»å‹ | å®¹é‡ | ç‰¹ç‚¹ | é€‚ç”¨åœºæ™¯ |
|---------|------|------|---------|
| **ArrayBlockingQueue** | æœ‰ç•Œ | æ•°ç»„å®ç°ï¼ŒFIFO | èµ„æºæœ‰é™ |
| **LinkedBlockingQueue** | å¯é€‰æœ‰ç•Œ | é“¾è¡¨å®ç°ï¼ŒFIFO | ä¸€èˆ¬åœºæ™¯ |
| **SynchronousQueue** | 0 | ç›´æ¥ä¼ é€’ï¼Œæ— å­˜å‚¨ | å¿«é€Ÿå“åº” |
| **PriorityBlockingQueue** | æ— ç•Œ | ä¼˜å…ˆçº§é˜Ÿåˆ— | ä»»åŠ¡æœ‰ä¼˜å…ˆçº§ |
| **DelayQueue** | æ— ç•Œ | å»¶è¿Ÿé˜Ÿåˆ— | å®šæ—¶ä»»åŠ¡ |

**é˜Ÿåˆ—é€‰æ‹©æµç¨‹å›¾**ï¼š

```
éœ€è¦ä»»åŠ¡æ’åºï¼Ÿ
    â†“
â”Œâ”€â”€â”€æ˜¯â”€â”€â”€â”
â”‚        å¦
â†“        â†“
ä¼˜å…ˆçº§ï¼Ÿ  éœ€è¦ç¼“å­˜ä»»åŠ¡ï¼Ÿ
â†“        â†“
Priority â”Œâ”€â”€â”€æ˜¯â”€â”€â”€â”
Queue    â”‚        å¦
         â†“        â†“
      æœ‰ç•Œé˜Ÿåˆ—   ç›´æ¥ä¼ é€’
         â†“        â†“
      Array/     Synchronous
      Linked     Queue
      Blocking
      Queue
```

**ç¤ºä¾‹**ï¼š

```java
// 1. æœ‰ç•Œé˜Ÿåˆ—ï¼šé˜²æ­¢å†…å­˜æº¢å‡º
BlockingQueue<Runnable> queue = new ArrayBlockingQueue<>(100);
ThreadPoolExecutor executor = new ThreadPoolExecutor(
    5, 10, 60L, TimeUnit.SECONDS, queue
);

// 2. æ— ç•Œé˜Ÿåˆ—ï¼šmaximumPoolSizeæ— æ•ˆ
BlockingQueue<Runnable> queue = new LinkedBlockingQueue<>();
ThreadPoolExecutor executor = new ThreadPoolExecutor(
    5, 10, 60L, TimeUnit.SECONDS, queue
);
// æ³¨æ„ï¼šçº¿ç¨‹æ•°æ°¸è¿œä¸ä¼šè¶…è¿‡corePoolSizeï¼

// 3. ç›´æ¥ä¼ é€’ï¼šå¿«é€Ÿå“åº”
BlockingQueue<Runnable> queue = new SynchronousQueue<>();
ThreadPoolExecutor executor = new ThreadPoolExecutor(
    0, Integer.MAX_VALUE, 60L, TimeUnit.SECONDS, queue
);
// æ¯ä¸ªä»»åŠ¡éƒ½ä¼šç«‹å³åˆ›å»ºæ–°çº¿ç¨‹æ‰§è¡Œ
```

---

## 5. æ‹’ç»ç­–ç•¥è¯¦è§£

### 5.1 é—®é¢˜10ï¼šä»€ä¹ˆæ—¶å€™ä¼šè§¦å‘æ‹’ç»ç­–ç•¥ï¼Ÿ

**è§¦å‘æ¡ä»¶**ï¼š

```
çº¿ç¨‹æ•° >= maximumPoolSize
    &&
é˜Ÿåˆ—å·²æ»¡
    &&
æ–°ä»»åŠ¡æäº¤
    â†“
è§¦å‘æ‹’ç»ç­–ç•¥
```

---

### 5.2 é—®é¢˜11ï¼šæœ‰å“ªäº›æ‹’ç»ç­–ç•¥ï¼Ÿ

**4ç§å†…ç½®ç­–ç•¥**ï¼š

| ç­–ç•¥ | è¡Œä¸º | é€‚ç”¨åœºæ™¯ |
|------|------|---------|
| **AbortPolicy** | æŠ›å‡ºå¼‚å¸¸ | é»˜è®¤ç­–ç•¥ï¼Œéœ€è¦æ„ŸçŸ¥å¤±è´¥ |
| **CallerRunsPolicy** | è°ƒç”¨è€…æ‰§è¡Œ | é™ä½æäº¤é€Ÿåº¦ |
| **DiscardPolicy** | é™é»˜ä¸¢å¼ƒ | å…è®¸ä¸¢å¤±ä»»åŠ¡ |
| **DiscardOldestPolicy** | ä¸¢å¼ƒæœ€è€ä»»åŠ¡ | ä¼˜å…ˆæ‰§è¡Œæ–°ä»»åŠ¡ |

**ç­–ç•¥å¯¹æ¯”å›¾**ï¼š

```
ä»»åŠ¡è¢«æ‹’ç»
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ AbortPolicy                     â”‚
â”‚ throw RejectedExecutionExceptionâ”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ CallerRunsPolicy                â”‚
â”‚ æäº¤ä»»åŠ¡çš„çº¿ç¨‹è‡ªå·±æ‰§è¡Œ          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ DiscardPolicy                   â”‚
â”‚ ä»€ä¹ˆéƒ½ä¸åšï¼Œé™é»˜ä¸¢å¼ƒ            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ DiscardOldestPolicy             â”‚
â”‚ ä¸¢å¼ƒé˜Ÿåˆ—å¤´éƒ¨ä»»åŠ¡ï¼Œé‡è¯•æäº¤      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**æºç å®ç°**ï¼š

```java
// 1. AbortPolicy - æŠ›å‡ºå¼‚å¸¸ï¼ˆé»˜è®¤ï¼‰
public static class AbortPolicy implements RejectedExecutionHandler {
    public void rejectedExecution(Runnable r, ThreadPoolExecutor e) {
        throw new RejectedExecutionException(
            "Task " + r.toString() + " rejected from " + e.toString()
        );
    }
}

// 2. CallerRunsPolicy - è°ƒç”¨è€…æ‰§è¡Œ
public static class CallerRunsPolicy implements RejectedExecutionHandler {
    public void rejectedExecution(Runnable r, ThreadPoolExecutor e) {
        if (!e.isShutdown()) {
            r.run();  // åœ¨å½“å‰çº¿ç¨‹æ‰§è¡Œ
        }
    }
}

// 3. DiscardPolicy - é™é»˜ä¸¢å¼ƒ
public static class DiscardPolicy implements RejectedExecutionHandler {
    public void rejectedExecution(Runnable r, ThreadPoolExecutor e) {
        // ä»€ä¹ˆéƒ½ä¸åš
    }
}

// 4. DiscardOldestPolicy - ä¸¢å¼ƒæœ€è€ä»»åŠ¡
public static class DiscardOldestPolicy implements RejectedExecutionHandler {
    public void rejectedExecution(Runnable r, ThreadPoolExecutor e) {
        if (!e.isShutdown()) {
            e.getQueue().poll();  // ç§»é™¤é˜Ÿåˆ—å¤´éƒ¨
            e.execute(r);         // é‡æ–°æäº¤
        }
    }
}
```

**è‡ªå®šä¹‰æ‹’ç»ç­–ç•¥**ï¼š

```java
public class CustomRejectedHandler implements RejectedExecutionHandler {
    @Override
    public void rejectedExecution(Runnable r, ThreadPoolExecutor executor) {
        // 1. è®°å½•æ—¥å¿—
        System.err.println("ä»»åŠ¡è¢«æ‹’ç»: " + r.toString());
        
        // 2. ä¿å­˜åˆ°æ•°æ®åº“æˆ–æ¶ˆæ¯é˜Ÿåˆ—
        saveToDatabase(r);
        
        // 3. å‘é€å‘Šè­¦
        sendAlert("çº¿ç¨‹æ± å·²æ»¡ï¼");
        
        // 4. é™çº§å¤„ç†
        // ...
    }
    
    private void saveToDatabase(Runnable r) {
        // ä¿å­˜ä»»åŠ¡ï¼Œç¨åé‡è¯•
    }
    
    private void sendAlert(String message) {
        // å‘é€å‘Šè­¦é€šçŸ¥
    }
}
```

---

## 6. æ ¸å¿ƒå‚æ•°é…ç½®

### 6.1 é—®é¢˜12ï¼šå¦‚ä½•é…ç½®çº¿ç¨‹æ± å‚æ•°ï¼Ÿ

**å‚æ•°è¯´æ˜**ï¼š

```java
ThreadPoolExecutor executor = new ThreadPoolExecutor(
    int corePoolSize,              // æ ¸å¿ƒçº¿ç¨‹æ•°
    int maximumPoolSize,           // æœ€å¤§çº¿ç¨‹æ•°
    long keepAliveTime,            // ç©ºé—²çº¿ç¨‹å­˜æ´»æ—¶é—´
    TimeUnit unit,                 // æ—¶é—´å•ä½
    BlockingQueue<Runnable> workQueue,  // ä»»åŠ¡é˜Ÿåˆ—
    ThreadFactory threadFactory,   // çº¿ç¨‹å·¥å‚
    RejectedExecutionHandler handler    // æ‹’ç»ç­–ç•¥
);
```

**å‚æ•°å…³ç³»å›¾**ï¼š

```
ä»»åŠ¡æäº¤
    â†“
å½“å‰çº¿ç¨‹æ•° < corePoolSizeï¼Ÿ
    â†“
   æ˜¯ â†’ åˆ›å»ºæ ¸å¿ƒçº¿ç¨‹
    â†“
   å¦ â†’ é˜Ÿåˆ—æœªæ»¡ï¼Ÿ
    â†“
   æ˜¯ â†’ åŠ å…¥é˜Ÿåˆ—
    â†“
   å¦ â†’ å½“å‰çº¿ç¨‹æ•° < maximumPoolSizeï¼Ÿ
    â†“
   æ˜¯ â†’ åˆ›å»ºä¸´æ—¶çº¿ç¨‹ï¼ˆå­˜æ´»keepAliveTimeï¼‰
    â†“
   å¦ â†’ æ‰§è¡Œæ‹’ç»ç­–ç•¥
```

---

### 6.2 é—®é¢˜13ï¼šå¦‚ä½•è®¡ç®—åˆé€‚çš„çº¿ç¨‹æ•°ï¼Ÿ

**CPUå¯†é›†å‹ä»»åŠ¡**ï¼š

```
æœ€ä½³çº¿ç¨‹æ•° = CPUæ ¸å¿ƒæ•° + 1

åŸå› ï¼š
- ä¸»è¦æ¶ˆè€—CPUèµ„æº
- è¿‡å¤šçº¿ç¨‹ä¼šå¯¼è‡´ä¸Šä¸‹æ–‡åˆ‡æ¢
- +1æ˜¯ä¸ºäº†é˜²æ­¢é¡µç¼ºå¤±ç­‰æƒ…å†µ
```

**IOå¯†é›†å‹ä»»åŠ¡**ï¼š

```
æœ€ä½³çº¿ç¨‹æ•° = CPUæ ¸å¿ƒæ•° Ã— (1 + IOç­‰å¾…æ—¶é—´/CPUè®¡ç®—æ—¶é—´)

ç¤ºä¾‹ï¼š
- CPUæ ¸å¿ƒæ•°ï¼š8
- IOç­‰å¾…æ—¶é—´ï¼š90ms
- CPUè®¡ç®—æ—¶é—´ï¼š10ms
- æœ€ä½³çº¿ç¨‹æ•° = 8 Ã— (1 + 90/10) = 80
```

**æ··åˆå‹ä»»åŠ¡**ï¼š

```
1. åˆ†ç¦»CPUå¯†é›†å’ŒIOå¯†é›†ä»»åŠ¡
2. ä½¿ç”¨ä¸åŒçš„çº¿ç¨‹æ± 
3. åˆ†åˆ«ä¼˜åŒ–
```

**å®é™…é…ç½®å»ºè®®**ï¼š

```java
// 1. CPUå¯†é›†å‹
int cpuCount = Runtime.getRuntime().availableProcessors();
ThreadPoolExecutor cpuExecutor = new ThreadPoolExecutor(
    cpuCount + 1,           // æ ¸å¿ƒçº¿ç¨‹æ•°
    cpuCount + 1,           // æœ€å¤§çº¿ç¨‹æ•°
    0L,                     // ä¸éœ€è¦å›æ”¶
    TimeUnit.MILLISECONDS,
    new LinkedBlockingQueue<>(100),
    new ThreadPoolExecutor.AbortPolicy()
);

// 2. IOå¯†é›†å‹
ThreadPoolExecutor ioExecutor = new ThreadPoolExecutor(
    cpuCount * 2,           // æ ¸å¿ƒçº¿ç¨‹æ•°
    cpuCount * 10,          // æœ€å¤§çº¿ç¨‹æ•°
    60L,                    // 60ç§’å›æ”¶
    TimeUnit.SECONDS,
    new LinkedBlockingQueue<>(1000),
    new ThreadPoolExecutor.CallerRunsPolicy()
);

// 3. æ··åˆå‹ï¼ˆåˆ†ç¦»å¤„ç†ï¼‰
ThreadPoolExecutor cpuPool = ...;  // CPUå¯†é›†ä»»åŠ¡
ThreadPoolExecutor ioPool = ...;   // IOå¯†é›†ä»»åŠ¡
```

---

## 7. çº¿ç¨‹æ± çš„å®Œæ•´æ‰§è¡Œæµç¨‹

### 7.1 é—®é¢˜14ï¼šä»æäº¤åˆ°æ‰§è¡Œçš„å®Œæ•´è¿‡ç¨‹æ˜¯ä»€ä¹ˆï¼Ÿ

**å®Œæ•´æµç¨‹å›¾**ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. ç”¨æˆ·æäº¤ä»»åŠ¡                                          â”‚
â”‚    executor.execute(task)                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. æ£€æŸ¥çº¿ç¨‹æ± çŠ¶æ€                                        â”‚
â”‚    if (çº¿ç¨‹æ± å·²å…³é—­) â†’ æ‹’ç»ä»»åŠ¡                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. åˆ¤æ–­æ ¸å¿ƒçº¿ç¨‹æ•°                                        â”‚
â”‚    if (workerCount < corePoolSize)                       â”‚
â”‚       â†’ addWorker(task, true)                            â”‚
â”‚       â†’ åˆ›å»ºWorker                                       â”‚
â”‚       â†’ å¯åŠ¨Workerçº¿ç¨‹                                   â”‚
â”‚       â†’ Worker.run() â†’ runWorker()                       â”‚
â”‚       â†’ æ‰§è¡ŒfirstTask                                    â”‚
â”‚       â†’ ç»“æŸ                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. å°è¯•åŠ å…¥é˜Ÿåˆ—                                          â”‚
â”‚    if (workQueue.offer(task))                            â”‚
â”‚       â†’ ä»»åŠ¡è¿›å…¥é˜Ÿåˆ—                                     â”‚
â”‚       â†’ Workerä»é˜Ÿåˆ—è·å–ï¼šgetTask()                      â”‚
â”‚       â†’ workQueue.take() æˆ– poll(timeout)                â”‚
â”‚       â†’ æ‰§è¡Œä»»åŠ¡                                         â”‚
â”‚       â†’ ç»“æŸ                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 5. åˆ¤æ–­æœ€å¤§çº¿ç¨‹æ•°                                        â”‚
â”‚    if (workerCount < maximumPoolSize)                    â”‚
â”‚       â†’ addWorker(task, false)                           â”‚
â”‚       â†’ åˆ›å»ºä¸´æ—¶Worker                                   â”‚
â”‚       â†’ æ‰§è¡Œä»»åŠ¡                                         â”‚
â”‚       â†’ keepAliveTimeåå›æ”¶                              â”‚
â”‚       â†’ ç»“æŸ                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 6. æ‰§è¡Œæ‹’ç»ç­–ç•¥                                          â”‚
â”‚    handler.rejectedExecution(task, executor)             â”‚
â”‚    - AbortPolicy: æŠ›å‡ºå¼‚å¸¸                               â”‚
â”‚    - CallerRunsPolicy: è°ƒç”¨è€…æ‰§è¡Œ                        â”‚
â”‚    - DiscardPolicy: ä¸¢å¼ƒä»»åŠ¡                             â”‚
â”‚    - DiscardOldestPolicy: ä¸¢å¼ƒæœ€è€ä»»åŠ¡                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### 7.2 é—®é¢˜15ï¼šWorkerçº¿ç¨‹çš„å®Œæ•´ç”Ÿå‘½å‘¨æœŸæ˜¯ä»€ä¹ˆï¼Ÿ

**Workerç”Ÿå‘½å‘¨æœŸå›¾**ï¼š

```
[åˆ›å»ºé˜¶æ®µ]
    â†“
new Worker(firstTask)
    â†“
åˆ›å»ºThreadå¯¹è±¡
    â†“
[å¯åŠ¨é˜¶æ®µ]
    â†“
thread.start()
    â†“
Worker.run()
    â†“
runWorker(this)
    â†“
[æ‰§è¡Œé˜¶æ®µ]
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ while (task != null ||           â”‚
â”‚        (task = getTask()) != null)â”‚
â”‚ {                                â”‚
â”‚   1. è·å–é”                      â”‚
â”‚   2. æ£€æŸ¥çº¿ç¨‹æ± çŠ¶æ€              â”‚
â”‚   3. beforeExecute()             â”‚
â”‚   4. task.run()                  â”‚
â”‚   5. afterExecute()              â”‚
â”‚   6. é‡Šæ”¾é”                      â”‚
â”‚   7. completedTasks++            â”‚
â”‚ }                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
[é€€å‡ºé˜¶æ®µ]
    â†“
getTask() è¿”å› null
    â†“
processWorkerExit(worker)
    â†“
ä»workersé›†åˆç§»é™¤
    â†“
tryTerminate()
    â†“
[é”€æ¯]
```

---

## 8. æ ¸å¿ƒé—®é¢˜æ€»ç»“

### Q1: çº¿ç¨‹æ± çš„æ ¸å¿ƒç»„ä»¶æœ‰å“ªäº›ï¼Ÿ
**A**: Workerçº¿ç¨‹ã€ä»»åŠ¡é˜Ÿåˆ—ã€çº¿ç¨‹å·¥å‚ã€æ‹’ç»ç­–ç•¥ã€çŠ¶æ€ç®¡ç†å™¨ã€‚

### Q2: ä»»åŠ¡æäº¤åçš„æ‰§è¡Œæµç¨‹æ˜¯ä»€ä¹ˆï¼Ÿ
**A**: æ ¸å¿ƒçº¿ç¨‹ â†’ é˜Ÿåˆ— â†’ ä¸´æ—¶çº¿ç¨‹ â†’ æ‹’ç»ç­–ç•¥ã€‚

### Q3: Workerçº¿ç¨‹å¦‚ä½•è·å–ä»»åŠ¡ï¼Ÿ
**A**: é€šè¿‡getTask()ä»BlockingQueueè·å–ï¼Œæ ¸å¿ƒçº¿ç¨‹é˜»å¡ç­‰å¾…ï¼Œä¸´æ—¶çº¿ç¨‹è¶…æ—¶ç­‰å¾…ã€‚

### Q4: çº¿ç¨‹æ± æœ‰å“ªäº›çŠ¶æ€ï¼Ÿ
**A**: RUNNINGã€SHUTDOWNã€STOPã€TIDYINGã€TERMINATEDã€‚

### Q5: å¦‚ä½•é€‰æ‹©åˆé€‚çš„é˜Ÿåˆ—ï¼Ÿ
**A**: æ ¹æ®åœºæ™¯é€‰æ‹©ï¼šæœ‰ç•Œé˜Ÿåˆ—ï¼ˆèµ„æºæœ‰é™ï¼‰ã€æ— ç•Œé˜Ÿåˆ—ï¼ˆä¸€èˆ¬åœºæ™¯ï¼‰ã€ç›´æ¥ä¼ é€’ï¼ˆå¿«é€Ÿå“åº”ï¼‰ã€‚

### Q6: å¦‚ä½•é…ç½®çº¿ç¨‹æ•°ï¼Ÿ
**A**: CPUå¯†é›†å‹ï¼šæ ¸å¿ƒæ•°+1ï¼›IOå¯†é›†å‹ï¼šæ ¸å¿ƒæ•°Ã—(1+IOæ—¶é—´/CPUæ—¶é—´)ã€‚

---

## 9. æ€è€ƒé¢˜

**Q1**: ä¸ºä»€ä¹ˆç”¨ä¸€ä¸ªAtomicIntegeråŒæ—¶è¡¨ç¤ºçŠ¶æ€å’Œçº¿ç¨‹æ•°ï¼Ÿ

**Q2**: ä¸ºä»€ä¹ˆéœ€è¦åŒé‡æ£€æŸ¥çº¿ç¨‹æ± çŠ¶æ€ï¼Ÿ

**Q3**: Workerä¸ºä»€ä¹ˆè¦ç»§æ‰¿AQSï¼Ÿ

**Q4**: ä¸ºä»€ä¹ˆæ ¸å¿ƒçº¿ç¨‹ä¸ä¼šè¢«å›æ”¶ï¼Ÿ

**Q5**: CallerRunsPolicyä¸ºä»€ä¹ˆèƒ½é™ä½æäº¤é€Ÿåº¦ï¼Ÿ

---

## ä¸‹ä¸€ç« é¢„å‘Š

ä¸‹ä¸€ç« æˆ‘ä»¬å°†æ¢è®¨ï¼š

- **çº¿ç¨‹æ± çš„å®é™…ä½¿ç”¨åœºæ™¯**
- **å¸¸è§çš„é…ç½®é”™è¯¯å’Œé™·é˜±**
- **å¦‚ä½•ç›‘æ§çº¿ç¨‹æ± **
- **çº¿ç¨‹æ± çš„æœ€ä½³å®è·µ**

è®©æˆ‘ä»¬ç»§ç»­æ·±å…¥ï¼ğŸš€
