# ç¬¬ä¸‰ç« ï¼šçº¿ç¨‹æ± çš„å®é™…ä½¿ç”¨

## å¼•è¨€

ç†è§£äº†çº¿ç¨‹æ± çš„å·¥ä½œåŸç†åï¼Œæœ¬ç« å°†èšç„¦å®æˆ˜ï¼š**å¦‚ä½•åœ¨å®é™…é¡¹ç›®ä¸­æ­£ç¡®ä½¿ç”¨çº¿ç¨‹æ± ï¼Ÿæœ‰å“ªäº›å¸¸è§é™·é˜±ï¼Ÿ**

---

## 1. çº¿ç¨‹æ± çš„åˆ›å»ºæ–¹å¼

### 1.1 é—®é¢˜1ï¼šExecutorså·¥å…·ç±» vs æ‰‹åŠ¨åˆ›å»ºï¼Ÿ

**Executorsæä¾›çš„å¿«æ·æ–¹æ³•**ï¼š

```java
// 1. newFixedThreadPool - å›ºå®šçº¿ç¨‹æ•°
ExecutorService executor = Executors.newFixedThreadPool(10);

// 2. newCachedThreadPool - ç¼“å­˜çº¿ç¨‹æ± 
ExecutorService executor = Executors.newCachedThreadPool();

// 3. newSingleThreadExecutor - å•çº¿ç¨‹
ExecutorService executor = Executors.newSingleThreadExecutor();

// 4. newScheduledThreadPool - å®šæ—¶ä»»åŠ¡
ScheduledExecutorService executor = Executors.newScheduledThreadPool(5);

// 5. newWorkStealingPool - å·¥ä½œçªƒå–ï¼ˆJava 8+ï¼‰
ExecutorService executor = Executors.newWorkStealingPool();
```

**âš ï¸ é˜¿é‡Œå·´å·´Javaå¼€å‘æ‰‹å†Œå¼ºåˆ¶è§„å®šï¼šç¦æ­¢ä½¿ç”¨Executorsåˆ›å»ºçº¿ç¨‹æ± ï¼**

**ä¸ºä»€ä¹ˆï¼Ÿ**

```java
// newFixedThreadPoolçš„æºç 
public static ExecutorService newFixedThreadPool(int nThreads) {
    return new ThreadPoolExecutor(
        nThreads, nThreads,
        0L, TimeUnit.MILLISECONDS,
        new LinkedBlockingQueue<Runnable>()  // âš ï¸ æ— ç•Œé˜Ÿåˆ—ï¼
    );
}

// newCachedThreadPoolçš„æºç 
public static ExecutorService newCachedThreadPool() {
    return new ThreadPoolExecutor(
        0, Integer.MAX_VALUE,  // âš ï¸ æ— é™çº¿ç¨‹ï¼
        60L, TimeUnit.SECONDS,
        new SynchronousQueue<Runnable>()
    );
}
```

**é—®é¢˜åˆ†æ**ï¼š


| æ–¹æ³•                        | é—®é¢˜     | åæœ            |
| --------------------------- | -------- | --------------- |
| **newFixedThreadPool**      | æ— ç•Œé˜Ÿåˆ— | OOMï¼ˆé˜Ÿåˆ—å †ç§¯ï¼‰ |
| **newCachedThreadPool**     | æ— é™çº¿ç¨‹ | OOMï¼ˆçº¿ç¨‹çˆ†ç‚¸ï¼‰ |
| **newSingleThreadExecutor** | æ— ç•Œé˜Ÿåˆ— | OOMï¼ˆé˜Ÿåˆ—å †ç§¯ï¼‰ |
| **newScheduledThreadPool**  | æ— ç•Œé˜Ÿåˆ— | OOMï¼ˆé˜Ÿåˆ—å †ç§¯ï¼‰ |

**æ­£ç¡®åšæ³•ï¼šæ‰‹åŠ¨åˆ›å»º**

```java
ThreadPoolExecutor executor = new ThreadPoolExecutor(
    10,                                    // æ ¸å¿ƒçº¿ç¨‹æ•°
    20,                                    // æœ€å¤§çº¿ç¨‹æ•°
    60L,                                   // ç©ºé—²çº¿ç¨‹å­˜æ´»æ—¶é—´
    TimeUnit.SECONDS,                      // æ—¶é—´å•ä½
    new ArrayBlockingQueue<>(1000),        // æœ‰ç•Œé˜Ÿåˆ—
    new ThreadFactoryBuilder()             // è‡ªå®šä¹‰çº¿ç¨‹å·¥å‚
        .setNameFormat("my-pool-%d")
        .build(),
    new ThreadPoolExecutor.CallerRunsPolicy()  // æ‹’ç»ç­–ç•¥
);
```

---

### 1.2 é—®é¢˜2ï¼šå¦‚ä½•è‡ªå®šä¹‰ThreadFactoryï¼Ÿ

**ä¸ºä»€ä¹ˆéœ€è¦è‡ªå®šä¹‰ThreadFactoryï¼Ÿ**

1. **è®¾ç½®æœ‰æ„ä¹‰çš„çº¿ç¨‹å**ï¼šæ–¹ä¾¿æ’æŸ¥é—®é¢˜
2. **è®¾ç½®çº¿ç¨‹ä¼˜å…ˆçº§**ï¼šåŒºåˆ†é‡è¦ä»»åŠ¡
3. **è®¾ç½®å®ˆæŠ¤çº¿ç¨‹**ï¼šé¿å…é˜»æ­¢JVMé€€å‡º
4. **ç»Ÿè®¡çº¿ç¨‹åˆ›å»ºæ•°é‡**ï¼šç›‘æ§

**é»˜è®¤ThreadFactoryçš„é—®é¢˜**ï¼š

```java
// é»˜è®¤çº¿ç¨‹åï¼špool-1-thread-1, pool-1-thread-2...
// æ— æ³•åŒºåˆ†æ˜¯å“ªä¸ªä¸šåŠ¡çš„çº¿ç¨‹ï¼
```

**è‡ªå®šä¹‰ThreadFactory**ï¼š

```java
public class CustomThreadFactory implements ThreadFactory {
    private final AtomicInteger threadNumber = new AtomicInteger(1);
    private final String namePrefix;
    private final boolean daemon;

    public CustomThreadFactory(String namePrefix, boolean daemon) {
        this.namePrefix = namePrefix;
        this.daemon = daemon;
    }

    @Override
    public Thread newThread(Runnable r) {
        Thread t = new Thread(r, namePrefix + "-" + threadNumber.getAndIncrement());
        t.setDaemon(daemon);

        // è®¾ç½®ä¼˜å…ˆçº§
        if (t.getPriority() != Thread.NORM_PRIORITY) {
            t.setPriority(Thread.NORM_PRIORITY);
        }

        // è®¾ç½®å¼‚å¸¸å¤„ç†å™¨
        t.setUncaughtExceptionHandler((thread, throwable) -> {
            System.err.println("çº¿ç¨‹ " + thread.getName() + " å‘ç”Ÿå¼‚å¸¸:");
            throwable.printStackTrace();
        });

        return t;
    }
}

// ä½¿ç”¨
ThreadPoolExecutor executor = new ThreadPoolExecutor(
    10, 20, 60L, TimeUnit.SECONDS,
    new ArrayBlockingQueue<>(1000),
    new CustomThreadFactory("order-pool", false),
    new ThreadPoolExecutor.CallerRunsPolicy()
);
```

**ä½¿ç”¨Guavaçš„ThreadFactoryBuilder**ï¼š

```java
// Mavenä¾èµ–
// <dependency>
//     <groupId>com.google.guava</groupId>
//     <artifactId>guava</artifactId>
//     <version>31.1-jre</version>
// </dependency>

ThreadFactory threadFactory = new ThreadFactoryBuilder()
    .setNameFormat("order-pool-%d")
    .setDaemon(false)
    .setPriority(Thread.NORM_PRIORITY)
    .setUncaughtExceptionHandler((t, e) -> {
        System.err.println("çº¿ç¨‹å¼‚å¸¸: " + t.getName());
        e.printStackTrace();
    })
    .build();
```

---

## 2. çº¿ç¨‹æ± çš„ä½¿ç”¨åœºæ™¯

### 2.1 é—®é¢˜3ï¼šä¸åŒåœºæ™¯å¦‚ä½•é€‰æ‹©çº¿ç¨‹æ± é…ç½®ï¼Ÿ

**åœºæ™¯1ï¼šWebåº”ç”¨å¤„ç†HTTPè¯·æ±‚**

```java
/**
 * åœºæ™¯ï¼šTomcatå¤„ç†HTTPè¯·æ±‚
 * ç‰¹ç‚¹ï¼šIOå¯†é›†å‹ï¼Œå“åº”æ—¶é—´è¦æ±‚é«˜
 */
public class WebRequestThreadPool {
    private static final int CPU_COUNT = Runtime.getRuntime().availableProcessors();

    private static final ThreadPoolExecutor EXECUTOR = new ThreadPoolExecutor(
        CPU_COUNT * 2,              // æ ¸å¿ƒçº¿ç¨‹æ•°ï¼šCPUæ ¸å¿ƒæ•°çš„2å€
        CPU_COUNT * 4,              // æœ€å¤§çº¿ç¨‹æ•°ï¼šCPUæ ¸å¿ƒæ•°çš„4å€
        60L,                        // ç©ºé—²çº¿ç¨‹60ç§’å›æ”¶
        TimeUnit.SECONDS,
        new LinkedBlockingQueue<>(500),  // é˜Ÿåˆ—å®¹é‡500
        new ThreadFactoryBuilder()
            .setNameFormat("web-request-%d")
            .build(),
        new ThreadPoolExecutor.CallerRunsPolicy()  // è°ƒç”¨è€…æ‰§è¡Œï¼Œé™ä½æäº¤é€Ÿåº¦
    );

    public static void handleRequest(Runnable task) {
        EXECUTOR.execute(task);
    }
}
```

**åœºæ™¯2ï¼šæ‰¹é‡æ•°æ®å¤„ç†**

```java
/**
 * åœºæ™¯ï¼šæ‰¹é‡å¯¼å…¥æ•°æ®
 * ç‰¹ç‚¹ï¼šCPUå¯†é›†å‹ï¼Œååé‡ä¼˜å…ˆ
 */
public class BatchProcessThreadPool {
    private static final int CPU_COUNT = Runtime.getRuntime().availableProcessors();

    private static final ThreadPoolExecutor EXECUTOR = new ThreadPoolExecutor(
        CPU_COUNT + 1,              // æ ¸å¿ƒçº¿ç¨‹æ•°ï¼šCPUæ ¸å¿ƒæ•°+1
        CPU_COUNT + 1,              // æœ€å¤§çº¿ç¨‹æ•°ï¼šå›ºå®š
        0L,                         // ä¸å›æ”¶
        TimeUnit.MILLISECONDS,
        new ArrayBlockingQueue<>(1000),  // æœ‰ç•Œé˜Ÿåˆ—
        new ThreadFactoryBuilder()
            .setNameFormat("batch-process-%d")
            .build(),
        new ThreadPoolExecutor.AbortPolicy()  // æ‹’ç»ä»»åŠ¡ï¼Œéœ€è¦å¤–éƒ¨å¤„ç†
    );

    public static <T> List<T> processBatch(List<T> data, Function<T, T> processor) {
        List<Future<T>> futures = new ArrayList<>();

        for (T item : data) {
            Future<T> future = EXECUTOR.submit(() -> processor.apply(item));
            futures.add(future);
        }

        List<T> results = new ArrayList<>();
        for (Future<T> future : futures) {
            try {
                results.add(future.get());
            } catch (Exception e) {
                e.printStackTrace();
            }
        }

        return results;
    }
}
```

**åœºæ™¯3ï¼šå¼‚æ­¥æ—¥å¿—å†™å…¥**

```java
/**
 * åœºæ™¯ï¼šå¼‚æ­¥å†™æ—¥å¿—
 * ç‰¹ç‚¹ï¼šIOå¯†é›†å‹ï¼Œå…è®¸ä¸¢å¤±éƒ¨åˆ†æ—¥å¿—
 */
public class AsyncLogThreadPool {
    private static final ThreadPoolExecutor EXECUTOR = new ThreadPoolExecutor(
        1,                          // æ ¸å¿ƒçº¿ç¨‹æ•°ï¼š1ä¸ªè¶³å¤Ÿ
        1,                          // æœ€å¤§çº¿ç¨‹æ•°ï¼š1ä¸ª
        0L,
        TimeUnit.MILLISECONDS,
        new LinkedBlockingQueue<>(10000),  // å¤§å®¹é‡é˜Ÿåˆ—
        new ThreadFactoryBuilder()
            .setNameFormat("async-log-%d")
            .setDaemon(true)        // å®ˆæŠ¤çº¿ç¨‹ï¼Œä¸é˜»æ­¢JVMé€€å‡º
            .build(),
        new ThreadPoolExecutor.DiscardOldestPolicy()  // ä¸¢å¼ƒæœ€è€çš„æ—¥å¿—
    );

    public static void log(String message) {
        EXECUTOR.execute(() -> {
            // å†™å…¥æ–‡ä»¶æˆ–å‘é€åˆ°æ—¥å¿—æœåŠ¡å™¨
            System.out.println(LocalDateTime.now() + " - " + message);
        });
    }
}
```

**åœºæ™¯4ï¼šå®šæ—¶ä»»åŠ¡**

```java
/**
 * åœºæ™¯ï¼šå®šæ—¶ä»»åŠ¡è°ƒåº¦
 * ç‰¹ç‚¹ï¼šéœ€è¦å»¶è¿Ÿæ‰§è¡Œå’Œå‘¨æœŸæ‰§è¡Œ
 */
public class ScheduledTaskThreadPool {
    private static final ScheduledThreadPoolExecutor EXECUTOR =
        new ScheduledThreadPoolExecutor(
            5,  // æ ¸å¿ƒçº¿ç¨‹æ•°
            new ThreadFactoryBuilder()
                .setNameFormat("scheduled-task-%d")
                .build(),
            new ThreadPoolExecutor.DiscardPolicy()
        );

    static {
        // è®¾ç½®ï¼šä»»åŠ¡æ‰§è¡Œå®Œåæ‰å¼€å§‹è®¡ç®—ä¸‹æ¬¡æ‰§è¡Œæ—¶é—´
        EXECUTOR.setExecuteExistingDelayedTasksAfterShutdownPolicy(false);
        EXECUTOR.setContinueExistingPeriodicTasksAfterShutdownPolicy(false);
    }

    // å»¶è¿Ÿæ‰§è¡Œ
    public static void scheduleOnce(Runnable task, long delay, TimeUnit unit) {
        EXECUTOR.schedule(task, delay, unit);
    }

    // å›ºå®šé¢‘ç‡æ‰§è¡Œ
    public static void scheduleAtFixedRate(Runnable task, long initialDelay,
                                           long period, TimeUnit unit) {
        EXECUTOR.scheduleAtFixedRate(task, initialDelay, period, unit);
    }

    // å›ºå®šå»¶è¿Ÿæ‰§è¡Œ
    public static void scheduleWithFixedDelay(Runnable task, long initialDelay,
                                              long delay, TimeUnit unit) {
        EXECUTOR.scheduleWithFixedDelay(task, initialDelay, delay, unit);
    }
}
```

---

### 2.2 é—®é¢˜4ï¼šå¦‚ä½•æ­£ç¡®æäº¤ä»»åŠ¡ï¼Ÿ

**execute() vs submit()**

```java
// 1. execute() - æäº¤Runnableï¼Œæ— è¿”å›å€¼
executor.execute(() -> {
    System.out.println("æ‰§è¡Œä»»åŠ¡");
});

// 2. submit() - æäº¤Runnableï¼Œè¿”å›Future
Future<?> future = executor.submit(() -> {
    System.out.println("æ‰§è¡Œä»»åŠ¡");
});

// 3. submit() - æäº¤Callableï¼Œè¿”å›Future<T>
Future<Integer> future = executor.submit(() -> {
    return 42;
});

// 4. invokeAll() - æ‰¹é‡æäº¤ï¼Œç­‰å¾…æ‰€æœ‰å®Œæˆ
List<Callable<Integer>> tasks = Arrays.asList(
    () -> 1,
    () -> 2,
    () -> 3
);
List<Future<Integer>> futures = executor.invokeAll(tasks);

// 5. invokeAny() - æ‰¹é‡æäº¤ï¼Œè¿”å›æœ€å¿«å®Œæˆçš„
Integer result = executor.invokeAny(tasks);
```

**âš ï¸ é‡è¦é™·é˜±ï¼šexecute()ä¼šåæ‰å¼‚å¸¸ï¼**

```java
// é”™è¯¯ç¤ºä¾‹ï¼šå¼‚å¸¸è¢«åæ‰
executor.execute(() -> {
    throw new RuntimeException("å‡ºé”™äº†ï¼");  // å¼‚å¸¸ä¸ä¼šè¢«æ•è·ï¼
});

// æ­£ç¡®åšæ³•1ï¼šä½¿ç”¨submit()
Future<?> future = executor.submit(() -> {
    throw new RuntimeException("å‡ºé”™äº†ï¼");
});
try {
    future.get();  // è¿™é‡Œä¼šæŠ›å‡ºå¼‚å¸¸
} catch (ExecutionException e) {
    System.err.println("ä»»åŠ¡æ‰§è¡Œå¤±è´¥: " + e.getCause());
}

// æ­£ç¡®åšæ³•2ï¼šæ‰‹åŠ¨æ•è·å¼‚å¸¸
executor.execute(() -> {
    try {
        // ä¸šåŠ¡é€»è¾‘
        throw new RuntimeException("å‡ºé”™äº†ï¼");
    } catch (Exception e) {
        System.err.println("ä»»åŠ¡æ‰§è¡Œå¤±è´¥: " + e);
    }
});

// æ­£ç¡®åšæ³•3ï¼šè®¾ç½®UncaughtExceptionHandler
ThreadFactory threadFactory = new ThreadFactoryBuilder()
    .setUncaughtExceptionHandler((t, e) -> {
        System.err.println("çº¿ç¨‹ " + t.getName() + " å¼‚å¸¸: " + e);
    })
    .build();
```

---

## 3. å¸¸è§é™·é˜±ä¸æœ€ä½³å®è·µ

### 3.1 é—®é¢˜5ï¼šçº¿ç¨‹æ± å¤§å°é…ç½®ä¸å½“

**é™·é˜±1ï¼šçº¿ç¨‹æ•°è¿‡å°‘**

```java
// âŒ é”™è¯¯ï¼šåªæœ‰2ä¸ªçº¿ç¨‹å¤„ç†å¤§é‡ä»»åŠ¡
ThreadPoolExecutor executor = new ThreadPoolExecutor(
    2, 2, 0L, TimeUnit.MILLISECONDS,
    new LinkedBlockingQueue<>()
);

// åæœï¼š
// - ä»»åŠ¡å“åº”æ…¢
// - CPUåˆ©ç”¨ç‡ä½
// - é˜Ÿåˆ—å †ç§¯
```

**é™·é˜±2ï¼šçº¿ç¨‹æ•°è¿‡å¤š**

```java
// âŒ é”™è¯¯ï¼šåˆ›å»º1000ä¸ªçº¿ç¨‹
ThreadPoolExecutor executor = new ThreadPoolExecutor(
    1000, 1000, 0L, TimeUnit.MILLISECONDS,
    new LinkedBlockingQueue<>()
);

// åæœï¼š
// - å†…å­˜å ç”¨é«˜ï¼ˆ1000MB+ï¼‰
// - ä¸Šä¸‹æ–‡åˆ‡æ¢é¢‘ç¹
// - æ€§èƒ½åè€Œä¸‹é™
```

**âœ… æ­£ç¡®åšæ³•ï¼šæ ¹æ®ä»»åŠ¡ç±»å‹è®¡ç®—**

```java
public class ThreadPoolSizeCalculator {

    /**
     * è®¡ç®—æœ€ä½³çº¿ç¨‹æ•°
     * @param targetCpuUtilization ç›®æ ‡CPUåˆ©ç”¨ç‡ (0-1)
     * @param waitTime IOç­‰å¾…æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰
     * @param computeTime CPUè®¡ç®—æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰
     */
    public static int calculate(double targetCpuUtilization,
                                long waitTime,
                                long computeTime) {
        int cpuCount = Runtime.getRuntime().availableProcessors();

        // å…¬å¼ï¼šçº¿ç¨‹æ•° = CPUæ ¸å¿ƒæ•° Ã— ç›®æ ‡åˆ©ç”¨ç‡ Ã— (1 + ç­‰å¾…æ—¶é—´/è®¡ç®—æ—¶é—´)
        return (int) (cpuCount * targetCpuUtilization *
                     (1 + (double) waitTime / computeTime));
    }

    public static void main(String[] args) {
        // ç¤ºä¾‹1ï¼šCPUå¯†é›†å‹ä»»åŠ¡
        int cpuIntensive = calculate(1.0, 0, 100);
        System.out.println("CPUå¯†é›†å‹æœ€ä½³çº¿ç¨‹æ•°: " + cpuIntensive);
        // è¾“å‡ºï¼š8ï¼ˆå‡è®¾8æ ¸CPUï¼‰

        // ç¤ºä¾‹2ï¼šIOå¯†é›†å‹ä»»åŠ¡ï¼ˆ90%æ—¶é—´åœ¨ç­‰å¾…IOï¼‰
        int ioIntensive = calculate(1.0, 900, 100);
        System.out.println("IOå¯†é›†å‹æœ€ä½³çº¿ç¨‹æ•°: " + ioIntensive);
        // è¾“å‡ºï¼š80
    }
}
```

---

### 3.2 é—®é¢˜6ï¼šé˜Ÿåˆ—é€‰æ‹©ä¸å½“

**é™·é˜±1ï¼šä½¿ç”¨æ— ç•Œé˜Ÿåˆ—**

```java
// âŒ é”™è¯¯ï¼šæ— ç•Œé˜Ÿåˆ—
ThreadPoolExecutor executor = new ThreadPoolExecutor(
    10, 20, 60L, TimeUnit.SECONDS,
    new LinkedBlockingQueue<>()  // æ— ç•Œé˜Ÿåˆ—
);

// é—®é¢˜ï¼š
// 1. maximumPoolSizeæ°¸è¿œä¸ä¼šç”Ÿæ•ˆ
// 2. é˜Ÿåˆ—å¯èƒ½æ— é™å¢é•¿ï¼Œå¯¼è‡´OOM
// 3. ä»»åŠ¡å †ç§¯ï¼Œå“åº”æ—¶é—´å˜é•¿
```

**é™·é˜±2ï¼šé˜Ÿåˆ—å®¹é‡è¿‡å°**

```java
// âŒ é”™è¯¯ï¼šé˜Ÿåˆ—å®¹é‡è¿‡å°
ThreadPoolExecutor executor = new ThreadPoolExecutor(
    10, 20, 60L, TimeUnit.SECONDS,
    new ArrayBlockingQueue<>(10)  // åªèƒ½æ”¾10ä¸ªä»»åŠ¡
);

// é—®é¢˜ï¼š
// 1. é¢‘ç¹è§¦å‘æ‹’ç»ç­–ç•¥
// 2. æ— æ³•åº”å¯¹æµé‡æ³¢åŠ¨
```

**âœ… æ­£ç¡®åšæ³•ï¼šæ ¹æ®åœºæ™¯é€‰æ‹©**

```java
// åœºæ™¯1ï¼šå†…å­˜æœ‰é™ï¼Œéœ€è¦å¿«é€Ÿå¤±è´¥
new ArrayBlockingQueue<>(1000)

// åœºæ™¯2ï¼šå…è®¸ä¸€å®šçš„é˜Ÿåˆ—å †ç§¯
new LinkedBlockingQueue<>(10000)

// åœºæ™¯3ï¼šéœ€è¦å¿«é€Ÿå“åº”ï¼Œä¸ç¼“å­˜ä»»åŠ¡
new SynchronousQueue<>()

// åœºæ™¯4ï¼šä»»åŠ¡æœ‰ä¼˜å…ˆçº§
new PriorityBlockingQueue<>(1000)
```

---

### 3.3 é—®é¢˜7ï¼šæ‹’ç»ç­–ç•¥é€‰æ‹©ä¸å½“

**åœºæ™¯åˆ†æ**ï¼š

```java
// åœºæ™¯1ï¼šå…³é”®ä¸šåŠ¡ï¼Œä¸èƒ½ä¸¢å¤±ä»»åŠ¡
// âœ… ä½¿ç”¨CallerRunsPolicy
new ThreadPoolExecutor.CallerRunsPolicy()
// æ•ˆæœï¼šè°ƒç”¨è€…æ‰§è¡Œï¼Œé™ä½æäº¤é€Ÿåº¦ï¼Œç»™çº¿ç¨‹æ± ç¼“å†²æ—¶é—´

// åœºæ™¯2ï¼šéœ€è¦æ„ŸçŸ¥ä»»åŠ¡è¢«æ‹’ç»
// âœ… ä½¿ç”¨AbortPolicyï¼ˆé»˜è®¤ï¼‰
new ThreadPoolExecutor.AbortPolicy()
// æ•ˆæœï¼šæŠ›å‡ºå¼‚å¸¸ï¼Œå¤–éƒ¨å¯ä»¥æ•è·å¹¶å¤„ç†

// åœºæ™¯3ï¼šå…è®¸ä¸¢å¤±éƒ¨åˆ†ä»»åŠ¡ï¼ˆå¦‚æ—¥å¿—ï¼‰
// âœ… ä½¿ç”¨DiscardPolicy
new ThreadPoolExecutor.DiscardPolicy()
// æ•ˆæœï¼šé™é»˜ä¸¢å¼ƒï¼Œä¸å½±å“ä¸»æµç¨‹

// åœºæ™¯4ï¼šä¼˜å…ˆæ‰§è¡Œæ–°ä»»åŠ¡
// âœ… ä½¿ç”¨DiscardOldestPolicy
new ThreadPoolExecutor.DiscardOldestPolicy()
// æ•ˆæœï¼šä¸¢å¼ƒé˜Ÿåˆ—å¤´éƒ¨ä»»åŠ¡ï¼Œé€‚åˆå®æ—¶æ€§è¦æ±‚é«˜çš„åœºæ™¯
```

**è‡ªå®šä¹‰æ‹’ç»ç­–ç•¥ç¤ºä¾‹**ï¼š

```java
public class SaveToDbRejectedHandler implements RejectedExecutionHandler {

    @Override
    public void rejectedExecution(Runnable r, ThreadPoolExecutor executor) {
        // 1. è®°å½•æ—¥å¿—
        System.err.println("ä»»åŠ¡è¢«æ‹’ç»ï¼Œä¿å­˜åˆ°æ•°æ®åº“: " + r);

        // 2. ä¿å­˜åˆ°æ•°æ®åº“
        saveTaskToDatabase(r);

        // 3. å‘é€å‘Šè­¦
        sendAlert("çº¿ç¨‹æ±  " + executor + " å·²æ»¡ï¼Œä»»åŠ¡è¢«æ‹’ç»ï¼");
    }

    private void saveTaskToDatabase(Runnable task) {
        // ä¿å­˜ä»»åŠ¡åˆ°æ•°æ®åº“ï¼Œç¨åé‡è¯•
        // ...
    }

    private void sendAlert(String message) {
        // å‘é€å‘Šè­¦é€šçŸ¥
        // ...
    }
}
```

---

### 3.4 é—®é¢˜8ï¼šçº¿ç¨‹æ± æœªæ­£ç¡®å…³é—­

**é™·é˜±ï¼šçº¿ç¨‹æ± æœªå…³é—­å¯¼è‡´JVMæ— æ³•é€€å‡º**

```java
// âŒ é”™è¯¯ï¼šçº¿ç¨‹æ± æœªå…³é—­
public class BadExample {
    private static final ExecutorService EXECUTOR =
        Executors.newFixedThreadPool(10);

    public static void main(String[] args) {
        EXECUTOR.execute(() -> {
            System.out.println("æ‰§è¡Œä»»åŠ¡");
        });

        // ç¨‹åºä¸ä¼šé€€å‡ºï¼å› ä¸ºçº¿ç¨‹æ± çš„çº¿ç¨‹è¿˜åœ¨è¿è¡Œ
    }
}
```

**âœ… æ­£ç¡®åšæ³•ï¼šä¼˜é›…å…³é—­**

```java
public class GracefulShutdown {
    private static final ExecutorService EXECUTOR =
        Executors.newFixedThreadPool(10);

    public static void main(String[] args) {
        // æäº¤ä»»åŠ¡
        EXECUTOR.execute(() -> {
            System.out.println("æ‰§è¡Œä»»åŠ¡");
        });

        // ä¼˜é›…å…³é—­
        shutdownGracefully(EXECUTOR, 60, TimeUnit.SECONDS);
    }

    /**
     * ä¼˜é›…å…³é—­çº¿ç¨‹æ± 
     * @param executor çº¿ç¨‹æ± 
     * @param timeout è¶…æ—¶æ—¶é—´
     * @param unit æ—¶é—´å•ä½
     */
    public static void shutdownGracefully(ExecutorService executor,
                                         long timeout,
                                         TimeUnit unit) {
        // 1. åœæ­¢æ¥æ”¶æ–°ä»»åŠ¡
        executor.shutdown();

        try {
            // 2. ç­‰å¾…å·²æäº¤çš„ä»»åŠ¡å®Œæˆ
            if (!executor.awaitTermination(timeout, unit)) {
                // 3. è¶…æ—¶åå¼ºåˆ¶å…³é—­
                System.err.println("çº¿ç¨‹æ± æœªèƒ½åœ¨æŒ‡å®šæ—¶é—´å†…å…³é—­ï¼Œå¼ºåˆ¶å…³é—­");
                List<Runnable> droppedTasks = executor.shutdownNow();
                System.err.println("è¢«ä¸¢å¼ƒçš„ä»»åŠ¡æ•°: " + droppedTasks.size());

                // 4. å†æ¬¡ç­‰å¾…
                if (!executor.awaitTermination(timeout, unit)) {
                    System.err.println("çº¿ç¨‹æ± æ— æ³•å…³é—­");
                }
            }
        } catch (InterruptedException e) {
            // 5. å½“å‰çº¿ç¨‹è¢«ä¸­æ–­ï¼Œå¼ºåˆ¶å…³é—­
            executor.shutdownNow();
            Thread.currentThread().interrupt();
        }
    }
}
```

**ä½¿ç”¨é’©å­å‡½æ•°è‡ªåŠ¨å…³é—­**ï¼š

```java
public class AutoShutdownThreadPool {
    private static final ExecutorService EXECUTOR =
        Executors.newFixedThreadPool(10);

    static {
        // æ³¨å†ŒJVMå…³é—­é’©å­
        Runtime.getRuntime().addShutdownHook(new Thread(() -> {
            System.out.println("JVMæ­£åœ¨å…³é—­ï¼Œå…³é—­çº¿ç¨‹æ± ...");
            GracefulShutdown.shutdownGracefully(EXECUTOR, 60, TimeUnit.SECONDS);
        }));
    }
}
```

---

#### Spring Booté¡¹ç›®ä¸­çº¿ç¨‹æ± æœªå…³é—­çš„å½±å“

**åœºæ™¯ï¼šåœ¨Spring Bootä¸­åˆ›å»ºè‡ªå®šä¹‰çº¿ç¨‹æ± **

```java
@Configuration
public class ThreadPoolConfig {
    
    @Bean("customThreadPool")
    public ThreadPoolExecutor customThreadPool() {
        return new ThreadPoolExecutor(
            10,                         // æ ¸å¿ƒçº¿ç¨‹æ•°
            20,                         // æœ€å¤§çº¿ç¨‹æ•°
            60L,                        // ç©ºé—²çº¿ç¨‹å­˜æ´»æ—¶é—´
            TimeUnit.SECONDS,
            new ArrayBlockingQueue<>(100),
            new ThreadFactoryBuilder()
                .setNameFormat("custom-pool-%d")
                .build(),
            new ThreadPoolExecutor.CallerRunsPolicy()
        );
    }
}
```

**é—®é¢˜1ï¼šåº”ç”¨æ— æ³•æ­£å¸¸å…³é—­**

```
ç°è±¡ï¼š
1. æ‰§è¡Œ kill -15 <pid> æˆ– Ctrl+C æ—¶ï¼Œåº”ç”¨hangä½
2. æ—¥å¿—æ˜¾ç¤º "Waiting for active requests to complete"
3. éœ€è¦ç­‰å¾…å¾ˆé•¿æ—¶é—´æˆ–å¼ºåˆ¶kill -9æ‰èƒ½å…³é—­

åŸå› ï¼š
- çº¿ç¨‹æ± çš„æ ¸å¿ƒçº¿ç¨‹é»˜è®¤ä¸ä¼šè¶…æ—¶é”€æ¯
- è¿™äº›çº¿ç¨‹ä¼šä¸€ç›´ç­‰å¾…æ–°ä»»åŠ¡
- Spring Bootçš„ä¼˜é›…å…³é—­æœºåˆ¶æ— æ³•ç»ˆæ­¢è¿™äº›çº¿ç¨‹
- å¯¼è‡´åº”ç”¨æ— æ³•æ­£å¸¸é€€å‡º
```

**é—®é¢˜2ï¼šèµ„æºæ³„æ¼**

```
å½±å“ï¼š
1. çº¿ç¨‹èµ„æºæ³„æ¼
   - 10ä¸ªæ ¸å¿ƒçº¿ç¨‹ä¸€ç›´å ç”¨å†…å­˜ï¼ˆæ¯ä¸ªçº¿ç¨‹çº¦1MBï¼‰
   - çº¿ç¨‹æ ˆç©ºé—´æ— æ³•é‡Šæ”¾
   
2. ä»»åŠ¡é˜Ÿåˆ—æ³„æ¼
   - é˜Ÿåˆ—ä¸­æœªå®Œæˆçš„ä»»åŠ¡æ— æ³•è¢«GC
   - å¦‚æœä»»åŠ¡æŒæœ‰å¤§å¯¹è±¡ï¼Œå†…å­˜æ³„æ¼ä¸¥é‡
   
3. ThreadLocalæ³„æ¼
   - å¦‚æœçº¿ç¨‹ä¸­ä½¿ç”¨äº†ThreadLocal
   - çº¿ç¨‹ä¸ç»“æŸï¼ŒThreadLocalæ°¸è¿œæ— æ³•è¢«æ¸…ç†
```

**é—®é¢˜3ï¼šé‡å¯/é‡æ–°éƒ¨ç½²æ—¶çš„é—®é¢˜**

```
åœºæ™¯ï¼šä½¿ç”¨çƒ­éƒ¨ç½²å·¥å…·ï¼ˆå¦‚Spring DevToolsï¼‰æˆ–å®¹å™¨åŒ–éƒ¨ç½²

é—®é¢˜ï¼š
1. æ—§çš„çº¿ç¨‹æ± å®ä¾‹æ— æ³•è¢«GC
2. æ¯æ¬¡é‡å¯éƒ½ä¼šåˆ›å»ºæ–°çš„çº¿ç¨‹æ± 
3. æœ€ç»ˆå¯¼è‡´çº¿ç¨‹æ•°çˆ†ç‚¸å’ŒOOM

ç¤ºä¾‹ï¼š
é‡å¯10æ¬¡åï¼š
- çº¿ç¨‹æ•°ï¼š10æ¬¡ Ã— 10ä¸ªæ ¸å¿ƒçº¿ç¨‹ = 100ä¸ªçº¿ç¨‹
- å†…å­˜å ç”¨ï¼š100ä¸ªçº¿ç¨‹ Ã— 1MB = 100MB
```

**é—®é¢˜4ï¼šKubernetes/Dockerç¯å¢ƒä¸‹çš„å½±å“**

```
K8s Podç”Ÿå‘½å‘¨æœŸï¼š
1. æ”¶åˆ°SIGTERMä¿¡å·ï¼ˆä¼˜é›…å…³é—­ï¼‰
2. ç­‰å¾…30ç§’ï¼ˆé»˜è®¤terminationGracePeriodSecondsï¼‰
3. å‘é€SIGKILLä¿¡å·ï¼ˆå¼ºåˆ¶æ€æ­»ï¼‰

å¦‚æœçº¿ç¨‹æ± æœªå…³é—­ï¼š
- åº”ç”¨åœ¨30ç§’å†…æ— æ³•å®Œæˆå…³é—­
- è¢«SIGKILLå¼ºåˆ¶æ€æ­»
- æ­£åœ¨æ‰§è¡Œçš„ä»»åŠ¡è¢«ä¸­æ–­
- å¯èƒ½å¯¼è‡´æ•°æ®ä¸ä¸€è‡´
```

**âœ… è§£å†³æ–¹æ¡ˆ1ï¼šå®ç°DisposableBeanæ¥å£**

```java
@Configuration
public class ThreadPoolConfig {
    
    @Bean("customThreadPool")
    public ThreadPoolExecutor customThreadPool() {
        ThreadPoolExecutor executor = new ThreadPoolExecutor(
            10, 20, 60L, TimeUnit.SECONDS,
            new ArrayBlockingQueue<>(100),
            new ThreadFactoryBuilder()
                .setNameFormat("custom-pool-%d")
                .build(),
            new ThreadPoolExecutor.CallerRunsPolicy()
        );
        
        return executor;
    }
    
    /**
     * Springå®¹å™¨é”€æ¯æ—¶è‡ªåŠ¨è°ƒç”¨
     */
    @Bean
    public DisposableBean threadPoolDestroyer(@Qualifier("customThreadPool") ThreadPoolExecutor executor) {
        return () -> {
            System.out.println("æ­£åœ¨å…³é—­çº¿ç¨‹æ± ...");
            executor.shutdown();
            try {
                if (!executor.awaitTermination(60, TimeUnit.SECONDS)) {
                    System.err.println("çº¿ç¨‹æ± æœªèƒ½åœ¨60ç§’å†…å…³é—­ï¼Œå¼ºåˆ¶å…³é—­");
                    executor.shutdownNow();
                }
            } catch (InterruptedException e) {
                executor.shutdownNow();
                Thread.currentThread().interrupt();
            }
            System.out.println("çº¿ç¨‹æ± å·²å…³é—­");
        };
    }
}
```

**âœ… è§£å†³æ–¹æ¡ˆ2ï¼šä½¿ç”¨@PreDestroyæ³¨è§£**

```java
@Component
public class ThreadPoolManager {
    
    private final ThreadPoolExecutor executor;
    
    public ThreadPoolManager() {
        this.executor = new ThreadPoolExecutor(
            10, 20, 60L, TimeUnit.SECONDS,
            new ArrayBlockingQueue<>(100),
            new ThreadFactoryBuilder()
                .setNameFormat("custom-pool-%d")
                .build(),
            new ThreadPoolExecutor.CallerRunsPolicy()
        );
    }
    
    public ThreadPoolExecutor getExecutor() {
        return executor;
    }
    
    /**
     * Springå®¹å™¨é”€æ¯æ—¶è‡ªåŠ¨è°ƒç”¨
     */
    @PreDestroy
    public void destroy() {
        System.out.println("@PreDestroy: æ­£åœ¨å…³é—­çº¿ç¨‹æ± ...");
        executor.shutdown();
        try {
            if (!executor.awaitTermination(60, TimeUnit.SECONDS)) {
                System.err.println("çº¿ç¨‹æ± æœªèƒ½åœ¨60ç§’å†…å…³é—­ï¼Œå¼ºåˆ¶å…³é—­");
                List<Runnable> droppedTasks = executor.shutdownNow();
                System.err.println("è¢«ä¸¢å¼ƒçš„ä»»åŠ¡æ•°: " + droppedTasks.size());
            }
        } catch (InterruptedException e) {
            executor.shutdownNow();
            Thread.currentThread().interrupt();
        }
        System.out.println("çº¿ç¨‹æ± å·²å…³é—­");
    }
}
```

**âœ… è§£å†³æ–¹æ¡ˆ3ï¼šé…ç½®allowCoreThreadTimeOut**

```java
@Bean("customThreadPool")
public ThreadPoolExecutor customThreadPool() {
    ThreadPoolExecutor executor = new ThreadPoolExecutor(
        10, 20, 60L, TimeUnit.SECONDS,
        new ArrayBlockingQueue<>(100),
        new ThreadFactoryBuilder()
            .setNameFormat("custom-pool-%d")
            .build(),
        new ThreadPoolExecutor.CallerRunsPolicy()
    );
    
    // å…è®¸æ ¸å¿ƒçº¿ç¨‹è¶…æ—¶é”€æ¯
    // è¿™æ ·å³ä½¿ä¸è°ƒç”¨shutdown()ï¼Œç©ºé—²çº¿ç¨‹ä¹Ÿä¼šè‡ªåŠ¨é”€æ¯
    executor.allowCoreThreadTimeOut(true);
    
    return executor;
}
```

**âš ï¸ allowCoreThreadTimeOutçš„æ³¨æ„äº‹é¡¹**

```
ä¼˜ç‚¹ï¼š
1. æ ¸å¿ƒçº¿ç¨‹ç©ºé—²60ç§’åè‡ªåŠ¨é”€æ¯
2. å‡å°‘èµ„æºå ç”¨
3. åº”ç”¨å…³é—­æ—¶çº¿ç¨‹æ± è‡ªåŠ¨æ¸…ç©º

ç¼ºç‚¹ï¼š
1. é¢‘ç¹åˆ›å»º/é”€æ¯çº¿ç¨‹ï¼Œæ€§èƒ½å¼€é”€
2. ä¸é€‚åˆé«˜å¹¶å‘åœºæ™¯
3. çº¿ç¨‹é¢„çƒ­æ—¶é—´å¢åŠ 

é€‚ç”¨åœºæ™¯ï¼š
- ä»»åŠ¡ä¸é¢‘ç¹çš„åœºæ™¯
- å¼€å‘/æµ‹è¯•ç¯å¢ƒ
- å¯¹æ€§èƒ½è¦æ±‚ä¸é«˜çš„åœºæ™¯

ä¸é€‚ç”¨åœºæ™¯ï¼š
- é«˜å¹¶å‘ç”Ÿäº§ç¯å¢ƒ
- éœ€è¦çº¿ç¨‹é¢„çƒ­çš„åœºæ™¯
- å¯¹å“åº”æ—¶é—´æ•æ„Ÿçš„åœºæ™¯
```

**âœ… è§£å†³æ–¹æ¡ˆ4ï¼šä½¿ç”¨Springçš„ThreadPoolTaskExecutor**

```java
@Configuration
public class ThreadPoolConfig {
    
    /**
     * Springæä¾›çš„çº¿ç¨‹æ± ï¼Œä¼šè‡ªåŠ¨ç®¡ç†ç”Ÿå‘½å‘¨æœŸ
     */
    @Bean("springThreadPool")
    public ThreadPoolTaskExecutor springThreadPool() {
        ThreadPoolTaskExecutor executor = new ThreadPoolTaskExecutor();
        executor.setCorePoolSize(10);
        executor.setMaxPoolSize(20);
        executor.setQueueCapacity(100);
        executor.setKeepAliveSeconds(60);
        executor.setThreadNamePrefix("spring-pool-");
        executor.setRejectedExecutionHandler(new ThreadPoolExecutor.CallerRunsPolicy());
        
        // ç­‰å¾…æ‰€æœ‰ä»»åŠ¡å®Œæˆåå†å…³é—­çº¿ç¨‹æ± 
        executor.setWaitForTasksToCompleteOnShutdown(true);
        
        // ç­‰å¾…æ—¶é—´ï¼ˆç§’ï¼‰
        executor.setAwaitTerminationSeconds(60);
        
        executor.initialize();
        return executor;
    }
}
```

**å¯¹æ¯”ï¼šThreadPoolExecutor vs ThreadPoolTaskExecutor**

| ç‰¹æ€§ | ThreadPoolExecutor | ThreadPoolTaskExecutor |
|------|-------------------|----------------------|
| **ç”Ÿå‘½å‘¨æœŸç®¡ç†** | éœ€è¦æ‰‹åŠ¨ç®¡ç† | Springè‡ªåŠ¨ç®¡ç† |
| **ä¼˜é›…å…³é—­** | éœ€è¦æ‰‹åŠ¨å®ç° | è‡ªåŠ¨å®ç° |
| **é…ç½®æ–¹å¼** | æ„é€ å‡½æ•°å‚æ•° | setteræ–¹æ³• |
| **ç›‘æ§é›†æˆ** | éœ€è¦æ‰‹åŠ¨é›†æˆ | æ˜“äºé›†æˆSpringç›‘æ§ |
| **æ¨èåœºæ™¯** | éSpringç¯å¢ƒ | Spring/Spring Bootç¯å¢ƒ |

**æœ€ä½³å®è·µæ€»ç»“**

```
1. Spring Booté¡¹ç›®ä¸­ï¼š
   âœ… ä¼˜å…ˆä½¿ç”¨ThreadPoolTaskExecutor
   âœ… è®¾ç½®waitForTasksToCompleteOnShutdown=true
   âœ… è®¾ç½®åˆç†çš„awaitTerminationSeconds
   
2. å¿…é¡»ä½¿ç”¨ThreadPoolExecutoræ—¶ï¼š
   âœ… å®ç°DisposableBeanæˆ–ä½¿ç”¨@PreDestroy
   âœ… åœ¨destroyæ–¹æ³•ä¸­ä¼˜é›…å…³é—­çº¿ç¨‹æ± 
   âœ… è€ƒè™‘è®¾ç½®allowCoreThreadTimeOut=trueï¼ˆéé«˜å¹¶å‘åœºæ™¯ï¼‰
   
3. å®¹å™¨åŒ–éƒ¨ç½²æ—¶ï¼š
   âœ… ç¡®ä¿awaitTerminationSeconds < terminationGracePeriodSeconds
   âœ… ç›‘æ§åº”ç”¨å…³é—­æ—¶é—´
   âœ… è®°å½•æœªå®Œæˆçš„ä»»åŠ¡æ•°
   
4. å¼€å‘é˜¶æ®µï¼š
   âœ… ä½¿ç”¨Spring DevToolsæ—¶æ³¨æ„çº¿ç¨‹æ± æ³„æ¼
   âœ… å®šæœŸæ£€æŸ¥çº¿ç¨‹æ•°
   âœ… ä½¿ç”¨JProfilerç­‰å·¥å…·ç›‘æ§
```

**å®é™…æ¡ˆä¾‹ï¼šç”Ÿäº§ç¯å¢ƒé—®é¢˜æ’æŸ¥**

```
é—®é¢˜ç°è±¡ï¼š
- åº”ç”¨é‡å¯æ—¶é—´ä»10ç§’å¢åŠ åˆ°60ç§’
- K8s Podç»å¸¸è¢«SIGKILLå¼ºåˆ¶æ€æ­»
- åº”ç”¨æ—¥å¿—æ˜¾ç¤ºå¤§é‡ä»»åŠ¡è¢«ä¸­æ–­

æ’æŸ¥è¿‡ç¨‹ï¼š
1. jstackæŸ¥çœ‹çº¿ç¨‹æ ˆ
   - å‘ç°å¤§é‡è‡ªå®šä¹‰çº¿ç¨‹æ± çš„çº¿ç¨‹
   - çº¿ç¨‹çŠ¶æ€ï¼šWAITING (parking)
   
2. æ£€æŸ¥ä»£ç 
   - å‘ç°è‡ªå®šä¹‰ThreadPoolExecutoræœªå…³é—­
   - æ²¡æœ‰å®ç°DisposableBean
   
3. è§£å†³æ–¹æ¡ˆ
   - æ·»åŠ @PreDestroyæ–¹æ³•
   - è®¾ç½®awaitTerminationSeconds=50
   - K8sçš„terminationGracePeriodSeconds=60
   
ç»“æœï¼š
- åº”ç”¨å…³é—­æ—¶é—´é™ä½åˆ°5ç§’
- æ‰€æœ‰ä»»åŠ¡æ­£å¸¸å®Œæˆ
- æ— SIGKILLå¼ºåˆ¶æ€æ­»
```

---



### 3.5 é—®é¢˜9ï¼šçº¿ç¨‹æ± å‚æ•°ä¸å¯è°ƒæ•´

**é™·é˜±ï¼šç¡¬ç¼–ç å‚æ•°**

```java
// âŒ é”™è¯¯ï¼šå‚æ•°ç¡¬ç¼–ç 
ThreadPoolExecutor executor = new ThreadPoolExecutor(
    10, 20, 60L, TimeUnit.SECONDS,
    new ArrayBlockingQueue<>(1000)
);

// é—®é¢˜ï¼š
// 1. æ— æ³•æ ¹æ®å®é™…æƒ…å†µè°ƒæ•´
// 2. éœ€è¦é‡å¯åº”ç”¨æ‰èƒ½ä¿®æ”¹
```

**âœ… æ­£ç¡®åšæ³•ï¼šæ”¯æŒåŠ¨æ€è°ƒæ•´**

```java
public class DynamicThreadPool {
    private final ThreadPoolExecutor executor;

    public DynamicThreadPool() {
        this.executor = new ThreadPoolExecutor(
            10, 20, 60L, TimeUnit.SECONDS,
            new ArrayBlockingQueue<>(1000),
            new ThreadFactoryBuilder()
                .setNameFormat("dynamic-pool-%d")
                .build(),
            new ThreadPoolExecutor.CallerRunsPolicy()
        );
    }

    /**
     * åŠ¨æ€è°ƒæ•´æ ¸å¿ƒçº¿ç¨‹æ•°
     */
    public void setCorePoolSize(int corePoolSize) {
        executor.setCorePoolSize(corePoolSize);
        System.out.println("æ ¸å¿ƒçº¿ç¨‹æ•°å·²è°ƒæ•´ä¸º: " + corePoolSize);
    }

    /**
     * åŠ¨æ€è°ƒæ•´æœ€å¤§çº¿ç¨‹æ•°
     */
    public void setMaximumPoolSize(int maximumPoolSize) {
        executor.setMaximumPoolSize(maximumPoolSize);
        System.out.println("æœ€å¤§çº¿ç¨‹æ•°å·²è°ƒæ•´ä¸º: " + maximumPoolSize);
    }

    /**
     * åŠ¨æ€è°ƒæ•´é˜Ÿåˆ—å®¹é‡ï¼ˆéœ€è¦ä½¿ç”¨ResizableCapacityLinkedBlockingQueueï¼‰
     */
    public void setQueueCapacity(int capacity) {
        BlockingQueue<Runnable> queue = executor.getQueue();
        if (queue instanceof ResizableCapacityLinkedBlockingQueue) {
            ((ResizableCapacityLinkedBlockingQueue<Runnable>) queue)
                .setCapacity(capacity);
            System.out.println("é˜Ÿåˆ—å®¹é‡å·²è°ƒæ•´ä¸º: " + capacity);
        }
    }

    /**
     * è·å–çº¿ç¨‹æ± çŠ¶æ€
     */
    public String getStatus() {
        return String.format(
            "æ ¸å¿ƒçº¿ç¨‹æ•°: %d, æœ€å¤§çº¿ç¨‹æ•°: %d, å½“å‰çº¿ç¨‹æ•°: %d, " +
            "æ´»è·ƒçº¿ç¨‹æ•°: %d, é˜Ÿåˆ—å¤§å°: %d, å·²å®Œæˆä»»åŠ¡æ•°: %d",
            executor.getCorePoolSize(),
            executor.getMaximumPoolSize(),
            executor.getPoolSize(),
            executor.getActiveCount(),
            executor.getQueue().size(),
            executor.getCompletedTaskCount()
        );
    }
}

/**
 * å¯è°ƒæ•´å®¹é‡çš„é˜»å¡é˜Ÿåˆ—
 */
class ResizableCapacityLinkedBlockingQueue<E> extends LinkedBlockingQueue<E> {
    private volatile int capacity;

    public ResizableCapacityLinkedBlockingQueue(int capacity) {
        super(capacity);
        this.capacity = capacity;
    }

    public void setCapacity(int capacity) {
        this.capacity = capacity;
    }

    @Override
    public int remainingCapacity() {
        return capacity - size();
    }
}
```

---

## 4. çº¿ç¨‹æ± ç›‘æ§

### 4.1 é—®é¢˜10ï¼šå¦‚ä½•ç›‘æ§çº¿ç¨‹æ± çŠ¶æ€ï¼Ÿ

**ç›‘æ§æŒ‡æ ‡**ï¼š

```java
public class ThreadPoolMonitor {

    public static void monitor(ThreadPoolExecutor executor) {
        System.out.println("========== çº¿ç¨‹æ± ç›‘æ§ ==========");
        System.out.println("æ ¸å¿ƒçº¿ç¨‹æ•°: " + executor.getCorePoolSize());
        System.out.println("æœ€å¤§çº¿ç¨‹æ•°: " + executor.getMaximumPoolSize());
        System.out.println("å½“å‰çº¿ç¨‹æ•°: " + executor.getPoolSize());
        System.out.println("æ´»è·ƒçº¿ç¨‹æ•°: " + executor.getActiveCount());
        System.out.println("é˜Ÿåˆ—å¤§å°: " + executor.getQueue().size());
        System.out.println("é˜Ÿåˆ—å‰©ä½™å®¹é‡: " + executor.getQueue().remainingCapacity());
        System.out.println("å·²å®Œæˆä»»åŠ¡æ•°: " + executor.getCompletedTaskCount());
        System.out.println("æ€»ä»»åŠ¡æ•°: " + executor.getTaskCount());
        System.out.println("æ›¾ç»çš„æœ€å¤§çº¿ç¨‹æ•°: " + executor.getLargestPoolSize());
        System.out.println("================================");
    }

    /**
     * å®šæœŸç›‘æ§
     */
    public static void startMonitoring(ThreadPoolExecutor executor,
                                      long period,
                                      TimeUnit unit) {
        ScheduledExecutorService monitor = Executors.newSingleThreadScheduledExecutor(
            new ThreadFactoryBuilder()
                .setNameFormat("pool-monitor-%d")
                .setDaemon(true)
                .build()
        );

        monitor.scheduleAtFixedRate(() -> {
            monitor(executor);

            // å‘Šè­¦æ£€æŸ¥
            checkAndAlert(executor);
        }, 0, period, unit);
    }

    /**
     * å‘Šè­¦æ£€æŸ¥
     */
    private static void checkAndAlert(ThreadPoolExecutor executor) {
        // 1. é˜Ÿåˆ—ä½¿ç”¨ç‡å‘Šè­¦
        int queueSize = executor.getQueue().size();
        int queueCapacity = queueSize + executor.getQueue().remainingCapacity();
        double queueUsage = (double) queueSize / queueCapacity;

        if (queueUsage > 0.8) {
            System.err.println("âš ï¸ å‘Šè­¦ï¼šé˜Ÿåˆ—ä½¿ç”¨ç‡è¶…è¿‡80%: " +
                             String.format("%.2f%%", queueUsage * 100));
        }

        // 2. æ´»è·ƒçº¿ç¨‹æ•°å‘Šè­¦
        int activeCount = executor.getActiveCount();
        int maximumPoolSize = executor.getMaximumPoolSize();
        double threadUsage = (double) activeCount / maximumPoolSize;

        if (threadUsage > 0.9) {
            System.err.println("âš ï¸ å‘Šè­¦ï¼šæ´»è·ƒçº¿ç¨‹æ•°è¶…è¿‡90%: " +
                             String.format("%.2f%%", threadUsage * 100));
        }

        // 3. æ‹’ç»ä»»åŠ¡å‘Šè­¦ï¼ˆéœ€è¦è‡ªå®šä¹‰æ‹’ç»ç­–ç•¥ç»Ÿè®¡ï¼‰
        // ...
    }
}
```

**ä½¿ç”¨ç¤ºä¾‹**ï¼š

```java
public class MonitoringExample {
    public static void main(String[] args) throws InterruptedException {
        ThreadPoolExecutor executor = new ThreadPoolExecutor(
            5, 10, 60L, TimeUnit.SECONDS,
            new ArrayBlockingQueue<>(100),
            new ThreadFactoryBuilder()
                .setNameFormat("test-pool-%d")
                .build()
        );

        // å¯åŠ¨ç›‘æ§
        ThreadPoolMonitor.startMonitoring(executor, 5, TimeUnit.SECONDS);

        // æäº¤ä»»åŠ¡
        for (int i = 0; i < 200; i++) {
            final int taskId = i;
            executor.execute(() -> {
                try {
                    Thread.sleep(1000);
                    System.out.println("ä»»åŠ¡ " + taskId + " å®Œæˆ");
                } catch (InterruptedException e) {
                    e.printStackTrace();
                }
            });
        }

        // ç­‰å¾…ä¸€æ®µæ—¶é—´è§‚å¯Ÿç›‘æ§
        Thread.sleep(60000);

        executor.shutdown();
    }
}
```

---

### 4.2 é—®é¢˜11ï¼šå¦‚ä½•é›†æˆç›‘æ§ç³»ç»Ÿï¼Ÿ

**é›†æˆMicrometerï¼ˆSpring Boot Actuatorï¼‰**ï¼š

```java
@Configuration
public class ThreadPoolMetricsConfig {

    @Bean
    public ThreadPoolExecutor monitoredThreadPool(MeterRegistry registry) {
        ThreadPoolExecutor executor = new ThreadPoolExecutor(
            10, 20, 60L, TimeUnit.SECONDS,
            new ArrayBlockingQueue<>(1000),
            new ThreadFactoryBuilder()
                .setNameFormat("monitored-pool-%d")
                .build()
        );

        // æ³¨å†ŒæŒ‡æ ‡
        Metrics.gauge("thread.pool.core.size", executor,
                     ThreadPoolExecutor::getCorePoolSize);
        Metrics.gauge("thread.pool.max.size", executor,
                     ThreadPoolExecutor::getMaximumPoolSize);
        Metrics.gauge("thread.pool.current.size", executor,
                     ThreadPoolExecutor::getPoolSize);
        Metrics.gauge("thread.pool.active.count", executor,
                     ThreadPoolExecutor::getActiveCount);
        Metrics.gauge("thread.pool.queue.size", executor,
                     e -> e.getQueue().size());

        return executor;
    }
}
```

---

## 5. æœ€ä½³å®è·µæ€»ç»“

### 5.1 é…ç½®æ¸…å•

```java
/**
 * çº¿ç¨‹æ± é…ç½®æœ€ä½³å®è·µ
 */
public class ThreadPoolBestPractice {

    public static ThreadPoolExecutor createThreadPool(String poolName) {
        int cpuCount = Runtime.getRuntime().availableProcessors();

        return new ThreadPoolExecutor(
            // 1. æ ¸å¿ƒçº¿ç¨‹æ•°ï¼šæ ¹æ®ä»»åŠ¡ç±»å‹è®¡ç®—
            cpuCount * 2,

            // 2. æœ€å¤§çº¿ç¨‹æ•°ï¼šæ ¸å¿ƒçº¿ç¨‹æ•°çš„2å€
            cpuCount * 4,

            // 3. ç©ºé—²çº¿ç¨‹å­˜æ´»æ—¶é—´ï¼š60ç§’
            60L,
            TimeUnit.SECONDS,

            // 4. ä»»åŠ¡é˜Ÿåˆ—ï¼šæœ‰ç•Œé˜Ÿåˆ—ï¼Œé˜²æ­¢OOM
            new ArrayBlockingQueue<>(1000),

            // 5. çº¿ç¨‹å·¥å‚ï¼šè‡ªå®šä¹‰çº¿ç¨‹å
            new ThreadFactoryBuilder()
                .setNameFormat(poolName + "-%d")
                .setDaemon(false)
                .setUncaughtExceptionHandler((t, e) -> {
                    System.err.println("çº¿ç¨‹ " + t.getName() + " å¼‚å¸¸:");
                    e.printStackTrace();
                })
                .build(),

            // 6. æ‹’ç»ç­–ç•¥ï¼šè°ƒç”¨è€…æ‰§è¡Œ
            new ThreadPoolExecutor.CallerRunsPolicy()
        );
    }
}
```

### 5.2 ä½¿ç”¨æµç¨‹å›¾

```
[åˆ›å»ºçº¿ç¨‹æ± ]
    â†“
é…ç½®åˆç†çš„å‚æ•°
    â†“
[æäº¤ä»»åŠ¡]
    â†“
ä½¿ç”¨submit()è€Œéexecute()
    â†“
æ­£ç¡®å¤„ç†Future
    â†“
[ç›‘æ§çº¿ç¨‹æ± ]
    â†“
å®šæœŸæ£€æŸ¥æŒ‡æ ‡
    â†“
æ ¹æ®ç›‘æ§æ•°æ®è°ƒæ•´å‚æ•°
    â†“
[å…³é—­çº¿ç¨‹æ± ]
    â†“
ä¼˜é›…å…³é—­
```

---

## 6. æ ¸å¿ƒé—®é¢˜æ€»ç»“

### Q1: ä¸ºä»€ä¹ˆä¸èƒ½ä½¿ç”¨Executorsåˆ›å»ºçº¿ç¨‹æ± ï¼Ÿ

**A**: ä¼šåˆ›å»ºæ— ç•Œé˜Ÿåˆ—æˆ–æ— é™çº¿ç¨‹ï¼Œå¯¼è‡´OOMã€‚

### Q2: å¦‚ä½•é€‰æ‹©åˆé€‚çš„çº¿ç¨‹æ•°ï¼Ÿ

**A**: CPUå¯†é›†å‹ï¼šæ ¸å¿ƒæ•°+1ï¼›IOå¯†é›†å‹ï¼šæ ¸å¿ƒæ•°Ã—(1+IOæ—¶é—´/CPUæ—¶é—´)ã€‚

### Q3: å¦‚ä½•é€‰æ‹©åˆé€‚çš„é˜Ÿåˆ—ï¼Ÿ

**A**: æ ¹æ®åœºæ™¯é€‰æ‹©ï¼šæœ‰ç•Œé˜Ÿåˆ—ï¼ˆé˜²OOMï¼‰ã€æ— ç•Œé˜Ÿåˆ—ï¼ˆå…è®¸å †ç§¯ï¼‰ã€ç›´æ¥ä¼ é€’ï¼ˆå¿«é€Ÿå“åº”ï¼‰ã€‚

### Q4: å¦‚ä½•æ­£ç¡®å…³é—­çº¿ç¨‹æ± ï¼Ÿ

**A**: shutdown() + awaitTermination() + shutdownNow()ã€‚

### Q5: å¦‚ä½•ç›‘æ§çº¿ç¨‹æ± ï¼Ÿ

**A**: å®šæœŸé‡‡é›†æŒ‡æ ‡ï¼Œè®¾ç½®å‘Šè­¦é˜ˆå€¼ï¼Œé›†æˆç›‘æ§ç³»ç»Ÿã€‚

---

## ä¸‹ä¸€ç« é¢„å‘Š

ä¸‹ä¸€ç« æˆ‘ä»¬å°†æ·±å…¥æºç ï¼š

- **ThreadPoolExecutoræºç è¯¦è§£**
- **Workerçš„å®ç°åŸç†**
- **ctlçš„å·§å¦™è®¾è®¡**
- **çº¿ç¨‹æ± çš„ä¼˜åŒ–æŠ€å·§**

è®©æˆ‘ä»¬ç»§ç»­æ·±å…¥ï¼ğŸš€
