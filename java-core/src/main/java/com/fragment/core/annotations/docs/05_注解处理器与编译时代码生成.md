# ç¬¬äº”ç« ï¼šæ³¨è§£å¤„ç†å™¨ä¸ç¼–è¯‘æ—¶ä»£ç ç”Ÿæˆ

## å¼•è¨€

åœ¨å‰é¢çš„ç« èŠ‚ä¸­ï¼Œæˆ‘ä»¬å­¦ä¹ äº†æ³¨è§£çš„å®šä¹‰ã€å·¥ä½œåŸç†å’Œå®é™…åº”ç”¨ã€‚ä½†ä½ æ˜¯å¦å¥½å¥‡ï¼š

- **Lombokæ˜¯å¦‚ä½•é€šè¿‡ä¸€ä¸ª`@Data`æ³¨è§£å°±èƒ½è‡ªåŠ¨ç”Ÿæˆgetter/setterçš„ï¼Ÿ**
- **ä¸ºä»€ä¹ˆä½¿ç”¨Lombokä¸éœ€è¦åœ¨è¿è¡Œæ—¶åå°„ï¼Ÿ**
- **å¦‚ä½•åœ¨ç¼–è¯‘æœŸå°±ç”Ÿæˆä»£ç ï¼Œè€Œä¸æ˜¯è¿è¡Œæ—¶ï¼Ÿ**

æœ¬ç« å°†æ­å¼€ **æ³¨è§£å¤„ç†å™¨ï¼ˆAnnotation Processorï¼‰** çš„ç¥ç§˜é¢çº±ï¼Œå¸¦ä½ æ·±å…¥ç†è§£ç¼–è¯‘æ—¶ä»£ç ç”Ÿæˆçš„åŸç†å’Œå®è·µã€‚

---

## 1. ä»€ä¹ˆæ˜¯æ³¨è§£å¤„ç†å™¨ï¼ˆAPTï¼‰

### 1.1 åŸºæœ¬æ¦‚å¿µ

**æ³¨è§£å¤„ç†å™¨ï¼ˆAnnotation Processing Toolï¼ŒAPTï¼‰** æ˜¯Javaç¼–è¯‘å™¨çš„ä¸€ä¸ªå·¥å…·ï¼Œå®ƒå¯ä»¥åœ¨**ç¼–è¯‘æœŸ**æ‰«æå’Œå¤„ç†æ³¨è§£ï¼Œå¹¶ç”Ÿæˆæ–°çš„æºä»£ç æ–‡ä»¶æˆ–èµ„æºæ–‡ä»¶ã€‚

```
æºä»£ç (.java)
    â†“
[ç¼–è¯‘å™¨å¯åŠ¨]
    â†“
[æ³¨è§£å¤„ç†å™¨æ‰«ææ³¨è§£] â† åœ¨è¿™é‡Œå·¥ä½œï¼
    â†“
[ç”Ÿæˆæ–°çš„.javaæ–‡ä»¶]
    â†“
[ç»§ç»­ç¼–è¯‘æ‰€æœ‰æ–‡ä»¶]
    â†“
å­—èŠ‚ç (.class)
```

### 1.2 APT vs åå°„


| ç‰¹æ€§         | æ³¨è§£å¤„ç†å™¨ï¼ˆAPTï¼‰  | åå°„               |
| ------------ | ------------------ | ------------------ |
| **å·¥ä½œæ—¶æœº** | ç¼–è¯‘æœŸ             | è¿è¡ŒæœŸ             |
| **æ€§èƒ½å½±å“** | æ— ï¼ˆç¼–è¯‘æ—¶å¤„ç†ï¼‰   | æœ‰ï¼ˆè¿è¡Œæ—¶å¼€é”€ï¼‰   |
| **èƒ½åŠ›**     | ç”Ÿæˆæ–°ä»£ç          | è¯»å–å·²æœ‰ä¿¡æ¯       |
| **ç±»å‹å®‰å…¨** | ç¼–è¯‘æœŸæ£€æŸ¥         | è¿è¡ŒæœŸæ£€æŸ¥         |
| **ä½¿ç”¨åœºæ™¯** | ä»£ç ç”Ÿæˆã€ç¼–è¯‘æ£€æŸ¥ | åŠ¨æ€ä»£ç†ã€æ¡†æ¶æ³¨å…¥ |

**å…³é”®åŒºåˆ«**ï¼š

```java
// åå°„æ–¹å¼ï¼ˆè¿è¡Œæ—¶ï¼‰
@Getter
public class User {
    private String name;
}
// è¿è¡Œæ—¶é€šè¿‡åå°„è°ƒç”¨getName()ï¼Œæ¯æ¬¡éƒ½æœ‰åå°„å¼€é”€

// APTæ–¹å¼ï¼ˆç¼–è¯‘æ—¶ï¼‰
@Getter
public class User {
    private String name;
}
// ç¼–è¯‘åç›´æ¥ç”ŸæˆgetName()æ–¹æ³•ï¼Œè¿è¡Œæ—¶æ— å¼€é”€
```

### 1.3 APTçš„åº”ç”¨åœºæ™¯

1. **ä»£ç ç”Ÿæˆ**ï¼šLombokã€AutoValueã€Dagger
2. **ç¼–è¯‘æ£€æŸ¥**ï¼šChecker Frameworkã€NullAway
3. **èµ„æºç”Ÿæˆ**ï¼šRoomï¼ˆAndroidï¼‰ã€ButterKnife
4. **æ–‡æ¡£ç”Ÿæˆ**ï¼šJavaDocå¤„ç†å™¨

---

## 2. æ³¨è§£å¤„ç†å™¨çš„å·¥ä½œåŸç†

### 2.1 ç¼–è¯‘è¿‡ç¨‹è¯¦è§£

Javaç¼–è¯‘å™¨çš„å®Œæ•´æµç¨‹ï¼š

```
1. Parse and Enterï¼ˆè§£æå’Œè¾“å…¥ï¼‰
   â”œâ”€ è¯»å–æºæ–‡ä»¶
   â”œâ”€ è¯æ³•åˆ†æ
   â”œâ”€ è¯­æ³•åˆ†æ
   â””â”€ æ„å»ºæŠ½è±¡è¯­æ³•æ ‘ï¼ˆASTï¼‰

2. Annotation Processingï¼ˆæ³¨è§£å¤„ç†ï¼‰â† APTåœ¨è¿™é‡Œ
   â”œâ”€ ç¬¬1è½®ï¼šå¤„ç†æ‰€æœ‰æ³¨è§£
   â”œâ”€ ç”Ÿæˆæ–°æ–‡ä»¶
   â”œâ”€ ç¬¬2è½®ï¼šå¤„ç†æ–°æ–‡ä»¶ä¸­çš„æ³¨è§£
   â””â”€ é‡å¤ç›´åˆ°æ²¡æœ‰æ–°æ–‡ä»¶ç”Ÿæˆ

3. Analyse and Generateï¼ˆåˆ†æå’Œç”Ÿæˆï¼‰
   â”œâ”€ è¯­ä¹‰åˆ†æ
   â”œâ”€ ç±»å‹æ£€æŸ¥
   â””â”€ ç”Ÿæˆå­—èŠ‚ç 
```

### 2.2 æ³¨è§£å¤„ç†å™¨çš„ç”Ÿå‘½å‘¨æœŸ

```java
public class MyProcessor extends AbstractProcessor {

    @Override
    public synchronized void init(ProcessingEnvironment env) {
        // 1. åˆå§‹åŒ–ï¼šè·å–å·¥å…·ç±»
        super.init(env);
    }

    @Override
    public boolean process(Set<? extends TypeElement> annotations,
                          RoundEnvironment roundEnv) {
        // 2. å¤„ç†ï¼šæ¯ä¸€è½®éƒ½ä¼šè°ƒç”¨
        // - æ‰«ææ³¨è§£
        // - ç”Ÿæˆä»£ç 
        // - è¿”å›trueè¡¨ç¤ºæ³¨è§£å·²å¤„ç†
        return true;
    }

    @Override
    public Set<String> getSupportedAnnotationTypes() {
        // 3. å£°æ˜æ”¯æŒçš„æ³¨è§£ç±»å‹
        return Set.of("com.example.MyAnnotation");
    }

    @Override
    public SourceVersion getSupportedSourceVersion() {
        // 4. å£°æ˜æ”¯æŒçš„Javaç‰ˆæœ¬
        return SourceVersion.latestSupported();
    }
}
```

### 2.3 å¤„ç†è½®æ¬¡ï¼ˆRoundï¼‰

æ³¨è§£å¤„ç†æ˜¯**å¤šè½®**è¿›è¡Œçš„ï¼š

```
Round 1:
  è¾“å…¥ï¼šUser.javaï¼ˆå¸¦@Getteræ³¨è§£ï¼‰
  å¤„ç†ï¼šç”ŸæˆUserBuilder.java

Round 2:
  è¾“å…¥ï¼šUserBuilder.javaï¼ˆå¯èƒ½ä¹Ÿæœ‰æ³¨è§£ï¼‰
  å¤„ç†ï¼šå¦‚æœæœ‰æ–°æ³¨è§£ï¼Œç»§ç»­ç”Ÿæˆ

Round N:
  è¾“å…¥ï¼šæ— æ–°æ–‡ä»¶
  å¤„ç†ï¼šç»“æŸ
```

**ç¤ºä¾‹ä»£ç **ï¼š

```java
@Override
public boolean process(Set<? extends TypeElement> annotations,
                      RoundEnvironment roundEnv) {
    if (roundEnv.processingOver()) {
        // æœ€åä¸€è½®ï¼Œåšæ¸…ç†å·¥ä½œ
        return false;
    }

    // æ­£å¸¸å¤„ç†
    for (TypeElement annotation : annotations) {
        Set<? extends Element> elements =
            roundEnv.getElementsAnnotatedWith(annotation);
        // å¤„ç†æ¯ä¸ªè¢«æ³¨è§£çš„å…ƒç´ 
    }

    return true;
}
```

---

## 3. ç¼–å†™ç¬¬ä¸€ä¸ªæ³¨è§£å¤„ç†å™¨

### 3.1 éœ€æ±‚ï¼šè‡ªåŠ¨ç”ŸæˆBuilder

æˆ‘ä»¬è¦å®ç°ä¸€ä¸ª`@AutoBuilder`æ³¨è§£ï¼Œè‡ªåŠ¨ç”ŸæˆBuilderæ¨¡å¼ä»£ç ã€‚

**ä½¿ç”¨æ•ˆæœ**ï¼š

```java
@AutoBuilder
public class User {
    private String name;
    private int age;
    private String email;
}

// è‡ªåŠ¨ç”ŸæˆUserBuilderç±»
User user = new UserBuilder()
    .name("å¼ ä¸‰")
    .age(25)
    .email("zhangsan@example.com")
    .build();
```

### 3.2 æ­¥éª¤1ï¼šå®šä¹‰æ³¨è§£

```java
package com.example.processor;

import java.lang.annotation.ElementType;
import java.lang.annotation.Retention;
import java.lang.annotation.RetentionPolicy;
import java.lang.annotation.Target;

@Target(ElementType.TYPE)  // åªèƒ½ç”¨äºç±»
@Retention(RetentionPolicy.SOURCE)  // ç¼–è¯‘åä¸¢å¼ƒ
public @interface AutoBuilder {
}
```

**å…³é”®ç‚¹**ï¼š

- `@Retention(SOURCE)`ï¼šç¼–è¯‘åæ³¨è§£ä¿¡æ¯ä¼šè¢«ä¸¢å¼ƒï¼Œå› ä¸ºå·²ç»ç”Ÿæˆäº†ä»£ç 
- `@Target(TYPE)`ï¼šåªèƒ½ç”¨äºç±»

### 3.3 æ­¥éª¤2ï¼šå®ç°æ³¨è§£å¤„ç†å™¨

```java
package com.example.processor;

import javax.annotation.processing.*;
import javax.lang.model.SourceVersion;
import javax.lang.model.element.*;
import javax.lang.model.type.TypeMirror;
import javax.tools.Diagnostic;
import javax.tools.JavaFileObject;
import java.io.IOException;
import java.io.PrintWriter;
import java.util.Set;

@SupportedAnnotationTypes("com.example.processor.AutoBuilder")
@SupportedSourceVersion(SourceVersion.RELEASE_8)
public class AutoBuilderProcessor extends AbstractProcessor {

    private Filer filer;
    private Messager messager;

    @Override
    public synchronized void init(ProcessingEnvironment processingEnv) {
        super.init(processingEnv);
        // è·å–æ–‡ä»¶ç”Ÿæˆå™¨
        filer = processingEnv.getFiler();
        // è·å–æ¶ˆæ¯è¾“å‡ºå™¨ï¼ˆç”¨äºæ‰“å°æ—¥å¿—å’Œé”™è¯¯ï¼‰
        messager = processingEnv.getMessager();
    }

    @Override
    public boolean process(Set<? extends TypeElement> annotations,
                          RoundEnvironment roundEnv) {
        // è·å–æ‰€æœ‰è¢«@AutoBuilderæ³¨è§£çš„ç±»
        for (Element element : roundEnv.getElementsAnnotatedWith(AutoBuilder.class)) {
            // åªå¤„ç†ç±»
            if (element.getKind() != ElementKind.CLASS) {
                messager.printMessage(
                    Diagnostic.Kind.ERROR,
                    "@AutoBuilderåªèƒ½ç”¨äºç±»",
                    element
                );
                continue;
            }

            TypeElement classElement = (TypeElement) element;
            try {
                generateBuilderClass(classElement);
            } catch (IOException e) {
                messager.printMessage(
                    Diagnostic.Kind.ERROR,
                    "ç”ŸæˆBuilderå¤±è´¥: " + e.getMessage(),
                    element
                );
            }
        }

        return true;
    }

    private void generateBuilderClass(TypeElement classElement) throws IOException {
        String className = classElement.getSimpleName().toString();
        String packageName = processingEnv.getElementUtils()
            .getPackageOf(classElement).toString();
        String builderClassName = className + "Builder";

        // åˆ›å»ºæ–°çš„Javaæ–‡ä»¶
        JavaFileObject builderFile = filer.createSourceFile(
            packageName + "." + builderClassName
        );

        try (PrintWriter out = new PrintWriter(builderFile.openWriter())) {
            // ç”ŸæˆåŒ…å£°æ˜
            if (!packageName.isEmpty()) {
                out.println("package " + packageName + ";");
                out.println();
            }

            // ç”Ÿæˆç±»å£°æ˜
            out.println("public class " + builderClassName + " {");
            out.println();

            // ç”Ÿæˆå­—æ®µ
            for (Element enclosed : classElement.getEnclosedElements()) {
                if (enclosed.getKind() == ElementKind.FIELD) {
                    VariableElement field = (VariableElement) enclosed;
                    String fieldName = field.getSimpleName().toString();
                    String fieldType = field.asType().toString();

                    out.println("    private " + fieldType + " " + fieldName + ";");
                }
            }
            out.println();

            // ç”Ÿæˆsetteræ–¹æ³•ï¼ˆè¿”å›thisï¼‰
            for (Element enclosed : classElement.getEnclosedElements()) {
                if (enclosed.getKind() == ElementKind.FIELD) {
                    VariableElement field = (VariableElement) enclosed;
                    String fieldName = field.getSimpleName().toString();
                    String fieldType = field.asType().toString();

                    out.println("    public " + builderClassName + " " +
                               fieldName + "(" + fieldType + " " + fieldName + ") {");
                    out.println("        this." + fieldName + " = " + fieldName + ";");
                    out.println("        return this;");
                    out.println("    }");
                    out.println();
                }
            }

            // ç”Ÿæˆbuildæ–¹æ³•
            out.println("    public " + className + " build() {");
            out.println("        " + className + " obj = new " + className + "();");

            for (Element enclosed : classElement.getEnclosedElements()) {
                if (enclosed.getKind() == ElementKind.FIELD) {
                    VariableElement field = (VariableElement) enclosed;
                    String fieldName = field.getSimpleName().toString();
                    out.println("        obj." + fieldName + " = this." + fieldName + ";");
                }
            }

            out.println("        return obj;");
            out.println("    }");

            // ç»“æŸç±»
            out.println("}");
        }

        messager.printMessage(
            Diagnostic.Kind.NOTE,
            "ç”ŸæˆBuilderç±»: " + builderClassName
        );
    }
}
```

### 3.4 æ­¥éª¤3ï¼šæ³¨å†Œå¤„ç†å™¨

åˆ›å»ºæ–‡ä»¶ï¼š`src/main/resources/META-INF/services/javax.annotation.processing.Processor`

```
com.example.processor.AutoBuilderProcessor
```

**æˆ–è€…ä½¿ç”¨Googleçš„auto-serviceåº“**ï¼š

```xml
<dependency>
    <groupId>com.google.auto.service</groupId>
    <artifactId>auto-service</artifactId>
    <version>1.0.1</version>
    <optional>true</optional>
</dependency>
```

```java
@AutoService(Processor.class)  // è‡ªåŠ¨ç”Ÿæˆæ³¨å†Œæ–‡ä»¶
@SupportedAnnotationTypes("com.example.processor.AutoBuilder")
@SupportedSourceVersion(SourceVersion.RELEASE_8)
public class AutoBuilderProcessor extends AbstractProcessor {
    // ...
}
```

### 3.5 æ­¥éª¤4ï¼šä½¿ç”¨å¤„ç†å™¨

**é¡¹ç›®ç»“æ„**ï¼š

```
my-project/
â”œâ”€â”€ processor/          # æ³¨è§£å¤„ç†å™¨æ¨¡å—
â”‚   â”œâ”€â”€ AutoBuilder.java
â”‚   â””â”€â”€ AutoBuilderProcessor.java
â””â”€â”€ app/               # åº”ç”¨æ¨¡å—
    â””â”€â”€ User.java
```

**Mavené…ç½®**ï¼š

```xml
<!-- processoræ¨¡å—çš„pom.xml -->
<dependencies>
    <dependency>
        <groupId>com.google.auto.service</groupId>
        <artifactId>auto-service</artifactId>
        <version>1.0.1</version>
        <optional>true</optional>
    </dependency>
</dependencies>

<!-- appæ¨¡å—çš„pom.xml -->
<dependencies>
    <dependency>
        <groupId>com.example</groupId>
        <artifactId>processor</artifactId>
        <version>1.0.0</version>
        <scope>provided</scope>  <!-- åªåœ¨ç¼–è¯‘æ—¶éœ€è¦ -->
    </dependency>
</dependencies>
```

**ä½¿ç”¨ç¤ºä¾‹**ï¼š

```java
@AutoBuilder
public class User {
    private String name;
    private int age;
    private String email;
}

// ç¼–è¯‘åè‡ªåŠ¨ç”ŸæˆUserBuilder.java
public class UserBuilder {
    private String name;
    private int age;
    private String email;

    public UserBuilder name(String name) {
        this.name = name;
        return this;
    }

    public UserBuilder age(int age) {
        this.age = age;
        return this;
    }

    public UserBuilder email(String email) {
        this.email = email;
        return this;
    }

    public User build() {
        User obj = new User();
        obj.name = this.name;
        obj.age = this.age;
        obj.email = this.email;
        return obj;
    }
}
```

---

## 4. Elementæ¨¡å‹è¯¦è§£

### 4.1 Elementå±‚æ¬¡ç»“æ„

åœ¨æ³¨è§£å¤„ç†å™¨ä¸­ï¼Œæˆ‘ä»¬é€šè¿‡**Element**æ¥è¡¨ç¤ºç¨‹åºå…ƒç´ ï¼š

```
Elementï¼ˆç¨‹åºå…ƒç´ ï¼‰
â”œâ”€â”€ PackageElementï¼ˆåŒ…ï¼‰
â”œâ”€â”€ TypeElementï¼ˆç±»/æ¥å£ï¼‰
â”‚   â”œâ”€â”€ VariableElementï¼ˆå­—æ®µï¼‰
â”‚   â”œâ”€â”€ ExecutableElementï¼ˆæ–¹æ³•/æ„é€ å™¨ï¼‰
â”‚   â”‚   â””â”€â”€ VariableElementï¼ˆå‚æ•°ï¼‰
â”‚   â””â”€â”€ TypeElementï¼ˆå†…éƒ¨ç±»ï¼‰
â””â”€â”€ TypeParameterElementï¼ˆæ³›å‹å‚æ•°ï¼‰
```

**ç¤ºä¾‹ä»£ç **ï¼š

```java
@AutoBuilder
public class User<T> {  // TypeElement
    private String name;  // VariableElement

    public User(String name) {  // ExecutableElement
        this.name = name;  // VariableElementï¼ˆå‚æ•°ï¼‰
    }

    public String getName() {  // ExecutableElement
        return name;
    }
}
```

### 4.2 å¸¸ç”¨Element API

```java
// 1. è·å–å…ƒç´ ä¿¡æ¯
Element element = ...;
String simpleName = element.getSimpleName().toString();  // ç®€å•åç§°
ElementKind kind = element.getKind();  // å…ƒç´ ç±»å‹
Set<Modifier> modifiers = element.getModifiers();  // ä¿®é¥°ç¬¦

// 2. è·å–æ³¨è§£
AutoBuilder annotation = element.getAnnotation(AutoBuilder.class);
List<? extends AnnotationMirror> annotations = element.getAnnotationMirrors();

// 3. è·å–åŒ…å«çš„å…ƒç´ 
TypeElement classElement = (TypeElement) element;
List<? extends Element> enclosedElements = classElement.getEnclosedElements();

// 4. è·å–çˆ¶å…ƒç´ 
Element enclosingElement = element.getEnclosingElement();

// 5. ç±»å‹ç›¸å…³
TypeElement typeElement = (TypeElement) element;
TypeMirror superclass = typeElement.getSuperclass();  // çˆ¶ç±»
List<? extends TypeMirror> interfaces = typeElement.getInterfaces();  // æ¥å£
```

### 4.3 TypeMirror vs Class

**ä¸ºä»€ä¹ˆä¸ç›´æ¥ä½¿ç”¨Classï¼Ÿ**

```java
// âŒ é”™è¯¯ï¼šåœ¨ç¼–è¯‘æœŸæ— æ³•åŠ è½½ç±»
Class<?> clazz = Class.forName("com.example.User");

// âœ… æ­£ç¡®ï¼šä½¿ç”¨TypeMirror
TypeMirror typeMirror = element.asType();
```

**åŸå› **ï¼š

1. ç¼–è¯‘æœŸç±»è¿˜æ²¡æœ‰ç”Ÿæˆå­—èŠ‚ç 
2. å¯èƒ½å­˜åœ¨å¾ªç¯ä¾èµ–
3. ç±»è·¯å¾„å¯èƒ½ä¸å®Œæ•´

**TypeMirrorçš„ä½¿ç”¨**ï¼š

```java
TypeMirror type = field.asType();

// åˆ¤æ–­ç±»å‹
if (type.getKind() == TypeKind.INT) {
    // åŸºæœ¬ç±»å‹int
}

// è·å–ç±»å‹åç§°
String typeName = type.toString();

// ç±»å‹æ¯”è¾ƒ
Types typeUtils = processingEnv.getTypeUtils();
TypeMirror stringType = processingEnv.getElementUtils()
    .getTypeElement("java.lang.String").asType();
if (typeUtils.isSameType(type, stringType)) {
    // æ˜¯Stringç±»å‹
}
```

---

## 5. ä½¿ç”¨JavaPoetä¼˜é›…ç”Ÿæˆä»£ç 

### 5.1 ä¸ºä»€ä¹ˆéœ€è¦JavaPoet

å‰é¢æˆ‘ä»¬ç”¨å­—ç¬¦ä¸²æ‹¼æ¥ç”Ÿæˆä»£ç ï¼Œå­˜åœ¨é—®é¢˜ï¼š

```java
// âŒ å­—ç¬¦ä¸²æ‹¼æ¥ï¼šå®¹æ˜“å‡ºé”™
out.println("public class " + className + " {");
out.println("    private " + fieldType + " " + fieldName + ";");
out.println("}");
```

**é—®é¢˜**ï¼š

1. ç¼©è¿›å®¹æ˜“é”™
2. è¯­æ³•é”™è¯¯éš¾å‘ç°
3. ä»£ç ä¸æ˜“ç»´æŠ¤
4. æ²¡æœ‰ç±»å‹æ£€æŸ¥

**JavaPoet**æ˜¯Squareå¼€å‘çš„ä»£ç ç”Ÿæˆåº“ï¼Œæä¾›æµå¼APIï¼š

```java
// âœ… JavaPoetï¼šç±»å‹å®‰å…¨ã€æ˜“ç»´æŠ¤
TypeSpec.Builder classBuilder = TypeSpec.classBuilder(className)
    .addModifiers(Modifier.PUBLIC)
    .addField(String.class, "name", Modifier.PRIVATE);
```

### 5.2 JavaPoetåŸºç¡€

**Mavenä¾èµ–**ï¼š

```xml
<dependency>
    <groupId>com.squareup</groupId>
    <artifactId>javapoet</artifactId>
    <version>1.13.0</version>
</dependency>
```

**æ ¸å¿ƒç±»**ï¼š

- `TypeSpec`ï¼šç±»/æ¥å£/æšä¸¾
- `MethodSpec`ï¼šæ–¹æ³•
- `FieldSpec`ï¼šå­—æ®µ
- `ParameterSpec`ï¼šå‚æ•°
- `AnnotationSpec`ï¼šæ³¨è§£
- `JavaFile`ï¼šJavaæ–‡ä»¶

### 5.3 ç”¨JavaPoeté‡å†™Builderç”Ÿæˆå™¨

```java
import com.squareup.javapoet.*;
import javax.lang.model.element.Modifier;

private void generateBuilderClass(TypeElement classElement) throws IOException {
    String className = classElement.getSimpleName().toString();
    String packageName = processingEnv.getElementUtils()
        .getPackageOf(classElement).toString();
    String builderClassName = className + "Builder";

    // 1. åˆ›å»ºBuilderç±»
    TypeSpec.Builder builderClass = TypeSpec.classBuilder(builderClassName)
        .addModifiers(Modifier.PUBLIC);

    // 2. æ·»åŠ å­—æ®µå’Œsetteræ–¹æ³•
    for (Element enclosed : classElement.getEnclosedElements()) {
        if (enclosed.getKind() == ElementKind.FIELD) {
            VariableElement field = (VariableElement) enclosed;
            String fieldName = field.getSimpleName().toString();
            TypeName fieldType = TypeName.get(field.asType());

            // æ·»åŠ å­—æ®µ
            builderClass.addField(
                FieldSpec.builder(fieldType, fieldName, Modifier.PRIVATE)
                    .build()
            );

            // æ·»åŠ setteræ–¹æ³•
            MethodSpec setter = MethodSpec.methodBuilder(fieldName)
                .addModifiers(Modifier.PUBLIC)
                .returns(ClassName.get(packageName, builderClassName))
                .addParameter(fieldType, fieldName)
                .addStatement("this.$N = $N", fieldName, fieldName)
                .addStatement("return this")
                .build();

            builderClass.addMethod(setter);
        }
    }

    // 3. æ·»åŠ buildæ–¹æ³•
    MethodSpec.Builder buildMethod = MethodSpec.methodBuilder("build")
        .addModifiers(Modifier.PUBLIC)
        .returns(ClassName.get(classElement))
        .addStatement("$T obj = new $T()",
                     ClassName.get(classElement),
                     ClassName.get(classElement));

    for (Element enclosed : classElement.getEnclosedElements()) {
        if (enclosed.getKind() == ElementKind.FIELD) {
            String fieldName = enclosed.getSimpleName().toString();
            buildMethod.addStatement("obj.$N = this.$N", fieldName, fieldName);
        }
    }

    buildMethod.addStatement("return obj");
    builderClass.addMethod(buildMethod.build());

    // 4. ç”Ÿæˆæ–‡ä»¶
    JavaFile javaFile = JavaFile.builder(packageName, builderClass.build())
        .build();

    javaFile.writeTo(filer);
}
```

**JavaPoetçš„ä¼˜åŠ¿**ï¼š

1. **ç±»å‹å®‰å…¨**ï¼šç¼–è¯‘æœŸæ£€æŸ¥
2. **è‡ªåŠ¨æ ¼å¼åŒ–**ï¼šç¼©è¿›ã€æ¢è¡Œè‡ªåŠ¨å¤„ç†
3. **æ˜“äºç»´æŠ¤**ï¼šç»“æ„æ¸…æ™°
4. **å ä½ç¬¦**ï¼š`$T`ï¼ˆç±»å‹ï¼‰ã€`$N`ï¼ˆåç§°ï¼‰ã€`$S`ï¼ˆå­—ç¬¦ä¸²ï¼‰ã€`$L`ï¼ˆå­—é¢é‡ï¼‰

### 5.4 JavaPoeté«˜çº§ç”¨æ³•

**1. ç”Ÿæˆå¸¦æ³›å‹çš„ç±»**ï¼š

```java
// ç”Ÿæˆï¼špublic class Container<T> { }
TypeSpec container = TypeSpec.classBuilder("Container")
    .addTypeVariable(TypeVariableName.get("T"))
    .addModifiers(Modifier.PUBLIC)
    .build();
```

**2. ç”Ÿæˆå¸¦æ³¨è§£çš„æ–¹æ³•**ï¼š

```java
// ç”Ÿæˆï¼š@Override public String toString() { }
MethodSpec toString = MethodSpec.methodBuilder("toString")
    .addAnnotation(Override.class)
    .addModifiers(Modifier.PUBLIC)
    .returns(String.class)
    .addStatement("return $S", "Hello")
    .build();
```

**3. ç”Ÿæˆæ§åˆ¶æµ**ï¼š

```java
MethodSpec validate = MethodSpec.methodBuilder("validate")
    .returns(void.class)
    .beginControlFlow("if (name == null)")
    .addStatement("throw new $T($S)",
                 IllegalArgumentException.class,
                 "nameä¸èƒ½ä¸ºç©º")
    .endControlFlow()
    .build();

// ç”Ÿæˆï¼š
// void validate() {
//     if (name == null) {
//         throw new IllegalArgumentException("nameä¸èƒ½ä¸ºç©º");
//     }
// }
```

**4. ç”Ÿæˆå¤æ‚è¡¨è¾¾å¼**ï¼š

```java
MethodSpec compute = MethodSpec.methodBuilder("compute")
    .returns(int.class)
    .addStatement("int result = 0")
    .beginControlFlow("for (int i = 0; i < 10; i++)")
    .addStatement("result += i")
    .endControlFlow()
    .addStatement("return result")
    .build();
```

---

## 6. Lombokçš„å®ç°åŸç†

### 6.1 Lombokç®€ä»‹

**Lombok**æ˜¯æœ€æµè¡Œçš„Javaä»£ç ç”Ÿæˆå·¥å…·ï¼Œé€šè¿‡æ³¨è§£è‡ªåŠ¨ç”Ÿæˆæ ·æ¿ä»£ç ã€‚

```java
@Data
@Builder
@AllArgsConstructor
@NoArgsConstructor
public class User {
    private String name;
    private int age;
}

// è‡ªåŠ¨ç”Ÿæˆï¼š
// - getter/setter
// - toString/equals/hashCode
// - Builderæ¨¡å¼
// - æ„é€ å™¨
```

### 6.2 Lombokçš„å·¥ä½œåŸç†

**Lombokä¸æ˜¯æ ‡å‡†çš„æ³¨è§£å¤„ç†å™¨ï¼**

æ ‡å‡†APTçš„é™åˆ¶ï¼š

- âœ… å¯ä»¥ç”Ÿæˆæ–°æ–‡ä»¶
- âŒ ä¸èƒ½ä¿®æ”¹å·²æœ‰æ–‡ä»¶

Lombokçš„åšæ³•ï¼š

- **ç›´æ¥ä¿®æ”¹æŠ½è±¡è¯­æ³•æ ‘ï¼ˆASTï¼‰**
- åœ¨ç¼–è¯‘æœŸæ’å…¥ä»£ç åˆ°åŸæœ‰ç±»ä¸­

```
æºä»£ç ï¼ˆUser.javaï¼‰
    â†“
[ç¼–è¯‘å™¨è§£æ] â†’ ç”ŸæˆAST
    â†“
[Lombokä»‹å…¥] â†’ ä¿®æ”¹ASTï¼ˆæ’å…¥getter/setterï¼‰
    â†“
[ç»§ç»­ç¼–è¯‘] â†’ åŸºäºä¿®æ”¹åçš„AST
    â†“
å­—èŠ‚ç ï¼ˆUser.classï¼‰
```

### 6.3 Lombokçš„å®ç°ç»†èŠ‚

**æ ¸å¿ƒæŠ€æœ¯**ï¼š

1. **JSR 269ï¼ˆæ³¨è§£å¤„ç†å™¨APIï¼‰**ï¼šä½œä¸ºå…¥å£
2. **Compiler Tree API**ï¼šä¿®æ”¹AST
3. **åå°„**ï¼šè®¿é—®ç¼–è¯‘å™¨å†…éƒ¨API

**ç®€åŒ–çš„å®ç°æµç¨‹**ï¼š

```java
// 1. å®ç°æ³¨è§£å¤„ç†å™¨
@SupportedAnnotationTypes("lombok.Data")
public class DataProcessor extends AbstractProcessor {

    @Override
    public boolean process(Set<? extends TypeElement> annotations,
                          RoundEnvironment roundEnv) {
        for (Element element : roundEnv.getElementsAnnotatedWith(Data.class)) {
            // 2. è·å–ç¼–è¯‘å™¨çš„AST
            JCTree tree = (JCTree) trees.getTree(element);

            // 3. ä½¿ç”¨TreeTranslatorä¿®æ”¹AST
            tree.accept(new TreeTranslator() {
                @Override
                public void visitClassDef(JCTree.JCClassDecl clazz) {
                    // 4. æ’å…¥getter/setteræ–¹æ³•
                    for (JCTree member : clazz.defs) {
                        if (member instanceof JCTree.JCVariableDecl) {
                            JCTree.JCVariableDecl field =
                                (JCTree.JCVariableDecl) member;

                            // ç”Ÿæˆgetter
                            clazz.defs = clazz.defs.append(
                                makeGetter(field)
                            );

                            // ç”Ÿæˆsetter
                            clazz.defs = clazz.defs.append(
                                makeSetter(field)
                            );
                        }
                    }
                    super.visitClassDef(clazz);
                }
            });
        }
        return true;
    }
}
```

**å…³é”®ç‚¹**ï¼š

- `JCTree`ï¼šjavacç¼–è¯‘å™¨çš„ASTèŠ‚ç‚¹
- `TreeTranslator`ï¼šASTè®¿é—®è€…æ¨¡å¼
- ç›´æ¥ä¿®æ”¹`clazz.defs`ï¼ˆç±»çš„æˆå‘˜åˆ—è¡¨ï¼‰

### 6.4 ä¸ºä»€ä¹ˆLombokæœ‰äº‰è®®

**ä¼˜ç‚¹**ï¼š

1. âœ… å‡å°‘æ ·æ¿ä»£ç 
2. âœ… æé«˜å¼€å‘æ•ˆç‡
3. âœ… ä»£ç æ›´ç®€æ´

**ç¼ºç‚¹**ï¼š

1. âŒ **ä¾èµ–ç¼–è¯‘å™¨å†…éƒ¨API**ï¼ˆä¸ç¨³å®šï¼‰
2. âŒ **IDEæ”¯æŒé—®é¢˜**ï¼ˆéœ€è¦å®‰è£…æ’ä»¶ï¼‰
3. âŒ **è°ƒè¯•å›°éš¾**ï¼ˆç”Ÿæˆçš„ä»£ç ä¸å¯è§ï¼‰
4. âŒ **ç ´åäº†Javaè§„èŒƒ**ï¼ˆä¿®æ”¹ASTæ˜¯éæ ‡å‡†è¡Œä¸ºï¼‰
5. âŒ **å‡çº§é£é™©**ï¼ˆJDKå‡çº§å¯èƒ½å¯¼è‡´Lombokå¤±æ•ˆï¼‰

**æ›¿ä»£æ–¹æ¡ˆ**ï¼š

- **Recordsï¼ˆJava 14+ï¼‰**ï¼šå®˜æ–¹æ”¯æŒçš„æ•°æ®ç±»
- **æ ‡å‡†APT**ï¼šç”Ÿæˆæ–°æ–‡ä»¶è€Œä¸æ˜¯ä¿®æ”¹åŸæ–‡ä»¶
- **IDEä»£ç ç”Ÿæˆ**ï¼šIDEAçš„GenerateåŠŸèƒ½

### 6.5 Records vs Lombok

**Java 14å¼•å…¥çš„Records**ï¼š

```java
// Lombokæ–¹å¼
@Data
@AllArgsConstructor
public class User {
    private final String name;
    private final int age;
}

// Recordsæ–¹å¼ï¼ˆå®˜æ–¹æ”¯æŒï¼‰
public record User(String name, int age) {
}

// è‡ªåŠ¨ç”Ÿæˆï¼š
// - æ„é€ å™¨
// - getterï¼ˆname()ã€age()ï¼‰
// - equals/hashCode/toString
// - ä¸å¯å˜ï¼ˆfinalå­—æ®µï¼‰
```

**å¯¹æ¯”**ï¼š


| ç‰¹æ€§         | Lombok            | Records  |
| ------------ | ----------------- | -------- |
| **å®˜æ–¹æ”¯æŒ** | âŒ                | âœ…       |
| **å¯å˜æ€§**   | å¯é€‰              | ä¸å¯å˜   |
| **è‡ªå®šä¹‰**   | çµæ´»              | å—é™     |
| **IDEæ”¯æŒ**  | éœ€æ’ä»¶            | åŸç”Ÿæ”¯æŒ |
| **ç¨³å®šæ€§**   | ä¾èµ–ç¼–è¯‘å™¨å†…éƒ¨API | è¯­è¨€ç‰¹æ€§ |

---

## 7. å®æˆ˜ï¼šç¼–å†™ä¸€ä¸ªå‚æ•°æ ¡éªŒå¤„ç†å™¨

### 7.1 éœ€æ±‚åˆ†æ

å®ç°ä¸€ä¸ª`@Validate`æ³¨è§£ï¼Œåœ¨ç¼–è¯‘æœŸç”Ÿæˆæ ¡éªŒä»£ç ï¼š

```java
public class User {
    @NotNull
    private String name;

    @Range(min = 0, max = 150)
    private int age;

    @Email
    private String email;
}

// è‡ªåŠ¨ç”Ÿæˆæ ¡éªŒæ–¹æ³•
public class UserValidator {
    public static void validate(User user) {
        if (user.name == null) {
            throw new ValidationException("nameä¸èƒ½ä¸ºç©º");
        }
        if (user.age < 0 || user.age > 150) {
            throw new ValidationException("ageå¿…é¡»åœ¨0-150ä¹‹é—´");
        }
        if (!user.email.matches("^[A-Za-z0-9+_.-]+@(.+)$")) {
            throw new ValidationException("emailæ ¼å¼ä¸æ­£ç¡®");
        }
    }
}
```

### 7.2 å®šä¹‰æ³¨è§£

```java
// NotNull.java
@Target(ElementType.FIELD)
@Retention(RetentionPolicy.SOURCE)
public @interface NotNull {
    String message() default "ä¸èƒ½ä¸ºç©º";
}

// Range.java
@Target(ElementType.FIELD)
@Retention(RetentionPolicy.SOURCE)
public @interface Range {
    int min() default Integer.MIN_VALUE;
    int max() default Integer.MAX_VALUE;
    String message() default "è¶…å‡ºèŒƒå›´";
}

// Email.java
@Target(ElementType.FIELD)
@Retention(RetentionPolicy.SOURCE)
public @interface Email {
    String message() default "é‚®ç®±æ ¼å¼ä¸æ­£ç¡®";
}

// Validate.javaï¼ˆç±»çº§åˆ«æ³¨è§£ï¼‰
@Target(ElementType.TYPE)
@Retention(RetentionPolicy.SOURCE)
public @interface Validate {
}
```

### 7.3 å®ç°å¤„ç†å™¨

```java
@AutoService(Processor.class)
@SupportedAnnotationTypes("com.example.validation.Validate")
@SupportedSourceVersion(SourceVersion.RELEASE_8)
public class ValidationProcessor extends AbstractProcessor {

    private Filer filer;
    private Messager messager;

    @Override
    public synchronized void init(ProcessingEnvironment processingEnv) {
        super.init(processingEnv);
        filer = processingEnv.getFiler();
        messager = processingEnv.getMessager();
    }

    @Override
    public boolean process(Set<? extends TypeElement> annotations,
                          RoundEnvironment roundEnv) {
        for (Element element : roundEnv.getElementsAnnotatedWith(Validate.class)) {
            if (element.getKind() != ElementKind.CLASS) {
                continue;
            }

            TypeElement classElement = (TypeElement) element;
            try {
                generateValidator(classElement);
            } catch (IOException e) {
                messager.printMessage(Diagnostic.Kind.ERROR,
                                     "ç”Ÿæˆæ ¡éªŒå™¨å¤±è´¥: " + e.getMessage());
            }
        }
        return true;
    }

    private void generateValidator(TypeElement classElement) throws IOException {
        String className = classElement.getSimpleName().toString();
        String packageName = processingEnv.getElementUtils()
            .getPackageOf(classElement).toString();
        String validatorClassName = className + "Validator";

        // åˆ›å»ºValidatorç±»
        TypeSpec.Builder validatorClass = TypeSpec.classBuilder(validatorClassName)
            .addModifiers(Modifier.PUBLIC);

        // åˆ›å»ºvalidateæ–¹æ³•
        MethodSpec.Builder validateMethod = MethodSpec.methodBuilder("validate")
            .addModifiers(Modifier.PUBLIC, Modifier.STATIC)
            .returns(void.class)
            .addParameter(ClassName.get(classElement), "obj")
            .addException(ClassName.get("com.example.validation",
                                       "ValidationException"));

        // éå†å­—æ®µï¼Œç”Ÿæˆæ ¡éªŒä»£ç 
        for (Element enclosed : classElement.getEnclosedElements()) {
            if (enclosed.getKind() != ElementKind.FIELD) {
                continue;
            }

            VariableElement field = (VariableElement) enclosed;
            String fieldName = field.getSimpleName().toString();

            // å¤„ç†@NotNull
            NotNull notNull = field.getAnnotation(NotNull.class);
            if (notNull != null) {
                validateMethod.beginControlFlow("if (obj.$N == null)", fieldName)
                    .addStatement("throw new $T($S)",
                                 ClassName.get("com.example.validation",
                                              "ValidationException"),
                                 notNull.message())
                    .endControlFlow();
            }

            // å¤„ç†@Range
            Range range = field.getAnnotation(Range.class);
            if (range != null) {
                validateMethod.beginControlFlow(
                    "if (obj.$N < $L || obj.$N > $L)",
                    fieldName, range.min(), fieldName, range.max())
                    .addStatement("throw new $T($S)",
                                 ClassName.get("com.example.validation",
                                              "ValidationException"),
                                 range.message())
                    .endControlFlow();
            }

            // å¤„ç†@Email
            Email email = field.getAnnotation(Email.class);
            if (email != null) {
                validateMethod.beginControlFlow(
                    "if (!obj.$N.matches($S))",
                    fieldName,
                    "^[A-Za-z0-9+_.-]+@(.+)$")
                    .addStatement("throw new $T($S)",
                                 ClassName.get("com.example.validation",
                                              "ValidationException"),
                                 email.message())
                    .endControlFlow();
            }
        }

        validatorClass.addMethod(validateMethod.build());

        // ç”Ÿæˆæ–‡ä»¶
        JavaFile javaFile = JavaFile.builder(packageName, validatorClass.build())
            .build();
        javaFile.writeTo(filer);

        messager.printMessage(Diagnostic.Kind.NOTE,
                             "ç”Ÿæˆæ ¡éªŒå™¨: " + validatorClassName);
    }
}
```

### 7.4 ä½¿ç”¨ç¤ºä¾‹

```java
@Validate
public class User {
    @NotNull(message = "ç”¨æˆ·åä¸èƒ½ä¸ºç©º")
    private String name;

    @Range(min = 18, max = 100, message = "å¹´é¾„å¿…é¡»åœ¨18-100ä¹‹é—´")
    private int age;

    @Email(message = "é‚®ç®±æ ¼å¼ä¸æ­£ç¡®")
    private String email;

    // getters and setters
}

// ä½¿ç”¨ç”Ÿæˆçš„æ ¡éªŒå™¨
public class Main {
    public static void main(String[] args) {
        User user = new User();
        user.setName("å¼ ä¸‰");
        user.setAge(25);
        user.setEmail("zhangsan@example.com");

        try {
            UserValidator.validate(user);
            System.out.println("æ ¡éªŒé€šè¿‡");
        } catch (ValidationException e) {
            System.out.println("æ ¡éªŒå¤±è´¥: " + e.getMessage());
        }
    }
}
```

---

## 8. è°ƒè¯•æ³¨è§£å¤„ç†å™¨

### 8.1 æ‰“å°æ—¥å¿—

ä½¿ç”¨`Messager`è¾“å‡ºæ—¥å¿—ï¼š

```java
Messager messager = processingEnv.getMessager();

// æ™®é€šä¿¡æ¯
messager.printMessage(Diagnostic.Kind.NOTE, "å¤„ç†ç±»: " + className);

// è­¦å‘Š
messager.printMessage(Diagnostic.Kind.WARNING, "å­—æ®µå¯èƒ½ä¸ºç©º", element);

// é”™è¯¯ï¼ˆä¼šå¯¼è‡´ç¼–è¯‘å¤±è´¥ï¼‰
messager.printMessage(Diagnostic.Kind.ERROR, "ä¸æ”¯æŒçš„ç±»å‹", element);
```

### 8.2 è¿œç¨‹è°ƒè¯•

**æ­¥éª¤1ï¼šé…ç½®Maven**

```xml
<plugin>
    <groupId>org.apache.maven.plugins</groupId>
    <artifactId>maven-compiler-plugin</artifactId>
    <version>3.8.1</version>
    <configuration>
        <fork>true</fork>
        <compilerArgs>
            <arg>-J-agentlib:jdwp=transport=dt_socket,server=y,suspend=y,address=5005</arg>
        </compilerArgs>
    </configuration>
</plugin>
```

**æ­¥éª¤2ï¼šå¯åŠ¨ç¼–è¯‘**

```bash
mvn clean compile
# ç­‰å¾…è°ƒè¯•å™¨è¿æ¥...
```

**æ­¥éª¤3ï¼šIDEAè¿æ¥è°ƒè¯•å™¨**

1. Run â†’ Edit Configurations
2. æ·»åŠ Remote JVM Debug
3. Host: localhost, Port: 5005
4. å¯åŠ¨è°ƒè¯•

### 8.3 æŸ¥çœ‹ç”Ÿæˆçš„ä»£ç 

**æ–¹æ³•1ï¼šæŸ¥çœ‹ç¼–è¯‘è¾“å‡ºç›®å½•**

```bash
# ç”Ÿæˆçš„æºæ–‡ä»¶åœ¨è¿™é‡Œ
target/generated-sources/annotations/
```

**æ–¹æ³•2ï¼šé…ç½®Mavenä¿ç•™ç”Ÿæˆçš„æ–‡ä»¶**

```xml
<plugin>
    <groupId>org.apache.maven.plugins</groupId>
    <artifactId>maven-compiler-plugin</artifactId>
    <configuration>
        <generatedSourcesDirectory>
            ${project.build.directory}/generated-sources/annotations
        </generatedSourcesDirectory>
    </configuration>
</plugin>
```

**æ–¹æ³•3ï¼šä½¿ç”¨`-verbose`é€‰é¡¹**

```bash
mvn clean compile -X
```

---

## 9. æ³¨è§£å¤„ç†å™¨çš„æœ€ä½³å®è·µ

### 9.1 è®¾è®¡åŸåˆ™

**1. å•ä¸€èŒè´£**

```java
// âŒ ä¸€ä¸ªå¤„ç†å™¨å¤„ç†å¤šç§æ³¨è§£
@SupportedAnnotationTypes({"com.example.*"})
public class MegaProcessor extends AbstractProcessor { }

// âœ… æ¯ä¸ªå¤„ç†å™¨ä¸“æ³¨ä¸€ä¸ªåŠŸèƒ½
@SupportedAnnotationTypes("com.example.AutoBuilder")
public class BuilderProcessor extends AbstractProcessor { }

@SupportedAnnotationTypes("com.example.Validate")
public class ValidationProcessor extends AbstractProcessor { }
```

**2. å¹‚ç­‰æ€§**

```java
// å¤„ç†å™¨å¯èƒ½è¢«å¤šæ¬¡è°ƒç”¨ï¼Œç¡®ä¿å¹‚ç­‰
private final Set<String> processedClasses = new HashSet<>();

@Override
public boolean process(...) {
    for (Element element : elements) {
        String className = element.toString();
        if (processedClasses.contains(className)) {
            continue;  // å·²å¤„ç†ï¼Œè·³è¿‡
        }
        processedClasses.add(className);
        // å¤„ç†...
    }
}
```

**3. é”™è¯¯å¤„ç†**

```java
try {
    generateCode(element);
} catch (Exception e) {
    // è¾“å‡ºå‹å¥½çš„é”™è¯¯ä¿¡æ¯
    messager.printMessage(
        Diagnostic.Kind.ERROR,
        "ç”Ÿæˆä»£ç å¤±è´¥: " + e.getMessage() +
        "\nè¯·æ£€æŸ¥æ³¨è§£ä½¿ç”¨æ˜¯å¦æ­£ç¡®",
        element
    );
}
```

### 9.2 æ€§èƒ½ä¼˜åŒ–

**1. é¿å…é‡å¤è®¡ç®—**

```java
// âŒ æ¯æ¬¡éƒ½æŸ¥è¯¢
for (Element element : elements) {
    TypeElement stringType = elementUtils.getTypeElement("java.lang.String");
}

// âœ… ç¼“å­˜å¸¸ç”¨ç±»å‹
private TypeElement stringType;

@Override
public void init(ProcessingEnvironment env) {
    super.init(env);
    stringType = env.getElementUtils().getTypeElement("java.lang.String");
}
```

**2. å»¶è¿Ÿç”Ÿæˆ**

```java
// æ”¶é›†æ‰€æœ‰éœ€è¦å¤„ç†çš„å…ƒç´ 
List<TypeElement> toProcess = new ArrayList<>();

for (Element element : roundEnv.getElementsAnnotatedWith(MyAnnotation.class)) {
    toProcess.add((TypeElement) element);
}

// æ‰¹é‡ç”Ÿæˆ
if (!toProcess.isEmpty()) {
    generateBatchCode(toProcess);
}
```

### 9.3 å…¼å®¹æ€§

**1. æ”¯æŒå¤šä¸ªJavaç‰ˆæœ¬**

```java
@Override
public SourceVersion getSupportedSourceVersion() {
    // æ”¯æŒæœ€æ–°ç‰ˆæœ¬
    return SourceVersion.latestSupported();
}
```

**2. å¤„ç†å¢é‡ç¼–è¯‘**

```java
@Override
public boolean process(Set<? extends TypeElement> annotations,
                      RoundEnvironment roundEnv) {
    // æ£€æŸ¥æ˜¯å¦æ˜¯æœ€åä¸€è½®
    if (roundEnv.processingOver()) {
        return false;
    }

    // åªå¤„ç†æ–°çš„å…ƒç´ 
    // ...
}
```

### 9.4 æµ‹è¯•

**å•å…ƒæµ‹è¯•**ï¼š

```java
@Test
public void testBuilderGeneration() {
    // ä½¿ç”¨Googleçš„compile-testingåº“
    JavaFileObject source = JavaFileObjects.forSourceString(
        "com.example.User",
        "package com.example;\n" +
        "@AutoBuilder\n" +
        "public class User {\n" +
        "    private String name;\n" +
        "}"
    );

    Compilation compilation = Compiler.javac()
        .withProcessors(new AutoBuilderProcessor())
        .compile(source);

    assertThat(compilation).succeeded();
    assertThat(compilation)
        .generatedSourceFile("com.example.UserBuilder")
        .hasSourceEquivalentTo(expectedBuilder);
}
```

**Mavenä¾èµ–**ï¼š

```xml
<dependency>
    <groupId>com.google.testing.compile</groupId>
    <artifactId>compile-testing</artifactId>
    <version>0.19</version>
    <scope>test</scope>
</dependency>
```

---

## 10. å¸¸è§é—®é¢˜ä¸é™·é˜±

### 10.1 æ— æ³•è®¿é—®ç”Ÿæˆçš„ç±»

**é—®é¢˜**ï¼š

```java
@AutoBuilder
public class User {
    private String name;
}

// ç¼–è¯‘é”™è¯¯ï¼šæ‰¾ä¸åˆ°UserBuilder
UserBuilder builder = new UserBuilder();
```

**åŸå› **ï¼š

- IDEæ²¡æœ‰è¯†åˆ«ç”Ÿæˆçš„ä»£ç 
- ç”Ÿæˆçš„ä»£ç è·¯å¾„ä¸åœ¨æºç è·¯å¾„ä¸­

**è§£å†³æ–¹æ¡ˆ**ï¼š

```xml
<!-- é…ç½®Maven -->
<plugin>
    <groupId>org.apache.maven.plugins</groupId>
    <artifactId>maven-compiler-plugin</artifactId>
    <configuration>
        <annotationProcessorPaths>
            <path>
                <groupId>com.example</groupId>
                <artifactId>my-processor</artifactId>
                <version>1.0.0</version>
            </path>
        </annotationProcessorPaths>
    </configuration>
</plugin>
```

**IDEAé…ç½®**ï¼š

1. Settings â†’ Build â†’ Compiler â†’ Annotation Processors
2. å‹¾é€‰"Enable annotation processing"
3. Store generated sources relative to: Module content root
4. Production sources directory: target/generated-sources/annotations

### 10.2 å¤„ç†å™¨æ²¡æœ‰æ‰§è¡Œ

**æ£€æŸ¥æ¸…å•**ï¼š

1. âœ… æ˜¯å¦æ³¨å†Œäº†å¤„ç†å™¨ï¼ˆMETA-INF/servicesæ–‡ä»¶ï¼‰
2. âœ… æ³¨è§£çš„`@Retention`æ˜¯å¦æ˜¯`SOURCE`æˆ–`CLASS`
3. âœ… `@SupportedAnnotationTypes`æ˜¯å¦æ­£ç¡®
4. âœ… Mavenä¾èµ–çš„scopeæ˜¯å¦æ­£ç¡®ï¼ˆåº”è¯¥æ˜¯`provided`ï¼‰

**è°ƒè¯•æ–¹æ³•**ï¼š

```java
@Override
public boolean process(...) {
    // æ·»åŠ æ—¥å¿—
    messager.printMessage(Diagnostic.Kind.NOTE, "å¤„ç†å™¨å·²æ‰§è¡Œ");

    // æ‰“å°æ‰€æœ‰æ³¨è§£
    for (TypeElement annotation : annotations) {
        messager.printMessage(Diagnostic.Kind.NOTE,
                             "å¤„ç†æ³¨è§£: " + annotation);
    }

    return true;
}
```

### 10.3 å¾ªç¯ä¾èµ–

**é—®é¢˜**ï¼š

```java
// A.java
@AutoBuilder
public class A {
    private B b;
}

// B.java
@AutoBuilder
public class B {
    private A a;
}
```

**è§£å†³æ–¹æ¡ˆ**ï¼š

- ä½¿ç”¨`TypeMirror`è€Œä¸æ˜¯ç›´æ¥å¼•ç”¨ç±»
- ç”Ÿæˆçš„ä»£ç ä½¿ç”¨å®Œå…¨é™å®šå

```java
// ç”Ÿæˆæ—¶ä½¿ç”¨å®Œå…¨é™å®šå
out.println("private com.example.B b;");
```

### 10.4 å¢é‡ç¼–è¯‘é—®é¢˜

**é—®é¢˜**ï¼šä¿®æ”¹æ³¨è§£åï¼Œç”Ÿæˆçš„ä»£ç æ²¡æœ‰æ›´æ–°

**è§£å†³æ–¹æ¡ˆ**ï¼š

```bash
# æ¸…ç†åé‡æ–°ç¼–è¯‘
mvn clean compile
```

**æˆ–è€…é…ç½®å¢é‡ç¼–è¯‘**ï¼š

```java
@SupportedOptions("org.gradle.annotation.processing.aggregating")
public class MyProcessor extends AbstractProcessor {
    // ...
}
```

---

## 11. å®æˆ˜æ¡ˆä¾‹ï¼šæµè¡Œæ¡†æ¶çš„APTåº”ç”¨

### 11.1 Daggerï¼ˆä¾èµ–æ³¨å…¥ï¼‰

**ä½¿ç”¨ç¤ºä¾‹**ï¼š

```java
@Module
public class AppModule {
    @Provides
    @Singleton
    UserService provideUserService() {
        return new UserServiceImpl();
    }
}

@Component(modules = AppModule.class)
public interface AppComponent {
    UserService userService();
}

// è‡ªåŠ¨ç”ŸæˆDaggerAppComponent
AppComponent component = DaggerAppComponent.create();
UserService service = component.userService();
```

**åŸç†**ï¼š

- æ‰«æ`@Module`ã€`@Provides`ã€`@Component`æ³¨è§£
- ç”Ÿæˆä¾èµ–æ³¨å…¥ä»£ç 
- ç¼–è¯‘æœŸæ£€æŸ¥ä¾èµ–å…³ç³»

### 11.2 Roomï¼ˆAndroidæ•°æ®åº“ï¼‰

**ä½¿ç”¨ç¤ºä¾‹**ï¼š

```java
@Entity
public class User {
    @PrimaryKey
    private int id;
    private String name;
}

@Dao
public interface UserDao {
    @Query("SELECT * FROM user")
    List<User> getAll();

    @Insert
    void insert(User user);
}

// è‡ªåŠ¨ç”ŸæˆUserDao_Impl
```

**åŸç†**ï¼š

- è§£æSQLè¯­å¥
- ç”Ÿæˆæ•°æ®åº“æ“ä½œä»£ç 
- ç¼–è¯‘æœŸéªŒè¯SQLè¯­æ³•

### 11.3 ButterKnifeï¼ˆAndroidè§†å›¾ç»‘å®šï¼‰

**ä½¿ç”¨ç¤ºä¾‹**ï¼š

```java
public class MainActivity extends Activity {
    @BindView(R.id.title)
    TextView title;

    @OnClick(R.id.button)
    void onButtonClick() {
        // ...
    }

    @Override
    protected void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        setContentView(R.layout.activity_main);
        ButterKnife.bind(this);  // è‡ªåŠ¨ç»‘å®š
    }
}
```

**åŸç†**ï¼š

- æ‰«æ`@BindView`ã€`@OnClick`æ³¨è§£
- ç”Ÿæˆ`findViewById`å’Œ`setOnClickListener`ä»£ç 

---

## 12. æ€»ç»“ä¸å±•æœ›

### 12.1 æ ¸å¿ƒè¦ç‚¹å›é¡¾

1. **APT vs åå°„**

   - APTï¼šç¼–è¯‘æœŸï¼Œé›¶è¿è¡Œæ—¶å¼€é”€
   - åå°„ï¼šè¿è¡ŒæœŸï¼Œæœ‰æ€§èƒ½æŸè€—
2. **æ³¨è§£å¤„ç†å™¨çš„å·¥ä½œæµç¨‹**

   - ç¼–è¯‘å™¨è§£ææºç  â†’ æ³¨è§£å¤„ç†å™¨æ‰«ææ³¨è§£ â†’ ç”Ÿæˆæ–°ä»£ç  â†’ ç»§ç»­ç¼–è¯‘
3. **Elementæ¨¡å‹**

   - `TypeElement`ï¼šç±»/æ¥å£
   - `VariableElement`ï¼šå­—æ®µ/å‚æ•°
   - `ExecutableElement`ï¼šæ–¹æ³•/æ„é€ å™¨
4. **ä»£ç ç”Ÿæˆå·¥å…·**

   - å­—ç¬¦ä¸²æ‹¼æ¥ï¼šç®€å•ä½†æ˜“é”™
   - JavaPoetï¼šç±»å‹å®‰å…¨ã€æ˜“ç»´æŠ¤
5. **Lombokçš„ç‰¹æ®Šæ€§**

   - ä¿®æ”¹ASTè€Œä¸æ˜¯ç”Ÿæˆæ–°æ–‡ä»¶
   - ä¾èµ–ç¼–è¯‘å™¨å†…éƒ¨API
   - æœ‰äº‰è®®ä½†å¾ˆæµè¡Œ

### 12.2 æœ€ä½³å®è·µæ€»ç»“


| åŸåˆ™         | è¯´æ˜                     |
| ------------ | ------------------------ |
| **å•ä¸€èŒè´£** | ä¸€ä¸ªå¤„ç†å™¨åªå¤„ç†ä¸€ç§æ³¨è§£ |
| **å¹‚ç­‰æ€§**   | å¤šæ¬¡è°ƒç”¨ç»“æœç›¸åŒ         |
| **é”™è¯¯å¤„ç†** | å‹å¥½çš„é”™è¯¯ä¿¡æ¯           |
| **æ€§èƒ½ä¼˜åŒ–** | ç¼“å­˜å¸¸ç”¨å¯¹è±¡             |
| **æµ‹è¯•**     | ä½¿ç”¨compile-testing      |

### 12.3 ä½•æ—¶ä½¿ç”¨APT

**é€‚åˆä½¿ç”¨APTçš„åœºæ™¯**ï¼š

- âœ… éœ€è¦ç”Ÿæˆå¤§é‡æ ·æ¿ä»£ç 
- âœ… éœ€è¦ç¼–è¯‘æœŸç±»å‹æ£€æŸ¥
- âœ… è¿½æ±‚é›¶è¿è¡Œæ—¶å¼€é”€
- âœ… ä»£ç ç”Ÿæˆè§„åˆ™æ˜ç¡®

**ä¸é€‚åˆä½¿ç”¨APTçš„åœºæ™¯**ï¼š

- âŒ éœ€è¦è¿è¡Œæ—¶åŠ¨æ€è¡Œä¸º
- âŒ è§„åˆ™è¿‡äºå¤æ‚
- âŒ å›¢é˜Ÿä¸ç†Ÿæ‚‰APT
- âŒ åªæ˜¯ç®€å•çš„é…ç½®

### 12.4 æœªæ¥è¶‹åŠ¿

1. **Recordsï¼ˆJava 14+ï¼‰**

   - å®˜æ–¹æ”¯æŒçš„æ•°æ®ç±»
   - å‡å°‘å¯¹Lombokçš„ä¾èµ–
2. **Pattern Matchingï¼ˆJava 16+ï¼‰**

   - ç®€åŒ–ç±»å‹åˆ¤æ–­
   - å‡å°‘æ ·æ¿ä»£ç 
3. **Project Valhalla**

   - å€¼ç±»å‹
   - è¿›ä¸€æ­¥ä¼˜åŒ–æ€§èƒ½
4. **æ›´å¥½çš„IDEæ”¯æŒ**

   - å®æ—¶é¢„è§ˆç”Ÿæˆçš„ä»£ç 
   - æ›´æ™ºèƒ½çš„ä»£ç è¡¥å…¨

---

## 13. ç»ƒä¹ ä¸æ€è€ƒ

### 13.1 ç»ƒä¹ é¢˜

**ç»ƒä¹ 1ï¼šå®ç°@Singletonæ³¨è§£**

- ç”Ÿæˆå•ä¾‹æ¨¡å¼ä»£ç 
- æ”¯æŒæ‡’åŠ è½½å’Œé¥¿æ±‰å¼

**ç»ƒä¹ 2ï¼šå®ç°@ToStringæ³¨è§£**

- è‡ªåŠ¨ç”ŸæˆtoStringæ–¹æ³•
- æ”¯æŒæ’é™¤æŸäº›å­—æ®µ

**ç»ƒä¹ 3ï¼šå®ç°@Immutableæ³¨è§£**

- ç”Ÿæˆä¸å¯å˜ç±»
- æ‰€æœ‰å­—æ®µfinal
- æä¾›Builder

### 13.2 æ€è€ƒé¢˜

**Q1: APTèƒ½å®Œå…¨æ›¿ä»£åå°„å—ï¼Ÿ**

- æç¤ºï¼šè€ƒè™‘åŠ¨æ€æ€§å’Œçµæ´»æ€§

**Q2: ä¸ºä»€ä¹ˆLombokä¸ä½¿ç”¨æ ‡å‡†APTï¼Ÿ**

- æç¤ºï¼šæ ‡å‡†APTçš„é™åˆ¶

**Q3: å¦‚ä½•åœ¨APTä¸­å¤„ç†æ³›å‹ï¼Ÿ**

- æç¤ºï¼šTypeMirrorå’Œç±»å‹æ“¦é™¤

**Q4: APTç”Ÿæˆçš„ä»£ç å¦‚ä½•è°ƒè¯•ï¼Ÿ**

- æç¤ºï¼šæŸ¥çœ‹ç”Ÿæˆçš„æºæ–‡ä»¶

**Q5: å¦‚ä½•æµ‹è¯•æ³¨è§£å¤„ç†å™¨ï¼Ÿ**

- æç¤ºï¼šcompile-testingåº“

---

## 14. å‚è€ƒèµ„æº

### 14.1 å®˜æ–¹æ–‡æ¡£

- [JSR 269: Pluggable Annotation Processing API](https://jcp.org/en/jsr/detail?id=269)
- [javax.annotation.processing API](https://docs.oracle.com/javase/8/docs/api/javax/annotation/processing/package-summary.html)
- [JavaPoet GitHub](https://github.com/square/javapoet)

### 14.2 å¼€æºé¡¹ç›®

- [Lombok](https://github.com/projectlombok/lombok)
- [Dagger](https://github.com/google/dagger)
- [AutoValue](https://github.com/google/auto/tree/master/value)
- [ButterKnife](https://github.com/JakeWharton/butterknife)

### 14.3 æ¨èé˜…è¯»

- ã€ŠEffective Javaã€‹ç¬¬3ç‰ˆ - Item 39-41ï¼ˆæ³¨è§£ç›¸å…³ï¼‰
- ã€ŠJavaç¼–è¯‘å™¨åŸç†ã€‹
- [The Hacker's Guide to Javac](http://scg.unibe.ch/archive/projects/Erni08b.pdf)

---

## ä¸‹ä¸€ç« é¢„å‘Š

ä¸‹ä¸€ç« æˆ‘ä»¬å°†æ¢è®¨ï¼š

- **æ³¨è§£ä¸AOPçš„ç»“åˆ**
- **Spring AOPçš„å®ç°åŸç†**
- **åŠ¨æ€ä»£ç† vs å­—èŠ‚ç å¢å¼º**
- **å¦‚ä½•å®ç°è‡ªå®šä¹‰çš„AOPæ¡†æ¶**

è®©æˆ‘ä»¬ç»§ç»­æ·±å…¥æ¢ç´¢æ³¨è§£çš„é«˜çº§åº”ç”¨ï¼

---

## é™„å½•ï¼šå®Œæ•´ç¤ºä¾‹ä»£ç 

### A.1 AutoBuilderå®Œæ•´å®ç°

è§æœ¬ç« 3.3èŠ‚çš„å®Œæ•´ä»£ç ã€‚

### A.2 ValidationProcessorå®Œæ•´å®ç°

è§æœ¬ç« 7.3èŠ‚çš„å®Œæ•´ä»£ç ã€‚

### A.3 é¡¹ç›®ç»“æ„ç¤ºä¾‹

```
annotation-processor-demo/
â”œâ”€â”€ processor/                    # æ³¨è§£å¤„ç†å™¨æ¨¡å—
â”‚   â”œâ”€â”€ src/main/java/
â”‚   â”‚   â””â”€â”€ com/example/processor/
â”‚   â”‚       â”œâ”€â”€ AutoBuilder.java
â”‚   â”‚       â””â”€â”€ AutoBuilderProcessor.java
â”‚   â”œâ”€â”€ src/main/resources/
â”‚   â”‚   â””â”€â”€ META-INF/services/
â”‚   â”‚       â””â”€â”€ javax.annotation.processing.Processor
â”‚   â””â”€â”€ pom.xml
â”‚
â”œâ”€â”€ app/                          # åº”ç”¨æ¨¡å—
â”‚   â”œâ”€â”€ src/main/java/
â”‚   â”‚   â””â”€â”€ com/example/app/
â”‚   â”‚       â”œâ”€â”€ User.java
â”‚   â”‚       â””â”€â”€ Main.java
â”‚   â””â”€â”€ pom.xml
â”‚
â””â”€â”€ pom.xml                       # çˆ¶POM
```

### A.4 Mavené…ç½®ç¤ºä¾‹

**çˆ¶POM**ï¼š

```xml
<project>
    <groupId>com.example</groupId>
    <artifactId>annotation-processor-demo</artifactId>
    <version>1.0.0</version>
    <packaging>pom</packaging>

    <modules>
        <module>processor</module>
        <module>app</module>
    </modules>

    <properties>
        <maven.compiler.source>8</maven.compiler.source>
        <maven.compiler.target>8</maven.compiler.target>
    </properties>
</project>
```

**processoræ¨¡å—POM**ï¼š

```xml
<project>
    <parent>
        <groupId>com.example</groupId>
        <artifactId>annotation-processor-demo</artifactId>
        <version>1.0.0</version>
    </parent>

    <artifactId>processor</artifactId>

    <dependencies>
        <dependency>
            <groupId>com.google.auto.service</groupId>
            <artifactId>auto-service</artifactId>
            <version>1.0.1</version>
            <optional>true</optional>
        </dependency>
        <dependency>
            <groupId>com.squareup</groupId>
            <artifactId>javapoet</artifactId>
            <version>1.13.0</version>
        </dependency>
    </dependencies>
</project>
```

**appæ¨¡å—POM**ï¼š

```xml
<project>
    <parent>
        <groupId>com.example</groupId>
        <artifactId>annotation-processor-demo</artifactId>
        <version>1.0.0</version>
    </parent>

    <artifactId>app</artifactId>

    <dependencies>
        <dependency>
            <groupId>com.example</groupId>
            <artifactId>processor</artifactId>
            <version>1.0.0</version>
            <scope>provided</scope>
        </dependency>
    </dependencies>

    <build>
        <plugins>
            <plugin>
                <groupId>org.apache.maven.plugins</groupId>
                <artifactId>maven-compiler-plugin</artifactId>
                <version>3.8.1</version>
                <configuration>
                    <annotationProcessorPaths>
                        <path>
                            <groupId>com.example</groupId>
                            <artifactId>processor</artifactId>
                            <version>1.0.0</version>
                        </path>
                    </annotationProcessorPaths>
                </configuration>
            </plugin>
        </plugins>
    </build>
</project>
```

---

**æœ¬ç« å®Œ**

å¸Œæœ›é€šè¿‡æœ¬ç« çš„å­¦ä¹ ï¼Œä½ å·²ç»æŒæ¡äº†ï¼š

1. âœ… æ³¨è§£å¤„ç†å™¨çš„å·¥ä½œåŸç†
2. âœ… å¦‚ä½•ç¼–å†™è‡ªå·±çš„æ³¨è§£å¤„ç†å™¨
3. âœ… Lombokçš„å®ç°åŸç†
4. âœ… ä½¿ç”¨JavaPoetä¼˜é›…ç”Ÿæˆä»£ç 
5. âœ… APTçš„æœ€ä½³å®è·µå’Œå¸¸è§é™·é˜±

ä¸‹ä¸€ç« è§ï¼ğŸš€
