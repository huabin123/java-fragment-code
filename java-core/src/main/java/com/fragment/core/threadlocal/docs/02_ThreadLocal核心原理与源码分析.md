# ç¬¬äºŒç« ï¼šThreadLocalæ ¸å¿ƒåŸç†ä¸æºç åˆ†æ

## å¼•è¨€

ç†è§£äº†ThreadLocalçš„å¿…è¦æ€§åï¼Œæœ¬ç« å°†æ·±å…¥æºç ï¼Œå‰–æThreadLocalçš„æ ¸å¿ƒå®ç°åŸç†ã€‚æˆ‘ä»¬å°†æ­ç¤ºThreadLocalMapçš„ç²¾å¦™è®¾è®¡ã€ç¥å¥‡çš„æ–æ³¢é‚£å¥‘æ•£åˆ—ç®—æ³•ï¼Œä»¥åŠä¸ºä»€ä¹ˆEntryè¦ä½¿ç”¨å¼±å¼•ç”¨ã€‚

---

## 1. ThreadLocalçš„æ ¸å¿ƒæ•°æ®ç»“æ„

### 1.1 é—®é¢˜1ï¼šThreadLocalçš„æ•°æ®å­˜å‚¨åœ¨å“ªé‡Œï¼Ÿ

**å…³é”®è®¤çŸ¥**ï¼š**æ•°æ®ä¸æ˜¯å­˜å‚¨åœ¨ThreadLocalå¯¹è±¡ä¸­ï¼Œè€Œæ˜¯å­˜å‚¨åœ¨Threadå¯¹è±¡ä¸­ï¼**

**æ•°æ®ç»“æ„å…³ç³»å›¾**ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Threadå¯¹è±¡                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  ThreadLocal.ThreadLocalMap threadLocals          â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚  â”‚  Entry[] table                              â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”    â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”‚ Entry[0] â”‚ Entry[1] â”‚ Entry[2] â”‚...â”‚    â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”˜    â”‚  â”‚  â”‚
â”‚  â”‚  â”‚                                             â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  Entryç»“æ„ï¼š                                 â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”‚  WeakReference<ThreadLocal<?>> key  â”‚   â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”‚  Object value                       â”‚   â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚  â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ThreadLocalå¯¹è±¡ï¼ˆåªæ˜¯ä¸€ä¸ªè®¿é—®å·¥å…·ï¼‰
  â†“
é€šè¿‡Thread.currentThread()è·å–å½“å‰çº¿ç¨‹
  â†“
è®¿é—®çº¿ç¨‹çš„threadLocalså­—æ®µ
  â†“
åœ¨ThreadLocalMapä¸­å­˜å–æ•°æ®
```

**Threadç±»çš„æºç **ï¼š

```java
public class Thread implements Runnable {
    // ThreadLocalçš„æ•°æ®å­˜å‚¨åœ¨è¿™é‡Œ
    ThreadLocal.ThreadLocalMap threadLocals = null;
    
    // InheritableThreadLocalçš„æ•°æ®å­˜å‚¨åœ¨è¿™é‡Œ
    ThreadLocal.ThreadLocalMap inheritableThreadLocals = null;
}
```

---

### 1.2 é—®é¢˜2ï¼šä¸ºä»€ä¹ˆè¦è¿™æ ·è®¾è®¡ï¼Ÿ

**è®¾è®¡æ€æƒ³åˆ†æ**ï¼š

```
æ–¹æ¡ˆAï¼šæ•°æ®å­˜å‚¨åœ¨ThreadLocalå¯¹è±¡ä¸­
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ThreadLocalå¯¹è±¡                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Map<Thread, Object>       â”‚  â”‚
â”‚  â”‚  â”œâ”€ Thread-1 â†’ value1      â”‚  â”‚
â”‚  â”‚  â”œâ”€ Thread-2 â†’ value2      â”‚  â”‚
â”‚  â”‚  â””â”€ Thread-3 â†’ value3      â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

é—®é¢˜ï¼š
1. éœ€è¦ä½¿ç”¨ConcurrentHashMapï¼Œæœ‰é”ç«äº‰
2. Threadå¯¹è±¡ä½œä¸ºkeyï¼Œå¯èƒ½å¯¼è‡´Threadæ— æ³•è¢«GC
3. å¤šä¸ªThreadLocalå¯¹è±¡ï¼Œæ¯ä¸ªéƒ½è¦ç»´æŠ¤ä¸€ä¸ªMap

æ–¹æ¡ˆBï¼šæ•°æ®å­˜å‚¨åœ¨Threadå¯¹è±¡ä¸­ï¼ˆå®é™…æ–¹æ¡ˆï¼‰
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Threadå¯¹è±¡                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  ThreadLocalMap            â”‚  â”‚
â”‚  â”‚  â”œâ”€ ThreadLocal1 â†’ value1  â”‚  â”‚
â”‚  â”‚  â”œâ”€ ThreadLocal2 â†’ value2  â”‚  â”‚
â”‚  â”‚  â””â”€ ThreadLocal3 â†’ value3  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ä¼˜åŠ¿ï¼š
1. æ— éœ€é”ï¼Œæ¯ä¸ªçº¿ç¨‹è®¿é—®è‡ªå·±çš„Map
2. Threadç»“æŸæ—¶ï¼ŒMapè‡ªåŠ¨è¢«GC
3. æ‰€æœ‰ThreadLocalå…±äº«ä¸€ä¸ªMapï¼ŒèŠ‚çœå†…å­˜
```

---

## 2. ThreadLocalMapçš„å®ç°åŸç†

### 2.1 é—®é¢˜3ï¼šThreadLocalMapçš„æ ¸å¿ƒç»“æ„æ˜¯ä»€ä¹ˆï¼Ÿ

**ThreadLocalMapæºç **ï¼š

```java
static class ThreadLocalMap {
    
    /**
     * Entryç»§æ‰¿WeakReferenceï¼Œkeyæ˜¯å¼±å¼•ç”¨
     */
    static class Entry extends WeakReference<ThreadLocal<?>> {
        Object value;
        
        Entry(ThreadLocal<?> k, Object v) {
            super(k); // keyæ˜¯å¼±å¼•ç”¨
            value = v;
        }
    }
    
    /**
     * åˆå§‹å®¹é‡ï¼Œå¿…é¡»æ˜¯2çš„å¹‚
     */
    private static final int INITIAL_CAPACITY = 16;
    
    /**
     * Entryæ•°ç»„ï¼Œé•¿åº¦å¿…é¡»æ˜¯2çš„å¹‚
     */
    private Entry[] table;
    
    /**
     * å…ƒç´ ä¸ªæ•°
     */
    private int size = 0;
    
    /**
     * æ‰©å®¹é˜ˆå€¼ï¼Œé»˜è®¤ä¸ºå®¹é‡çš„2/3
     */
    private int threshold;
    
    /**
     * è®¾ç½®æ‰©å®¹é˜ˆå€¼
     */
    private void setThreshold(int len) {
        threshold = len * 2 / 3;
    }
}
```

**å…³é”®è®¾è®¡**ï¼š

1. **Entryæ•°ç»„**ï¼šä½¿ç”¨æ•°ç»„è€Œéé“¾è¡¨
2. **å®¹é‡æ˜¯2çš„å¹‚**ï¼šä¾¿äºä½è¿ç®—ä¼˜åŒ–
3. **Entryç»§æ‰¿WeakReference**ï¼škeyæ˜¯å¼±å¼•ç”¨
4. **æ‰©å®¹é˜ˆå€¼æ˜¯2/3**ï¼šè€ŒéHashMapçš„3/4

---

### 2.2 é—®é¢˜4ï¼šç¥å¥‡çš„æ–æ³¢é‚£å¥‘æ•£åˆ—æ˜¯ä»€ä¹ˆï¼Ÿ

**ThreadLocalçš„hashCodeç”Ÿæˆ**ï¼š

```java
public class ThreadLocal<T> {
    private final int threadLocalHashCode = nextHashCode();
    
    private static AtomicInteger nextHashCode = new AtomicInteger();
    
    /**
     * ç¥å¥‡çš„æ•°å­—ï¼š0x61c88647
     * è¿™æ˜¯æ–æ³¢é‚£å¥‘æ•£åˆ—çš„é»„é‡‘åˆ†å‰²æ•°
     */
    private static final int HASH_INCREMENT = 0x61c88647;
    
    private static int nextHashCode() {
        return nextHashCode.getAndAdd(HASH_INCREMENT);
    }
}
```

**ä¸ºä»€ä¹ˆæ˜¯0x61c88647ï¼Ÿ**

```
æ•°å­¦åŸç†ï¼š
é»„é‡‘åˆ†å‰²æ¯” Ï† = (âˆš5 - 1) / 2 â‰ˆ 0.618033988749895

2^32 Ã— Ï† = 2654435769 = 0x9e3779b9

0x61c88647 = 2^32 - 0x9e3779b9

ä½œç”¨ï¼š
- ä½¿ç”¨è¿™ä¸ªå¢é‡ï¼Œå¯ä»¥è®©hashå€¼å‡åŒ€åˆ†å¸ƒ
- å‡å°‘hashå†²çª
- ç‰¹åˆ«é€‚åˆ2çš„å¹‚æ¬¡æ–¹å¤§å°çš„æ•°ç»„
```

**æ•£åˆ—æ•ˆæœæ¼”ç¤º**ï¼š

```java
public class HashDemo {
    private static final int HASH_INCREMENT = 0x61c88647;
    
    public static void main(String[] args) {
        int hashCode = 0;
        
        // æ¨¡æ‹Ÿ16ä¸ªThreadLocalçš„hashåˆ†å¸ƒ
        System.out.println("å®¹é‡16çš„æ•£åˆ—åˆ†å¸ƒï¼š");
        for (int i = 0; i < 16; i++) {
            hashCode += HASH_INCREMENT;
            int index = hashCode & (16 - 1); // ç­‰ä»·äº hashCode % 16
            System.out.println("ThreadLocal-" + i + " â†’ index: " + index);
        }
    }
}
```

**è¾“å‡ºç»“æœ**ï¼š

```
å®¹é‡16çš„æ•£åˆ—åˆ†å¸ƒï¼š
ThreadLocal-0 â†’ index: 7
ThreadLocal-1 â†’ index: 14
ThreadLocal-2 â†’ index: 5
ThreadLocal-3 â†’ index: 12
ThreadLocal-4 â†’ index: 3
ThreadLocal-5 â†’ index: 10
ThreadLocal-6 â†’ index: 1
ThreadLocal-7 â†’ index: 8
ThreadLocal-8 â†’ index: 15
ThreadLocal-9 â†’ index: 6
ThreadLocal-10 â†’ index: 13
ThreadLocal-11 â†’ index: 4
ThreadLocal-12 â†’ index: 11
ThreadLocal-13 â†’ index: 2
ThreadLocal-14 â†’ index: 9
ThreadLocal-15 â†’ index: 0

å®Œç¾åˆ†å¸ƒï¼æ²¡æœ‰ä»»ä½•å†²çªï¼
```

**ä¸ºä»€ä¹ˆè¿™ä¹ˆç¥å¥‡ï¼Ÿ**

```
æ–æ³¢é‚£å¥‘æ•£åˆ—çš„æ•°å­¦ç‰¹æ€§ï¼š
1. å¯¹äº2çš„å¹‚æ¬¡æ–¹å¤§å°çš„æ•°ç»„ï¼Œä½¿ç”¨é»„é‡‘åˆ†å‰²æ•°ä½œä¸ºå¢é‡
2. å¯ä»¥ä¿è¯å‰Nä¸ªå…ƒç´ ï¼ˆNâ‰¤æ•°ç»„å¤§å°ï¼‰å®Œå…¨ä¸å†²çª
3. è¿™æ˜¯æ•°å­¦ä¸Šè¯æ˜çš„æœ€ä¼˜æ•£åˆ—æ–¹å¼

å¯¹æ¯”HashMapçš„æ•£åˆ—ï¼š
HashMap: ä½¿ç”¨é“¾è¡¨/çº¢é»‘æ ‘å¤„ç†å†²çª
ThreadLocalMap: ä½¿ç”¨å¼€æ”¾å¯»å€æ³•ï¼Œä½†é€šè¿‡æ–æ³¢é‚£å¥‘æ•£åˆ—å‡å°‘å†²çª
```

---

## 3. ThreadLocalçš„æ ¸å¿ƒæ–¹æ³•

### 3.1 é—®é¢˜5ï¼šset()æ–¹æ³•çš„å®Œæ•´æµç¨‹æ˜¯ä»€ä¹ˆï¼Ÿ

**set()æ–¹æ³•æºç **ï¼š

```java
public void set(T value) {
    // 1. è·å–å½“å‰çº¿ç¨‹
    Thread t = Thread.currentThread();
    
    // 2. è·å–å½“å‰çº¿ç¨‹çš„ThreadLocalMap
    ThreadLocalMap map = getMap(t);
    
    if (map != null)
        // 3. å¦‚æœmapå­˜åœ¨ï¼Œç›´æ¥è®¾ç½®å€¼
        map.set(this, value);
    else
        // 4. å¦‚æœmapä¸å­˜åœ¨ï¼Œåˆ›å»ºmapå¹¶è®¾ç½®å€¼
        createMap(t, value);
}

ThreadLocalMap getMap(Thread t) {
    return t.threadLocals;
}

void createMap(Thread t, T firstValue) {
    t.threadLocals = new ThreadLocalMap(this, firstValue);
}
```

**ThreadLocalMap.set()æºç **ï¼š

```java
private void set(ThreadLocal<?> key, Object value) {
    Entry[] tab = table;
    int len = tab.length;
    
    // 1. è®¡ç®—ç´¢å¼•ä½ç½®
    int i = key.threadLocalHashCode & (len - 1);
    
    // 2. çº¿æ€§æ¢æµ‹æ³•æŸ¥æ‰¾ä½ç½®
    for (Entry e = tab[i];
         e != null;
         e = tab[i = nextIndex(i, len)]) {
        
        ThreadLocal<?> k = e.get();
        
        // 2.1 keyç›¸åŒï¼Œæ›´æ–°value
        if (k == key) {
            e.value = value;
            return;
        }
        
        // 2.2 keyä¸ºnullï¼ˆè¢«GCå›æ”¶ï¼‰ï¼Œæ›¿æ¢è¿‡æœŸEntry
        if (k == null) {
            replaceStaleEntry(key, value, i);
            return;
        }
    }
    
    // 3. æ‰¾åˆ°ç©ºä½ç½®ï¼Œåˆ›å»ºæ–°Entry
    tab[i] = new Entry(key, value);
    int sz = ++size;
    
    // 4. æ¸…ç†è¿‡æœŸEntryï¼Œå¦‚æœæ¸…ç†åä»è¶…è¿‡é˜ˆå€¼ï¼Œåˆ™æ‰©å®¹
    if (!cleanSomeSlots(i, sz) && sz >= threshold)
        rehash();
}

/**
 * ä¸‹ä¸€ä¸ªç´¢å¼•ï¼ˆçº¿æ€§æ¢æµ‹ï¼‰
 */
private static int nextIndex(int i, int len) {
    return ((i + 1 < len) ? i + 1 : 0);
}
```

**set()æµç¨‹å›¾**ï¼š

```
set(value)
    â†“
è·å–å½“å‰çº¿ç¨‹çš„ThreadLocalMap
    â†“
mapå­˜åœ¨ï¼Ÿ
    â†“ å¦
åˆ›å»ºThreadLocalMap
    â†“ æ˜¯
è®¡ç®—ç´¢å¼•ï¼ši = hashCode & (len - 1)
    â†“
æ£€æŸ¥tab[i]
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â†“                               â†“
tab[i] == null              tab[i] != null
    â†“                               â†“
åˆ›å»ºæ–°Entry              çº¿æ€§æ¢æµ‹æŸ¥æ‰¾
    â†“                       â†“
size++                  â”Œâ”€â”€â”€â”´â”€â”€â”€â”
    â†“                   â†“       â†“
æ¸…ç†è¿‡æœŸEntry        keyç›¸åŒ   keyä¸ºnull
    â†“                   â†“       â†“
size >= threshold?   æ›´æ–°value  æ›¿æ¢è¿‡æœŸEntry
    â†“ æ˜¯
æ‰©å®¹rehash()
```

---

### 3.2 é—®é¢˜6ï¼šget()æ–¹æ³•çš„å®Œæ•´æµç¨‹æ˜¯ä»€ä¹ˆï¼Ÿ

**get()æ–¹æ³•æºç **ï¼š

```java
public T get() {
    // 1. è·å–å½“å‰çº¿ç¨‹
    Thread t = Thread.currentThread();
    
    // 2. è·å–å½“å‰çº¿ç¨‹çš„ThreadLocalMap
    ThreadLocalMap map = getMap(t);
    
    if (map != null) {
        // 3. ä»mapä¸­è·å–Entry
        ThreadLocalMap.Entry e = map.getEntry(this);
        if (e != null) {
            @SuppressWarnings("unchecked")
            T result = (T)e.value;
            return result;
        }
    }
    
    // 4. mapä¸å­˜åœ¨æˆ–Entryä¸å­˜åœ¨ï¼Œè¿”å›åˆå§‹å€¼
    return setInitialValue();
}

private T setInitialValue() {
    // è°ƒç”¨initialValue()è·å–åˆå§‹å€¼
    T value = initialValue();
    Thread t = Thread.currentThread();
    ThreadLocalMap map = getMap(t);
    if (map != null)
        map.set(this, value);
    else
        createMap(t, value);
    return value;
}

/**
 * å­ç±»å¯ä»¥é‡å†™æ­¤æ–¹æ³•æä¾›åˆå§‹å€¼
 */
protected T initialValue() {
    return null;
}
```

**ThreadLocalMap.getEntry()æºç **ï¼š

```java
private Entry getEntry(ThreadLocal<?> key) {
    // 1. è®¡ç®—ç´¢å¼•
    int i = key.threadLocalHashCode & (table.length - 1);
    Entry e = table[i];
    
    // 2. ç›´æ¥å‘½ä¸­
    if (e != null && e.get() == key)
        return e;
    else
        // 3. æœªå‘½ä¸­ï¼Œçº¿æ€§æ¢æµ‹æŸ¥æ‰¾
        return getEntryAfterMiss(key, i, e);
}

private Entry getEntryAfterMiss(ThreadLocal<?> key, int i, Entry e) {
    Entry[] tab = table;
    int len = tab.length;
    
    // çº¿æ€§æ¢æµ‹
    while (e != null) {
        ThreadLocal<?> k = e.get();
        
        // æ‰¾åˆ°åŒ¹é…çš„key
        if (k == key)
            return e;
        
        // keyä¸ºnullï¼Œæ¸…ç†è¿‡æœŸEntry
        if (k == null)
            expungeStaleEntry(i);
        else
            i = nextIndex(i, len);
        
        e = tab[i];
    }
    return null;
}
```

**get()æµç¨‹å›¾**ï¼š

```
get()
    â†“
è·å–å½“å‰çº¿ç¨‹çš„ThreadLocalMap
    â†“
mapå­˜åœ¨ï¼Ÿ
    â†“ å¦
è°ƒç”¨setInitialValue()
    â†“ æ˜¯
è®¡ç®—ç´¢å¼•ï¼ši = hashCode & (len - 1)
    â†“
æ£€æŸ¥tab[i]
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â†“                               â†“
tab[i].key == this          tab[i].key != this
    â†“                               â†“
ç›´æ¥è¿”å›value              çº¿æ€§æ¢æµ‹æŸ¥æ‰¾
                                â†“
                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”
                        â†“               â†“
                    æ‰¾åˆ°åŒ¹é…         æœªæ‰¾åˆ°
                        â†“               â†“
                    è¿”å›value      è¿”å›null
```

---

### 3.3 é—®é¢˜7ï¼šremove()æ–¹æ³•çš„å®Œæ•´æµç¨‹æ˜¯ä»€ä¹ˆï¼Ÿ

**remove()æ–¹æ³•æºç **ï¼š

```java
public void remove() {
    // 1. è·å–å½“å‰çº¿ç¨‹çš„ThreadLocalMap
    ThreadLocalMap m = getMap(Thread.currentThread());
    
    if (m != null)
        // 2. ä»mapä¸­ç§»é™¤Entry
        m.remove(this);
}
```

**ThreadLocalMap.remove()æºç **ï¼š

```java
private void remove(ThreadLocal<?> key) {
    Entry[] tab = table;
    int len = tab.length;
    
    // 1. è®¡ç®—ç´¢å¼•
    int i = key.threadLocalHashCode & (len - 1);
    
    // 2. çº¿æ€§æ¢æµ‹æŸ¥æ‰¾
    for (Entry e = tab[i];
         e != null;
         e = tab[i = nextIndex(i, len)]) {
        
        // 3. æ‰¾åˆ°åŒ¹é…çš„Entry
        if (e.get() == key) {
            // 4. æ¸…é™¤å¼±å¼•ç”¨
            e.clear();
            
            // 5. æ¸…ç†è¿‡æœŸEntry
            expungeStaleEntry(i);
            return;
        }
    }
}
```

---

## 4. å¼€æ”¾å¯»å€æ³•ä¸çº¿æ€§æ¢æµ‹

### 4.1 é—®é¢˜8ï¼šThreadLocalMapå¦‚ä½•è§£å†³hashå†²çªï¼Ÿ

**HashMap vs ThreadLocalMap**ï¼š

```
HashMapçš„å†²çªè§£å†³ï¼šé“¾åœ°å€æ³•
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ•°ç»„                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”                          â”‚
â”‚  â”‚ 0  â”‚â†’ Entry1 â†’ Entry2 â†’ Entry3â”‚
â”‚  â”œâ”€â”€â”€â”€â”¤                          â”‚
â”‚  â”‚ 1  â”‚â†’ Entry4                  â”‚
â”‚  â”œâ”€â”€â”€â”€â”¤                          â”‚
â”‚  â”‚ 2  â”‚â†’ null                    â”‚
â”‚  â””â”€â”€â”€â”€â”˜                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ThreadLocalMapçš„å†²çªè§£å†³ï¼šå¼€æ”¾å¯»å€æ³•ï¼ˆçº¿æ€§æ¢æµ‹ï¼‰
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ•°ç»„                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”                          â”‚
â”‚  â”‚ 0  â”‚â†’ Entry1                  â”‚
â”‚  â”œâ”€â”€â”€â”€â”¤                          â”‚
â”‚  â”‚ 1  â”‚â†’ Entry2ï¼ˆå†²çªåç§»ï¼‰      â”‚
â”‚  â”œâ”€â”€â”€â”€â”¤                          â”‚
â”‚  â”‚ 2  â”‚â†’ Entry3ï¼ˆå†²çªåç§»ï¼‰      â”‚
â”‚  â””â”€â”€â”€â”€â”˜                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**çº¿æ€§æ¢æµ‹ç¤ºä¾‹**ï¼š

```java
// å‡è®¾å®¹é‡ä¸º16ï¼Œå·²æœ‰3ä¸ªEntry
// ThreadLocal1: hashCode & 15 = 5
// ThreadLocal2: hashCode & 15 = 5ï¼ˆå†²çªï¼ï¼‰
// ThreadLocal3: hashCode & 15 = 5ï¼ˆå†²çªï¼ï¼‰

å­˜å‚¨ç»“æœï¼š
â”Œâ”€â”€â”€â”€â”¬â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”
â”‚ 0  â”‚ 1  â”‚ 2  â”‚ 3  â”‚ 4  â”‚ 5  â”‚ 6  â”‚ 7  â”‚
â”œâ”€â”€â”€â”€â”¼â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”¤
â”‚nullâ”‚nullâ”‚nullâ”‚nullâ”‚nullâ”‚ E1 â”‚ E2 â”‚ E3 â”‚
â””â”€â”€â”€â”€â”´â”€â”€â”€â”€â”´â”€â”€â”€â”€â”´â”€â”€â”€â”€â”´â”€â”€â”€â”€â”´â”€â”€â”€â”€â”´â”€â”€â”€â”€â”´â”€â”€â”€â”€â”˜
                          â†‘    â†‘    â†‘
                        åŸä½  +1   +2
```

**ä¸ºä»€ä¹ˆThreadLocalMapä½¿ç”¨å¼€æ”¾å¯»å€æ³•ï¼Ÿ**

```
ä¼˜åŠ¿ï¼š
1. å†…å­˜å±€éƒ¨æ€§å¥½ï¼šæ•°æ®è¿ç»­å­˜å‚¨ï¼ŒCPUç¼“å­˜å‹å¥½
2. ä¸éœ€è¦é¢å¤–çš„Nodeå¯¹è±¡ï¼šèŠ‚çœå†…å­˜
3. æ–æ³¢é‚£å¥‘æ•£åˆ—å‡å°‘å†²çªï¼šå¤§éƒ¨åˆ†æƒ…å†µä¸‹ä¸éœ€è¦æ¢æµ‹

åŠ£åŠ¿ï¼š
1. åˆ é™¤æ“ä½œå¤æ‚ï¼šéœ€è¦å¤„ç†ç©ºæ´
2. è£…è½½å› å­ä¸èƒ½å¤ªé«˜ï¼šå¦åˆ™æ¢æµ‹æ¬¡æ•°å¢åŠ 

ä¸ºä»€ä¹ˆHashMapä¸ç”¨å¼€æ”¾å¯»å€æ³•ï¼Ÿ
- HashMapçš„ä½¿ç”¨åœºæ™¯æ›´é€šç”¨ï¼Œå†²çªå¯èƒ½æ›´å¤š
- é“¾åœ°å€æ³•åœ¨é«˜å†²çªæƒ…å†µä¸‹æ€§èƒ½æ›´ç¨³å®š
- ThreadLocalMapçš„ä½¿ç”¨åœºæ™¯ç‰¹æ®Šï¼Œå†²çªå°‘
```

---

## 5. è¿‡æœŸEntryçš„æ¸…ç†æœºåˆ¶

### 5.1 é—®é¢˜9ï¼šä»€ä¹ˆæ˜¯è¿‡æœŸEntryï¼Ÿå¦‚ä½•æ¸…ç†ï¼Ÿ

**è¿‡æœŸEntryçš„äº§ç”Ÿ**ï¼š

```
åœºæ™¯ï¼š
1. ThreadLocalå¯¹è±¡è¢«GCå›æ”¶
2. Entryçš„keyï¼ˆå¼±å¼•ç”¨ï¼‰å˜ä¸ºnull
3. ä½†Entryçš„valueä»ç„¶å­˜åœ¨

ç»“æœï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Entry                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  key: nullï¼ˆè¢«GCå›æ”¶ï¼‰  â”‚  â”‚
â”‚  â”‚  value: å¯¹è±¡ï¼ˆä»ç„¶å­˜åœ¨ï¼‰â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

è¿™å°±æ˜¯è¿‡æœŸEntryï¼Œéœ€è¦æ¸…ç†
```

**æ¸…ç†æ—¶æœº**ï¼š

1. **set()æ—¶æ¸…ç†**ï¼š`cleanSomeSlots()`
2. **get()æ—¶æ¸…ç†**ï¼š`expungeStaleEntry()`
3. **remove()æ—¶æ¸…ç†**ï¼š`expungeStaleEntry()`
4. **æ‰©å®¹æ—¶æ¸…ç†**ï¼š`rehash()`

**expungeStaleEntry()æºç **ï¼š

```java
/**
 * æ¸…ç†ä»staleSlotå¼€å§‹çš„è¿‡æœŸEntry
 * è¿”å›ä¸‹ä¸€ä¸ªnullä½ç½®çš„ç´¢å¼•
 */
private int expungeStaleEntry(int staleSlot) {
    Entry[] tab = table;
    int len = tab.length;
    
    // 1. æ¸…ç†staleSlotä½ç½®çš„Entry
    tab[staleSlot].value = null;
    tab[staleSlot] = null;
    size--;
    
    Entry e;
    int i;
    
    // 2. ä»staleSlotå¼€å§‹ï¼Œå‘åæ‰«æ
    for (i = nextIndex(staleSlot, len);
         (e = tab[i]) != null;
         i = nextIndex(i, len)) {
        
        ThreadLocal<?> k = e.get();
        
        // 2.1 keyä¸ºnullï¼Œæ¸…ç†
        if (k == null) {
            e.value = null;
            tab[i] = null;
            size--;
        } else {
            // 2.2 keyä¸ä¸ºnullï¼Œé‡æ–°hash
            int h = k.threadLocalHashCode & (len - 1);
            
            // å¦‚æœå½“å‰ä½ç½®ä¸æ˜¯ç†æƒ³ä½ç½®ï¼Œéœ€è¦ç§»åŠ¨
            if (h != i) {
                tab[i] = null;
                
                // ä»ç†æƒ³ä½ç½®å¼€å§‹ï¼Œæ‰¾åˆ°ç¬¬ä¸€ä¸ªç©ºä½
                while (tab[h] != null)
                    h = nextIndex(h, len);
                tab[h] = e;
            }
        }
    }
    return i;
}
```

**æ¸…ç†æµç¨‹å›¾**ï¼š

```
expungeStaleEntry(staleSlot)
    â†“
æ¸…ç†staleSlotä½ç½®çš„Entry
    â†“
ä»staleSlot+1å¼€å§‹å‘åæ‰«æ
    â†“
é‡åˆ°Entry
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â†“                       â†“
key == null         key != null
    â†“                   â†“
æ¸…ç†Entry          é‡æ–°hash
    â†“                   â†“
size--            ä½ç½®æ­£ç¡®ï¼Ÿ
                        â†“
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”
                â†“               â†“
                æ˜¯              å¦
                â†“               â†“
            ä¸ç§»åŠ¨          ç§»åŠ¨åˆ°æ­£ç¡®ä½ç½®
                        
ç»§ç»­æ‰«æï¼Œç›´åˆ°é‡åˆ°null
```

---

### 5.2 é—®é¢˜10ï¼šä¸ºä»€ä¹ˆéœ€è¦é‡æ–°hashï¼Ÿ

**é‡æ–°hashçš„åŸå› **ï¼š

```
åœºæ™¯ï¼š
åˆå§‹çŠ¶æ€ï¼ˆå®¹é‡16ï¼‰ï¼š
â”Œâ”€â”€â”€â”€â”¬â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”
â”‚ 0  â”‚ 1  â”‚ 2  â”‚ 3  â”‚ 4  â”‚ 5  â”‚ 6  â”‚ 7  â”‚
â”œâ”€â”€â”€â”€â”¼â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”¤
â”‚nullâ”‚nullâ”‚nullâ”‚ E1 â”‚ E2 â”‚ E3 â”‚nullâ”‚nullâ”‚
â””â”€â”€â”€â”€â”´â”€â”€â”€â”€â”´â”€â”€â”€â”€â”´â”€â”€â”€â”€â”´â”€â”€â”€â”€â”´â”€â”€â”€â”€â”´â”€â”€â”€â”€â”´â”€â”€â”€â”€â”˜
              â†‘    â†‘    â†‘
            hash=3 hash=3 hash=3
            ï¼ˆE2ã€E3å› å†²çªåç§»ï¼‰

E1è¢«GCå›æ”¶åï¼š
â”Œâ”€â”€â”€â”€â”¬â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”
â”‚ 0  â”‚ 1  â”‚ 2  â”‚ 3  â”‚ 4  â”‚ 5  â”‚ 6  â”‚ 7  â”‚
â”œâ”€â”€â”€â”€â”¼â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”¤
â”‚nullâ”‚nullâ”‚nullâ”‚nullâ”‚ E2 â”‚ E3 â”‚nullâ”‚nullâ”‚
â””â”€â”€â”€â”€â”´â”€â”€â”€â”€â”´â”€â”€â”€â”€â”´â”€â”€â”€â”€â”´â”€â”€â”€â”€â”´â”€â”€â”€â”€â”´â”€â”€â”€â”€â”´â”€â”€â”€â”€â”˜
                   â†‘    â†‘
                 hash=3 hash=3

é—®é¢˜ï¼š
- E2çš„ç†æƒ³ä½ç½®æ˜¯3ï¼Œä½†ç°åœ¨åœ¨4
- E3çš„ç†æƒ³ä½ç½®æ˜¯3ï¼Œä½†ç°åœ¨åœ¨5
- å¦‚æœä¸ç§»åŠ¨ï¼ŒæŸ¥æ‰¾æ•ˆç‡é™ä½

é‡æ–°hashåï¼š
â”Œâ”€â”€â”€â”€â”¬â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”
â”‚ 0  â”‚ 1  â”‚ 2  â”‚ 3  â”‚ 4  â”‚ 5  â”‚ 6  â”‚ 7  â”‚
â”œâ”€â”€â”€â”€â”¼â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”¤
â”‚nullâ”‚nullâ”‚nullâ”‚ E2 â”‚ E3 â”‚nullâ”‚nullâ”‚nullâ”‚
â””â”€â”€â”€â”€â”´â”€â”€â”€â”€â”´â”€â”€â”€â”€â”´â”€â”€â”€â”€â”´â”€â”€â”€â”€â”´â”€â”€â”€â”€â”´â”€â”€â”€â”€â”´â”€â”€â”€â”€â”˜
              â†‘    â†‘
            ç†æƒ³ä½ç½®
```

---

## 6. æ‰©å®¹æœºåˆ¶

### 6.1 é—®é¢˜11ï¼šThreadLocalMapå¦‚ä½•æ‰©å®¹ï¼Ÿ

**rehash()æºç **ï¼š

```java
private void rehash() {
    // 1. å…ˆæ¸…ç†æ‰€æœ‰è¿‡æœŸEntry
    expungeStaleEntries();
    
    // 2. æ¸…ç†åï¼Œå¦‚æœsizeä»ç„¶ >= thresholdçš„3/4ï¼Œåˆ™æ‰©å®¹
    if (size >= threshold - threshold / 4)
        resize();
}

/**
 * æ¸…ç†æ‰€æœ‰è¿‡æœŸEntry
 */
private void expungeStaleEntries() {
    Entry[] tab = table;
    int len = tab.length;
    for (int j = 0; j < len; j++) {
        Entry e = tab[j];
        if (e != null && e.get() == null)
            expungeStaleEntry(j);
    }
}

/**
 * æ‰©å®¹ä¸ºåŸæ¥çš„2å€
 */
private void resize() {
    Entry[] oldTab = table;
    int oldLen = oldTab.length;
    int newLen = oldLen * 2;
    Entry[] newTab = new Entry[newLen];
    int count = 0;
    
    // éå†æ—§æ•°ç»„
    for (int j = 0; j < oldLen; ++j) {
        Entry e = oldTab[j];
        if (e != null) {
            ThreadLocal<?> k = e.get();
            
            // keyä¸ºnullï¼Œæ¸…ç†
            if (k == null) {
                e.value = null;
            } else {
                // é‡æ–°hashåˆ°æ–°æ•°ç»„
                int h = k.threadLocalHashCode & (newLen - 1);
                while (newTab[h] != null)
                    h = nextIndex(h, newLen);
                newTab[h] = e;
                count++;
            }
        }
    }
    
    setThreshold(newLen);
    size = count;
    table = newTab;
}
```

**æ‰©å®¹æµç¨‹å›¾**ï¼š

```
size >= threshold?
    â†“ æ˜¯
è°ƒç”¨rehash()
    â†“
æ¸…ç†æ‰€æœ‰è¿‡æœŸEntry
    â†“
size >= threshold * 3/4?
    â†“ æ˜¯
æ‰©å®¹ä¸ºåŸæ¥çš„2å€
    â†“
éå†æ—§æ•°ç»„
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â†“                       â†“
Entry.key == null   Entry.key != null
    â†“                   â†“
æ¸…ç†Entry          é‡æ–°hashåˆ°æ–°æ•°ç»„
    â†“                   â†“
value = null       çº¿æ€§æ¢æµ‹æ‰¾ç©ºä½
                        â†“
                    æ’å…¥æ–°æ•°ç»„
```

---

## 7. æ ¸å¿ƒé—®é¢˜æ€»ç»“

### Q1: ThreadLocalçš„æ•°æ®å­˜å‚¨åœ¨å“ªé‡Œï¼Ÿ
**A**: å­˜å‚¨åœ¨Threadå¯¹è±¡çš„threadLocalså­—æ®µä¸­ï¼Œè€Œä¸æ˜¯ThreadLocalå¯¹è±¡ä¸­ã€‚

### Q2: ä¸ºä»€ä¹ˆè¦è¿™æ ·è®¾è®¡ï¼Ÿ
**A**: 
- é¿å…é”ç«äº‰ï¼ˆæ¯ä¸ªçº¿ç¨‹è®¿é—®è‡ªå·±çš„Mapï¼‰
- Threadç»“æŸæ—¶è‡ªåŠ¨GC
- å¤šä¸ªThreadLocalå…±äº«ä¸€ä¸ªMapï¼ŒèŠ‚çœå†…å­˜

### Q3: æ–æ³¢é‚£å¥‘æ•£åˆ—çš„ä½œç”¨æ˜¯ä»€ä¹ˆï¼Ÿ
**A**: ä½¿ç”¨é»„é‡‘åˆ†å‰²æ•°0x61c88647ä½œä¸ºå¢é‡ï¼Œå¯ä»¥è®©hashå€¼å‡åŒ€åˆ†å¸ƒï¼Œå‡å°‘å†²çªã€‚

### Q4: ThreadLocalMapå¦‚ä½•è§£å†³hashå†²çªï¼Ÿ
**A**: ä½¿ç”¨å¼€æ”¾å¯»å€æ³•ï¼ˆçº¿æ€§æ¢æµ‹ï¼‰ï¼Œè€ŒéHashMapçš„é“¾åœ°å€æ³•ã€‚

### Q5: ä»€ä¹ˆæ˜¯è¿‡æœŸEntryï¼Ÿ
**A**: ThreadLocalå¯¹è±¡è¢«GCå›æ”¶åï¼ŒEntryçš„keyå˜ä¸ºnullï¼Œä½†valueä»å­˜åœ¨ï¼Œè¿™å°±æ˜¯è¿‡æœŸEntryã€‚

### Q6: è¿‡æœŸEntryä½•æ—¶æ¸…ç†ï¼Ÿ
**A**: set()ã€get()ã€remove()ã€æ‰©å®¹æ—¶éƒ½ä¼šæ¸…ç†ã€‚

### Q7: ä¸ºä»€ä¹ˆéœ€è¦é‡æ–°hashï¼Ÿ
**A**: æ¸…ç†è¿‡æœŸEntryåï¼Œåç»­Entryå¯èƒ½ä¸åœ¨ç†æƒ³ä½ç½®ï¼Œéœ€è¦ç§»åŠ¨åˆ°ç†æƒ³ä½ç½®ï¼Œæé«˜æŸ¥æ‰¾æ•ˆç‡ã€‚

### Q8: ThreadLocalMapä½•æ—¶æ‰©å®¹ï¼Ÿ
**A**: å…ˆæ¸…ç†è¿‡æœŸEntryï¼Œæ¸…ç†åsizeä» >= threshold * 3/4æ—¶æ‰©å®¹ä¸ºåŸæ¥çš„2å€ã€‚

---

## ä¸‹ä¸€ç« é¢„å‘Š

ä¸‹ä¸€ç« æˆ‘ä»¬å°†æ·±å…¥åˆ†æï¼š

- **Entryä¸ºä»€ä¹ˆä½¿ç”¨å¼±å¼•ç”¨ï¼Ÿ**
- **å¼ºå¼•ç”¨ã€è½¯å¼•ç”¨ã€å¼±å¼•ç”¨ã€è™šå¼•ç”¨çš„åŒºåˆ«**
- **å†…å­˜æ³„æ¼æ˜¯å¦‚ä½•äº§ç”Ÿçš„ï¼Ÿ**
- **ä¸ºä»€ä¹ˆremove()å¦‚æ­¤é‡è¦ï¼Ÿ**
- **ThreadLocalMapçš„å®Œæ•´ç”Ÿå‘½å‘¨æœŸ**

è®©æˆ‘ä»¬ç»§ç»­æ·±å…¥ï¼ğŸš€
