# ç¬¬ä¸‰ç« ï¼šThreadLocalMapæ·±åº¦å‰–æ

## å¼•è¨€

æœ¬ç« å°†æ·±å…¥åˆ†æThreadLocalMapæœ€ç²¾å¦™çš„è®¾è®¡ï¼šEntryçš„å¼±å¼•ç”¨æœºåˆ¶ã€‚æˆ‘ä»¬å°†æ­ç¤ºä¸ºä»€ä¹ˆEntryè¦ä½¿ç”¨å¼±å¼•ç”¨ï¼Œä»¥åŠè¿™ä¸ªè®¾è®¡å¦‚ä½•å½±å“å†…å­˜ç®¡ç†ã€‚

---

## 1. Javaçš„å››ç§å¼•ç”¨ç±»å‹

### 1.1 é—®é¢˜1ï¼šJavaæœ‰å“ªäº›å¼•ç”¨ç±»å‹ï¼Ÿ

**å››ç§å¼•ç”¨ç±»å‹**ï¼š

```java
// 1. å¼ºå¼•ç”¨ï¼ˆStrong Referenceï¼‰
Object obj = new Object();

// 2. è½¯å¼•ç”¨ï¼ˆSoft Referenceï¼‰
SoftReference<Object> soft = new SoftReference<>(new Object());

// 3. å¼±å¼•ç”¨ï¼ˆWeak Referenceï¼‰
WeakReference<Object> weak = new WeakReference<>(new Object());

// 4. è™šå¼•ç”¨ï¼ˆPhantom Referenceï¼‰
PhantomReference<Object> phantom = new PhantomReference<>(new Object(), queue);
```

**å¼•ç”¨å¼ºåº¦å¯¹æ¯”**ï¼š

```
å¼ºå¼•ç”¨ > è½¯å¼•ç”¨ > å¼±å¼•ç”¨ > è™šå¼•ç”¨
  â†“       â†“       â†“       â†“
æ°¸ä¸å›æ”¶  å†…å­˜ä¸è¶³  GCæ—¶å›æ”¶  å·²å›æ”¶
```

---

### 1.2 é—®é¢˜2ï¼šå››ç§å¼•ç”¨çš„åŒºåˆ«æ˜¯ä»€ä¹ˆï¼Ÿ

#### 1. å¼ºå¼•ç”¨ï¼ˆStrong Referenceï¼‰

```java
public class StrongReferenceDemo {
    public static void main(String[] args) {
        Object obj = new Object(); // å¼ºå¼•ç”¨
        
        System.out.println("obj: " + obj);
        
        // å³ä½¿å†…å­˜ä¸è¶³ï¼Œä¹Ÿä¸ä¼šå›æ”¶
        obj = null; // æ–­å¼€å¼ºå¼•ç”¨ï¼Œæ‰èƒ½è¢«å›æ”¶
        
        System.gc();
        System.out.println("GCå: " + obj); // null
    }
}
```

**ç‰¹ç‚¹**ï¼š
- åªè¦å¼ºå¼•ç”¨å­˜åœ¨ï¼Œå¯¹è±¡æ°¸è¿œä¸ä¼šè¢«å›æ”¶
- å³ä½¿OOMï¼Œä¹Ÿä¸ä¼šå›æ”¶
- æœ€å¸¸è§çš„å¼•ç”¨ç±»å‹

---

#### 2. è½¯å¼•ç”¨ï¼ˆSoft Referenceï¼‰

```java
public class SoftReferenceDemo {
    public static void main(String[] args) {
        // åˆ›å»ºè½¯å¼•ç”¨
        SoftReference<byte[]> soft = new SoftReference<>(new byte[1024 * 1024]); // 1MB
        
        System.out.println("ç¬¬1æ¬¡GCå‰: " + soft.get());
        
        // å†…å­˜å……è¶³æ—¶ï¼Œä¸ä¼šå›æ”¶
        System.gc();
        System.out.println("ç¬¬1æ¬¡GCå: " + soft.get()); // ä»ç„¶å­˜åœ¨
        
        // æ¨¡æ‹Ÿå†…å­˜ä¸è¶³
        try {
            byte[] huge = new byte[10 * 1024 * 1024]; // 10MB
        } catch (OutOfMemoryError e) {
            System.out.println("OOM");
        }
        
        System.out.println("å†…å­˜ä¸è¶³å: " + soft.get()); // nullï¼Œè¢«å›æ”¶äº†
    }
}
```

**ç‰¹ç‚¹**ï¼š
- å†…å­˜å……è¶³æ—¶ï¼Œä¸ä¼šå›æ”¶
- å†…å­˜ä¸è¶³æ—¶ï¼Œä¼šè¢«å›æ”¶
- é€‚åˆå®ç°ç¼“å­˜

**åº”ç”¨åœºæ™¯**ï¼š

```java
// å›¾ç‰‡ç¼“å­˜
public class ImageCache {
    private Map<String, SoftReference<Image>> cache = new HashMap<>();
    
    public Image getImage(String path) {
        SoftReference<Image> ref = cache.get(path);
        if (ref != null) {
            Image img = ref.get();
            if (img != null) {
                return img; // ç¼“å­˜å‘½ä¸­
            }
        }
        
        // ç¼“å­˜æœªå‘½ä¸­ï¼ŒåŠ è½½å›¾ç‰‡
        Image img = loadImage(path);
        cache.put(path, new SoftReference<>(img));
        return img;
    }
}
```

---

#### 3. å¼±å¼•ç”¨ï¼ˆWeak Referenceï¼‰

```java
public class WeakReferenceDemo {
    public static void main(String[] args) {
        // åˆ›å»ºå¼±å¼•ç”¨
        WeakReference<byte[]> weak = new WeakReference<>(new byte[1024 * 1024]); // 1MB
        
        System.out.println("GCå‰: " + weak.get());
        
        // GCæ—¶ä¸€å®šä¼šå›æ”¶
        System.gc();
        System.out.println("GCå: " + weak.get()); // nullï¼Œè¢«å›æ”¶äº†
    }
}
```

**ç‰¹ç‚¹**ï¼š
- GCæ—¶ä¸€å®šä¼šå›æ”¶
- ä¸ç®¡å†…å­˜æ˜¯å¦å……è¶³
- ThreadLocalMapçš„Entryå°±æ˜¯å¼±å¼•ç”¨

---

#### 4. è™šå¼•ç”¨ï¼ˆPhantom Referenceï¼‰

```java
public class PhantomReferenceDemo {
    public static void main(String[] args) {
        ReferenceQueue<byte[]> queue = new ReferenceQueue<>();
        
        // åˆ›å»ºè™šå¼•ç”¨
        PhantomReference<byte[]> phantom = new PhantomReference<>(
            new byte[1024 * 1024], queue
        );
        
        System.out.println("get(): " + phantom.get()); // æ°¸è¿œè¿”å›null
        
        System.gc();
        
        // å¯¹è±¡è¢«å›æ”¶åï¼Œè™šå¼•ç”¨ä¼šè¢«åŠ å…¥é˜Ÿåˆ—
        Reference<? extends byte[]> ref = queue.poll();
        System.out.println("é˜Ÿåˆ—ä¸­çš„å¼•ç”¨: " + ref);
    }
}
```

**ç‰¹ç‚¹**ï¼š
- `get()`æ°¸è¿œè¿”å›null
- å¯¹è±¡è¢«å›æ”¶åï¼Œè™šå¼•ç”¨ä¼šè¢«åŠ å…¥ReferenceQueue
- ç”¨äºè·Ÿè¸ªå¯¹è±¡çš„å›æ”¶çŠ¶æ€

---

### 1.3 é—®é¢˜3ï¼šå¼•ç”¨ç±»å‹å¯¹æ¯”æ€»ç»“

| å¼•ç”¨ç±»å‹ | å›æ”¶æ—¶æœº | get()è¿”å›å€¼ | åº”ç”¨åœºæ™¯ |
|---------|---------|------------|---------|
| **å¼ºå¼•ç”¨** | æ°¸ä¸å›æ”¶ | å¯¹è±¡ | æ™®é€šå¯¹è±¡ |
| **è½¯å¼•ç”¨** | å†…å­˜ä¸è¶³æ—¶ | å¯¹è±¡æˆ–null | ç¼“å­˜ |
| **å¼±å¼•ç”¨** | GCæ—¶ | å¯¹è±¡æˆ–null | ThreadLocalMap |
| **è™šå¼•ç”¨** | GCæ—¶ | æ°¸è¿œnull | è·Ÿè¸ªå›æ”¶ |

---

## 2. Entryä¸ºä»€ä¹ˆä½¿ç”¨å¼±å¼•ç”¨ï¼Ÿ

### 2.1 é—®é¢˜4ï¼šEntryçš„è®¾è®¡æ˜¯ä»€ä¹ˆæ ·çš„ï¼Ÿ

**Entryæºç **ï¼š

```java
static class Entry extends WeakReference<ThreadLocal<?>> {
    /** The value associated with this ThreadLocal. */
    Object value;
    
    Entry(ThreadLocal<?> k, Object v) {
        super(k); // keyæ˜¯å¼±å¼•ç”¨
        value = v; // valueæ˜¯å¼ºå¼•ç”¨
    }
}
```

**å…³é”®è®¾è®¡**ï¼š

```
Entryçš„å¼•ç”¨å…³ç³»ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Entry                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  key: WeakReference        â”‚  â”‚  â† å¼±å¼•ç”¨
â”‚  â”‚        â†“                   â”‚  â”‚
â”‚  â”‚  ThreadLocalå¯¹è±¡           â”‚  â”‚
â”‚  â”‚                            â”‚  â”‚
â”‚  â”‚  value: Object             â”‚  â”‚  â† å¼ºå¼•ç”¨
â”‚  â”‚        â†“                   â”‚  â”‚
â”‚  â”‚  å®é™…çš„å€¼å¯¹è±¡               â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### 2.2 é—®é¢˜5ï¼šä¸ºä»€ä¹ˆkeyè¦ä½¿ç”¨å¼±å¼•ç”¨ï¼Ÿ

**åœºæ™¯åˆ†æ**ï¼š

```java
public class ThreadLocalUsage {
    public void method() {
        // 1. åˆ›å»ºThreadLocalå¯¹è±¡
        ThreadLocal<String> threadLocal = new ThreadLocal<>();
        
        // 2. è®¾ç½®å€¼
        threadLocal.set("value");
        
        // 3. æ–¹æ³•ç»“æŸï¼ŒthreadLocalå˜é‡è¶…å‡ºä½œç”¨åŸŸ
    }
}
```

**å¼•ç”¨å…³ç³»å›¾**ï¼š

```
æ–¹æ³•æ‰§è¡Œä¸­ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ ˆ                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                 â”‚
â”‚  â”‚ threadLocalå˜é‡ â”‚ â”€â”€â”€â”€â”€â”                         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚ å¼ºå¼•ç”¨                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ ThreadLocal  â”‚
                    â”‚   å¯¹è±¡       â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†‘
                            â”‚ å¼±å¼•ç”¨ï¼ˆEntry.keyï¼‰
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Threadå¯¹è±¡                â”‚                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                        â”‚
â”‚  â”‚  ThreadLocalMap                                  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  â”‚  Entry                                     â”‚ â”‚
â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚
â”‚  â”‚  â”‚  â”‚  key: WeakReference<ThreadLocal>     â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  â”‚  value: "value"                      â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

æ–¹æ³•ç»“æŸåï¼š
æ ˆä¸­çš„threadLocalå˜é‡æ¶ˆå¤±ï¼Œåªå‰©ä¸‹Entry.keyçš„å¼±å¼•ç”¨

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Threadå¯¹è±¡                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚  ThreadLocalMap                                 â”‚â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚â”‚
â”‚  â”‚  â”‚  Entry                                     â”‚â”‚â”‚
â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚â”‚â”‚
â”‚  â”‚  â”‚  â”‚  key: WeakReference<ThreadLocal>     â”‚ â”‚â”‚â”‚
â”‚  â”‚  â”‚  â”‚       â†“ï¼ˆå¼±å¼•ç”¨ï¼‰                     â”‚ â”‚â”‚â”‚
â”‚  â”‚  â”‚  â”‚  ThreadLocalå¯¹è±¡ï¼ˆå¯ä»¥è¢«GCï¼‰         â”‚ â”‚â”‚â”‚
â”‚  â”‚  â”‚  â”‚                                      â”‚ â”‚â”‚â”‚
â”‚  â”‚  â”‚  â”‚  value: "value"ï¼ˆå¼ºå¼•ç”¨ï¼Œæ— æ³•è¢«GCï¼‰  â”‚ â”‚â”‚â”‚
â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚â”‚â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### 2.3 é—®é¢˜6ï¼šå¦‚æœkeyä½¿ç”¨å¼ºå¼•ç”¨ä¼šæ€æ ·ï¼Ÿ

**å‡è®¾Entry.keyæ˜¯å¼ºå¼•ç”¨**ï¼š

```java
// å‡è®¾çš„è®¾è®¡ï¼ˆé”™è¯¯ï¼‰
static class Entry {
    ThreadLocal<?> key; // å¼ºå¼•ç”¨
    Object value;
}
```

**é—®é¢˜åˆ†æ**ï¼š

```
æ–¹æ³•ç»“æŸåï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Threadå¯¹è±¡                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚  ThreadLocalMap                                 â”‚â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚â”‚
â”‚  â”‚  â”‚  Entry                                     â”‚â”‚â”‚
â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚â”‚â”‚
â”‚  â”‚  â”‚  â”‚  key: ThreadLocalå¯¹è±¡ï¼ˆå¼ºå¼•ç”¨ï¼‰       â”‚ â”‚â”‚â”‚
â”‚  â”‚  â”‚  â”‚       â†“                              â”‚ â”‚â”‚â”‚
â”‚  â”‚  â”‚  â”‚  ThreadLocalå¯¹è±¡ï¼ˆæ— æ³•è¢«GCï¼ï¼‰       â”‚ â”‚â”‚â”‚
â”‚  â”‚  â”‚  â”‚                                      â”‚ â”‚â”‚â”‚
â”‚  â”‚  â”‚  â”‚  value: "value"ï¼ˆå¼ºå¼•ç”¨ï¼‰            â”‚ â”‚â”‚â”‚
â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚â”‚â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

é—®é¢˜ï¼š
1. ThreadLocalå¯¹è±¡æ— æ³•è¢«GCï¼ˆè¢«Entry.keyå¼ºå¼•ç”¨ï¼‰
2. valueä¹Ÿæ— æ³•è¢«GCï¼ˆè¢«Entry.valueå¼ºå¼•ç”¨ï¼‰
3. åªæœ‰Threadç»“æŸæ—¶ï¼Œæ•´ä¸ªThreadLocalMapæ‰èƒ½è¢«GC
4. å¦‚æœæ˜¯çº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹ï¼ŒThreadæ°¸è¿œä¸ç»“æŸï¼Œå¯¼è‡´å†…å­˜æ³„æ¼
```

---

### 2.4 é—®é¢˜7ï¼šä½¿ç”¨å¼±å¼•ç”¨åçš„æ•ˆæœæ˜¯ä»€ä¹ˆï¼Ÿ

**ä½¿ç”¨å¼±å¼•ç”¨çš„æ•ˆæœ**ï¼š

```
æ–¹æ³•ç»“æŸåï¼ŒGCå‘ç”Ÿï¼š

GCå‰ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Threadå¯¹è±¡                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚  ThreadLocalMap                                 â”‚â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚â”‚
â”‚  â”‚  â”‚  Entry                                     â”‚â”‚â”‚
â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚â”‚â”‚
â”‚  â”‚  â”‚  â”‚  key: WeakReference<ThreadLocal>     â”‚ â”‚â”‚â”‚
â”‚  â”‚  â”‚  â”‚       â†“ï¼ˆå¼±å¼•ç”¨ï¼‰                     â”‚ â”‚â”‚â”‚
â”‚  â”‚  â”‚  â”‚  ThreadLocalå¯¹è±¡                     â”‚ â”‚â”‚â”‚
â”‚  â”‚  â”‚  â”‚                                      â”‚ â”‚â”‚â”‚
â”‚  â”‚  â”‚  â”‚  value: "value"                      â”‚ â”‚â”‚â”‚
â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚â”‚â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

GCåï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Threadå¯¹è±¡                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚  ThreadLocalMap                                 â”‚â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚â”‚
â”‚  â”‚  â”‚  Entry                                     â”‚â”‚â”‚
â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚â”‚â”‚
â”‚  â”‚  â”‚  â”‚  key: nullï¼ˆThreadLocalè¢«GCå›æ”¶ï¼‰    â”‚ â”‚â”‚â”‚
â”‚  â”‚  â”‚  â”‚                                      â”‚ â”‚â”‚â”‚
â”‚  â”‚  â”‚  â”‚  value: "value"ï¼ˆä»ç„¶å­˜åœ¨ï¼ï¼‰        â”‚ â”‚â”‚â”‚
â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚â”‚â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

è¿™å°±æ˜¯è¿‡æœŸEntryï¼
```

**ä¼˜åŠ¿**ï¼š

1. âœ… ThreadLocalå¯¹è±¡å¯ä»¥è¢«GCå›æ”¶
2. âœ… Entry.keyå˜ä¸ºnullï¼Œæ ‡è®°ä¸ºè¿‡æœŸEntry
3. âœ… åç»­çš„set/get/removeæ“ä½œä¼šæ¸…ç†è¿‡æœŸEntry
4. âœ… é¿å…äº†ThreadLocalå¯¹è±¡çš„å†…å­˜æ³„æ¼

**ä»ç„¶å­˜åœ¨çš„é—®é¢˜**ï¼š

1. âŒ valueä»ç„¶æ˜¯å¼ºå¼•ç”¨ï¼Œæ— æ³•è¢«GC
2. âŒ å¦‚æœä¸è°ƒç”¨set/get/removeï¼Œè¿‡æœŸEntryä¸ä¼šè¢«æ¸…ç†
3. âŒ çº¿ç¨‹æ± åœºæ™¯ä¸‹ï¼Œçº¿ç¨‹ä¸ç»“æŸï¼Œvalueæ°¸è¿œæ— æ³•è¢«GC

---

## 3. å†…å­˜æ³„æ¼çš„æ ¹æœ¬åŸå› 

### 3.1 é—®é¢˜8ï¼šThreadLocalçš„å†…å­˜æ³„æ¼æ˜¯å¦‚ä½•äº§ç”Ÿçš„ï¼Ÿ

**å®Œæ•´çš„å¼•ç”¨é“¾è·¯**ï¼š

```
å¼ºå¼•ç”¨é“¾è·¯ï¼š
Threadå¯¹è±¡ï¼ˆå¼ºå¼•ç”¨ï¼‰
    â†“
ThreadLocalMapå¯¹è±¡ï¼ˆå¼ºå¼•ç”¨ï¼‰
    â†“
Entryå¯¹è±¡ï¼ˆå¼ºå¼•ç”¨ï¼‰
    â†“
valueå¯¹è±¡ï¼ˆå¼ºå¼•ç”¨ï¼‰

åªè¦Threadå¯¹è±¡å­˜åœ¨ï¼Œæ•´ä¸ªé“¾è·¯éƒ½æ— æ³•è¢«GC
```

**å†…å­˜æ³„æ¼åœºæ™¯**ï¼š

```java
public class MemoryLeakDemo {
    private static ThreadLocal<byte[]> threadLocal = new ThreadLocal<>();
    private static ExecutorService executor = Executors.newFixedThreadPool(10);
    
    public static void main(String[] args) {
        for (int i = 0; i < 100; i++) {
            executor.execute(() -> {
                // å­˜å‚¨10MBæ•°æ®
                threadLocal.set(new byte[10 * 1024 * 1024]);
                
                // æ‰§è¡Œä¸šåŠ¡é€»è¾‘
                doSomething();
                
                // âŒ å¿˜è®°removeï¼Œå¯¼è‡´å†…å­˜æ³„æ¼
                // threadLocal.remove();
            });
        }
    }
}
```

**å†…å­˜æ³„æ¼åˆ†æ**ï¼š

```
çº¿ç¨‹æ± æœ‰10ä¸ªçº¿ç¨‹ï¼Œæ¯ä¸ªçº¿ç¨‹å­˜å‚¨10MBæ•°æ®

ç¬¬1ä¸ªä»»åŠ¡æ‰§è¡Œåï¼š
Thread-1: threadLocal â†’ 10MBï¼ˆæœªremoveï¼‰

ç¬¬2ä¸ªä»»åŠ¡æ‰§è¡Œåï¼ˆå¯èƒ½å¤ç”¨Thread-1ï¼‰ï¼š
Thread-1: threadLocal â†’ 10MBï¼ˆæ—§å€¼ï¼Œä»ç„¶å­˜åœ¨ï¼‰
Thread-2: threadLocal â†’ 10MBï¼ˆæ–°å€¼ï¼‰

...

ç¬¬100ä¸ªä»»åŠ¡æ‰§è¡Œåï¼š
Thread-1: threadLocal â†’ 10MBï¼ˆç¬¬91ä¸ªä»»åŠ¡çš„å€¼ï¼‰
Thread-2: threadLocal â†’ 10MBï¼ˆç¬¬92ä¸ªä»»åŠ¡çš„å€¼ï¼‰
...
Thread-10: threadLocal â†’ 10MBï¼ˆç¬¬100ä¸ªä»»åŠ¡çš„å€¼ï¼‰

æ€»å†…å­˜å ç”¨ï¼š10 Ã— 10MB = 100MB

é—®é¢˜ï¼š
- å‰90ä¸ªä»»åŠ¡çš„æ•°æ®ä»ç„¶å ç”¨å†…å­˜
- å› ä¸ºçº¿ç¨‹æ± çš„çº¿ç¨‹ä¸ä¼šç»“æŸ
- åªæœ‰è°ƒç”¨remove()æ‰èƒ½é‡Šæ”¾
```

---

### 3.2 é—®é¢˜9ï¼šä¸ºä»€ä¹ˆè¯´"ThreadLocalå¯¼è‡´å†…å­˜æ³„æ¼"æ˜¯è¯¯è§£ï¼Ÿ

**æ­£ç¡®çš„ç†è§£**ï¼š

```
è¯¯è§£ï¼šThreadLocalä¼šå¯¼è‡´å†…å­˜æ³„æ¼
çœŸç›¸ï¼šä¸æ­£ç¡®ä½¿ç”¨ThreadLocalä¼šå¯¼è‡´å†…å­˜æ³„æ¼

ThreadLocalçš„è®¾è®¡ï¼š
1. Entry.keyä½¿ç”¨å¼±å¼•ç”¨ â†’ ThreadLocalå¯¹è±¡å¯ä»¥è¢«GC
2. set/get/removeæ—¶æ¸…ç†è¿‡æœŸEntry â†’ valueå¯ä»¥è¢«GC
3. æä¾›remove()æ–¹æ³• â†’ æ‰‹åŠ¨æ¸…ç†

å†…å­˜æ³„æ¼çš„çœŸæ­£åŸå› ï¼š
1. ä½¿ç”¨åä¸è°ƒç”¨remove()
2. çº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹ä¸ç»“æŸ
3. valueçš„å¼ºå¼•ç”¨é“¾è·¯æ— æ³•æ–­å¼€
```

**å¯¹æ¯”åˆ†æ**ï¼š

```
å¦‚æœEntry.keyæ˜¯å¼ºå¼•ç”¨ï¼š
ThreadLocalå¯¹è±¡ + valueå¯¹è±¡ éƒ½æ— æ³•è¢«GC
å†…å­˜æ³„æ¼æ›´ä¸¥é‡ï¼

å¦‚æœEntry.keyæ˜¯å¼±å¼•ç”¨ï¼ˆå®é™…è®¾è®¡ï¼‰ï¼š
ThreadLocalå¯¹è±¡å¯ä»¥è¢«GC
valueå¯¹è±¡åœ¨è°ƒç”¨remove()åå¯ä»¥è¢«GC
å†…å­˜æ³„æ¼å¯ä»¥é¿å…ï¼

ç»“è®ºï¼š
å¼±å¼•ç”¨ä¸æ˜¯å¯¼è‡´å†…å­˜æ³„æ¼çš„åŸå› 
å¼±å¼•ç”¨æ˜¯ä¸ºäº†å‡è½»å†…å­˜æ³„æ¼çš„å½±å“
çœŸæ­£çš„åŸå› æ˜¯ï¼šä½¿ç”¨åä¸è°ƒç”¨remove()
```

---

## 4. è¿‡æœŸEntryçš„å®Œæ•´æ¸…ç†æœºåˆ¶

### 4.1 é—®é¢˜10ï¼šè¿‡æœŸEntryçš„æ¸…ç†æ—¶æœºæœ‰å“ªäº›ï¼Ÿ

**æ¸…ç†æ—¶æœºæ€»ç»“**ï¼š

| æ—¶æœº | æ–¹æ³• | æ¸…ç†èŒƒå›´ | è§¦å‘æ¡ä»¶ |
|------|------|---------|---------|
| **setæ—¶** | cleanSomeSlots() | éƒ¨åˆ†æ¸…ç† | æ¯æ¬¡set |
| **getæ—¶** | expungeStaleEntry() | è¿ç»­æ¸…ç† | é‡åˆ°è¿‡æœŸEntry |
| **removeæ—¶** | expungeStaleEntry() | è¿ç»­æ¸…ç† | æ‰¾åˆ°ç›®æ ‡Entry |
| **æ‰©å®¹æ—¶** | expungeStaleEntries() | å…¨éƒ¨æ¸…ç† | rehashå‰ |

---

### 4.2 é—®é¢˜11ï¼šcleanSomeSlots()çš„æ¸…ç†ç­–ç•¥æ˜¯ä»€ä¹ˆï¼Ÿ

**cleanSomeSlots()æºç **ï¼š

```java
/**
 * å¯å‘å¼æ¸…ç†
 * @param i å·²çŸ¥çš„éè¿‡æœŸEntryä½ç½®
 * @param n æ‰«ææ§åˆ¶å‚æ•°ï¼ˆé€šå¸¸æ˜¯sizeï¼‰
 * @return æ˜¯å¦æ¸…ç†äº†è¿‡æœŸEntry
 */
private boolean cleanSomeSlots(int i, int n) {
    boolean removed = false;
    Entry[] tab = table;
    int len = tab.length;
    
    do {
        i = nextIndex(i, len);
        Entry e = tab[i];
        
        if (e != null && e.get() == null) {
            // å‘ç°è¿‡æœŸEntry
            n = len;
            removed = true;
            i = expungeStaleEntry(i);
        }
    } while ( (n >>>= 1) != 0); // log2(n)æ¬¡å¾ªç¯
    
    return removed;
}
```

**æ¸…ç†ç­–ç•¥**ï¼š

```
å¯å‘å¼æ¸…ç†ï¼ˆHeuristic Cleaningï¼‰ï¼š

æ‰«ææ¬¡æ•°ï¼šlog2(n)
- né€šå¸¸æ˜¯size
- å¦‚æœsize=16ï¼Œæ‰«æ4æ¬¡
- å¦‚æœsize=32ï¼Œæ‰«æ5æ¬¡

ä¸ºä»€ä¹ˆä¸å…¨éƒ¨æ‰«æï¼Ÿ
- å…¨éƒ¨æ‰«æå¼€é”€å¤§
- å¤§éƒ¨åˆ†æƒ…å†µä¸‹ï¼Œè¿‡æœŸEntryä¸å¤š
- å¯å‘å¼æ‰«æå¯ä»¥å¹³è¡¡æ€§èƒ½å’Œæ¸…ç†æ•ˆæœ

ä½•æ—¶ä¼šå…¨éƒ¨æ‰«æï¼Ÿ
- æ‰©å®¹æ—¶ï¼ˆexpungeStaleEntriesï¼‰
```

---

### 4.3 é—®é¢˜12ï¼šexpungeStaleEntry()çš„æ¸…ç†ç­–ç•¥æ˜¯ä»€ä¹ˆï¼Ÿ

**expungeStaleEntry()çš„æ¸…ç†èŒƒå›´**ï¼š

```
ä»staleSlotå¼€å§‹ï¼Œè¿ç»­æ¸…ç†ç›´åˆ°é‡åˆ°null

ç¤ºä¾‹ï¼š
â”Œâ”€â”€â”€â”€â”¬â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”
â”‚ 0  â”‚ 1  â”‚ 2  â”‚ 3  â”‚ 4  â”‚ 5  â”‚ 6  â”‚ 7  â”‚
â”œâ”€â”€â”€â”€â”¼â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”¤
â”‚nullâ”‚ E1 â”‚ E2 â”‚nullâ”‚ E3 â”‚ E4 â”‚nullâ”‚ E5 â”‚
â””â”€â”€â”€â”€â”´â”€â”€â”€â”€â”´â”€â”€â”€â”€â”´â”€â”€â”€â”€â”´â”€â”€â”€â”€â”´â”€â”€â”€â”€â”´â”€â”€â”€â”€â”´â”€â”€â”€â”€â”˜
       â†‘
    staleSlot=1

æ¸…ç†è¿‡ç¨‹ï¼š
1. æ¸…ç†E1
2. æ£€æŸ¥E2ï¼ˆkeyä¸ä¸ºnullï¼Œé‡æ–°hashï¼‰
3. é‡åˆ°nullï¼ˆç´¢å¼•3ï¼‰ï¼Œåœæ­¢

æ¸…ç†åï¼š
â”Œâ”€â”€â”€â”€â”¬â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”
â”‚ 0  â”‚ 1  â”‚ 2  â”‚ 3  â”‚ 4  â”‚ 5  â”‚ 6  â”‚ 7  â”‚
â”œâ”€â”€â”€â”€â”¼â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”¤
â”‚nullâ”‚nullâ”‚ E2 â”‚nullâ”‚ E3 â”‚ E4 â”‚nullâ”‚ E5 â”‚
â””â”€â”€â”€â”€â”´â”€â”€â”€â”€â”´â”€â”€â”€â”€â”´â”€â”€â”€â”€â”´â”€â”€â”€â”€â”´â”€â”€â”€â”€â”´â”€â”€â”€â”€â”´â”€â”€â”€â”€â”˜
```

---

## 5. ThreadLocalMapçš„ç”Ÿå‘½å‘¨æœŸ

### 5.1 é—®é¢˜13ï¼šThreadLocalMapçš„å®Œæ•´ç”Ÿå‘½å‘¨æœŸæ˜¯ä»€ä¹ˆï¼Ÿ

**ç”Ÿå‘½å‘¨æœŸå›¾**ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  1. Threadåˆ›å»º                                       â”‚
â”‚     threadLocals = null                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  2. ç¬¬ä¸€æ¬¡è°ƒç”¨ThreadLocal.set()                      â”‚
â”‚     åˆ›å»ºThreadLocalMap                              â”‚
â”‚     threadLocals = new ThreadLocalMap(this, value)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  3. åç»­è°ƒç”¨set/get/remove                          â”‚
â”‚     æ“ä½œThreadLocalMap                              â”‚
â”‚     è‡ªåŠ¨æ¸…ç†è¿‡æœŸEntry                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  4. ThreadLocalå¯¹è±¡è¢«GC                             â”‚
â”‚     Entry.keyå˜ä¸ºnull                               â”‚
â”‚     æˆä¸ºè¿‡æœŸEntry                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  5. ä¸‹æ¬¡set/get/removeæ—¶                            â”‚
â”‚     æ¸…ç†è¿‡æœŸEntry                                    â”‚
â”‚     é‡Šæ”¾valueçš„å¼•ç”¨                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  6. Threadç»“æŸ                                       â”‚
â”‚     threadLocals = null                             â”‚
â”‚     æ•´ä¸ªThreadLocalMapè¢«GC                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### 5.2 é—®é¢˜14ï¼šçº¿ç¨‹æ± åœºæ™¯ä¸‹çš„ç”Ÿå‘½å‘¨æœŸæœ‰ä»€ä¹ˆä¸åŒï¼Ÿ

**çº¿ç¨‹æ± åœºæ™¯**ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  1. çº¿ç¨‹æ± åˆ›å»ºWorkerçº¿ç¨‹                             â”‚
â”‚     Threadåˆ›å»ºï¼ŒthreadLocals = null                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  2. æ‰§è¡Œç¬¬1ä¸ªä»»åŠ¡                                    â”‚
â”‚     ThreadLocal.set(value1)                         â”‚
â”‚     åˆ›å»ºThreadLocalMap                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  3. ä»»åŠ¡ç»“æŸ                                         â”‚
â”‚     âŒ å¦‚æœä¸è°ƒç”¨remove()                           â”‚
â”‚     value1ä»ç„¶å­˜åœ¨                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  4. æ‰§è¡Œç¬¬2ä¸ªä»»åŠ¡ï¼ˆå¤ç”¨åŒä¸€ä¸ªçº¿ç¨‹ï¼‰                   â”‚
â”‚     ThreadLocal.get()                               â”‚
â”‚     âŒ å¯èƒ½è·å–åˆ°value1ï¼ˆä¸Šä¸€ä¸ªä»»åŠ¡çš„å€¼ï¼‰            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  5. çº¿ç¨‹æ± å…³é—­                                       â”‚
â”‚     Workerçº¿ç¨‹ç»“æŸ                                   â”‚
â”‚     threadLocalsè¢«GC                                â”‚
â”‚     âœ… æ­¤æ—¶value1æ‰èƒ½è¢«GC                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

é—®é¢˜ï¼š
- çº¿ç¨‹ä¸ç»“æŸï¼ŒthreadLocalsä¸ä¼šè¢«GC
- valueçš„å¼•ç”¨é“¾è·¯æ— æ³•æ–­å¼€
- å¿…é¡»æ‰‹åŠ¨è°ƒç”¨remove()
```

---

## 6. æ ¸å¿ƒé—®é¢˜æ€»ç»“

### Q1: Javaæœ‰å“ªäº›å¼•ç”¨ç±»å‹ï¼Ÿ
**A**: å¼ºå¼•ç”¨ã€è½¯å¼•ç”¨ã€å¼±å¼•ç”¨ã€è™šå¼•ç”¨ï¼Œå¼ºåº¦ä¾æ¬¡é€’å‡ã€‚

### Q2: Entryä¸ºä»€ä¹ˆä½¿ç”¨å¼±å¼•ç”¨ï¼Ÿ
**A**: è®©ThreadLocalå¯¹è±¡å¯ä»¥è¢«GCå›æ”¶ï¼Œé¿å…ThreadLocalå¯¹è±¡çš„å†…å­˜æ³„æ¼ã€‚

### Q3: å¦‚æœEntry.keyä½¿ç”¨å¼ºå¼•ç”¨ä¼šæ€æ ·ï¼Ÿ
**A**: ThreadLocalå¯¹è±¡æ— æ³•è¢«GCï¼Œå†…å­˜æ³„æ¼æ›´ä¸¥é‡ã€‚

### Q4: ä½¿ç”¨å¼±å¼•ç”¨åçš„æ•ˆæœæ˜¯ä»€ä¹ˆï¼Ÿ
**A**: ThreadLocalå¯¹è±¡å¯ä»¥è¢«GCï¼ŒEntry.keyå˜ä¸ºnullï¼Œæˆä¸ºè¿‡æœŸEntryï¼Œåç»­å¯ä»¥è¢«æ¸…ç†ã€‚

### Q5: ThreadLocalçš„å†…å­˜æ³„æ¼æ˜¯å¦‚ä½•äº§ç”Ÿçš„ï¼Ÿ
**A**: ä½¿ç”¨åä¸è°ƒç”¨remove()ï¼Œå¯¼è‡´valueçš„å¼ºå¼•ç”¨é“¾è·¯æ— æ³•æ–­å¼€ï¼Œç‰¹åˆ«æ˜¯åœ¨çº¿ç¨‹æ± åœºæ™¯ä¸‹ã€‚

### Q6: ä¸ºä»€ä¹ˆè¯´"ThreadLocalå¯¼è‡´å†…å­˜æ³„æ¼"æ˜¯è¯¯è§£ï¼Ÿ
**A**: å¼±å¼•ç”¨æ˜¯ä¸ºäº†å‡è½»å†…å­˜æ³„æ¼ï¼ŒçœŸæ­£çš„åŸå› æ˜¯ä½¿ç”¨åä¸è°ƒç”¨remove()ã€‚

### Q7: è¿‡æœŸEntryä½•æ—¶æ¸…ç†ï¼Ÿ
**A**: set/get/remove/æ‰©å®¹æ—¶éƒ½ä¼šæ¸…ç†ï¼Œä½†ä¸ä¿è¯å…¨éƒ¨æ¸…ç†ã€‚

### Q8: cleanSomeSlots()çš„æ¸…ç†ç­–ç•¥æ˜¯ä»€ä¹ˆï¼Ÿ
**A**: å¯å‘å¼æ¸…ç†ï¼Œæ‰«ælog2(n)æ¬¡ï¼Œå¹³è¡¡æ€§èƒ½å’Œæ¸…ç†æ•ˆæœã€‚

### Q9: çº¿ç¨‹æ± åœºæ™¯ä¸‹æœ‰ä»€ä¹ˆç‰¹æ®Šæ€§ï¼Ÿ
**A**: çº¿ç¨‹ä¸ç»“æŸï¼ŒthreadLocalsä¸ä¼šè¢«GCï¼Œå¿…é¡»æ‰‹åŠ¨è°ƒç”¨remove()ã€‚

---

## ä¸‹ä¸€ç« é¢„å‘Š

ä¸‹ä¸€ç« æˆ‘ä»¬å°†å­¦ä¹ ï¼š

- **å†…å­˜æ³„æ¼çš„å®Œæ•´æ¡ˆä¾‹åˆ†æ**
- **å¦‚ä½•æ­£ç¡®ä½¿ç”¨ThreadLocal**
- **remove()çš„æœ€ä½³å®è·µ**
- **çº¿ç¨‹æ± åœºæ™¯ä¸‹çš„æ³¨æ„äº‹é¡¹**
- **ThreadLocalçš„ç›‘æ§å’Œè°ƒè¯•**

è®©æˆ‘ä»¬ç»§ç»­æ·±å…¥ï¼ğŸš€
