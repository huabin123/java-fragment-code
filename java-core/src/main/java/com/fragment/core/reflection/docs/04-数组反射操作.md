# 04 数组反射操作

## 数组的特殊性

在 Java 中，数组是一种特殊的对象类型，具有以下特点：
- 数组类型在运行时动态生成
- 数组的 Class 对象名称遵循特定规则
- 可以通过反射动态创建和操作数组

## 数组 Class 命名规则

```java
int[] -> [I
double[] -> [D
String[] -> [Ljava.lang.String;
int[][] -> [[I
Object[][] -> [[Ljava.lang.Object;
```

规则：
- `[` 表示数组维度
- 基本类型用单字符表示（I=int, D=double, Z=boolean 等）
- 引用类型用 `L类全名;` 表示

## 动态创建数组

### 一维数组创建
```java
// 创建 int[5]
Object intArray = Array.newInstance(int.class, 5);

// 创建 String[3]
Object stringArray = Array.newInstance(String.class, 3);

// 创建自定义类型数组
Object personArray = Array.newInstance(Person.class, 2);
```

### 多维数组创建
```java
// 创建 int[3][4]
Object twoDimArray = Array.newInstance(int.class, 3, 4);

// 创建不规则数组
Object jaggedArray = Array.newInstance(int.class, 3);
Array.set(jaggedArray, 0, Array.newInstance(int.class, 2));
Array.set(jaggedArray, 1, Array.newInstance(int.class, 4));
Array.set(jaggedArray, 2, Array.newInstance(int.class, 3));
```

## 数组元素访问

### 基本类型数组
```java
Object intArray = Array.newInstance(int.class, 5);

// 设置元素（类型安全）
Array.setInt(intArray, 0, 100);

// 获取元素（类型安全）
int value = Array.getInt(intArray, 0);

// 通用方法（需要装箱/拆箱）
Array.set(intArray, 1, 200);
Integer value2 = (Integer) Array.get(intArray, 1);
```

### 引用类型数组
```java
Object stringArray = Array.newInstance(String.class, 3);

// 设置和获取元素
Array.set(stringArray, 0, "Hello");
String str = (String) Array.get(stringArray, 0);
```

### 数组长度获取
```java
int length = Array.getLength(arrayObject);
```

## 数组类型检查

### 判断是否为数组
```java
Class<?> clazz = obj.getClass();
boolean isArray = clazz.isArray();
```

### 获取组件类型
```java
if (clazz.isArray()) {
    Class<?> componentType = clazz.getComponentType();
    System.out.println("组件类型: " + componentType.getName());
}
```

### 多维数组处理
```java
Class<?> arrayClass = int[][].class;
while (arrayClass.isArray()) {
    System.out.println("数组类型: " + arrayClass.getName());
    arrayClass = arrayClass.getComponentType();
}
System.out.println("最终组件类型: " + arrayClass.getName());
```

## 实际应用场景

### 1. 通用集合转数组
```java
public static <T> T[] toArray(Collection<T> collection, Class<T> componentType) {
    @SuppressWarnings("unchecked")
    T[] array = (T[]) Array.newInstance(componentType, collection.size());
    return collection.toArray(array);
}
```

### 2. 数组拷贝工具
```java
public static Object copyArray(Object source) {
    Class<?> componentType = source.getClass().getComponentType();
    int length = Array.getLength(source);
    Object copy = Array.newInstance(componentType, length);
    
    for (int i = 0; i < length; i++) {
        Array.set(copy, i, Array.get(source, i));
    }
    return copy;
}
```

### 3. 动态多维数组创建
```java
public static Object createMultiDimArray(Class<?> componentType, int... dimensions) {
    return Array.newInstance(componentType, dimensions);
}
```

## 性能考虑

### Array 类 vs 直接访问
- `Array.get/set` 比直接数组访问慢约 10-20 倍
- 类型安全的方法（如 `Array.getInt`）比通用方法稍快
- 频繁访问时考虑缓存数组引用并转换为具体类型

### 优化建议
```java
// 慢：每次都通过反射访问
for (int i = 0; i < Array.getLength(array); i++) {
    Array.setInt(array, i, i);
}

// 快：转换后直接访问
int[] intArray = (int[]) array;
for (int i = 0; i < intArray.length; i++) {
    intArray[i] = i;
}
```

## 常见陷阱

### 1. 基本类型 vs 包装类型
```java
// 错误：不能将 Integer[] 当作 int[] 处理
Object integerArray = Array.newInstance(Integer.class, 5);
// Array.setInt(integerArray, 0, 100); // 抛出异常

// 正确：使用对应的基本类型
Object intArray = Array.newInstance(int.class, 5);
Array.setInt(intArray, 0, 100); // OK
```

### 2. 多维数组的组件类型
```java
int[][] array2D = new int[3][4];
Class<?> componentType = array2D.getClass().getComponentType();
// componentType 是 int[].class，不是 int.class
```

## 示例代码位置

- `ArrayReflectionDemo.java`：完整的数组反射操作演示
- 包含一维数组、多维数组、不规则数组的创建和操作示例
