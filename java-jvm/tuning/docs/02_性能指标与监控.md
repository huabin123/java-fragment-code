# 性能指标与监控

## 📚 概述

性能监控是性能调优的基础。只有准确地监控和度量系统性能，才能发现问题、定位瓶颈、验证优化效果。本文从架构师视角讲解JVM性能指标体系和监控方法。

## 🎯 核心问题

- ❓ 为什么需要性能监控？不监控会怎样？
- ❓ 有哪些关键的性能指标？
- ❓ 如何建立性能监控体系？
- ❓ 如何选择监控工具？
- ❓ 如何设置合理的告警阈值？
- ❓ 如何从监控数据中发现问题？

---

## 一、为什么需要性能监控

### 1.1 没有监控的后果

```
场景1：问题发现滞后
- 用户投诉才知道系统慢
- 无法提前预警
- 影响用户体验

场景2：问题定位困难
- 不知道是CPU问题还是内存问题
- 不知道是GC问题还是代码问题
- 排查耗时长

场景3：优化效果无法验证
- 不知道优化前后的对比
- 无法量化优化效果
- 可能越优化越差

场景4：容量规划困难
- 不知道系统能承受多大压力
- 无法预测扩容时机
- 资源浪费或不足
```

### 1.2 监控的价值

```
价值1：及时发现问题
- 实时监控性能指标
- 异常自动告警
- 快速响应

价值2：快速定位问题
- 多维度指标分析
- 关联分析
- 缩小排查范围

价值3：验证优化效果
- 对比优化前后数据
- 量化优化收益
- 持续改进

价值4：容量规划
- 了解系统负载
- 预测扩容时机
- 合理分配资源
```

### 1.3 监控体系建设流程

```
建设监控体系
    ↓
1. 确定监控目标
   - 性能目标（响应时间、吞吐量）
   - 稳定性目标（可用性、错误率）
   - 资源目标（CPU、内存、GC）
    ↓
2. 选择监控指标
   - 系统级指标
   - JVM级指标
   - 应用级指标
    ↓
3. 选择监控工具
   - 开源工具（Prometheus、Grafana）
   - 商业工具（APM）
   - 自研工具
    ↓
4. 设置告警规则
   - 告警阈值
   - 告警级别
   - 告警通知
    ↓
5. 持续优化
   - 调整阈值
   - 优化指标
   - 改进工具
```

---

## 二、性能指标体系

### 2.1 指标分类

```
性能指标体系
    ↓
┌────┴────┬────┬────┐
│         │    │    │
系统级    JVM级  应用级  业务级
```

### 2.2 系统级指标

#### CPU指标

| 指标 | 说明 | 正常范围 | 告警阈值 |
|------|------|---------|---------|
| **CPU使用率** | 整体CPU使用率 | 30-70% | > 80% |
| **用户态CPU** | 应用程序CPU | - | - |
| **内核态CPU** | 系统调用CPU | - | > 30% |
| **iowait** | IO等待时间 | < 10% | > 20% |
| **load average** | 平均负载 | < CPU核数 | > CPU核数×2 |

#### 内存指标

| 指标 | 说明 | 正常范围 | 告警阈值 |
|------|------|---------|---------|
| **内存使用率** | 物理内存使用率 | 60-80% | > 90% |
| **swap使用** | 交换分区使用 | 0 | > 0 |
| **可用内存** | 剩余可用内存 | > 20% | < 10% |

#### 磁盘指标

| 指标 | 说明 | 正常范围 | 告警阈值 |
|------|------|---------|---------|
| **磁盘使用率** | 磁盘空间使用率 | < 80% | > 90% |
| **磁盘IO** | 读写速率 | - | 接近上限 |
| **IO等待** | IO等待时间 | < 10ms | > 50ms |

#### 网络指标

| 指标 | 说明 | 正常范围 | 告警阈值 |
|------|------|---------|---------|
| **网络流量** | 入站/出站流量 | - | 接近带宽上限 |
| **连接数** | TCP连接数 | - | 接近上限 |
| **丢包率** | 网络丢包率 | 0 | > 0.1% |

### 2.3 JVM级指标

#### 堆内存指标

| 指标 | 说明 | 正常范围 | 告警阈值 |
|------|------|---------|---------|
| **堆内存使用率** | 堆内存使用百分比 | 60-80% | > 85% |
| **新生代使用率** | 新生代使用百分比 | - | > 90% |
| **老年代使用率** | 老年代使用百分比 | 60-80% | > 85% |
| **元空间使用率** | 元空间使用百分比 | < 80% | > 90% |

#### GC指标

| 指标 | 说明 | 正常范围 | 告警阈值 |
|------|------|---------|---------|
| **Minor GC频率** | 每秒Minor GC次数 | < 1次/秒 | > 5次/秒 |
| **Minor GC时间** | 单次Minor GC耗时 | < 50ms | > 100ms |
| **Full GC频率** | 每小时Full GC次数 | < 1次/小时 | > 5次/小时 |
| **Full GC时间** | 单次Full GC耗时 | < 1秒 | > 3秒 |
| **GC吞吐量** | 非GC时间占比 | > 95% | < 90% |

#### 线程指标

| 指标 | 说明 | 正常范围 | 告警阈值 |
|------|------|---------|---------|
| **线程总数** | 当前线程数 | - | 接近上限 |
| **活跃线程数** | RUNNABLE状态线程 | - | - |
| **阻塞线程数** | BLOCKED状态线程 | 0 | > 10 |
| **死锁线程数** | 死锁线程数 | 0 | > 0 |

#### 类加载指标

| 指标 | 说明 | 正常范围 | 告警阈值 |
|------|------|---------|---------|
| **已加载类数** | 当前加载的类数量 | - | 持续增长 |
| **类加载速率** | 每秒加载类数量 | - | 异常增长 |
| **类卸载速率** | 每秒卸载类数量 | - | - |

### 2.4 应用级指标

| 指标 | 说明 | 正常范围 | 告警阈值 |
|------|------|---------|---------|
| **QPS** | 每秒请求数 | - | 超过容量 |
| **响应时间** | 平均响应时间 | < 200ms | > 1秒 |
| **P99响应时间** | 99分位响应时间 | < 500ms | > 2秒 |
| **错误率** | 请求错误率 | < 0.1% | > 1% |
| **并发数** | 当前并发请求数 | - | 超过容量 |

---

## 三、监控工具

### 3.1 命令行工具

#### jps - 查看Java进程

```bash
# 查看所有Java进程
jps -l

# 查看进程和JVM参数
jps -v

# 输出示例
12345 com.example.Application -Xms4g -Xmx4g
```

#### jstat - GC统计

```bash
# 查看GC统计（每秒刷新）
jstat -gc <pid> 1000

# 查看GC百分比
jstat -gcutil <pid> 1000

# 查看类加载统计
jstat -class <pid>

# 输出示例
S0C    S1C    S0U    S1U      EC       EU        OC         OU       MC     MU    
10240  10240  0      8192     81920    40960     204800     102400   51200  48000
```

#### jmap - 内存分析

```bash
# 查看堆内存使用
jmap -heap <pid>

# 查看对象统计
jmap -histo <pid> | head -20

# 生成堆转储
jmap -dump:format=b,file=heap.hprof <pid>

# 查看类加载器统计
jmap -clstats <pid>
```

#### jstack - 线程分析

```bash
# 查看线程栈
jstack <pid>

# 查看线程栈并输出到文件
jstack <pid> > thread.txt

# 检测死锁
jstack -l <pid> | grep -A 10 "deadlock"
```

#### jinfo - 查看和修改JVM参数

```bash
# 查看所有JVM参数
jinfo -flags <pid>

# 查看特定参数
jinfo -flag UseG1GC <pid>

# 动态修改参数（部分参数支持）
jinfo -flag +PrintGC <pid>
```

### 3.2 可视化工具

#### JConsole

```
特点：
- JDK自带
- 图形化界面
- 实时监控

功能：
- 内存监控
- 线程监控
- 类加载监控
- MBean管理

使用：
jconsole <pid>
```

#### VisualVM

```
特点：
- 功能强大
- 支持插件
- 性能分析

功能：
- CPU分析
- 内存分析
- 线程分析
- 堆转储分析

使用：
jvisualvm
```

#### JProfiler

```
特点：
- 商业工具
- 功能最全
- 性能开销小

功能：
- CPU profiling
- 内存profiling
- 线程profiling
- 数据库profiling
```

### 3.3 APM工具

#### Prometheus + Grafana

```yaml
# Prometheus配置
scrape_configs:
  - job_name: 'jvm'
    static_configs:
      - targets: ['localhost:9090']
    metrics_path: '/metrics'
    
# JVM Exporter
java -javaagent:jmx_prometheus_javaagent.jar=9090:config.yaml -jar app.jar
```

#### SkyWalking

```
特点：
- 开源APM
- 分布式追踪
- 性能分析

功能：
- 服务拓扑
- 性能指标
- 调用链追踪
- 告警

使用：
java -javaagent:skywalking-agent.jar -jar app.jar
```

#### Arthas

```bash
# 启动Arthas
java -jar arthas-boot.jar

# 常用命令
dashboard  # 仪表盘
thread     # 线程分析
jvm        # JVM信息
memory     # 内存分析
gc         # GC信息
```

---

## 四、监控实践

### 4.1 建立监控指标

```java
/**
 * 自定义监控指标
 */
public class MetricsCollector {
    
    // 使用Micrometer
    private final MeterRegistry registry;
    
    public MetricsCollector(MeterRegistry registry) {
        this.registry = registry;
    }
    
    // 记录计数器
    public void recordRequest() {
        registry.counter("app.requests").increment();
    }
    
    // 记录计时器
    public void recordResponseTime(long millis) {
        registry.timer("app.response.time").record(millis, TimeUnit.MILLISECONDS);
    }
    
    // 记录仪表
    public void recordActiveUsers(int count) {
        registry.gauge("app.active.users", count);
    }
}
```

### 4.2 设置告警规则

```yaml
# Prometheus告警规则
groups:
  - name: jvm_alerts
    rules:
      # CPU使用率过高
      - alert: HighCPUUsage
        expr: process_cpu_usage > 0.8
        for: 5m
        annotations:
          summary: "CPU使用率过高"
          description: "CPU使用率超过80%"
      
      # 堆内存使用率过高
      - alert: HighHeapUsage
        expr: jvm_memory_used_bytes{area="heap"} / jvm_memory_max_bytes{area="heap"} > 0.85
        for: 5m
        annotations:
          summary: "堆内存使用率过高"
          description: "堆内存使用率超过85%"
      
      # Full GC频率过高
      - alert: FrequentFullGC
        expr: rate(jvm_gc_pause_seconds_count{action="end of major GC"}[5m]) > 0.1
        for: 5m
        annotations:
          summary: "Full GC频率过高"
          description: "Full GC频率超过0.1次/秒"
```

### 4.3 监控大盘

```
Grafana仪表盘布局：

┌─────────────────────────────────────┐
│  系统概览                            │
│  - QPS                              │
│  - 响应时间                          │
│  - 错误率                            │
└─────────────────────────────────────┘

┌─────────────────────────────────────┐
│  JVM内存                             │
│  - 堆内存使用趋势                     │
│  - 新生代/老年代使用率                │
│  - 元空间使用率                       │
└─────────────────────────────────────┘

┌─────────────────────────────────────┐
│  GC监控                              │
│  - GC次数趋势                        │
│  - GC时间趋势                        │
│  - GC吞吐量                          │
└─────────────────────────────────────┘

┌─────────────────────────────────────┐
│  线程监控                            │
│  - 线程数趋势                        │
│  - 线程状态分布                      │
│  - 死锁检测                          │
└─────────────────────────────────────┘
```

---

## 五、监控最佳实践

### 5.1 监控原则

```
1. 全面性
   - 覆盖所有关键指标
   - 系统、JVM、应用多层次

2. 实时性
   - 秒级数据采集
   - 实时告警

3. 准确性
   - 指标定义准确
   - 阈值设置合理

4. 可操作性
   - 告警可执行
   - 提供解决方案
```

### 5.2 告警策略

```
告警级别：

P0 - 紧急
- 服务不可用
- 大量错误
- 立即处理

P1 - 重要
- 性能严重下降
- 资源即将耗尽
- 1小时内处理

P2 - 一般
- 性能下降
- 资源使用偏高
- 当天处理

P3 - 提示
- 潜在问题
- 趋势异常
- 关注即可
```

### 5.3 监控检查清单

```
□ 系统监控
  □ CPU使用率
  □ 内存使用率
  □ 磁盘使用率
  □ 网络流量

□ JVM监控
  □ 堆内存使用
  □ GC频率和时间
  □ 线程数
  □ 类加载数

□ 应用监控
  □ QPS
  □ 响应时间
  □ 错误率
  □ 并发数

□ 告警配置
  □ 告警规则
  □ 告警阈值
  □ 告警通知
  □ 告警处理流程
```

---

## 六、总结

### 6.1 关键指标

```
必须监控的指标：
1. CPU使用率
2. 堆内存使用率
3. GC频率和时间
4. 响应时间
5. 错误率
```

### 6.2 监控工具选择

```
开发环境：
- JConsole
- VisualVM
- Arthas

测试环境：
- Prometheus + Grafana
- JProfiler

生产环境：
- APM（SkyWalking、Pinpoint）
- Prometheus + Grafana
- 自研监控平台
```

---

**下一篇**：[CPU飙高问题排查](./03_CPU飙高问题排查.md)
