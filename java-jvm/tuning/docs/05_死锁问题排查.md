# æ­»é”é—®é¢˜æ’æŸ¥

## ğŸ“š æ¦‚è¿°

æ­»é”æ˜¯å¤šçº¿ç¨‹ç¼–ç¨‹ä¸­æœ€ä¸¥é‡çš„é—®é¢˜ä¹‹ä¸€ï¼Œä¼šå¯¼è‡´çº¿ç¨‹æ°¸ä¹…é˜»å¡ï¼Œåº”ç”¨æ— å“åº”ã€‚æœ¬æ–‡ä»æ¶æ„å¸ˆè§†è§’æ·±å…¥è®²è§£æ­»é”çš„åŸç†ã€æ’æŸ¥æ–¹æ³•å’Œé¢„é˜²ç­–ç•¥ã€‚

## ğŸ¯ æ ¸å¿ƒé—®é¢˜

- â“ ä»€ä¹ˆæ˜¯æ­»é”ï¼Ÿä¸ºä»€ä¹ˆä¼šå‘ç”Ÿæ­»é”ï¼Ÿ
- â“ æ­»é”çš„å¿…è¦æ¡ä»¶æ˜¯ä»€ä¹ˆï¼Ÿ
- â“ å¦‚ä½•å¿«é€Ÿæ£€æµ‹æ­»é”ï¼Ÿ
- â“ å¦‚ä½•å®šä½æ­»é”çš„ä»£ç ï¼Ÿ
- â“ å¦‚ä½•é¢„é˜²æ­»é”ï¼Ÿ
- â“ æ­»é”å’Œæ´»é”ã€é¥¥é¥¿æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ

---

## ä¸€ã€ä»€ä¹ˆæ˜¯æ­»é”

### 1.1 æ­»é”çš„å®šä¹‰

```
æ­»é”ï¼ˆDeadlockï¼‰ï¼š
ä¸¤ä¸ªæˆ–å¤šä¸ªçº¿ç¨‹äº’ç›¸æŒæœ‰å¯¹æ–¹éœ€è¦çš„èµ„æº
å¯¼è‡´æ‰€æœ‰çº¿ç¨‹éƒ½æ— æ³•ç»§ç»­æ‰§è¡Œ
æ°¸ä¹…é˜»å¡

ç»å…¸ç¤ºä¾‹ï¼š
çº¿ç¨‹AæŒæœ‰èµ„æº1ï¼Œç­‰å¾…èµ„æº2
çº¿ç¨‹BæŒæœ‰èµ„æº2ï¼Œç­‰å¾…èµ„æº1
    â†“
äº’ç›¸ç­‰å¾…
    â†“
æ°¸ä¹…é˜»å¡
    â†“
æ­»é”
```

### 1.2 æ­»é”ç¤ºä¾‹

```java
public class DeadlockDemo {
    
    private static Object lock1 = new Object();
    private static Object lock2 = new Object();
    
    public static void main(String[] args) {
        // çº¿ç¨‹1
        new Thread(() -> {
            synchronized (lock1) {
                System.out.println("Thread1: æŒæœ‰lock1ï¼Œç­‰å¾…lock2");
                try {
                    Thread.sleep(100);
                } catch (InterruptedException e) {
                    e.printStackTrace();
                }
                synchronized (lock2) {
                    System.out.println("Thread1: è·å¾—lock2");
                }
            }
        }).start();
        
        // çº¿ç¨‹2
        new Thread(() -> {
            synchronized (lock2) {
                System.out.println("Thread2: æŒæœ‰lock2ï¼Œç­‰å¾…lock1");
                try {
                    Thread.sleep(100);
                } catch (InterruptedException e) {
                    e.printStackTrace();
                }
                synchronized (lock1) {
                    System.out.println("Thread2: è·å¾—lock1");
                }
            }
        }).start();
    }
}

// è¾“å‡ºï¼š
// Thread1: æŒæœ‰lock1ï¼Œç­‰å¾…lock2
// Thread2: æŒæœ‰lock2ï¼Œç­‰å¾…lock1
// ï¼ˆç„¶åæ°¸ä¹…é˜»å¡ï¼‰
```

### 1.3 æ­»é”çš„å››ä¸ªå¿…è¦æ¡ä»¶

```
æ­»é”çš„å››ä¸ªå¿…è¦æ¡ä»¶ï¼ˆç¼ºä¸€ä¸å¯ï¼‰ï¼š

1. äº’æ–¥æ¡ä»¶ï¼ˆMutual Exclusionï¼‰
   - èµ„æºä¸èƒ½è¢«å¤šä¸ªçº¿ç¨‹åŒæ—¶ä½¿ç”¨
   - ä¸€æ¬¡åªèƒ½è¢«ä¸€ä¸ªçº¿ç¨‹å ç”¨

2. æŒæœ‰å¹¶ç­‰å¾…ï¼ˆHold and Waitï¼‰
   - çº¿ç¨‹æŒæœ‰è‡³å°‘ä¸€ä¸ªèµ„æº
   - åŒæ—¶ç­‰å¾…è·å–å…¶ä»–èµ„æº

3. ä¸å¯å‰¥å¤ºï¼ˆNo Preemptionï¼‰
   - èµ„æºä¸èƒ½è¢«å¼ºåˆ¶å‰¥å¤º
   - åªèƒ½ç”±æŒæœ‰è€…ä¸»åŠ¨é‡Šæ”¾

4. å¾ªç¯ç­‰å¾…ï¼ˆCircular Waitï¼‰
   - å­˜åœ¨çº¿ç¨‹ç­‰å¾…ç¯è·¯
   - Aç­‰Bï¼ŒBç­‰Cï¼ŒCç­‰A

ç ´åä»»æ„ä¸€ä¸ªæ¡ä»¶ï¼Œå°±å¯ä»¥é¢„é˜²æ­»é”
```

### 1.4 æ­»é”çš„å±å®³

```
å±å®³1ï¼šçº¿ç¨‹æ°¸ä¹…é˜»å¡
- æ¶‰åŠçš„çº¿ç¨‹æ— æ³•ç»§ç»­æ‰§è¡Œ
- å ç”¨çš„èµ„æºæ— æ³•é‡Šæ”¾
- å½±å“å…¶ä»–çº¿ç¨‹

å±å®³2ï¼šåº”ç”¨æ— å“åº”
- å…³é”®çº¿ç¨‹æ­»é”
- è¯·æ±‚æ— æ³•å¤„ç†
- ç”¨æˆ·æ— æ³•ä½¿ç”¨

å±å®³3ï¼šèµ„æºæµªè´¹
- çº¿ç¨‹å ç”¨å†…å­˜
- è¿æ¥å ç”¨èµ„æº
- ç³»ç»Ÿèµ„æºè€—å°½

å±å®³4ï¼šéš¾ä»¥æ’æŸ¥
- é—®é¢˜ä¸æ˜“å¤ç°
- å¯èƒ½å¶å‘
- æ’æŸ¥æˆæœ¬é«˜
```

---

## äºŒã€æ­»é”çš„ç±»å‹

### 2.1 ç®€å•æ­»é”

```java
/**
 * æœ€ç®€å•çš„æ­»é”ï¼šä¸¤ä¸ªçº¿ç¨‹ï¼Œä¸¤ä¸ªé”
 */
public class SimpleDeadlock {
    
    private final Object lock1 = new Object();
    private final Object lock2 = new Object();
    
    public void method1() {
        synchronized (lock1) {
            System.out.println(Thread.currentThread().getName() + ": æŒæœ‰lock1");
            synchronized (lock2) {
                System.out.println(Thread.currentThread().getName() + ": æŒæœ‰lock2");
            }
        }
    }
    
    public void method2() {
        synchronized (lock2) {
            System.out.println(Thread.currentThread().getName() + ": æŒæœ‰lock2");
            synchronized (lock1) {
                System.out.println(Thread.currentThread().getName() + ": æŒæœ‰lock1");
            }
        }
    }
    
    public static void main(String[] args) {
        SimpleDeadlock deadlock = new SimpleDeadlock();
        
        new Thread(() -> deadlock.method1(), "Thread-1").start();
        new Thread(() -> deadlock.method2(), "Thread-2").start();
    }
}

// æ­»é”å…³ç³»ï¼š
// Thread-1: lock1 â†’ lock2
// Thread-2: lock2 â†’ lock1
// å½¢æˆå¾ªç¯ç­‰å¾…
```

### 2.2 å¤æ‚æ­»é”

```java
/**
 * å¤æ‚æ­»é”ï¼šå¤šä¸ªçº¿ç¨‹ï¼Œå¤šä¸ªé”
 */
public class ComplexDeadlock {
    
    private final Object lockA = new Object();
    private final Object lockB = new Object();
    private final Object lockC = new Object();
    
    public void methodA() {
        synchronized (lockA) {
            System.out.println("æŒæœ‰lockA");
            synchronized (lockB) {
                System.out.println("æŒæœ‰lockB");
            }
        }
    }
    
    public void methodB() {
        synchronized (lockB) {
            System.out.println("æŒæœ‰lockB");
            synchronized (lockC) {
                System.out.println("æŒæœ‰lockC");
            }
        }
    }
    
    public void methodC() {
        synchronized (lockC) {
            System.out.println("æŒæœ‰lockC");
            synchronized (lockA) {
                System.out.println("æŒæœ‰lockA");
            }
        }
    }
    
    public static void main(String[] args) {
        ComplexDeadlock deadlock = new ComplexDeadlock();
        
        new Thread(() -> deadlock.methodA(), "Thread-A").start();
        new Thread(() -> deadlock.methodB(), "Thread-B").start();
        new Thread(() -> deadlock.methodC(), "Thread-C").start();
    }
}

// æ­»é”å…³ç³»ï¼š
// Thread-A: lockA â†’ lockB
// Thread-B: lockB â†’ lockC
// Thread-C: lockC â†’ lockA
// å½¢æˆå¾ªç¯ç­‰å¾…ç¯
```

### 2.3 åŠ¨æ€æ­»é”

```java
/**
 * åŠ¨æ€æ­»é”ï¼šè½¬è´¦åœºæ™¯
 */
public class TransferDeadlock {
    
    public static class Account {
        private int balance;
        private final int id;
        
        public Account(int id, int balance) {
            this.id = id;
            this.balance = balance;
        }
        
        public void debit(int amount) {
            balance -= amount;
        }
        
        public void credit(int amount) {
            balance += amount;
        }
    }
    
    // é—®é¢˜ä»£ç ï¼šå¯èƒ½æ­»é”
    public void transfer(Account from, Account to, int amount) {
        synchronized (from) {
            System.out.println("é”å®šfromè´¦æˆ·: " + from.id);
            synchronized (to) {
                System.out.println("é”å®štoè´¦æˆ·: " + to.id);
                from.debit(amount);
                to.credit(amount);
            }
        }
    }
    
    public static void main(String[] args) {
        Account account1 = new Account(1, 1000);
        Account account2 = new Account(2, 1000);
        
        TransferDeadlock transfer = new TransferDeadlock();
        
        // çº¿ç¨‹1ï¼šaccount1 â†’ account2
        new Thread(() -> {
            transfer.transfer(account1, account2, 100);
        }).start();
        
        // çº¿ç¨‹2ï¼šaccount2 â†’ account1
        new Thread(() -> {
            transfer.transfer(account2, account1, 200);
        }).start();
        
        // å¯èƒ½æ­»é”ï¼š
        // çº¿ç¨‹1æŒæœ‰account1ï¼Œç­‰å¾…account2
        // çº¿ç¨‹2æŒæœ‰account2ï¼Œç­‰å¾…account1
    }
}
```

---

## ä¸‰ã€æ­»é”æ’æŸ¥æµç¨‹

### 3.1 æ’æŸ¥æµç¨‹å›¾

```
å‘ç°åº”ç”¨æ— å“åº”
    â†“
1. ç¡®è®¤æ˜¯å¦æ­»é”
   - çº¿ç¨‹é•¿æ—¶é—´BLOCKED
   - åº”ç”¨æ— å“åº”
    â†“
2. ä½¿ç”¨jstackæ£€æµ‹æ­»é”
   jstack <pid>
    â†“
3. åˆ†ææ­»é”ä¿¡æ¯
   - æŸ¥çœ‹æ­»é”çº¿ç¨‹
   - æŸ¥çœ‹æŒæœ‰çš„é”
   - æŸ¥çœ‹ç­‰å¾…çš„é”
    â†“
4. å®šä½æ­»é”ä»£ç 
   - æ ¹æ®çº¿ç¨‹æ ˆå®šä½
   - åˆ†æåŠ é”é¡ºåº
    â†“
5. ä¿®å¤æ­»é”
   - è°ƒæ•´åŠ é”é¡ºåº
   - ä½¿ç”¨è¶…æ—¶æœºåˆ¶
   - ä½¿ç”¨Lockæ›¿ä»£synchronized
    â†“
6. éªŒè¯ä¿®å¤æ•ˆæœ
```

### 3.2 ä½¿ç”¨jstackæ£€æµ‹æ­»é”

#### æ­¥éª¤1ï¼šå¯¼å‡ºçº¿ç¨‹æ ˆ

```bash
# å¯¼å‡ºçº¿ç¨‹æ ˆ
jstack <pid> > thread.txt

# æˆ–è€…ç›´æ¥æŸ¥çœ‹
jstack <pid>
```

#### æ­¥éª¤2ï¼šæŸ¥æ‰¾æ­»é”ä¿¡æ¯

```bash
# jstackä¼šè‡ªåŠ¨æ£€æµ‹æ­»é”
# åœ¨è¾“å‡ºçš„æœ€åä¼šæ˜¾ç¤ºæ­»é”ä¿¡æ¯

Found one Java-level deadlock:
=============================
"Thread-2":
  waiting to lock monitor 0x00007f8c3c001000 (object 0x00000000e0000000, a java.lang.Object),
  which is held by "Thread-1"
"Thread-1":
  waiting to lock monitor 0x00007f8c3c002000 (object 0x00000000e0000010, a java.lang.Object),
  which is held by "Thread-2"

Java stack information for the threads listed above:
===================================================
"Thread-2":
        at com.example.DeadlockDemo.lambda$main$1(DeadlockDemo.java:25)
        - waiting to lock <0x00000000e0000000> (a java.lang.Object)
        - locked <0x00000000e0000010> (a java.lang.Object)
        at com.example.DeadlockDemo$$Lambda$2/123456789.run(Unknown Source)
        at java.lang.Thread.run(Thread.java:748)
"Thread-1":
        at com.example.DeadlockDemo.lambda$main$0(DeadlockDemo.java:15)
        - waiting to lock <0x00000000e0000010> (a java.lang.Object)
        - locked <0x00000000e0000000> (a java.lang.Object)
        at com.example.DeadlockDemo$$Lambda$1/987654321.run(Unknown Source)
        at java.lang.Thread.run(Thread.java:748)

Found 1 deadlock.
```

#### æ­¥éª¤3ï¼šåˆ†ææ­»é”ä¿¡æ¯

```
åˆ†æè¦ç‚¹ï¼š

1. æ­»é”çº¿ç¨‹
   - Thread-1
   - Thread-2

2. æŒæœ‰çš„é”
   - Thread-1æŒæœ‰ï¼š0x00000000e0000000
   - Thread-2æŒæœ‰ï¼š0x00000000e0000010

3. ç­‰å¾…çš„é”
   - Thread-1ç­‰å¾…ï¼š0x00000000e0000010
   - Thread-2ç­‰å¾…ï¼š0x00000000e0000000

4. æ­»é”å…³ç³»
   Thread-1: æŒæœ‰lock1ï¼Œç­‰å¾…lock2
   Thread-2: æŒæœ‰lock2ï¼Œç­‰å¾…lock1
   å½¢æˆå¾ªç¯ç­‰å¾…

5. ä»£ç ä½ç½®
   - DeadlockDemo.java:15
   - DeadlockDemo.java:25
```

### 3.3 ä½¿ç”¨JConsoleæ£€æµ‹æ­»é”

```
æ­¥éª¤ï¼š
1. å¯åŠ¨JConsole
   jconsole <pid>

2. åˆ‡æ¢åˆ°"çº¿ç¨‹"æ ‡ç­¾

3. ç‚¹å‡»"æ£€æµ‹æ­»é”"æŒ‰é’®

4. æŸ¥çœ‹æ­»é”ä¿¡æ¯
   - æ˜¾ç¤ºæ­»é”çº¿ç¨‹
   - æ˜¾ç¤ºçº¿ç¨‹æ ˆ
   - æ˜¾ç¤ºé”ä¿¡æ¯
```

### 3.4 ä½¿ç”¨VisualVMæ£€æµ‹æ­»é”

```
æ­¥éª¤ï¼š
1. å¯åŠ¨VisualVM
   jvisualvm

2. è¿æ¥åˆ°åº”ç”¨

3. åˆ‡æ¢åˆ°"çº¿ç¨‹"æ ‡ç­¾

4. æŸ¥çœ‹çº¿ç¨‹çŠ¶æ€
   - BLOCKEDçº¿ç¨‹ï¼ˆçº¢è‰²ï¼‰
   - å¯èƒ½å­˜åœ¨æ­»é”

5. ç‚¹å‡»"çº¿ç¨‹Dump"
   - è‡ªåŠ¨æ£€æµ‹æ­»é”
   - æ˜¾ç¤ºæ­»é”ä¿¡æ¯
```

### 3.5 ä½¿ç”¨Arthasæ£€æµ‹æ­»é”

```bash
# å¯åŠ¨Arthas
java -jar arthas-boot.jar

# æ£€æµ‹æ­»é”
thread -b

# è¾“å‡ºç¤ºä¾‹
"Thread-1" Id=11 BLOCKED on java.lang.Object@12345678 owned by "Thread-2" Id=12
    at com.example.DeadlockDemo.lambda$main$0(DeadlockDemo.java:15)
    - waiting to lock <0x00000000e0000010> (a java.lang.Object)
    - locked <0x00000000e0000000> (a java.lang.Object)

"Thread-2" Id=12 BLOCKED on java.lang.Object@87654321 owned by "Thread-1" Id=11
    at com.example.DeadlockDemo.lambda$main$1(DeadlockDemo.java:25)
    - waiting to lock <0x00000000e0000000> (a java.lang.Object)
    - locked <0x00000000e0000010> (a java.lang.Object)
```

---

## å››ã€æ­»é”è§£å†³æ–¹æ¡ˆ

### 4.1 æ–¹æ¡ˆ1ï¼šå›ºå®šåŠ é”é¡ºåº

#### åŸç†

```
é—®é¢˜ï¼š
ä¸åŒçº¿ç¨‹ä»¥ä¸åŒé¡ºåºè·å–é”
å¯¼è‡´å¾ªç¯ç­‰å¾…

è§£å†³ï¼š
æ‰€æœ‰çº¿ç¨‹ä»¥ç›¸åŒé¡ºåºè·å–é”
é¿å…å¾ªç¯ç­‰å¾…
```

#### å®ç°

```java
/**
 * è½¬è´¦æ­»é”çš„è§£å†³æ–¹æ¡ˆï¼šå›ºå®šåŠ é”é¡ºåº
 */
public class TransferWithOrder {
    
    public static class Account {
        private int balance;
        private final int id;
        
        public Account(int id, int balance) {
            this.id = id;
            this.balance = balance;
        }
        
        public void debit(int amount) {
            balance -= amount;
        }
        
        public void credit(int amount) {
            balance += amount;
        }
    }
    
    // è§£å†³æ–¹æ¡ˆï¼šæŒ‰è´¦æˆ·IDé¡ºåºåŠ é”
    public void transfer(Account from, Account to, int amount) {
        Account first, second;
        
        // ç¡®å®šåŠ é”é¡ºåº
        if (from.id < to.id) {
            first = from;
            second = to;
        } else {
            first = to;
            second = from;
        }
        
        // æŒ‰é¡ºåºåŠ é”
        synchronized (first) {
            synchronized (second) {
                from.debit(amount);
                to.credit(amount);
            }
        }
    }
    
    public static void main(String[] args) {
        Account account1 = new Account(1, 1000);
        Account account2 = new Account(2, 1000);
        
        TransferWithOrder transfer = new TransferWithOrder();
        
        // çº¿ç¨‹1ï¼šaccount1 â†’ account2
        new Thread(() -> {
            transfer.transfer(account1, account2, 100);
        }).start();
        
        // çº¿ç¨‹2ï¼šaccount2 â†’ account1
        new Thread(() -> {
            transfer.transfer(account2, account1, 200);
        }).start();
        
        // ä¸ä¼šæ­»é”ï¼š
        // ä¸¤ä¸ªçº¿ç¨‹éƒ½æŒ‰ç…§ account1 â†’ account2 çš„é¡ºåºåŠ é”
    }
}
```

### 4.2 æ–¹æ¡ˆ2ï¼šä½¿ç”¨Lockçš„tryLock

#### åŸç†

```
é—®é¢˜ï¼š
synchronizedæ— æ³•è®¾ç½®è¶…æ—¶
çº¿ç¨‹å¯èƒ½æ°¸ä¹…ç­‰å¾…

è§£å†³ï¼š
ä½¿ç”¨Lock.tryLock(timeout)
è¶…æ—¶åæ”¾å¼ƒï¼Œé¿å…æ­»é”
```

#### å®ç°

```java
import java.util.concurrent.locks.Lock;
import java.util.concurrent.locks.ReentrantLock;
import java.util.concurrent.TimeUnit;

/**
 * ä½¿ç”¨tryLocké¿å…æ­»é”
 */
public class TransferWithTryLock {
    
    public static class Account {
        private int balance;
        private final Lock lock = new ReentrantLock();
        
        public Account(int balance) {
            this.balance = balance;
        }
        
        public void debit(int amount) {
            balance -= amount;
        }
        
        public void credit(int amount) {
            balance += amount;
        }
        
        public Lock getLock() {
            return lock;
        }
    }
    
    // ä½¿ç”¨tryLockï¼Œè®¾ç½®è¶…æ—¶
    public boolean transfer(Account from, Account to, int amount) throws InterruptedException {
        long timeout = 1000;  // 1ç§’è¶…æ—¶
        
        // å°è¯•è·å–ç¬¬ä¸€ä¸ªé”
        if (from.getLock().tryLock(timeout, TimeUnit.MILLISECONDS)) {
            try {
                // å°è¯•è·å–ç¬¬äºŒä¸ªé”
                if (to.getLock().tryLock(timeout, TimeUnit.MILLISECONDS)) {
                    try {
                        // æ‰§è¡Œè½¬è´¦
                        from.debit(amount);
                        to.credit(amount);
                        return true;
                    } finally {
                        to.getLock().unlock();
                    }
                }
            } finally {
                from.getLock().unlock();
            }
        }
        
        // è·å–é”å¤±è´¥
        return false;
    }
    
    public static void main(String[] args) {
        Account account1 = new Account(1000);
        Account account2 = new Account(1000);
        
        TransferWithTryLock transfer = new TransferWithTryLock();
        
        // çº¿ç¨‹1
        new Thread(() -> {
            try {
                boolean success = transfer.transfer(account1, account2, 100);
                System.out.println("Thread1 transfer: " + success);
            } catch (InterruptedException e) {
                e.printStackTrace();
            }
        }).start();
        
        // çº¿ç¨‹2
        new Thread(() -> {
            try {
                boolean success = transfer.transfer(account2, account1, 200);
                System.out.println("Thread2 transfer: " + success);
            } catch (InterruptedException e) {
                e.printStackTrace();
            }
        }).start();
        
        // ä¸ä¼šæ­»é”ï¼š
        // å¦‚æœè·å–é”è¶…æ—¶ï¼Œä¼šæ”¾å¼ƒå¹¶è¿”å›false
        // å¯ä»¥é‡è¯•æˆ–è®°å½•æ—¥å¿—
    }
}
```

### 4.3 æ–¹æ¡ˆ3ï¼šä½¿ç”¨å•ä¸€é”

#### åŸç†

```
é—®é¢˜ï¼š
å¤šä¸ªé”å¯èƒ½å¯¼è‡´æ­»é”

è§£å†³ï¼š
ä½¿ç”¨å•ä¸€é”ä¿æŠ¤æ‰€æœ‰èµ„æº
é¿å…å¤šé”é—®é¢˜
```

#### å®ç°

```java
/**
 * ä½¿ç”¨å•ä¸€é”é¿å…æ­»é”
 */
public class TransferWithSingleLock {
    
    // å…¨å±€é”
    private static final Object GLOBAL_LOCK = new Object();
    
    public static class Account {
        private int balance;
        
        public Account(int balance) {
            this.balance = balance;
        }
        
        public void debit(int amount) {
            balance -= amount;
        }
        
        public void credit(int amount) {
            balance += amount;
        }
    }
    
    // ä½¿ç”¨å…¨å±€é”
    public void transfer(Account from, Account to, int amount) {
        synchronized (GLOBAL_LOCK) {
            from.debit(amount);
            to.credit(amount);
        }
    }
    
    // ä¼˜ç‚¹ï¼š
    // - ä¸ä¼šæ­»é”
    // - å®ç°ç®€å•
    
    // ç¼ºç‚¹ï¼š
    // - å¹¶å‘æ€§èƒ½å·®
    // - æ‰€æœ‰è½¬è´¦ä¸²è¡Œæ‰§è¡Œ
}
```

### 4.4 æ–¹æ¡ˆ4ï¼šé¿å…åµŒå¥—é”

#### åŸç†

```
é—®é¢˜ï¼š
åµŒå¥—é”å®¹æ˜“å¯¼è‡´æ­»é”

è§£å†³ï¼š
é¿å…åœ¨æŒæœ‰é”çš„æƒ…å†µä¸‹è·å–å…¶ä»–é”
```

#### å®ç°

```java
/**
 * é¿å…åµŒå¥—é”
 */
public class TransferWithoutNesting {
    
    public static class Account {
        private int balance;
        
        public Account(int balance) {
            this.balance = balance;
        }
        
        public synchronized void debit(int amount) {
            balance -= amount;
        }
        
        public synchronized void credit(int amount) {
            balance += amount;
        }
    }
    
    // ä¸ä½¿ç”¨åµŒå¥—é”
    public void transfer(Account from, Account to, int amount) {
        // åˆ†åˆ«è°ƒç”¨ï¼Œä¸åµŒå¥—
        from.debit(amount);
        to.credit(amount);
    }
    
    // æ³¨æ„ï¼š
    // è¿™ç§æ–¹å¼ä¸æ˜¯åŸå­æ“ä½œ
    // å¯èƒ½å‡ºç°æ•°æ®ä¸ä¸€è‡´
    // éœ€è¦æ ¹æ®ä¸šåŠ¡åœºæ™¯é€‰æ‹©
}
```

---

## äº”ã€æ­»é”é¢„é˜²

### 5.1 è®¾è®¡åŸåˆ™

```
åŸåˆ™1ï¼šé¿å…åµŒå¥—é”
- å°½é‡ä¸è¦åœ¨æŒæœ‰é”æ—¶è·å–å…¶ä»–é”
- å¦‚æœå¿…é¡»åµŒå¥—ï¼Œç¡®ä¿é¡ºåºä¸€è‡´

åŸåˆ™2ï¼šå›ºå®šåŠ é”é¡ºåº
- ä¸ºé”å®šä¹‰å…¨å±€é¡ºåº
- æ‰€æœ‰çº¿ç¨‹æŒ‰ç›¸åŒé¡ºåºè·å–é”

åŸåˆ™3ï¼šä½¿ç”¨è¶…æ—¶æœºåˆ¶
- ä½¿ç”¨tryLockè®¾ç½®è¶…æ—¶
- è¶…æ—¶åæ”¾å¼ƒå¹¶é‡è¯•

åŸåˆ™4ï¼šå‡å°é”çš„ç²’åº¦
- åªé”å¿…è¦çš„ä»£ç 
- å‡å°‘æŒé”æ—¶é—´

åŸåˆ™5ï¼šä½¿ç”¨å¹¶å‘å·¥å…·ç±»
- ä½¿ç”¨ConcurrentHashMap
- ä½¿ç”¨åŸå­ç±»
- é¿å…æ‰‹åŠ¨åŠ é”
```

### 5.2 ç¼–ç è§„èŒƒ

```java
/**
 * æ­»é”é¢„é˜²æœ€ä½³å®è·µ
 */
public class DeadlockPrevention {
    
    // 1. é¿å…åµŒå¥—é”
    public void badExample() {
        synchronized (lock1) {
            synchronized (lock2) {  // åµŒå¥—é”ï¼Œå±é™©
                // ä¸šåŠ¡é€»è¾‘
            }
        }
    }
    
    public void goodExample() {
        synchronized (lock1) {
            // ä¸šåŠ¡é€»è¾‘1
        }
        synchronized (lock2) {
            // ä¸šåŠ¡é€»è¾‘2
        }
    }
    
    // 2. ä½¿ç”¨tryLock
    private Lock lock = new ReentrantLock();
    
    public void withTryLock() {
        try {
            if (lock.tryLock(1, TimeUnit.SECONDS)) {
                try {
                    // ä¸šåŠ¡é€»è¾‘
                } finally {
                    lock.unlock();
                }
            } else {
                // è·å–é”å¤±è´¥ï¼Œè®°å½•æ—¥å¿—æˆ–é‡è¯•
            }
        } catch (InterruptedException e) {
            Thread.currentThread().interrupt();
        }
    }
    
    // 3. ä½¿ç”¨å¹¶å‘å·¥å…·ç±»
    private ConcurrentHashMap<String, Object> map = new ConcurrentHashMap<>();
    
    public void useConcurrentUtils() {
        // ä¸éœ€è¦æ‰‹åŠ¨åŠ é”
        map.put("key", "value");
    }
    
    // 4. å‡å°é”çš„ç²’åº¦
    public void fineLock() {
        // å‡†å¤‡æ•°æ®ï¼ˆä¸éœ€è¦é”ï¼‰
        Object data = prepareData();
        
        // åªé”å¿…è¦çš„éƒ¨åˆ†
        synchronized (lock) {
            // æœ€å°åŒ–çš„ä¸´ç•ŒåŒº
            updateSharedState(data);
        }
        
        // åç»­å¤„ç†ï¼ˆä¸éœ€è¦é”ï¼‰
        postProcess();
    }
}
```

### 5.3 Code Reviewæ£€æŸ¥æ¸…å•

```
â–¡ é”çš„ä½¿ç”¨
  â–¡ æ˜¯å¦æœ‰åµŒå¥—é”
  â–¡ åŠ é”é¡ºåºæ˜¯å¦ä¸€è‡´
  â–¡ æ˜¯å¦æœ‰è¶…æ—¶æœºåˆ¶

â–¡ é”çš„ç²’åº¦
  â–¡ é”çš„èŒƒå›´æ˜¯å¦æœ€å°
  â–¡ æ˜¯å¦å¯ä»¥ä½¿ç”¨å¹¶å‘å·¥å…·ç±»
  â–¡ æ˜¯å¦å¯ä»¥æ— é”åŒ–

â–¡ å¼‚å¸¸å¤„ç†
  â–¡ finallyä¸­æ˜¯å¦é‡Šæ”¾é”
  â–¡ æ˜¯å¦æœ‰æ­»é”æ£€æµ‹
  â–¡ æ˜¯å¦æœ‰æ—¥å¿—è®°å½•

â–¡ æ€§èƒ½è€ƒè™‘
  â–¡ æ˜¯å¦å½±å“å¹¶å‘æ€§èƒ½
  â–¡ æ˜¯å¦æœ‰é”ç«äº‰
  â–¡ æ˜¯å¦å¯ä»¥ä¼˜åŒ–
```

---

## å…­ã€æ­»é” vs æ´»é” vs é¥¥é¥¿

### 6.1 æ­»é”ï¼ˆDeadlockï¼‰

```
å®šä¹‰ï¼š
çº¿ç¨‹äº’ç›¸ç­‰å¾…å¯¹æ–¹æŒæœ‰çš„èµ„æº
æ°¸ä¹…é˜»å¡

ç‰¹å¾ï¼š
- çº¿ç¨‹çŠ¶æ€ï¼šBLOCKED
- æ— æ³•ç»§ç»­æ‰§è¡Œ
- éœ€è¦å¤–éƒ¨å¹²é¢„

ç¤ºä¾‹ï¼š
Thread-1æŒæœ‰Aï¼Œç­‰å¾…B
Thread-2æŒæœ‰Bï¼Œç­‰å¾…A
```

### 6.2 æ´»é”ï¼ˆLivelockï¼‰

```
å®šä¹‰ï¼š
çº¿ç¨‹ä¸æ–­é‡è¯•
ä½†å§‹ç»ˆæ— æ³•æˆåŠŸ
ä¸€ç›´åœ¨è¿è¡Œä½†æ²¡æœ‰è¿›å±•

ç‰¹å¾ï¼š
- çº¿ç¨‹çŠ¶æ€ï¼šRUNNABLE
- CPUå ç”¨é«˜
- æ²¡æœ‰å®é™…è¿›å±•

ç¤ºä¾‹ï¼š
ä¸¤ä¸ªäººåœ¨èµ°å»Šç›¸é‡
éƒ½æƒ³è®©å¯¹æ–¹å…ˆè¿‡
ä¸æ–­å·¦å³ç§»åŠ¨
ä½†éƒ½æ— æ³•é€šè¿‡
```

```java
/**
 * æ´»é”ç¤ºä¾‹
 */
public class LivelockDemo {
    
    static class Spoon {
        private Diner owner;
        
        public synchronized void use() {
            System.out.println(owner.name + " is eating");
        }
        
        public synchronized void setOwner(Diner diner) {
            this.owner = diner;
        }
        
        public synchronized Diner getOwner() {
            return owner;
        }
    }
    
    static class Diner {
        private String name;
        private boolean isHungry;
        
        public Diner(String name) {
            this.name = name;
            this.isHungry = true;
        }
        
        public void eatWith(Spoon spoon, Diner spouse) {
            while (isHungry) {
                // å¦‚æœå‹ºå­ä¸æ˜¯è‡ªå·±çš„
                if (spoon.getOwner() != this) {
                    try {
                        Thread.sleep(1);
                    } catch (InterruptedException e) {
                        continue;
                    }
                    continue;
                }
                
                // å¦‚æœé…å¶é¥¿äº†ï¼Œè®©ç»™é…å¶
                if (spouse.isHungry) {
                    System.out.println(name + ": ä½ å…ˆåƒå§");
                    spoon.setOwner(spouse);
                    continue;
                }
                
                // åƒé¥­
                spoon.use();
                isHungry = false;
                spoon.setOwner(spouse);
            }
        }
    }
    
    public static void main(String[] args) {
        Diner husband = new Diner("ä¸ˆå¤«");
        Diner wife = new Diner("å¦»å­");
        
        Spoon spoon = new Spoon();
        spoon.setOwner(husband);
        
        new Thread(() -> husband.eatWith(spoon, wife)).start();
        new Thread(() -> wife.eatWith(spoon, husband)).start();
        
        // æ´»é”ï¼š
        // ä¸¤äººéƒ½æƒ³è®©å¯¹æ–¹å…ˆåƒ
        // ä¸æ–­æŠŠå‹ºå­è®©ç»™å¯¹æ–¹
        // ä½†éƒ½åƒä¸åˆ°é¥­
    }
}
```

### 6.3 é¥¥é¥¿ï¼ˆStarvationï¼‰

```
å®šä¹‰ï¼š
çº¿ç¨‹é•¿æ—¶é—´æ— æ³•è·å–æ‰€éœ€èµ„æº
ä¸€ç›´ç­‰å¾…

ç‰¹å¾ï¼š
- çº¿ç¨‹çŠ¶æ€ï¼šWAITING/TIMED_WAITING
- ä½ä¼˜å…ˆçº§çº¿ç¨‹
- å¯èƒ½æœ€ç»ˆè·å¾—èµ„æº

åŸå› ï¼š
1. ä¼˜å…ˆçº§è®¾ç½®ä¸å½“
2. é”è¢«é•¿æ—¶é—´å ç”¨
3. èµ„æºåˆ†é…ä¸å…¬å¹³

ç¤ºä¾‹ï¼š
é«˜ä¼˜å…ˆçº§çº¿ç¨‹ä¸€ç›´æŠ¢å CPU
ä½ä¼˜å…ˆçº§çº¿ç¨‹æ— æ³•æ‰§è¡Œ
```

```java
/**
 * é¥¥é¥¿ç¤ºä¾‹
 */
public class StarvationDemo {
    
    private static final Object lock = new Object();
    
    public static void main(String[] args) {
        // é«˜ä¼˜å…ˆçº§çº¿ç¨‹
        Thread highPriority = new Thread(() -> {
            while (true) {
                synchronized (lock) {
                    // é•¿æ—¶é—´æŒæœ‰é”
                    try {
                        Thread.sleep(100);
                    } catch (InterruptedException e) {
                        e.printStackTrace();
                    }
                }
            }
        });
        highPriority.setPriority(Thread.MAX_PRIORITY);
        highPriority.start();
        
        // ä½ä¼˜å…ˆçº§çº¿ç¨‹
        Thread lowPriority = new Thread(() -> {
            while (true) {
                synchronized (lock) {
                    System.out.println("ä½ä¼˜å…ˆçº§çº¿ç¨‹è·å¾—é”");
                }
            }
        });
        lowPriority.setPriority(Thread.MIN_PRIORITY);
        lowPriority.start();
        
        // é¥¥é¥¿ï¼š
        // ä½ä¼˜å…ˆçº§çº¿ç¨‹å¾ˆéš¾è·å¾—é”
        // å¯èƒ½é•¿æ—¶é—´æ— æ³•æ‰§è¡Œ
    }
}
```

### 6.4 å¯¹æ¯”æ€»ç»“

| å¯¹æ¯”é¡¹ | æ­»é” | æ´»é” | é¥¥é¥¿ |
|-------|------|------|------|
| **çº¿ç¨‹çŠ¶æ€** | BLOCKED | RUNNABLE | WAITING |
| **CPUå ç”¨** | ä½ | é«˜ | ä½ |
| **æ˜¯å¦æœ‰è¿›å±•** | æ—  | æ—  | å¯èƒ½æœ‰ |
| **èƒ½å¦è‡ªåŠ¨æ¢å¤** | å¦ | å¯èƒ½ | å¯èƒ½ |
| **æ£€æµ‹éš¾åº¦** | å®¹æ˜“ | å›°éš¾ | ä¸­ç­‰ |

---

## ä¸ƒã€æ€»ç»“

### 7.1 æ­»é”æ£€æµ‹

```
å·¥å…·ï¼š
1. jstack <pid>
2. JConsole
3. VisualVM
4. Arthas

æ–¹æ³•ï¼š
1. æŸ¥çœ‹BLOCKEDçº¿ç¨‹
2. åˆ†æé”æŒæœ‰å…³ç³»
3. æ‰¾åˆ°å¾ªç¯ç­‰å¾…
```

### 7.2 æ­»é”é¢„é˜²

```
ç­–ç•¥ï¼š
1. å›ºå®šåŠ é”é¡ºåº
2. ä½¿ç”¨tryLockè¶…æ—¶
3. é¿å…åµŒå¥—é”
4. ä½¿ç”¨å¹¶å‘å·¥å…·ç±»
5. å‡å°é”ç²’åº¦
```

### 7.3 æœ€ä½³å®è·µ

```
1. è®¾è®¡é˜¶æ®µè€ƒè™‘å¹¶å‘
2. éµå¾ªåŠ é”è§„èŒƒ
3. Code Reviewæ£€æŸ¥
4. å‹åŠ›æµ‹è¯•éªŒè¯
5. ç”Ÿäº§ç¯å¢ƒç›‘æ§
```

---

**ä¸‹ä¸€ç¯‡**ï¼š[æ€§èƒ½è°ƒä¼˜æœ€ä½³å®è·µ](./06_æ€§èƒ½è°ƒä¼˜æœ€ä½³å®è·µ.md)
