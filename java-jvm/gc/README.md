# åƒåœ¾å›æ”¶ï¼ˆGCï¼‰

## ğŸ“š æ¨¡å—ç®€ä»‹

æœ¬æ¨¡å—æ·±å…¥è®²è§£JVMåƒåœ¾å›æ”¶æœºåˆ¶ï¼ŒåŒ…æ‹¬GCç®—æ³•ã€åˆ†ä»£å›æ”¶ã€åƒåœ¾æ”¶é›†å™¨ã€GCè°ƒä¼˜ç­‰æ ¸å¿ƒå†…å®¹ã€‚

## ğŸ¯ å­¦ä¹ ç›®æ ‡

- âœ… ç†è§£åƒåœ¾å›æ”¶çš„åŸºæœ¬åŸç†
- âœ… æŒæ¡å„ç§GCç®—æ³•çš„ç‰¹ç‚¹
- âœ… ç†è§£åˆ†ä»£åƒåœ¾å›æ”¶æ¨¡å‹
- âœ… æŒæ¡å„ç§åƒåœ¾æ”¶é›†å™¨çš„ä½¿ç”¨
- âœ… èƒ½å¤Ÿåˆ†æGCæ—¥å¿—å’Œè°ƒä¼˜
- âœ… æŒæ¡GCæ€§èƒ½ä¼˜åŒ–æŠ€å·§

## ğŸ“‚ ç›®å½•ç»“æ„

```
gc/
â”œâ”€â”€ docs/                                      # æ–‡æ¡£ç›®å½•
â”‚   â”œâ”€â”€ 01_åƒåœ¾å›æ”¶åŸºç¡€ä¸ç®—æ³•.md                # GCåŸºç¡€å’Œç®—æ³•
â”‚   â”œâ”€â”€ 02_åˆ†ä»£åƒåœ¾å›æ”¶.md                      # åˆ†ä»£æ¨¡å‹
â”‚   â”œâ”€â”€ 03_åƒåœ¾æ”¶é›†å™¨è¯¦è§£.md                    # å„ç§æ”¶é›†å™¨
â”‚   â””â”€â”€ 04_GCè°ƒä¼˜å®æˆ˜.md                        # è°ƒä¼˜å®æˆ˜
â”œâ”€â”€ demo/                                      # æ¼”ç¤ºä»£ç 
â”‚   â”œâ”€â”€ GCAlgorithmDemo.java                   # GCç®—æ³•æ¼”ç¤º
â”‚   â”œâ”€â”€ GCCollectorDemo.java                   # æ”¶é›†å™¨æ¼”ç¤º
â”‚   â””â”€â”€ GCTuningDemo.java                      # è°ƒä¼˜æ¼”ç¤º
â”œâ”€â”€ project/                                   # å®æˆ˜é¡¹ç›®
â”‚   â”œâ”€â”€ GCMonitor.java                         # GCç›‘æ§å·¥å…·
â”‚   â””â”€â”€ MemoryLeakDetector.java                # å†…å­˜æ³„æ¼æ£€æµ‹å·¥å…·
â””â”€â”€ README.md                                  # æœ¬æ–‡ä»¶
```

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. å­¦ä¹ GCåŸºç¡€ä¸ç®—æ³•

**é˜…è¯»æ–‡æ¡£**ï¼š`docs/01_åƒåœ¾å›æ”¶åŸºç¡€ä¸ç®—æ³•.md`

**è¿è¡ŒDemo**ï¼š
```bash
cd demo
javac GCAlgorithmDemo.java
java com.example.jvm.gc.demo.GCAlgorithmDemo
```

**å…³é”®é—®é¢˜**ï¼š
- â“ ä»€ä¹ˆæ˜¯åƒåœ¾å›æ”¶ï¼Ÿä¸ºä»€ä¹ˆéœ€è¦GCï¼Ÿ
- â“ å¦‚ä½•åˆ¤æ–­å¯¹è±¡æ˜¯å¦å¯ä»¥å›æ”¶ï¼Ÿ
- â“ æœ‰å“ªäº›GCç®—æ³•ï¼Ÿå„æœ‰ä»€ä¹ˆç‰¹ç‚¹ï¼Ÿ
- â“ ä»€ä¹ˆæ˜¯GC Rootsï¼Ÿ
- â“ å¼•ç”¨ç±»å‹æœ‰å“ªäº›ï¼Ÿ

### 2. å­¦ä¹ åˆ†ä»£åƒåœ¾å›æ”¶

**é˜…è¯»æ–‡æ¡£**ï¼š`docs/02_åˆ†ä»£åƒåœ¾å›æ”¶.md`

**å…³é”®é—®é¢˜**ï¼š
- â“ ä¸ºä»€ä¹ˆè¦åˆ†ä»£ï¼Ÿ
- â“ æ–°ç”Ÿä»£å’Œè€å¹´ä»£å¦‚ä½•åˆ’åˆ†ï¼Ÿ
- â“ Minor GCå’ŒFull GCçš„åŒºåˆ«ï¼Ÿ
- â“ å¯¹è±¡å¦‚ä½•æ™‹å‡åˆ°è€å¹´ä»£ï¼Ÿ
- â“ ä»€ä¹ˆæ˜¯ç©ºé—´åˆ†é…æ‹…ä¿ï¼Ÿ

### 3. å­¦ä¹ åƒåœ¾æ”¶é›†å™¨

**é˜…è¯»æ–‡æ¡£**ï¼š`docs/03_åƒåœ¾æ”¶é›†å™¨è¯¦è§£.md`

**è¿è¡ŒDemo**ï¼š
```bash
# Serial GC
java -XX:+UseSerialGC -Xms20M -Xmx20M -XX:+PrintGCDetails \
     com.example.jvm.gc.demo.GCCollectorDemo

# G1 GC
java -XX:+UseG1GC -Xms20M -Xmx20M -XX:+PrintGCDetails \
     com.example.jvm.gc.demo.GCCollectorDemo
```

**å…³é”®é—®é¢˜**ï¼š
- â“ æœ‰å“ªäº›åƒåœ¾æ”¶é›†å™¨ï¼Ÿ
- â“ Serialã€Parallelã€CMSã€G1ã€ZGCæœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ
- â“ å¦‚ä½•é€‰æ‹©åˆé€‚çš„æ”¶é›†å™¨ï¼Ÿ
- â“ G1çš„å·¥ä½œåŸç†æ˜¯ä»€ä¹ˆï¼Ÿ

### 4. å­¦ä¹ GCè°ƒä¼˜

**é˜…è¯»æ–‡æ¡£**ï¼š`docs/04_GCè°ƒä¼˜å®æˆ˜.md`

**è¿è¡ŒDemo**ï¼š
```bash
java -XX:+PrintGCDetails -XX:+PrintGCDateStamps \
     -Xloggc:gc.log \
     com.example.jvm.gc.demo.GCTuningDemo
```

**å…³é”®é—®é¢˜**ï¼š
- â“ å¦‚ä½•åˆ†æGCæ—¥å¿—ï¼Ÿ
- â“ å¸¸è§çš„GCé—®é¢˜æœ‰å“ªäº›ï¼Ÿ
- â“ å¦‚ä½•åˆ¶å®šè°ƒä¼˜æ–¹æ¡ˆï¼Ÿ
- â“ æœ‰å“ªäº›è°ƒä¼˜å·¥å…·ï¼Ÿ

### 5. å®æˆ˜é¡¹ç›®

#### 5.1 GCç›‘æ§å·¥å…·

**è¿è¡Œé¡¹ç›®**ï¼š
```bash
cd project
javac GCMonitor.java
java com.example.jvm.gc.project.GCMonitor
```

**åŠŸèƒ½ç‰¹æ€§**ï¼š
- âœ… å®æ—¶ç›‘æ§GCæ´»åŠ¨
- âœ… ç»Ÿè®¡GCæŒ‡æ ‡ï¼ˆæ¬¡æ•°ã€æ—¶é—´ã€ååé‡ï¼‰
- âœ… æ£€æµ‹GCå¼‚å¸¸ï¼ˆåœé¡¿æ—¶é—´è¿‡é•¿ã€é¢‘ç‡è¿‡é«˜ï¼‰
- âœ… ç”ŸæˆGCç›‘æ§æŠ¥å‘Š
- âœ… GCå‘Šè­¦æœºåˆ¶

**åº”ç”¨åœºæ™¯**ï¼š
- ç”Ÿäº§ç¯å¢ƒGCç›‘æ§
- æ€§èƒ½æµ‹è¯•GCåˆ†æ
- GCé—®é¢˜æ’æŸ¥

#### 5.2 å†…å­˜æ³„æ¼æ£€æµ‹å·¥å…·

**è¿è¡Œé¡¹ç›®**ï¼š
```bash
cd project
javac MemoryLeakDetector.java
java com.example.jvm.gc.project.MemoryLeakDetector
```

**åŠŸèƒ½ç‰¹æ€§**ï¼š
- âœ… æ£€æµ‹å¸¸è§å†…å­˜æ³„æ¼æ¨¡å¼
- âœ… åˆ†æå †å†…å­˜å¢é•¿è¶‹åŠ¿
- âœ… æ£€æµ‹å¯¹è±¡æ³„æ¼
- âœ… ç”Ÿæˆæ³„æ¼æŠ¥å‘Š
- âœ… æä¾›ä¿®å¤å»ºè®®

**æ£€æµ‹æ¨¡å¼**ï¼š
1. é™æ€é›†åˆæŒæœ‰å¯¹è±¡
2. ç›‘å¬å™¨æœªæ³¨é”€
3. ThreadLocalæœªæ¸…ç†
4. èµ„æºæœªå…³é—­

## ğŸ“Š æ ¸å¿ƒçŸ¥è¯†ç‚¹

### 1. å¯¹è±¡å­˜æ´»åˆ¤å®š

```
å¼•ç”¨è®¡æ•°æ³•ï¼š
- ä¸ºå¯¹è±¡ç»´æŠ¤å¼•ç”¨è®¡æ•°
- è®¡æ•°ä¸º0æ—¶å›æ”¶
- é—®é¢˜ï¼šæ— æ³•è§£å†³å¾ªç¯å¼•ç”¨

å¯è¾¾æ€§åˆ†æï¼š
- ä»GC Rootså‡ºå‘éå†å¯¹è±¡å›¾
- å¯è¾¾çš„å¯¹è±¡å­˜æ´»ï¼Œä¸å¯è¾¾çš„å›æ”¶
- Javaé‡‡ç”¨æ­¤æ–¹æ³•
```

### 2. GCç®—æ³•

| ç®—æ³• | ä¼˜ç‚¹ | ç¼ºç‚¹ | é€‚ç”¨åœºæ™¯ |
|------|------|------|---------|
| **æ ‡è®°-æ¸…é™¤** | å®ç°ç®€å• | äº§ç”Ÿç¢ç‰‡ | è€å¹´ä»£ |
| **æ ‡è®°-å¤åˆ¶** | æ— ç¢ç‰‡ï¼Œé€Ÿåº¦å¿« | æµªè´¹ç©ºé—´ | æ–°ç”Ÿä»£ |
| **æ ‡è®°-æ•´ç†** | æ— ç¢ç‰‡ï¼Œä¸æµªè´¹ç©ºé—´ | ç§»åŠ¨å¯¹è±¡æ…¢ | è€å¹´ä»£ |

### 3. åˆ†ä»£æ¨¡å‹

```
æ–°ç”Ÿä»£ï¼ˆYoung Generationï¼‰ï¼š
â”œâ”€ EdenåŒºï¼ˆ80%ï¼‰
â”œâ”€ Survivor0ï¼ˆ10%ï¼‰
â””â”€ Survivor1ï¼ˆ10%ï¼‰

è€å¹´ä»£ï¼ˆOld Generationï¼‰ï¼š
â””â”€ å­˜æ”¾é•¿æœŸå­˜æ´»å¯¹è±¡

Minor GCï¼šå›æ”¶æ–°ç”Ÿä»£
Full GCï¼šå›æ”¶æ•´ä¸ªå †
```

### 4. åƒåœ¾æ”¶é›†å™¨

| æ”¶é›†å™¨ | ç±»å‹ | åœé¡¿æ—¶é—´ | ååé‡ | é€‚ç”¨åœºæ™¯ |
|-------|------|---------|--------|---------|
| **Serial** | ä¸²è¡Œ | é•¿ | é«˜ | å•æ ¸ï¼Œå°å † |
| **Parallel** | å¹¶è¡Œ | é•¿ | æœ€é«˜ | å¤šæ ¸ï¼Œåå°è®¡ç®— |
| **CMS** | å¹¶å‘ | çŸ­ | ä¸­ | äº’è”ç½‘åº”ç”¨ |
| **G1** | å¹¶å‘ | å¯æ§ | é«˜ | å¤§å †ï¼Œä½å»¶è¿Ÿ |
| **ZGC** | å¹¶å‘ | æçŸ­ | ä¸­ | è¶…å¤§å †ï¼Œè¶…ä½å»¶è¿Ÿ |

### 5. å¼•ç”¨ç±»å‹

```
å¼ºå¼•ç”¨ > è½¯å¼•ç”¨ > å¼±å¼•ç”¨ > è™šå¼•ç”¨

å¼ºå¼•ç”¨ï¼šæ°¸ä¸å›æ”¶
è½¯å¼•ç”¨ï¼šå†…å­˜ä¸è¶³æ—¶å›æ”¶
å¼±å¼•ç”¨ï¼šä¸‹æ¬¡GCæ—¶å›æ”¶
è™šå¼•ç”¨ï¼šè·Ÿè¸ªå›æ”¶çŠ¶æ€
```

## ğŸ› ï¸ å¸¸ç”¨å·¥å…·

### 1. å‘½ä»¤è¡Œå·¥å…·

```bash
# æŸ¥çœ‹GCç»Ÿè®¡
jstat -gc <pid> 1000 10

# ç”Ÿæˆå †è½¬å‚¨
jmap -dump:format=b,file=heap.hprof <pid>

# æŸ¥çœ‹å †ä¿¡æ¯
jmap -heap <pid>

# æŸ¥çœ‹å¯¹è±¡ç»Ÿè®¡
jmap -histo <pid> | head -20
```

### 2. å¯è§†åŒ–å·¥å…·

- **JConsole**ï¼šJDKè‡ªå¸¦ï¼Œå®æ—¶ç›‘æ§
- **VisualVM**ï¼šåŠŸèƒ½å¼ºå¤§ï¼Œæ”¯æŒæ’ä»¶
- **MAT**ï¼šå †è½¬å‚¨åˆ†æï¼ŒæŸ¥æ‰¾å†…å­˜æ³„æ¼
- **GCEasy**ï¼šåœ¨çº¿GCæ—¥å¿—åˆ†æ
- **Arthas**ï¼šåœ¨çº¿è¯Šæ–­å·¥å…·

### 3. GCæ—¥å¿—å‚æ•°

```bash
# JDK 8
java -XX:+PrintGCDetails \
     -XX:+PrintGCDateStamps \
     -XX:+PrintGCTimeStamps \
     -Xloggc:gc.log \
     -XX:+UseGCLogFileRotation \
     -XX:NumberOfGCLogFiles=5 \
     -XX:GCLogFileSize=20M \
     -jar app.jar

# JDK 9+
java -Xlog:gc*:file=gc.log:time,uptime,level,tags \
     -jar app.jar
```

## ğŸ’¡ æœ€ä½³å®è·µ

### 1. é€‰æ‹©åˆé€‚çš„GC

```bash
# å°å‹åº”ç”¨ï¼ˆ<2GBï¼‰
java -XX:+UseSerialGC -Xms512m -Xmx512m

# ä¸­å‹åº”ç”¨ï¼ˆ2-8GBï¼‰
java -XX:+UseG1GC -Xms4g -Xmx4g -XX:MaxGCPauseMillis=200

# å¤§å‹åº”ç”¨ï¼ˆ>8GBï¼‰
java -XX:+UseG1GC -Xms16g -Xmx16g -XX:MaxGCPauseMillis=100

# è¶…å¤§å‹åº”ç”¨ï¼ˆ>32GBï¼‰
java -XX:+UseZGC -Xms64g -Xmx64g
```

### 2. å †å¤§å°è®¾ç½®

```bash
# åŸºæœ¬åŸåˆ™
-Xms = -Xmx  # é¿å…åŠ¨æ€æ‰©å±•
-Xmn = å †çš„1/3åˆ°1/2  # æ–°ç”Ÿä»£å¤§å°

# ç¤ºä¾‹
java -Xms4g -Xmx4g -Xmn2g -jar app.jar
```

### 3. ä»£ç ä¼˜åŒ–

```java
// 1. å‡å°‘å¯¹è±¡åˆ›å»º
String str = "hello";  // å¥½
String str = new String("hello");  // ä¸å¥½

// 2. ä½¿ç”¨å¯¹è±¡æ± 
ObjectPool<Connection> pool = new ObjectPool<>();

// 3. åŠæ—¶é‡Šæ”¾å¼•ç”¨
list.clear();
obj = null;

// 4. ä½¿ç”¨åˆé€‚çš„é›†åˆå¤§å°
List<String> list = new ArrayList<>(1000);

// 5. é¿å…åœ¨å¾ªç¯ä¸­åˆ›å»ºå¯¹è±¡
String str = "test";
for (int i = 0; i < 10000; i++) {
    // ä½¿ç”¨str
}
```

### 4. ç›‘æ§å‘Šè­¦

```
å…³é”®æŒ‡æ ‡ï¼š
- Minor GCé¢‘ç‡ï¼š< 1æ¬¡/ç§’
- Minor GCè€—æ—¶ï¼š< 50ms
- Full GCé¢‘ç‡ï¼š< 1æ¬¡/å°æ—¶
- Full GCè€—æ—¶ï¼š< 1ç§’
- å †å†…å­˜ä½¿ç”¨ç‡ï¼š60-80%
```

## ğŸ“ å¸¸è§é—®é¢˜

### Q1: å¦‚ä½•åˆ¤æ–­æ˜¯å¦éœ€è¦GCè°ƒä¼˜ï¼Ÿ

**A**: å‡ºç°ä»¥ä¸‹æƒ…å†µéœ€è¦è°ƒä¼˜ï¼š
1. é¢‘ç¹Full GCï¼ˆæ¯å°æ—¶è¶…è¿‡1æ¬¡ï¼‰
2. GCåœé¡¿æ—¶é—´é•¿ï¼ˆè¶…è¿‡1ç§’ï¼‰
3. åº”ç”¨å“åº”æ…¢
4. å†…å­˜ä½¿ç”¨ç‡è¿‡é«˜ï¼ˆè¶…è¿‡90%ï¼‰
5. å‡ºç°OOM

### Q2: Minor GCå’ŒFull GCçš„åŒºåˆ«ï¼Ÿ

**A**:
- **Minor GC**ï¼šå›æ”¶æ–°ç”Ÿä»£ï¼Œé¢‘ç‡é«˜ï¼Œé€Ÿåº¦å¿«
- **Full GC**ï¼šå›æ”¶æ•´ä¸ªå †ï¼Œé¢‘ç‡ä½ï¼Œé€Ÿåº¦æ…¢

### Q3: å¦‚ä½•å‡å°‘Full GCï¼Ÿ

**A**:
1. å¢å¤§å †å†…å­˜
2. å¢å¤§æ–°ç”Ÿä»£
3. ä¼˜åŒ–ä»£ç ï¼Œå‡å°‘å¯¹è±¡åˆ›å»º
4. é¿å…å¤§å¯¹è±¡
5. ä½¿ç”¨G1æˆ–ZGC

### Q4: G1å’ŒCMSçš„åŒºåˆ«ï¼Ÿ

**A**:
- **G1**ï¼šåˆ†åŒºæ¨¡å‹ï¼Œå¯é¢„æµ‹åœé¡¿ï¼Œæ— ç¢ç‰‡
- **CMS**ï¼šåˆ†ä»£æ¨¡å‹ï¼Œä½å»¶è¿Ÿï¼Œæœ‰ç¢ç‰‡

### Q5: ä»€ä¹ˆæ—¶å€™ä½¿ç”¨ZGCï¼Ÿ

**A**:
- å †å†…å­˜è¶…è¿‡32GB
- è¦æ±‚åœé¡¿æ—¶é—´å°äº10ms
- JDK 11+

## ğŸ“ è¿›é˜¶å­¦ä¹ 

### 1. GCç®—æ³•æ¼”è¿›

```
Serial â†’ Parallel â†’ CMS â†’ G1 â†’ ZGC

è¶‹åŠ¿ï¼š
- æ›´ä½çš„å»¶è¿Ÿ
- æ›´å¤§çš„å †æ”¯æŒ
- æ›´æ™ºèƒ½çš„è°ƒä¼˜
```

### 2. æ–°ä¸€ä»£GC

- **ZGC**ï¼šè¶…ä½å»¶è¿Ÿï¼ˆ<10msï¼‰
- **Shenandoah**ï¼šä½å»¶è¿Ÿï¼ŒRedHatå¼€å‘
- **Epsilon**ï¼šæ— æ“ä½œGCï¼Œç”¨äºæµ‹è¯•

### 3. GCè°ƒä¼˜æ¡ˆä¾‹

å‚è€ƒ`docs/04_GCè°ƒä¼˜å®æˆ˜.md`ä¸­çš„å®æˆ˜æ¡ˆä¾‹ï¼š
- ç”µå•†ç³»ç»ŸGCè°ƒä¼˜
- å¤§æ•°æ®å¤„ç†ç³»ç»Ÿè°ƒä¼˜

## ğŸ“š å‚è€ƒèµ„æ–™

1. **ã€Šæ·±å…¥ç†è§£Javaè™šæ‹Ÿæœºï¼ˆç¬¬3ç‰ˆï¼‰ã€‹** - å‘¨å¿—æ˜
2. **ã€ŠJavaæ€§èƒ½æƒå¨æŒ‡å—ã€‹** - Scott Oaks
3. **Oracle GCè°ƒä¼˜æŒ‡å—** - https://docs.oracle.com/javase/8/docs/technotes/guides/vm/gctuning/
4. **GCEasy** - https://gceasy.io/
5. **ZGCå®˜æ–¹æ–‡æ¡£** - https://wiki.openjdk.java.net/display/zgc

## ğŸ”— ç›¸å…³æ¨¡å—

- [JVMå†…å­˜æ¨¡å‹](../memory/README.md)
- [ç±»åŠ è½½æœºåˆ¶](../classloader/README.md)
- [æ€§èƒ½è°ƒä¼˜](../tuning/README.md)

---

**å­¦ä¹ å»ºè®®**ï¼š
1. å…ˆç†è§£GCåŸºç¡€ç†è®º
2. æŒæ¡å„ç§æ”¶é›†å™¨ç‰¹ç‚¹
3. å­¦ä¼šåˆ†æGCæ—¥å¿—
4. å®è·µè°ƒä¼˜æ¡ˆä¾‹
5. æŒç»­ç›‘æ§å’Œä¼˜åŒ–
