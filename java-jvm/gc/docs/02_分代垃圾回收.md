# åˆ†ä»£åƒåœ¾å›æ”¶

## ğŸ“š æ¦‚è¿°

åˆ†ä»£åƒåœ¾å›æ”¶æ˜¯åŸºäº"å¤§éƒ¨åˆ†å¯¹è±¡æœç”Ÿå¤•æ­»"çš„å‡è®¾ï¼Œå°†å †å†…å­˜åˆ’åˆ†ä¸ºä¸åŒçš„ä»£ï¼Œé’ˆå¯¹ä¸åŒä»£é‡‡ç”¨ä¸åŒçš„å›æ”¶ç­–ç•¥ï¼Œä»è€Œæé«˜GCæ•ˆç‡ã€‚

## ğŸ¯ æ ¸å¿ƒé—®é¢˜

- â“ ä¸ºä»€ä¹ˆè¦åˆ†ä»£ï¼Ÿ
- â“ å¦‚ä½•åˆ’åˆ†ä»£ï¼Ÿ
- â“ æ–°ç”Ÿä»£GCå¦‚ä½•å·¥ä½œï¼Ÿ
- â“ è€å¹´ä»£GCå¦‚ä½•å·¥ä½œï¼Ÿ
- â“ å¯¹è±¡å¦‚ä½•æ™‹å‡åˆ°è€å¹´ä»£ï¼Ÿ
- â“ ä»€ä¹ˆæ˜¯ç©ºé—´åˆ†é…æ‹…ä¿ï¼Ÿ

---

## ä¸€ã€åˆ†ä»£å‡è¯´

### 1.1 å¼±åˆ†ä»£å‡è¯´

**å¤§éƒ¨åˆ†å¯¹è±¡æœç”Ÿå¤•æ­»**

```java
public void method() {
    // å±€éƒ¨å˜é‡ï¼Œæ–¹æ³•ç»“æŸåç«‹å³æ­»äº¡
    Object temp = new Object();
    String str = "hello";
    int[] arr = new int[10];
}

// ç»Ÿè®¡æ•°æ®ï¼š
// - 98%çš„å¯¹è±¡åœ¨åˆ›å»ºåå¾ˆå¿«æ­»äº¡
// - åªæœ‰2%çš„å¯¹è±¡èƒ½å­˜æ´»è¾ƒé•¿æ—¶é—´
```

### 1.2 å¼ºåˆ†ä»£å‡è¯´

**ç†¬è¿‡å¤šæ¬¡GCçš„å¯¹è±¡éš¾ä»¥æ¶ˆäº¡**

```java
public class Service {
    // é™æ€å˜é‡ï¼Œç”Ÿå‘½å‘¨æœŸå¾ˆé•¿
    private static Cache cache = new Cache();
    
    // å•ä¾‹å¯¹è±¡ï¼Œç”Ÿå‘½å‘¨æœŸå¾ˆé•¿
    private static Service instance = new Service();
}

// ç»Ÿè®¡æ•°æ®ï¼š
// - ç»å†15æ¬¡GCä»å­˜æ´»çš„å¯¹è±¡
// - 99%ä¼šç»§ç»­å­˜æ´»å¾ˆé•¿æ—¶é—´
```

### 1.3 è·¨ä»£å¼•ç”¨å‡è¯´

**è·¨ä»£å¼•ç”¨ç›¸å¯¹äºåŒä»£å¼•ç”¨æ¥è¯´å æå°‘æ•°**

```
è€å¹´ä»£å¯¹è±¡ â†’ æ–°ç”Ÿä»£å¯¹è±¡ï¼ˆå°‘ï¼‰
æ–°ç”Ÿä»£å¯¹è±¡ â†’ æ–°ç”Ÿä»£å¯¹è±¡ï¼ˆå¤šï¼‰
è€å¹´ä»£å¯¹è±¡ â†’ è€å¹´ä»£å¯¹è±¡ï¼ˆå¤šï¼‰

åŸå› ï¼š
- æ–°ç”Ÿä»£å¯¹è±¡å¾ˆå¿«æ­»äº¡
- å¦‚æœè€å¹´ä»£å¯¹è±¡å¼•ç”¨æ–°ç”Ÿä»£å¯¹è±¡
- æ–°ç”Ÿä»£å¯¹è±¡å¾ˆå¿«æ­»äº¡ï¼Œå¼•ç”¨æ–­å¼€
- è€å¹´ä»£å¯¹è±¡å¾ˆå°‘é•¿æœŸæŒæœ‰æ–°ç”Ÿä»£å¯¹è±¡çš„å¼•ç”¨
```

---

## äºŒã€åˆ†ä»£æ¨¡å‹

### 2.1 å †å†…å­˜åˆ’åˆ†

```
Javaå †å†…å­˜ç»“æ„ï¼š

+------------------------------------------+
|                  Java Heap               |
+------------------------------------------+
|  Young Generation  |   Old Generation   |
+--------------------+--------------------+
| Eden | S0  |  S1   |    Old/Tenured    |
+------+-----+-------+--------------------+
  8:1    1:1    1:1          æ›´å¤§
```

### 2.2 å„åŒºåŸŸè¯´æ˜

| åŒºåŸŸ | å¤§å°æ¯”ä¾‹ | ç”¨é€” | GCé¢‘ç‡ |
|------|---------|------|--------|
| **EdenåŒº** | 80% | æ–°å¯¹è±¡åˆ†é… | é«˜ |
| **Survivor0** | 10% | å­˜æ´»å¯¹è±¡ | é«˜ |
| **Survivor1** | 10% | å­˜æ´»å¯¹è±¡ | é«˜ |
| **è€å¹´ä»£** | 2å€æ–°ç”Ÿä»£ | é•¿æœŸå­˜æ´»å¯¹è±¡ | ä½ |

### 2.3 ä¸ºä»€ä¹ˆè¿™æ ·åˆ’åˆ†

```
1. EdenåŒºå¤§ï¼ˆ80%ï¼‰ï¼š
   - å¤§éƒ¨åˆ†å¯¹è±¡åœ¨EdenåŒºåˆ†é…
   - å¤§éƒ¨åˆ†å¯¹è±¡å¾ˆå¿«æ­»äº¡
   - å‡å°‘GCé¢‘ç‡

2. SurvivoråŒºå°ï¼ˆå„10%ï¼‰ï¼š
   - åªæœ‰å°‘é‡å¯¹è±¡å­˜æ´»
   - 10%çš„ç©ºé—´è¶³å¤Ÿ
   - èŠ‚çœå†…å­˜

3. è€å¹´ä»£å¤§ï¼š
   - å­˜æ”¾é•¿æœŸå­˜æ´»å¯¹è±¡
   - GCé¢‘ç‡ä½
   - éœ€è¦æ›´å¤§ç©ºé—´
```

---

## ä¸‰ã€æ–°ç”Ÿä»£GCï¼ˆMinor GCï¼‰

### 3.1 å·¥ä½œæµç¨‹

```
åˆå§‹çŠ¶æ€ï¼š
Eden: [å¯¹è±¡A][å¯¹è±¡B][å¯¹è±¡C][å¯¹è±¡D][å¯¹è±¡E]
S0:   [ç©º]
S1:   [ç©º]

ç¬¬1æ¬¡Minor GCï¼š
1. EdenåŒºæ»¡
2. æ ‡è®°å­˜æ´»å¯¹è±¡ï¼ˆAã€Cã€Eï¼‰
3. å¤åˆ¶åˆ°S0
4. æ¸…ç©ºEden

ç»“æœï¼š
Eden: [ç©º]
S0:   [å¯¹è±¡A(age=1)][å¯¹è±¡C(age=1)][å¯¹è±¡E(age=1)]
S1:   [ç©º]

ç»§ç»­åˆ†é…ï¼š
Eden: [å¯¹è±¡F][å¯¹è±¡G][å¯¹è±¡H]
S0:   [å¯¹è±¡A(age=1)][å¯¹è±¡C(age=1)][å¯¹è±¡E(age=1)]
S1:   [ç©º]

ç¬¬2æ¬¡Minor GCï¼š
1. EdenåŒºæ»¡
2. æ ‡è®°Edenå’ŒS0çš„å­˜æ´»å¯¹è±¡ï¼ˆAã€Cã€Fã€Hï¼‰
3. å¤åˆ¶åˆ°S1ï¼Œage+1
4. æ¸…ç©ºEdenå’ŒS0

ç»“æœï¼š
Eden: [ç©º]
S0:   [ç©º]
S1:   [å¯¹è±¡A(age=2)][å¯¹è±¡C(age=2)][å¯¹è±¡F(age=1)][å¯¹è±¡H(age=1)]
```

### 3.2 è¯¦ç»†æ­¥éª¤

#### æ­¥éª¤1ï¼šå¯¹è±¡åˆ†é…

```java
public class AllocationDemo {
    public static void main(String[] args) {
        // å¯¹è±¡åœ¨EdenåŒºåˆ†é…
        byte[] obj1 = new byte[1024 * 1024];  // 1MB
        byte[] obj2 = new byte[1024 * 1024];  // 1MB
        byte[] obj3 = new byte[1024 * 1024];  // 1MB
        
        // EdenåŒºæ»¡ï¼Œè§¦å‘Minor GC
        byte[] obj4 = new byte[1024 * 1024];  // 1MB
    }
}
```

#### æ­¥éª¤2ï¼šè§¦å‘Minor GC

```
è§¦å‘æ¡ä»¶ï¼š
1. EdenåŒºç©ºé—´ä¸è¶³
2. æ˜¾å¼è°ƒç”¨System.gc()ï¼ˆä¸æ¨èï¼‰

GCè¿‡ç¨‹ï¼š
1. Stop The World
2. æ ‡è®°Edenå’ŒFrom Survivorçš„å­˜æ´»å¯¹è±¡
3. å¤åˆ¶åˆ°To Survivor
4. æ¸…ç©ºEdenå’ŒFrom Survivor
5. äº¤æ¢Fromå’ŒTo
6. æ¢å¤åº”ç”¨çº¿ç¨‹
```

#### æ­¥éª¤3ï¼šå¯¹è±¡å¹´é¾„å¢é•¿

```java
// å¯¹è±¡å¤´ä¸­çš„å¹´é¾„å­—æ®µï¼ˆ4ä½ï¼Œæœ€å¤§15ï¼‰
class ObjectHeader {
    int age : 4;  // å¹´é¾„ï¼Œ0-15
    // ...
}

// æ¯æ¬¡Minor GCï¼Œå­˜æ´»å¯¹è±¡age+1
age = 0  // æ–°åˆ›å»º
age = 1  // ç»å†1æ¬¡Minor GC
age = 2  // ç»å†2æ¬¡Minor GC
...
age = 15 // ç»å†15æ¬¡Minor GCï¼ˆæœ€å¤§å€¼ï¼‰
```

### 3.3 Minor GCç¤ºä¾‹

```java
/**
 * VMå‚æ•°ï¼š
 * -Xms20M -Xmx20M -Xmn10M -XX:+PrintGCDetails -XX:SurvivorRatio=8
 * 
 * å †å¤§å°ï¼š20M
 * æ–°ç”Ÿä»£ï¼š10Mï¼ˆEden=8M, S0=1M, S1=1Mï¼‰
 * è€å¹´ä»£ï¼š10M
 */
public class MinorGCDemo {
    
    private static final int _1MB = 1024 * 1024;
    
    public static void main(String[] args) {
        byte[] allocation1, allocation2, allocation3, allocation4;
        
        // åˆ†é…3ä¸ª1MBå¯¹è±¡ï¼Œåœ¨EdenåŒº
        allocation1 = new byte[_1MB];
        allocation2 = new byte[_1MB];
        allocation3 = new byte[_1MB];
        
        System.out.println("åˆ†é…3ä¸ª1MBå¯¹è±¡å");
        printMemory();
        
        // åˆ†é…4MBå¯¹è±¡ï¼ŒEdenåŒºä¸è¶³ï¼Œè§¦å‘Minor GC
        allocation4 = new byte[4 * _1MB];
        
        System.out.println("åˆ†é…4MBå¯¹è±¡åï¼ˆè§¦å‘Minor GCï¼‰");
        printMemory();
    }
    
    private static void printMemory() {
        Runtime runtime = Runtime.getRuntime();
        long total = runtime.totalMemory() / _1MB;
        long free = runtime.freeMemory() / _1MB;
        long used = total - free;
        
        System.out.println("æ€»å†…å­˜: " + total + "MB");
        System.out.println("ç©ºé—²å†…å­˜: " + free + "MB");
        System.out.println("å·²ç”¨å†…å­˜: " + used + "MB");
        System.out.println("----------------------------");
    }
}

// è¾“å‡ºç¤ºä¾‹ï¼š
// [GC (Allocation Failure) [PSYoungGen: 7291K->1016K(9216K)] 7291K->5128K(19456K), 0.0034567 secs]
// 
// è§£è¯»ï¼š
// PSYoungGen: æ–°ç”Ÿä»£GC
// 7291K->1016K(9216K): æ–°ç”Ÿä»£ä»7291Ké™åˆ°1016Kï¼Œæ€»å®¹é‡9216K
// 7291K->5128K(19456K): æ•´ä¸ªå †ä»7291Ké™åˆ°5128Kï¼Œæ€»å®¹é‡19456K
// 0.0034567 secs: GCè€—æ—¶
```

### 3.4 Minor GCç‰¹ç‚¹

| ç‰¹ç‚¹ | è¯´æ˜ |
|------|------|
| **é¢‘ç‡** | é«˜ï¼ˆEdenåŒºå°ï¼Œå¾ˆå¿«å¡«æ»¡ï¼‰ |
| **é€Ÿåº¦** | å¿«ï¼ˆå­˜æ´»å¯¹è±¡å°‘ï¼Œå¤åˆ¶å¿«ï¼‰ |
| **æš‚åœæ—¶é—´** | çŸ­ï¼ˆå‡ æ¯«ç§’åˆ°å‡ åæ¯«ç§’ï¼‰ |
| **ç®—æ³•** | æ ‡è®°-å¤åˆ¶ |
| **å½±å“** | å°ï¼ˆæš‚åœæ—¶é—´çŸ­ï¼‰ |

---

## å››ã€è€å¹´ä»£GCï¼ˆMajor GC / Full GCï¼‰

### 4.1 è§¦å‘æ¡ä»¶

```
1. è€å¹´ä»£ç©ºé—´ä¸è¶³
   - å¤§å¯¹è±¡ç›´æ¥è¿›å…¥è€å¹´ä»£
   - é•¿æœŸå­˜æ´»å¯¹è±¡æ™‹å‡åˆ°è€å¹´ä»£

2. ç©ºé—´åˆ†é…æ‹…ä¿å¤±è´¥
   - SurvivoråŒºæ”¾ä¸ä¸‹å­˜æ´»å¯¹è±¡
   - éœ€è¦è€å¹´ä»£æ‹…ä¿

3. Metaspaceç©ºé—´ä¸è¶³
   - ç±»å…ƒæ•°æ®è¿‡å¤š

4. æ˜¾å¼è°ƒç”¨System.gc()
   - ä¸æ¨èä½¿ç”¨

5. CMS GCçš„å¹¶å‘å¤±è´¥
   - å¹¶å‘æ¨¡å¼å¤±è´¥
   - æ™‹å‡å¤±è´¥
```

### 4.2 å·¥ä½œæµç¨‹

```
è€å¹´ä»£GCæµç¨‹ï¼š

1. æ ‡è®°é˜¶æ®µï¼ˆSTWï¼‰
   â”œâ”€ ä»GC Rootså¼€å§‹æ ‡è®°
   â”œâ”€ æ ‡è®°æ‰€æœ‰å¯è¾¾å¯¹è±¡
   â””â”€ è€—æ—¶è¾ƒé•¿

2. æ¸…é™¤/æ•´ç†é˜¶æ®µ
   â”œâ”€ æ ‡è®°-æ¸…é™¤ï¼šç›´æ¥æ¸…é™¤æœªæ ‡è®°å¯¹è±¡
   â””â”€ æ ‡è®°-æ•´ç†ï¼šç§»åŠ¨å­˜æ´»å¯¹è±¡ï¼Œæ•´ç†å†…å­˜

3. æ¢å¤åº”ç”¨
```

### 4.3 Full GCç¤ºä¾‹

```java
/**
 * VMå‚æ•°ï¼š
 * -Xms20M -Xmx20M -Xmn10M -XX:+PrintGCDetails
 */
public class FullGCDemo {
    
    private static final int _1MB = 1024 * 1024;
    
    public static void main(String[] args) {
        byte[] allocation1, allocation2, allocation3, allocation4;
        
        // åˆ†é…å¯¹è±¡ï¼Œè§¦å‘Minor GC
        allocation1 = new byte[2 * _1MB];
        allocation2 = new byte[2 * _1MB];
        allocation3 = new byte[2 * _1MB];
        
        // åˆ›å»ºå¤§å¯¹è±¡ï¼Œç›´æ¥è¿›å…¥è€å¹´ä»£
        allocation4 = new byte[8 * _1MB];
        
        System.out.println("åˆ›å»ºå¤§å¯¹è±¡å");
        printGCInfo();
        
        // è€å¹´ä»£ç©ºé—´ä¸è¶³ï¼Œè§¦å‘Full GC
        byte[] allocation5 = new byte[8 * _1MB];
        
        System.out.println("å†æ¬¡åˆ›å»ºå¤§å¯¹è±¡åï¼ˆè§¦å‘Full GCï¼‰");
        printGCInfo();
    }
    
    private static void printGCInfo() {
        System.out.println("GCä¿¡æ¯å·²æ‰“å°");
        System.out.println("----------------------------");
    }
}

// è¾“å‡ºç¤ºä¾‹ï¼š
// [Full GC (Ergonomics) [PSYoungGen: 2048K->0K(9216K)] [ParOldGen: 8192K->10240K(10240K)] 10240K->10240K(19456K), 0.0123456 secs]
//
// è§£è¯»ï¼š
// Full GC: å…¨å †GC
// PSYoungGen: æ–°ç”Ÿä»£ä»2048Ké™åˆ°0K
// ParOldGen: è€å¹´ä»£ä»8192Kå‡åˆ°10240Kï¼ˆå¯¹è±¡æ™‹å‡ï¼‰
// æ•´ä¸ªå †ä»10240Kåˆ°10240K
```

### 4.4 Full GCç‰¹ç‚¹

| ç‰¹ç‚¹ | è¯´æ˜ |
|------|------|
| **é¢‘ç‡** | ä½ï¼ˆè€å¹´ä»£å¤§ï¼Œä¸å®¹æ˜“å¡«æ»¡ï¼‰ |
| **é€Ÿåº¦** | æ…¢ï¼ˆå¯¹è±¡å¤šï¼Œæ‰«ææ…¢ï¼‰ |
| **æš‚åœæ—¶é—´** | é•¿ï¼ˆå‡ ç™¾æ¯«ç§’åˆ°å‡ ç§’ï¼‰ |
| **ç®—æ³•** | æ ‡è®°-æ¸…é™¤æˆ–æ ‡è®°-æ•´ç† |
| **å½±å“** | å¤§ï¼ˆæš‚åœæ—¶é—´é•¿ï¼Œå½±å“ç”¨æˆ·ä½“éªŒï¼‰ |

---

## äº”ã€å¯¹è±¡æ™‹å‡

### 5.1 æ™‹å‡æ¡ä»¶

```
å¯¹è±¡æ™‹å‡åˆ°è€å¹´ä»£çš„æ¡ä»¶ï¼š

1. å¹´é¾„è¾¾åˆ°é˜ˆå€¼ï¼ˆé»˜è®¤15ï¼‰
   - ç»å†15æ¬¡Minor GCä»å­˜æ´»
   - å¯é€šè¿‡-XX:MaxTenuringThresholdè®¾ç½®

2. å¤§å¯¹è±¡ç›´æ¥æ™‹å‡
   - å¤§å°è¶…è¿‡-XX:PretenureSizeThreshold
   - ç›´æ¥åœ¨è€å¹´ä»£åˆ†é…

3. SurvivoråŒºç©ºé—´ä¸è¶³
   - å­˜æ´»å¯¹è±¡è¶…è¿‡Survivorå®¹é‡
   - æå‰æ™‹å‡åˆ°è€å¹´ä»£

4. åŠ¨æ€å¹´é¾„åˆ¤å®š
   - SurvivoråŒºä¸­ç›¸åŒå¹´é¾„å¯¹è±¡å¤§å°æ€»å’Œ > Survivorç©ºé—´ä¸€åŠ
   - å¹´é¾„ >= è¯¥å¹´é¾„çš„å¯¹è±¡ç›´æ¥æ™‹å‡
```

### 5.2 å¹´é¾„é˜ˆå€¼æ™‹å‡

```java
/**
 * VMå‚æ•°ï¼š
 * -XX:MaxTenuringThreshold=15  // è®¾ç½®æœ€å¤§å¹´é¾„
 * -XX:+PrintTenuringDistribution  // æ‰“å°å¹´é¾„åˆ†å¸ƒ
 */
public class AgeTenuringDemo {
    
    private static final int _1MB = 1024 * 1024;
    
    public static void main(String[] args) {
        // åˆ›å»ºå¯¹è±¡
        byte[] allocation1 = new byte[_1MB / 4];
        
        // è§¦å‘å¤šæ¬¡Minor GC
        for (int i = 0; i < 20; i++) {
            byte[] temp = new byte[4 * _1MB];
            temp = null;
            System.gc();
        }
        
        // allocation1ç»å†å¤šæ¬¡GCåæ™‹å‡åˆ°è€å¹´ä»£
    }
}

// è¾“å‡ºç¤ºä¾‹ï¼š
// Desired survivor size 524288 bytes, new threshold 15 (max 15)
// - age   1:     262144 bytes,     262144 total
// - age   2:     262144 bytes,     524288 total
// ...
// - age  15:     262144 bytes,    3932160 total
```

### 5.3 å¤§å¯¹è±¡ç›´æ¥æ™‹å‡

```java
/**
 * VMå‚æ•°ï¼š
 * -XX:PretenureSizeThreshold=3145728  // 3MB
 * -XX:+UseSerialGC  // åªæœ‰Serialå’ŒParNewæ”¯æŒæ­¤å‚æ•°
 */
public class PretenureSizeDemo {
    
    private static final int _1MB = 1024 * 1024;
    
    public static void main(String[] args) {
        // å°å¯¹è±¡ï¼Œåœ¨EdenåŒºåˆ†é…
        byte[] allocation1 = new byte[2 * _1MB];
        
        // å¤§å¯¹è±¡ï¼ˆ>3MBï¼‰ï¼Œç›´æ¥åœ¨è€å¹´ä»£åˆ†é…
        byte[] allocation2 = new byte[4 * _1MB];
        
        System.out.println("å¤§å¯¹è±¡ç›´æ¥è¿›å…¥è€å¹´ä»£");
    }
}

// ä¸ºä»€ä¹ˆå¤§å¯¹è±¡ç›´æ¥è¿›å…¥è€å¹´ä»£ï¼Ÿ
// 1. é¿å…åœ¨Edenå’ŒSurvivorä¹‹é—´å¤åˆ¶
// 2. å‡å°‘Minor GCçš„å¼€é”€
// 3. å¤§å¯¹è±¡é€šå¸¸ç”Ÿå‘½å‘¨æœŸè¾ƒé•¿
```

### 5.4 åŠ¨æ€å¹´é¾„åˆ¤å®š

```java
/**
 * åŠ¨æ€å¹´é¾„åˆ¤å®šè§„åˆ™ï¼š
 * å¦‚æœSurvivoråŒºä¸­ç›¸åŒå¹´é¾„æ‰€æœ‰å¯¹è±¡å¤§å°çš„æ€»å’Œ > Survivorç©ºé—´çš„ä¸€åŠ
 * å¹´é¾„ >= è¯¥å¹´é¾„çš„å¯¹è±¡å¯ä»¥ç›´æ¥è¿›å…¥è€å¹´ä»£
 */
public class DynamicAgeTenuringDemo {
    
    private static final int _1MB = 1024 * 1024;
    
    public static void main(String[] args) {
        // SurvivoråŒºå¤§å°ï¼š1MB
        
        // åˆ›å»ºå¤šä¸ªç›¸åŒå¹´é¾„çš„å¯¹è±¡
        byte[] obj1 = new byte[_1MB / 4];  // age=1
        byte[] obj2 = new byte[_1MB / 4];  // age=1
        byte[] obj3 = new byte[_1MB / 4];  // age=1
        
        // æ€»å¤§å° = 3/4 MB > 1/2 MB
        // è§¦å‘Minor GCåï¼Œè¿™äº›å¯¹è±¡ä¼šç›´æ¥æ™‹å‡åˆ°è€å¹´ä»£
        // å³ä½¿age < MaxTenuringThreshold
        
        System.gc();
    }
}
```

### 5.5 æ™‹å‡æµç¨‹å›¾

```
å¯¹è±¡åˆ›å»º
   â†“
EdenåŒºåˆ†é…
   â†“
EdenåŒºæ»¡ï¼Ÿ â”€Noâ†’ ç»§ç»­åˆ†é…
   â†“Yes
Minor GC
   â†“
å¯¹è±¡å­˜æ´»ï¼Ÿ â”€Noâ†’ å›æ”¶
   â†“Yes
   â”œâ”€ å¤§å¯¹è±¡ï¼Ÿ â”€Yesâ†’ è€å¹´ä»£
   â”œâ”€ age >= é˜ˆå€¼ï¼Ÿ â”€Yesâ†’ è€å¹´ä»£
   â”œâ”€ Survivoræ»¡ï¼Ÿ â”€Yesâ†’ è€å¹´ä»£
   â”œâ”€ åŠ¨æ€åˆ¤å®šï¼Ÿ â”€Yesâ†’ è€å¹´ä»£
   â””â”€ No â†’ SurvivoråŒºï¼ˆage+1ï¼‰
```

---

## å…­ã€ç©ºé—´åˆ†é…æ‹…ä¿

### 6.1 ä»€ä¹ˆæ˜¯ç©ºé—´åˆ†é…æ‹…ä¿

åœ¨Minor GCå‰ï¼ŒJVMä¼šæ£€æŸ¥è€å¹´ä»£æœ€å¤§å¯ç”¨è¿ç»­ç©ºé—´æ˜¯å¦å¤§äºæ–°ç”Ÿä»£æ‰€æœ‰å¯¹è±¡æ€»ç©ºé—´ã€‚

```
Minor GCå‰çš„æ£€æŸ¥ï¼š

è€å¹´ä»£æœ€å¤§è¿ç»­ç©ºé—´ >= æ–°ç”Ÿä»£æ‰€æœ‰å¯¹è±¡ï¼Ÿ
   â†“Yes
å®‰å…¨ï¼Œæ‰§è¡ŒMinor GC
   â†“No
æ£€æŸ¥HandlePromotionFailureè®¾ç½®
   â†“
è€å¹´ä»£æœ€å¤§è¿ç»­ç©ºé—´ >= å†æ¬¡æ™‹å‡å¹³å‡å¤§å°ï¼Ÿ
   â†“Yes
å†’é™©æ‰§è¡ŒMinor GC
   â†“No
æ‰§è¡ŒFull GC
```

### 6.2 ä¸ºä»€ä¹ˆéœ€è¦æ‹…ä¿

```
é—®é¢˜åœºæ™¯ï¼š
1. Minor GCæ—¶ï¼ŒEdenå’ŒSurvivorçš„å­˜æ´»å¯¹è±¡éœ€è¦å¤åˆ¶åˆ°å¦ä¸€ä¸ªSurvivor
2. å¦‚æœå­˜æ´»å¯¹è±¡å¤ªå¤šï¼ŒSurvivoræ”¾ä¸ä¸‹
3. éœ€è¦è€å¹´ä»£æä¾›æ‹…ä¿ï¼Œå°†å¯¹è±¡ç›´æ¥æ™‹å‡åˆ°è€å¹´ä»£

æ‹…ä¿æœºåˆ¶ï¼š
- ç¡®ä¿Minor GCä¸ä¼šå¤±è´¥
- é¿å…é¢‘ç¹Full GC
```

### 6.3 æ‹…ä¿å¤±è´¥

```java
/**
 * ç©ºé—´åˆ†é…æ‹…ä¿å¤±è´¥ç¤ºä¾‹
 */
public class HandlePromotionFailureDemo {
    
    private static final int _1MB = 1024 * 1024;
    
    public static void main(String[] args) {
        // è€å¹´ä»£å‰©ä½™ç©ºé—´ï¼š5MB
        
        // åˆ›å»ºå¤§é‡å¯¹è±¡
        List<byte[]> list = new ArrayList<>();
        for (int i = 0; i < 10; i++) {
            list.add(new byte[_1MB]);
        }
        
        // Minor GCæ—¶ï¼Œå­˜æ´»å¯¹è±¡éœ€è¦æ™‹å‡
        // ä½†è€å¹´ä»£ç©ºé—´ä¸è¶³
        // è§¦å‘Full GC
        
        System.gc();
    }
}

// è¾“å‡ºç¤ºä¾‹ï¼š
// [GC (Allocation Failure) [PSYoungGen: 8192K->1024K(9216K)] 8192K->5120K(19456K), 0.0012345 secs]
// [Full GC (Ergonomics) [PSYoungGen: 1024K->0K(9216K)] [ParOldGen: 4096K->5120K(10240K)] 5120K->5120K(19456K), 0.0123456 secs]
```

### 6.4 JDKç‰ˆæœ¬å·®å¼‚

```
JDK 6 Update 24ä¹‹å‰ï¼š
- éœ€è¦è®¾ç½®-XX:+HandlePromotionFailure
- æ§åˆ¶æ˜¯å¦å…è®¸æ‹…ä¿å¤±è´¥

JDK 6 Update 24ä¹‹åï¼š
- ä¸å†éœ€è¦æ­¤å‚æ•°
- åªè¦è€å¹´ä»£è¿ç»­ç©ºé—´ > æ–°ç”Ÿä»£å¯¹è±¡æ€»å¤§å° æˆ– å†æ¬¡æ™‹å‡å¹³å‡å¤§å°
- å°±ä¼šè¿›è¡ŒMinor GC
- å¦åˆ™è¿›è¡ŒFull GC
```

---

## ä¸ƒã€åˆ†ä»£GCçš„ä¼˜åŒ–

### 7.1 å¯¹è±¡åˆ†é…ä¼˜åŒ–

#### 1. æ ˆä¸Šåˆ†é…

```java
// é€ƒé€¸åˆ†æï¼šå¯¹è±¡ä¸ä¼šé€ƒé€¸å‡ºæ–¹æ³•
public void method() {
    Point p = new Point(1, 2);
    int x = p.getX();
    int y = p.getY();
    // pä¸ä¼šé€ƒé€¸å‡ºæ–¹æ³•
}

// JVMä¼˜åŒ–ï¼šåœ¨æ ˆä¸Šåˆ†é…å¯¹è±¡
// å¥½å¤„ï¼š
// - æ–¹æ³•ç»“æŸï¼Œæ ˆå¸§é”€æ¯ï¼Œå¯¹è±¡è‡ªåŠ¨å›æ”¶
// - ä¸éœ€è¦GC
// - æ€§èƒ½æ›´å¥½
```

#### 2. æ ‡é‡æ›¿æ¢

```java
// åŸå§‹ä»£ç 
public void method() {
    Point p = new Point(1, 2);
    int sum = p.getX() + p.getY();
}

// æ ‡é‡æ›¿æ¢å
public void method() {
    int x = 1;
    int y = 2;
    int sum = x + y;
    // ä¸åˆ›å»ºPointå¯¹è±¡
}
```

#### 3. TLABï¼ˆThread Local Allocation Bufferï¼‰

```
é—®é¢˜ï¼š
- å¤šçº¿ç¨‹å¹¶å‘åˆ†é…å¯¹è±¡
- éœ€è¦åŒæ­¥ï¼Œæ€§èƒ½å·®

è§£å†³ï¼š
- æ¯ä¸ªçº¿ç¨‹åœ¨EdenåŒºé¢„åˆ†é…ä¸€å—ç¼“å†²åŒºï¼ˆTLABï¼‰
- çº¿ç¨‹åœ¨è‡ªå·±çš„TLABä¸­åˆ†é…å¯¹è±¡
- æ— éœ€åŒæ­¥ï¼Œæ€§èƒ½å¥½

TLABç»“æ„ï¼š
EdenåŒºï¼š
[Thread1 TLAB][Thread2 TLAB][Thread3 TLAB][å…±äº«åŒºåŸŸ]
```

```java
/**
 * TLABå‚æ•°ï¼š
 * -XX:+UseTLAB  // å¯ç”¨TLABï¼ˆé»˜è®¤å¯ç”¨ï¼‰
 * -XX:TLABSize  // TLABå¤§å°
 * -XX:+PrintTLAB  // æ‰“å°TLABä¿¡æ¯
 */
public class TLABDemo {
    public static void main(String[] args) {
        // å¯¹è±¡åœ¨çº¿ç¨‹çš„TLABä¸­åˆ†é…
        for (int i = 0; i < 1000; i++) {
            Object obj = new Object();
        }
    }
}
```

### 7.2 GCé¢‘ç‡ä¼˜åŒ–

```
å‡å°‘Minor GCé¢‘ç‡ï¼š
1. å¢å¤§EdenåŒº
   -XX:NewRatio=2  // æ–°ç”Ÿä»£:è€å¹´ä»£ = 1:2
   -XX:SurvivorRatio=8  // Eden:Survivor = 8:1

2. å‡å°‘å¯¹è±¡åˆ›å»º
   - å¯¹è±¡å¤ç”¨
   - ä½¿ç”¨å¯¹è±¡æ± 

3. ä½¿ç”¨æ ˆä¸Šåˆ†é…
   -XX:+DoEscapeAnalysis  // å¯ç”¨é€ƒé€¸åˆ†æ

å‡å°‘Full GCé¢‘ç‡ï¼š
1. å¢å¤§è€å¹´ä»£
   -Xmx4g  // å¢å¤§å †å¤§å°

2. é¿å…å¤§å¯¹è±¡
   - æ‹†åˆ†å¤§å¯¹è±¡
   - ä½¿ç”¨æµå¼å¤„ç†

3. åŠæ—¶é‡Šæ”¾å¼•ç”¨
   - ä¸å†ä½¿ç”¨çš„å¯¹è±¡ç½®ä¸ºnull
```

### 7.3 æ™‹å‡ä¼˜åŒ–

```
å»¶è¿Ÿå¯¹è±¡æ™‹å‡ï¼š
1. å¢å¤§SurvivoråŒº
   -XX:SurvivorRatio=6  // Eden:Survivor = 6:1

2. æé«˜æ™‹å‡å¹´é¾„é˜ˆå€¼
   -XX:MaxTenuringThreshold=15

3. é¿å…å¤§å¯¹è±¡ç›´æ¥æ™‹å‡
   -XX:PretenureSizeThreshold=10485760  // 10MB

åŠ é€Ÿå¯¹è±¡æ™‹å‡ï¼š
1. é™ä½æ™‹å‡å¹´é¾„é˜ˆå€¼
   -XX:MaxTenuringThreshold=3

2. å‡å°SurvivoråŒº
   -XX:SurvivorRatio=10
```

---

## å…«ã€åˆ†ä»£GCçš„é—®é¢˜

### 8.1 è·¨ä»£å¼•ç”¨

```
é—®é¢˜ï¼š
è€å¹´ä»£å¯¹è±¡ â†’ æ–°ç”Ÿä»£å¯¹è±¡

Minor GCæ—¶ï¼š
- éœ€è¦æ‰«æè€å¹´ä»£æ‰¾åˆ°å¼•ç”¨
- è€å¹´ä»£å¾ˆå¤§ï¼Œæ‰«ææ…¢

è§£å†³ï¼š
- ä½¿ç”¨è®°å¿†é›†ï¼ˆRemembered Setï¼‰
- è®°å½•è€å¹´ä»£â†’æ–°ç”Ÿä»£çš„å¼•ç”¨
- Minor GCæ—¶åªæ‰«æè®°å¿†é›†
```

### 8.2 å¡è¡¨å®ç°

```
å¡è¡¨ï¼ˆCard Tableï¼‰ï¼š
- å°†å †åˆ’åˆ†ä¸º512å­—èŠ‚çš„å¡ç‰‡
- ç”¨å­—èŠ‚æ•°ç»„è®°å½•æ¯ä¸ªå¡ç‰‡çš„çŠ¶æ€

å¡è¡¨æ•°ç»„ï¼š
[0][1][0][0][1][0]...
 â†‘  â†‘        â†‘
 |  |        â””â”€ å¡ç‰‡4æœ‰è·¨ä»£å¼•ç”¨
 |  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ å¡ç‰‡1æœ‰è·¨ä»£å¼•ç”¨
 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ å¡ç‰‡0æ— è·¨ä»£å¼•ç”¨

å†™å±éšœï¼ˆWrite Barrierï¼‰ï¼š
- å¯¹è±¡å¼•ç”¨æ›´æ–°æ—¶
- æ£€æŸ¥æ˜¯å¦è·¨ä»£å¼•ç”¨
- æ›´æ–°å¡è¡¨
```

```java
// å†™å±éšœä¼ªä»£ç 
void oop_store(oop* addr, oop value) {
    *addr = value;  // æ›´æ–°å¼•ç”¨
    
    // æ£€æŸ¥æ˜¯å¦è·¨ä»£å¼•ç”¨
    if (is_in_young(value) && is_in_old(addr)) {
        // æ ‡è®°å¡è¡¨
        mark_card_dirty(addr);
    }
}
```

### 8.3 å¹¶å‘é—®é¢˜

```
é—®é¢˜ï¼š
- Minor GCæ—¶éœ€è¦STW
- å½±å“åº”ç”¨æ€§èƒ½

è§£å†³ï¼š
- ä½¿ç”¨å¹¶å‘GCï¼ˆå¦‚G1ã€ZGCï¼‰
- å‡å°‘STWæ—¶é—´
```

---

## ä¹ã€æ€»ç»“

### 9.1 åˆ†ä»£GCæ ¸å¿ƒæ€æƒ³

```
1. æ ¹æ®å¯¹è±¡ç”Ÿå‘½å‘¨æœŸåˆ’åˆ†ä»£
2. ä¸åŒä»£ä½¿ç”¨ä¸åŒGCç­–ç•¥
3. å¤§éƒ¨åˆ†GCåªå›æ”¶æ–°ç”Ÿä»£
4. å‡å°‘Full GCé¢‘ç‡
```

### 9.2 å…³é”®å‚æ•°

| å‚æ•° | è¯´æ˜ | é»˜è®¤å€¼ |
|------|------|--------|
| `-Xmn` | æ–°ç”Ÿä»£å¤§å° | å †çš„1/3 |
| `-XX:NewRatio` | è€å¹´ä»£/æ–°ç”Ÿä»£æ¯”ä¾‹ | 2 |
| `-XX:SurvivorRatio` | Eden/Survivoræ¯”ä¾‹ | 8 |
| `-XX:MaxTenuringThreshold` | æ™‹å‡å¹´é¾„é˜ˆå€¼ | 15 |
| `-XX:PretenureSizeThreshold` | å¤§å¯¹è±¡é˜ˆå€¼ | 0ï¼ˆä¸å¯ç”¨ï¼‰ |

### 9.3 æœ€ä½³å®è·µ

1. âœ… åˆç†è®¾ç½®å †å¤§å°å’Œä»£æ¯”ä¾‹
2. âœ… é¿å…åˆ›å»ºå¤§å¯¹è±¡
3. âœ… åŠæ—¶é‡Šæ”¾ä¸å†ä½¿ç”¨çš„å¼•ç”¨
4. âœ… ä½¿ç”¨å¯¹è±¡æ± å‡å°‘å¯¹è±¡åˆ›å»º
5. âœ… ç›‘æ§GCæ—¥å¿—ï¼ŒåŠæ—¶è°ƒä¼˜

---

## ğŸ“š å‚è€ƒèµ„æ–™

1. **ã€Šæ·±å…¥ç†è§£Javaè™šæ‹Ÿæœºï¼ˆç¬¬3ç‰ˆï¼‰ã€‹** - å‘¨å¿—æ˜
2. **ã€ŠJavaæ€§èƒ½æƒå¨æŒ‡å—ã€‹** - Scott Oaks
3. **Oracleå®˜æ–¹æ–‡æ¡£** - https://docs.oracle.com/javase/8/docs/technotes/guides/vm/gctuning/

---

**ä¸‹ä¸€ç¯‡**ï¼š[åƒåœ¾æ”¶é›†å™¨è¯¦è§£](./03_åƒåœ¾æ”¶é›†å™¨è¯¦è§£.md)
