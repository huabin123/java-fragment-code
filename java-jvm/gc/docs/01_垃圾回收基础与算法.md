# åƒåœ¾å›æ”¶åŸºç¡€ä¸ç®—æ³•

## ğŸ“š æ¦‚è¿°

åƒåœ¾å›æ”¶ï¼ˆGarbage Collectionï¼ŒGCï¼‰æ˜¯Javaè™šæ‹Ÿæœºè‡ªåŠ¨ç®¡ç†å†…å­˜çš„æ ¸å¿ƒæœºåˆ¶ã€‚ç†è§£GCçš„å·¥ä½œåŸç†å¯¹äºç¼–å†™é«˜æ€§èƒ½Javaåº”ç”¨è‡³å…³é‡è¦ã€‚

## ğŸ¯ æ ¸å¿ƒé—®é¢˜

- â“ ä»€ä¹ˆæ˜¯åƒåœ¾å›æ”¶ï¼Ÿä¸ºä»€ä¹ˆéœ€è¦GCï¼Ÿ
- â“ å¦‚ä½•åˆ¤æ–­å¯¹è±¡æ˜¯å¦å¯ä»¥å›æ”¶ï¼Ÿ
- â“ æœ‰å“ªäº›åƒåœ¾å›æ”¶ç®—æ³•ï¼Ÿ
- â“ å„ç§ç®—æ³•çš„ä¼˜ç¼ºç‚¹æ˜¯ä»€ä¹ˆï¼Ÿ
- â“ ä»€ä¹ˆæ˜¯GC Rootsï¼Ÿ
- â“ å¼•ç”¨ç±»å‹æœ‰å“ªäº›ï¼Ÿ

---

## ä¸€ã€åƒåœ¾å›æ”¶æ¦‚è¿°

### 1.1 ä»€ä¹ˆæ˜¯åƒåœ¾å›æ”¶

åƒåœ¾å›æ”¶æ˜¯è‡ªåŠ¨å†…å­˜ç®¡ç†æœºåˆ¶ï¼Œè´Ÿè´£ï¼š
1. **è¯†åˆ«**ä¸å†ä½¿ç”¨çš„å¯¹è±¡
2. **å›æ”¶**è¿™äº›å¯¹è±¡å ç”¨çš„å†…å­˜
3. **æ•´ç†**å†…å­˜ç¢ç‰‡

```
æ‰‹åŠ¨å†…å­˜ç®¡ç†ï¼ˆC/C++ï¼‰ï¼š
ç¨‹åºå‘˜è´Ÿè´£ malloc/freeã€new/delete

è‡ªåŠ¨å†…å­˜ç®¡ç†ï¼ˆJavaï¼‰ï¼š
JVMè´Ÿè´£è‡ªåŠ¨å›æ”¶ä¸å†ä½¿ç”¨çš„å¯¹è±¡
```

### 1.2 ä¸ºä»€ä¹ˆéœ€è¦åƒåœ¾å›æ”¶

#### æ²¡æœ‰GCçš„é—®é¢˜

```c
// Cè¯­è¨€ç¤ºä¾‹
void createObjects() {
    Object* obj = malloc(sizeof(Object));
    // ä½¿ç”¨obj
    // å¿˜è®°è°ƒç”¨free(obj) -> å†…å­˜æ³„æ¼
}

// å¤šæ¬¡è°ƒç”¨åï¼Œå†…å­˜è€—å°½
for (int i = 0; i < 1000000; i++) {
    createObjects();
}
```

#### æœ‰GCçš„å¥½å¤„

```java
// Javaç¤ºä¾‹
void createObjects() {
    Object obj = new Object();
    // ä½¿ç”¨obj
    // æ–¹æ³•ç»“æŸåï¼Œobjè‡ªåŠ¨è¢«GCå›æ”¶
}

// ä¸ä¼šå†…å­˜æ³„æ¼
for (int i = 0; i < 1000000; i++) {
    createObjects();
}
```

### 1.3 GCçš„ä¼˜åŠ¿ä¸ä»£ä»·

| æ–¹é¢ | ä¼˜åŠ¿ | ä»£ä»· |
|------|------|------|
| **å¼€å‘æ•ˆç‡** | æ— éœ€æ‰‹åŠ¨ç®¡ç†å†…å­˜ | - |
| **å®‰å…¨æ€§** | é¿å…å†…å­˜æ³„æ¼ã€æ‚¬ç©ºæŒ‡é’ˆ | - |
| **æ€§èƒ½** | - | GCæš‚åœï¼ˆStop The Worldï¼‰ |
| **å¯æ§æ€§** | - | å›æ”¶æ—¶æœºä¸å¯æ§ |

---

## äºŒã€å¯¹è±¡å­˜æ´»åˆ¤å®šç®—æ³•

### 2.1 å¼•ç”¨è®¡æ•°æ³•

#### åŸç†

ä¸ºæ¯ä¸ªå¯¹è±¡ç»´æŠ¤ä¸€ä¸ªå¼•ç”¨è®¡æ•°å™¨ï¼Œå½“å¼•ç”¨æ•°ä¸º0æ—¶å›æ”¶ã€‚

```
å¯¹è±¡Aï¼šå¼•ç”¨è®¡æ•° = 2
  â†‘       â†‘
  |       |
å¼•ç”¨1   å¼•ç”¨2

å¼•ç”¨1æ–­å¼€ -> å¼•ç”¨è®¡æ•° = 1
å¼•ç”¨2æ–­å¼€ -> å¼•ç”¨è®¡æ•° = 0 -> å¯å›æ”¶
```

#### å®ç°ç¤ºä¾‹

```java
class RefCountObject {
    private int refCount = 0;  // å¼•ç”¨è®¡æ•°
    
    public void addRef() {
        refCount++;
    }
    
    public void release() {
        refCount--;
        if (refCount == 0) {
            // å›æ”¶å¯¹è±¡
            System.out.println("å¯¹è±¡è¢«å›æ”¶");
        }
    }
}

// ä½¿ç”¨
RefCountObject obj = new RefCountObject();
obj.addRef();  // refCount = 1

RefCountObject obj2 = obj;
obj.addRef();  // refCount = 2

obj2 = null;
obj.release();  // refCount = 1

obj = null;
obj.release();  // refCount = 0ï¼Œå¯¹è±¡è¢«å›æ”¶
```

#### ä¼˜ç‚¹

- âœ… å®ç°ç®€å•
- âœ… å›æ”¶åŠæ—¶ï¼ˆå¼•ç”¨æ•°ä¸º0ç«‹å³å›æ”¶ï¼‰
- âœ… ä¸éœ€è¦æš‚åœç¨‹åº

#### ç¼ºç‚¹

- âŒ **æ— æ³•è§£å†³å¾ªç¯å¼•ç”¨é—®é¢˜**
- âŒ æ¯æ¬¡å¼•ç”¨å˜åŒ–éƒ½è¦æ›´æ–°è®¡æ•°å™¨ï¼Œå¼€é”€å¤§
- âŒ éœ€è¦é¢å¤–çš„å†…å­˜å­˜å‚¨è®¡æ•°å™¨

#### å¾ªç¯å¼•ç”¨é—®é¢˜

```java
class Node {
    Node next;
}

// åˆ›å»ºå¾ªç¯å¼•ç”¨
Node a = new Node();
Node b = new Node();
a.next = b;  // aå¼•ç”¨b
b.next = a;  // bå¼•ç”¨a

// æ–­å¼€å¤–éƒ¨å¼•ç”¨
a = null;
b = null;

// é—®é¢˜ï¼šaå’Œbäº’ç›¸å¼•ç”¨ï¼Œå¼•ç”¨è®¡æ•°éƒ½ä¸ä¸º0
// ä½†å®é™…ä¸Šå·²ç»æ— æ³•è®¿é—®ï¼Œåº”è¯¥è¢«å›æ”¶
```

```
å¾ªç¯å¼•ç”¨ç¤ºæ„å›¾ï¼š

å¤–éƒ¨å¼•ç”¨æ–­å¼€å‰ï¼š
main -> a <-> b
       (1)   (1)

å¤–éƒ¨å¼•ç”¨æ–­å¼€åï¼š
main   a <-> b
      (1)   (1)

å¼•ç”¨è®¡æ•°éƒ½æ˜¯1ï¼Œä½†éƒ½æ— æ³•è®¿é—®
```

### 2.2 å¯è¾¾æ€§åˆ†æç®—æ³•

#### åŸç†

ä»**GC Roots**å‡ºå‘ï¼Œé€šè¿‡å¼•ç”¨é“¾æœç´¢ï¼Œèƒ½å¤Ÿåˆ°è¾¾çš„å¯¹è±¡æ˜¯å­˜æ´»çš„ï¼Œä¸èƒ½åˆ°è¾¾çš„å¯¹è±¡æ˜¯å¯å›æ”¶çš„ã€‚

```
GC Roots
   â†“
  å¯¹è±¡A â†’ å¯¹è±¡B â†’ å¯¹è±¡C
   â†“
  å¯¹è±¡D

å¯¹è±¡Eï¼ˆæ— å¼•ç”¨é“¾ï¼‰

ç»“æœï¼š
- Aã€Bã€Cã€D å­˜æ´»
- E å¯å›æ”¶
```

#### GC RootsåŒ…æ‹¬

| GC Rootç±»å‹ | è¯´æ˜ | ç¤ºä¾‹ |
|------------|------|------|
| **è™šæ‹Ÿæœºæ ˆä¸­çš„å¼•ç”¨** | æ–¹æ³•çš„å±€éƒ¨å˜é‡ | `Object obj = new Object();` |
| **æ–¹æ³•åŒºä¸­çš„é™æ€å˜é‡** | ç±»çš„é™æ€å­—æ®µ | `static Object obj;` |
| **æ–¹æ³•åŒºä¸­çš„å¸¸é‡** | finalå¸¸é‡ | `static final Object obj;` |
| **æœ¬åœ°æ–¹æ³•æ ˆä¸­çš„å¼•ç”¨** | JNIå¼•ç”¨ | Nativeæ–¹æ³•ä¸­çš„å¯¹è±¡ |
| **æ´»è·ƒçº¿ç¨‹** | æ­£åœ¨è¿è¡Œçš„çº¿ç¨‹ | `Thread.currentThread()` |

#### ç¤ºä¾‹

```java
public class GCRootsDemo {
    
    // GC Root 1: æ–¹æ³•åŒºä¸­çš„é™æ€å˜é‡
    private static Object staticObj = new Object();
    
    // GC Root 2: æ–¹æ³•åŒºä¸­çš„å¸¸é‡
    private static final Object CONSTANT_OBJ = new Object();
    
    public void method() {
        // GC Root 3: è™šæ‹Ÿæœºæ ˆä¸­çš„å¼•ç”¨
        Object localObj = new Object();
        
        // è¿™ä¸ªå¯¹è±¡å¯ä»¥é€šè¿‡localObjåˆ°è¾¾ï¼Œæ‰€ä»¥å­˜æ´»
        Object reachableObj = new Object();
        localObj = reachableObj;
        
        // è¿™ä¸ªå¯¹è±¡æ— æ³•ä»GC Rootsåˆ°è¾¾ï¼Œå¯å›æ”¶
        Object unreachableObj = new Object();
        unreachableObj = null;
    }
}
```

#### å¯è¾¾æ€§åˆ†ææµç¨‹

```
1. æ ‡è®°é˜¶æ®µ
   â”œâ”€ ä»GC Rootså¼€å§‹éå†
   â”œâ”€ æ ‡è®°æ‰€æœ‰å¯è¾¾å¯¹è±¡
   â””â”€ æœªæ ‡è®°çš„å¯¹è±¡å³ä¸ºåƒåœ¾

2. æ¸…é™¤é˜¶æ®µ
   â””â”€ å›æ”¶æœªæ ‡è®°çš„å¯¹è±¡
```

#### ä¼˜ç‚¹

- âœ… è§£å†³äº†å¾ªç¯å¼•ç”¨é—®é¢˜
- âœ… å‡†ç¡®åˆ¤æ–­å¯¹è±¡æ˜¯å¦å­˜æ´»
- âœ… Javaã€C#ç­‰ä¸»æµè¯­è¨€éƒ½é‡‡ç”¨

#### ç¼ºç‚¹

- âŒ éœ€è¦æš‚åœç¨‹åºï¼ˆStop The Worldï¼‰
- âŒ éå†å¯¹è±¡å›¾æœ‰æ€§èƒ½å¼€é”€

---

## ä¸‰ã€åƒåœ¾å›æ”¶ç®—æ³•

### 3.1 æ ‡è®°-æ¸…é™¤ç®—æ³•ï¼ˆMark-Sweepï¼‰

#### åŸç†

1. **æ ‡è®°é˜¶æ®µ**ï¼šæ ‡è®°æ‰€æœ‰éœ€è¦å›æ”¶çš„å¯¹è±¡
2. **æ¸…é™¤é˜¶æ®µ**ï¼šå›æ”¶è¢«æ ‡è®°çš„å¯¹è±¡

```
åˆå§‹çŠ¶æ€ï¼š
[å¯¹è±¡A][å¯¹è±¡B][å¯¹è±¡C][å¯¹è±¡D][å¯¹è±¡E]

æ ‡è®°é˜¶æ®µï¼ˆBã€Då¯å›æ”¶ï¼‰ï¼š
[å¯¹è±¡A][å¯¹è±¡Bâœ—][å¯¹è±¡C][å¯¹è±¡Dâœ—][å¯¹è±¡E]

æ¸…é™¤é˜¶æ®µï¼š
[å¯¹è±¡A][ç©ºé—²][å¯¹è±¡C][ç©ºé—²][å¯¹è±¡E]
```

#### å®ç°ç¤ºä¾‹

```java
public class MarkSweepGC {
    
    private List<Object> heap = new ArrayList<>();
    private Set<Object> marked = new HashSet<>();
    
    // æ ‡è®°é˜¶æ®µ
    public void mark(Object root) {
        if (marked.contains(root)) {
            return;
        }
        
        marked.add(root);
        
        // é€’å½’æ ‡è®°æ‰€æœ‰å¯è¾¾å¯¹è±¡
        for (Object ref : getReferences(root)) {
            mark(ref);
        }
    }
    
    // æ¸…é™¤é˜¶æ®µ
    public void sweep() {
        Iterator<Object> it = heap.iterator();
        while (it.hasNext()) {
            Object obj = it.next();
            if (!marked.contains(obj)) {
                // æœªæ ‡è®°çš„å¯¹è±¡ï¼Œå›æ”¶
                it.remove();
                System.out.println("å›æ”¶å¯¹è±¡: " + obj);
            }
        }
        
        // æ¸…ç©ºæ ‡è®°é›†åˆ
        marked.clear();
    }
    
    // æ‰§è¡ŒGC
    public void gc(Object root) {
        System.out.println("å¼€å§‹GC...");
        mark(root);
        sweep();
        System.out.println("GCå®Œæˆ");
    }
    
    private List<Object> getReferences(Object obj) {
        // è·å–å¯¹è±¡çš„æ‰€æœ‰å¼•ç”¨
        return new ArrayList<>();
    }
}
```

#### ä¼˜ç‚¹

- âœ… å®ç°ç®€å•
- âœ… ä¸éœ€è¦ç§»åŠ¨å¯¹è±¡

#### ç¼ºç‚¹

- âŒ **äº§ç”Ÿå†…å­˜ç¢ç‰‡**
- âŒ æ ‡è®°å’Œæ¸…é™¤æ•ˆç‡éƒ½ä¸é«˜
- âŒ éœ€è¦ç»´æŠ¤ç©ºé—²åˆ—è¡¨

#### å†…å­˜ç¢ç‰‡é—®é¢˜

```
å¤šæ¬¡GCåçš„å†…å­˜çŠ¶æ€ï¼š
[å¯¹è±¡][ç©ºé—²][å¯¹è±¡][ç©ºé—²][ç©ºé—²][å¯¹è±¡][ç©ºé—²]

é—®é¢˜ï¼š
- è™½ç„¶æ€»ç©ºé—²ç©ºé—´è¶³å¤Ÿ
- ä½†æ²¡æœ‰è¿ç»­çš„å¤§å—ç©ºé—´
- æ— æ³•åˆ†é…å¤§å¯¹è±¡
```

### 3.2 æ ‡è®°-å¤åˆ¶ç®—æ³•ï¼ˆMark-Copyï¼‰

#### åŸç†

1. å°†å†…å­˜åˆ†ä¸ºä¸¤å—ï¼šFromåŒºå’ŒToåŒº
2. å¯¹è±¡åˆ†é…åœ¨FromåŒº
3. GCæ—¶ï¼Œå°†FromåŒºå­˜æ´»å¯¹è±¡å¤åˆ¶åˆ°ToåŒº
4. æ¸…ç©ºFromåŒº
5. äº¤æ¢FromåŒºå’ŒToåŒº

```
åˆå§‹çŠ¶æ€ï¼ˆFromåŒºï¼‰ï¼š
[å¯¹è±¡A][å¯¹è±¡B][å¯¹è±¡C][å¯¹è±¡D][å¯¹è±¡E]
        (æ­»)           (æ­»)

å¤åˆ¶å­˜æ´»å¯¹è±¡åˆ°ToåŒºï¼š
From: [å¯¹è±¡A][å¯¹è±¡B][å¯¹è±¡C][å¯¹è±¡D][å¯¹è±¡E]
To:   [å¯¹è±¡A][å¯¹è±¡C][å¯¹è±¡E]

æ¸…ç©ºFromåŒºï¼Œäº¤æ¢è§’è‰²ï¼š
From: [å¯¹è±¡A][å¯¹è±¡C][å¯¹è±¡E]
To:   [ç©ºé—²ç©ºé—´]
```

#### å®ç°ç¤ºä¾‹

```java
public class CopyingGC {
    
    private Object[] fromSpace;
    private Object[] toSpace;
    private int fromIndex = 0;
    private int toIndex = 0;
    
    public CopyingGC(int size) {
        fromSpace = new Object[size];
        toSpace = new Object[size];
    }
    
    // åˆ†é…å¯¹è±¡
    public int allocate(Object obj) {
        if (fromIndex >= fromSpace.length) {
            gc();
        }
        fromSpace[fromIndex] = obj;
        return fromIndex++;
    }
    
    // æ‰§è¡ŒGC
    public void gc() {
        System.out.println("å¼€å§‹å¤åˆ¶GC...");
        
        toIndex = 0;
        
        // å¤åˆ¶å­˜æ´»å¯¹è±¡
        for (int i = 0; i < fromIndex; i++) {
            Object obj = fromSpace[i];
            if (isAlive(obj)) {
                toSpace[toIndex++] = obj;
                System.out.println("å¤åˆ¶å¯¹è±¡: " + obj);
            }
        }
        
        // äº¤æ¢ç©ºé—´
        Object[] temp = fromSpace;
        fromSpace = toSpace;
        toSpace = temp;
        fromIndex = toIndex;
        
        // æ¸…ç©ºToç©ºé—´
        Arrays.fill(toSpace, null);
        
        System.out.println("GCå®Œæˆï¼Œå­˜æ´»å¯¹è±¡: " + toIndex);
    }
    
    private boolean isAlive(Object obj) {
        // åˆ¤æ–­å¯¹è±¡æ˜¯å¦å­˜æ´»
        return obj != null;
    }
}
```

#### ä¼˜ç‚¹

- âœ… **æ²¡æœ‰å†…å­˜ç¢ç‰‡**
- âœ… åˆ†é…å†…å­˜ç®€å•é«˜æ•ˆï¼ˆæŒ‡é’ˆç¢°æ’ï¼‰
- âœ… é€‚åˆå­˜æ´»å¯¹è±¡å°‘çš„åœºæ™¯

#### ç¼ºç‚¹

- âŒ **æµªè´¹50%çš„å†…å­˜ç©ºé—´**
- âŒ å­˜æ´»å¯¹è±¡å¤šæ—¶ï¼Œå¤åˆ¶å¼€é”€å¤§
- âŒ éœ€è¦é¢å¤–ç©ºé—´æ‹…ä¿

#### æ”¹è¿›ï¼šä¸å¯¹ç­‰åˆ†é…

```
EdenåŒºï¼ˆ80%ï¼‰ + Survivor0ï¼ˆ10%ï¼‰ + Survivor1ï¼ˆ10%ï¼‰

æ­£å¸¸æƒ…å†µï¼š
- å¯¹è±¡åˆ†é…åœ¨EdenåŒº
- GCæ—¶ï¼ŒEdenå’ŒSurvivor0çš„å­˜æ´»å¯¹è±¡å¤åˆ¶åˆ°Survivor1
- æ¸…ç©ºEdenå’ŒSurvivor0

ä¸‹æ¬¡GCï¼š
- Edenå’ŒSurvivor1çš„å­˜æ´»å¯¹è±¡å¤åˆ¶åˆ°Survivor0
- æ¸…ç©ºEdenå’ŒSurvivor1
```

### 3.3 æ ‡è®°-æ•´ç†ç®—æ³•ï¼ˆMark-Compactï¼‰

#### åŸç†

1. **æ ‡è®°é˜¶æ®µ**ï¼šæ ‡è®°æ‰€æœ‰å­˜æ´»å¯¹è±¡
2. **æ•´ç†é˜¶æ®µ**ï¼šå°†å­˜æ´»å¯¹è±¡ç§»åŠ¨åˆ°å†…å­˜ä¸€ç«¯
3. **æ¸…é™¤é˜¶æ®µ**ï¼šæ¸…ç†è¾¹ç•Œå¤–çš„å†…å­˜

```
åˆå§‹çŠ¶æ€ï¼š
[å¯¹è±¡A][å¯¹è±¡B][å¯¹è±¡C][å¯¹è±¡D][å¯¹è±¡E]
        (æ­»)           (æ­»)

æ ‡è®°å­˜æ´»å¯¹è±¡ï¼š
[å¯¹è±¡Aâœ“][å¯¹è±¡Bâœ—][å¯¹è±¡Câœ“][å¯¹è±¡Dâœ—][å¯¹è±¡Eâœ“]

æ•´ç†ï¼ˆç§»åŠ¨å­˜æ´»å¯¹è±¡ï¼‰ï¼š
[å¯¹è±¡A][å¯¹è±¡C][å¯¹è±¡E][ç©ºé—²ç©ºé—´]
```

#### å®ç°ç¤ºä¾‹

```java
public class CompactingGC {
    
    private Object[] heap;
    private boolean[] marked;
    private int nextFree = 0;
    
    public CompactingGC(int size) {
        heap = new Object[size];
        marked = new boolean[size];
    }
    
    // æ ‡è®°é˜¶æ®µ
    public void mark(Set<Integer> roots) {
        Arrays.fill(marked, false);
        
        for (int root : roots) {
            markObject(root);
        }
    }
    
    private void markObject(int index) {
        if (index < 0 || index >= heap.length || marked[index]) {
            return;
        }
        
        marked[index] = true;
        
        // é€’å½’æ ‡è®°å¼•ç”¨çš„å¯¹è±¡
        for (int ref : getReferences(index)) {
            markObject(ref);
        }
    }
    
    // æ•´ç†é˜¶æ®µ
    public void compact() {
        int writeIndex = 0;
        
        // ç§»åŠ¨å­˜æ´»å¯¹è±¡
        for (int i = 0; i < heap.length; i++) {
            if (marked[i]) {
                if (i != writeIndex) {
                    heap[writeIndex] = heap[i];
                    heap[i] = null;
                    System.out.println("ç§»åŠ¨å¯¹è±¡: " + heap[writeIndex] + 
                                     " ä» " + i + " åˆ° " + writeIndex);
                }
                writeIndex++;
            }
        }
        
        // æ¸…ç†å‰©ä½™ç©ºé—´
        for (int i = writeIndex; i < heap.length; i++) {
            heap[i] = null;
        }
        
        nextFree = writeIndex;
        System.out.println("æ•´ç†å®Œæˆï¼Œä¸‹ä¸€ä¸ªç©ºé—²ä½ç½®: " + nextFree);
    }
    
    // æ‰§è¡ŒGC
    public void gc(Set<Integer> roots) {
        System.out.println("å¼€å§‹æ ‡è®°-æ•´ç†GC...");
        mark(roots);
        compact();
        System.out.println("GCå®Œæˆ");
    }
    
    private List<Integer> getReferences(int index) {
        // è·å–å¯¹è±¡çš„å¼•ç”¨
        return new ArrayList<>();
    }
}
```

#### ä¼˜ç‚¹

- âœ… **æ²¡æœ‰å†…å­˜ç¢ç‰‡**
- âœ… **ä¸æµªè´¹å†…å­˜ç©ºé—´**
- âœ… é€‚åˆå­˜æ´»å¯¹è±¡å¤šçš„åœºæ™¯

#### ç¼ºç‚¹

- âŒ **ç§»åŠ¨å¯¹è±¡å¼€é”€å¤§**
- âŒ éœ€è¦æ›´æ–°æ‰€æœ‰å¼•ç”¨
- âŒ éœ€è¦æš‚åœæ—¶é—´æ›´é•¿

### 3.4 ä¸‰ç§ç®—æ³•å¯¹æ¯”

| ç®—æ³• | å†…å­˜ç¢ç‰‡ | å†…å­˜åˆ©ç”¨ç‡ | ç§»åŠ¨å¯¹è±¡ | é€‚ç”¨åœºæ™¯ |
|------|---------|-----------|---------|---------|
| **æ ‡è®°-æ¸…é™¤** | æœ‰ | é«˜ | å¦ | å¯¹è±¡å­˜æ´»ç‡é«˜ |
| **æ ‡è®°-å¤åˆ¶** | æ—  | ä½ï¼ˆ50%ï¼‰ | æ˜¯ | å¯¹è±¡å­˜æ´»ç‡ä½ |
| **æ ‡è®°-æ•´ç†** | æ—  | é«˜ | æ˜¯ | å¯¹è±¡å­˜æ´»ç‡é«˜ |

#### é€‰æ‹©å»ºè®®

```
æ–°ç”Ÿä»£ï¼ˆå¯¹è±¡å­˜æ´»ç‡ä½ï¼‰ï¼š
â†’ æ ‡è®°-å¤åˆ¶ç®—æ³•

è€å¹´ä»£ï¼ˆå¯¹è±¡å­˜æ´»ç‡é«˜ï¼‰ï¼š
â†’ æ ‡è®°-æ¸…é™¤ æˆ– æ ‡è®°-æ•´ç†
```

---

## å››ã€å¼•ç”¨ç±»å‹

### 4.1 å¼•ç”¨ç±»å‹æ¦‚è¿°

Javaæä¾›äº†4ç§å¼•ç”¨ç±»å‹ï¼Œç”¨äºæ›´çµæ´»åœ°æ§åˆ¶å¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸã€‚

```
å¼ºå¼•ç”¨ > è½¯å¼•ç”¨ > å¼±å¼•ç”¨ > è™šå¼•ç”¨
ï¼ˆå¼•ç”¨å¼ºåº¦ä»å¼ºåˆ°å¼±ï¼‰
```

### 4.2 å¼ºå¼•ç”¨ï¼ˆStrong Referenceï¼‰

#### å®šä¹‰

æœ€å¸¸è§çš„å¼•ç”¨ç±»å‹ï¼Œåªè¦å¼ºå¼•ç”¨å­˜åœ¨ï¼Œå¯¹è±¡å°±ä¸ä¼šè¢«å›æ”¶ã€‚

```java
// å¼ºå¼•ç”¨
Object obj = new Object();

// åªè¦objè¿˜æŒ‡å‘å¯¹è±¡ï¼Œå¯¹è±¡å°±ä¸ä¼šè¢«GC
// å³ä½¿å†…å­˜ä¸è¶³ï¼Œä¹Ÿä¸ä¼šå›æ”¶ï¼Œè€Œæ˜¯æŠ›å‡ºOOM
```

#### ç‰¹ç‚¹

- âœ… æœ€å¸¸ç”¨çš„å¼•ç”¨ç±»å‹
- âœ… åªè¦å¼ºå¼•ç”¨å­˜åœ¨ï¼Œå¯¹è±¡æ°¸è¿œä¸ä¼šè¢«å›æ”¶
- âŒ å¯èƒ½å¯¼è‡´å†…å­˜æ³„æ¼

#### ç¤ºä¾‹

```java
public class StrongReferenceDemo {
    public static void main(String[] args) {
        // åˆ›å»ºå¼ºå¼•ç”¨
        Object obj = new Object();
        System.out.println("å¯¹è±¡: " + obj);
        
        // å³ä½¿å†…å­˜ä¸è¶³ï¼Œä¹Ÿä¸ä¼šå›æ”¶obj
        // åªæœ‰å½“obj = nullæ—¶ï¼Œå¯¹è±¡æ‰å¯èƒ½è¢«å›æ”¶
        
        // æ–­å¼€å¼ºå¼•ç”¨
        obj = null;
        
        // æ­¤æ—¶å¯¹è±¡å¯ä»¥è¢«GCå›æ”¶
        System.gc();
    }
}
```

### 4.3 è½¯å¼•ç”¨ï¼ˆSoft Referenceï¼‰

#### å®šä¹‰

å†…å­˜å……è¶³æ—¶ä¿ç•™ï¼Œå†…å­˜ä¸è¶³æ—¶å›æ”¶ã€‚

```java
import java.lang.ref.SoftReference;

// åˆ›å»ºè½¯å¼•ç”¨
Object obj = new Object();
SoftReference<Object> softRef = new SoftReference<>(obj);
obj = null;  // æ–­å¼€å¼ºå¼•ç”¨

// è·å–å¯¹è±¡
Object retrieved = softRef.get();
if (retrieved != null) {
    System.out.println("å¯¹è±¡è¿˜åœ¨");
} else {
    System.out.println("å¯¹è±¡å·²è¢«å›æ”¶");
}
```

#### ç‰¹ç‚¹

- âœ… å†…å­˜å……è¶³æ—¶ä¸å›æ”¶
- âœ… å†…å­˜ä¸è¶³æ—¶å›æ”¶
- âœ… é€‚åˆå®ç°ç¼“å­˜

#### åº”ç”¨åœºæ™¯ï¼šå›¾ç‰‡ç¼“å­˜

```java
public class ImageCache {
    
    private Map<String, SoftReference<Image>> cache = new HashMap<>();
    
    public Image getImage(String path) {
        // ä»ç¼“å­˜è·å–
        SoftReference<Image> ref = cache.get(path);
        if (ref != null) {
            Image image = ref.get();
            if (image != null) {
                System.out.println("ä»ç¼“å­˜è·å–å›¾ç‰‡: " + path);
                return image;
            }
        }
        
        // ç¼“å­˜ä¸­æ²¡æœ‰ï¼ŒåŠ è½½å›¾ç‰‡
        Image image = loadImage(path);
        cache.put(path, new SoftReference<>(image));
        System.out.println("åŠ è½½å›¾ç‰‡: " + path);
        return image;
    }
    
    private Image loadImage(String path) {
        // ä»ç£ç›˜åŠ è½½å›¾ç‰‡
        return new Image(path);
    }
    
    static class Image {
        private String path;
        private byte[] data = new byte[1024 * 1024];  // 1MB
        
        public Image(String path) {
            this.path = path;
        }
    }
    
    public static void main(String[] args) {
        ImageCache cache = new ImageCache();
        
        // åŠ è½½å›¾ç‰‡
        cache.getImage("image1.jpg");
        cache.getImage("image2.jpg");
        
        // å†æ¬¡è·å–ï¼ˆä»ç¼“å­˜ï¼‰
        cache.getImage("image1.jpg");
        
        // æ¨¡æ‹Ÿå†…å­˜ä¸è¶³
        // è½¯å¼•ç”¨çš„å›¾ç‰‡ä¼šè¢«å›æ”¶
    }
}
```

### 4.4 å¼±å¼•ç”¨ï¼ˆWeak Referenceï¼‰

#### å®šä¹‰

åªè¦å‘ç”ŸGCï¼Œå°±ä¼šè¢«å›æ”¶ï¼Œæ— è®ºå†…å­˜æ˜¯å¦å……è¶³ã€‚

```java
import java.lang.ref.WeakReference;

// åˆ›å»ºå¼±å¼•ç”¨
Object obj = new Object();
WeakReference<Object> weakRef = new WeakReference<>(obj);
obj = null;  // æ–­å¼€å¼ºå¼•ç”¨

// æ­¤æ—¶å¯¹è±¡åªæœ‰å¼±å¼•ç”¨
System.gc();  // è§¦å‘GC

// å¯¹è±¡è¢«å›æ”¶
Object retrieved = weakRef.get();
System.out.println(retrieved);  // null
```

#### ç‰¹ç‚¹

- âœ… ä¸å½±å“å¯¹è±¡çš„å›æ”¶
- âœ… é€‚åˆå®ç°è§„èŒƒåŒ–æ˜ å°„
- âŒ ç”Ÿå‘½å‘¨æœŸå¾ˆçŸ­

#### åº”ç”¨åœºæ™¯ï¼šThreadLocal

```java
public class ThreadLocal<T> {
    
    static class Entry extends WeakReference<ThreadLocal<?>> {
        Object value;
        
        Entry(ThreadLocal<?> k, Object v) {
            super(k);  // ThreadLocalä½œä¸ºå¼±å¼•ç”¨
            value = v;
        }
    }
    
    // ThreadLocalä½œä¸ºkeyï¼Œä½¿ç”¨å¼±å¼•ç”¨
    // å½“ThreadLocalæ²¡æœ‰å¼ºå¼•ç”¨æ—¶ï¼Œä¼šè¢«GCå›æ”¶
    // é¿å…å†…å­˜æ³„æ¼
}
```

#### WeakHashMapç¤ºä¾‹

```java
import java.util.WeakHashMap;

public class WeakHashMapDemo {
    public static void main(String[] args) {
        WeakHashMap<Object, String> map = new WeakHashMap<>();
        
        Object key1 = new Object();
        Object key2 = new Object();
        
        map.put(key1, "value1");
        map.put(key2, "value2");
        
        System.out.println("GCå‰: " + map.size());  // 2
        
        // æ–­å¼€key1çš„å¼ºå¼•ç”¨
        key1 = null;
        
        // è§¦å‘GC
        System.gc();
        
        try {
            Thread.sleep(100);
        } catch (InterruptedException e) {
            e.printStackTrace();
        }
        
        System.out.println("GCå: " + map.size());  // 1
        // key1è¢«å›æ”¶ï¼Œå¯¹åº”çš„entryä¹Ÿè¢«åˆ é™¤
    }
}
```

### 4.5 è™šå¼•ç”¨ï¼ˆPhantom Referenceï¼‰

#### å®šä¹‰

æœ€å¼±çš„å¼•ç”¨ç±»å‹ï¼Œæ— æ³•é€šè¿‡è™šå¼•ç”¨è·å–å¯¹è±¡ï¼Œä¸»è¦ç”¨äºè·Ÿè¸ªå¯¹è±¡è¢«å›æ”¶çš„çŠ¶æ€ã€‚

```java
import java.lang.ref.PhantomReference;
import java.lang.ref.ReferenceQueue;

// åˆ›å»ºè™šå¼•ç”¨
Object obj = new Object();
ReferenceQueue<Object> queue = new ReferenceQueue<>();
PhantomReference<Object> phantomRef = new PhantomReference<>(obj, queue);

// æ— æ³•é€šè¿‡è™šå¼•ç”¨è·å–å¯¹è±¡
Object retrieved = phantomRef.get();
System.out.println(retrieved);  // æ€»æ˜¯null
```

#### ç‰¹ç‚¹

- âœ… è·Ÿè¸ªå¯¹è±¡å›æ”¶çŠ¶æ€
- âœ… å¯ä»¥åœ¨å¯¹è±¡å›æ”¶å‰åšæ¸…ç†å·¥ä½œ
- âŒ æ— æ³•é€šè¿‡è™šå¼•ç”¨è·å–å¯¹è±¡

#### åº”ç”¨åœºæ™¯ï¼šèµ„æºæ¸…ç†

```java
import java.lang.ref.*;
import java.util.HashMap;
import java.util.Map;

public class ResourceCleanup {
    
    private static ReferenceQueue<Object> queue = new ReferenceQueue<>();
    private static Map<PhantomReference<Object>, String> resources = new HashMap<>();
    
    public static void track(Object obj, String resourceName) {
        PhantomReference<Object> ref = new PhantomReference<>(obj, queue);
        resources.put(ref, resourceName);
    }
    
    public static void cleanup() {
        Reference<?> ref;
        while ((ref = queue.poll()) != null) {
            String resourceName = resources.remove(ref);
            System.out.println("æ¸…ç†èµ„æº: " + resourceName);
            // æ‰§è¡Œæ¸…ç†æ“ä½œ
        }
    }
    
    public static void main(String[] args) throws InterruptedException {
        // åˆ›å»ºå¯¹è±¡å¹¶è·Ÿè¸ª
        Object obj1 = new Object();
        track(obj1, "Resource1");
        
        Object obj2 = new Object();
        track(obj2, "Resource2");
        
        // æ–­å¼€å¼•ç”¨
        obj1 = null;
        obj2 = null;
        
        // è§¦å‘GC
        System.gc();
        Thread.sleep(100);
        
        // æ¸…ç†èµ„æº
        cleanup();
    }
}
```

### 4.6 å¼•ç”¨ç±»å‹å¯¹æ¯”

| å¼•ç”¨ç±»å‹ | å›æ”¶æ—¶æœº | ç”¨é€” | get()è¿”å›å€¼ |
|---------|---------|------|------------|
| **å¼ºå¼•ç”¨** | æ°¸ä¸å›æ”¶ | æ™®é€šå¯¹è±¡å¼•ç”¨ | å¯¹è±¡æœ¬èº« |
| **è½¯å¼•ç”¨** | å†…å­˜ä¸è¶³æ—¶ | ç¼“å­˜ | å¯¹è±¡æˆ–null |
| **å¼±å¼•ç”¨** | ä¸‹æ¬¡GCæ—¶ | è§„èŒƒåŒ–æ˜ å°„ | å¯¹è±¡æˆ–null |
| **è™šå¼•ç”¨** | ä¸‹æ¬¡GCæ—¶ | è·Ÿè¸ªå›æ”¶ | æ€»æ˜¯null |

---

## äº”ã€GCç›¸å…³æ¦‚å¿µ

### 5.1 Stop The Worldï¼ˆSTWï¼‰

#### å®šä¹‰

GCæ—¶æš‚åœæ‰€æœ‰åº”ç”¨çº¿ç¨‹ï¼Œç­‰å¾…GCå®Œæˆã€‚

```
åº”ç”¨çº¿ç¨‹ï¼š  è¿è¡Œ â†’ æš‚åœ â†’ ç­‰å¾…GC â†’ æ¢å¤è¿è¡Œ
                    â†“
GCçº¿ç¨‹ï¼š           å¯åŠ¨ â†’ æ‰§è¡ŒGC â†’ å®Œæˆ
```

#### ä¸ºä»€ä¹ˆéœ€è¦STW

```java
// é—®é¢˜ï¼šå¦‚æœä¸æš‚åœåº”ç”¨çº¿ç¨‹
// GCçº¿ç¨‹æ­£åœ¨æ ‡è®°å¯¹è±¡A
// åº”ç”¨çº¿ç¨‹ä¿®æ”¹äº†å¯¹è±¡Açš„å¼•ç”¨
// å¯¼è‡´æ ‡è®°ç»“æœä¸å‡†ç¡®

// è§£å†³ï¼šSTWç¡®ä¿å¯¹è±¡å›¾ä¸å˜
```

#### å½±å“

- âŒ åº”ç”¨æš‚åœï¼Œå½±å“ç”¨æˆ·ä½“éªŒ
- âŒ æš‚åœæ—¶é—´è¶Šé•¿ï¼Œå½±å“è¶Šå¤§
- âœ… ç°ä»£GCè‡´åŠ›äºå‡å°‘STWæ—¶é—´

### 5.2 å®‰å…¨ç‚¹ï¼ˆSafepointï¼‰

#### å®šä¹‰

ç¨‹åºæ‰§è¡Œè¿‡ç¨‹ä¸­å¯ä»¥æš‚åœçš„ä½ç½®ã€‚

```java
// å®‰å…¨ç‚¹ä½ç½®ï¼š
// 1. æ–¹æ³•è°ƒç”¨
// 2. å¾ªç¯è·³è½¬
// 3. å¼‚å¸¸è·³è½¬

public void method() {
    int sum = 0;
    for (int i = 0; i < 1000000; i++) {  // å¾ªç¯è·³è½¬ï¼ˆå®‰å…¨ç‚¹ï¼‰
        sum += i;
        if (i % 100 == 0) {
            doSomething();  // æ–¹æ³•è°ƒç”¨ï¼ˆå®‰å…¨ç‚¹ï¼‰
        }
    }
}
```

#### ä¸ºä»€ä¹ˆéœ€è¦å®‰å…¨ç‚¹

- ç¡®ä¿çº¿ç¨‹çŠ¶æ€ä¸€è‡´
- æ–¹ä¾¿ç”ŸæˆOopMap
- å‡å°‘GCå¼€é”€

### 5.3 å®‰å…¨åŒºåŸŸï¼ˆSafe Regionï¼‰

#### å®šä¹‰

çº¿ç¨‹å¤„äºSleepæˆ–BlockedçŠ¶æ€æ—¶ï¼Œæ— æ³•å“åº”å®‰å…¨ç‚¹è¯·æ±‚ï¼Œéœ€è¦å®‰å…¨åŒºåŸŸã€‚

```
çº¿ç¨‹çŠ¶æ€ï¼š
- Runningï¼šå¯ä»¥åˆ°è¾¾å®‰å…¨ç‚¹
- Sleep/Blockedï¼šå·²ç»åœ¨å®‰å…¨åŒºåŸŸ

GCæµç¨‹ï¼š
1. å‘å‡ºGCè¯·æ±‚
2. ç­‰å¾…æ‰€æœ‰çº¿ç¨‹åˆ°è¾¾å®‰å…¨ç‚¹æˆ–å®‰å…¨åŒºåŸŸ
3. æ‰§è¡ŒGC
4. æ¢å¤çº¿ç¨‹æ‰§è¡Œ
```

### 5.4 è®°å¿†é›†ï¼ˆRemembered Setï¼‰

#### å®šä¹‰

è®°å½•ä»å…¶ä»–åŒºåŸŸæŒ‡å‘æœ¬åŒºåŸŸçš„å¼•ç”¨ï¼Œé¿å…å…¨å †æ‰«æã€‚

```
è€å¹´ä»£å¯¹è±¡ â†’ æ–°ç”Ÿä»£å¯¹è±¡

é—®é¢˜ï¼š
- æ–°ç”Ÿä»£GCæ—¶ï¼Œéœ€è¦æ‰«æè€å¹´ä»£æ‰¾åˆ°å¼•ç”¨
- è€å¹´ä»£å¾ˆå¤§ï¼Œæ‰«ææ…¢

è§£å†³ï¼š
- ä½¿ç”¨è®°å¿†é›†è®°å½•è€å¹´ä»£â†’æ–°ç”Ÿä»£çš„å¼•ç”¨
- æ–°ç”Ÿä»£GCæ—¶ï¼Œåªæ‰«æè®°å¿†é›†
```

### 5.5 å¡è¡¨ï¼ˆCard Tableï¼‰

#### å®šä¹‰

è®°å¿†é›†çš„ä¸€ç§å®ç°æ–¹å¼ï¼Œå°†å †åˆ’åˆ†ä¸ºå›ºå®šå¤§å°çš„å¡ç‰‡ã€‚

```
å †å†…å­˜ï¼š
[å¡ç‰‡0][å¡ç‰‡1][å¡ç‰‡2][å¡ç‰‡3]...

å¡è¡¨ï¼š
[0][1][0][1]...
 â†‘  â†‘  â†‘  â†‘
 |  |  |  â””â”€ å¡ç‰‡3æœ‰è·¨ä»£å¼•ç”¨
 |  |  â””â”€â”€â”€â”€ å¡ç‰‡2æ— è·¨ä»£å¼•ç”¨
 |  â””â”€â”€â”€â”€â”€â”€â”€ å¡ç‰‡1æœ‰è·¨ä»£å¼•ç”¨
 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ å¡ç‰‡0æ— è·¨ä»£å¼•ç”¨
```

---

## å…­ã€æ€»ç»“

### 6.1 æ ¸å¿ƒçŸ¥è¯†ç‚¹

| çŸ¥è¯†ç‚¹ | è¦ç‚¹ |
|-------|------|
| **å¯¹è±¡å­˜æ´»åˆ¤å®š** | å¼•ç”¨è®¡æ•°æ³•ã€å¯è¾¾æ€§åˆ†æ |
| **GCç®—æ³•** | æ ‡è®°-æ¸…é™¤ã€æ ‡è®°-å¤åˆ¶ã€æ ‡è®°-æ•´ç† |
| **å¼•ç”¨ç±»å‹** | å¼ºã€è½¯ã€å¼±ã€è™šå¼•ç”¨ |
| **GCæ¦‚å¿µ** | STWã€å®‰å…¨ç‚¹ã€è®°å¿†é›† |

### 6.2 ç®—æ³•é€‰æ‹©

```
æ–°ç”Ÿä»£ï¼š
- å¯¹è±¡å­˜æ´»ç‡ä½ï¼ˆ10%å·¦å³ï¼‰
- ä½¿ç”¨æ ‡è®°-å¤åˆ¶ç®—æ³•
- Eden + Survivor0 + Survivor1

è€å¹´ä»£ï¼š
- å¯¹è±¡å­˜æ´»ç‡é«˜ï¼ˆ90%ä»¥ä¸Šï¼‰
- ä½¿ç”¨æ ‡è®°-æ¸…é™¤æˆ–æ ‡è®°-æ•´ç†
- æ ¹æ®å…·ä½“GCå™¨é€‰æ‹©
```

### 6.3 æœ€ä½³å®è·µ

1. âœ… ç†è§£ä¸åŒGCç®—æ³•çš„ç‰¹ç‚¹
2. âœ… åˆç†ä½¿ç”¨å¼•ç”¨ç±»å‹
3. âœ… é¿å…åˆ›å»ºä¸å¿…è¦çš„å¯¹è±¡
4. âœ… åŠæ—¶é‡Šæ”¾ä¸å†ä½¿ç”¨çš„å¼•ç”¨
5. âœ… ä½¿ç”¨å¯¹è±¡æ± å‡å°‘GCå‹åŠ›

---

## ğŸ“š å‚è€ƒèµ„æ–™

1. **ã€Šæ·±å…¥ç†è§£Javaè™šæ‹Ÿæœºï¼ˆç¬¬3ç‰ˆï¼‰ã€‹** - å‘¨å¿—æ˜
2. **ã€ŠJavaæ€§èƒ½ä¼˜åŒ–æƒå¨æŒ‡å—ã€‹** - Charlie Hunt
3. **ã€Šåƒåœ¾å›æ”¶ç®—æ³•æ‰‹å†Œã€‹** - Richard Jones

---

**ä¸‹ä¸€ç¯‡**ï¼š[åˆ†ä»£åƒåœ¾å›æ”¶](./02_åˆ†ä»£åƒåœ¾å›æ”¶.md)
