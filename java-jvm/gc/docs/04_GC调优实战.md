# GCè°ƒä¼˜å®æˆ˜

## ğŸ“š æ¦‚è¿°

GCè°ƒä¼˜æ˜¯JVMæ€§èƒ½ä¼˜åŒ–çš„æ ¸å¿ƒå†…å®¹ã€‚æœ¬æ–‡ä»å®æˆ˜è§’åº¦è®²è§£å¦‚ä½•åˆ†æGCæ—¥å¿—ã€å®šä½æ€§èƒ½é—®é¢˜ã€åˆ¶å®šè°ƒä¼˜æ–¹æ¡ˆã€‚

## ğŸ¯ æ ¸å¿ƒé—®é¢˜

- â“ å¦‚ä½•åˆ†æGCæ—¥å¿—ï¼Ÿ
- â“ å¦‚ä½•å®šä½GCé—®é¢˜ï¼Ÿ
- â“ å¸¸è§çš„GCé—®é¢˜æœ‰å“ªäº›ï¼Ÿ
- â“ å¦‚ä½•åˆ¶å®šè°ƒä¼˜æ–¹æ¡ˆï¼Ÿ
- â“ æœ‰å“ªäº›è°ƒä¼˜å·¥å…·ï¼Ÿ
- â“ è°ƒä¼˜çš„æœ€ä½³å®è·µæ˜¯ä»€ä¹ˆï¼Ÿ

---

## ä¸€ã€GCè°ƒä¼˜ç›®æ ‡

### 1.1 è°ƒä¼˜æŒ‡æ ‡

```
1. ååé‡ï¼ˆThroughputï¼‰
   = è¿è¡Œç”¨æˆ·ä»£ç æ—¶é—´ / æ€»è¿è¡Œæ—¶é—´
   ç›®æ ‡ï¼š> 95%

2. å»¶è¿Ÿï¼ˆLatencyï¼‰
   = GCåœé¡¿æ—¶é—´
   ç›®æ ‡ï¼š< 200ms

3. å†…å­˜å ç”¨ï¼ˆFootprintï¼‰
   = å †å†…å­˜å¤§å°
   ç›®æ ‡ï¼šåˆç†å³å¯

ä¸‰è€…å…³ç³»ï¼š
ä¸å¯èƒ½åŒæ—¶ä¼˜åŒ–ï¼Œéœ€è¦æƒè¡¡
```

### 1.2 è°ƒä¼˜åŸåˆ™

```
1. ä¼˜å…ˆçº§
   æ­£ç¡®æ€§ > ååé‡ > å»¶è¿Ÿ > å†…å­˜å ç”¨

2. è°ƒä¼˜æ­¥éª¤
   ç›‘æ§ â†’ åˆ†æ â†’ è°ƒæ•´ â†’ éªŒè¯

3. è°ƒä¼˜ç¦å¿Œ
   - ä¸è¦è¿‡æ—©ä¼˜åŒ–
   - ä¸è¦ç›²ç›®è°ƒæ•´å‚æ•°
   - ä¸è¦å¿½ç•¥ä¸šåŠ¡ä»£ç é—®é¢˜
```

---

## äºŒã€GCæ—¥å¿—åˆ†æ

### 2.1 å¼€å¯GCæ—¥å¿—

```bash
# JDK 8åŠä¹‹å‰
java -XX:+PrintGCDetails \
     -XX:+PrintGCDateStamps \
     -XX:+PrintGCTimeStamps \
     -Xloggc:gc.log \
     -jar app.jar

# JDK 9åŠä¹‹å
java -Xlog:gc*:file=gc.log:time,uptime,level,tags \
     -jar app.jar

# æ¨èå‚æ•°
java -XX:+PrintGCDetails \
     -XX:+PrintGCDateStamps \
     -XX:+PrintGCTimeStamps \
     -XX:+PrintHeapAtGC \
     -XX:+PrintTenuringDistribution \
     -XX:+PrintGCApplicationStoppedTime \
     -Xloggc:gc-%t.log \
     -XX:+UseGCLogFileRotation \
     -XX:NumberOfGCLogFiles=5 \
     -XX:GCLogFileSize=20M \
     -jar app.jar
```

### 2.2 GCæ—¥å¿—æ ¼å¼

#### Minor GCæ—¥å¿—

```
2024-01-03T19:30:15.123+0800: 1.234: [GC (Allocation Failure) [PSYoungGen: 8192K->1024K(9216K)] 8192K->5120K(19456K), 0.0012345 secs] [Times: user=0.00 sys=0.00, real=0.00 secs]

è§£è¯»ï¼š
- 2024-01-03T19:30:15.123+0800: æ—¶é—´æˆ³
- 1.234: JVMå¯åŠ¨åçš„ç§’æ•°
- GC (Allocation Failure): GCç±»å‹å’ŒåŸå› 
- PSYoungGen: æ–°ç”Ÿä»£æ”¶é›†å™¨åç§°
- 8192K->1024K(9216K): æ–°ç”Ÿä»£GCå‰->GCå(æ€»å®¹é‡)
- 8192K->5120K(19456K): æ•´ä¸ªå †GCå‰->GCå(æ€»å®¹é‡)
- 0.0012345 secs: GCè€—æ—¶
- Times: user=ç”¨æˆ·æ€CPUæ—¶é—´ sys=å†…æ ¸æ€CPUæ—¶é—´ real=å®é™…è€—æ—¶
```

#### Full GCæ—¥å¿—

```
2024-01-03T19:30:20.456+0800: 6.567: [Full GC (Ergonomics) [PSYoungGen: 1024K->0K(9216K)] [ParOldGen: 8192K->5120K(10240K)] 9216K->5120K(19456K), [Metaspace: 3072K->3072K(1056768K)], 0.0123456 secs] [Times: user=0.04 sys=0.00, real=0.01 secs]

è§£è¯»ï¼š
- Full GC: å…¨å †GC
- (Ergonomics): GCåŸå› ï¼ˆè‡ªé€‚åº”ç­–ç•¥ï¼‰
- PSYoungGen: æ–°ç”Ÿä»£å›æ”¶æƒ…å†µ
- ParOldGen: è€å¹´ä»£å›æ”¶æƒ…å†µ
- Metaspace: å…ƒç©ºé—´å›æ”¶æƒ…å†µ
- 0.0123456 secs: GCè€—æ—¶
```

#### CMS GCæ—¥å¿—

```
2024-01-03T19:30:25.789+0800: 11.890: [GC (CMS Initial Mark) [1 CMS-initial-mark: 10240K(20480K)] 14336K(29696K), 0.0001234 secs] [Times: user=0.00 sys=0.00, real=0.00 secs]
2024-01-03T19:30:25.790+0800: 11.891: [CMS-concurrent-mark-start]
2024-01-03T19:30:25.900+0800: 12.001: [CMS-concurrent-mark: 0.110/0.110 secs] [Times: user=0.22 sys=0.01, real=0.11 secs]
2024-01-03T19:30:25.901+0800: 12.002: [CMS-concurrent-preclean-start]
2024-01-03T19:30:25.905+0800: 12.006: [CMS-concurrent-preclean: 0.004/0.004 secs] [Times: user=0.01 sys=0.00, real=0.00 secs]
2024-01-03T19:30:25.906+0800: 12.007: [GC (CMS Final Remark) [YG occupancy: 4096 K (9216 K)][Rescan (parallel) , 0.0012345 secs][weak refs processing, 0.0001234 secs][class unloading, 0.0001234 secs][scrub symbol table, 0.0001234 secs][scrub string table, 0.0001234 secs][1 CMS-remark: 10240K(20480K)] 14336K(29696K), 0.0023456 secs] [Times: user=0.01 sys=0.00, real=0.00 secs]
2024-01-03T19:30:25.909+0800: 12.010: [CMS-concurrent-sweep-start]
2024-01-03T19:30:26.009+0800: 12.110: [CMS-concurrent-sweep: 0.100/0.100 secs] [Times: user=0.20 sys=0.01, real=0.10 secs]
2024-01-03T19:30:26.010+0800: 12.111: [CMS-concurrent-reset-start]
2024-01-03T19:30:26.015+0800: 12.116: [CMS-concurrent-reset: 0.005/0.005 secs] [Times: user=0.01 sys=0.00, real=0.01 secs]

è§£è¯»ï¼š
- CMS Initial Mark: åˆå§‹æ ‡è®°ï¼ˆSTWï¼‰
- CMS-concurrent-mark: å¹¶å‘æ ‡è®°
- CMS-concurrent-preclean: å¹¶å‘é¢„æ¸…ç†
- CMS Final Remark: æœ€ç»ˆæ ‡è®°ï¼ˆSTWï¼‰
- CMS-concurrent-sweep: å¹¶å‘æ¸…é™¤
- CMS-concurrent-reset: å¹¶å‘é‡ç½®
```

### 2.3 GCæ—¥å¿—åˆ†æå·¥å…·

```
1. GCEasy
   - åœ¨çº¿å·¥å…·ï¼šhttps://gceasy.io/
   - ä¸Šä¼ GCæ—¥å¿—ï¼Œè‡ªåŠ¨åˆ†æ
   - ç”Ÿæˆå›¾è¡¨å’Œå»ºè®®

2. GCViewer
   - å¼€æºå·¥å…·
   - å¯è§†åŒ–GCæ—¥å¿—
   - ä¸‹è½½ï¼šhttps://github.com/chewiebug/GCViewer

3. GCPlot
   - åœ¨çº¿å·¥å…·
   - å®æ—¶ç›‘æ§GC
   - https://gcplot.com/

4. JVM Profiler
   - Uberå¼€æºå·¥å…·
   - åˆ†å¸ƒå¼JVMæ€§èƒ½åˆ†æ
```

---

## ä¸‰ã€å¸¸è§GCé—®é¢˜

### 3.1 é¢‘ç¹Minor GC

#### é—®é¢˜è¡¨ç°

```
GCæ—¥å¿—ï¼š
[GC (Allocation Failure) ... 0.0012 secs]
[GC (Allocation Failure) ... 0.0013 secs]
[GC (Allocation Failure) ... 0.0011 secs]
...
æ¯ç§’è§¦å‘å¤šæ¬¡Minor GC
```

#### åŸå› åˆ†æ

```
1. æ–°ç”Ÿä»£å¤ªå°
   - EdenåŒºå¾ˆå¿«å¡«æ»¡
   - é¢‘ç¹è§¦å‘Minor GC

2. å¯¹è±¡åˆ›å»ºé€Ÿç‡é«˜
   - ä¸šåŠ¡ä»£ç åˆ›å»ºå¤§é‡ä¸´æ—¶å¯¹è±¡
   - EdenåŒºå¿«é€Ÿå¡«æ»¡

3. SurvivoråŒºå¤ªå°
   - å­˜æ´»å¯¹è±¡æ”¾ä¸ä¸‹
   - æå‰æ™‹å‡åˆ°è€å¹´ä»£
```

#### è§£å†³æ–¹æ¡ˆ

```bash
# 1. å¢å¤§æ–°ç”Ÿä»£
java -Xmn2g -jar app.jar

# 2. è°ƒæ•´æ–°ç”Ÿä»£æ¯”ä¾‹
java -XX:NewRatio=2 -jar app.jar  # æ–°ç”Ÿä»£:è€å¹´ä»£ = 1:2

# 3. å¢å¤§EdenåŒº
java -XX:SurvivorRatio=8 -jar app.jar  # Eden:Survivor = 8:1

# 4. ä¼˜åŒ–ä¸šåŠ¡ä»£ç 
# - å‡å°‘ä¸´æ—¶å¯¹è±¡åˆ›å»º
# - ä½¿ç”¨å¯¹è±¡æ± 
# - å¤ç”¨å¯¹è±¡
```

### 3.2 é¢‘ç¹Full GC

#### é—®é¢˜è¡¨ç°

```
GCæ—¥å¿—ï¼š
[Full GC (Ergonomics) ... 0.1234 secs]
[Full GC (Ergonomics) ... 0.1345 secs]
[Full GC (Ergonomics) ... 0.1456 secs]
...
é¢‘ç¹Full GCï¼Œæ¯æ¬¡è€—æ—¶é•¿
```

#### åŸå› åˆ†æ

```
1. è€å¹´ä»£ç©ºé—´ä¸è¶³
   - å¯¹è±¡æ™‹å‡é€Ÿåº¦å¿«
   - è€å¹´ä»£å¾ˆå¿«å¡«æ»¡

2. Metaspaceç©ºé—´ä¸è¶³
   - ç±»åŠ è½½è¿‡å¤š
   - è§¦å‘Full GC

3. æ˜¾å¼è°ƒç”¨System.gc()
   - ä»£ç ä¸­è°ƒç”¨System.gc()
   - è§¦å‘Full GC

4. CMSå¹¶å‘å¤±è´¥
   - å¹¶å‘æ¨¡å¼å¤±è´¥
   - é™çº§ä¸ºSerial Old
```

#### è§£å†³æ–¹æ¡ˆ

```bash
# 1. å¢å¤§è€å¹´ä»£
java -Xmx4g -jar app.jar

# 2. å¢å¤§Metaspace
java -XX:MetaspaceSize=256m -XX:MaxMetaspaceSize=512m -jar app.jar

# 3. ç¦ç”¨æ˜¾å¼GC
java -XX:+DisableExplicitGC -jar app.jar

# 4. CMSè°ƒä¼˜
java -XX:+UseConcMarkSweepGC \
     -XX:CMSInitiatingOccupancyFraction=70 \
     -XX:+UseCMSInitiatingOccupancyOnly \
     -jar app.jar

# 5. ä½¿ç”¨G1
java -XX:+UseG1GC -XX:MaxGCPauseMillis=200 -jar app.jar
```

### 3.3 GCåœé¡¿æ—¶é—´é•¿

#### é—®é¢˜è¡¨ç°

```
GCæ—¥å¿—ï¼š
[GC (Allocation Failure) ... 0.5678 secs]  # åœé¡¿æ—¶é—´è¿‡é•¿
åº”ç”¨å“åº”ç¼“æ…¢ï¼Œç”¨æˆ·ä½“éªŒå·®
```

#### åŸå› åˆ†æ

```
1. å †å¤ªå¤§
   - æ‰«æå¯¹è±¡å¤š
   - GCè€—æ—¶é•¿

2. å­˜æ´»å¯¹è±¡å¤š
   - å¤åˆ¶/æ•´ç†å¯¹è±¡è€—æ—¶
   - GCæ—¶é—´é•¿

3. ä½¿ç”¨äº†ä¸åˆé€‚çš„æ”¶é›†å™¨
   - Serialæ”¶é›†å™¨å•çº¿ç¨‹
   - åœé¡¿æ—¶é—´é•¿
```

#### è§£å†³æ–¹æ¡ˆ

```bash
# 1. ä½¿ç”¨ä½å»¶è¿Ÿæ”¶é›†å™¨
java -XX:+UseG1GC -XX:MaxGCPauseMillis=100 -jar app.jar

# 2. ä½¿ç”¨ZGCï¼ˆJDK 11+ï¼‰
java -XX:+UseZGC -jar app.jar

# 3. å¢åŠ GCçº¿ç¨‹æ•°
java -XX:ParallelGCThreads=8 -jar app.jar

# 4. ä¼˜åŒ–å¯¹è±¡ç”Ÿå‘½å‘¨æœŸ
# - å‡å°‘é•¿ç”Ÿå‘½å‘¨æœŸå¯¹è±¡
# - åŠæ—¶é‡Šæ”¾å¼•ç”¨
```

### 3.4 å†…å­˜æ³„æ¼

#### é—®é¢˜è¡¨ç°

```
ç°è±¡ï¼š
- è€å¹´ä»£æŒç»­å¢é•¿
- Full GCåå†…å­˜ä¸ä¸‹é™
- æœ€ç»ˆOOM

GCæ—¥å¿—ï¼š
[Full GC ... 512M->510M(512M), 1.2345 secs]  # å›æ”¶æ•ˆæœå·®
[Full GC ... 512M->511M(512M), 1.3456 secs]
[Full GC (Allocation Failure) ... 512M->512M(512M), 1.4567 secs]
java.lang.OutOfMemoryError: Java heap space
```

#### åŸå› åˆ†æ

```
1. é™æ€é›†åˆæŒæœ‰å¯¹è±¡
   private static List<Object> cache = new ArrayList<>();

2. ç›‘å¬å™¨æœªæ³¨é”€
   eventBus.register(listener);  // å¿˜è®°unregister

3. ThreadLocalæœªæ¸…ç†
   threadLocal.set(value);  // å¿˜è®°remove

4. èµ„æºæœªå…³é—­
   Connection conn = getConnection();  // å¿˜è®°close
```

#### è§£å†³æ–¹æ¡ˆ

```java
// 1. åŠæ—¶æ¸…ç†é›†åˆ
public class CacheManager {
    private static Map<String, Object> cache = new WeakHashMap<>();  // ä½¿ç”¨WeakHashMap
    
    public void clear() {
        cache.clear();
    }
}

// 2. æ³¨é”€ç›‘å¬å™¨
public class Service {
    public void destroy() {
        eventBus.unregister(listener);
    }
}

// 3. æ¸…ç†ThreadLocal
public class ThreadLocalDemo {
    private static ThreadLocal<Object> threadLocal = new ThreadLocal<>();
    
    public void execute() {
        try {
            threadLocal.set(new Object());
            // ä½¿ç”¨
        } finally {
            threadLocal.remove();  // ç¡®ä¿æ¸…ç†
        }
    }
}

// 4. ä½¿ç”¨try-with-resources
public void query() {
    try (Connection conn = getConnection();
         Statement stmt = conn.createStatement()) {
        // ä½¿ç”¨
    }  // è‡ªåŠ¨å…³é—­
}
```

### 3.5 å¯¹è±¡è¿‡æ—©æ™‹å‡

#### é—®é¢˜è¡¨ç°

```
ç°è±¡ï¼š
- å¹´è½»å¯¹è±¡è¿›å…¥è€å¹´ä»£
- è€å¹´ä»£å¿«é€Ÿå¢é•¿
- é¢‘ç¹Full GC

GCæ—¥å¿—ï¼š
Desired survivor size 524288 bytes, new threshold 1 (max 15)
- age   1:     524288 bytes,     524288 total
å¯¹è±¡age=1å°±æ™‹å‡åˆ°è€å¹´ä»£
```

#### åŸå› åˆ†æ

```
1. SurvivoråŒºå¤ªå°
   - å­˜æ´»å¯¹è±¡æ”¾ä¸ä¸‹
   - ç›´æ¥æ™‹å‡åˆ°è€å¹´ä»£

2. åŠ¨æ€å¹´é¾„åˆ¤å®š
   - ç›¸åŒå¹´é¾„å¯¹è±¡æ€»å’Œ > Survivorä¸€åŠ
   - æå‰æ™‹å‡

3. æ™‹å‡é˜ˆå€¼å¤ªå°
   - MaxTenuringThresholdè®¾ç½®å¤ªå°
   - å¯¹è±¡è¿‡æ—©æ™‹å‡
```

#### è§£å†³æ–¹æ¡ˆ

```bash
# 1. å¢å¤§SurvivoråŒº
java -XX:SurvivorRatio=6 -jar app.jar  # Eden:Survivor = 6:1

# 2. æé«˜æ™‹å‡é˜ˆå€¼
java -XX:MaxTenuringThreshold=15 -jar app.jar

# 3. å¢å¤§æ–°ç”Ÿä»£
java -Xmn2g -jar app.jar
```

---

## å››ã€è°ƒä¼˜å®æˆ˜æ¡ˆä¾‹

### æ¡ˆä¾‹1ï¼šç”µå•†ç³»ç»ŸGCè°ƒä¼˜

#### é—®é¢˜æè¿°

```
ç³»ç»Ÿï¼šç”µå•†è®¢å•ç³»ç»Ÿ
é…ç½®ï¼š8æ ¸16Gï¼ŒJDK 8
å †é…ç½®ï¼š-Xms4g -Xmx4g -XX:+UseParallelGC
é—®é¢˜ï¼šé«˜å³°æœŸå“åº”æ…¢ï¼Œé¢‘ç¹Full GC
```

#### åˆ†æè¿‡ç¨‹

```
1. æŸ¥çœ‹GCæ—¥å¿—
   - Minor GCé¢‘ç‡ï¼šæ¯ç§’2-3æ¬¡
   - Full GCé¢‘ç‡ï¼šæ¯åˆ†é’Ÿ1æ¬¡
   - Full GCè€—æ—¶ï¼š1-2ç§’

2. åˆ†æå †å†…å­˜
   - æ–°ç”Ÿä»£ï¼š1.3G
   - è€å¹´ä»£ï¼š2.7G
   - è€å¹´ä»£ä½¿ç”¨ç‡ï¼š90%ä»¥ä¸Š

3. åˆ†æå¯¹è±¡åˆ†é…
   - å¤§é‡è®¢å•å¯¹è±¡åˆ›å»º
   - è®¢å•å¯¹è±¡ç”Ÿå‘½å‘¨æœŸçŸ­
   - ä½†éƒ¨åˆ†è®¢å•éœ€è¦ç¼“å­˜
```

#### è°ƒä¼˜æ–¹æ¡ˆ

```bash
# è°ƒä¼˜å‰
java -Xms4g -Xmx4g -XX:+UseParallelGC -jar app.jar

# è°ƒä¼˜å
java -Xms4g -Xmx4g \
     -XX:+UseG1GC \
     -XX:MaxGCPauseMillis=200 \
     -XX:G1HeapRegionSize=16m \
     -XX:InitiatingHeapOccupancyPercent=45 \
     -XX:+ParallelRefProcEnabled \
     -jar app.jar

# è°ƒä¼˜ç†ç”±ï¼š
# 1. ä½¿ç”¨G1æ›¿ä»£Parallelï¼Œé™ä½åœé¡¿æ—¶é—´
# 2. è®¾ç½®åœé¡¿æ—¶é—´ç›®æ ‡200ms
# 3. è®¾ç½®Regionå¤§å°16MBï¼Œé€‚åˆè®¢å•å¯¹è±¡
# 4. é™ä½è§¦å‘é˜ˆå€¼ï¼Œæå‰è¿›è¡ŒGC
# 5. å¹¶è¡Œå¤„ç†å¼•ç”¨ï¼Œæé«˜æ•ˆç‡
```

#### è°ƒä¼˜æ•ˆæœ

```
è°ƒä¼˜å‰ï¼š
- Minor GC: 2-3æ¬¡/ç§’ï¼Œæ¯æ¬¡10-20ms
- Full GC: 1æ¬¡/åˆ†é’Ÿï¼Œæ¯æ¬¡1-2ç§’
- å¹³å‡å“åº”æ—¶é—´ï¼š500ms
- P99å“åº”æ—¶é—´ï¼š3000ms

è°ƒä¼˜åï¼š
- Young GC: 1æ¬¡/ç§’ï¼Œæ¯æ¬¡20-30ms
- Mixed GC: 1æ¬¡/10ç§’ï¼Œæ¯æ¬¡50-100ms
- Full GC: å‡ ä¹æ²¡æœ‰
- å¹³å‡å“åº”æ—¶é—´ï¼š100ms
- P99å“åº”æ—¶é—´ï¼š500ms

æ”¹å–„ï¼š
- å“åº”æ—¶é—´é™ä½80%
- æ¶ˆé™¤äº†é•¿æ—¶é—´åœé¡¿
- ç³»ç»Ÿç¨³å®šæ€§æå‡
```

### æ¡ˆä¾‹2ï¼šå¤§æ•°æ®å¤„ç†ç³»ç»Ÿè°ƒä¼˜

#### é—®é¢˜æè¿°

```
ç³»ç»Ÿï¼šæ—¥å¿—åˆ†æç³»ç»Ÿ
é…ç½®ï¼š16æ ¸32Gï¼ŒJDK 11
å †é…ç½®ï¼š-Xms16g -Xmx16g -XX:+UseG1GC
é—®é¢˜ï¼šå¤„ç†å¤§æ–‡ä»¶æ—¶é¢‘ç¹Full GCï¼ŒOOM
```

#### åˆ†æè¿‡ç¨‹

```
1. æŸ¥çœ‹GCæ—¥å¿—
   - G1 Evacuation Pauseé¢‘ç¹
   - To-space exhausted
   - é™çº§ä¸ºFull GC

2. åˆ†æå†…å­˜ä½¿ç”¨
   - å¤§é‡å¤§å¯¹è±¡ï¼ˆæ—¥å¿—è¡Œï¼‰
   - ç›´æ¥è¿›å…¥è€å¹´ä»£
   - è€å¹´ä»£å¿«é€Ÿå¡«æ»¡

3. åˆ†æä¸šåŠ¡é€»è¾‘
   - ä¸€æ¬¡æ€§è¯»å–æ•´ä¸ªæ–‡ä»¶åˆ°å†…å­˜
   - åˆ›å»ºå¤§é‡Stringå¯¹è±¡
   - æ²¡æœ‰åŠæ—¶é‡Šæ”¾
```

#### è°ƒä¼˜æ–¹æ¡ˆ

```bash
# 1. JVMå‚æ•°è°ƒä¼˜
java -Xms16g -Xmx16g \
     -XX:+UseG1GC \
     -XX:MaxGCPauseMillis=100 \
     -XX:G1HeapRegionSize=32m \
     -XX:G1ReservePercent=15 \
     -XX:InitiatingHeapOccupancyPercent=40 \
     -XX:ConcGCThreads=4 \
     -XX:+ParallelRefProcEnabled \
     -jar app.jar

# 2. ä»£ç ä¼˜åŒ–
# æ”¹ä¸ºæµå¼å¤„ç†ï¼Œä¸ä¸€æ¬¡æ€§åŠ è½½æ•´ä¸ªæ–‡ä»¶
```

```java
// ä¼˜åŒ–å‰
public void processFile(String filePath) {
    List<String> lines = Files.readAllLines(Paths.get(filePath));  // ä¸€æ¬¡æ€§è¯»å–
    for (String line : lines) {
        process(line);
    }
}

// ä¼˜åŒ–å
public void processFile(String filePath) {
    try (Stream<String> lines = Files.lines(Paths.get(filePath))) {
        lines.forEach(this::process);  // æµå¼å¤„ç†
    }
}
```

#### è°ƒä¼˜æ•ˆæœ

```
è°ƒä¼˜å‰ï¼š
- å¤„ç†1GBæ–‡ä»¶ï¼š5åˆ†é’Ÿ
- Full GC: 10-20æ¬¡
- ç»å¸¸OOM

è°ƒä¼˜åï¼š
- å¤„ç†1GBæ–‡ä»¶ï¼š2åˆ†é’Ÿ
- Full GC: 0æ¬¡
- æ— OOM
- å†…å­˜ä½¿ç”¨ç¨³å®š
```

---

## äº”ã€è°ƒä¼˜å·¥å…·

### 5.1 å‘½ä»¤è¡Œå·¥å…·

```bash
# 1. jps - æŸ¥çœ‹Javaè¿›ç¨‹
jps -lvm

# 2. jstat - æŸ¥çœ‹GCç»Ÿè®¡
jstat -gc <pid> 1000 10  # æ¯ç§’æ‰“å°ä¸€æ¬¡ï¼Œå…±10æ¬¡
jstat -gcutil <pid> 1000  # æ‰“å°ç™¾åˆ†æ¯”

# 3. jmap - æŸ¥çœ‹å †å†…å­˜
jmap -heap <pid>  # æŸ¥çœ‹å †é…ç½®å’Œä½¿ç”¨æƒ…å†µ
jmap -histo <pid> | head -20  # æŸ¥çœ‹å¯¹è±¡ç»Ÿè®¡
jmap -dump:format=b,file=heap.hprof <pid>  # ç”Ÿæˆå †è½¬å‚¨

# 4. jstack - æŸ¥çœ‹çº¿ç¨‹æ ˆ
jstack <pid> > thread.txt

# 5. jinfo - æŸ¥çœ‹JVMå‚æ•°
jinfo -flags <pid>
jinfo -flag UseG1GC <pid>
```

### 5.2 å¯è§†åŒ–å·¥å…·

```
1. JConsole
   - JDKè‡ªå¸¦
   - å®æ—¶ç›‘æ§JVM
   - æŸ¥çœ‹å†…å­˜ã€çº¿ç¨‹ã€ç±»

2. VisualVM
   - åŠŸèƒ½å¼ºå¤§
   - æ”¯æŒæ’ä»¶
   - æ€§èƒ½åˆ†æã€å†…å­˜åˆ†æ

3. JProfiler
   - å•†ä¸šå·¥å…·
   - åŠŸèƒ½æœ€å…¨
   - CPUã€å†…å­˜ã€çº¿ç¨‹åˆ†æ

4. Arthas
   - é˜¿é‡Œå¼€æº
   - åœ¨çº¿è¯Šæ–­
   - æ— éœ€é‡å¯

5. MATï¼ˆMemory Analyzer Toolï¼‰
   - Eclipseå‡ºå“
   - å †è½¬å‚¨åˆ†æ
   - æŸ¥æ‰¾å†…å­˜æ³„æ¼
```

### 5.3 ç›‘æ§å¹³å°

```
1. Prometheus + Grafana
   - å¼€æºç›‘æ§æ–¹æ¡ˆ
   - JMX Exporteré‡‡é›†JVMæŒ‡æ ‡
   - Grafanaå±•ç¤º

2. SkyWalking
   - APMå·¥å…·
   - åˆ†å¸ƒå¼è¿½è¸ª
   - JVMç›‘æ§

3. Pinpoint
   - APMå·¥å…·
   - å®æ—¶ç›‘æ§
   - æ€§èƒ½åˆ†æ

4. Cat
   - ç¾å›¢å¼€æº
   - å®æ—¶ç›‘æ§
   - è°ƒç”¨é“¾è¿½è¸ª
```

---

## å…­ã€è°ƒä¼˜æœ€ä½³å®è·µ

### 6.1 è°ƒä¼˜æµç¨‹

```
1. å»ºç«‹åŸºçº¿
   â”œâ”€ è®°å½•å½“å‰æ€§èƒ½æŒ‡æ ‡
   â”œâ”€ GCé¢‘ç‡ã€åœé¡¿æ—¶é—´
   â””â”€ ååé‡ã€å“åº”æ—¶é—´

2. ç›‘æ§åˆ†æ
   â”œâ”€ æ”¶é›†GCæ—¥å¿—
   â”œâ”€ åˆ†æGCæ¨¡å¼
   â””â”€ å®šä½æ€§èƒ½ç“¶é¢ˆ

3. åˆ¶å®šæ–¹æ¡ˆ
   â”œâ”€ é€‰æ‹©åˆé€‚çš„æ”¶é›†å™¨
   â”œâ”€ è°ƒæ•´å †å¤§å°
   â””â”€ ä¼˜åŒ–GCå‚æ•°

4. å®æ–½éªŒè¯
   â”œâ”€ åœ¨æµ‹è¯•ç¯å¢ƒéªŒè¯
   â”œâ”€ å‹åŠ›æµ‹è¯•
   â””â”€ å¯¹æ¯”æ€§èƒ½æŒ‡æ ‡

5. ä¸Šçº¿ç›‘æ§
   â”œâ”€ ç°åº¦å‘å¸ƒ
   â”œâ”€ æŒç»­ç›‘æ§
   â””â”€ åŠæ—¶è°ƒæ•´
```

### 6.2 å‚æ•°è°ƒä¼˜å»ºè®®

```bash
# åŸºç¡€é…ç½®
-Xms4g -Xmx4g  # å †å¤§å°ç›¸ç­‰ï¼Œé¿å…åŠ¨æ€æ‰©å±•
-Xmn2g  # æ–°ç”Ÿä»£å¤§å°ï¼ˆå †çš„1/3åˆ°1/2ï¼‰
-XX:MetaspaceSize=256m -XX:MaxMetaspaceSize=512m  # å…ƒç©ºé—´

# G1é…ç½®ï¼ˆæ¨èï¼‰
-XX:+UseG1GC
-XX:MaxGCPauseMillis=200  # åœé¡¿æ—¶é—´ç›®æ ‡
-XX:G1HeapRegionSize=16m  # Regionå¤§å°
-XX:InitiatingHeapOccupancyPercent=45  # è§¦å‘é˜ˆå€¼
-XX:G1ReservePercent=10  # é¢„ç•™ç©ºé—´
-XX:+ParallelRefProcEnabled  # å¹¶è¡Œå¤„ç†å¼•ç”¨

# GCæ—¥å¿—
-XX:+PrintGCDetails
-XX:+PrintGCDateStamps
-XX:+PrintGCTimeStamps
-Xloggc:gc-%t.log
-XX:+UseGCLogFileRotation
-XX:NumberOfGCLogFiles=5
-XX:GCLogFileSize=20M

# OOMæ—¶ç”Ÿæˆå †è½¬å‚¨
-XX:+HeapDumpOnOutOfMemoryError
-XX:HeapDumpPath=/path/to/dumps

# JMXç›‘æ§
-Dcom.sun.management.jmxremote
-Dcom.sun.management.jmxremote.port=9999
-Dcom.sun.management.jmxremote.authenticate=false
-Dcom.sun.management.jmxremote.ssl=false
```

### 6.3 ä»£ç ä¼˜åŒ–å»ºè®®

```java
// 1. å‡å°‘å¯¹è±¡åˆ›å»º
// ä¸å¥½
public String format(int value) {
    return new String("Value: " + value);  // åˆ›å»ºå¤šä¸ªå¯¹è±¡
}

// å¥½
public String format(int value) {
    return "Value: " + value;  // å­—ç¬¦ä¸²å¸¸é‡æ± 
}

// 2. ä½¿ç”¨å¯¹è±¡æ± 
public class ObjectPool<T> {
    private Queue<T> pool = new ConcurrentLinkedQueue<>();
    
    public T borrow() {
        T obj = pool.poll();
        return obj != null ? obj : create();
    }
    
    public void returnObject(T obj) {
        pool.offer(obj);
    }
}

// 3. åŠæ—¶é‡Šæ”¾å¼•ç”¨
public class Cache {
    private Map<String, Object> cache = new HashMap<>();
    
    public void clear() {
        cache.clear();  // åŠæ—¶æ¸…ç†
    }
}

// 4. ä½¿ç”¨åˆé€‚çš„é›†åˆå¤§å°
// ä¸å¥½
List<String> list = new ArrayList<>();  // é»˜è®¤å®¹é‡10

// å¥½
List<String> list = new ArrayList<>(1000);  // é¢„ä¼°å®¹é‡

// 5. é¿å…åœ¨å¾ªç¯ä¸­åˆ›å»ºå¯¹è±¡
// ä¸å¥½
for (int i = 0; i < 10000; i++) {
    String str = new String("test");  // æ¯æ¬¡åˆ›å»º
}

// å¥½
String str = "test";
for (int i = 0; i < 10000; i++) {
    // ä½¿ç”¨str
}
```

---

## ä¸ƒã€æ€»ç»“

### 7.1 è°ƒä¼˜æ£€æŸ¥æ¸…å•

```
â–¡ æ˜¯å¦å¼€å¯äº†GCæ—¥å¿—
â–¡ æ˜¯å¦é€‰æ‹©äº†åˆé€‚çš„æ”¶é›†å™¨
â–¡ å †å¤§å°æ˜¯å¦åˆç†
â–¡ æ–°ç”Ÿä»£/è€å¹´ä»£æ¯”ä¾‹æ˜¯å¦åˆç†
â–¡ æ˜¯å¦æœ‰é¢‘ç¹çš„Full GC
â–¡ GCåœé¡¿æ—¶é—´æ˜¯å¦å¯æ¥å—
â–¡ æ˜¯å¦æœ‰å†…å­˜æ³„æ¼
â–¡ æ˜¯å¦æœ‰å¯¹è±¡è¿‡æ—©æ™‹å‡
â–¡ ä»£ç æ˜¯å¦æœ‰ä¼˜åŒ–ç©ºé—´
â–¡ æ˜¯å¦æœ‰ç›‘æ§å‘Šè­¦
```

### 7.2 å…³é”®æŒ‡æ ‡

| æŒ‡æ ‡ | ç›®æ ‡å€¼ | è¯´æ˜ |
|------|--------|------|
| Minor GCé¢‘ç‡ | < 1æ¬¡/ç§’ | è¿‡é«˜è¯´æ˜æ–°ç”Ÿä»£å¤ªå° |
| Minor GCè€—æ—¶ | < 50ms | è¿‡é•¿å½±å“å“åº”æ—¶é—´ |
| Full GCé¢‘ç‡ | < 1æ¬¡/å°æ—¶ | è¿‡é«˜è¯´æ˜æœ‰é—®é¢˜ |
| Full GCè€—æ—¶ | < 1ç§’ | è¿‡é•¿ä¸¥é‡å½±å“æ€§èƒ½ |
| ååé‡ | > 95% | GCæ—¶é—´å æ¯” |
| å †å†…å­˜ä½¿ç”¨ç‡ | 60-80% | è¿‡é«˜å®¹æ˜“OOMï¼Œè¿‡ä½æµªè´¹ |

### 7.3 ç»éªŒæ€»ç»“

```
1. æ²¡æœ‰é“¶å¼¹
   - æ²¡æœ‰é€‚ç”¨æ‰€æœ‰åœºæ™¯çš„é…ç½®
   - éœ€è¦æ ¹æ®å®é™…æƒ…å†µè°ƒæ•´

2. ç›‘æ§å…ˆè¡Œ
   - å…ˆç›‘æ§ï¼Œå†è°ƒä¼˜
   - æ•°æ®é©±åŠ¨å†³ç­–

3. å°æ­¥å¿«è·‘
   - ä¸€æ¬¡åªè°ƒæ•´ä¸€ä¸ªå‚æ•°
   - è§‚å¯Ÿæ•ˆæœåå†ç»§ç»­

4. ä»£ç ä¼˜å…ˆ
   - ä¼˜å…ˆä¼˜åŒ–ä»£ç 
   - JVMå‚æ•°æ˜¯è¾…åŠ©æ‰‹æ®µ

5. æŒç»­ä¼˜åŒ–
   - æ€§èƒ½ä¼˜åŒ–æ˜¯æŒç»­çš„è¿‡ç¨‹
   - éœ€è¦å®šæœŸreviewå’Œè°ƒæ•´
```

---

## ğŸ“š å‚è€ƒèµ„æ–™

1. **ã€Šæ·±å…¥ç†è§£Javaè™šæ‹Ÿæœºï¼ˆç¬¬3ç‰ˆï¼‰ã€‹** - å‘¨å¿—æ˜
2. **ã€ŠJavaæ€§èƒ½æƒå¨æŒ‡å—ã€‹** - Scott Oaks
3. **Oracle GCè°ƒä¼˜æŒ‡å—** - https://docs.oracle.com/javase/8/docs/technotes/guides/vm/gctuning/
4. **GCEasy** - https://gceasy.io/

---

**ç›¸å…³æ–‡æ¡£**ï¼š
- [åƒåœ¾å›æ”¶åŸºç¡€ä¸ç®—æ³•](./01_åƒåœ¾å›æ”¶åŸºç¡€ä¸ç®—æ³•.md)
- [åˆ†ä»£åƒåœ¾å›æ”¶](./02_åˆ†ä»£åƒåœ¾å›æ”¶.md)
- [åƒåœ¾æ”¶é›†å™¨è¯¦è§£](./03_åƒåœ¾æ”¶é›†å™¨è¯¦è§£.md)
