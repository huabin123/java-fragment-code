# ç±»åŠ è½½æœºåˆ¶

## ğŸ“š æ¨¡å—ç®€ä»‹

æœ¬æ¨¡å—æ·±å…¥è®²è§£JVMç±»åŠ è½½æœºåˆ¶ï¼ŒåŒ…æ‹¬ç±»åŠ è½½è¿‡ç¨‹ã€ç±»åŠ è½½å™¨ã€åŒäº²å§”æ´¾æ¨¡å‹ã€å¦‚ä½•æ‰“ç ´åŒäº²å§”æ´¾ã€ç±»åŠ è½½å™¨éš”ç¦»å’Œçƒ­éƒ¨ç½²ç­‰æ ¸å¿ƒå†…å®¹ã€‚

## ğŸ¯ å­¦ä¹ ç›®æ ‡

- âœ… ç†è§£ç±»åŠ è½½çš„å®Œæ•´æµç¨‹
- âœ… æŒæ¡ç±»åŠ è½½å™¨çš„å±‚æ¬¡ç»“æ„
- âœ… ç†è§£åŒäº²å§”æ´¾æ¨¡å‹çš„åŸç†å’Œæ„ä¹‰
- âœ… æŒæ¡å¦‚ä½•æ‰“ç ´åŒäº²å§”æ´¾æ¨¡å‹
- âœ… èƒ½å¤Ÿå®ç°è‡ªå®šä¹‰ç±»åŠ è½½å™¨
- âœ… æŒæ¡ç±»åŠ è½½å™¨éš”ç¦»å’Œçƒ­éƒ¨ç½²æŠ€æœ¯

## ğŸ“‚ ç›®å½•ç»“æ„

```
classloader/
â”œâ”€â”€ docs/                                      # æ–‡æ¡£ç›®å½•
â”‚   â”œâ”€â”€ 01_ç±»åŠ è½½è¿‡ç¨‹è¯¦è§£.md                    # ç±»åŠ è½½çš„7ä¸ªé˜¶æ®µ
â”‚   â”œâ”€â”€ 02_ç±»åŠ è½½å™¨ä¸åŒäº²å§”æ´¾.md                # ç±»åŠ è½½å™¨å±‚æ¬¡å’ŒåŒäº²å§”æ´¾
â”‚   â”œâ”€â”€ 03_æ‰“ç ´åŒäº²å§”æ´¾æ¨¡å‹.md                  # æ‰“ç ´åŒäº²å§”æ´¾çš„æ–¹å¼
â”‚   â””â”€â”€ 04_ç±»åŠ è½½å™¨éš”ç¦»ä¸çƒ­éƒ¨ç½².md              # éš”ç¦»å’Œçƒ­éƒ¨ç½²å®ç°
â”œâ”€â”€ demo/                                      # æ¼”ç¤ºä»£ç 
â”‚   â”œâ”€â”€ ClassLoadingDemo.java                  # ç±»åŠ è½½è¿‡ç¨‹æ¼”ç¤º
â”‚   â”œâ”€â”€ CustomClassLoaderDemo.java             # è‡ªå®šä¹‰ç±»åŠ è½½å™¨æ¼”ç¤º
â”‚   â””â”€â”€ HotDeployDemo.java                     # çƒ­éƒ¨ç½²æ¼”ç¤º
â”œâ”€â”€ project/                                   # å®æˆ˜é¡¹ç›®
â”‚   â”œâ”€â”€ PluginFramework.java                   # æ’ä»¶æ¡†æ¶
â”‚   â””â”€â”€ HotSwapClassLoader.java                # çƒ­äº¤æ¢ç±»åŠ è½½å™¨
â””â”€â”€ README.md                                  # æœ¬æ–‡ä»¶
```

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. å­¦ä¹ ç±»åŠ è½½è¿‡ç¨‹

**é˜…è¯»æ–‡æ¡£**ï¼š`docs/01_ç±»åŠ è½½è¿‡ç¨‹è¯¦è§£.md`

**è¿è¡ŒDemo**ï¼š
```bash
cd demo
javac ClassLoadingDemo.java
java com.example.jvm.classloader.demo.ClassLoadingDemo
```

**å…³é”®é—®é¢˜**ï¼š
- â“ ç±»åŠ è½½çš„7ä¸ªé˜¶æ®µæ˜¯ä»€ä¹ˆï¼Ÿ
- â“ ä»€ä¹ˆæ—¶å€™ä¼šè§¦å‘ç±»åŠ è½½ï¼Ÿ
- â“ å‡†å¤‡é˜¶æ®µå’Œåˆå§‹åŒ–é˜¶æ®µçš„åŒºåˆ«ï¼Ÿ
- â“ ç±»åˆå§‹åŒ–çš„é¡ºåºæ˜¯ä»€ä¹ˆï¼Ÿ

### 2. å­¦ä¹ ç±»åŠ è½½å™¨ä¸åŒäº²å§”æ´¾

**é˜…è¯»æ–‡æ¡£**ï¼š`docs/02_ç±»åŠ è½½å™¨ä¸åŒäº²å§”æ´¾.md`

**è¿è¡ŒDemo**ï¼š
```bash
cd demo
javac CustomClassLoaderDemo.java
java com.example.jvm.classloader.demo.CustomClassLoaderDemo
```

**å…³é”®é—®é¢˜**ï¼š
- â“ æœ‰å“ªäº›ç±»å‹çš„ç±»åŠ è½½å™¨ï¼Ÿ
- â“ ä»€ä¹ˆæ˜¯åŒäº²å§”æ´¾æ¨¡å‹ï¼Ÿ
- â“ ä¸ºä»€ä¹ˆéœ€è¦åŒäº²å§”æ´¾æ¨¡å‹ï¼Ÿ
- â“ å¦‚ä½•å®ç°è‡ªå®šä¹‰ç±»åŠ è½½å™¨ï¼Ÿ

### 3. å­¦ä¹ æ‰“ç ´åŒäº²å§”æ´¾

**é˜…è¯»æ–‡æ¡£**ï¼š`docs/03_æ‰“ç ´åŒäº²å§”æ´¾æ¨¡å‹.md`

**å…³é”®é—®é¢˜**ï¼š
- â“ ä¸ºä»€ä¹ˆè¦æ‰“ç ´åŒäº²å§”æ´¾ï¼Ÿ
- â“ æœ‰å“ªäº›æ‰“ç ´åŒäº²å§”æ´¾çš„æ–¹å¼ï¼Ÿ
- â“ Tomcatæ˜¯å¦‚ä½•å®ç°ç±»åŠ è½½çš„ï¼Ÿ
- â“ SPIæœºåˆ¶å¦‚ä½•å·¥ä½œï¼Ÿ

### 4. å­¦ä¹ ç±»åŠ è½½å™¨éš”ç¦»ä¸çƒ­éƒ¨ç½²

**é˜…è¯»æ–‡æ¡£**ï¼š`docs/04_ç±»åŠ è½½å™¨éš”ç¦»ä¸çƒ­éƒ¨ç½².md`

**è¿è¡ŒDemo**ï¼š
```bash
cd demo
javac HotDeployDemo.java
java com.example.jvm.classloader.demo.HotDeployDemo
```

**å…³é”®é—®é¢˜**ï¼š
- â“ ä»€ä¹ˆæ˜¯ç±»åŠ è½½å™¨éš”ç¦»ï¼Ÿ
- â“ å¦‚ä½•å®ç°çƒ­éƒ¨ç½²ï¼Ÿ
- â“ çƒ­éƒ¨ç½²æœ‰å“ªäº›é™åˆ¶ï¼Ÿ
- â“ å¦‚ä½•é¿å…ç±»åŠ è½½å™¨å†…å­˜æ³„æ¼ï¼Ÿ

### 5. å®æˆ˜ï¼šæ’ä»¶æ¡†æ¶

**è¿è¡Œé¡¹ç›®**ï¼š
```bash
cd project
javac PluginFramework.java
java com.example.jvm.classloader.project.PluginFramework
```

**åŠŸèƒ½**ï¼š
- æ’ä»¶åŠ è½½å’Œå¸è½½
- æ’ä»¶éš”ç¦»
- æ’ä»¶çƒ­éƒ¨ç½²
- æ’ä»¶ç”Ÿå‘½å‘¨æœŸç®¡ç†
- æ’ä»¶ä¾èµ–ç®¡ç†

### 6. å®æˆ˜ï¼šçƒ­äº¤æ¢ç±»åŠ è½½å™¨

**è¿è¡Œé¡¹ç›®**ï¼š
```bash
cd project
javac HotSwapClassLoader.java
java com.example.jvm.classloader.project.HotSwapClassLoader
```

**åŠŸèƒ½**ï¼š
- ç±»æ–‡ä»¶çƒ­æ›¿æ¢
- æ–‡ä»¶ç›‘æ§
- ç‰ˆæœ¬ç®¡ç†
- å†…å­˜æ³„æ¼æ£€æµ‹
- å›æ»šæ”¯æŒ

## ğŸ“Š æ ¸å¿ƒçŸ¥è¯†ç‚¹

### 1. ç±»åŠ è½½è¿‡ç¨‹

```
åŠ è½½ â†’ éªŒè¯ â†’ å‡†å¤‡ â†’ è§£æ â†’ åˆå§‹åŒ– â†’ ä½¿ç”¨ â†’ å¸è½½
      â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
           è¿æ¥
```

| é˜¶æ®µ | ä¸»è¦å·¥ä½œ | å…³é”®ç‚¹ |
|------|---------|--------|
| **åŠ è½½** | è·å–å­—èŠ‚æµã€è½¬æ¢ä¸ºè¿è¡Œæ—¶æ•°æ®ã€ç”ŸæˆClasså¯¹è±¡ | å¯è‡ªå®šä¹‰ |
| **éªŒè¯** | æ–‡ä»¶æ ¼å¼ã€å…ƒæ•°æ®ã€å­—èŠ‚ç ã€ç¬¦å·å¼•ç”¨éªŒè¯ | ä¿è¯å®‰å…¨ |
| **å‡†å¤‡** | åˆ†é…å†…å­˜ã€è®¾ç½®é›¶å€¼ | ç±»å˜é‡ |
| **è§£æ** | ç¬¦å·å¼•ç”¨â†’ç›´æ¥å¼•ç”¨ | å¯é€‰ |
| **åˆå§‹åŒ–** | æ‰§è¡Œ`<clinit>()` | çº¿ç¨‹å®‰å…¨ |

### 2. ç±»åŠ è½½å™¨å±‚æ¬¡

```
Bootstrap ClassLoaderï¼ˆC++å®ç°ï¼‰
        â†“
Extension ClassLoader
        â†“
Application ClassLoader
        â†“
Custom ClassLoader
```

### 3. åŒäº²å§”æ´¾æ¨¡å‹

```
å·¥ä½œæµç¨‹ï¼š
1. æ£€æŸ¥æ˜¯å¦å·²åŠ è½½
2. å§”æ´¾ç»™çˆ¶åŠ è½½å™¨
3. çˆ¶åŠ è½½å™¨æ— æ³•åŠ è½½
4. è‡ªå·±å°è¯•åŠ è½½
```

**ä¼˜åŠ¿**ï¼š
- é¿å…ç±»çš„é‡å¤åŠ è½½
- ä¿æŠ¤æ ¸å¿ƒç±»åº“
- ä¿è¯ç±»çš„å”¯ä¸€æ€§

### 4. æ‰“ç ´åŒäº²å§”æ´¾çš„æ–¹å¼

| æ–¹å¼ | å®ç° | åº”ç”¨åœºæ™¯ |
|------|------|---------|
| é‡å†™loadClass() | æ”¹å˜å§”æ´¾é€»è¾‘ | è‡ªå®šä¹‰åŠ è½½é¡ºåº |
| çº¿ç¨‹ä¸Šä¸‹æ–‡ç±»åŠ è½½å™¨ | å‘ä¸‹å§”æ´¾ | JDBCã€SPI |
| OSGi | ç½‘çŠ¶ç»“æ„ | æ¨¡å—åŒ–ç³»ç»Ÿ |

### 5. ç±»åŠ è½½å™¨éš”ç¦»

```
åº”ç”¨A              åº”ç”¨B
   â†“                  â†“
ClassLoader A    ClassLoader B
   â†“                  â†“
åŠ è½½Userç±»        åŠ è½½Userç±»
   â†“                  â†“
User@A           User@B
ï¼ˆä¸åŒçš„ç±»ï¼‰      ï¼ˆä¸åŒçš„ç±»ï¼‰
```

### 6. çƒ­éƒ¨ç½²åŸç†

```
1. æ£€æµ‹ç±»æ–‡ä»¶å˜åŒ–
   â†“
2. åˆ›å»ºæ–°çš„ç±»åŠ è½½å™¨
   â†“
3. ä½¿ç”¨æ–°ç±»åŠ è½½å™¨åŠ è½½ä¿®æ”¹åçš„ç±»
   â†“
4. æ›¿æ¢æ—§çš„ç±»å®ä¾‹
   â†“
5. æ¸…ç†æ—§çš„ç±»åŠ è½½å™¨
```

## ğŸ› ï¸ å·¥å…·ä½¿ç”¨

### 1. æŸ¥çœ‹ç±»åŠ è½½å™¨

```java
// è·å–ç±»çš„ç±»åŠ è½½å™¨
ClassLoader loader = MyClass.class.getClassLoader();
System.out.println("ç±»åŠ è½½å™¨: " + loader);

// è·å–çˆ¶åŠ è½½å™¨
ClassLoader parent = loader.getParent();
System.out.println("çˆ¶åŠ è½½å™¨: " + parent);
```

### 2. æŸ¥çœ‹ç±»åŠ è½½è·¯å¾„

```bash
# Bootstrap ClassPath
java -XX:+TraceClassPaths MyClass

# æˆ–è€…åœ¨ä»£ç ä¸­
System.out.println(System.getProperty("sun.boot.class.path"));
System.out.println(System.getProperty("java.ext.dirs"));
System.out.println(System.getProperty("java.class.path"));
```

### 3. è·Ÿè¸ªç±»åŠ è½½

```bash
# æ‰“å°ç±»åŠ è½½ä¿¡æ¯
java -verbose:class MyClass

# æˆ–è€…
java -XX:+TraceClassLoading MyClass
```

### 4. æŸ¥çœ‹å·²åŠ è½½çš„ç±»

```bash
# ä½¿ç”¨jmap
jmap -histo <pid> | grep ClassLoader

# ä½¿ç”¨jcmd
jcmd <pid> VM.class_hierarchy
```

## ğŸ’¡ æœ€ä½³å®è·µ

### 1. è‡ªå®šä¹‰ç±»åŠ è½½å™¨

```java
// âœ… æ¨èï¼šç»§æ‰¿ClassLoaderï¼Œé‡å†™findClass()
public class MyClassLoader extends ClassLoader {
    @Override
    protected Class<?> findClass(String name) throws ClassNotFoundException {
        // è‡ªå®šä¹‰åŠ è½½é€»è¾‘
        byte[] classData = loadClassData(name);
        return defineClass(name, classData, 0, classData.length);
    }
}

// âŒ ä¸æ¨èï¼šé‡å†™loadClass()ï¼ˆä¼šç ´ååŒäº²å§”æ´¾ï¼‰
public class BadClassLoader extends ClassLoader {
    @Override
    public Class<?> loadClass(String name) throws ClassNotFoundException {
        // ç ´åäº†åŒäº²å§”æ´¾æ¨¡å‹
    }
}
```

### 2. ç±»åŠ è½½å™¨éš”ç¦»

```java
// âœ… æ¨èï¼šæ˜ç¡®å®šä¹‰å…±äº«å’Œéš”ç¦»çš„è¾¹ç•Œ
public class IsolationExample {
    // å…±äº«çš„ç±»åŠ è½½å™¨ï¼ˆåŠ è½½å…¬å…±APIï¼‰
    private ClassLoader sharedLoader;
    
    // éš”ç¦»çš„ç±»åŠ è½½å™¨ï¼ˆåŠ è½½å…·ä½“å®ç°ï¼‰
    private Map<String, ClassLoader> isolatedLoaders;
}
```

### 3. çƒ­éƒ¨ç½²

```java
// âœ… æ¨èï¼šä½¿ç”¨ç‰ˆæœ¬å·ç®¡ç†ç±»åŠ è½½å™¨
public class HotDeployExample {
    private AtomicInteger version = new AtomicInteger(0);
    
    public ClassLoader reload() {
        int newVersion = version.incrementAndGet();
        ClassLoader newLoader = new HotDeployClassLoader("v" + newVersion);
        return newLoader;
    }
}
```

### 4. é¿å…å†…å­˜æ³„æ¼

```java
// âœ… æ¨èï¼šåŠæ—¶æ¸…ç†å¼•ç”¨
public void unload() {
    // æ¸…ç†å®ä¾‹
    instance = null;
    
    // æ¸…ç†ç±»åŠ è½½å™¨
    loader = null;
    
    // å»ºè®®GC
    System.gc();
}

// âœ… æ¨èï¼šä½¿ç”¨try-finallyæ¸…ç†ThreadLocal
public void execute() {
    try {
        threadLocal.set(value);
        // ä½¿ç”¨
    } finally {
        threadLocal.remove();
    }
}
```

## ğŸ“ å¸¸è§é—®é¢˜

### Q1: ç±»åŠ è½½å’Œç±»åˆå§‹åŒ–çš„åŒºåˆ«ï¼Ÿ

**A**: 
- **ç±»åŠ è½½**ï¼šåŒ…æ‹¬åŠ è½½ã€éªŒè¯ã€å‡†å¤‡ã€è§£æã€åˆå§‹åŒ–5ä¸ªé˜¶æ®µ
- **ç±»åˆå§‹åŒ–**ï¼šæ˜¯ç±»åŠ è½½çš„æœ€åä¸€ä¸ªé˜¶æ®µï¼Œæ‰§è¡Œ`<clinit>()`æ–¹æ³•

### Q2: ä»€ä¹ˆæ—¶å€™ä¼šè§¦å‘ç±»åˆå§‹åŒ–ï¼Ÿ

**A**: 6ç§æƒ…å†µ
1. ä½¿ç”¨newå…³é”®å­—åˆ›å»ºå¯¹è±¡
2. è®¿é—®æˆ–è®¾ç½®é™æ€å­—æ®µ
3. è°ƒç”¨é™æ€æ–¹æ³•
4. ä½¿ç”¨åå°„è°ƒç”¨
5. åˆå§‹åŒ–å­ç±»æ—¶
6. è™šæ‹Ÿæœºå¯åŠ¨æ—¶çš„ä¸»ç±»

### Q3: ä¸ºä»€ä¹ˆéœ€è¦åŒäº²å§”æ´¾æ¨¡å‹ï¼Ÿ

**A**:
1. é¿å…ç±»çš„é‡å¤åŠ è½½
2. ä¿æŠ¤æ ¸å¿ƒç±»åº“ä¸è¢«ç¯¡æ”¹
3. ä¿è¯ç±»çš„å”¯ä¸€æ€§

### Q4: å¦‚ä½•æ‰“ç ´åŒäº²å§”æ´¾æ¨¡å‹ï¼Ÿ

**A**:
1. é‡å†™`loadClass()`æ–¹æ³•
2. ä½¿ç”¨çº¿ç¨‹ä¸Šä¸‹æ–‡ç±»åŠ è½½å™¨
3. ä½¿ç”¨OSGiç­‰æ¨¡å—åŒ–æ¡†æ¶

### Q5: çƒ­éƒ¨ç½²æœ‰å“ªäº›é™åˆ¶ï¼Ÿ

**A**:
1. æ— æ³•ä¿®æ”¹ç±»çš„ç»“æ„ï¼ˆå­—æ®µã€æ–¹æ³•ç­¾åï¼‰
2. é™æ€å­—æ®µä¼šé‡æ–°åˆå§‹åŒ–
3. å·²åˆ›å»ºçš„å¯¹è±¡ä¸ä¼šæ›´æ–°
4. å¯èƒ½å¯¼è‡´å†…å­˜æ³„æ¼

### Q6: å¦‚ä½•é¿å…ç±»åŠ è½½å™¨å†…å­˜æ³„æ¼ï¼Ÿ

**A**:
1. åŠæ—¶æ¸…ç†ç±»åŠ è½½å™¨å¼•ç”¨
2. é¿å…é™æ€å­—æ®µæŒæœ‰ç±»å®ä¾‹
3. æ¸…ç†ThreadLocal
4. æ³¨é”€ç›‘å¬å™¨
5. åœæ­¢çº¿ç¨‹

## ğŸ“ è¿›é˜¶å­¦ä¹ 

### 1. Tomcatç±»åŠ è½½å™¨æ¶æ„

- Common ClassLoader
- Catalina ClassLoader
- Shared ClassLoader
- WebApp ClassLoader
- Jsp ClassLoader

### 2. OSGiæ¨¡å—åŒ–

- Bundleæ¦‚å¿µ
- ç½‘çŠ¶ç±»åŠ è½½å™¨ç»“æ„
- åŠ¨æ€æ¨¡å—ç®¡ç†

### 3. Java 9æ¨¡å—ç³»ç»Ÿ

- æ¨¡å—åŒ–JDK
- æ¨¡å—è·¯å¾„
- æ¨¡å—æè¿°ç¬¦

### 4. GraalVM

- æå‰ç¼–è¯‘ï¼ˆAOTï¼‰
- åŸç”Ÿé•œåƒ
- å¤šè¯­è¨€æ”¯æŒ

## ğŸ“š å‚è€ƒèµ„æ–™

1. **ã€Šæ·±å…¥ç†è§£Javaè™šæ‹Ÿæœºï¼ˆç¬¬3ç‰ˆï¼‰ã€‹** - å‘¨å¿—æ˜
2. **ã€ŠJavaè™šæ‹Ÿæœºè§„èŒƒã€‹** - https://docs.oracle.com/javase/specs/
3. **Tomcatæºç ** - https://github.com/apache/tomcat
4. **OSGiè§„èŒƒ** - https://www.osgi.org/

## ğŸ”— ç›¸å…³æ¨¡å—

- [JVMå†…å­˜æ¨¡å‹](../memory/README.md)
- [åƒåœ¾å›æ”¶](../gc/README.md)
- [æ€§èƒ½è°ƒä¼˜](../tuning/README.md)

---

**ä¸‹ä¸€æ­¥**ï¼šå­¦ä¹ [åƒåœ¾å›æ”¶æœºåˆ¶](../gc/README.md)
