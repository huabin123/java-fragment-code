# ç±»åŠ è½½å™¨éš”ç¦»ä¸çƒ­éƒ¨ç½²

## ğŸ“š æ¦‚è¿°

ç±»åŠ è½½å™¨éš”ç¦»å’Œçƒ­éƒ¨ç½²æ˜¯ä¼ä¸šçº§åº”ç”¨ä¸­çš„é‡è¦æŠ€æœ¯ã€‚æœ¬æ–‡æ·±å…¥è®²è§£å¦‚ä½•åˆ©ç”¨ç±»åŠ è½½å™¨å®ç°åº”ç”¨éš”ç¦»å’Œçƒ­éƒ¨ç½²ï¼Œä»¥åŠåœ¨å®é™…é¡¹ç›®ä¸­çš„åº”ç”¨ã€‚

## ğŸ¯ æ ¸å¿ƒé—®é¢˜

- â“ ä»€ä¹ˆæ˜¯ç±»åŠ è½½å™¨éš”ç¦»ï¼Ÿä¸ºä»€ä¹ˆéœ€è¦å®ƒï¼Ÿ
- â“ å¦‚ä½•å®ç°ç±»åŠ è½½å™¨éš”ç¦»ï¼Ÿ
- â“ ä»€ä¹ˆæ˜¯çƒ­éƒ¨ç½²ï¼Ÿå¦‚ä½•å®ç°ï¼Ÿ
- â“ çƒ­éƒ¨ç½²æœ‰å“ªäº›å®ç°æ–¹å¼ï¼Ÿ
- â“ å¦‚ä½•é¿å…ç±»åŠ è½½å™¨å†…å­˜æ³„æ¼ï¼Ÿ
- â“ å®é™…é¡¹ç›®ä¸­å¦‚ä½•åº”ç”¨ï¼Ÿ

---

## ä¸€ã€ç±»åŠ è½½å™¨éš”ç¦»

### 1.1 ä»€ä¹ˆæ˜¯ç±»åŠ è½½å™¨éš”ç¦»

ç±»åŠ è½½å™¨éš”ç¦»æ˜¯æŒ‡é€šè¿‡ä¸åŒçš„ç±»åŠ è½½å™¨åŠ è½½ç›¸åŒçš„ç±»ï¼Œä½¿å®ƒä»¬åœ¨JVMä¸­è¢«è§†ä¸ºä¸åŒçš„ç±»ï¼Œä»è€Œå®ç°éš”ç¦»ã€‚

```java
// ç±»çš„å”¯ä¸€æ€§ = ç±»çš„å…¨é™å®šå + ç±»åŠ è½½å™¨

ClassLoader loader1 = new CustomClassLoader();
ClassLoader loader2 = new CustomClassLoader();

Class<?> class1 = loader1.loadClass("com.example.User");
Class<?> class2 = loader2.loadClass("com.example.User");

// è™½ç„¶ç±»åç›¸åŒï¼Œä½†ç±»åŠ è½½å™¨ä¸åŒï¼Œæ‰€ä»¥æ˜¯ä¸åŒçš„ç±»
System.out.println(class1 == class2);  // false
```

### 1.2 ä¸ºä»€ä¹ˆéœ€è¦ç±»åŠ è½½å™¨éš”ç¦»

#### 1. å¤šç‰ˆæœ¬å…±å­˜

```java
// åœºæ™¯ï¼šåŒä¸€ä¸ªåº”ç”¨æœåŠ¡å™¨ä¸­è¿è¡Œå¤šä¸ªWebåº”ç”¨
// åº”ç”¨Aä½¿ç”¨Spring 4.x
// åº”ç”¨Bä½¿ç”¨Spring 5.x
// å¦‚æœä¸éš”ç¦»ï¼Œä¼šå‘ç”Ÿç‰ˆæœ¬å†²çª

// ä½¿ç”¨ä¸åŒçš„ç±»åŠ è½½å™¨éš”ç¦»
WebAppClassLoader loaderA = new WebAppClassLoader("appA");
WebAppClassLoader loaderB = new WebAppClassLoader("appB");

Class<?> springA = loaderA.loadClass("org.springframework.context.ApplicationContext");
Class<?> springB = loaderB.loadClass("org.springframework.context.ApplicationContext");

// ä¸¤ä¸ªç±»äº’ä¸å½±å“
System.out.println(springA == springB);  // false
```

#### 2. æ’ä»¶ç³»ç»Ÿ

```java
// åœºæ™¯ï¼šIDEä¸­çš„æ’ä»¶ç³»ç»Ÿ
// ä¸åŒæ’ä»¶å¯èƒ½ä½¿ç”¨ç›¸åŒç±»åº“çš„ä¸åŒç‰ˆæœ¬
// éœ€è¦éš”ç¦»é¿å…å†²çª

PluginClassLoader plugin1Loader = new PluginClassLoader("plugin1");
PluginClassLoader plugin2Loader = new PluginClassLoader("plugin2");
```

#### 3. æ¨¡å—åŒ–

```java
// åœºæ™¯ï¼šå¤§å‹åº”ç”¨çš„æ¨¡å—åŒ–
// ä¸åŒæ¨¡å—ç‹¬ç«‹å¼€å‘ã€ç‹¬ç«‹éƒ¨ç½²
// éœ€è¦éš”ç¦»é¿å…ç›¸äº’å½±å“

ModuleClassLoader module1Loader = new ModuleClassLoader("module1");
ModuleClassLoader module2Loader = new ModuleClassLoader("module2");
```

### 1.3 ç±»åŠ è½½å™¨éš”ç¦»çš„å®ç°

#### å®ç°åŸç†

```
åº”ç”¨A                åº”ç”¨B
   â†“                    â†“
ClassLoader A      ClassLoader B
   â†“                    â†“
åŠ è½½Userç±»          åŠ è½½Userç±»
   â†“                    â†“
User@A             User@B
ï¼ˆä¸åŒçš„ç±»ï¼‰        ï¼ˆä¸åŒçš„ç±»ï¼‰
```

#### ç¤ºä¾‹ï¼šå®ç°ç®€å•çš„éš”ç¦»

```java
public class IsolatedClassLoader extends ClassLoader {
    
    private String classPath;
    private String name;
    
    public IsolatedClassLoader(String name, String classPath) {
        this.name = name;
        this.classPath = classPath;
    }
    
    @Override
    protected Class<?> findClass(String className) throws ClassNotFoundException {
        try {
            byte[] classData = loadClassData(className);
            return defineClass(className, classData, 0, classData.length);
        } catch (IOException e) {
            throw new ClassNotFoundException(className, e);
        }
    }
    
    private byte[] loadClassData(String className) throws IOException {
        String fileName = classPath + "/" + className.replace('.', '/') + ".class";
        try (InputStream is = new FileInputStream(fileName);
             ByteArrayOutputStream baos = new ByteArrayOutputStream()) {
            
            byte[] buffer = new byte[1024];
            int len;
            while ((len = is.read(buffer)) != -1) {
                baos.write(buffer, 0, len);
            }
            return baos.toByteArray();
        }
    }
    
    @Override
    public String toString() {
        return "IsolatedClassLoader[" + name + "]";
    }
}

// ä½¿ç”¨ç¤ºä¾‹
public class IsolationDemo {
    public static void main(String[] args) throws Exception {
        // åˆ›å»ºä¸¤ä¸ªéš”ç¦»çš„ç±»åŠ è½½å™¨
        IsolatedClassLoader loader1 = new IsolatedClassLoader("App1", "/path/to/app1");
        IsolatedClassLoader loader2 = new IsolatedClassLoader("App2", "/path/to/app2");
        
        // åŠ è½½ç›¸åŒçš„ç±»
        Class<?> class1 = loader1.loadClass("com.example.Service");
        Class<?> class2 = loader2.loadClass("com.example.Service");
        
        // éªŒè¯éš”ç¦»
        System.out.println("ç±»1: " + class1);
        System.out.println("ç±»2: " + class2);
        System.out.println("æ˜¯å¦ç›¸åŒ: " + (class1 == class2));  // false
        
        // åˆ›å»ºå®ä¾‹
        Object obj1 = class1.newInstance();
        Object obj2 = class2.newInstance();
        
        // éªŒè¯ç±»å‹
        System.out.println("obj1çš„ç±»åŠ è½½å™¨: " + obj1.getClass().getClassLoader());
        System.out.println("obj2çš„ç±»åŠ è½½å™¨: " + obj2.getClass().getClassLoader());
        
        // instanceofåˆ¤æ–­
        System.out.println(class1.isInstance(obj1));  // true
        System.out.println(class1.isInstance(obj2));  // false
    }
}
```

### 1.4 å…±äº«ä¸éš”ç¦»çš„å¹³è¡¡

#### é—®é¢˜ï¼šå¦‚ä½•å®ç°éƒ¨åˆ†å…±äº«ã€éƒ¨åˆ†éš”ç¦»ï¼Ÿ

```java
public class SharedIsolatedClassLoader extends ClassLoader {
    
    private String classPath;
    private ClassLoader sharedLoader;  // å…±äº«çš„ç±»åŠ è½½å™¨
    
    public SharedIsolatedClassLoader(String classPath, ClassLoader sharedLoader) {
        this.classPath = classPath;
        this.sharedLoader = sharedLoader;
    }
    
    @Override
    protected Class<?> loadClass(String name, boolean resolve) 
        throws ClassNotFoundException {
        
        // 1. æ£€æŸ¥æ˜¯å¦å·²åŠ è½½
        Class<?> c = findLoadedClass(name);
        if (c != null) {
            return c;
        }
        
        // 2. æ ¸å¿ƒç±»å§”æ´¾ç»™çˆ¶åŠ è½½å™¨
        if (name.startsWith("java.") || name.startsWith("javax.")) {
            return super.loadClass(name, resolve);
        }
        
        // 3. å…±äº«çš„ç±»å§”æ´¾ç»™å…±äº«ç±»åŠ è½½å™¨
        if (isSharedClass(name)) {
            return sharedLoader.loadClass(name);
        }
        
        // 4. éš”ç¦»çš„ç±»è‡ªå·±åŠ è½½
        try {
            c = findClass(name);
            if (resolve) {
                resolveClass(c);
            }
            return c;
        } catch (ClassNotFoundException e) {
            // 5. æ‰¾ä¸åˆ°ï¼Œå§”æ´¾ç»™çˆ¶åŠ è½½å™¨
            return super.loadClass(name, resolve);
        }
    }
    
    private boolean isSharedClass(String name) {
        // å®šä¹‰å“ªäº›ç±»éœ€è¦å…±äº«
        return name.startsWith("com.example.common.") ||
               name.startsWith("com.example.api.");
    }
    
    @Override
    protected Class<?> findClass(String name) throws ClassNotFoundException {
        try {
            byte[] classData = loadClassData(name);
            return defineClass(name, classData, 0, classData.length);
        } catch (IOException e) {
            throw new ClassNotFoundException(name, e);
        }
    }
    
    private byte[] loadClassData(String name) throws IOException {
        String fileName = classPath + "/" + name.replace('.', '/') + ".class";
        try (InputStream is = new FileInputStream(fileName);
             ByteArrayOutputStream baos = new ByteArrayOutputStream()) {
            
            byte[] buffer = new byte[1024];
            int len;
            while ((len = is.read(buffer)) != -1) {
                baos.write(buffer, 0, len);
            }
            return baos.toByteArray();
        }
    }
}
```

---

## äºŒã€çƒ­éƒ¨ç½²

### 2.1 ä»€ä¹ˆæ˜¯çƒ­éƒ¨ç½²

çƒ­éƒ¨ç½²ï¼ˆHot Deploymentï¼‰æ˜¯æŒ‡åœ¨ä¸é‡å¯åº”ç”¨çš„æƒ…å†µä¸‹ï¼ŒåŠ¨æ€æ›¿æ¢æˆ–æ›´æ–°ç±»æ–‡ä»¶ï¼Œä½¿ä¿®æ”¹ç«‹å³ç”Ÿæ•ˆã€‚

```
ä¼ ç»Ÿéƒ¨ç½²ï¼š
ä¿®æ”¹ä»£ç  â†’ ç¼–è¯‘ â†’ åœæ­¢åº”ç”¨ â†’ éƒ¨ç½² â†’ å¯åŠ¨åº”ç”¨
ï¼ˆéœ€è¦åœæœºï¼Œå½±å“æœåŠ¡ï¼‰

çƒ­éƒ¨ç½²ï¼š
ä¿®æ”¹ä»£ç  â†’ ç¼–è¯‘ â†’ åŠ¨æ€åŠ è½½
ï¼ˆæ— éœ€åœæœºï¼Œä¸å½±å“æœåŠ¡ï¼‰
```

### 2.2 çƒ­éƒ¨ç½²çš„å®ç°åŸç†

#### æ ¸å¿ƒæ€æƒ³

```
1. æ£€æµ‹ç±»æ–‡ä»¶å˜åŒ–
   â†“
2. åˆ›å»ºæ–°çš„ç±»åŠ è½½å™¨
   â†“
3. ä½¿ç”¨æ–°ç±»åŠ è½½å™¨åŠ è½½ä¿®æ”¹åçš„ç±»
   â†“
4. æ›¿æ¢æ—§çš„ç±»å®ä¾‹
   â†“
5. æ¸…ç†æ—§çš„ç±»åŠ è½½å™¨
```

#### ä¸ºä»€ä¹ˆéœ€è¦æ–°çš„ç±»åŠ è½½å™¨ï¼Ÿ

```java
// é—®é¢˜ï¼šåŒä¸€ä¸ªç±»åŠ è½½å™¨ä¸èƒ½é‡å¤åŠ è½½åŒä¸€ä¸ªç±»
ClassLoader loader = new CustomClassLoader();
Class<?> class1 = loader.loadClass("com.example.Service");

// ä¿®æ”¹Service.classå
Class<?> class2 = loader.loadClass("com.example.Service");

// class1 == class2ï¼ˆè¿˜æ˜¯æ—§çš„ç±»ï¼‰

// è§£å†³æ–¹æ¡ˆï¼šåˆ›å»ºæ–°çš„ç±»åŠ è½½å™¨
ClassLoader newLoader = new CustomClassLoader();
Class<?> newClass = newLoader.loadClass("com.example.Service");

// newClassæ˜¯æ–°çš„ç±»
```

### 2.3 çƒ­éƒ¨ç½²çš„å®ç°æ–¹å¼

#### æ–¹å¼ä¸€ï¼šæ–‡ä»¶ç›‘æ§ + ç±»åŠ è½½å™¨æ›¿æ¢

```java
public class HotDeployClassLoader extends ClassLoader {
    
    private String classPath;
    
    public HotDeployClassLoader(String classPath) {
        this.classPath = classPath;
    }
    
    @Override
    protected Class<?> findClass(String name) throws ClassNotFoundException {
        try {
            byte[] classData = loadClassData(name);
            return defineClass(name, classData, 0, classData.length);
        } catch (IOException e) {
            throw new ClassNotFoundException(name, e);
        }
    }
    
    private byte[] loadClassData(String name) throws IOException {
        String fileName = classPath + "/" + name.replace('.', '/') + ".class";
        try (InputStream is = new FileInputStream(fileName);
             ByteArrayOutputStream baos = new ByteArrayOutputStream()) {
            
            byte[] buffer = new byte[1024];
            int len;
            while ((len = is.read(buffer)) != -1) {
                baos.write(buffer, 0, len);
            }
            return baos.toByteArray();
        }
    }
}

public class HotDeployManager {
    
    private String classPath;
    private String className;
    private Map<String, Long> fileTimestamps = new ConcurrentHashMap<>();
    private volatile HotDeployClassLoader loader;
    private volatile Object instance;
    
    public HotDeployManager(String classPath, String className) {
        this.classPath = classPath;
        this.className = className;
        reload();
        startMonitor();
    }
    
    private void reload() {
        try {
            // åˆ›å»ºæ–°çš„ç±»åŠ è½½å™¨
            loader = new HotDeployClassLoader(classPath);
            
            // åŠ è½½ç±»
            Class<?> clazz = loader.loadClass(className);
            
            // åˆ›å»ºå®ä¾‹
            instance = clazz.newInstance();
            
            // æ›´æ–°æ–‡ä»¶æ—¶é—´æˆ³
            updateTimestamp(className);
            
            System.out.println("[" + new Date() + "] ç±» " + className + " é‡æ–°åŠ è½½æˆåŠŸ");
        } catch (Exception e) {
            System.err.println("é‡æ–°åŠ è½½å¤±è´¥: " + e.getMessage());
            e.printStackTrace();
        }
    }
    
    private void updateTimestamp(String className) {
        String fileName = classPath + "/" + className.replace('.', '/') + ".class";
        File file = new File(fileName);
        if (file.exists()) {
            fileTimestamps.put(className, file.lastModified());
        }
    }
    
    private boolean isModified(String className) {
        String fileName = classPath + "/" + className.replace('.', '/') + ".class";
        File file = new File(fileName);
        if (!file.exists()) {
            return false;
        }
        
        Long lastModified = fileTimestamps.get(className);
        return lastModified == null || file.lastModified() > lastModified;
    }
    
    private void startMonitor() {
        Thread monitorThread = new Thread(() -> {
            while (true) {
                try {
                    Thread.sleep(2000);  // æ¯2ç§’æ£€æŸ¥ä¸€æ¬¡
                    
                    if (isModified(className)) {
                        System.out.println("æ£€æµ‹åˆ°ç±»æ–‡ä»¶å˜åŒ–ï¼Œå‡†å¤‡é‡æ–°åŠ è½½...");
                        reload();
                    }
                } catch (InterruptedException e) {
                    break;
                }
            }
        });
        monitorThread.setDaemon(true);
        monitorThread.start();
    }
    
    public Object invoke(String methodName, Object... args) throws Exception {
        Class<?> clazz = instance.getClass();
        
        // æŸ¥æ‰¾æ–¹æ³•
        Method method = null;
        for (Method m : clazz.getMethods()) {
            if (m.getName().equals(methodName) && m.getParameterCount() == args.length) {
                method = m;
                break;
            }
        }
        
        if (method == null) {
            throw new NoSuchMethodException(methodName);
        }
        
        return method.invoke(instance, args);
    }
    
    public static void main(String[] args) throws Exception {
        HotDeployManager manager = new HotDeployManager(
            "/path/to/classes",
            "com.example.Service"
        );
        
        // æŒç»­è°ƒç”¨æ–¹æ³•ï¼Œè§‚å¯Ÿçƒ­éƒ¨ç½²æ•ˆæœ
        while (true) {
            try {
                Object result = manager.invoke("execute");
                System.out.println("æ‰§è¡Œç»“æœ: " + result);
            } catch (Exception e) {
                System.err.println("æ‰§è¡Œå¤±è´¥: " + e.getMessage());
            }
            
            Thread.sleep(5000);
        }
    }
}
```

#### æ–¹å¼äºŒï¼šä½¿ç”¨WatchServiceç›‘æ§æ–‡ä»¶å˜åŒ–

```java
public class FileWatcherHotDeploy {
    
    private String classPath;
    private String className;
    private volatile HotDeployClassLoader loader;
    private volatile Object instance;
    
    public FileWatcherHotDeploy(String classPath, String className) {
        this.classPath = classPath;
        this.className = className;
        reload();
        startWatcher();
    }
    
    private void reload() {
        try {
            loader = new HotDeployClassLoader(classPath);
            Class<?> clazz = loader.loadClass(className);
            instance = clazz.newInstance();
            System.out.println("[" + new Date() + "] ç±»é‡æ–°åŠ è½½æˆåŠŸ");
        } catch (Exception e) {
            e.printStackTrace();
        }
    }
    
    private void startWatcher() {
        Thread watcherThread = new Thread(() -> {
            try {
                WatchService watchService = FileSystems.getDefault().newWatchService();
                Path path = Paths.get(classPath);
                
                // æ³¨å†Œç›‘å¬
                path.register(watchService, 
                    StandardWatchEventKinds.ENTRY_MODIFY,
                    StandardWatchEventKinds.ENTRY_CREATE);
                
                System.out.println("å¼€å§‹ç›‘æ§ç›®å½•: " + path);
                
                while (true) {
                    WatchKey key = watchService.take();
                    
                    for (WatchEvent<?> event : key.pollEvents()) {
                        WatchEvent.Kind<?> kind = event.kind();
                        
                        if (kind == StandardWatchEventKinds.OVERFLOW) {
                            continue;
                        }
                        
                        WatchEvent<Path> ev = (WatchEvent<Path>) event;
                        Path filename = ev.context();
                        
                        // æ£€æŸ¥æ˜¯å¦æ˜¯æˆ‘ä»¬å…³æ³¨çš„ç±»æ–‡ä»¶
                        String changedFile = filename.toString();
                        String expectedFile = className.replace('.', '/') + ".class";
                        
                        if (changedFile.endsWith(expectedFile)) {
                            System.out.println("æ£€æµ‹åˆ°æ–‡ä»¶å˜åŒ–: " + changedFile);
                            
                            // ç­‰å¾…æ–‡ä»¶å†™å…¥å®Œæˆ
                            Thread.sleep(100);
                            
                            reload();
                        }
                    }
                    
                    boolean valid = key.reset();
                    if (!valid) {
                        break;
                    }
                }
            } catch (Exception e) {
                e.printStackTrace();
            }
        });
        watcherThread.setDaemon(true);
        watcherThread.start();
    }
    
    public Object invoke(String methodName, Object... args) throws Exception {
        Class<?> clazz = instance.getClass();
        Method method = clazz.getMethod(methodName);
        return method.invoke(instance, args);
    }
}
```

### 2.4 çƒ­éƒ¨ç½²çš„é™åˆ¶

#### 1. æ— æ³•ä¿®æ”¹ç±»çš„ç»“æ„

```java
// âœ… å¯ä»¥çƒ­éƒ¨ç½²ï¼šä¿®æ”¹æ–¹æ³•å®ç°
public class Service {
    public String execute() {
        return "Version 1";  // æ”¹ä¸º "Version 2"
    }
}

// âŒ æ— æ³•çƒ­éƒ¨ç½²ï¼šæ·»åŠ å­—æ®µ
public class Service {
    private String newField;  // æ–°å¢å­—æ®µ
    
    public String execute() {
        return "Version 1";
    }
}

// âŒ æ— æ³•çƒ­éƒ¨ç½²ï¼šä¿®æ”¹æ–¹æ³•ç­¾å
public class Service {
    public String execute(int param) {  // ä¿®æ”¹äº†å‚æ•°
        return "Version 1";
    }
}
```

#### 2. é™æ€å­—æ®µå’Œé™æ€ä»£ç å—çš„é—®é¢˜

```java
public class Service {
    // é™æ€å­—æ®µåªä¼šåˆå§‹åŒ–ä¸€æ¬¡
    private static int counter = 0;
    
    static {
        // é™æ€ä»£ç å—åªä¼šæ‰§è¡Œä¸€æ¬¡
        System.out.println("ç±»åˆå§‹åŒ–");
    }
    
    public void execute() {
        counter++;
        System.out.println("Counter: " + counter);
    }
}

// çƒ­éƒ¨ç½²åï¼Œcounterä¸ä¼šé‡ç½®
// å› ä¸ºæ¯æ¬¡éƒ½æ˜¯æ–°çš„ç±»ï¼Œæ–°çš„é™æ€å­—æ®µ
```

#### 3. å·²åˆ›å»ºçš„å¯¹è±¡ä¸ä¼šæ›´æ–°

```java
// çƒ­éƒ¨ç½²å‰åˆ›å»ºçš„å¯¹è±¡
Service oldService = new Service();

// çƒ­éƒ¨ç½²å
// oldServiceä»ç„¶æ˜¯æ—§ç‰ˆæœ¬çš„å®ä¾‹
// åªæœ‰æ–°åˆ›å»ºçš„å¯¹è±¡æ‰æ˜¯æ–°ç‰ˆæœ¬
Service newService = new Service();
```

### 2.5 å®Œæ•´çš„çƒ­éƒ¨ç½²ç¤ºä¾‹

```java
public class CompleteHotDeployDemo {
    
    public static void main(String[] args) throws Exception {
        String classPath = "/path/to/classes";
        String className = "com.example.Service";
        
        // åˆ›å»ºçƒ­éƒ¨ç½²ç®¡ç†å™¨
        HotDeployManager manager = new HotDeployManager(classPath, className);
        
        // æ¨¡æ‹ŸWebæœåŠ¡å™¨
        ServerSocket serverSocket = new ServerSocket(8080);
        System.out.println("æœåŠ¡å™¨å¯åŠ¨ï¼Œç›‘å¬ç«¯å£8080");
        
        while (true) {
            Socket socket = serverSocket.accept();
            
            // å¤„ç†è¯·æ±‚
            new Thread(() -> {
                try {
                    BufferedReader reader = new BufferedReader(
                        new InputStreamReader(socket.getInputStream())
                    );
                    PrintWriter writer = new PrintWriter(socket.getOutputStream());
                    
                    // è¯»å–è¯·æ±‚
                    String request = reader.readLine();
                    System.out.println("æ”¶åˆ°è¯·æ±‚: " + request);
                    
                    // è°ƒç”¨æœåŠ¡ï¼ˆä½¿ç”¨æœ€æ–°ç‰ˆæœ¬çš„ç±»ï¼‰
                    Object result = manager.invoke("execute");
                    
                    // è¿”å›å“åº”
                    writer.println("HTTP/1.1 200 OK");
                    writer.println("Content-Type: text/plain");
                    writer.println();
                    writer.println("Result: " + result);
                    writer.flush();
                    
                    socket.close();
                } catch (Exception e) {
                    e.printStackTrace();
                }
            }).start();
        }
    }
}
```

---

## ä¸‰ã€ç±»åŠ è½½å™¨å†…å­˜æ³„æ¼

### 3.1 ä»€ä¹ˆæ˜¯ç±»åŠ è½½å™¨å†…å­˜æ³„æ¼

ç±»åŠ è½½å™¨å†…å­˜æ³„æ¼æ˜¯æŒ‡ç±»åŠ è½½å™¨åŠå…¶åŠ è½½çš„ç±»æ— æ³•è¢«GCå›æ”¶ï¼Œå¯¼è‡´å†…å­˜æ³„æ¼ã€‚

```java
// å†…å­˜æ³„æ¼åœºæ™¯
public class MemoryLeakDemo {
    
    // é™æ€é›†åˆæŒæœ‰ç±»åŠ è½½å™¨
    private static List<ClassLoader> loaders = new ArrayList<>();
    
    public static void loadPlugin() {
        ClassLoader loader = new PluginClassLoader();
        loaders.add(loader);  // æŒæœ‰å¼•ç”¨ï¼Œæ— æ³•å›æ”¶
    }
}
```

### 3.2 ç±»åŠ è½½å™¨å†…å­˜æ³„æ¼çš„åŸå› 

#### 1. é™æ€å­—æ®µæŒæœ‰å¼•ç”¨

```java
public class LeakCause1 {
    // é™æ€å­—æ®µæŒæœ‰ç±»åŠ è½½å™¨åŠ è½½çš„ç±»çš„å®ä¾‹
    private static Object instance;
    
    public static void load() {
        ClassLoader loader = new CustomClassLoader();
        Class<?> clazz = loader.loadClass("com.example.Service");
        instance = clazz.newInstance();  // æ³„æ¼ï¼šé™æ€å­—æ®µæŒæœ‰å®ä¾‹
    }
}
```

#### 2. ThreadLocalæœªæ¸…ç†

```java
public class LeakCause2 {
    private static ThreadLocal<Object> threadLocal = new ThreadLocal<>();
    
    public static void load() {
        ClassLoader loader = new CustomClassLoader();
        Class<?> clazz = loader.loadClass("com.example.Service");
        Object instance = clazz.newInstance();
        threadLocal.set(instance);  // æ³„æ¼ï¼šThreadLocalæŒæœ‰å®ä¾‹
        
        // å¿˜è®°æ¸…ç†
        // threadLocal.remove();
    }
}
```

#### 3. ç›‘å¬å™¨æœªæ³¨é”€

```java
public class LeakCause3 {
    private static List<EventListener> listeners = new ArrayList<>();
    
    public static void load() {
        ClassLoader loader = new CustomClassLoader();
        Class<?> clazz = loader.loadClass("com.example.Listener");
        EventListener listener = (EventListener) clazz.newInstance();
        listeners.add(listener);  // æ³„æ¼ï¼šç›‘å¬å™¨åˆ—è¡¨æŒæœ‰å®ä¾‹
        
        // å¿˜è®°æ³¨é”€
        // listeners.remove(listener);
    }
}
```

#### 4. çº¿ç¨‹æœªåœæ­¢

```java
public class LeakCause4 {
    public static void load() {
        ClassLoader loader = new CustomClassLoader();
        Class<?> clazz = loader.loadClass("com.example.Worker");
        Runnable worker = (Runnable) clazz.newInstance();
        
        Thread thread = new Thread(worker);
        thread.start();  // æ³„æ¼ï¼šçº¿ç¨‹æŒæœ‰å®ä¾‹
        
        // çº¿ç¨‹ä¸€ç›´è¿è¡Œï¼Œæ— æ³•å›æ”¶
    }
}
```

### 3.3 å¦‚ä½•é¿å…ç±»åŠ è½½å™¨å†…å­˜æ³„æ¼

#### 1. åŠæ—¶æ¸…ç†å¼•ç”¨

```java
public class AvoidLeak1 {
    private Map<String, ClassLoader> loaders = new ConcurrentHashMap<>();
    
    public void loadPlugin(String name) {
        ClassLoader loader = new PluginClassLoader();
        loaders.put(name, loader);
    }
    
    public void unloadPlugin(String name) {
        ClassLoader loader = loaders.remove(name);
        
        // æ¸…ç†æ‰€æœ‰å¼•ç”¨
        loader = null;
        
        // å»ºè®®GC
        System.gc();
    }
}
```

#### 2. ä½¿ç”¨å¼±å¼•ç”¨

```java
public class AvoidLeak2 {
    // ä½¿ç”¨WeakHashMapï¼Œkeyè¢«å›æ”¶æ—¶ï¼Œentryè‡ªåŠ¨åˆ é™¤
    private Map<String, ClassLoader> loaders = new WeakHashMap<>();
    
    public void loadPlugin(String name) {
        ClassLoader loader = new PluginClassLoader();
        loaders.put(name, loader);
    }
}
```

#### 3. æ¸…ç†ThreadLocal

```java
public class AvoidLeak3 {
    private static ThreadLocal<Object> threadLocal = new ThreadLocal<>();
    
    public static void execute() {
        try {
            ClassLoader loader = new CustomClassLoader();
            Class<?> clazz = loader.loadClass("com.example.Service");
            Object instance = clazz.newInstance();
            threadLocal.set(instance);
            
            // ä½¿ç”¨instance
        } finally {
            // ç¡®ä¿æ¸…ç†
            threadLocal.remove();
        }
    }
}
```

#### 4. åœæ­¢çº¿ç¨‹

```java
public class AvoidLeak4 {
    private Thread workerThread;
    
    public void start() {
        ClassLoader loader = new CustomClassLoader();
        Class<?> clazz = loader.loadClass("com.example.Worker");
        Runnable worker = (Runnable) clazz.newInstance();
        
        workerThread = new Thread(worker);
        workerThread.start();
    }
    
    public void stop() {
        if (workerThread != null) {
            workerThread.interrupt();
            workerThread = null;
        }
    }
}
```

### 3.4 æ£€æµ‹ç±»åŠ è½½å™¨å†…å­˜æ³„æ¼

#### ä½¿ç”¨jmapæŸ¥çœ‹ç±»åŠ è½½å™¨

```bash
# æŸ¥çœ‹å †ä¸­çš„ç±»åŠ è½½å™¨å®ä¾‹
jmap -histo:live <pid> | grep ClassLoader

# ç”Ÿæˆå †è½¬å‚¨
jmap -dump:format=b,file=heap.hprof <pid>
```

#### ä½¿ç”¨MATåˆ†æ

```
1. æ‰“å¼€å †è½¬å‚¨æ–‡ä»¶
2. æŸ¥çœ‹Leak Suspects
3. æŸ¥æ‰¾ClassLoaderå®ä¾‹
4. åˆ†æGC Rootsè·¯å¾„
5. æ‰¾åˆ°æŒæœ‰å¼•ç”¨çš„å¯¹è±¡
```

#### ç¼–ç¨‹æ–¹å¼æ£€æµ‹

```java
public class ClassLoaderLeakDetector {
    
    private static WeakReference<ClassLoader> loaderRef;
    
    public static void testLeak() {
        // åˆ›å»ºç±»åŠ è½½å™¨
        ClassLoader loader = new CustomClassLoader();
        loaderRef = new WeakReference<>(loader);
        
        // ä½¿ç”¨ç±»åŠ è½½å™¨
        try {
            Class<?> clazz = loader.loadClass("com.example.Service");
            Object instance = clazz.newInstance();
            
            // æ¨¡æ‹Ÿä½¿ç”¨
            Method method = clazz.getMethod("execute");
            method.invoke(instance);
        } catch (Exception e) {
            e.printStackTrace();
        }
        
        // æ¸…ç†å¼•ç”¨
        loader = null;
        
        // è§¦å‘GC
        System.gc();
        
        // ç­‰å¾…GCå®Œæˆ
        try {
            Thread.sleep(1000);
        } catch (InterruptedException e) {
            e.printStackTrace();
        }
        
        // æ£€æŸ¥æ˜¯å¦è¢«å›æ”¶
        if (loaderRef.get() == null) {
            System.out.println("âœ“ ç±»åŠ è½½å™¨å·²è¢«å›æ”¶ï¼Œæ— å†…å­˜æ³„æ¼");
        } else {
            System.out.println("âœ— ç±»åŠ è½½å™¨æœªè¢«å›æ”¶ï¼Œå¯èƒ½å­˜åœ¨å†…å­˜æ³„æ¼");
        }
    }
    
    public static void main(String[] args) {
        testLeak();
    }
}
```

---

## å››ã€å®æˆ˜æ¡ˆä¾‹

### æ¡ˆä¾‹1ï¼šå®ç°å®Œæ•´çš„æ’ä»¶ç³»ç»Ÿ

```java
// æ’ä»¶æ¥å£
public interface Plugin {
    void init();
    void execute();
    void destroy();
}

// æ’ä»¶ç±»åŠ è½½å™¨
public class PluginClassLoader extends URLClassLoader {
    
    private String pluginName;
    
    public PluginClassLoader(String pluginName, URL[] urls, ClassLoader parent) {
        super(urls, parent);
        this.pluginName = pluginName;
    }
    
    @Override
    protected Class<?> loadClass(String name, boolean resolve) 
        throws ClassNotFoundException {
        
        // æ ¸å¿ƒç±»å§”æ´¾ç»™çˆ¶åŠ è½½å™¨
        if (name.startsWith("java.") || 
            name.startsWith("com.example.api.")) {
            return super.loadClass(name, resolve);
        }
        
        // æ’ä»¶ç±»è‡ªå·±åŠ è½½
        synchronized (getClassLoadingLock(name)) {
            Class<?> c = findLoadedClass(name);
            if (c == null) {
                try {
                    c = findClass(name);
                } catch (ClassNotFoundException e) {
                    c = super.loadClass(name, resolve);
                }
            }
            if (resolve) {
                resolveClass(c);
            }
            return c;
        }
    }
    
    @Override
    public String toString() {
        return "PluginClassLoader[" + pluginName + "]";
    }
}

// æ’ä»¶ç®¡ç†å™¨
public class PluginManager {
    
    private Map<String, PluginContext> plugins = new ConcurrentHashMap<>();
    
    // æ’ä»¶ä¸Šä¸‹æ–‡
    private static class PluginContext {
        String name;
        PluginClassLoader loader;
        Plugin instance;
        long loadTime;
        
        PluginContext(String name, PluginClassLoader loader, Plugin instance) {
            this.name = name;
            this.loader = loader;
            this.instance = instance;
            this.loadTime = System.currentTimeMillis();
        }
    }
    
    // åŠ è½½æ’ä»¶
    public void loadPlugin(String pluginName, String pluginJarPath) throws Exception {
        System.out.println("æ­£åœ¨åŠ è½½æ’ä»¶: " + pluginName);
        
        // åˆ›å»ºç±»åŠ è½½å™¨
        URL[] urls = new URL[] { new File(pluginJarPath).toURI().toURL() };
        PluginClassLoader loader = new PluginClassLoader(
            pluginName,
            urls,
            this.getClass().getClassLoader()
        );
        
        // åŠ è½½æ’ä»¶ä¸»ç±»
        Class<?> pluginClass = loader.loadClass("com.example.plugin." + pluginName + ".Main");
        
        // åˆ›å»ºå®ä¾‹
        Plugin plugin = (Plugin) pluginClass.newInstance();
        
        // åˆå§‹åŒ–
        plugin.init();
        
        // ä¿å­˜ä¸Šä¸‹æ–‡
        PluginContext context = new PluginContext(pluginName, loader, plugin);
        plugins.put(pluginName, context);
        
        System.out.println("æ’ä»¶åŠ è½½æˆåŠŸ: " + pluginName);
    }
    
    // æ‰§è¡Œæ’ä»¶
    public void executePlugin(String pluginName) {
        PluginContext context = plugins.get(pluginName);
        if (context == null) {
            System.err.println("æ’ä»¶ä¸å­˜åœ¨: " + pluginName);
            return;
        }
        
        try {
            context.instance.execute();
        } catch (Exception e) {
            System.err.println("æ’ä»¶æ‰§è¡Œå¤±è´¥: " + pluginName);
            e.printStackTrace();
        }
    }
    
    // å¸è½½æ’ä»¶
    public void unloadPlugin(String pluginName) {
        System.out.println("æ­£åœ¨å¸è½½æ’ä»¶: " + pluginName);
        
        PluginContext context = plugins.remove(pluginName);
        if (context == null) {
            System.err.println("æ’ä»¶ä¸å­˜åœ¨: " + pluginName);
            return;
        }
        
        try {
            // é”€æ¯æ’ä»¶
            context.instance.destroy();
            
            // æ¸…ç†å¼•ç”¨
            context.instance = null;
            context.loader = null;
            
            // å»ºè®®GC
            System.gc();
            
            System.out.println("æ’ä»¶å¸è½½æˆåŠŸ: " + pluginName);
        } catch (Exception e) {
            System.err.println("æ’ä»¶å¸è½½å¤±è´¥: " + pluginName);
            e.printStackTrace();
        }
    }
    
    // é‡æ–°åŠ è½½æ’ä»¶
    public void reloadPlugin(String pluginName, String pluginJarPath) throws Exception {
        unloadPlugin(pluginName);
        Thread.sleep(100);  // ç­‰å¾…GC
        loadPlugin(pluginName, pluginJarPath);
    }
    
    // åˆ—å‡ºæ‰€æœ‰æ’ä»¶
    public void listPlugins() {
        System.out.println("\n========== å·²åŠ è½½çš„æ’ä»¶ ==========");
        for (PluginContext context : plugins.values()) {
            System.out.println("æ’ä»¶åç§°: " + context.name);
            System.out.println("ç±»åŠ è½½å™¨: " + context.loader);
            System.out.println("åŠ è½½æ—¶é—´: " + new Date(context.loadTime));
            System.out.println("-----------------------------------");
        }
    }
    
    public static void main(String[] args) throws Exception {
        PluginManager manager = new PluginManager();
        
        // åŠ è½½æ’ä»¶
        manager.loadPlugin("plugin1", "/path/to/plugin1.jar");
        manager.loadPlugin("plugin2", "/path/to/plugin2.jar");
        
        // åˆ—å‡ºæ’ä»¶
        manager.listPlugins();
        
        // æ‰§è¡Œæ’ä»¶
        manager.executePlugin("plugin1");
        manager.executePlugin("plugin2");
        
        // é‡æ–°åŠ è½½æ’ä»¶
        manager.reloadPlugin("plugin1", "/path/to/plugin1.jar");
        
        // å¸è½½æ’ä»¶
        manager.unloadPlugin("plugin2");
    }
}
```

### æ¡ˆä¾‹2ï¼šå®ç°Webåº”ç”¨çƒ­éƒ¨ç½²

```java
public class WebAppHotDeployManager {
    
    private Map<String, WebAppContext> webApps = new ConcurrentHashMap<>();
    
    private static class WebAppContext {
        String name;
        String webAppPath;
        WebAppClassLoader loader;
        Object servletContext;
        long lastModified;
        
        WebAppContext(String name, String webAppPath) {
            this.name = name;
            this.webAppPath = webAppPath;
            this.lastModified = System.currentTimeMillis();
        }
    }
    
    // éƒ¨ç½²Webåº”ç”¨
    public void deploy(String appName, String webAppPath) throws Exception {
        System.out.println("æ­£åœ¨éƒ¨ç½²åº”ç”¨: " + appName);
        
        WebAppContext context = new WebAppContext(appName, webAppPath);
        
        // åˆ›å»ºç±»åŠ è½½å™¨
        URL[] urls = new URL[] {
            new File(webAppPath + "/WEB-INF/classes").toURI().toURL(),
            new File(webAppPath + "/WEB-INF/lib").toURI().toURL()
        };
        context.loader = new WebAppClassLoader(urls);
        
        // åˆå§‹åŒ–ServletContext
        Class<?> contextClass = context.loader.loadClass("com.example.ServletContextImpl");
        context.servletContext = contextClass.newInstance();
        
        // è°ƒç”¨åˆå§‹åŒ–æ–¹æ³•
        Method initMethod = contextClass.getMethod("init", String.class);
        initMethod.invoke(context.servletContext, webAppPath);
        
        webApps.put(appName, context);
        
        System.out.println("åº”ç”¨éƒ¨ç½²æˆåŠŸ: " + appName);
    }
    
    // å–æ¶ˆéƒ¨ç½²
    public void undeploy(String appName) {
        System.out.println("æ­£åœ¨å–æ¶ˆéƒ¨ç½²: " + appName);
        
        WebAppContext context = webApps.remove(appName);
        if (context == null) {
            System.err.println("åº”ç”¨ä¸å­˜åœ¨: " + appName);
            return;
        }
        
        try {
            // è°ƒç”¨é”€æ¯æ–¹æ³•
            Class<?> contextClass = context.servletContext.getClass();
            Method destroyMethod = contextClass.getMethod("destroy");
            destroyMethod.invoke(context.servletContext);
            
            // æ¸…ç†å¼•ç”¨
            context.servletContext = null;
            context.loader = null;
            
            System.gc();
            
            System.out.println("åº”ç”¨å–æ¶ˆéƒ¨ç½²æˆåŠŸ: " + appName);
        } catch (Exception e) {
            System.err.println("åº”ç”¨å–æ¶ˆéƒ¨ç½²å¤±è´¥: " + appName);
            e.printStackTrace();
        }
    }
    
    // é‡æ–°éƒ¨ç½²
    public void redeploy(String appName) throws Exception {
        WebAppContext context = webApps.get(appName);
        if (context == null) {
            System.err.println("åº”ç”¨ä¸å­˜åœ¨: " + appName);
            return;
        }
        
        String webAppPath = context.webAppPath;
        undeploy(appName);
        Thread.sleep(100);
        deploy(appName, webAppPath);
    }
    
    // ç›‘æ§æ–‡ä»¶å˜åŒ–
    public void startMonitor() {
        Thread monitorThread = new Thread(() -> {
            while (true) {
                try {
                    Thread.sleep(5000);  // æ¯5ç§’æ£€æŸ¥ä¸€æ¬¡
                    
                    for (WebAppContext context : webApps.values()) {
                        if (isModified(context)) {
                            System.out.println("æ£€æµ‹åˆ°åº”ç”¨å˜åŒ–: " + context.name);
                            redeploy(context.name);
                        }
                    }
                } catch (Exception e) {
                    e.printStackTrace();
                }
            }
        });
        monitorThread.setDaemon(true);
        monitorThread.start();
    }
    
    private boolean isModified(WebAppContext context) {
        File classesDir = new File(context.webAppPath + "/WEB-INF/classes");
        return getLastModified(classesDir) > context.lastModified;
    }
    
    private long getLastModified(File dir) {
        long lastModified = dir.lastModified();
        File[] files = dir.listFiles();
        if (files != null) {
            for (File file : files) {
                if (file.isDirectory()) {
                    lastModified = Math.max(lastModified, getLastModified(file));
                } else {
                    lastModified = Math.max(lastModified, file.lastModified());
                }
            }
        }
        return lastModified;
    }
}
```

---

## äº”ã€æœ€ä½³å®è·µ

### 1. ç±»åŠ è½½å™¨éš”ç¦»

```java
// âœ… æ¨èï¼šæ˜ç¡®å®šä¹‰å…±äº«å’Œéš”ç¦»çš„è¾¹ç•Œ
public class BestPractice1 {
    
    // å…±äº«çš„ç±»åŠ è½½å™¨ï¼ˆåŠ è½½å…¬å…±APIï¼‰
    private ClassLoader sharedLoader;
    
    // éš”ç¦»çš„ç±»åŠ è½½å™¨ï¼ˆåŠ è½½å…·ä½“å®ç°ï¼‰
    private Map<String, ClassLoader> isolatedLoaders;
    
    public void init() {
        // åˆå§‹åŒ–å…±äº«ç±»åŠ è½½å™¨
        sharedLoader = new URLClassLoader(getSharedJars());
        
        // ä¸ºæ¯ä¸ªæ¨¡å—åˆ›å»ºéš”ç¦»çš„ç±»åŠ è½½å™¨
        isolatedLoaders = new HashMap<>();
        for (String module : getModules()) {
            ClassLoader loader = new ModuleClassLoader(module, sharedLoader);
            isolatedLoaders.put(module, loader);
        }
    }
}
```

### 2. çƒ­éƒ¨ç½²

```java
// âœ… æ¨èï¼šä½¿ç”¨ç‰ˆæœ¬å·ç®¡ç†ç±»åŠ è½½å™¨
public class BestPractice2 {
    
    private AtomicInteger version = new AtomicInteger(0);
    private Map<Integer, ClassLoader> loaderVersions = new ConcurrentHashMap<>();
    
    public ClassLoader reload() {
        int newVersion = version.incrementAndGet();
        ClassLoader newLoader = new HotDeployClassLoader("v" + newVersion);
        loaderVersions.put(newVersion, newLoader);
        
        // æ¸…ç†æ—§ç‰ˆæœ¬ï¼ˆä¿ç•™æœ€è¿‘3ä¸ªç‰ˆæœ¬ï¼‰
        if (newVersion > 3) {
            loaderVersions.remove(newVersion - 3);
        }
        
        return newLoader;
    }
}
```

### 3. å†…å­˜æ³„æ¼é¢„é˜²

```java
// âœ… æ¨èï¼šä½¿ç”¨try-finallyç¡®ä¿æ¸…ç†
public class BestPractice3 {
    
    private ThreadLocal<Object> threadLocal = new ThreadLocal<>();
    
    public void execute() {
        try {
            // ä½¿ç”¨ThreadLocal
            threadLocal.set(createInstance());
            doWork();
        } finally {
            // ç¡®ä¿æ¸…ç†
            threadLocal.remove();
        }
    }
}
```

---

## å…­ã€æ€»ç»“

### 6.1 ç±»åŠ è½½å™¨éš”ç¦»

| ç‰¹æ€§ | è¯´æ˜ |
|------|------|
| **ç›®çš„** | å®ç°å¤šç‰ˆæœ¬å…±å­˜ã€æ¨¡å—åŒ– |
| **åŸç†** | ä¸åŒç±»åŠ è½½å™¨åŠ è½½ç›¸åŒçš„ç±» |
| **åº”ç”¨** | Tomcatã€æ’ä»¶ç³»ç»Ÿã€OSGi |

### 6.2 çƒ­éƒ¨ç½²

| ç‰¹æ€§ | è¯´æ˜ |
|------|------|
| **ç›®çš„** | ä¸åœæœºæ›´æ–°ä»£ç  |
| **åŸç†** | åˆ›å»ºæ–°ç±»åŠ è½½å™¨åŠ è½½æ–°ç±» |
| **é™åˆ¶** | æ— æ³•ä¿®æ”¹ç±»ç»“æ„ |

### 6.3 å†…å­˜æ³„æ¼

| åŸå›  | è§£å†³æ–¹æ¡ˆ |
|------|---------|
| é™æ€å­—æ®µæŒæœ‰å¼•ç”¨ | åŠæ—¶æ¸…ç† |
| ThreadLocalæœªæ¸…ç† | ä½¿ç”¨try-finally |
| ç›‘å¬å™¨æœªæ³¨é”€ | åŠæ—¶æ³¨é”€ |
| çº¿ç¨‹æœªåœæ­¢ | åœæ­¢çº¿ç¨‹ |

---

## ğŸ“š å‚è€ƒèµ„æ–™

1. **ã€Šæ·±å…¥ç†è§£Javaè™šæ‹Ÿæœºï¼ˆç¬¬3ç‰ˆï¼‰ã€‹** - å‘¨å¿—æ˜
2. **ã€ŠJavaè™šæ‹Ÿæœºè§„èŒƒã€‹** - https://docs.oracle.com/javase/specs/
3. **Tomcatæºç ** - https://github.com/apache/tomcat

---

**ä¸‹ä¸€æ­¥**ï¼šæŸ¥çœ‹[æ¼”ç¤ºä»£ç ](../demo/)å’Œ[å®æˆ˜é¡¹ç›®](../project/)
