# æ‰“ç ´åŒäº²å§”æ´¾æ¨¡å‹

## ğŸ“š æ¦‚è¿°

è™½ç„¶åŒäº²å§”æ´¾æ¨¡å‹æ˜¯Javaç±»åŠ è½½çš„æ¨èæ–¹å¼ï¼Œä½†åœ¨æŸäº›åœºæ™¯ä¸‹éœ€è¦æ‰“ç ´è¿™ä¸ªæ¨¡å‹ã€‚æœ¬æ–‡æ·±å…¥è®²è§£å¦‚ä½•ä»¥åŠä¸ºä»€ä¹ˆè¦æ‰“ç ´åŒäº²å§”æ´¾æ¨¡å‹ï¼Œä»¥åŠå®é™…åº”ç”¨åœºæ™¯ã€‚

## ğŸ¯ æ ¸å¿ƒé—®é¢˜

- â“ ä¸ºä»€ä¹ˆè¦æ‰“ç ´åŒäº²å§”æ´¾æ¨¡å‹ï¼Ÿ
- â“ å¦‚ä½•æ‰“ç ´åŒäº²å§”æ´¾æ¨¡å‹ï¼Ÿ
- â“ æœ‰å“ªäº›å…¸å‹çš„åº”ç”¨åœºæ™¯ï¼Ÿ
- â“ Tomcatæ˜¯å¦‚ä½•å®ç°ç±»åŠ è½½çš„ï¼Ÿ
- â“ SPIæœºåˆ¶å¦‚ä½•æ‰“ç ´åŒäº²å§”æ´¾ï¼Ÿ
- â“ OSGiçš„ç±»åŠ è½½æœºåˆ¶æ˜¯ä»€ä¹ˆï¼Ÿ

---

## ä¸€ã€ä¸ºä»€ä¹ˆè¦æ‰“ç ´åŒäº²å§”æ´¾æ¨¡å‹

### 1.1 åŒäº²å§”æ´¾æ¨¡å‹çš„å±€é™æ€§

è™½ç„¶åŒäº²å§”æ´¾æ¨¡å‹æœ‰å¾ˆå¤šä¼˜ç‚¹ï¼Œä½†åœ¨ä»¥ä¸‹åœºæ™¯ä¸­ä¼šé‡åˆ°é—®é¢˜ï¼š

#### 1. åŸºç¡€ç±»éœ€è¦è°ƒç”¨ç”¨æˆ·ä»£ç 

```java
// åœºæ™¯ï¼šJDBCé©±åŠ¨åŠ è½½
// DriverManageråœ¨rt.jarä¸­ï¼Œç”±Bootstrap ClassLoaderåŠ è½½
// ä½†MySQLé©±åŠ¨åœ¨ClassPathä¸­ï¼Œç”±Application ClassLoaderåŠ è½½
// Bootstrap ClassLoaderæ— æ³•è®¿é—®Application ClassLoaderåŠ è½½çš„ç±»

public class DriverManager {
    static {
        // å¦‚ä½•åŠ è½½ç”¨æˆ·æä¾›çš„é©±åŠ¨ï¼Ÿ
        loadInitialDrivers();
    }
}
```

#### 2. ä»£ç çƒ­æ›¿æ¢

```java
// åœºæ™¯ï¼šå¼€å‘ç¯å¢ƒçƒ­éƒ¨ç½²
// ä¿®æ”¹ä»£ç åï¼Œéœ€è¦é‡æ–°åŠ è½½ç±»
// ä½†åŒäº²å§”æ´¾æ¨¡å‹ä¼šè¿”å›å·²åŠ è½½çš„ç±»
Class<?> oldClass = loader.loadClass("com.example.Service");
// ä¿®æ”¹ä»£ç å
Class<?> newClass = loader.loadClass("com.example.Service");
// oldClass == newClassï¼ˆæ— æ³•çƒ­æ›¿æ¢ï¼‰
```

#### 3. åº”ç”¨éš”ç¦»

```java
// åœºæ™¯ï¼šTomcatä¸­å¤šä¸ªWebåº”ç”¨
// ä¸åŒåº”ç”¨å¯èƒ½ä½¿ç”¨ä¸åŒç‰ˆæœ¬çš„åŒä¸€ä¸ªç±»åº“
// åŒäº²å§”æ´¾æ¨¡å‹æ— æ³•å®ç°ç±»çš„éš”ç¦»
```

### 1.2 éœ€è¦æ‰“ç ´åŒäº²å§”æ´¾çš„åœºæ™¯

| åœºæ™¯ | åŸå›  | è§£å†³æ–¹æ¡ˆ |
|------|------|---------|
| JDBCé©±åŠ¨åŠ è½½ | åŸºç¡€ç±»è°ƒç”¨ç”¨æˆ·ä»£ç  | çº¿ç¨‹ä¸Šä¸‹æ–‡ç±»åŠ è½½å™¨ |
| Tomcat | åº”ç”¨éš”ç¦» | è‡ªå®šä¹‰ç±»åŠ è½½å™¨æ¶æ„ |
| OSGi | æ¨¡å—åŒ– | ç½‘çŠ¶ç±»åŠ è½½å™¨ç»“æ„ |
| çƒ­éƒ¨ç½² | ä»£ç çƒ­æ›¿æ¢ | è‡ªå®šä¹‰ç±»åŠ è½½å™¨ |
| SPIæœºåˆ¶ | æœåŠ¡æä¾›è€…åŠ è½½ | çº¿ç¨‹ä¸Šä¸‹æ–‡ç±»åŠ è½½å™¨ |

---

## äºŒã€æ‰“ç ´åŒäº²å§”æ´¾çš„ä¸‰ç§æ–¹å¼

### 2.1 æ–¹å¼ä¸€ï¼šé‡å†™loadClass()æ–¹æ³•

#### åŸç†

```java
// åŒäº²å§”æ´¾æ¨¡å‹çš„å®ç°åœ¨loadClass()æ–¹æ³•ä¸­
// é‡å†™æ­¤æ–¹æ³•å¯ä»¥æ”¹å˜å§”æ´¾é€»è¾‘

public class BreakParentDelegationLoader extends ClassLoader {
    
    @Override
    public Class<?> loadClass(String name) throws ClassNotFoundException {
        // ä¸å§”æ´¾ç»™çˆ¶åŠ è½½å™¨ï¼Œç›´æ¥è‡ªå·±åŠ è½½
        Class<?> c = findLoadedClass(name);
        if (c == null) {
            // è‡ªå·±æŸ¥æ‰¾å¹¶åŠ è½½
            c = findClass(name);
        }
        return c;
    }
    
    @Override
    protected Class<?> findClass(String name) throws ClassNotFoundException {
        // å®ç°ç±»åŠ è½½é€»è¾‘
        byte[] classData = loadClassData(name);
        return defineClass(name, classData, 0, classData.length);
    }
}
```

#### ç¤ºä¾‹ï¼šä¼˜å…ˆåŠ è½½è‡ªå·±çš„ç±»

```java
public class SelfFirstClassLoader extends ClassLoader {
    
    private String classPath;
    
    public SelfFirstClassLoader(String classPath) {
        this.classPath = classPath;
    }
    
    @Override
    public Class<?> loadClass(String name) throws ClassNotFoundException {
        // 1. æ£€æŸ¥æ˜¯å¦å·²åŠ è½½
        Class<?> c = findLoadedClass(name);
        if (c != null) {
            return c;
        }
        
        // 2. å¯¹äºjava.*ç­‰æ ¸å¿ƒç±»ï¼Œå§”æ´¾ç»™çˆ¶åŠ è½½å™¨
        if (name.startsWith("java.") || name.startsWith("javax.")) {
            return super.loadClass(name);
        }
        
        // 3. ä¼˜å…ˆè‡ªå·±åŠ è½½
        try {
            c = findClass(name);
            return c;
        } catch (ClassNotFoundException e) {
            // 4. è‡ªå·±åŠ è½½å¤±è´¥ï¼Œå§”æ´¾ç»™çˆ¶åŠ è½½å™¨
            return super.loadClass(name);
        }
    }
    
    @Override
    protected Class<?> findClass(String name) throws ClassNotFoundException {
        try {
            byte[] classData = loadClassData(name);
            return defineClass(name, classData, 0, classData.length);
        } catch (IOException e) {
            throw new ClassNotFoundException(name, e);
        }
    }
    
    private byte[] loadClassData(String name) throws IOException {
        String fileName = classPath + "/" + name.replace('.', '/') + ".class";
        try (InputStream is = new FileInputStream(fileName);
             ByteArrayOutputStream baos = new ByteArrayOutputStream()) {
            
            byte[] buffer = new byte[1024];
            int len;
            while ((len = is.read(buffer)) != -1) {
                baos.write(buffer, 0, len);
            }
            return baos.toByteArray();
        }
    }
}
```

âš ï¸ **æ³¨æ„**ï¼š
- ä¸è¦åŠ è½½`java.*`ç­‰æ ¸å¿ƒç±»ï¼Œä¼šæŠ›å‡º`SecurityException`
- å¿…é¡»ä¿è¯æ ¸å¿ƒç±»ç”±Bootstrap ClassLoaderåŠ è½½

### 2.2 æ–¹å¼äºŒï¼šçº¿ç¨‹ä¸Šä¸‹æ–‡ç±»åŠ è½½å™¨

#### åŸç†

çº¿ç¨‹ä¸Šä¸‹æ–‡ç±»åŠ è½½å™¨ï¼ˆThread Context ClassLoaderï¼‰å¯ä»¥è®©çˆ¶ç±»åŠ è½½å™¨è¯·æ±‚å­ç±»åŠ è½½å™¨å®Œæˆç±»åŠ è½½ã€‚

```java
// è®¾ç½®çº¿ç¨‹ä¸Šä¸‹æ–‡ç±»åŠ è½½å™¨
Thread.currentThread().setContextClassLoader(classLoader);

// è·å–çº¿ç¨‹ä¸Šä¸‹æ–‡ç±»åŠ è½½å™¨
ClassLoader contextLoader = Thread.currentThread().getContextClassLoader();
```

#### å·¥ä½œæµç¨‹

```
ä¼ ç»ŸåŒäº²å§”æ´¾ï¼š
    å­åŠ è½½å™¨ â†’ çˆ¶åŠ è½½å™¨ â†’ ç¥–çˆ¶åŠ è½½å™¨
    ï¼ˆå‘ä¸Šå§”æ´¾ï¼‰

çº¿ç¨‹ä¸Šä¸‹æ–‡ç±»åŠ è½½å™¨ï¼š
    çˆ¶åŠ è½½å™¨ â†’ çº¿ç¨‹ä¸Šä¸‹æ–‡ç±»åŠ è½½å™¨ï¼ˆå­åŠ è½½å™¨ï¼‰
    ï¼ˆå‘ä¸‹å§”æ´¾ï¼‰
```

---

## ä¸‰ã€SPIæœºåˆ¶ä¸çº¿ç¨‹ä¸Šä¸‹æ–‡ç±»åŠ è½½å™¨

### 3.1 ä»€ä¹ˆæ˜¯SPI

SPIï¼ˆService Provider Interfaceï¼‰æ˜¯Javaæä¾›çš„ä¸€ç§æœåŠ¡å‘ç°æœºåˆ¶ï¼Œå…è®¸ç¬¬ä¸‰æ–¹ä¸ºæ¥å£æä¾›å®ç°ã€‚

```
æ ¸å¿ƒç±»åº“ï¼ˆæ¥å£ï¼‰  â†  ç¬¬ä¸‰æ–¹å®ç°
    â†“                    â†“
Bootstrap CL      Application CL
```

### 3.2 SPIçš„ä½¿ç”¨

#### 1. å®šä¹‰æ¥å£

```java
// åœ¨æ ¸å¿ƒç±»åº“ä¸­å®šä¹‰æ¥å£
package java.sql;

public interface Driver {
    Connection connect(String url, Properties info) throws SQLException;
    boolean acceptsURL(String url) throws SQLException;
}
```

#### 2. æä¾›å®ç°

```java
// MySQLé©±åŠ¨å®ç°ï¼ˆåœ¨ç¬¬ä¸‰æ–¹jarä¸­ï¼‰
package com.mysql.jdbc;

public class Driver implements java.sql.Driver {
    static {
        try {
            DriverManager.registerDriver(new Driver());
        } catch (SQLException e) {
            throw new RuntimeException("Can't register driver!");
        }
    }
    
    @Override
    public Connection connect(String url, Properties info) {
        // å®ç°è¿æ¥é€»è¾‘
    }
}
```

#### 3. é…ç½®æœåŠ¡æä¾›è€…

```
åœ¨jaråŒ…ä¸­åˆ›å»ºæ–‡ä»¶ï¼š
META-INF/services/java.sql.Driver

æ–‡ä»¶å†…å®¹ï¼š
com.mysql.jdbc.Driver
```

#### 4. ä½¿ç”¨ServiceLoaderåŠ è½½

```java
public class DriverManager {
    
    static {
        loadInitialDrivers();
    }
    
    private static void loadInitialDrivers() {
        AccessController.doPrivileged(new PrivilegedAction<Void>() {
            public Void run() {
                // ä½¿ç”¨ServiceLoaderåŠ è½½æ‰€æœ‰Driverå®ç°
                ServiceLoader<Driver> loadedDrivers = ServiceLoader.load(Driver.class);
                Iterator<Driver> driversIterator = loadedDrivers.iterator();
                
                try {
                    while(driversIterator.hasNext()) {
                        driversIterator.next();
                    }
                } catch(Throwable t) {
                    // å¿½ç•¥
                }
                return null;
            }
        });
    }
}
```

### 3.3 ServiceLoaderçš„å®ç°

```java
public final class ServiceLoader<S> implements Iterable<S> {
    
    // æœåŠ¡æ¥å£
    private final Class<S> service;
    
    // ç±»åŠ è½½å™¨
    private final ClassLoader loader;
    
    // å·²åŠ è½½çš„æœåŠ¡æä¾›è€…
    private LinkedHashMap<String,S> providers = new LinkedHashMap<>();
    
    // æ‡’åŠ è½½è¿­ä»£å™¨
    private LazyIterator lookupIterator;
    
    public static <S> ServiceLoader<S> load(Class<S> service) {
        // ä½¿ç”¨çº¿ç¨‹ä¸Šä¸‹æ–‡ç±»åŠ è½½å™¨
        ClassLoader cl = Thread.currentThread().getContextClassLoader();
        return ServiceLoader.load(service, cl);
    }
    
    public static <S> ServiceLoader<S> load(Class<S> service, ClassLoader loader) {
        return new ServiceLoader<>(service, loader);
    }
    
    private ServiceLoader(Class<S> svc, ClassLoader cl) {
        service = Objects.requireNonNull(svc, "Service interface cannot be null");
        loader = (cl == null) ? ClassLoader.getSystemClassLoader() : cl;
        reload();
    }
    
    public void reload() {
        providers.clear();
        lookupIterator = new LazyIterator(service, loader);
    }
    
    public Iterator<S> iterator() {
        return new Iterator<S>() {
            
            Iterator<Map.Entry<String,S>> knownProviders = providers.entrySet().iterator();
            
            public boolean hasNext() {
                if (knownProviders.hasNext())
                    return true;
                return lookupIterator.hasNext();
            }
            
            public S next() {
                if (knownProviders.hasNext())
                    return knownProviders.next().getValue();
                return lookupIterator.next();
            }
        };
    }
    
    // æ‡’åŠ è½½è¿­ä»£å™¨
    private class LazyIterator implements Iterator<S> {
        
        Class<S> service;
        ClassLoader loader;
        Enumeration<URL> configs = null;
        Iterator<String> pending = null;
        String nextName = null;
        
        private LazyIterator(Class<S> service, ClassLoader loader) {
            this.service = service;
            this.loader = loader;
        }
        
        public boolean hasNext() {
            if (nextName != null) {
                return true;
            }
            if (configs == null) {
                try {
                    // è¯»å–META-INF/services/æ¥å£å…¨é™å®šåæ–‡ä»¶
                    String fullName = "META-INF/services/" + service.getName();
                    if (loader == null)
                        configs = ClassLoader.getSystemResources(fullName);
                    else
                        configs = loader.getResources(fullName);
                } catch (IOException x) {
                    fail(service, "Error locating configuration files", x);
                }
            }
            while ((pending == null) || !pending.hasNext()) {
                if (!configs.hasMoreElements()) {
                    return false;
                }
                pending = parse(service, configs.nextElement());
            }
            nextName = pending.next();
            return true;
        }
        
        public S next() {
            if (!hasNext()) {
                throw new NoSuchElementException();
            }
            String cn = nextName;
            nextName = null;
            Class<?> c = null;
            try {
                // ä½¿ç”¨æŒ‡å®šçš„ç±»åŠ è½½å™¨åŠ è½½å®ç°ç±»
                c = Class.forName(cn, false, loader);
            } catch (ClassNotFoundException x) {
                fail(service, "Provider " + cn + " not found");
            }
            if (!service.isAssignableFrom(c)) {
                fail(service, "Provider " + cn  + " not a subtype");
            }
            try {
                S p = service.cast(c.newInstance());
                providers.put(cn, p);
                return p;
            } catch (Throwable x) {
                fail(service, "Provider " + cn + " could not be instantiated", x);
            }
            throw new Error();
        }
    }
}
```

### 3.4 SPIæ‰“ç ´åŒäº²å§”æ´¾çš„åŸç†

```
1. DriverManagerç”±Bootstrap ClassLoaderåŠ è½½
   â†“
2. DriverManagerè°ƒç”¨ServiceLoader.load(Driver.class)
   â†“
3. ServiceLoaderä½¿ç”¨Thread.currentThread().getContextClassLoader()
   è·å–Application ClassLoader
   â†“
4. ä½¿ç”¨Application ClassLoaderåŠ è½½META-INF/servicesé…ç½®
   â†“
5. ä½¿ç”¨Application ClassLoaderåŠ è½½MySQLé©±åŠ¨å®ç°ç±»
   â†“
6. å®Œæˆ"çˆ¶åŠ è½½å™¨è¯·æ±‚å­åŠ è½½å™¨åŠ è½½ç±»"çš„é€†å‘æ“ä½œ
```

### 3.5 è‡ªå®šä¹‰SPIç¤ºä¾‹

```java
// 1. å®šä¹‰æœåŠ¡æ¥å£
public interface PaymentService {
    void pay(double amount);
}

// 2. å®ç°æœåŠ¡ï¼ˆæ”¯ä»˜å®ï¼‰
public class AlipayService implements PaymentService {
    @Override
    public void pay(double amount) {
        System.out.println("æ”¯ä»˜å®æ”¯ä»˜: " + amount);
    }
}

// 3. å®ç°æœåŠ¡ï¼ˆå¾®ä¿¡ï¼‰
public class WechatPayService implements PaymentService {
    @Override
    public void pay(double amount) {
        System.out.println("å¾®ä¿¡æ”¯ä»˜: " + amount);
    }
}

// 4. é…ç½®æ–‡ä»¶
// META-INF/services/com.example.PaymentService
// com.example.AlipayService
// com.example.WechatPayService

// 5. ä½¿ç”¨SPI
public class SPIDemo {
    public static void main(String[] args) {
        ServiceLoader<PaymentService> loader = ServiceLoader.load(PaymentService.class);
        
        for (PaymentService service : loader) {
            service.pay(100.0);
        }
    }
}

// è¾“å‡ºï¼š
// æ”¯ä»˜å®æ”¯ä»˜: 100.0
// å¾®ä¿¡æ”¯ä»˜: 100.0
```

---

## å››ã€Tomcatçš„ç±»åŠ è½½å™¨æ¶æ„

### 4.1 Tomcatç±»åŠ è½½å™¨å±‚æ¬¡

```
        Bootstrap ClassLoader
                â†“
        Extension ClassLoader
                â†“
        System ClassLoader
                â†“
        Common ClassLoader
            â†™       â†˜
    Catalina      Shared
    ClassLoader   ClassLoader
                      â†“
                  WebApp ClassLoader
                      â†“
                  Jsp ClassLoader
```

### 4.2 å„ç±»åŠ è½½å™¨çš„ä½œç”¨

| ç±»åŠ è½½å™¨ | åŠ è½½è·¯å¾„ | ä½œç”¨ | å¯è§æ€§ |
|---------|---------|------|--------|
| **Common** | `$CATALINA_HOME/lib` | Tomcatå’Œæ‰€æœ‰Webåº”ç”¨å…±äº« | å¯¹Tomcatå’Œæ‰€æœ‰Webåº”ç”¨å¯è§ |
| **Catalina** | `$CATALINA_HOME/server/lib` | ä»…Tomcatä½¿ç”¨ | ä»…å¯¹Tomcatå¯è§ |
| **Shared** | `$CATALINA_HOME/shared/lib` | æ‰€æœ‰Webåº”ç”¨å…±äº« | å¯¹æ‰€æœ‰Webåº”ç”¨å¯è§ï¼Œå¯¹Tomcatä¸å¯è§ |
| **WebApp** | `/WEB-INF/lib`, `/WEB-INF/classes` | å½“å‰Webåº”ç”¨ç§æœ‰ | ä»…å¯¹å½“å‰Webåº”ç”¨å¯è§ |
| **Jsp** | åŠ¨æ€ç”Ÿæˆçš„JSPç±» | JSPæ–‡ä»¶ | ä»…å¯¹å½“å‰JSPå¯è§ |

### 4.3 WebAppClassLoaderå®ç°

```java
public class WebAppClassLoader extends URLClassLoader {
    
    // æ˜¯å¦éµå¾ªåŒäº²å§”æ´¾æ¨¡å‹
    private boolean delegate = false;
    
    @Override
    public Class<?> loadClass(String name, boolean resolve) 
        throws ClassNotFoundException {
        
        synchronized (getClassLoadingLock(name)) {
            Class<?> clazz = null;
            
            // 1. æ£€æŸ¥æœ¬åœ°ç¼“å­˜
            clazz = findLoadedClass(name);
            if (clazz != null) {
                if (resolve) {
                    resolveClass(clazz);
                }
                return clazz;
            }
            
            // 2. æ£€æŸ¥JVMç¼“å­˜
            try {
                clazz = findLoadedClass0(name);
                if (clazz != null) {
                    if (resolve) {
                        resolveClass(clazz);
                    }
                    return clazz;
                }
            } catch (Exception e) {
                // ignore
            }
            
            // 3. ä½¿ç”¨System ClassLoaderåŠ è½½ï¼ˆé˜²æ­¢è¦†ç›–æ ¸å¿ƒç±»ï¼‰
            try {
                clazz = getSystemClassLoader().loadClass(name);
                if (clazz != null) {
                    if (resolve) {
                        resolveClass(clazz);
                    }
                    return clazz;
                }
            } catch (ClassNotFoundException e) {
                // ignore
            }
            
            // 4. æ˜¯å¦éµå¾ªåŒäº²å§”æ´¾
            boolean delegateLoad = delegate || filter(name);
            
            if (delegateLoad) {
                // éµå¾ªåŒäº²å§”æ´¾ï¼šå…ˆå§”æ´¾ç»™çˆ¶åŠ è½½å™¨
                try {
                    clazz = Class.forName(name, false, getParent());
                    if (clazz != null) {
                        if (resolve) {
                            resolveClass(clazz);
                        }
                        return clazz;
                    }
                } catch (ClassNotFoundException e) {
                    // ignore
                }
            }
            
            // 5. ä»å½“å‰Webåº”ç”¨åŠ è½½
            try {
                clazz = findClass(name);
                if (clazz != null) {
                    if (resolve) {
                        resolveClass(clazz);
                    }
                    return clazz;
                }
            } catch (ClassNotFoundException e) {
                // ignore
            }
            
            // 6. å¦‚æœä¸éµå¾ªåŒäº²å§”æ´¾ï¼Œæœ€åå°è¯•çˆ¶åŠ è½½å™¨
            if (!delegateLoad) {
                try {
                    clazz = Class.forName(name, false, getParent());
                    if (clazz != null) {
                        if (resolve) {
                            resolveClass(clazz);
                        }
                        return clazz;
                    }
                } catch (ClassNotFoundException e) {
                    // ignore
                }
            }
            
            throw new ClassNotFoundException(name);
        }
    }
    
    // è¿‡æ»¤å™¨ï¼šæŸäº›ç±»å¿…é¡»ç”±çˆ¶åŠ è½½å™¨åŠ è½½
    private boolean filter(String name) {
        if (name == null) {
            return false;
        }
        
        // javax.*å¿…é¡»ç”±çˆ¶åŠ è½½å™¨åŠ è½½
        if (name.startsWith("javax.")) {
            return true;
        }
        
        // org.xml.*å¿…é¡»ç”±çˆ¶åŠ è½½å™¨åŠ è½½
        if (name.startsWith("org.xml.")) {
            return true;
        }
        
        return false;
    }
}
```

### 4.4 Tomcatç±»åŠ è½½é¡ºåº

#### delegate=falseï¼ˆé»˜è®¤ï¼‰

```
1. Bootstrap ClassLoaderï¼ˆJVMæ ¸å¿ƒç±»ï¼‰
   â†“ æ‰¾ä¸åˆ°
2. WebApp ClassLoaderï¼ˆ/WEB-INF/classes, /WEB-INF/libï¼‰
   â†“ æ‰¾ä¸åˆ°
3. Common ClassLoaderï¼ˆ$CATALINA_HOME/libï¼‰
   â†“ æ‰¾ä¸åˆ°
4. System ClassLoader
```

#### delegate=true

```
1. Bootstrap ClassLoader
   â†“ æ‰¾ä¸åˆ°
2. System ClassLoader
   â†“ æ‰¾ä¸åˆ°
3. Common ClassLoader
   â†“ æ‰¾ä¸åˆ°
4. WebApp ClassLoader
```

### 4.5 ä¸ºä»€ä¹ˆTomcatè¦è¿™æ ·è®¾è®¡ï¼Ÿ

#### 1. éš”ç¦»æ€§

```java
// åº”ç”¨Aä½¿ç”¨Spring 4.x
// /webapps/appA/WEB-INF/lib/spring-core-4.3.jar

// åº”ç”¨Bä½¿ç”¨Spring 5.x
// /webapps/appB/WEB-INF/lib/spring-core-5.2.jar

// ä¸¤ä¸ªåº”ç”¨ä½¿ç”¨ä¸åŒçš„WebAppClassLoaderï¼Œäº’ä¸å½±å“
```

#### 2. çµæ´»æ€§

```java
// åŒä¸€ä¸ªç±»åº“çš„ä¸åŒç‰ˆæœ¬å¯ä»¥åœ¨ä¸åŒåº”ç”¨ä¸­å…±å­˜
// æ¯ä¸ªåº”ç”¨æœ‰è‡ªå·±çš„ç±»åŠ è½½å™¨ï¼ŒåŠ è½½è‡ªå·±çš„ç‰ˆæœ¬
```

#### 3. å…±äº«æ€§

```java
// å…¬å…±ç±»åº“æ”¾åœ¨Commonä¸­ï¼Œæ‰€æœ‰åº”ç”¨å…±äº«
// $CATALINA_HOME/lib/servlet-api.jar
// èŠ‚çœå†…å­˜ï¼Œé¿å…é‡å¤åŠ è½½
```

#### 4. çƒ­éƒ¨ç½²

```java
// é‡æ–°åˆ›å»ºWebAppClassLoaderå³å¯å®ç°çƒ­éƒ¨ç½²
public void reload(Context context) {
    // 1. åœæ­¢æ—§çš„WebAppClassLoader
    WebAppClassLoader oldLoader = context.getLoader();
    oldLoader.stop();
    
    // 2. åˆ›å»ºæ–°çš„WebAppClassLoader
    WebAppClassLoader newLoader = new WebAppClassLoader(context.getDocBase());
    context.setLoader(newLoader);
    
    // 3. é‡æ–°åŠ è½½åº”ç”¨
    newLoader.start();
}
```

### 4.6 é…ç½®delegateæ¨¡å¼

```xml
<!-- åœ¨context.xmlä¸­é…ç½® -->
<Context>
    <Loader delegate="true"/>
</Context>
```

---

## äº”ã€OSGiçš„ç±»åŠ è½½æœºåˆ¶

### 5.1 OSGiç®€ä»‹

OSGiï¼ˆOpen Service Gateway Initiativeï¼‰æ˜¯ä¸€ä¸ªåŠ¨æ€æ¨¡å—åŒ–ç³»ç»Ÿï¼Œå®ç°äº†å®Œå…¨çš„æ¨¡å—åŒ–ã€‚

### 5.2 OSGiç±»åŠ è½½å™¨ç»“æ„

```
ä¼ ç»ŸåŒäº²å§”æ´¾ï¼ˆæ ‘çŠ¶ï¼‰ï¼š
    Bootstrap
        â†“
    Extension
        â†“
    Application
        â†“
    Custom

OSGiï¼ˆç½‘çŠ¶ï¼‰ï¼š
    Bundle A â†â†’ Bundle B
        â†“           â†“
    Bundle C â†â†’ Bundle D
```

### 5.3 OSGiç±»åŠ è½½è§„åˆ™

```java
// OSGiçš„ç±»åŠ è½½é¡ºåºï¼š
// 1. æ£€æŸ¥æ˜¯å¦æ˜¯java.*å¼€å¤´ï¼Œæ˜¯åˆ™å§”æ´¾ç»™çˆ¶åŠ è½½å™¨
// 2. æ£€æŸ¥æ˜¯å¦åœ¨Import-Packageä¸­ï¼Œæ˜¯åˆ™å§”æ´¾ç»™å¯¼å‡ºè¯¥åŒ…çš„Bundle
// 3. æ£€æŸ¥æ˜¯å¦åœ¨è‡ªå·±çš„Bundleä¸­
// 4. æ£€æŸ¥æ˜¯å¦åœ¨Fragment Bundleä¸­
// 5. æ£€æŸ¥æ˜¯å¦åœ¨Require-Bundleä¸­
// 6. æŸ¥æ‰¾å¤±è´¥

public class OSGiClassLoader extends ClassLoader {
    
    private Bundle bundle;
    
    @Override
    protected Class<?> loadClass(String name, boolean resolve) 
        throws ClassNotFoundException {
        
        // 1. java.*å§”æ´¾ç»™çˆ¶åŠ è½½å™¨
        if (name.startsWith("java.")) {
            return getParent().loadClass(name);
        }
        
        // 2. æ£€æŸ¥Import-Package
        String packageName = getPackageName(name);
        if (bundle.isImportedPackage(packageName)) {
            Bundle exportBundle = bundle.findExportBundle(packageName);
            return exportBundle.loadClass(name);
        }
        
        // 3. æ£€æŸ¥è‡ªå·±çš„Bundle
        Class<?> c = findOwnClass(name);
        if (c != null) {
            return c;
        }
        
        // 4. æ£€æŸ¥Fragment Bundle
        for (Bundle fragment : bundle.getFragments()) {
            try {
                return fragment.loadClass(name);
            } catch (ClassNotFoundException e) {
                // ç»§ç»­æŸ¥æ‰¾
            }
        }
        
        // 5. æ£€æŸ¥Require-Bundle
        for (Bundle requiredBundle : bundle.getRequiredBundles()) {
            try {
                return requiredBundle.loadClass(name);
            } catch (ClassNotFoundException e) {
                // ç»§ç»­æŸ¥æ‰¾
            }
        }
        
        throw new ClassNotFoundException(name);
    }
    
    private String getPackageName(String className) {
        int lastDot = className.lastIndexOf('.');
        return (lastDot == -1) ? "" : className.substring(0, lastDot);
    }
}
```

### 5.4 OSGi Bundleç¤ºä¾‹

```
// Bundle Açš„MANIFEST.MF
Manifest-Version: 1.0
Bundle-Name: Bundle A
Bundle-SymbolicName: com.example.bundleA
Bundle-Version: 1.0.0
Export-Package: com.example.service
Import-Package: com.example.util

// Bundle Bçš„MANIFEST.MF
Manifest-Version: 1.0
Bundle-Name: Bundle B
Bundle-SymbolicName: com.example.bundleB
Bundle-Version: 1.0.0
Export-Package: com.example.util
```

---

## å…­ã€æ‰“ç ´åŒäº²å§”æ´¾çš„æœ€ä½³å®è·µ

### 6.1 ä½•æ—¶åº”è¯¥æ‰“ç ´åŒäº²å§”æ´¾

âœ… **åº”è¯¥æ‰“ç ´çš„åœºæ™¯**ï¼š
1. å®ç°åº”ç”¨éš”ç¦»ï¼ˆå¦‚Tomcatï¼‰
2. å®ç°çƒ­éƒ¨ç½²
3. å®ç°æ’ä»¶ç³»ç»Ÿ
4. SPIæœºåˆ¶
5. æ¨¡å—åŒ–ç³»ç»Ÿï¼ˆå¦‚OSGiï¼‰

âŒ **ä¸åº”è¯¥æ‰“ç ´çš„åœºæ™¯**ï¼š
1. æ™®é€šåº”ç”¨ç¨‹åº
2. ç®€å•çš„ç±»åŠ è½½éœ€æ±‚
3. æ²¡æœ‰ç‰¹æ®Šéš”ç¦»éœ€æ±‚

### 6.2 æ‰“ç ´åŒäº²å§”æ´¾çš„æ³¨æ„äº‹é¡¹

#### 1. ä¿æŠ¤æ ¸å¿ƒç±»

```java
public class SafeClassLoader extends ClassLoader {
    
    @Override
    public Class<?> loadClass(String name) throws ClassNotFoundException {
        // æ ¸å¿ƒç±»å¿…é¡»å§”æ´¾ç»™çˆ¶åŠ è½½å™¨
        if (name.startsWith("java.") || 
            name.startsWith("javax.") ||
            name.startsWith("sun.")) {
            return super.loadClass(name);
        }
        
        // å…¶ä»–ç±»å¯ä»¥è‡ªå·±åŠ è½½
        return findClass(name);
    }
}
```

#### 2. é¿å…ç±»åŠ è½½æ­»é”

```java
public class DeadlockSafeClassLoader extends ClassLoader {
    
    @Override
    protected Class<?> loadClass(String name, boolean resolve) 
        throws ClassNotFoundException {
        
        // ä½¿ç”¨ç±»åä½œä¸ºé”ï¼Œé¿å…æ­»é”
        synchronized (getClassLoadingLock(name)) {
            // åŠ è½½é€»è¾‘
        }
    }
}
```

#### 3. æ­£ç¡®å¤„ç†èµ„æº

```java
public class ResourceAwareClassLoader extends ClassLoader {
    
    @Override
    public URL getResource(String name) {
        // å…ˆæŸ¥æ‰¾è‡ªå·±çš„èµ„æº
        URL url = findResource(name);
        if (url != null) {
            return url;
        }
        
        // å†æŸ¥æ‰¾çˆ¶åŠ è½½å™¨çš„èµ„æº
        return super.getResource(name);
    }
}
```

### 6.3 æ€§èƒ½ä¼˜åŒ–

```java
public class OptimizedClassLoader extends ClassLoader {
    
    // ç¼“å­˜å·²åŠ è½½çš„ç±»
    private final Map<String, Class<?>> classCache = new ConcurrentHashMap<>();
    
    @Override
    protected Class<?> loadClass(String name, boolean resolve) 
        throws ClassNotFoundException {
        
        // å…ˆæŸ¥ç¼“å­˜
        Class<?> c = classCache.get(name);
        if (c != null) {
            return c;
        }
        
        // åŠ è½½ç±»
        c = super.loadClass(name, resolve);
        
        // æ”¾å…¥ç¼“å­˜
        classCache.put(name, c);
        
        return c;
    }
}
```

---

## ä¸ƒã€å®æˆ˜æ¡ˆä¾‹

### æ¡ˆä¾‹1ï¼šå®ç°ç®€å•çš„æ’ä»¶ç³»ç»Ÿ

```java
public class PluginClassLoader extends ClassLoader {
    
    private String pluginPath;
    
    public PluginClassLoader(String pluginPath, ClassLoader parent) {
        super(parent);
        this.pluginPath = pluginPath;
    }
    
    @Override
    public Class<?> loadClass(String name) throws ClassNotFoundException {
        // æ ¸å¿ƒç±»å§”æ´¾ç»™çˆ¶åŠ è½½å™¨
        if (name.startsWith("java.") || name.startsWith("com.example.api.")) {
            return super.loadClass(name);
        }
        
        // æ’ä»¶ç±»è‡ªå·±åŠ è½½
        if (name.startsWith("com.example.plugin.")) {
            return findClass(name);
        }
        
        // å…¶ä»–ç±»å§”æ´¾ç»™çˆ¶åŠ è½½å™¨
        return super.loadClass(name);
    }
    
    @Override
    protected Class<?> findClass(String name) throws ClassNotFoundException {
        try {
            byte[] classData = loadClassData(name);
            return defineClass(name, classData, 0, classData.length);
        } catch (IOException e) {
            throw new ClassNotFoundException(name, e);
        }
    }
    
    private byte[] loadClassData(String name) throws IOException {
        String fileName = pluginPath + "/" + name.replace('.', '/') + ".class";
        try (InputStream is = new FileInputStream(fileName);
             ByteArrayOutputStream baos = new ByteArrayOutputStream()) {
            
            byte[] buffer = new byte[1024];
            int len;
            while ((len = is.read(buffer)) != -1) {
                baos.write(buffer, 0, len);
            }
            return baos.toByteArray();
        }
    }
}

// æ’ä»¶ç®¡ç†å™¨
public class PluginManager {
    
    private Map<String, PluginClassLoader> plugins = new ConcurrentHashMap<>();
    
    public void loadPlugin(String pluginName, String pluginPath) throws Exception {
        // åˆ›å»ºæ’ä»¶ç±»åŠ è½½å™¨
        PluginClassLoader loader = new PluginClassLoader(
            pluginPath,
            this.getClass().getClassLoader()
        );
        
        plugins.put(pluginName, loader);
        
        // åŠ è½½æ’ä»¶ä¸»ç±»
        Class<?> pluginClass = loader.loadClass("com.example.plugin." + pluginName + ".Main");
        Object plugin = pluginClass.newInstance();
        
        // åˆå§‹åŒ–æ’ä»¶
        Method initMethod = pluginClass.getMethod("init");
        initMethod.invoke(plugin);
        
        System.out.println("æ’ä»¶ " + pluginName + " åŠ è½½æˆåŠŸ");
    }
    
    public void unloadPlugin(String pluginName) {
        PluginClassLoader loader = plugins.remove(pluginName);
        if (loader != null) {
            // æ¸…ç†èµ„æº
            try {
                Method cleanupMethod = loader.loadClass("com.example.plugin." + pluginName + ".Main")
                    .getMethod("cleanup");
                cleanupMethod.invoke(null);
            } catch (Exception e) {
                e.printStackTrace();
            }
            
            // å°†ç±»åŠ è½½å™¨ç½®ä¸ºnullï¼Œç­‰å¾…GCå›æ”¶
            loader = null;
            System.gc();
            
            System.out.println("æ’ä»¶ " + pluginName + " å¸è½½æˆåŠŸ");
        }
    }
    
    public void reloadPlugin(String pluginName, String pluginPath) throws Exception {
        unloadPlugin(pluginName);
        Thread.sleep(100);  // ç­‰å¾…GC
        loadPlugin(pluginName, pluginPath);
    }
}
```

### æ¡ˆä¾‹2ï¼šå®ç°çƒ­éƒ¨ç½²

```java
public class HotDeployClassLoader extends ClassLoader {
    
    private String classPath;
    private long lastModified;
    
    public HotDeployClassLoader(String classPath) {
        this.classPath = classPath;
    }
    
    @Override
    protected Class<?> findClass(String name) throws ClassNotFoundException {
        try {
            byte[] classData = loadClassData(name);
            return defineClass(name, classData, 0, classData.length);
        } catch (IOException e) {
            throw new ClassNotFoundException(name, e);
        }
    }
    
    private byte[] loadClassData(String name) throws IOException {
        String fileName = classPath + "/" + name.replace('.', '/') + ".class";
        File file = new File(fileName);
        lastModified = file.lastModified();
        
        try (InputStream is = new FileInputStream(file);
             ByteArrayOutputStream baos = new ByteArrayOutputStream()) {
            
            byte[] buffer = new byte[1024];
            int len;
            while ((len = is.read(buffer)) != -1) {
                baos.write(buffer, 0, len);
            }
            return baos.toByteArray();
        }
    }
    
    public boolean isModified(String name) {
        String fileName = classPath + "/" + name.replace('.', '/') + ".class";
        File file = new File(fileName);
        return file.lastModified() > lastModified;
    }
}

// çƒ­éƒ¨ç½²ç®¡ç†å™¨
public class HotDeployManager {
    
    private String classPath;
    private String className;
    private HotDeployClassLoader loader;
    private Object instance;
    
    public HotDeployManager(String classPath, String className) {
        this.classPath = classPath;
        this.className = className;
        reload();
    }
    
    public void reload() {
        try {
            // åˆ›å»ºæ–°çš„ç±»åŠ è½½å™¨
            loader = new HotDeployClassLoader(classPath);
            
            // åŠ è½½ç±»
            Class<?> clazz = loader.loadClass(className);
            
            // åˆ›å»ºå®ä¾‹
            instance = clazz.newInstance();
            
            System.out.println("ç±» " + className + " é‡æ–°åŠ è½½æˆåŠŸ");
        } catch (Exception e) {
            e.printStackTrace();
        }
    }
    
    public Object invoke(String methodName, Object... args) throws Exception {
        if (loader.isModified(className)) {
            reload();
        }
        
        Class<?> clazz = instance.getClass();
        Method method = clazz.getMethod(methodName);
        return method.invoke(instance, args);
    }
    
    public static void main(String[] args) throws Exception {
        HotDeployManager manager = new HotDeployManager(
            "/path/to/classes",
            "com.example.Service"
        );
        
        while (true) {
            // è°ƒç”¨æ–¹æ³•
            Object result = manager.invoke("execute");
            System.out.println("ç»“æœ: " + result);
            
            // ç­‰å¾…5ç§’
            Thread.sleep(5000);
        }
    }
}
```

---

## å…«ã€å¸¸è§é—®é¢˜

### Q1: ä»€ä¹ˆæ—¶å€™å¿…é¡»æ‰“ç ´åŒäº²å§”æ´¾ï¼Ÿ

**A**: 
1. åŸºç¡€ç±»éœ€è¦è°ƒç”¨ç”¨æˆ·ä»£ç ï¼ˆå¦‚JDBCï¼‰
2. éœ€è¦å®ç°åº”ç”¨éš”ç¦»ï¼ˆå¦‚Tomcatï¼‰
3. éœ€è¦å®ç°çƒ­éƒ¨ç½²
4. éœ€è¦å®ç°æ¨¡å—åŒ–ï¼ˆå¦‚OSGiï¼‰

### Q2: å¦‚ä½•å®‰å…¨åœ°æ‰“ç ´åŒäº²å§”æ´¾ï¼Ÿ

**A**: 
1. æ ¸å¿ƒç±»ï¼ˆjava.*ã€javax.*ï¼‰å¿…é¡»å§”æ´¾ç»™çˆ¶åŠ è½½å™¨
2. ä½¿ç”¨synchronizedé¿å…æ­»é”
3. æ­£ç¡®å¤„ç†èµ„æºåŠ è½½
4. åŠæ—¶æ¸…ç†ç±»åŠ è½½å™¨å¼•ç”¨

### Q3: çº¿ç¨‹ä¸Šä¸‹æ–‡ç±»åŠ è½½å™¨çš„é»˜è®¤å€¼æ˜¯ä»€ä¹ˆï¼Ÿ

**A**: 
- é»˜è®¤æ˜¯Application ClassLoader
- å¯ä»¥é€šè¿‡`Thread.setContextClassLoader()`ä¿®æ”¹

### Q4: Tomcatä¸ºä»€ä¹ˆé»˜è®¤ä¸éµå¾ªåŒäº²å§”æ´¾ï¼Ÿ

**A**: 
- å®ç°åº”ç”¨éš”ç¦»
- å…è®¸ä¸åŒåº”ç”¨ä½¿ç”¨ä¸åŒç‰ˆæœ¬çš„ç±»åº“
- ä¼˜å…ˆåŠ è½½åº”ç”¨è‡ªå·±çš„ç±»

### Q5: å¦‚ä½•é¿å…ç±»åŠ è½½å™¨å†…å­˜æ³„æ¼ï¼Ÿ

**A**: 
1. åŠæ—¶æ¸…ç†ç±»åŠ è½½å™¨å¼•ç”¨
2. é¿å…åœ¨é™æ€å­—æ®µä¸­æŒæœ‰ç±»åŠ è½½å™¨
3. ä½¿ç”¨å¼±å¼•ç”¨
4. å®šæœŸæ£€æŸ¥å†…å­˜

---

## ä¹ã€æ€»ç»“

### 9.1 æ‰“ç ´åŒäº²å§”æ´¾çš„æ–¹å¼

| æ–¹å¼ | å®ç° | åº”ç”¨åœºæ™¯ |
|------|------|---------|
| é‡å†™loadClass() | æ”¹å˜å§”æ´¾é€»è¾‘ | è‡ªå®šä¹‰åŠ è½½é¡ºåº |
| çº¿ç¨‹ä¸Šä¸‹æ–‡ç±»åŠ è½½å™¨ | å‘ä¸‹å§”æ´¾ | SPIæœºåˆ¶ |
| OSGi | ç½‘çŠ¶ç»“æ„ | æ¨¡å—åŒ–ç³»ç»Ÿ |

### 9.2 å…¸å‹åº”ç”¨

| åº”ç”¨ | æ–¹å¼ | ç›®çš„ |
|------|------|------|
| JDBC | çº¿ç¨‹ä¸Šä¸‹æ–‡ç±»åŠ è½½å™¨ | åŠ è½½é©±åŠ¨ |
| Tomcat | è‡ªå®šä¹‰ç±»åŠ è½½å™¨æ¶æ„ | åº”ç”¨éš”ç¦» |
| OSGi | ç½‘çŠ¶ç±»åŠ è½½å™¨ | æ¨¡å—åŒ– |
| çƒ­éƒ¨ç½² | é‡æ–°åˆ›å»ºç±»åŠ è½½å™¨ | ä»£ç çƒ­æ›¿æ¢ |

### 9.3 æœ€ä½³å®è·µ

1. âœ… ä¼˜å…ˆä½¿ç”¨åŒäº²å§”æ´¾æ¨¡å‹
2. âœ… åªåœ¨å¿…è¦æ—¶æ‰“ç ´åŒäº²å§”æ´¾
3. âœ… ä¿æŠ¤æ ¸å¿ƒç±»ä¸è¢«è¦†ç›–
4. âœ… æ­£ç¡®å¤„ç†ç±»åŠ è½½å™¨ç”Ÿå‘½å‘¨æœŸ
5. âœ… é¿å…ç±»åŠ è½½å™¨å†…å­˜æ³„æ¼

---

## ğŸ“š å‚è€ƒèµ„æ–™

1. **ã€Šæ·±å…¥ç†è§£Javaè™šæ‹Ÿæœºï¼ˆç¬¬3ç‰ˆï¼‰ã€‹** - å‘¨å¿—æ˜
2. **ã€ŠJavaè™šæ‹Ÿæœºè§„èŒƒã€‹** - https://docs.oracle.com/javase/specs/
3. **Tomcatæºç ** - https://github.com/apache/tomcat
4. **OSGiè§„èŒƒ** - https://www.osgi.org/

---

**ä¸‹ä¸€ç¯‡**ï¼š[ç±»åŠ è½½å™¨éš”ç¦»ä¸çƒ­éƒ¨ç½²](./04_ç±»åŠ è½½å™¨éš”ç¦»ä¸çƒ­éƒ¨ç½².md)
