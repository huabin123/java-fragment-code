# ç±»åŠ è½½å™¨ä¸åŒäº²å§”æ´¾æ¨¡å‹

## ğŸ“š æ¦‚è¿°

ç±»åŠ è½½å™¨ï¼ˆClassLoaderï¼‰æ˜¯Javaè™šæ‹Ÿæœºæä¾›ç»™åº”ç”¨ç¨‹åºå»å®ç°è·å–ç±»å’Œæ¥å£å­—èŠ‚ç æ•°æ®çš„æŠ€æœ¯ã€‚åŒäº²å§”æ´¾æ¨¡å‹æ˜¯ç±»åŠ è½½å™¨çš„æ ¸å¿ƒæœºåˆ¶ï¼Œä¿è¯äº†Javaç¨‹åºçš„ç¨³å®šè¿è¡Œã€‚

## ğŸ¯ æ ¸å¿ƒé—®é¢˜

- â“ ä»€ä¹ˆæ˜¯ç±»åŠ è½½å™¨ï¼Ÿæœ‰å“ªäº›ç±»å‹ï¼Ÿ
- â“ ä»€ä¹ˆæ˜¯åŒäº²å§”æ´¾æ¨¡å‹ï¼Ÿ
- â“ ä¸ºä»€ä¹ˆéœ€è¦åŒäº²å§”æ´¾æ¨¡å‹ï¼Ÿ
- â“ åŒäº²å§”æ´¾æ¨¡å‹å¦‚ä½•å·¥ä½œï¼Ÿ
- â“ å¦‚ä½•è‡ªå®šä¹‰ç±»åŠ è½½å™¨ï¼Ÿ
- â“ ç±»çš„å”¯ä¸€æ€§å¦‚ä½•ç¡®å®šï¼Ÿ

---

## ä¸€ã€ç±»åŠ è½½å™¨æ¦‚è¿°

### 1.1 ç±»åŠ è½½å™¨çš„ä½œç”¨

ç±»åŠ è½½å™¨è´Ÿè´£è¯»å–Javaå­—èŠ‚ä»£ç ï¼Œå¹¶è½¬æ¢æˆ`java.lang.Class`ç±»çš„ä¸€ä¸ªå®ä¾‹ã€‚

```java
// ç±»åŠ è½½å™¨çš„æ ¸å¿ƒæ–¹æ³•
public abstract class ClassLoader {
    // åŠ è½½ç±»
    public Class<?> loadClass(String name) throws ClassNotFoundException {
        // ...
    }
    
    // æŸ¥æ‰¾ç±»ï¼ˆç”±å­ç±»å®ç°ï¼‰
    protected Class<?> findClass(String name) throws ClassNotFoundException {
        // ...
    }
    
    // å®šä¹‰ç±»
    protected final Class<?> defineClass(String name, byte[] b, int off, int len) {
        // ...
    }
}
```

### 1.2 ç±»åŠ è½½å™¨çš„å±‚æ¬¡ç»“æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Bootstrap ClassLoader              â”‚  å¯åŠ¨ç±»åŠ è½½å™¨ï¼ˆC++å®ç°ï¼‰
â”‚  åŠ è½½ï¼š<JAVA_HOME>/lib              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â†‘ çˆ¶åŠ è½½å™¨
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Extension ClassLoader              â”‚  æ‰©å±•ç±»åŠ è½½å™¨
â”‚  åŠ è½½ï¼š<JAVA_HOME>/lib/ext          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â†‘ çˆ¶åŠ è½½å™¨
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Application ClassLoader            â”‚  åº”ç”¨ç¨‹åºç±»åŠ è½½å™¨
â”‚  åŠ è½½ï¼šClassPath                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â†‘ çˆ¶åŠ è½½å™¨
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Custom ClassLoader                 â”‚  è‡ªå®šä¹‰ç±»åŠ è½½å™¨
â”‚  åŠ è½½ï¼šç”¨æˆ·æŒ‡å®šè·¯å¾„                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## äºŒã€JVMå†…ç½®çš„ç±»åŠ è½½å™¨

### 2.1 å¯åŠ¨ç±»åŠ è½½å™¨ï¼ˆBootstrap ClassLoaderï¼‰

#### ç‰¹ç‚¹

- ç”±C++å®ç°ï¼Œæ˜¯è™šæ‹Ÿæœºè‡ªèº«çš„ä¸€éƒ¨åˆ†
- è´Ÿè´£åŠ è½½å­˜æ”¾åœ¨`<JAVA_HOME>/lib`ç›®å½•ä¸­çš„æ ¸å¿ƒç±»åº“
- æˆ–è€…è¢«`-Xbootclasspath`å‚æ•°æŒ‡å®šçš„è·¯å¾„ä¸­çš„ç±»åº“
- æ— æ³•è¢«Javaç¨‹åºç›´æ¥å¼•ç”¨

#### åŠ è½½çš„ç±»åº“

```
rt.jar          - Javaè¿è¡Œæ—¶æ ¸å¿ƒç±»åº“
resources.jar   - èµ„æºæ–‡ä»¶
charsets.jar    - å­—ç¬¦é›†
jce.jar         - åŠ å¯†æ‰©å±•
jsse.jar        - å®‰å…¨å¥—æ¥å­—æ‰©å±•
```

#### ç¤ºä¾‹

```java
public class BootstrapClassLoaderDemo {
    public static void main(String[] args) {
        // Stringç±»ç”±å¯åŠ¨ç±»åŠ è½½å™¨åŠ è½½
        ClassLoader classLoader = String.class.getClassLoader();
        System.out.println("Stringç±»çš„ç±»åŠ è½½å™¨: " + classLoader);  // null
        
        // å¯åŠ¨ç±»åŠ è½½å™¨åŠ è½½çš„è·¯å¾„
        String bootClassPath = System.getProperty("sun.boot.class.path");
        System.out.println("å¯åŠ¨ç±»åŠ è½½å™¨åŠ è½½è·¯å¾„:");
        for (String path : bootClassPath.split(":")) {
            System.out.println("  " + path);
        }
    }
}

// è¾“å‡ºï¼š
// Stringç±»çš„ç±»åŠ è½½å™¨: null
// å¯åŠ¨ç±»åŠ è½½å™¨åŠ è½½è·¯å¾„:
//   /Library/Java/JavaVirtualMachines/jdk1.8.0_301.jdk/Contents/Home/jre/lib/resources.jar
//   /Library/Java/JavaVirtualMachines/jdk1.8.0_301.jdk/Contents/Home/jre/lib/rt.jar
//   ...
```

### 2.2 æ‰©å±•ç±»åŠ è½½å™¨ï¼ˆExtension ClassLoaderï¼‰

#### ç‰¹ç‚¹

- ç”±Javaå®ç°ï¼Œç±»åä¸º`sun.misc.Launcher$ExtClassLoader`
- è´Ÿè´£åŠ è½½`<JAVA_HOME>/lib/ext`ç›®å½•ä¸­çš„ç±»åº“
- æˆ–è€…è¢«`java.ext.dirs`ç³»ç»Ÿå˜é‡æŒ‡å®šçš„è·¯å¾„ä¸­çš„ç±»åº“
- å¼€å‘è€…å¯ä»¥ç›´æ¥ä½¿ç”¨æ‰©å±•ç±»åŠ è½½å™¨

#### åŠ è½½çš„ç±»åº“

```
dnsns.jar       - DNSå‘½åæœåŠ¡
localedata.jar  - æœ¬åœ°åŒ–æ•°æ®
sunec.jar       - æ¤­åœ†æ›²çº¿åŠ å¯†
sunjce_provider.jar - JCEæä¾›è€…
zipfs.jar       - ZIPæ–‡ä»¶ç³»ç»Ÿ
```

#### ç¤ºä¾‹

```java
public class ExtensionClassLoaderDemo {
    public static void main(String[] args) {
        // è·å–æ‰©å±•ç±»åŠ è½½å™¨
        ClassLoader extClassLoader = ClassLoader.getSystemClassLoader().getParent();
        System.out.println("æ‰©å±•ç±»åŠ è½½å™¨: " + extClassLoader);
        
        // æ‰©å±•ç±»åŠ è½½å™¨åŠ è½½çš„è·¯å¾„
        String extDirs = System.getProperty("java.ext.dirs");
        System.out.println("æ‰©å±•ç±»åŠ è½½å™¨åŠ è½½è·¯å¾„:");
        for (String path : extDirs.split(":")) {
            System.out.println("  " + path);
        }
    }
}

// è¾“å‡ºï¼š
// æ‰©å±•ç±»åŠ è½½å™¨: sun.misc.Launcher$ExtClassLoader@...
// æ‰©å±•ç±»åŠ è½½å™¨åŠ è½½è·¯å¾„:
//   /Users/xxx/Library/Java/Extensions
//   /Library/Java/JavaVirtualMachines/jdk1.8.0_301.jdk/Contents/Home/jre/lib/ext
//   /Library/Java/Extensions
//   /Network/Library/Java/Extensions
//   /System/Library/Java/Extensions
//   /usr/lib/java
```

### 2.3 åº”ç”¨ç¨‹åºç±»åŠ è½½å™¨ï¼ˆApplication ClassLoaderï¼‰

#### ç‰¹ç‚¹

- ç”±Javaå®ç°ï¼Œç±»åä¸º`sun.misc.Launcher$AppClassLoader`
- è´Ÿè´£åŠ è½½ç”¨æˆ·ç±»è·¯å¾„ï¼ˆClassPathï¼‰ä¸Šçš„ç±»åº“
- æ˜¯ç¨‹åºä¸­é»˜è®¤çš„ç±»åŠ è½½å™¨
- å¯ä»¥é€šè¿‡`ClassLoader.getSystemClassLoader()`è·å–

#### ç¤ºä¾‹

```java
public class ApplicationClassLoaderDemo {
    public static void main(String[] args) {
        // è·å–åº”ç”¨ç¨‹åºç±»åŠ è½½å™¨
        ClassLoader appClassLoader = ClassLoader.getSystemClassLoader();
        System.out.println("åº”ç”¨ç¨‹åºç±»åŠ è½½å™¨: " + appClassLoader);
        
        // å½“å‰ç±»çš„ç±»åŠ è½½å™¨
        ClassLoader currentClassLoader = ApplicationClassLoaderDemo.class.getClassLoader();
        System.out.println("å½“å‰ç±»çš„ç±»åŠ è½½å™¨: " + currentClassLoader);
        
        // ç±»è·¯å¾„
        String classPath = System.getProperty("java.class.path");
        System.out.println("ç±»è·¯å¾„:");
        for (String path : classPath.split(":")) {
            System.out.println("  " + path);
        }
    }
}

// è¾“å‡ºï¼š
// åº”ç”¨ç¨‹åºç±»åŠ è½½å™¨: sun.misc.Launcher$AppClassLoader@...
// å½“å‰ç±»çš„ç±»åŠ è½½å™¨: sun.misc.Launcher$AppClassLoader@...
// ç±»è·¯å¾„:
//   /Users/xxx/project/target/classes
//   /Users/xxx/.m2/repository/...
```

### 2.4 ç±»åŠ è½½å™¨å¯¹æ¯”

| ç±»åŠ è½½å™¨ | å®ç°è¯­è¨€ | çˆ¶åŠ è½½å™¨ | åŠ è½½è·¯å¾„ | è·å–æ–¹å¼ |
|---------|---------|---------|---------|---------|
| Bootstrap | C++ | æ—  | `<JAVA_HOME>/lib` | null |
| Extension | Java | Bootstrap | `<JAVA_HOME>/lib/ext` | `getParent()` |
| Application | Java | Extension | ClassPath | `getSystemClassLoader()` |
| Custom | Java | Application | è‡ªå®šä¹‰ | è‡ªå·±åˆ›å»º |

---

## ä¸‰ã€åŒäº²å§”æ´¾æ¨¡å‹

### 3.1 ä»€ä¹ˆæ˜¯åŒäº²å§”æ´¾æ¨¡å‹

åŒäº²å§”æ´¾æ¨¡å‹ï¼ˆParent Delegation Modelï¼‰æ˜¯ç±»åŠ è½½å™¨çš„å·¥ä½œæ¨¡å¼ï¼š

```
å½“ä¸€ä¸ªç±»åŠ è½½å™¨æ”¶åˆ°ç±»åŠ è½½è¯·æ±‚æ—¶ï¼š
1. é¦–å…ˆä¸ä¼šè‡ªå·±å°è¯•åŠ è½½è¿™ä¸ªç±»
2. è€Œæ˜¯æŠŠè¯·æ±‚å§”æ´¾ç»™çˆ¶ç±»åŠ è½½å™¨å®Œæˆ
3. æ¯ä¸€å±‚éƒ½æ˜¯å¦‚æ­¤
4. åªæœ‰å½“çˆ¶åŠ è½½å™¨åé¦ˆæ— æ³•å®ŒæˆåŠ è½½æ—¶
5. å­åŠ è½½å™¨æ‰ä¼šå°è¯•è‡ªå·±åŠ è½½
```

### 3.2 åŒäº²å§”æ´¾æ¨¡å‹çš„å®ç°

```java
// java.lang.ClassLoader
protected Class<?> loadClass(String name, boolean resolve)
    throws ClassNotFoundException
{
    synchronized (getClassLoadingLock(name)) {
        // 1. é¦–å…ˆæ£€æŸ¥ç±»æ˜¯å¦å·²ç»è¢«åŠ è½½
        Class<?> c = findLoadedClass(name);
        if (c == null) {
            long t0 = System.nanoTime();
            try {
                // 2. å¦‚æœæ²¡æœ‰è¢«åŠ è½½ï¼Œå§”æ´¾ç»™çˆ¶åŠ è½½å™¨
                if (parent != null) {
                    c = parent.loadClass(name, false);
                } else {
                    // 3. å¦‚æœçˆ¶åŠ è½½å™¨ä¸ºnullï¼Œä½¿ç”¨å¯åŠ¨ç±»åŠ è½½å™¨
                    c = findBootstrapClassOrNull(name);
                }
            } catch (ClassNotFoundException e) {
                // çˆ¶åŠ è½½å™¨æ— æ³•åŠ è½½ï¼ŒæŠ›å‡ºClassNotFoundException
            }

            if (c == null) {
                // 4. å¦‚æœçˆ¶åŠ è½½å™¨æ— æ³•åŠ è½½ï¼Œè‡ªå·±å°è¯•åŠ è½½
                long t1 = System.nanoTime();
                c = findClass(name);

                // è®°å½•ç»Ÿè®¡ä¿¡æ¯
                sun.misc.PerfCounter.getParentDelegationTime().addTime(t1 - t0);
                sun.misc.PerfCounter.getFindClassTime().addElapsedTimeFrom(t1);
                sun.misc.PerfCounter.getFindClasses().increment();
            }
        }
        if (resolve) {
            // 5. é“¾æ¥ç±»
            resolveClass(c);
        }
        return c;
    }
}
```

### 3.3 åŒäº²å§”æ´¾æ¨¡å‹çš„å·¥ä½œæµç¨‹

```
åŠ è½½ com.example.User ç±»

Step 1: Application ClassLoader æ”¶åˆ°è¯·æ±‚
        â†“ å§”æ´¾ç»™çˆ¶åŠ è½½å™¨
Step 2: Extension ClassLoader æ”¶åˆ°è¯·æ±‚
        â†“ å§”æ´¾ç»™çˆ¶åŠ è½½å™¨
Step 3: Bootstrap ClassLoader æ”¶åˆ°è¯·æ±‚
        â†“ å°è¯•åŠ è½½
        âœ— åœ¨ <JAVA_HOME>/lib ä¸­æ‰¾ä¸åˆ°
        â†“ è¿”å›å¤±è´¥
Step 4: Extension ClassLoader å°è¯•åŠ è½½
        âœ— åœ¨ <JAVA_HOME>/lib/ext ä¸­æ‰¾ä¸åˆ°
        â†“ è¿”å›å¤±è´¥
Step 5: Application ClassLoader å°è¯•åŠ è½½
        âœ“ åœ¨ ClassPath ä¸­æ‰¾åˆ°
        â†“ åŠ è½½æˆåŠŸ
è¿”å› Class å¯¹è±¡
```

### 3.4 åŒäº²å§”æ´¾æ¨¡å‹ç¤ºä¾‹

```java
public class ParentDelegationDemo {
    public static void main(String[] args) throws Exception {
        // è‡ªå®šä¹‰ç±»åŠ è½½å™¨
        ClassLoader customLoader = new CustomClassLoader();
        
        // åŠ è½½Stringç±»ï¼ˆä¼šå§”æ´¾åˆ°Bootstrap ClassLoaderï¼‰
        Class<?> stringClass = customLoader.loadClass("java.lang.String");
        System.out.println("Stringç±»çš„ç±»åŠ è½½å™¨: " + stringClass.getClassLoader());
        
        // åŠ è½½è‡ªå®šä¹‰ç±»ï¼ˆä¼šç”±CustomClassLoaderåŠ è½½ï¼‰
        Class<?> userClass = customLoader.loadClass("com.example.User");
        System.out.println("Userç±»çš„ç±»åŠ è½½å™¨: " + userClass.getClassLoader());
    }
}

// è¾“å‡ºï¼š
// Stringç±»çš„ç±»åŠ è½½å™¨: nullï¼ˆBootstrap ClassLoaderï¼‰
// Userç±»çš„ç±»åŠ è½½å™¨: CustomClassLoader@...
```

---

## å››ã€åŒäº²å§”æ´¾æ¨¡å‹çš„ä¼˜åŠ¿

### 4.1 é¿å…ç±»çš„é‡å¤åŠ è½½

```java
// åœºæ™¯ï¼šå¤šä¸ªç±»åŠ è½½å™¨åŠ è½½åŒä¸€ä¸ªç±»
public class AvoidDuplicateLoadingDemo {
    public static void main(String[] args) throws Exception {
        ClassLoader loader1 = new CustomClassLoader();
        ClassLoader loader2 = new CustomClassLoader();
        
        // ä¸¤ä¸ªç±»åŠ è½½å™¨åŠ è½½Stringç±»
        Class<?> class1 = loader1.loadClass("java.lang.String");
        Class<?> class2 = loader2.loadClass("java.lang.String");
        
        // ç”±äºåŒäº²å§”æ´¾ï¼Œéƒ½å§”æ´¾ç»™Bootstrap ClassLoader
        // æ‰€ä»¥åŠ è½½çš„æ˜¯åŒä¸€ä¸ªç±»
        System.out.println(class1 == class2);  // true
    }
}
```

### 4.2 ä¿æŠ¤æ ¸å¿ƒç±»åº“

```java
// å°è¯•è‡ªå®šä¹‰java.lang.Stringç±»
package java.lang;

public class String {
    // æ¶æ„ä»£ç 
    public void hack() {
        System.out.println("I'm a fake String!");
    }
}

// è¿è¡Œæ—¶ä¼šæŠ¥é”™ï¼š
// java.lang.SecurityException: Prohibited package name: java.lang
```

**åŸå› **ï¼š
- åŒäº²å§”æ´¾æ¨¡å‹ä¼šå…ˆå§”æ´¾ç»™Bootstrap ClassLoader
- Bootstrap ClassLoaderä¼šåŠ è½½JDKè‡ªå¸¦çš„Stringç±»
- è‡ªå®šä¹‰çš„Stringç±»æ°¸è¿œä¸ä¼šè¢«åŠ è½½

### 4.3 ä¿è¯ç±»çš„å”¯ä¸€æ€§

```java
// ç±»çš„å”¯ä¸€æ€§ç”±ç±»åŠ è½½å™¨å’Œç±»æœ¬èº«å…±åŒå†³å®š
public class ClassUniquenessDemo {
    public static void main(String[] args) throws Exception {
        ClassLoader loader1 = new CustomClassLoader();
        ClassLoader loader2 = new CustomClassLoader();
        
        // åŠ è½½æ ¸å¿ƒç±»ï¼ˆåŒäº²å§”æ´¾ï¼‰
        Class<?> string1 = loader1.loadClass("java.lang.String");
        Class<?> string2 = loader2.loadClass("java.lang.String");
        System.out.println("Stringç±»ç›¸åŒ: " + (string1 == string2));  // true
        
        // åŠ è½½è‡ªå®šä¹‰ç±»ï¼ˆä¸åŒçš„ç±»åŠ è½½å™¨ï¼‰
        Class<?> user1 = loader1.loadClass("com.example.User");
        Class<?> user2 = loader2.loadClass("com.example.User");
        System.out.println("Userç±»ç›¸åŒ: " + (user1 == user2));  // false
    }
}
```

### 4.4 å®ç°ç±»çš„éš”ç¦»

```java
// ä¸åŒçš„ç±»åŠ è½½å™¨å¯ä»¥åŠ è½½ç›¸åŒçš„ç±»ï¼Œå®ç°éš”ç¦»
public class ClassIsolationDemo {
    public static void main(String[] args) throws Exception {
        // æ’ä»¶1çš„ç±»åŠ è½½å™¨
        ClassLoader plugin1Loader = new PluginClassLoader("plugin1");
        Class<?> plugin1Class = plugin1Loader.loadClass("com.example.Plugin");
        Object plugin1 = plugin1Class.newInstance();
        
        // æ’ä»¶2çš„ç±»åŠ è½½å™¨
        ClassLoader plugin2Loader = new PluginClassLoader("plugin2");
        Class<?> plugin2Class = plugin2Loader.loadClass("com.example.Plugin");
        Object plugin2 = plugin2Class.newInstance();
        
        // ä¸¤ä¸ªæ’ä»¶çš„ç±»æ˜¯ä¸åŒçš„
        System.out.println(plugin1Class == plugin2Class);  // false
        System.out.println(plugin1 instanceof plugin2Class);  // ç¼–è¯‘é”™è¯¯
    }
}
```

---

## äº”ã€ç±»çš„å”¯ä¸€æ€§

### 5.1 ç±»çš„å”¯ä¸€æ€§åˆ¤å®š

åœ¨JVMä¸­ï¼Œåˆ¤æ–­ä¸¤ä¸ªç±»æ˜¯å¦"ç›¸åŒ"ï¼Œéœ€è¦æ»¡è¶³ä»¥ä¸‹æ¡ä»¶ï¼š

1. **ç±»çš„å…¨é™å®šåç›¸åŒ**
2. **åŠ è½½è¿™ä¸ªç±»çš„ç±»åŠ è½½å™¨ç›¸åŒ**

```java
public class ClassEqualityDemo {
    public static void main(String[] args) throws Exception {
        // ä½¿ç”¨ä¸åŒçš„ç±»åŠ è½½å™¨åŠ è½½åŒä¸€ä¸ªç±»
        ClassLoader loader1 = new CustomClassLoader();
        ClassLoader loader2 = new CustomClassLoader();
        
        Class<?> class1 = loader1.loadClass("com.example.User");
        Class<?> class2 = loader2.loadClass("com.example.User");
        
        // ç±»åç›¸åŒï¼Œä½†ç±»åŠ è½½å™¨ä¸åŒ
        System.out.println("ç±»åç›¸åŒ: " + class1.getName().equals(class2.getName()));  // true
        System.out.println("ç±»ç›¸åŒ: " + (class1 == class2));  // false
        
        // åˆ›å»ºå®ä¾‹
        Object obj1 = class1.newInstance();
        Object obj2 = class2.newInstance();
        
        // instanceofåˆ¤æ–­
        System.out.println(obj1 instanceof class1);  // ç¼–è¯‘é”™è¯¯
        System.out.println(class1.isInstance(obj1));  // true
        System.out.println(class1.isInstance(obj2));  // false
    }
}
```

### 5.2 ç±»åŠ è½½å™¨çš„å‘½åç©ºé—´

æ¯ä¸ªç±»åŠ è½½å™¨éƒ½æœ‰è‡ªå·±çš„å‘½åç©ºé—´ï¼Œå‘½åç©ºé—´ç”±è¯¥åŠ è½½å™¨åŠæ‰€æœ‰çˆ¶åŠ è½½å™¨æ‰€åŠ è½½çš„ç±»ç»„æˆã€‚

```
Bootstrap ClassLoaderçš„å‘½åç©ºé—´ï¼š
    - java.lang.String
    - java.lang.Object
    - ...

Extension ClassLoaderçš„å‘½åç©ºé—´ï¼š
    - Bootstrapçš„æ‰€æœ‰ç±»
    - javax.crypto.*
    - ...

Application ClassLoaderçš„å‘½åç©ºé—´ï¼š
    - Bootstrapçš„æ‰€æœ‰ç±»
    - Extensionçš„æ‰€æœ‰ç±»
    - com.example.*
    - ...
```

**è§„åˆ™**ï¼š
- å­åŠ è½½å™¨å¯ä»¥çœ‹è§çˆ¶åŠ è½½å™¨åŠ è½½çš„ç±»
- çˆ¶åŠ è½½å™¨çœ‹ä¸è§å­åŠ è½½å™¨åŠ è½½çš„ç±»
- å…„å¼ŸåŠ è½½å™¨ä¹‹é—´äº’ç›¸çœ‹ä¸è§

```java
public class NamespaceDemo {
    public static void main(String[] args) throws Exception {
        ClassLoader appLoader = ClassLoader.getSystemClassLoader();
        ClassLoader extLoader = appLoader.getParent();
        
        // Application ClassLoaderå¯ä»¥çœ‹åˆ°Extension ClassLoaderåŠ è½½çš„ç±»
        Class<?> class1 = appLoader.loadClass("javax.crypto.Cipher");
        System.out.println("æˆåŠŸåŠ è½½: " + class1.getName());
        
        // Extension ClassLoaderçœ‹ä¸åˆ°Application ClassLoaderåŠ è½½çš„ç±»
        try {
            Class<?> class2 = extLoader.loadClass("com.example.User");
        } catch (ClassNotFoundException e) {
            System.out.println("Extension ClassLoaderæ— æ³•åŠ è½½Userç±»");
        }
    }
}
```

---

## å…­ã€è‡ªå®šä¹‰ç±»åŠ è½½å™¨

### 6.1 ä¸ºä»€ä¹ˆéœ€è¦è‡ªå®šä¹‰ç±»åŠ è½½å™¨

1. **éš”ç¦»åŠ è½½ç±»**ï¼šä¸­é—´ä»¶ã€æ’ä»¶ç³»ç»Ÿ
2. **ä¿®æ”¹ç±»åŠ è½½æ–¹å¼**ï¼šæŒ‰éœ€åŠ è½½ã€å»¶è¿ŸåŠ è½½
3. **æ‰©å±•åŠ è½½æº**ï¼šä»æ•°æ®åº“ã€ç½‘ç»œã€åŠ å¯†æ–‡ä»¶åŠ è½½
4. **é˜²æ­¢æºç æ³„æ¼**ï¼šåŠ å¯†classæ–‡ä»¶

### 6.2 è‡ªå®šä¹‰ç±»åŠ è½½å™¨çš„å®ç°æ­¥éª¤

```java
public class CustomClassLoader extends ClassLoader {
    
    private String classPath;
    
    public CustomClassLoader(String classPath) {
        this.classPath = classPath;
    }
    
    // æ ¸å¿ƒæ–¹æ³•ï¼šæŸ¥æ‰¾ç±»
    @Override
    protected Class<?> findClass(String name) throws ClassNotFoundException {
        try {
            // 1. è¯»å–ç±»æ–‡ä»¶çš„å­—èŠ‚ç 
            byte[] classData = loadClassData(name);
            if (classData == null) {
                throw new ClassNotFoundException();
            }
            
            // 2. å°†å­—èŠ‚ç è½¬æ¢ä¸ºClasså¯¹è±¡
            return defineClass(name, classData, 0, classData.length);
        } catch (IOException e) {
            throw new ClassNotFoundException(name, e);
        }
    }
    
    // åŠ è½½ç±»æ–‡ä»¶çš„å­—èŠ‚ç 
    private byte[] loadClassData(String name) throws IOException {
        // å°†ç±»åè½¬æ¢ä¸ºæ–‡ä»¶è·¯å¾„
        String fileName = classPath + "/" + name.replace('.', '/') + ".class";
        
        // è¯»å–æ–‡ä»¶
        try (InputStream is = new FileInputStream(fileName);
             ByteArrayOutputStream baos = new ByteArrayOutputStream()) {
            
            byte[] buffer = new byte[1024];
            int len;
            while ((len = is.read(buffer)) != -1) {
                baos.write(buffer, 0, len);
            }
            return baos.toByteArray();
        }
    }
}
```

### 6.3 ä½¿ç”¨è‡ªå®šä¹‰ç±»åŠ è½½å™¨

```java
public class CustomClassLoaderDemo {
    public static void main(String[] args) throws Exception {
        // åˆ›å»ºè‡ªå®šä¹‰ç±»åŠ è½½å™¨
        CustomClassLoader loader = new CustomClassLoader("/path/to/classes");
        
        // åŠ è½½ç±»
        Class<?> clazz = loader.loadClass("com.example.User");
        System.out.println("ç±»åŠ è½½å™¨: " + clazz.getClassLoader());
        
        // åˆ›å»ºå®ä¾‹
        Object obj = clazz.newInstance();
        
        // è°ƒç”¨æ–¹æ³•ï¼ˆä½¿ç”¨åå°„ï¼‰
        Method method = clazz.getMethod("getName");
        String name = (String) method.invoke(obj);
        System.out.println("Name: " + name);
    }
}
```

### 6.4 åŠ å¯†ç±»åŠ è½½å™¨

```java
public class EncryptedClassLoader extends ClassLoader {
    
    private String classPath;
    private String key;
    
    public EncryptedClassLoader(String classPath, String key) {
        this.classPath = classPath;
        this.key = key;
    }
    
    @Override
    protected Class<?> findClass(String name) throws ClassNotFoundException {
        try {
            // 1. è¯»å–åŠ å¯†çš„ç±»æ–‡ä»¶
            byte[] encryptedData = loadEncryptedClassData(name);
            
            // 2. è§£å¯†
            byte[] classData = decrypt(encryptedData, key);
            
            // 3. å®šä¹‰ç±»
            return defineClass(name, classData, 0, classData.length);
        } catch (Exception e) {
            throw new ClassNotFoundException(name, e);
        }
    }
    
    private byte[] loadEncryptedClassData(String name) throws IOException {
        String fileName = classPath + "/" + name.replace('.', '/') + ".encrypted";
        try (InputStream is = new FileInputStream(fileName);
             ByteArrayOutputStream baos = new ByteArrayOutputStream()) {
            
            byte[] buffer = new byte[1024];
            int len;
            while ((len = is.read(buffer)) != -1) {
                baos.write(buffer, 0, len);
            }
            return baos.toByteArray();
        }
    }
    
    private byte[] decrypt(byte[] data, String key) {
        // ç®€å•çš„å¼‚æˆ–åŠ å¯†ï¼ˆå®é™…åº”ä½¿ç”¨AESç­‰ç®—æ³•ï¼‰
        byte[] result = new byte[data.length];
        byte[] keyBytes = key.getBytes();
        for (int i = 0; i < data.length; i++) {
            result[i] = (byte) (data[i] ^ keyBytes[i % keyBytes.length]);
        }
        return result;
    }
}
```

### 6.5 ç½‘ç»œç±»åŠ è½½å™¨

```java
public class NetworkClassLoader extends ClassLoader {
    
    private String baseUrl;
    
    public NetworkClassLoader(String baseUrl) {
        this.baseUrl = baseUrl;
    }
    
    @Override
    protected Class<?> findClass(String name) throws ClassNotFoundException {
        try {
            // 1. æ„å»ºURL
            String url = baseUrl + "/" + name.replace('.', '/') + ".class";
            
            // 2. ä»ç½‘ç»œä¸‹è½½ç±»æ–‡ä»¶
            byte[] classData = downloadClassData(url);
            
            // 3. å®šä¹‰ç±»
            return defineClass(name, classData, 0, classData.length);
        } catch (Exception e) {
            throw new ClassNotFoundException(name, e);
        }
    }
    
    private byte[] downloadClassData(String urlString) throws IOException {
        URL url = new URL(urlString);
        try (InputStream is = url.openStream();
             ByteArrayOutputStream baos = new ByteArrayOutputStream()) {
            
            byte[] buffer = new byte[1024];
            int len;
            while ((len = is.read(buffer)) != -1) {
                baos.write(buffer, 0, len);
            }
            return baos.toByteArray();
        }
    }
}
```

---

## ä¸ƒã€ClassLoaderçš„æ ¸å¿ƒæ–¹æ³•

### 7.1 loadClass() - åŠ è½½ç±»

```java
// åŠ è½½ç±»ï¼ˆéµå¾ªåŒäº²å§”æ´¾æ¨¡å‹ï¼‰
public Class<?> loadClass(String name) throws ClassNotFoundException {
    return loadClass(name, false);
}

protected Class<?> loadClass(String name, boolean resolve)
    throws ClassNotFoundException {
    // å®ç°åŒäº²å§”æ´¾é€»è¾‘
}
```

**ä½¿ç”¨åœºæ™¯**ï¼š
- æ­£å¸¸åŠ è½½ç±»
- éµå¾ªåŒäº²å§”æ´¾æ¨¡å‹

### 7.2 findClass() - æŸ¥æ‰¾ç±»

```java
// æŸ¥æ‰¾ç±»ï¼ˆç”±å­ç±»å®ç°ï¼‰
protected Class<?> findClass(String name) throws ClassNotFoundException {
    throw new ClassNotFoundException(name);
}
```

**ä½¿ç”¨åœºæ™¯**ï¼š
- è‡ªå®šä¹‰ç±»åŠ è½½å™¨å¿…é¡»é‡å†™æ­¤æ–¹æ³•
- å®ç°è‡ªå·±çš„ç±»æŸ¥æ‰¾é€»è¾‘

### 7.3 defineClass() - å®šä¹‰ç±»

```java
// å°†å­—èŠ‚æ•°ç»„è½¬æ¢ä¸ºClasså¯¹è±¡
protected final Class<?> defineClass(String name, byte[] b, int off, int len)
    throws ClassFormatError {
    // ...
}
```

**ä½¿ç”¨åœºæ™¯**ï¼š
- å°†å­—èŠ‚ç è½¬æ¢ä¸ºClasså¯¹è±¡
- é€šå¸¸åœ¨findClass()ä¸­è°ƒç”¨

### 7.4 resolveClass() - é“¾æ¥ç±»

```java
// é“¾æ¥æŒ‡å®šçš„ç±»
protected final void resolveClass(Class<?> c) {
    // ...
}
```

**ä½¿ç”¨åœºæ™¯**ï¼š
- é“¾æ¥ç±»ï¼ˆéªŒè¯ã€å‡†å¤‡ã€è§£æï¼‰
- é€šå¸¸ä¸éœ€è¦æ‰‹åŠ¨è°ƒç”¨

### 7.5 findLoadedClass() - æŸ¥æ‰¾å·²åŠ è½½çš„ç±»

```java
// æŸ¥æ‰¾å·²ç»è¢«åŠ è½½çš„ç±»
protected final Class<?> findLoadedClass(String name) {
    // ...
}
```

**ä½¿ç”¨åœºæ™¯**ï¼š
- æ£€æŸ¥ç±»æ˜¯å¦å·²ç»è¢«åŠ è½½
- é¿å…é‡å¤åŠ è½½

### 7.6 getParent() - è·å–çˆ¶åŠ è½½å™¨

```java
// è·å–çˆ¶ç±»åŠ è½½å™¨
public final ClassLoader getParent() {
    // ...
}
```

### 7.7 æ–¹æ³•è°ƒç”¨å…³ç³»

```
loadClass(String name)
    â†“
1. findLoadedClass(name)  // æ£€æŸ¥æ˜¯å¦å·²åŠ è½½
    â†“ æœªåŠ è½½
2. parent.loadClass(name)  // å§”æ´¾ç»™çˆ¶åŠ è½½å™¨
    â†“ çˆ¶åŠ è½½å™¨æ— æ³•åŠ è½½
3. findClass(name)  // è‡ªå·±æŸ¥æ‰¾
    â†“
4. defineClass(name, bytes, ...)  // å®šä¹‰ç±»
    â†“
5. resolveClass(class)  // é“¾æ¥ç±»ï¼ˆå¯é€‰ï¼‰
    â†“
è¿”å› Class å¯¹è±¡
```

---

## å…«ã€å®æˆ˜æ¡ˆä¾‹

### æ¡ˆä¾‹1ï¼šå®ç°çƒ­éƒ¨ç½²

```java
public class HotSwapClassLoader extends ClassLoader {
    
    private String classPath;
    
    public HotSwapClassLoader(String classPath) {
        this.classPath = classPath;
    }
    
    @Override
    protected Class<?> findClass(String name) throws ClassNotFoundException {
        try {
            byte[] classData = loadClassData(name);
            return defineClass(name, classData, 0, classData.length);
        } catch (IOException e) {
            throw new ClassNotFoundException(name, e);
        }
    }
    
    private byte[] loadClassData(String name) throws IOException {
        String fileName = classPath + "/" + name.replace('.', '/') + ".class";
        try (InputStream is = new FileInputStream(fileName);
             ByteArrayOutputStream baos = new ByteArrayOutputStream()) {
            
            byte[] buffer = new byte[1024];
            int len;
            while ((len = is.read(buffer)) != -1) {
                baos.write(buffer, 0, len);
            }
            return baos.toByteArray();
        }
    }
    
    // é‡æ–°åŠ è½½ç±»
    public Class<?> reload(String name) throws ClassNotFoundException {
        return findClass(name);
    }
}

// ä½¿ç”¨ç¤ºä¾‹
public class HotSwapDemo {
    public static void main(String[] args) throws Exception {
        String classPath = "/path/to/classes";
        
        while (true) {
            // æ¯æ¬¡éƒ½åˆ›å»ºæ–°çš„ç±»åŠ è½½å™¨
            HotSwapClassLoader loader = new HotSwapClassLoader(classPath);
            
            // åŠ è½½ç±»
            Class<?> clazz = loader.loadClass("com.example.Service");
            Object service = clazz.newInstance();
            
            // è°ƒç”¨æ–¹æ³•
            Method method = clazz.getMethod("execute");
            method.invoke(service);
            
            // ç­‰å¾…5ç§’åé‡æ–°åŠ è½½
            Thread.sleep(5000);
        }
    }
}
```

### æ¡ˆä¾‹2ï¼šæ’ä»¶ç³»ç»Ÿ

```java
public class PluginClassLoader extends ClassLoader {
    
    private String pluginPath;
    
    public PluginClassLoader(String pluginPath, ClassLoader parent) {
        super(parent);
        this.pluginPath = pluginPath;
    }
    
    @Override
    protected Class<?> findClass(String name) throws ClassNotFoundException {
        // åªåŠ è½½æ’ä»¶åŒ…ä¸­çš„ç±»
        if (!name.startsWith("com.example.plugin")) {
            throw new ClassNotFoundException(name);
        }
        
        try {
            byte[] classData = loadClassData(name);
            return defineClass(name, classData, 0, classData.length);
        } catch (IOException e) {
            throw new ClassNotFoundException(name, e);
        }
    }
    
    private byte[] loadClassData(String name) throws IOException {
        String fileName = pluginPath + "/" + name.replace('.', '/') + ".class";
        try (InputStream is = new FileInputStream(fileName);
             ByteArrayOutputStream baos = new ByteArrayOutputStream()) {
            
            byte[] buffer = new byte[1024];
            int len;
            while ((len = is.read(buffer)) != -1) {
                baos.write(buffer, 0, len);
            }
            return baos.toByteArray();
        }
    }
}

// æ’ä»¶ç®¡ç†å™¨
public class PluginManager {
    
    private Map<String, PluginClassLoader> plugins = new HashMap<>();
    
    // åŠ è½½æ’ä»¶
    public void loadPlugin(String pluginName, String pluginPath) throws Exception {
        PluginClassLoader loader = new PluginClassLoader(
            pluginPath, 
            ClassLoader.getSystemClassLoader()
        );
        plugins.put(pluginName, loader);
        
        // åŠ è½½æ’ä»¶ä¸»ç±»
        Class<?> pluginClass = loader.loadClass("com.example.plugin." + pluginName + ".Main");
        Object plugin = pluginClass.newInstance();
        
        // åˆå§‹åŒ–æ’ä»¶
        Method initMethod = pluginClass.getMethod("init");
        initMethod.invoke(plugin);
    }
    
    // å¸è½½æ’ä»¶
    public void unloadPlugin(String pluginName) {
        PluginClassLoader loader = plugins.remove(pluginName);
        // å°†ç±»åŠ è½½å™¨ç½®ä¸ºnullï¼Œç­‰å¾…GCå›æ”¶
        loader = null;
    }
}
```

---

## ä¹ã€å¸¸è§é—®é¢˜

### Q1: ä¸ºä»€ä¹ˆå«"åŒäº²"å§”æ´¾ï¼Ÿ

**A**: 
- è¿™æ˜¯ç¿»è¯‘é—®é¢˜ï¼Œè‹±æ–‡æ˜¯"Parent Delegation Model"
- "Parent"æ˜¯å•æ•°ï¼Œåº”è¯¥ç¿»è¯‘ä¸º"çˆ¶ç±»å§”æ´¾"
- å®é™…ä¸Šæ¯ä¸ªç±»åŠ è½½å™¨åªæœ‰ä¸€ä¸ªçˆ¶åŠ è½½å™¨

### Q2: å¦‚ä½•æ‰“ç ´åŒäº²å§”æ´¾æ¨¡å‹ï¼Ÿ

**A**: 
- é‡å†™`loadClass()`æ–¹æ³•ï¼ˆä¸æ¨èï¼‰
- ä½¿ç”¨çº¿ç¨‹ä¸Šä¸‹æ–‡ç±»åŠ è½½å™¨
- ä½¿ç”¨OSGiç­‰æ¨¡å—åŒ–æ¡†æ¶
- è¯¦è§ä¸‹ä¸€ç¯‡æ–‡æ¡£

### Q3: ç±»åŠ è½½å™¨çš„çˆ¶å­å…³ç³»æ˜¯ç»§æ‰¿å…³ç³»å—ï¼Ÿ

**A**: 
- ä¸æ˜¯ç»§æ‰¿å…³ç³»
- æ˜¯ç»„åˆå…³ç³»ï¼ˆé€šè¿‡`parent`å­—æ®µå…³è”ï¼‰

### Q4: ä¸ºä»€ä¹ˆBootstrap ClassLoaderè¿”å›nullï¼Ÿ

**A**: 
- Bootstrap ClassLoaderç”±C++å®ç°
- åœ¨Javaä¸­æ²¡æœ‰å¯¹åº”çš„ç±»
- æ‰€ä»¥è¿”å›nullè¡¨ç¤º

### Q5: å¦‚ä½•é¿å…ç±»åŠ è½½å™¨æ³„æ¼ï¼Ÿ

**A**: 
- åŠæ—¶æ¸…ç†ç±»åŠ è½½å™¨çš„å¼•ç”¨
- é¿å…åœ¨é™æ€å­—æ®µä¸­æŒæœ‰ç±»åŠ è½½å™¨
- ä½¿ç”¨å¼±å¼•ç”¨
- å®šæœŸæ£€æŸ¥å†…å­˜

---

## åã€æœ€ä½³å®è·µ

### 1. è‡ªå®šä¹‰ç±»åŠ è½½å™¨çš„å»ºè®®

```java
// âœ… æ¨èï¼šç»§æ‰¿ClassLoaderï¼Œé‡å†™findClass()
public class MyClassLoader extends ClassLoader {
    @Override
    protected Class<?> findClass(String name) throws ClassNotFoundException {
        // è‡ªå®šä¹‰åŠ è½½é€»è¾‘
    }
}

// âŒ ä¸æ¨èï¼šé‡å†™loadClass()ï¼ˆä¼šç ´ååŒäº²å§”æ´¾ï¼‰
public class BadClassLoader extends ClassLoader {
    @Override
    public Class<?> loadClass(String name) throws ClassNotFoundException {
        // ç ´åäº†åŒäº²å§”æ´¾æ¨¡å‹
    }
}
```

### 2. ç±»åŠ è½½å™¨çš„å‘½å

```java
// ä¸ºç±»åŠ è½½å™¨è®¾ç½®æœ‰æ„ä¹‰çš„åç§°ï¼ˆJDK 9+ï¼‰
ClassLoader loader = new CustomClassLoader("MyLoader");
```

### 3. èµ„æºåŠ è½½

```java
// ä½¿ç”¨ç±»åŠ è½½å™¨åŠ è½½èµ„æº
ClassLoader loader = MyClass.class.getClassLoader();
InputStream is = loader.getResourceAsStream("config.properties");

// æˆ–è€…ä½¿ç”¨Classå¯¹è±¡
InputStream is = MyClass.class.getResourceAsStream("/config.properties");
```

### 4. é¿å…ç±»åŠ è½½æ­»é”

```java
// åœ¨é™æ€ä»£ç å—ä¸­åŠ è½½ç±»å¯èƒ½å¯¼è‡´æ­»é”
public class DeadlockDemo {
    static {
        // é¿å…åœ¨é™æ€ä»£ç å—ä¸­åŠ è½½å…¶ä»–ç±»
        Class.forName("com.example.OtherClass");
    }
}
```

---

## ğŸ“š å‚è€ƒèµ„æ–™

1. **ã€Šæ·±å…¥ç†è§£Javaè™šæ‹Ÿæœºï¼ˆç¬¬3ç‰ˆï¼‰ã€‹** - å‘¨å¿—æ˜
2. **ã€ŠJavaè™šæ‹Ÿæœºè§„èŒƒã€‹** - https://docs.oracle.com/javase/specs/
3. **OpenJDKæºç ** - https://openjdk.java.net/

---

**ä¸‹ä¸€ç¯‡**ï¼š[æ‰“ç ´åŒäº²å§”æ´¾æ¨¡å‹](./03_æ‰“ç ´åŒäº²å§”æ´¾æ¨¡å‹.md)
