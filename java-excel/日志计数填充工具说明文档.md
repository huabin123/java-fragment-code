# 日志计数填充工具说明文档

## 一、需求背景

在系统运维和数据分析过程中，需要统计各个接口的调用次数。现有三个数据源：
- `result.xlsx`：包含接口清单，需要填充调用次数
- `sys_log.xlsx`：系统日志文件，记录了部分接口的实际调用次数
- `method.csv`：方法调用统计文件，记录了方法级别的调用次数

需要开发一个自动化工具，将 `sys_log.xlsx` 和 `method.csv` 中的调用次数数据填充到 `result.xlsx` 中对应的接口记录中。

## 二、实现目的

1. **自动化数据填充**：避免手工复制粘贴，提高工作效率
2. **智能匹配**：通过两级匹配机制，最大化匹配成功率
3. **数据准确性**：确保调用次数数据准确对应到正确的接口
4. **可维护性**：使用 EasyExcel 框架，代码简洁易维护

## 三、数据文件说明

### 3.1 result.xlsx
- **位置**：`src/main/resources/log_count/result.xlsx`
- **Sheet名称**：`Sheet1-产品已提供服务的接口清单`
- **关键列**：
  - `接口调用url（一个接口一行）`：接口URL，格式如 `/DataAuthController/batchUpdateRoleDataAuth`
  - `调用次数`：需要填充的目标列

### 3.2 sys_log.xlsx
- **位置**：`src/main/resources/log_count/sys_log.xlsx`
- **关键列**：
  - `请求连接`：请求URL，格式如 `/bocwm/comSearchController/chooseTemplate`（包含前缀）
  - `计数`：该接口的调用次数

### 3.3 method.csv
- **位置**：`src/main/resources/log_count/method.csv`
- **关键列**：
  - `name`：方法名称（URL的最后部分），格式如 `login`、`queryPageBySql`
  - `count`：该方法的调用次数（带千分位逗号，如 `554,286`）

## 四、匹配规则

### 4.1 第一级匹配：sys_log.xlsx

**匹配逻辑**：
1. 读取 `sys_log.xlsx` 时，对 `请求连接` 列进行标准化处理
2. 标准化规则：去除第二个 `/` 之前的内容（去除前缀如 `/bocwm`、`/wemax`、`/relatedtransation` 等）
3. 示例：
   - 原始URL：`/bocwm/comSearchController/chooseTemplate`
   - 标准化后：`/comSearchController/chooseTemplate`
4. 使用标准化后的URL与 `result.xlsx` 中的URL进行**完全匹配**
5. 匹配成功后，将 `sys_log.xlsx` 的 `计数` 列值填充到 `result.xlsx` 的 `调用次数` 列

**优先级**：最高（优先使用系统日志的真实调用数据）

### 4.2 第二级匹配：method.csv

**匹配逻辑**：
1. 仅对第一级匹配失败的URL进行第二级匹配
2. 提取 `result.xlsx` 中URL的最后部分（最后一个 `/` 之后的内容）
3. 示例：
   - 完整URL：`/loginController/login`
   - 提取最后部分：`login`
4. 将提取的最后部分与 `method.csv` 中的 `name` 列进行**完全匹配**
5. 匹配成功后，将 `method.csv` 的 `count` 列值（去除千分位逗号后）填充到 `result.xlsx` 的 `调用次数` 列

**优先级**：次要（作为补充数据源）

### 4.3 匹配失败

如果两级匹配都失败，该URL的 `调用次数` 列保持为空（null），并在控制台输出提示信息。

## 五、实现过程

### 5.1 技术选型

- **开发语言**：Java 8
- **Excel处理框架**：EasyExcel 3.1.1
- **辅助工具**：Lombok 1.18.24（简化数据模型）
- **构建工具**：Maven

### 5.2 项目结构

```
java-excel/
├── pom.xml                                  # Maven依赖配置
├── src/main/java/com/fragment/excel/
│   ├── LogCountMain.java                    # 主程序入口
│   ├── DebugLogCount.java                   # 调试工具（可选）
│   ├── model/                               # 数据模型包
│   │   ├── ResultData.java                  # result.xlsx 数据模型
│   │   ├── SysLogData.java                  # sys_log.xlsx 数据模型
│   │   └── MethodData.java                  # method.csv 数据模型
│   └── util/                                # 工具类包
│       └── LogCountProcessor.java           # 核心处理逻辑
└── src/main/resources/log_count/            # 数据文件目录
    ├── result.xlsx                          # 待填充的结果文件
    ├── sys_log.xlsx                         # 系统日志文件
    └── method.csv                           # 方法调用统计文件
```

### 5.3 核心实现步骤

#### 步骤1：添加依赖
在 `pom.xml` 中添加 EasyExcel 和 Lombok 依赖：
```xml
<dependency>
    <groupId>com.alibaba</groupId>
    <artifactId>easyexcel</artifactId>
    <version>3.1.1</version>
</dependency>
<dependency>
    <groupId>org.projectlombok</groupId>
    <artifactId>lombok</artifactId>
    <version>1.18.24</version>
    <scope>provided</scope>
</dependency>
```

#### 步骤2：创建数据模型
使用 `@ExcelProperty` 注解映射Excel列名：
- `ResultData`：映射 `接口调用url（一个接口一行）` 和 `调用次数`
- `SysLogData`：映射 `请求连接` 和 `计数`
- `MethodData`：映射 `name` 和 `count`

#### 步骤3：实现数据读取
- 使用 `EasyExcel.read()` 方法读取Excel和CSV文件
- 使用 `AnalysisEventListener` 监听器逐行处理数据
- 将数据存储到 `Map<String, Integer>` 中便于快速查找

#### 步骤4：实现URL标准化
```java
private String normalizeUrl(String url) {
    // 找到第二个/的位置
    int secondSlashIndex = url.indexOf('/', 1);
    if (secondSlashIndex > 0) {
        return url.substring(secondSlashIndex);
    }
    return url;
}
```

#### 步骤5：实现两级匹配
1. 优先从 `sys_log` 的Map中查找（完全匹配）
2. 如果未找到，从 `method.csv` 的Map中查找（提取URL最后部分后完全匹配）
3. 填充匹配到的调用次数

#### 步骤6：写入结果
使用 `EasyExcel.write()` 方法将填充后的数据写回 `result.xlsx` 文件。

## 六、操作步骤

### 6.1 准备工作

1. **确认数据文件**：确保以下文件存在于 `src/main/resources/log_count/` 目录：
   - `result.xlsx`
   - `sys_log.xlsx`
   - `method.csv`

2. **备份原始文件**（可选但推荐）：
   ```bash
   cp src/main/resources/log_count/result.xlsx src/main/resources/log_count/result_backup.xlsx
   ```

### 6.2 编译项目

在项目根目录执行：
```bash
cd /Users/huabin/workspace/playground/my-github/java-fragment-code/java-excel
mvn clean compile
```

### 6.3 运行程序

**方式一：使用Maven命令**
```bash
mvn exec:java -Dexec.mainClass="com.fragment.excel.LogCountMain"
```

**方式二：在IDE中运行**
1. 打开 `LogCountMain.java` 文件
2. 右键点击文件或 `main` 方法
3. 选择 "Run 'LogCountMain.main()'"

### 6.4 查看执行结果

程序执行时会在控制台输出以下信息：
```
开始处理日志计数...
读取sys_log.xlsx完成，共 218 条记录
读取method.csv完成，共 1001 条记录
读取result.xlsx完成，共 1009 条记录
匹配统计：
  - 从sys_log匹配: 212
  - 从method.csv匹配: 797
  - 未匹配: 0
结果已写入: /Users/huabin/workspace/playground/my-github/java-fragment-code/java-excel/src/main/resources/log_count/result.xlsx
处理完成！
```

### 6.5 验证结果

1. 打开 `result.xlsx` 文件
2. 检查 `调用次数` 列是否已填充数据
3. 随机抽查几条记录，验证数据准确性

## 七、注意事项

### 7.1 数据格式要求

1. **Excel列名必须完全匹配**：
   - `result.xlsx` 必须包含列：`接口调用url（一个接口一行）`、`调用次数`
   - `sys_log.xlsx` 必须包含列：`请求连接`、`计数`
   - `method.csv` 必须包含列：`name`、`count`

2. **Sheet名称要求**：
   - `result.xlsx` 的Sheet名称必须为：`Sheet1-产品已提供服务的接口清单`
   - `sys_log.xlsx` 可以是任意Sheet（默认读取第一个）

3. **CSV格式**：
   - `method.csv` 的 `count` 列可以包含千分位逗号（如 `554,286`），程序会自动处理

### 7.2 文件路径配置

当前文件路径硬编码在 `LogCountProcessor.java` 中：
```java
private static final String RESOURCE_PATH = "/Users/huabin/workspace/playground/my-github/java-fragment-code/java-excel/src/main/resources/log_count";
```

如需修改路径，请编辑该常量。

### 7.3 数据安全

- **原文件会被覆盖**：程序会直接修改 `result.xlsx`，建议运行前备份
- **无撤销功能**：一旦写入，无法自动恢复，请谨慎操作

### 7.4 性能考虑

- 当前实现适用于中小规模数据（几千到几万条）
- 如果数据量超过10万条，建议优化为流式处理

## 八、常见问题

### Q1: 为什么有些URL没有匹配到？

**可能原因**：
1. `sys_log.xlsx` 和 `method.csv` 中都没有该URL的记录
2. URL格式不一致（如大小写、多余空格等）
3. `method.csv` 中的方法名与URL最后部分不完全相同

**解决方案**：
- 检查控制台输出的"未匹配到URL"列表
- 手动核对数据源中是否存在该URL
- 如有需要，可以调整匹配规则

### Q2: 如何调试匹配过程？

可以运行 `DebugLogCount.java` 查看详细的匹配信息：
```bash
mvn exec:java -Dexec.mainClass="com.fragment.excel.DebugLogCount"
```

### Q3: 能否同时输出到新文件而不覆盖原文件？

可以修改 `LogCountProcessor.java` 中的 `writeResult()` 方法，将 `RESULT_FILE` 改为其他文件名。

### Q4: CSV中的count值包含逗号导致解析错误怎么办？

程序已经处理了这个问题，会自动去除逗号：
```java
String countStr = data.getCount().replace(",", "");
Integer count = Integer.parseInt(countStr);
```

## 九、扩展建议

### 9.1 功能扩展

1. **支持配置文件**：将文件路径、Sheet名称等配置项外部化
2. **支持命令行参数**：允许用户指定输入输出文件
3. **增加数据校验**：检查数据完整性和格式正确性
4. **生成统计报告**：输出详细的匹配报告（Excel或HTML格式）
5. **支持增量更新**：只更新变化的数据，不覆盖已有数据

### 9.2 性能优化

1. **并行处理**：使用多线程读取多个文件
2. **流式处理**：对于大文件使用流式读写，减少内存占用
3. **缓存机制**：缓存已读取的数据，避免重复读取

### 9.3 用户体验

1. **图形界面**：开发简单的GUI界面，方便非技术人员使用
2. **进度条**：显示处理进度
3. **日志文件**：将处理结果输出到日志文件，便于追溯

## 十、总结

本工具通过两级智能匹配机制，实现了从系统日志和方法统计数据中自动提取接口调用次数并填充到接口清单中。使用 EasyExcel 框架简化了Excel操作，代码简洁易维护。工具已在实际数据上验证，匹配成功率达到100%（212条从sys_log匹配，797条从method.csv匹配，共1009条全部匹配成功）。

---

**文档版本**：v1.0  
**最后更新**：2025-12-05  
**维护者**：huabin
